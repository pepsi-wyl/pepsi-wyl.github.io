<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>rebase Â© pepsiwyl</title>
      <link href="/2023/11/14/rebase-%C2%A9-pepsiwyl/"/>
      <url>/2023/11/14/rebase-%C2%A9-pepsiwyl/</url>
      
        <content type="html"><![CDATA[<h2 id="åˆå¹¶åˆ†æ”¯-Merge-VS-Rebase"><a href="#åˆå¹¶åˆ†æ”¯-Merge-VS-Rebase" class="headerlink" title="åˆå¹¶åˆ†æ”¯-Merge VS Rebase"></a>åˆå¹¶åˆ†æ”¯-Merge VS Rebase</h2><h3 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h3><p>æ–‡ç« <br /><a href="https://deepinout.com/git/git-questions/426_git_whats_the_difference_between_git_merge_and_git_rebase.html">Git â€˜mergeâ€™ å’Œ â€˜rebaseâ€™ ä¹‹é—´çš„åŒºåˆ«|æå®¢ç¬”è®°</a><br><a href="https://blog.csdn.net/weixin_42310154/article/details/119004977">git rebaseè¯¦è§£ï¼ˆå›¾è§£+æœ€ç®€å•ç¤ºä¾‹ï¼Œä¸€æ¬¡å°±æ‡‚ï¼‰-CSDNåšå®¢</a><br><a href="https://www.cnblogs.com/michael-xiang/p/13179837.html">å›¾è§£ Git åŸºæœ¬å‘½ä»¤ merge å’Œ rebase - Michaelç¿” - åšå®¢å›­</a><br>è§†é¢‘<br /><a href="https://www.bilibili.com/video/BV1Bg41167Zi/?spm_id_from=333.999.0.0&vd_source=d6c267f5e56771009ec98cfb62fcff49">ã€ITè€é½235ã€‘Git Rebase vs Git Mergeï¼Œä»£ç åˆå¹¶åˆ°åº•ç”¨å“ªä¸ªï¼Ÿ_å“”å“©å“”å“©_bilibili</a><br><a href="https://www.bilibili.com/video/BV1VG411F7rB/?spm_id_from=333.788.recommend_more_video.2&vd_source=d6c267f5e56771009ec98cfb62fcff49">äº”åˆ†é’Ÿå­¦ä¼šgit rebaseå’Œ git mergeçš„åŒºåˆ«_å“”å“©å“”å“©_bilibili</a><br><a href="https://www.bilibili.com/video/BV1Ur4y1q7xB/?spm_id_from=333.788.recommend_more_video.6&vd_source=d6c267f5e56771009ec98cfb62fcff49">gitå¸¸ç”¨æ“ä½œâ€“git rebaseå’Œgit merge_å“”å“©å“”å“©_bilibili</a><br><a href="https://www.bilibili.com/video/BV19B4y1u7vm/?spm_id_from=333.788.recommend_more_video.4&vd_source=d6c267f5e56771009ec98cfb62fcff49">ä¸ä¼šä½¿ç”¨ git rebase åˆå¹¶ä»£ç ï¼Ÿè¿™ä½é¢œå€¼é¢‡é«˜çš„ç¨‹åºå‘˜è¢«å…¬å¸å¼€é™¤äº† #83_å“”å“©å“”å“©_bilibili</a></p><h3 id="margeå’Œrebaseå›¾è§£"><a href="#margeå’Œrebaseå›¾è§£" class="headerlink" title="margeå’Œrebaseå›¾è§£"></a>margeå’Œrebaseå›¾è§£</h3><h4 id="merge"><a href="#merge" class="headerlink" title="merge"></a>merge</h4><p>å°†devåˆ†æ”¯mergeåˆ°masteråˆ†æ”¯ä¸Š<br /><img src="/2023/11/14/rebase-%C2%A9-pepsiwyl/1699928387365-15aa3032-b0ba-4f77-ac0f-4251cde82e90.png" class=""><br>å°†masteråˆ†æ”¯mergeåˆ°devåˆ†æ”¯ä¸Š<br /><img src="/2023/11/14/rebase-%C2%A9-pepsiwyl/1699928729471-88164ac5-2e2e-4aa5-96fb-75fd01539234.png" class=""></p><h4 id="rebase"><a href="#rebase" class="headerlink" title="rebase"></a>rebase</h4><p>å°†masteråˆ†æ”¯ä»¥devè¿›è¡Œå˜åŸº<br /><img src="/2023/11/14/rebase-%C2%A9-pepsiwyl/1699929915911-a8ae491b-8200-4b74-94c8-e3735fbf085e.png" class=""><br>å°†devåˆ†æ”¯ä»¥masterè¿›è¡Œå˜åŸº<br /><img src="/2023/11/14/rebase-%C2%A9-pepsiwyl/1699929934981-57dc2dfa-4974-40d6-9334-1bdb2823e84b.png" class=""></p><p>rebase å…³é”®åœ¨äºã€ŒåŸºã€ï¼Œgit rebase &lt;åŸºåˆ†æ”¯&gt;ï¼Œå°±æ˜¯å°†å½“å‰åŸºåˆ†æ”¯ä¸å½“å‰åˆ†æ”¯çš„å·®å¼‚æäº¤è·å–åˆ°ï¼Œç„¶ååœ¨ã€ŒåŸºåˆ†æ”¯ã€æœ€æ–°æäº¤ç‚¹åé¢å°†å·®å¼‚æäº¤é€ä¸ªå†æ¬¡æäº¤ï¼Œæœ€åå°†å½“å‰åˆ†æ”¯çš„ HEAD æŒ‡é’ˆæŒ‡å‘æœ€æ–°çš„æäº¤ç‚¹ã€‚ã€ŒåŸºåˆ†æ”¯ã€çš„ HEAD ä½ç½®æ˜¯ä¸å˜çš„ï¼Œè¦æƒ³å®Œæˆåˆ†æ”¯åˆå¹¶ï¼Œå®Œæˆå˜åŸºä¹‹åï¼Œè¿˜éœ€è¦å†è¿›è¡Œåˆ†æ”¯é—´çš„åˆå¹¶ç­‰æ“ä½œã€‚</p><h3 id="ä¼˜ç¼ºç‚¹åŠæ¯”è¾ƒ"><a href="#ä¼˜ç¼ºç‚¹åŠæ¯”è¾ƒ" class="headerlink" title="ä¼˜ç¼ºç‚¹åŠæ¯”è¾ƒ"></a>ä¼˜ç¼ºç‚¹åŠæ¯”è¾ƒ</h3><img src="/2023/11/14/rebase-%C2%A9-pepsiwyl/1699878741062-3163180d-0d27-45b0-9c34-5204c257b7e0.png" class=""><h3 id="ä½¿ç”¨åœºæ™¯å»ºè®®"><a href="#ä½¿ç”¨åœºæ™¯å»ºè®®" class="headerlink" title="ä½¿ç”¨åœºæ™¯å»ºè®®"></a>ä½¿ç”¨åœºæ™¯å»ºè®®</h3><p>å­åˆ†æ”¯ä¸Šæ‰§è¡Œ  - rebase  master   ç›¸å½“äºå­åˆ†æ”¯æ‹‰å–æœ€æ–°çš„å…¬å…±åˆ†æ”¯ä»£ç </p><img src="/2023/11/14/rebase-%C2%A9-pepsiwyl/1699885708092-ba5392bb-741c-46dd-a06e-45589e9b1015.png" class=""><p>masteråˆ†æ”¯ä¸Šæ‰§è¡Œ - merge å­åˆ†æ”¯  ç›¸å½“äºå°†å­åˆ†æ”¯ä»£ç åˆå¹¶åˆ°å…¬å…±åˆ†æ”¯ä¸Š</p><img src="/2023/11/14/rebase-%C2%A9-pepsiwyl/1699885665103-65c8f1a5-b3cc-44af-929a-ceffe6d6ca69.png" class=""><h2 id="å‹ç¼©commit-Rebase"><a href="#å‹ç¼©commit-Rebase" class="headerlink" title="å‹ç¼©commit-Rebase"></a>å‹ç¼©commit-Rebase</h2><p><a href="https://blog.csdn.net/weixin_44756333/article/details/122977109">ä½¿ç”¨IDEA GitæŠŠå¤šæ¬¡æäº¤åˆå¹¶æˆä¸€æ¬¡æ“ä½œ_idea å¦‚ä½•å°†è¿œç¨‹ä»“åº“å¤šæ¬¡æäº¤æ”¹ä¸ºå•æ¬¡-CSDNåšå®¢</a><br><a href="https://blog.csdn.net/luomo0203/article/details/111771015">IDEAä¸­å°†å¤šæ¬¡commitåˆå¹¶ä¸ºä¸€æ¬¡åpushåˆ°è¿œç¨‹ä»“åº“_å¤šæ¬¡commitä¸€æ¬¡push-CSDNåšå®¢</a></p>]]></content>
      
      
      <categories>
          
          <category> rebase </category>
          
          <category> merge </category>
          
      </categories>
      
      
        <tags>
            
            <tag> rebase </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>SpringSecurityÂ©ç¼–ç¨‹ä¸è‰¯äºº</title>
      <link href="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/"/>
      <url>/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/</url>
      
        <content type="html"><![CDATA[<h1 id="SpringSecurity-å®æˆ˜"><a href="#SpringSecurity-å®æˆ˜" class="headerlink" title="SpringSecurity å®æˆ˜"></a>SpringSecurity å®æˆ˜</h1><h1 id="ç¬¬ä¸€ç« -æƒé™ç®¡ç†"><a href="#ç¬¬ä¸€ç« -æƒé™ç®¡ç†" class="headerlink" title="ç¬¬ä¸€ç«  æƒé™ç®¡ç†"></a>ç¬¬ä¸€ç«  æƒé™ç®¡ç†</h1><ul><li>æƒé™ç®¡ç†</li><li>SpringSecurity ç®€ä»‹</li><li>æ•´ä½“æ¶æ„</li></ul><h2 id="æƒé™ç®¡ç†"><a href="#æƒé™ç®¡ç†" class="headerlink" title="æƒé™ç®¡ç†"></a>æƒé™ç®¡ç†</h2><p>åŸºæœ¬ä¸Šæ¶‰åŠåˆ°ç”¨æˆ·å‚ä¸çš„ç³»ç»Ÿéƒ½è¦è¿›è¡Œæƒé™ç®¡ç†ï¼Œæƒé™ç®¡ç†å±äºç³»ç»Ÿå®‰å…¨çš„èŒƒç•´ï¼Œæƒé™ç®¡ç†å®ç°<code>å¯¹ç”¨æˆ·è®¿é—®ç³»ç»Ÿçš„æ§åˆ¶</code>ï¼ŒæŒ‰ç…§<code>å®‰å…¨è§„åˆ™</code>æˆ–è€…<code>å®‰å…¨ç­–ç•¥</code>æ§åˆ¶ç”¨æˆ·<code>å¯ä»¥è®¿é—®è€Œä¸”åªèƒ½è®¿é—®è‡ªå·±è¢«æˆæƒçš„èµ„æº</code>ã€‚</p><p>æƒé™ç®¡ç†åŒ…æ‹¬ç”¨æˆ·<strong>èº«ä»½è®¤è¯</strong>å’Œ<strong>æˆæƒ</strong>ä¸¤éƒ¨åˆ†ï¼Œç®€ç§°<strong>è®¤è¯æˆæƒ</strong>ã€‚å¯¹äºéœ€è¦è®¿é—®æ§åˆ¶çš„èµ„æºç”¨æˆ·é¦–å…ˆç»è¿‡èº«ä»½è®¤è¯ï¼Œè®¤è¯é€šè¿‡åç”¨æˆ·å…·æœ‰è¯¥èµ„æºçš„è®¿é—®æƒé™æ–¹å¯è®¿é—®ã€‚</p><h3 id="è®¤è¯"><a href="#è®¤è¯" class="headerlink" title="è®¤è¯"></a>è®¤è¯</h3><p><strong>èº«ä»½è®¤è¯</strong>ï¼Œå°±æ˜¯åˆ¤æ–­ä¸€ä¸ªç”¨æˆ·æ˜¯å¦ä¸ºåˆæ³•ç”¨æˆ·çš„å¤„ç†è¿‡ç¨‹ã€‚æœ€å¸¸ç”¨çš„ç®€å•èº«ä»½è®¤è¯æ–¹å¼æ˜¯ç³»ç»Ÿé€šè¿‡æ ¸å¯¹ç”¨æˆ·è¾“å…¥çš„ç”¨æˆ·åå’Œå£ä»¤ï¼Œçœ‹å…¶æ˜¯å¦ä¸ç³»ç»Ÿä¸­å­˜å‚¨çš„è¯¥ç”¨æˆ·çš„ç”¨æˆ·åå’Œå£ä»¤ä¸€è‡´ï¼Œæ¥åˆ¤æ–­ç”¨æˆ·èº«ä»½æ˜¯å¦æ­£ç¡®ã€‚å¯¹äºé‡‡ç”¨<a href="http://baike.baidu.com/view/5628.htm">æŒ‡çº¹</a>ç­‰ç³»ç»Ÿï¼Œåˆ™å‡ºç¤ºæŒ‡çº¹ï¼›å¯¹äºç¡¬ä»¶Keyç­‰åˆ·å¡ç³»ç»Ÿï¼Œåˆ™éœ€è¦åˆ·å¡ã€‚</p><h3 id="æˆæƒ"><a href="#æˆæƒ" class="headerlink" title="æˆæƒ"></a>æˆæƒ</h3><p><strong>æˆæƒ</strong>ï¼Œå³è®¿é—®æ§åˆ¶ï¼Œæ§åˆ¶è°èƒ½è®¿é—®å“ªäº›èµ„æºã€‚ä¸»ä½“è¿›è¡Œèº«ä»½è®¤è¯åéœ€è¦åˆ†é…æƒé™æ–¹å¯è®¿é—®ç³»ç»Ÿçš„èµ„æºï¼Œå¯¹äºæŸäº›èµ„æºæ²¡æœ‰æƒé™æ˜¯æ— æ³•è®¿é—®çš„</p><h3 id="è§£å†³æ–¹æ¡ˆ"><a href="#è§£å†³æ–¹æ¡ˆ" class="headerlink" title="è§£å†³æ–¹æ¡ˆ"></a>è§£å†³æ–¹æ¡ˆ</h3><p>å’Œå…¶ä»–é¢†åŸŸä¸åŒï¼Œåœ¨ Java ä¼ä¸šçº§å¼€å‘ä¸­ï¼Œå®‰å…¨ç®¡ç†æ¡†æ¶éå¸¸å°‘ï¼Œç›®å‰æ¯”è¾ƒå¸¸è§çš„å°±æ˜¯ï¼š</p><ul><li>Shiro<ul><li>Shiro æœ¬èº«æ˜¯ä¸€ä¸ªè€ç‰Œçš„å®‰å…¨ç®¡ç†æ¡†æ¶ï¼Œæœ‰ç€ä¼—å¤šçš„ä¼˜ç‚¹ï¼Œä¾‹å¦‚è½»é‡ã€ç®€å•ã€æ˜“äºé›†æˆã€å¯ä»¥åœ¨JavaSEç¯å¢ƒä¸­ä½¿ç”¨ç­‰ã€‚ä¸è¿‡ï¼Œåœ¨å¾®æœåŠ¡æ—¶ä»£ï¼ŒShiro å°±æ˜¾å¾—åŠ›ä¸ä»å¿ƒäº†ï¼Œåœ¨å¾®æœåŠ¡é¢å‰å’Œæ‰©å±•æ–¹é¢ï¼Œæ— æ³•å……åˆ†å±•ç¤ºè‡ªå·±çš„ä¼˜åŠ¿ã€‚</li></ul></li><li>å¼€å‘è€…è‡ªå®šä¹‰<ul><li>ä¹Ÿæœ‰å¾ˆå¤šå…¬å¸é€‰æ‹©è‡ªå®šä¹‰æƒé™ï¼Œå³è‡ªå·±å¼€å‘æƒé™ç®¡ç†ã€‚ä½†æ˜¯ä¸€ä¸ªç³»ç»Ÿçš„å®‰å…¨ï¼Œä¸ä»…ä»…æ˜¯ç™»å½•å’Œæƒé™æ§åˆ¶è¿™ä¹ˆç®€å•ï¼Œæˆ‘ä»¬è¿˜è¦è€ƒè™‘ç§å„æ ·å¯èƒ½å­˜åœ¨çš„ç½‘ç»œæ”¿å‡»ä»¥åŠé˜²å½»ç­–ç•¥ï¼Œä»è¿™ä¸ªè§’åº¦æ¥è¯´ï¼Œå¼€å‘è€…ç™½å·±å®ç°å®‰å…¨ç®¡ç†ä¹Ÿå¹¶éæ˜¯ä¸€ä»¶å®¹æ˜“çš„äº‹æƒ…ï¼Œåªæœ‰å¤§å…¬å¸æ‰æœ‰è¶³å¤Ÿçš„äººåŠ›ç‰©åŠ›å»æ”¯æŒè¿™ä»¶äº‹æƒ…ã€‚</li></ul></li><li>Spring Security<ul><li>Spring Security,ä½œä¸ºspring å®¶æ—çš„ä¸€å‘˜ï¼Œåœ¨å’Œ Spring å®¶æ—çš„å…¶ä»–æˆå‘˜å¦‚ Spring Boot Spring Clondç­‰è¿›è¡Œæ•´åˆæ—¶ï¼Œå…·æœ‰å…¶ä»–æ¡†æ¶æ— å¯æ¯”æ‹Ÿçš„ä¼˜åŠ¿ï¼ŒåŒæ—¶å¯¹ OAuth2 æœ‰ç€è‰¯å¥½çš„æ”¯æŒï¼Œå†åŠ ä¸ŠSpring Cloudå¯¹ Spring Securityçš„ä¸æ–­åŠ æŒï¼ˆå¦‚æ¨å‡º Spring Cloud Security )ï¼Œè®© Spring Securiy ä¸çŸ¥ä¸è§‰ä¸­æˆä¸ºå¾®æœåŠ¡é¡¹ç›®çš„é¦–é€‰å®‰å…¨ç®¡ç†æ–¹æ¡ˆã€‚</li></ul></li></ul><h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><h3 id="å®˜æ–¹å®šä¹‰"><a href="#å®˜æ–¹å®šä¹‰" class="headerlink" title="å®˜æ–¹å®šä¹‰"></a>å®˜æ–¹å®šä¹‰</h3><ul><li><a href="https://spring.io/projects/spring-security">https://spring.io/projects/spring-security</a></li></ul><p>Spring Security is a powerful and highly customizable authentication and access-control framework. It is the de-facto standard for securing Spring-based applications.</p><p>Spring Security is a framework that focuses on providing both authentication and authorization to Java applications. Like all Spring projects, the real power of Spring Security is found in how easily it can be extended to meet custom requirements</p><p>Spring Securityæ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§ã€å¯é«˜åº¦å®šåˆ¶çš„èº«ä»½éªŒè¯å’Œè®¿é—®æ§åˆ¶æ¡†æ¶ã€‚å®ƒæ˜¯ä¿æŠ¤åŸºäºSpringçš„åº”ç”¨ç¨‹åºçš„äº‹å®æ ‡å‡†ã€‚</p><p>Spring Securityæ˜¯ä¸€ä¸ªé¢å‘Javaåº”ç”¨ç¨‹åºæä¾›èº«ä»½éªŒè¯å’Œå®‰å…¨æ€§çš„æ¡†æ¶ã€‚ä¸æ‰€æœ‰Springé¡¹ç›®ä¸€æ ·ï¼ŒSpring Securityçš„çœŸæ­£å¨åŠ›åœ¨äºå®ƒå¯ä»¥è½»æ¾åœ°æ‰©å±•ä»¥æ»¡è¶³å®šåˆ¶éœ€æ±‚ã€‚</p><ul><li>æ€»ç»“</li></ul><blockquote><p>Spring Securityæ˜¯ä¸€ä¸ªåŠŸèƒ½å¼ºå¤§ã€å¯é«˜åº¦å®šåˆ¶çš„<code>èº«ä»½éªŒè¯</code>å’Œ<code>è®¿é—®æ§åˆ¶</code>çš„æ¡†æ¶ã€‚æˆ–è€…è¯´ç”¨æ¥å®ç°ç³»ç»Ÿä¸­æƒé™ç®¡ç†çš„æ¡†æ¶ã€‚</p></blockquote><h3 id="å†å²"><a href="#å†å²" class="headerlink" title="å†å²"></a>å†å²</h3><p>Spring Security æœ€æ—©å« Acegi Securityï¼Œ è¿™ä¸ªåç§°å¹¶ä¸æ˜¯è¯´å®ƒå’Œ Spring å°±æ²¡æœ‰å…³ç³»ï¼Œå®ƒä¾ç„¶æ˜¯ä¸ºSpring æ¡†æ¶æä¾›å®‰å…¨æ”¯æŒçš„ã€‚Acegi Security åŸºäº Springï¼Œå¯ä»¥å¸®åŠ©æˆ‘ä»¬ä¸ºé¡¹ç›®å»ºç«‹ä¸°å¯Œçš„è§’è‰²ä¸æƒé™ç®¡ç†ç³»ç»Ÿã€‚Acegi security è™½ç„¶å¥½ç”¨ï¼Œä½†æ˜¯æœ€ä¸ºäººè¯Ÿç—…çš„åˆ™æ˜¯å®ƒè‡ƒè‚¿çƒ¦ççš„é…ç½®è¿™ä¸€é—®é¢˜æœ€ç»ˆä¹Ÿé—ä¼ ç»™äº† Spring Securityã€‚</p><p>â€‹Acegi Security æœ€ç»ˆè¢«å¹¶å…¥ Spring Security é¡¹ç›®ä¸­ï¼Œå¹¶äº 2008 å¹´4æœˆå‘å¸ƒäº†æ”¹ååçš„ç¬¬ä¸€ä¸ªç‰ˆæœ¬ Spring Security 2.0.0ï¼Œåˆ°ç›®å‰ä¸ºæ­¢ï¼ŒSpring Security çš„æœ€æ–°ç‰ˆæœ¬å·±ç»åˆ°äº† 5.6.1ã€‚å’Œ Shiro ç›¸æ¯”ï¼ŒSpring Securityé‡é‡çº§å¹¶ä¸”é…ç½®çƒ¦çï¼Œç›´è‡³ä»Šå¤©ï¼Œä¾ç„¶æœ‰äººä»¥æ­¤ä¸ºç†ç”±è€Œæ‹’ç»äº†è§£ Spring Securityã€‚å…¶å®ï¼Œè‡ªä» Spring Boot æ¨å‡ºåï¼Œå°±å½»åº•é¢ è¦†äº†ä¼ ç»Ÿäº† JavaEE å¼€å‘ï¼Œè‡ªåŠ¨åŒ–é…ç½®è®©è®¸å¤šäº‹æƒ…å˜å¾—éå¸¸å®¹æ˜“ï¼ŒåŒ…æ‹¬ Spring Security çš„é…ç½®ã€‚åœ¨ä¸€ä¸ª Spring Boot é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬ç”šè‡³åªéœ€è¦å¼•å…¥ä¸€ä¸ªä¾èµ–ï¼Œä¸éœ€è¦ä»»ä½•é¢å¤–é…ç½®ï¼Œé¡¹ç›®çš„æ‰€æœ‰æ¥å£å°±ä¼šè¢«è‡ªåŠ¨ä¿æŠ¤èµ·æ¥äº†ã€‚åœ¨ Spring Cloudä¸­ï¼Œå¾ˆå¤šæ¶‰åŠå®‰å…¨ç®¡ç†çš„é—®é¢˜ï¼Œä¹Ÿæ˜¯ä¸€ä¸ª Spring Security ä¾èµ–ä¸¤è¡Œé…ç½®å°±èƒ½æå®šï¼Œåœ¨å’Œ Spring å®¶æ—çš„äº§å“ä¸€èµ·ä½¿ç”¨æ—¶ï¼ŒSpring Security çš„ä¼˜åŠ¿å°±éå¸¸æ˜æ˜¾äº†ã€‚</p><p>â€‹å› æ­¤ï¼Œåœ¨å¾®æœåŠ¡æ—¶ä»£ï¼Œæˆ‘ä»¬ä¸éœ€è¦çº ç»“è¦ä¸è¦å­¦ä¹  Spring Securityï¼Œæˆ‘ä»¬è¦è€ƒè™‘çš„æ˜¯å¦‚ä½•å¿«é€ŸæŒæ¡Spring Securityï¼Œ å¹¶ä¸”èƒ½å¤Ÿä½¿ç”¨ Spring Security å®ç°æˆ‘ä»¬å¾®æœåŠ¡çš„å®‰å…¨ç®¡ç†ã€‚</p><h2 id="æ•´ä½“æ¶æ„"><a href="#æ•´ä½“æ¶æ„" class="headerlink" title="æ•´ä½“æ¶æ„"></a>æ•´ä½“æ¶æ„</h2><p>åœ¨<Spring Security>çš„æ¶æ„è®¾è®¡ä¸­ï¼Œ<strong>è®¤è¯</strong><Authentication>å’Œ<strong>æˆæƒ</strong> <Authorization>æ˜¯åˆ†å¼€çš„ï¼Œæ— è®ºä½¿ç”¨ä»€ä¹ˆæ ·çš„è®¤è¯æ–¹å¼ã€‚éƒ½ä¸ä¼šå½±å“æˆæƒï¼Œè¿™æ˜¯ä¸¤ä¸ªç‹¬ç«‹çš„å­˜åœ¨ï¼Œè¿™ç§ç‹¬ç«‹å¸¦æ¥çš„å¥½å¤„ä¹‹ä¸€ï¼Œå°±æ˜¯å¯ä»¥éå¸¸æ–¹ä¾¿åœ°æ•´åˆä¸€äº›å¤–éƒ¨çš„è§£å†³æ–¹æ¡ˆã€‚</p><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220110112541559.png" class=""> <h3 id="è®¤è¯-1"><a href="#è®¤è¯-1" class="headerlink" title="è®¤è¯"></a>è®¤è¯</h3><h4 id="AuthenticationManager"><a href="#AuthenticationManager" class="headerlink" title="AuthenticationManager"></a>AuthenticationManager</h4><p>åœ¨Spring Securityä¸­è®¤è¯æ˜¯ç”±<code>AuthenticationManager</code>æ¥å£æ¥è´Ÿè´£çš„ï¼Œæ¥å£å®šä¹‰ä¸ºï¼š</p><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220110104531129.png" class=""> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">AuthenticationManager</span> &#123; </span><br><span class="line">Authentication <span class="title function_">authenticate</span><span class="params">(Authentication authentication)</span> </span><br><span class="line">  <span class="keyword">throws</span> AuthenticationException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>è¿”å› Authentication è¡¨ç¤ºè®¤è¯æˆåŠŸ</li><li>è¿”å› AuthenticationException å¼‚å¸¸ï¼Œè¡¨ç¤ºè®¤è¯å¤±è´¥ã€‚</li></ul><p>AuthenticationManager ä¸»è¦å®ç°ç±»ä¸º ProviderManagerï¼Œåœ¨ ProviderManager ä¸­ç®¡ç†äº†ä¼—å¤š AuthenticationProvider å®ä¾‹ã€‚åœ¨ä¸€æ¬¡å®Œæ•´çš„è®¤è¯æµç¨‹ä¸­ï¼ŒSpring Security å…è®¸å­˜åœ¨å¤šä¸ª AuthenticationProvider ï¼Œç”¨æ¥å®ç°å¤šç§è®¤è¯æ–¹å¼ï¼Œè¿™äº› AuthenticationProvider éƒ½æ˜¯ç”± ProviderManager è¿›è¡Œç»Ÿä¸€ç®¡ç†çš„ã€‚</p><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220110103518334.png" class=""><h4 id="Authentication"><a href="#Authentication" class="headerlink" title="Authentication"></a>Authentication</h4><p>è®¤è¯ä»¥åŠè®¤è¯æˆåŠŸçš„ä¿¡æ¯ä¸»è¦æ˜¯ç”± Authentication çš„å®ç°ç±»è¿›è¡Œä¿å­˜çš„ï¼Œå…¶æ¥å£å®šä¹‰ä¸ºï¼š</p><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220110104815645.png" class=""><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Authentication</span> <span class="keyword">extends</span> <span class="title class_">Principal</span>, Serializable &#123;</span><br><span class="line">Collection&lt;? <span class="keyword">extends</span> <span class="title class_">GrantedAuthority</span>&gt; getAuthorities();</span><br><span class="line">Object <span class="title function_">getCredentials</span><span class="params">()</span>;</span><br><span class="line">Object <span class="title function_">getDetails</span><span class="params">()</span>;</span><br><span class="line">Object <span class="title function_">getPrincipal</span><span class="params">()</span>;</span><br><span class="line"><span class="type">boolean</span> <span class="title function_">isAuthenticated</span><span class="params">()</span>;</span><br><span class="line"><span class="keyword">void</span> <span class="title function_">setAuthenticated</span><span class="params">(<span class="type">boolean</span> isAuthenticated)</span> <span class="keyword">throws</span> IllegalArgumentException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>getAuthorities  è·å–ç”¨æˆ·æƒé™ä¿¡æ¯</li><li>getCredentials è·å–ç”¨æˆ·å‡­è¯ä¿¡æ¯ï¼Œä¸€èˆ¬æŒ‡å¯†ç </li><li>getDetails  è·å–ç”¨æˆ·è¯¦ç»†ä¿¡æ¯</li><li>getPrincipal  è·å–ç”¨æˆ·èº«ä»½ä¿¡æ¯ï¼Œç”¨æˆ·åã€ç”¨æˆ·å¯¹è±¡ç­‰</li><li>isAuthenticated   ç”¨æˆ·æ˜¯å¦è®¤è¯æˆåŠŸ</li></ul><h4 id="SecurityContextHolder"><a href="#SecurityContextHolder" class="headerlink" title="SecurityContextHolder"></a>SecurityContextHolder</h4><p>SecurityContextHolder ç”¨æ¥è·å–ç™»å½•ä¹‹åç”¨æˆ·ä¿¡æ¯ã€‚Spring Security ä¼šå°†ç™»å½•ç”¨æˆ·æ•°æ®ä¿å­˜åœ¨ Session ä¸­ã€‚ä½†æ˜¯ï¼Œä¸ºäº†ä½¿ç”¨æ–¹ä¾¿,Spring Securityåœ¨æ­¤åŸºç¡€ä¸Šè¿˜åšäº†ä¸€äº›æ”¹è¿›ï¼Œå…¶ä¸­æœ€ä¸»è¦çš„ä¸€ä¸ªå˜åŒ–å°±æ˜¯çº¿ç¨‹ç»‘å®šã€‚å½“ç”¨æˆ·ç™»å½•æˆåŠŸå,Spring Security ä¼šå°†ç™»å½•æˆåŠŸçš„ç”¨æˆ·ä¿¡æ¯ä¿å­˜åˆ° SecurityContextHolder ä¸­ã€‚SecurityContextHolder ä¸­çš„æ•°æ®ä¿å­˜é»˜è®¤æ˜¯é€šè¿‡ThreadLocal æ¥å®ç°çš„ï¼Œä½¿ç”¨ ThreadLocal åˆ›å»ºçš„å˜é‡åªèƒ½è¢«å½“å‰çº¿ç¨‹è®¿é—®ï¼Œä¸èƒ½è¢«å…¶ä»–çº¿ç¨‹è®¿é—®å’Œä¿®æ”¹ï¼Œä¹Ÿå°±æ˜¯ç”¨æˆ·æ•°æ®å’Œè¯·æ±‚çº¿ç¨‹ç»‘å®šåœ¨ä¸€èµ·ã€‚å½“ç™»å½•è¯·æ±‚å¤„ç†å®Œæ¯•åï¼ŒSpring Security ä¼šå°† SecurityContextHolder ä¸­çš„æ•°æ®æ‹¿å‡ºæ¥ä¿å­˜åˆ° Session ä¸­ï¼ŒåŒæ—¶å°† SecurityContexHolder ä¸­çš„æ•°æ®æ¸…ç©ºã€‚ä»¥åæ¯å½“æœ‰è¯·æ±‚åˆ°æ¥æ—¶ï¼ŒSpring Security å°±ä¼šå…ˆä» Session ä¸­å–å‡ºç”¨æˆ·ç™»å½•æ•°æ®ï¼Œä¿å­˜åˆ° SecurityContextHolder ä¸­ï¼Œæ–¹ä¾¿åœ¨è¯¥è¯·æ±‚çš„åç»­å¤„ç†è¿‡ç¨‹ä¸­ä½¿ç”¨ï¼ŒåŒæ—¶åœ¨è¯·æ±‚ç»“æŸæ—¶å°† SecurityContextHolder ä¸­çš„æ•°æ®æ‹¿å‡ºæ¥ä¿å­˜åˆ° Session ä¸­ï¼Œç„¶åå°† Security SecurityContextHolder ä¸­çš„æ•°æ®æ¸…ç©ºã€‚è¿™ä¸€ç­–ç•¥éå¸¸æ–¹ä¾¿ç”¨æˆ·åœ¨ Controllerã€Service å±‚ä»¥åŠä»»ä½•ä»£ç ä¸­è·å–å½“å‰ç™»å½•ç”¨æˆ·æ•°æ®ã€‚</p><h3 id="æˆæƒ-1"><a href="#æˆæƒ-1" class="headerlink" title="æˆæƒ"></a>æˆæƒ</h3><p>å½“å®Œæˆè®¤è¯åï¼Œæ¥ä¸‹æ¥å°±æ˜¯æˆæƒäº†ã€‚åœ¨ Spring Security çš„æˆæƒä½“ç³»ä¸­ï¼Œæœ‰ä¸¤ä¸ªå…³é”®æ¥å£ï¼Œ</p><h4 id="AccessDecisionManager"><a href="#AccessDecisionManager" class="headerlink" title="AccessDecisionManager"></a>AccessDecisionManager</h4><blockquote><p> AccessDecisionManager (è®¿é—®å†³ç­–ç®¡ç†å™¨)ï¼Œç”¨æ¥å†³å®šæ­¤æ¬¡è®¿é—®æ˜¯å¦è¢«å…è®¸ã€‚</p></blockquote><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220110110946267.png" class=""><h4 id="AccessDecisionVoter"><a href="#AccessDecisionVoter" class="headerlink" title="AccessDecisionVoter"></a>AccessDecisionVoter</h4><blockquote><p>AccessDecisionVoter (è®¿é—®å†³å®šæŠ•ç¥¨å™¨)ï¼ŒæŠ•ç¥¨å™¨ä¼šæ£€æŸ¥ç”¨æˆ·æ˜¯å¦å…·å¤‡åº”æœ‰çš„è§’è‰²ï¼Œè¿›è€ŒæŠ•å‡ºèµæˆã€åå¯¹æˆ–è€…å¼ƒæƒç¥¨ã€‚</p></blockquote><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220110111011018.png" class=""><p>AccesDecisionVoter å’Œ AccessDecisionManager éƒ½æœ‰ä¼—å¤šçš„å®ç°ç±»ï¼Œåœ¨ AccessDecisionManager ä¸­ä¼šæ¢ä¸ªéå† AccessDecisionVoterï¼Œè¿›è€Œå†³å®šæ˜¯å¦å…è®¸ç”¨æˆ·è®¿é—®ï¼Œå› è€Œ AaccesDecisionVoter å’Œ AccessDecisionManager ä¸¤è€…çš„å…³ç³»ç±»ä¼¼äº AuthenticationProvider å’Œ ProviderManager çš„å…³ç³»ã€‚</p><h4 id="ConfigAttribute"><a href="#ConfigAttribute" class="headerlink" title="ConfigAttribute"></a>ConfigAttribute</h4><blockquote><p>ConfigAttributeï¼Œç”¨æ¥ä¿å­˜æˆæƒæ—¶çš„è§’è‰²ä¿¡æ¯</p></blockquote><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220110111037603.png" class=""><p>åœ¨ Spring Security ä¸­ï¼Œç”¨æˆ·è¯·æ±‚ä¸€ä¸ªèµ„æº(é€šå¸¸æ˜¯ä¸€ä¸ªæ¥å£æˆ–è€…ä¸€ä¸ª Java æ–¹æ³•)éœ€è¦çš„è§’è‰²ä¼šè¢«å°è£…æˆä¸€ä¸ª ConfigAttribute å¯¹è±¡ï¼Œåœ¨ ConfigAttribute ä¸­åªæœ‰ä¸€ä¸ª getAttributeæ–¹æ³•ï¼Œè¯¥æ–¹æ³•è¿”å›ä¸€ä¸ª String å­—ç¬¦ä¸²ï¼Œå°±æ˜¯è§’è‰²çš„åç§°ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œè§’è‰²åç§°éƒ½å¸¦æœ‰ä¸€ä¸ª <code>ROLE_</code> å‰ç¼€ï¼ŒæŠ•ç¥¨å™¨ AccessDecisionVoter æ‰€åšçš„äº‹æƒ…ï¼Œå…¶å®å°±æ˜¯æ¯”è¾ƒç”¨æˆ·æ‰€å…·å„çš„è§’è‰²å’Œè¯·æ±‚æŸä¸ª<br>èµ„æºæ‰€éœ€çš„ ConfigAtuibute ä¹‹é—´çš„å…³ç³»ã€‚</p><h1 id="ç¬¬äºŒç« -ç¯å¢ƒæ­å»º"><a href="#ç¬¬äºŒç« -ç¯å¢ƒæ­å»º" class="headerlink" title="ç¬¬äºŒç«  ç¯å¢ƒæ­å»º"></a>ç¬¬äºŒç«  ç¯å¢ƒæ­å»º</h1><ul><li>ç¯å¢ƒæ­å»º</li><li>è‡ªåŠ¨é…ç½®ç»†èŠ‚</li></ul><h2 id="ç¯å¢ƒæ­å»º"><a href="#ç¯å¢ƒæ­å»º" class="headerlink" title="ç¯å¢ƒæ­å»º"></a>ç¯å¢ƒæ­å»º</h2><ul><li>spring boot </li><li>spring security<ul><li>è®¤è¯: åˆ¤æ–­ç”¨æˆ·æ˜¯å¦æ˜¯ç³»ç»Ÿåˆæ³•ç”¨æˆ·è¿‡ç¨‹</li><li>æˆæƒ: åˆ¤æ–­ç³»ç»Ÿå†…ç”¨æˆ·å¯ä»¥è®¿é—®æˆ–å…·æœ‰è®¿é—®é‚£äº›èµ„æºæƒé™è¿‡ç¨‹</li></ul></li></ul><h3 id="åˆ›å»ºé¡¹ç›®"><a href="#åˆ›å»ºé¡¹ç›®" class="headerlink" title="åˆ›å»ºé¡¹ç›®"></a>åˆ›å»ºé¡¹ç›®</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 1.åˆ›å»º springboot åº”ç”¨</span></span><br></pre></td></tr></table></figure><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220110113408799.png" class=""><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 2.åˆ›å»º controller</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloController</span> &#123;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/hello&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;hello security&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;hello security&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220110113534290.png" class=""><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 3.å¯åŠ¨é¡¹ç›®è¿›è¡Œæµ‹è¯•</span></span><br><span class="line"><span class="bullet">-</span> http://localhost:8080/hello</span><br></pre></td></tr></table></figure><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220110113757100.png" class=""><h3 id="æ•´åˆ-Spring-Security"><a href="#æ•´åˆ-Spring-Security" class="headerlink" title="æ•´åˆ Spring Security"></a>æ•´åˆ Spring Security</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 1.å¼•å…¥spring securityç›¸å…³ä¾èµ–</span></span><br></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--å¼•å…¥spring securityä¾èµ–--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 2.å†æ¬¡å¯åŠ¨é¡¹ç›®</span></span><br><span class="line"><span class="bullet">-</span> 1.å¯åŠ¨å®Œæˆåæ§åˆ¶å°ç”Ÿæˆä¸€ä¸ªå¯†ç </span><br><span class="line"><span class="bullet">-</span> 2.è®¿é—® hello å‘ç°ç›´æ¥è·³è½¬åˆ°ç™»å½•é¡µé¢</span><br></pre></td></tr></table></figure><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220110114044889.png" class=""><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220110114109713.png" class=""><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 3.ç™»å½•ç³»ç»Ÿ</span></span><br><span class="line"><span class="bullet">-</span> é»˜è®¤ç”¨æˆ·åä¸º: user</span><br><span class="line"><span class="bullet">-</span> é»˜è®¤å¯†ç ä¸º:  æ§åˆ¶å°æ‰“å°çš„ uuid</span><br></pre></td></tr></table></figure><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220110114258671.png" class=""><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220110114227714.png" class=""><p><strong>è¿™å°±æ˜¯ Spring Security çš„å¼ºå¤§ä¹‹å¤„ï¼Œåªéœ€è¦å¼•å…¥ä¸€ä¸ªä¾èµ–ï¼Œæ‰€æœ‰çš„æ¥å£å°±ä¼šè‡ªåŠ¨ä¿æŠ¤èµ·æ¥ï¼</strong></p><p>æ€è€ƒğŸ¤”?</p><ul><li><p>ä¸ºä»€ä¹ˆå¼•å…¥ Spring Security ä¹‹å<code>æ²¡æœ‰ä»»ä½•é…ç½®æ‰€æœ‰è¯·æ±‚å°±è¦è®¤è¯</code>å‘¢?</p></li><li><p>åœ¨é¡¹ç›®ä¸­æ˜æ˜æ²¡æœ‰ç™»å½•ç•Œé¢ï¼Œ<code>ç™»å½•ç•Œé¢</code>æ€ä¹ˆæ¥çš„å‘¢ï¼Ÿ</p></li><li><p>ä¸ºä»€ä¹ˆä½¿ç”¨ <code>user</code> å’Œ <code>æ§åˆ¶å°å¯†ç </code> èƒ½ç™»é™†ï¼Œç™»å½•æ—¶éªŒè¯æ•°æ®æºå­˜åœ¨å“ªé‡Œå‘¢ï¼Ÿ</p></li></ul><h3 id="å®ç°åŸç†"><a href="#å®ç°åŸç†" class="headerlink" title="å®ç°åŸç†"></a>å®ç°åŸç†</h3><p><a href="https://docs.spring.io/spring-security/site/docs/5.5.4/reference/html5/#servlet-architecture">https://docs.spring.io/spring-security/site/docs/5.5.4/reference/html5/#servlet-architecture</a></p><p>è™½ç„¶å¼€å‘è€…åªéœ€è¦å¼•å…¥ä¸€ä¸ªä¾èµ–ï¼Œå°±å¯ä»¥è®© Spring Security å¯¹åº”ç”¨è¿›è¡Œä¿æŠ¤ã€‚Spring Security åˆæ˜¯å¦‚ä½•åšåˆ°çš„å‘¢ï¼Ÿ</p><p>åœ¨ Spring Security ä¸­ <code>è®¤è¯ã€æˆæƒ</code> ç­‰åŠŸèƒ½éƒ½æ˜¯åŸºäº<a href="https://docs.spring.io/spring-security/site/docs/5.5.4/reference/html5/#servlet-architecture">è¿‡æ»¤å™¨</a>å®Œæˆçš„ã€‚</p><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220110120349053.png" class=""><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220110115946010.png" class=""><p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œé»˜è®¤è¿‡æ»¤å™¨å¹¶ä¸æ˜¯ç›´æ¥æ”¾åœ¨ Web é¡¹ç›®çš„åŸç”Ÿè¿‡æ»¤å™¨é“¾ä¸­ï¼Œè€Œæ˜¯é€šè¿‡ä¸€ä¸ª<br>FlterChainProxy æ¥ç»Ÿä¸€ç®¡ç†ã€‚Spring Security ä¸­çš„è¿‡æ»¤å™¨é“¾é€šè¿‡ FilterChainProxy åµŒå…¥åˆ° Webé¡¹ç›®çš„åŸç”Ÿè¿‡æ»¤å™¨é“¾ä¸­ã€‚FilterChainProxy  ä½œä¸ºä¸€ä¸ªé¡¶å±‚çš„ç®¡ç†è€…ï¼Œå°†ç»Ÿä¸€ç®¡ç† Security Filterã€‚FilterChainProxy æœ¬èº«æ˜¯é€šè¿‡ Spring æ¡†æ¶æä¾›çš„ DelegatingFilterProxy æ•´åˆåˆ°åŸç”Ÿçš„è¿‡æ»¤å™¨é“¾ä¸­ã€‚</p><h3 id="Security-Filters"><a href="#Security-Filters" class="headerlink" title="Security Filters"></a>Security Filters</h3><p>é‚£ä¹ˆåœ¨ Spring Security ä¸­ç»™æˆ‘ä»¬æä¾›é‚£äº›è¿‡æ»¤å™¨? é»˜è®¤æƒ…å†µä¸‹é‚£äº›è¿‡æ»¤å™¨ä¼šè¢«åŠ è½½å‘¢ï¼Ÿ</p><table><thead><tr><th>è¿‡æ»¤å™¨</th><th>è¿‡æ»¤å™¨ä½œç”¨</th><th>é»˜è®¤æ˜¯å¦åŠ è½½</th></tr></thead><tbody><tr><td>ChannelProcessingFilter</td><td>è¿‡æ»¤è¯·æ±‚åè®® HTTP ã€HTTPS</td><td>NO</td></tr><tr><td><code>WebAsyncManagerIntegrationFilter</code></td><td>å°† WebAsyncManger ä¸ SpringSecurity ä¸Šä¸‹æ–‡è¿›è¡Œé›†æˆ</td><td>YES</td></tr><tr><td><code>SecurityContextPersistenceFilter</code></td><td>åœ¨å¤„ç†è¯·æ±‚ä¹‹å‰,å°†å®‰å…¨ä¿¡æ¯åŠ è½½åˆ° SecurityContextHolder ä¸­</td><td>YES</td></tr><tr><td><code>HeaderWriterFilter</code></td><td>å¤„ç†å¤´ä¿¡æ¯åŠ å…¥å“åº”ä¸­</td><td>YES</td></tr><tr><td>CorsFilter</td><td>å¤„ç†è·¨åŸŸé—®é¢˜</td><td>NO</td></tr><tr><td><code>CsrfFilter</code></td><td>å¤„ç† CSRF æ”»å‡»</td><td>YES</td></tr><tr><td><code>LogoutFilter</code></td><td>å¤„ç†æ³¨é”€ç™»å½•</td><td>YES</td></tr><tr><td>OAuth2AuthorizationRequestRedirectFilter</td><td>å¤„ç† OAuth2 è®¤è¯é‡å®šå‘</td><td>NO</td></tr><tr><td>Saml2WebSsoAuthenticationRequestFilter</td><td>å¤„ç† SAML è®¤è¯</td><td>NO</td></tr><tr><td>X509AuthenticationFilter</td><td>å¤„ç† X509 è®¤è¯</td><td>NO</td></tr><tr><td>AbstractPreAuthenticatedProcessingFilter</td><td>å¤„ç†é¢„è®¤è¯é—®é¢˜</td><td>NO</td></tr><tr><td>CasAuthenticationFilter</td><td>å¤„ç† CAS å•ç‚¹ç™»å½•</td><td>NO</td></tr><tr><td><code>OAuth2LoginAuthenticationFilter</code></td><td>å¤„ç† OAuth2 è®¤è¯</td><td>NO</td></tr><tr><td>Saml2WebSsoAuthenticationFilter</td><td>å¤„ç† SAML è®¤è¯</td><td>NO</td></tr><tr><td><code>UsernamePasswordAuthenticationFilter</code></td><td>å¤„ç†è¡¨å•ç™»å½•</td><td>YES</td></tr><tr><td>OpenIDAuthenticationFilter</td><td>å¤„ç† OpenID è®¤è¯</td><td>NO</td></tr><tr><td><code>DefaultLoginPageGeneratingFilter</code></td><td>é…ç½®é»˜è®¤ç™»å½•é¡µé¢</td><td>YES</td></tr><tr><td><code>DefaultLogoutPageGeneratingFilter</code></td><td>é…ç½®é»˜è®¤æ³¨é”€é¡µé¢</td><td>YES</td></tr><tr><td>ConcurrentSessionFilter</td><td>å¤„ç† Session æœ‰æ•ˆæœŸ</td><td>NO</td></tr><tr><td>DigestAuthenticationFilter</td><td>å¤„ç† HTTP æ‘˜è¦è®¤è¯</td><td>NO</td></tr><tr><td>BearerTokenAuthenticationFilter</td><td>å¤„ç† OAuth2 è®¤è¯çš„ Access Token</td><td>NO</td></tr><tr><td><code>BasicAuthenticationFilter</code></td><td>å¤„ç† HttpBasic ç™»å½•</td><td>YES</td></tr><tr><td><code>RequestCacheAwareFilter</code></td><td>å¤„ç†è¯·æ±‚ç¼“å­˜</td><td>YES</td></tr><tr><td><code>SecurityContextHolder&lt;br /&gt;AwareRequestFilter</code></td><td>åŒ…è£…åŸå§‹è¯·æ±‚</td><td>YES</td></tr><tr><td>JaasApiIntegrationFilter</td><td>å¤„ç† JAAS è®¤è¯</td><td>NO</td></tr><tr><td><code>RememberMeAuthenticationFilter</code></td><td>å¤„ç† RememberMe ç™»å½•</td><td>NO</td></tr><tr><td><code>AnonymousAuthenticationFilter</code></td><td>é…ç½®åŒ¿åè®¤è¯</td><td>YES</td></tr><tr><td><code>OAuth2AuthorizationCodeGrantFilter</code></td><td>å¤„ç†OAuth2è®¤è¯ä¸­æˆæƒç </td><td>NO</td></tr><tr><td><code>SessionManagementFilter</code></td><td>å¤„ç† session å¹¶å‘é—®é¢˜</td><td>YES</td></tr><tr><td><code>ExceptionTranslationFilter</code></td><td>å¤„ç†è®¤è¯&#x2F;æˆæƒä¸­çš„å¼‚å¸¸</td><td>YES</td></tr><tr><td><code>FilterSecurityInterceptor</code></td><td>å¤„ç†æˆæƒç›¸å…³</td><td>YES</td></tr><tr><td>SwitchUserFilter</td><td>å¤„ç†è´¦æˆ·åˆ‡æ¢</td><td>NO</td></tr></tbody></table><p>å¯ä»¥çœ‹å‡ºï¼ŒSpring Security æä¾›äº† 30 å¤šä¸ªè¿‡æ»¤å™¨ã€‚é»˜è®¤æƒ…å†µä¸‹Spring Boot åœ¨å¯¹ Spring Security è¿›å…¥è‡ªåŠ¨åŒ–é…ç½®æ—¶ï¼Œä¼šåˆ›å»ºä¸€ä¸ªåä¸º SpringSecurityFilerChain çš„è¿‡æ»¤å™¨ï¼Œå¹¶æ³¨å…¥åˆ° Spring å®¹å™¨ä¸­ï¼Œè¿™ä¸ªè¿‡æ»¤å™¨å°†è´Ÿè´£æ‰€æœ‰çš„å®‰å…¨ç®¡ç†ï¼ŒåŒ…æ‹¬ç”¨æˆ·è®¤è¯ã€æˆæƒã€é‡å®šå‘åˆ°ç™»å½•é¡µé¢ç­‰ã€‚å…·ä½“å¯ä»¥å‚è€ƒWebSecurityConfigurationçš„æºç :</p><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220111211538604.png" class=""><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220111211436764.png" class=""><h3 id="SpringBootWebSecurityConfiguration"><a href="#SpringBootWebSecurityConfiguration" class="headerlink" title="SpringBootWebSecurityConfiguration"></a>SpringBootWebSecurityConfiguration</h3><p>è¿™ä¸ªç±»æ˜¯ spring boot è‡ªåŠ¨é…ç½®ç±»ï¼Œé€šè¿‡è¿™ä¸ªæºç å¾—çŸ¥ï¼Œé»˜è®¤æƒ…å†µä¸‹å¯¹æ‰€æœ‰è¯·æ±‚è¿›è¡Œæƒé™æ§åˆ¶:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="meta">@ConditionalOnDefaultWebSecurity</span></span><br><span class="line"><span class="meta">@ConditionalOnWebApplication(type = Type.SERVLET)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SpringBootWebSecurityConfiguration</span> &#123;</span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@Order(SecurityProperties.BASIC_AUTH_ORDER)</span></span><br><span class="line">SecurityFilterChain <span class="title function_">defaultSecurityFilterChain</span><span class="params">(HttpSecurity http)</span> </span><br><span class="line">    <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">http.authorizeRequests().anyRequest()</span><br><span class="line">      .authenticated().and().formLogin().and().httpBasic();</span><br><span class="line"><span class="keyword">return</span> http.build();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220112095052138.png" class=""><p><strong>è¿™å°±æ˜¯ä¸ºä»€ä¹ˆåœ¨å¼•å…¥ Spring Security ä¸­æ²¡æœ‰ä»»ä½•é…ç½®æƒ…å†µä¸‹ï¼Œè¯·æ±‚ä¼šè¢«æ‹¦æˆªçš„åŸå› ï¼</strong></p><p>é€šè¿‡ä¸Šé¢å¯¹è‡ªåŠ¨é…ç½®åˆ†æï¼Œæˆ‘ä»¬ä¹Ÿèƒ½çœ‹å‡ºé»˜è®¤ç”Ÿæ•ˆæ¡ä»¶ä¸º:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">DefaultWebSecurityCondition</span> <span class="keyword">extends</span> <span class="title class_">AllNestedConditions</span> &#123;</span><br><span class="line"></span><br><span class="line">DefaultWebSecurityCondition() &#123;</span><br><span class="line"><span class="built_in">super</span>(ConfigurationPhase.REGISTER_BEAN);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ConditionalOnClass(&#123; SecurityFilterChain.class, HttpSecurity.class &#125;)</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Classes</span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean(&#123; WebSecurityConfigurerAdapter.class, SecurityFilterChain.class &#125;)</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Beans</span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>æ¡ä»¶ä¸€ classpathä¸­å­˜åœ¨ SecurityFilterChain.class, HttpSecurity.class</li><li>æ¡ä»¶äºŒ æ²¡æœ‰è‡ªå®šä¹‰ WebSecurityConfigurerAdapter.class, SecurityFilterChain.class</li></ul><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œæ¡ä»¶éƒ½æ˜¯æ»¡è¶³çš„ã€‚WebSecurityConfigurerAdapter è¿™ä¸ªç±»æå…¶é‡è¦ï¼ŒSpring Security æ ¸å¿ƒé…ç½®éƒ½åœ¨è¿™ä¸ªç±»ä¸­:</p><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220112095638356.png" class=""><p>å¦‚æœè¦å¯¹ Spring Security è¿›è¡Œè‡ªå®šä¹‰é…ç½®ï¼Œå°±è¦è‡ªå®šä¹‰è¿™ä¸ªç±»å®ä¾‹ï¼Œé€šè¿‡è¦†ç›–ç±»ä¸­æ–¹æ³•è¾¾åˆ°ä¿®æ”¹é»˜è®¤é…ç½®çš„ç›®çš„ã€‚</p><h3 id="æµç¨‹åˆ†æ"><a href="#æµç¨‹åˆ†æ" class="headerlink" title="æµç¨‹åˆ†æ"></a>æµç¨‹åˆ†æ</h3><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220111100643506.png" class=""><ol><li>è¯·æ±‚ &#x2F;hello æ¥å£ï¼Œåœ¨å¼•å…¥ spring security ä¹‹åä¼šå…ˆç»è¿‡ä¸€äº›åˆ—è¿‡æ»¤å™¨</li><li>åœ¨è¯·æ±‚åˆ°è¾¾ FilterSecurityInterceptoræ—¶ï¼Œå‘ç°è¯·æ±‚å¹¶æœªè®¤è¯ã€‚è¯·æ±‚æ‹¦æˆªä¸‹æ¥ï¼Œå¹¶æŠ›å‡º AccessDeniedException å¼‚å¸¸ã€‚</li><li>æŠ›å‡º AccessDeniedException çš„å¼‚å¸¸ä¼šè¢« ExceptionTranslationFilter æ•è·ï¼Œè¿™ä¸ª Filter ä¸­ä¼šè°ƒç”¨ LoginUrlAuthenticationEntryPoint#commence æ–¹æ³•ç»™å®¢æˆ·ç«¯è¿”å› 302ï¼Œè¦æ±‚å®¢æˆ·ç«¯è¿›è¡Œé‡å®šå‘åˆ° &#x2F;login é¡µé¢ã€‚</li><li>å®¢æˆ·ç«¯å‘é€ &#x2F;login è¯·æ±‚ã€‚</li><li>&#x2F;login è¯·æ±‚ä¼šå†æ¬¡è¢«æ‹¦æˆªå™¨ä¸­ DefaultLoginPageGeneratingFilter æ‹¦æˆªåˆ°ï¼Œå¹¶åœ¨æ‹¦æˆªå™¨ä¸­è¿”å›ç”Ÿæˆç™»å½•é¡µé¢ã€‚</li></ol><p><strong>å°±æ˜¯é€šè¿‡è¿™ç§æ–¹å¼ï¼ŒSpring Security é»˜è®¤è¿‡æ»¤å™¨ä¸­ç”Ÿæˆäº†ç™»å½•é¡µé¢ï¼Œå¹¶è¿”å›ï¼</strong></p><h3 id="é»˜è®¤ç”¨æˆ·ç”Ÿæˆ"><a href="#é»˜è®¤ç”¨æˆ·ç”Ÿæˆ" class="headerlink" title="é»˜è®¤ç”¨æˆ·ç”Ÿæˆ"></a>é»˜è®¤ç”¨æˆ·ç”Ÿæˆ</h3><ol><li>æŸ¥çœ‹ SpringBootWebSecurityConfiguration#defaultSecurityFilterChain æ–¹æ³•è¡¨å•ç™»å½•</li></ol><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220112141503914.png" class=""><ol start="2"><li>å¤„ç†ç™»å½•ä¸º FormLoginConfigurer ç±»ä¸­ è°ƒç”¨ UsernamePasswordAuthenticationFilterè¿™ä¸ªç±»å®ä¾‹</li></ol><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220111104043636.png" class=""><ol start="3"><li>æŸ¥çœ‹ç±»ä¸­ UsernamePasswordAuthenticationFilter#attempAuthentication æ–¹æ³•å¾—çŸ¥å®é™…è°ƒç”¨ AuthenticationManager ä¸­ authenticate æ–¹æ³•</li></ol><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220111103955782.png" class=""><ol start="4"><li>è°ƒç”¨ ProviderManager ç±»ä¸­æ–¹æ³• authenticate</li></ol><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220111104357476.png" class=""><ol start="5"><li>è°ƒç”¨äº† ProviderManager å®ç°ç±»ä¸­ AbstractUserDetailsAuthenticationProviderç±»ä¸­æ–¹æ³•</li></ol><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220111104627002.png" class=""><ol start="6"><li>æœ€ç»ˆè°ƒç”¨å®ç°ç±» DaoAuthenticationProvider ç±»ä¸­æ–¹æ³•æ¯”è¾ƒ</li></ol><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220111105029814.png" class=""><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220111103729166.png" class=""><p><strong>çœ‹åˆ°è¿™é‡Œå°±çŸ¥é“é»˜è®¤å®ç°æ˜¯åŸºäº InMemoryUserDetailsManager è¿™ä¸ªç±»,ä¹Ÿå°±æ˜¯å†…å­˜çš„å®ç°!</strong></p><h3 id="UserDetailService"><a href="#UserDetailService" class="headerlink" title="UserDetailService"></a>UserDetailService</h3><p>é€šè¿‡åˆšæ‰æºç åˆ†æä¹Ÿèƒ½å¾—çŸ¥ UserDetailService æ˜¯é¡¶å±‚çˆ¶æ¥å£ï¼Œæ¥å£ä¸­ loadUserByUserName æ–¹æ³•æ˜¯ç”¨æ¥åœ¨è®¤è¯æ—¶è¿›è¡Œç”¨æˆ·åè®¤è¯æ–¹æ³•ï¼Œé»˜è®¤å®ç°ä½¿ç”¨æ˜¯å†…å­˜å®ç°ï¼Œå¦‚æœæƒ³è¦ä¿®æ”¹æ•°æ®åº“å®ç°æˆ‘ä»¬åªéœ€è¦è‡ªå®šä¹‰ UserDetailService å®ç°ï¼Œæœ€ç»ˆè¿”å› UserDetails å®ä¾‹å³å¯ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserDetailsService</span> &#123;</span><br><span class="line">UserDetails <span class="title function_">loadUserByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220111110043474.png" class=""><h3 id="UserDetailServiceAutoConfigutation"><a href="#UserDetailServiceAutoConfigutation" class="headerlink" title="UserDetailServiceAutoConfigutation"></a>UserDetailServiceAutoConfigutation</h3><p>è¿™ä¸ªæºç éå¸¸å¤šï¼Œè¿™é‡Œæ¢³ç†äº†å…³é”®éƒ¨åˆ†ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration(proxyBeanMethods = false)</span></span><br><span class="line"><span class="meta">@ConditionalOnClass(AuthenticationManager.class)</span></span><br><span class="line"><span class="meta">@ConditionalOnBean(ObjectPostProcessor.class)</span></span><br><span class="line"><span class="meta">@ConditionalOnMissingBean(</span></span><br><span class="line"><span class="meta">value = &#123; AuthenticationManager.class, AuthenticationProvider.class, UserDetailsService.class,</span></span><br><span class="line"><span class="meta">AuthenticationManagerResolver.class &#125;,</span></span><br><span class="line"><span class="meta">type = &#123; &quot;org.springframework.security.oauth2.jwt.JwtDecoder&quot;,</span></span><br><span class="line"><span class="meta">&quot;org.springframework.security.oauth2.server.resource.introspection.OpaqueTokenIntrospector&quot;,</span></span><br><span class="line"><span class="meta">&quot;org.springframework.security.oauth2.client.registration.ClientRegistrationRepository&quot; &#125;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserDetailsServiceAutoConfiguration</span> &#123;</span><br><span class="line">  <span class="comment">//....</span></span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line"><span class="meta">@Lazy</span></span><br><span class="line"><span class="keyword">public</span> InMemoryUserDetailsManager <span class="title function_">inMemoryUserDetailsManager</span><span class="params">(SecurityProperties properties,</span></span><br><span class="line"><span class="params">ObjectProvider&lt;PasswordEncoder&gt; passwordEncoder)</span> &#123;</span><br><span class="line">SecurityProperties.<span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> properties.getUser();</span><br><span class="line">List&lt;String&gt; roles = user.getRoles();</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">InMemoryUserDetailsManager</span>(</span><br><span class="line">User.withUsername(user.getName()).password(getOrDeducePassword(user, passwordEncoder.getIfAvailable()))</span><br><span class="line">.roles(StringUtils.toStringArray(roles)).build());</span><br><span class="line">&#125;</span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ç»“è®º</strong></p><ol><li>ä»è‡ªåŠ¨é…ç½®æºç ä¸­å¾—çŸ¥å½“ classpath ä¸‹å­˜åœ¨ AuthenticationManager ç±»</li><li>å½“å‰é¡¹ç›®ä¸­ï¼Œç³»ç»Ÿæ²¡æœ‰æä¾› AuthenticationManager.classã€ AuthenticationProvider.classã€UserDetailsService.classã€<br>            AuthenticationManagerResolver.classã€å®ä¾‹</li></ol><p><strong>é»˜è®¤æƒ…å†µä¸‹éƒ½ä¼šæ»¡è¶³ï¼Œæ­¤æ—¶Spring Securityä¼šæä¾›ä¸€ä¸ª InMemoryUserDetailManager å®ä¾‹</strong></p><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220111111244739.png" class=""><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;spring.security&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityProperties</span> &#123;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line"><span class="keyword">public</span> User <span class="title function_">getUser</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="built_in">this</span>.user;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//....</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line"><span class="keyword">private</span> <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> <span class="string">&quot;user&quot;</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> UUID.randomUUID().toString();</span><br><span class="line"><span class="keyword">private</span> List&lt;String&gt; roles = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">passwordGenerated</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line"><span class="comment">//get set ...</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>è¿™å°±æ˜¯é»˜è®¤ç”Ÿæˆ user ä»¥åŠ uuid å¯†ç è¿‡ç¨‹! å¦å¤–çœ‹æ˜ç™½æºç ä¹‹åï¼Œå°±çŸ¥é“åªè¦åœ¨é…ç½®æ–‡ä»¶ä¸­åŠ å…¥å¦‚ä¸‹é…ç½®å¯ä»¥å¯¹å†…å­˜ä¸­ç”¨æˆ·å’Œå¯†ç è¿›è¡Œè¦†ç›–ã€‚</strong></p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.security.user.name</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">spring.security.user.password</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">spring.security.user.roles</span>=<span class="string">admin,users</span></span><br></pre></td></tr></table></figure><h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><ul><li>AuthenticationManagerã€ProviderMangerã€ä»¥åŠ AuthenticationProvider å…³ç³»</li></ul><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220112150612023.png" class=""><ul><li><p><strong>WebSecurityConfigurerAdapter</strong> æ‰©å±• Spring Security æ‰€æœ‰é»˜è®¤é…ç½®</p><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220112150820284.png" class=""></li><li><p><strong>UserDetailService</strong> ç”¨æ¥ä¿®æ”¹é»˜è®¤è®¤è¯çš„æ•°æ®æºä¿¡æ¯</p><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220112150929998.png" class=""></li></ul><h1 id="ç¬¬ä¸‰ç« -ç¬¬å››ç« -è®¤è¯åŸç†-amp-è‡ªå®šä¹‰è®¤è¯"><a href="#ç¬¬ä¸‰ç« -ç¬¬å››ç« -è®¤è¯åŸç†-amp-è‡ªå®šä¹‰è®¤è¯" class="headerlink" title="ç¬¬ä¸‰ç« -ç¬¬å››ç«  è®¤è¯åŸç†&amp;è‡ªå®šä¹‰è®¤è¯"></a>ç¬¬ä¸‰ç« -ç¬¬å››ç«  è®¤è¯åŸç†&amp;è‡ªå®šä¹‰è®¤è¯</h1><ul><li>è®¤è¯é…ç½®</li><li>è¡¨å•è®¤è¯</li><li>æ³¨é”€ç™»å½•</li><li>å‰åç«¯åˆ†ç¦»è®¤è¯</li><li>æ·»åŠ éªŒè¯ç </li></ul><h2 id="è‡ªå®šä¹‰è®¤è¯"><a href="#è‡ªå®šä¹‰è®¤è¯" class="headerlink" title="è‡ªå®šä¹‰è®¤è¯"></a>è‡ªå®šä¹‰è®¤è¯</h2><h3 id="è‡ªå®šä¹‰èµ„æºæƒé™è§„åˆ™"><a href="#è‡ªå®šä¹‰èµ„æºæƒé™è§„åˆ™" class="headerlink" title="è‡ªå®šä¹‰èµ„æºæƒé™è§„åˆ™"></a>è‡ªå®šä¹‰èµ„æºæƒé™è§„åˆ™</h3><ul><li>&#x2F;index  å…¬å…±èµ„æº</li><li>&#x2F;hello â€¦. å—ä¿æŠ¤èµ„æº æƒé™ç®¡ç†</li></ul><p>åœ¨é¡¹ç›®ä¸­æ·»åŠ å¦‚ä¸‹é…ç½®å°±å¯ä»¥å®ç°å¯¹èµ„æºæƒé™è§„åˆ™è®¾å®š:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSecurityConfigurer</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http.authorizeHttpRequests()</span><br><span class="line">                .mvcMatchers(<span class="string">&quot;/index&quot;</span>).permitAll()</span><br><span class="line">                .anyRequest().authenticated()</span><br><span class="line">                .and().formLogin();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220113050533209-2023951.png" class=""><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># è¯´æ˜</span></span><br><span class="line"><span class="bullet">-</span> permitAll() ä»£è¡¨æ”¾è¡Œè¯¥èµ„æº,è¯¥èµ„æºä¸ºå…¬å…±èµ„æº æ— éœ€è®¤è¯å’Œæˆæƒå¯ä»¥ç›´æ¥è®¿é—®</span><br><span class="line"><span class="bullet">-</span> anyRequest().authenticated() ä»£è¡¨æ‰€æœ‰è¯·æ±‚,å¿…é¡»è®¤è¯ä¹‹åæ‰èƒ½è®¿é—®</span><br><span class="line"><span class="bullet">-</span> formLogin() ä»£è¡¨å¼€å¯è¡¨å•è®¤è¯</span><br><span class="line"><span class="section">## æ³¨æ„: æ”¾è¡Œèµ„æºå¿…é¡»æ”¾åœ¨æ‰€æœ‰è®¤è¯è¯·æ±‚ä¹‹å‰!</span></span><br></pre></td></tr></table></figure><h3 id="è‡ªå®šä¹‰ç™»å½•ç•Œé¢"><a href="#è‡ªå®šä¹‰ç™»å½•ç•Œé¢" class="headerlink" title="è‡ªå®šä¹‰ç™»å½•ç•Œé¢"></a>è‡ªå®šä¹‰ç™»å½•ç•Œé¢</h3><ul><li><p>å¼•å…¥æ¨¡æ¿ä¾èµ–</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--thymeleaf--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-thymeleaf<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>å®šä¹‰ç™»å½•é¡µé¢ controller</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/login.html&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">login</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;login&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>åœ¨ templates ä¸­å®šä¹‰ç™»å½•ç•Œé¢</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span> <span class="attr">xmlns:th</span>=<span class="string">&quot;https://www.thymeleaf.org&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>ç™»å½•<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>ç”¨æˆ·ç™»å½•<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span> <span class="attr">th:action</span>=<span class="string">&quot;@&#123;/doLogin&#125;&quot;</span>&gt;</span></span><br><span class="line">    ç”¨æˆ·å:<span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">&quot;uname&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span>/&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    å¯†ç :<span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">&quot;passwd&quot;</span> <span class="attr">type</span>=<span class="string">&quot;password&quot;</span>/&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;ç™»å½•&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p><strong>éœ€è¦æ³¨æ„çš„æ˜¯</strong></p><ul><li>ç™»å½•è¡¨å• method å¿…é¡»ä¸º <code>post</code>ï¼Œaction çš„è¯·æ±‚è·¯å¾„ä¸º <code>/doLogin</code></li><li>ç”¨æˆ·åçš„ name å±æ€§ä¸º <code>uname</code></li><li>å¯†ç çš„ name å±æ€§ä¸º <code>passwd</code></li></ul></li><li><p>é…ç½® Spring Security é…ç½®ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSecurityConfigurer</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">         http.authorizeHttpRequests()</span><br><span class="line">                .mvcMatchers(<span class="string">&quot;/login.html&quot;</span>).permitAll()</span><br><span class="line">                .mvcMatchers(<span class="string">&quot;/index&quot;</span>).permitAll()</span><br><span class="line">                .anyRequest().authenticated()</span><br><span class="line">                .and()</span><br><span class="line">                .formLogin()</span><br><span class="line">                .loginPage(<span class="string">&quot;/login.html&quot;</span>)</span><br><span class="line">                .loginProcessingUrl(<span class="string">&quot;/doLogin&quot;</span>)</span><br><span class="line">                .usernameParameter(<span class="string">&quot;uname&quot;</span>)</span><br><span class="line">                .passwordParameter(<span class="string">&quot;passwd&quot;</span>)</span><br><span class="line">                .successForwardUrl(<span class="string">&quot;/index&quot;</span>)  <span class="comment">//forward è·³è½¬           æ³¨æ„:ä¸ä¼šè·³è½¬åˆ°ä¹‹å‰è¯·æ±‚è·¯å¾„</span></span><br><span class="line">                <span class="comment">//.defaultSuccessUrl(&quot;/index&quot;)   //redirect é‡å®šå‘    æ³¨æ„:å¦‚æœä¹‹å‰è¯·æ±‚è·¯å¾„,ä¼šæœ‰ä¼˜å…ˆè·³è½¬ä¹‹å‰è¯·æ±‚è·¯å¾„</span></span><br><span class="line">                .failureUrl(<span class="string">&quot;/login.html&quot;</span>)</span><br><span class="line">                .and()</span><br><span class="line">                .csrf().disable();<span class="comment">//è¿™é‡Œå…ˆå…³é—­ CSRF</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>successForwardUrl ã€defaultSuccessUrl è¿™ä¸¤ä¸ªæ–¹æ³•éƒ½å¯ä»¥å®ç°æˆåŠŸä¹‹åè·³è½¬<ul><li>successForwardUrl  é»˜è®¤ä½¿ç”¨ <code>forward </code>è·³è½¬      <code>æ³¨æ„:ä¸ä¼šè·³è½¬åˆ°ä¹‹å‰è¯·æ±‚è·¯å¾„</code></li><li>defaultSuccessUrl   é»˜è®¤ä½¿ç”¨ <code>redirect</code> è·³è½¬      <code>æ³¨æ„:å¦‚æœä¹‹å‰è¯·æ±‚è·¯å¾„,ä¼šæœ‰ä¼˜å…ˆè·³è½¬ä¹‹å‰è¯·æ±‚è·¯å¾„,å¯ä»¥ä¼ å…¥ç¬¬äºŒä¸ªå‚æ•°è¿›è¡Œä¿®æ”¹</code></li></ul></li></ul></li></ul><h3 id="è‡ªå®šä¹‰ç™»å½•æˆåŠŸå¤„ç†"><a href="#è‡ªå®šä¹‰ç™»å½•æˆåŠŸå¤„ç†" class="headerlink" title="è‡ªå®šä¹‰ç™»å½•æˆåŠŸå¤„ç†"></a>è‡ªå®šä¹‰ç™»å½•æˆåŠŸå¤„ç†</h3><p>æœ‰æ—¶å€™é¡µé¢è·³è½¬å¹¶ä¸èƒ½æ»¡è¶³æˆ‘ä»¬ï¼Œç‰¹åˆ«æ˜¯åœ¨å‰åç«¯åˆ†ç¦»å¼€å‘ä¸­å°±ä¸éœ€è¦æˆåŠŸä¹‹åè·³è½¬é¡µé¢ã€‚åªéœ€è¦ç»™å‰ç«¯è¿”å›ä¸€ä¸ª JSON é€šçŸ¥ç™»å½•æˆåŠŸè¿˜æ˜¯å¤±è´¥ä¸å¦ã€‚è¿™ä¸ªæ—¶å€™å¯ä»¥é€šè¿‡è‡ªå®šä¹‰ <code>AuthenticationSucccessHandler</code> å®ç°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">AuthenticationSuccessHandler</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Called when a user has been successfully authenticated.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> request the request which caused the successful authentication</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> response the response</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> authentication the &lt;tt&gt;Authentication&lt;/tt&gt; object which was created during</span></span><br><span class="line"><span class="comment"> * the authentication process.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">onAuthenticationSuccess</span><span class="params">(HttpServletRequest request, HttpServletResponse response,</span></span><br><span class="line"><span class="params">Authentication authentication)</span> <span class="keyword">throws</span> IOException, ServletException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ ¹æ®æ¥å£çš„æè¿°ä¿¡æ¯,ä¹Ÿå¯ä»¥å¾—çŸ¥ç™»å½•æˆåŠŸä¼šè‡ªåŠ¨å›è°ƒè¿™ä¸ªæ–¹æ³•ï¼Œè¿›ä¸€æ­¥æŸ¥çœ‹å®ƒçš„é»˜è®¤å®ç°ï¼Œä½ ä¼šå‘ç°successForwardUrlã€defaultSuccessUrlä¹Ÿæ˜¯ç”±å®ƒçš„å­ç±»å®ç°çš„</strong></p><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220113054514897-2023963.png" class=""><ul><li>è‡ªå®šä¹‰ AuthenticationSuccessHandler å®ç°</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyAuthenticationSuccessHandler</span> <span class="keyword">implements</span> <span class="title class_">AuthenticationSuccessHandler</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAuthenticationSuccess</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Authentication authentication)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        Map&lt;String, Object&gt; result = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, Object&gt;();</span><br><span class="line">        result.put(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;ç™»å½•æˆåŠŸ&quot;</span>);</span><br><span class="line">        result.put(<span class="string">&quot;status&quot;</span>, <span class="number">200</span>);</span><br><span class="line">        response.setContentType(<span class="string">&quot;application/json;charset=UTF-8&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>().writeValueAsString(result);</span><br><span class="line">        response.getWriter().println(s);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>é…ç½® AuthenticationSuccessHandler</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSecurityConfigurer</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http.authorizeHttpRequests()</span><br><span class="line">                <span class="comment">//...</span></span><br><span class="line">                .and()</span><br><span class="line">                .formLogin()</span><br><span class="line">                <span class="comment">//....</span></span><br><span class="line">                .successHandler(<span class="keyword">new</span> <span class="title class_">MyAuthenticationSuccessHandler</span>())</span><br><span class="line">                .failureUrl(<span class="string">&quot;/login.html&quot;</span>)</span><br><span class="line">                .and()</span><br><span class="line">                .csrf().disable();<span class="comment">//è¿™é‡Œå…ˆå…³é—­ CSRF</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220113062644363-2026405.png" class=""><h3 id="æ˜¾ç¤ºç™»å½•å¤±è´¥ä¿¡æ¯"><a href="#æ˜¾ç¤ºç™»å½•å¤±è´¥ä¿¡æ¯" class="headerlink" title="æ˜¾ç¤ºç™»å½•å¤±è´¥ä¿¡æ¯"></a>æ˜¾ç¤ºç™»å½•å¤±è´¥ä¿¡æ¯</h3><p>ä¸ºäº†èƒ½æ›´ç›´è§‚åœ¨ç™»å½•é¡µé¢çœ‹åˆ°å¼‚å¸¸é”™è¯¯ä¿¡æ¯ï¼Œå¯ä»¥åœ¨ç™»å½•é¡µé¢ä¸­ç›´æ¥è·å–å¼‚å¸¸ä¿¡æ¯ã€‚Spring Security åœ¨ç™»å½•å¤±è´¥ä¹‹åä¼šå°†å¼‚å¸¸ä¿¡æ¯å­˜å‚¨åˆ° <code>request</code> ã€<code>session</code>ä½œç”¨åŸŸä¸­ key ä¸º <code>SPRING_SECURITY_LAST_EXCEPTION</code> å‘½åå±æ€§ä¸­ï¼Œæºç å¯ä»¥å‚è€ƒ SimpleUrlAuthenticationFailureHandler ï¼š</p><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220113060257662.png" class=""><ul><li><p>æ˜¾ç¤ºå¼‚å¸¸ä¿¡æ¯</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span> <span class="attr">xmlns:th</span>=<span class="string">&quot;https://www.thymeleaf.org&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>ç™»å½•<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  ....</span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">th:text</span>=<span class="string">&quot;$&#123;SPRING_SECURITY_LAST_EXCEPTION&#125;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>é…ç½®</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSecurityConfigurer</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http.authorizeHttpRequests()</span><br><span class="line">              <span class="comment">//..</span></span><br><span class="line">                .and()</span><br><span class="line">                .formLogin()</span><br><span class="line">                <span class="comment">//....</span></span><br><span class="line">                <span class="comment">//.failureUrl(&quot;/login.html&quot;)</span></span><br><span class="line">                .failureForwardUrl(<span class="string">&quot;/login.html&quot;</span>)</span><br><span class="line">                .and()</span><br><span class="line">                .csrf().disable();<span class="comment">//è¿™é‡Œå…ˆå…³é—­ CSRF</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>failureUrlã€failureForwardUrl å…³ç³»ç±»ä¼¼äºä¹‹å‰æåˆ°çš„ successForwardUrl ã€defaultSuccessUrl æ–¹æ³•<ul><li>failureUrl å¤±è´¥ä»¥åçš„é‡å®šå‘è·³è½¬</li><li>failureForwardUrl å¤±è´¥ä»¥åçš„ forward è·³è½¬ <code>æ³¨æ„:å› æ­¤è·å– request ä¸­å¼‚å¸¸ä¿¡æ¯,è¿™é‡Œåªèƒ½ä½¿ç”¨failureForwardUrl</code></li></ul></li></ul></li></ul><h3 id="è‡ªå®šä¹‰ç™»å½•å¤±è´¥å¤„ç†"><a href="#è‡ªå®šä¹‰ç™»å½•å¤±è´¥å¤„ç†" class="headerlink" title="è‡ªå®šä¹‰ç™»å½•å¤±è´¥å¤„ç†"></a>è‡ªå®šä¹‰ç™»å½•å¤±è´¥å¤„ç†</h3><p>å’Œè‡ªå®šä¹‰ç™»å½•æˆåŠŸå¤„ç†ä¸€æ ·ï¼ŒSpring Security åŒæ ·ä¸ºå‰åç«¯åˆ†ç¦»å¼€å‘æä¾›äº†ç™»å½•å¤±è´¥çš„å¤„ç†ï¼Œè¿™ä¸ªç±»å°±æ˜¯  AuthenticationFailureHandlerï¼Œæºç ä¸ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">AuthenticationFailureHandler</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Called when an authentication attempt fails.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> request the request during which the authentication attempt occurred.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> response the response.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> exception the exception which was thrown to reject the authentication</span></span><br><span class="line"><span class="comment"> * request.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">onAuthenticationFailure</span><span class="params">(HttpServletRequest request, HttpServletResponse response,</span></span><br><span class="line"><span class="params">AuthenticationException exception)</span> <span class="keyword">throws</span> IOException, ServletException;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ ¹æ®æ¥å£çš„æè¿°ä¿¡æ¯,ä¹Ÿå¯ä»¥å¾—çŸ¥ç™»å½•å¤±è´¥ä¼šè‡ªåŠ¨å›è°ƒè¿™ä¸ªæ–¹æ³•ï¼Œè¿›ä¸€æ­¥æŸ¥çœ‹å®ƒçš„é»˜è®¤å®ç°ï¼Œä½ ä¼šå‘ç°failureUrlã€failureForwardUrlä¹Ÿæ˜¯ç”±å®ƒçš„å­ç±»å®ç°çš„ã€‚</strong></p><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220113062114741.png" class=""><ul><li>è‡ªå®šä¹‰ AuthenticationFailureHandler å®ç°</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyAuthenticationFailureHandler</span> <span class="keyword">implements</span> <span class="title class_">AuthenticationFailureHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAuthenticationFailure</span><span class="params">(HttpServletRequest request, HttpServletResponse response, AuthenticationException exception)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        Map&lt;String, Object&gt; result = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, Object&gt;();</span><br><span class="line">        result.put(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;ç™»å½•å¤±è´¥: &quot;</span>+exception.getMessage());</span><br><span class="line">        result.put(<span class="string">&quot;status&quot;</span>, <span class="number">500</span>);</span><br><span class="line">        response.setContentType(<span class="string">&quot;application/json;charset=UTF-8&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>().writeValueAsString(result);</span><br><span class="line">        response.getWriter().println(s);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>é…ç½® AuthenticationFailureHandler</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSecurityConfigurer</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http.authorizeHttpRequests()</span><br><span class="line">              <span class="comment">//...</span></span><br><span class="line">                .and()</span><br><span class="line">                .formLogin()</span><br><span class="line">               <span class="comment">//..</span></span><br><span class="line">                .failureHandler(<span class="keyword">new</span> <span class="title class_">MyAuthenticationFailureHandler</span>())</span><br><span class="line">                .and()</span><br><span class="line">                .csrf().disable();<span class="comment">//è¿™é‡Œå…ˆå…³é—­ CSRF</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220113062617937-2026380.png" class=""><h3 id="æ³¨é”€ç™»å½•"><a href="#æ³¨é”€ç™»å½•" class="headerlink" title="æ³¨é”€ç™»å½•"></a>æ³¨é”€ç™»å½•</h3><p>Spring Security ä¸­ä¹Ÿæä¾›äº†é»˜è®¤çš„æ³¨é”€ç™»å½•é…ç½®ï¼Œåœ¨å¼€å‘æ—¶ä¹Ÿå¯ä»¥æŒ‰ç…§è‡ªå·±éœ€æ±‚å¯¹æ³¨é”€è¿›è¡Œä¸ªæ€§åŒ–å®šåˆ¶ã€‚</p><ul><li><p>å¼€å¯æ³¨é”€ç™»å½•<code>é»˜è®¤å¼€å¯</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSecurityConfigurer</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http.authorizeHttpRequests()</span><br><span class="line">                <span class="comment">//...</span></span><br><span class="line">                .and()</span><br><span class="line">                .formLogin()</span><br><span class="line">                <span class="comment">//...</span></span><br><span class="line">                .and()</span><br><span class="line">                .logout()</span><br><span class="line">                .logoutUrl(<span class="string">&quot;/logout&quot;</span>)</span><br><span class="line">                .invalidateHttpSession(<span class="literal">true</span>)</span><br><span class="line">                .clearAuthentication(<span class="literal">true</span>)</span><br><span class="line">                .logoutSuccessUrl(<span class="string">&quot;/login.html&quot;</span>)</span><br><span class="line">                .and()</span><br><span class="line">                .csrf().disable();<span class="comment">//è¿™é‡Œå…ˆå…³é—­ CSRF</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>é€šè¿‡ logout() æ–¹æ³•å¼€å¯æ³¨é”€é…ç½®</li><li>logoutUrl æŒ‡å®šé€€å‡ºç™»å½•è¯·æ±‚åœ°å€ï¼Œé»˜è®¤æ˜¯ GET è¯·æ±‚ï¼Œè·¯å¾„ä¸º <code>/logout</code></li><li>invalidateHttpSession é€€å‡ºæ—¶æ˜¯å¦æ˜¯ session å¤±æ•ˆï¼Œé»˜è®¤å€¼ä¸º true</li><li>clearAuthentication é€€å‡ºæ—¶æ˜¯å¦æ¸…é™¤è®¤è¯ä¿¡æ¯ï¼Œé»˜è®¤å€¼ä¸º true</li><li>logoutSuccessUrl é€€å‡ºç™»å½•æ—¶è·³è½¬åœ°å€</li></ul></li><li><p>é…ç½®å¤šä¸ªæ³¨é”€ç™»å½•è¯·æ±‚</p><p>å¦‚æœé¡¹ç›®ä¸­æœ‰éœ€è¦ï¼Œå¼€å‘è€…è¿˜å¯ä»¥é…ç½®å¤šä¸ªæ³¨é”€ç™»å½•çš„è¯·æ±‚ï¼ŒåŒæ—¶è¿˜å¯ä»¥æŒ‡å®šè¯·æ±‚çš„æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSecurityConfigurer</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http.authorizeHttpRequests()</span><br><span class="line">                <span class="comment">//...</span></span><br><span class="line">                .and()</span><br><span class="line">                .formLogin()</span><br><span class="line">                <span class="comment">//...</span></span><br><span class="line">                .and()</span><br><span class="line">                .logout()</span><br><span class="line">                .logoutRequestMatcher(<span class="keyword">new</span> <span class="title class_">OrRequestMatcher</span>(</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">AntPathRequestMatcher</span>(<span class="string">&quot;/logout1&quot;</span>,<span class="string">&quot;GET&quot;</span>),</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">AntPathRequestMatcher</span>(<span class="string">&quot;/logout&quot;</span>,<span class="string">&quot;GET&quot;</span>)</span><br><span class="line">                ))</span><br><span class="line">                .invalidateHttpSession(<span class="literal">true</span>)</span><br><span class="line">                .clearAuthentication(<span class="literal">true</span>)</span><br><span class="line">                .logoutSuccessUrl(<span class="string">&quot;/login.html&quot;</span>)</span><br><span class="line">                .and()</span><br><span class="line">                .csrf().disable();<span class="comment">//è¿™é‡Œå…ˆå…³é—­ CSRF</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>å‰åç«¯åˆ†ç¦»æ³¨é”€ç™»å½•é…ç½®</p><p>å¦‚æœæ˜¯å‰åç«¯åˆ†ç¦»å¼€å‘ï¼Œæ³¨é”€æˆåŠŸä¹‹åå°±ä¸éœ€è¦é¡µé¢è·³è½¬äº†ï¼Œåªéœ€è¦å°†æ³¨é”€æˆåŠŸçš„ä¿¡æ¯è¿”å›å‰ç«¯å³å¯ï¼Œæ­¤æ—¶æˆ‘ä»¬å¯ä»¥é€šè¿‡è‡ªå®šä¹‰ LogoutSuccessHandler  å®ç°æ¥è¿”å›æ³¨é”€ä¹‹åä¿¡æ¯ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyLogoutSuccessHandler</span> <span class="keyword">implements</span> <span class="title class_">LogoutSuccessHandler</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onLogoutSuccess</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Authentication authentication)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        Map&lt;String, Object&gt; result = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, Object&gt;();</span><br><span class="line">        result.put(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;æ³¨é”€æˆåŠŸ&quot;</span>);</span><br><span class="line">        result.put(<span class="string">&quot;status&quot;</span>, <span class="number">200</span>);</span><br><span class="line">        response.setContentType(<span class="string">&quot;application/json;charset=UTF-8&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>().writeValueAsString(result);</span><br><span class="line">        response.getWriter().println(s);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSecurityConfigurer</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http.authorizeHttpRequests()</span><br><span class="line">          <span class="comment">//....</span></span><br><span class="line">                .and()</span><br><span class="line">                .formLogin()</span><br><span class="line"> <span class="comment">//...</span></span><br><span class="line">                .and()</span><br><span class="line">                .logout()</span><br><span class="line">                <span class="comment">//.logoutUrl(&quot;/logout&quot;)</span></span><br><span class="line">                .logoutRequestMatcher(<span class="keyword">new</span> <span class="title class_">OrRequestMatcher</span>(</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">AntPathRequestMatcher</span>(<span class="string">&quot;/logout1&quot;</span>,<span class="string">&quot;GET&quot;</span>),</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">AntPathRequestMatcher</span>(<span class="string">&quot;/logout&quot;</span>,<span class="string">&quot;GET&quot;</span>)</span><br><span class="line">                ))</span><br><span class="line">                .invalidateHttpSession(<span class="literal">true</span>)</span><br><span class="line">                .clearAuthentication(<span class="literal">true</span>)</span><br><span class="line">                <span class="comment">//.logoutSuccessUrl(&quot;/login.html&quot;)</span></span><br><span class="line">                .logoutSuccessHandler(<span class="keyword">new</span> <span class="title class_">MyLogoutSuccessHandler</span>())</span><br><span class="line">                .and()</span><br><span class="line">                .csrf().disable();<span class="comment">//è¿™é‡Œå…ˆå…³é—­ CSRF</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220113114133687.png" class=""><h3 id="ç™»å½•ç”¨æˆ·æ•°æ®è·å–"><a href="#ç™»å½•ç”¨æˆ·æ•°æ®è·å–" class="headerlink" title="ç™»å½•ç”¨æˆ·æ•°æ®è·å–"></a>ç™»å½•ç”¨æˆ·æ•°æ®è·å–</h3><h4 id="SecurityContextHolder-1"><a href="#SecurityContextHolder-1" class="headerlink" title="SecurityContextHolder"></a>SecurityContextHolder</h4><p>â€‹Spring Security ä¼šå°†ç™»å½•ç”¨æˆ·æ•°æ®ä¿å­˜åœ¨ Session ä¸­ã€‚ä½†æ˜¯ï¼Œä¸ºäº†ä½¿ç”¨æ–¹ä¾¿,Spring Securityåœ¨æ­¤åŸºç¡€ä¸Šè¿˜åšäº†ä¸€äº›æ”¹è¿›ï¼Œå…¶ä¸­æœ€ä¸»è¦çš„ä¸€ä¸ªå˜åŒ–å°±æ˜¯çº¿ç¨‹ç»‘å®šã€‚å½“ç”¨æˆ·ç™»å½•æˆåŠŸå,Spring Security ä¼šå°†ç™»å½•æˆåŠŸçš„ç”¨æˆ·ä¿¡æ¯ä¿å­˜åˆ° SecurityContextHolder ä¸­ã€‚</p><p>â€‹SecurityContextHolder ä¸­çš„æ•°æ®ä¿å­˜é»˜è®¤æ˜¯é€šè¿‡ThreadLocal æ¥å®ç°çš„ï¼Œä½¿ç”¨ ThreadLocal åˆ›å»ºçš„å˜é‡åªèƒ½è¢«å½“å‰çº¿ç¨‹è®¿é—®ï¼Œä¸èƒ½è¢«å…¶ä»–çº¿ç¨‹è®¿é—®å’Œä¿®æ”¹ï¼Œä¹Ÿå°±æ˜¯ç”¨æˆ·æ•°æ®å’Œè¯·æ±‚çº¿ç¨‹ç»‘å®šåœ¨ä¸€èµ·ã€‚å½“ç™»å½•è¯·æ±‚å¤„ç†å®Œæ¯•åï¼ŒSpring Security ä¼šå°† SecurityContextHolder ä¸­çš„æ•°æ®æ‹¿å‡ºæ¥ä¿å­˜åˆ° Session ä¸­ï¼ŒåŒæ—¶å°† SecurityContexHolder ä¸­çš„æ•°æ®æ¸…ç©ºã€‚ä»¥åæ¯å½“æœ‰è¯·æ±‚åˆ°æ¥æ—¶ï¼ŒSpring Security å°±ä¼šå…ˆä» Session ä¸­å–å‡ºç”¨æˆ·ç™»å½•æ•°æ®ï¼Œä¿å­˜åˆ°SecurityContextHolder ä¸­ï¼Œæ–¹ä¾¿åœ¨è¯¥è¯·æ±‚çš„åç»­å¤„ç†è¿‡ç¨‹ä¸­ä½¿ç”¨ï¼ŒåŒæ—¶åœ¨è¯·æ±‚ç»“æŸæ—¶å°† SecurityContextHolder ä¸­çš„æ•°æ®æ‹¿å‡ºæ¥ä¿å­˜åˆ° Session ä¸­ï¼Œç„¶åå°†SecurityContextHolder ä¸­çš„æ•°æ®æ¸…ç©ºã€‚</p><p>â€‹å®é™…ä¸Š SecurityContextHolder ä¸­å­˜å‚¨æ˜¯ SecurityContextï¼Œåœ¨ SecurityContext ä¸­å­˜å‚¨æ˜¯ Authenticationã€‚</p><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220113115956334.png" class=""><p>è¿™ç§è®¾è®¡æ˜¯å…¸å‹çš„ç­–ç•¥è®¾è®¡æ¨¡å¼:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityContextHolder</span> &#123;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">MODE_THREADLOCAL</span> <span class="operator">=</span> <span class="string">&quot;MODE_THREADLOCAL&quot;</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">MODE_INHERITABLETHREADLOCAL</span> <span class="operator">=</span> <span class="string">&quot;MODE_INHERITABLETHREADLOCAL&quot;</span>;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">MODE_GLOBAL</span> <span class="operator">=</span> <span class="string">&quot;MODE_GLOBAL&quot;</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">MODE_PRE_INITIALIZED</span> <span class="operator">=</span> <span class="string">&quot;MODE_PRE_INITIALIZED&quot;</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> SecurityContextHolderStrategy strategy;</span><br><span class="line">  <span class="comment">//....</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">initializeStrategy</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (MODE_PRE_INITIALIZED.equals(strategyName)) &#123;</span><br><span class="line">Assert.state(strategy != <span class="literal">null</span>, <span class="string">&quot;When using &quot;</span> + MODE_PRE_INITIALIZED</span><br><span class="line">+ <span class="string">&quot;, setContextHolderStrategy must be called with the fully constructed strategy&quot;</span>);</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (!StringUtils.hasText(strategyName)) &#123;</span><br><span class="line"><span class="comment">// Set default</span></span><br><span class="line">strategyName = MODE_THREADLOCAL;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (strategyName.equals(MODE_THREADLOCAL)) &#123;</span><br><span class="line">strategy = <span class="keyword">new</span> <span class="title class_">ThreadLocalSecurityContextHolderStrategy</span>();</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (strategyName.equals(MODE_INHERITABLETHREADLOCAL)) &#123;</span><br><span class="line">strategy = <span class="keyword">new</span> <span class="title class_">InheritableThreadLocalSecurityContextHolderStrategy</span>();</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (strategyName.equals(MODE_GLOBAL)) &#123;</span><br><span class="line">strategy = <span class="keyword">new</span> <span class="title class_">GlobalSecurityContextHolderStrategy</span>();</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line">    <span class="comment">//.....</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li><code>MODE THREADLOCAL</code>ï¼šè¿™ç§å­˜æ”¾ç­–ç•¥æ˜¯å°† SecurityContext å­˜æ”¾åœ¨ ThreadLocalä¸­ï¼Œå¤§å®¶çŸ¥é“ Threadlocal çš„ç‰¹ç‚¹æ˜¯åœ¨å“ªä¸ªçº¿ç¨‹ä¸­å­˜å‚¨å°±è¦åœ¨å“ªä¸ªçº¿ç¨‹ä¸­è¯»å–ï¼Œè¿™å…¶å®éå¸¸é€‚åˆ web åº”ç”¨ï¼Œå› ä¸ºåœ¨é»˜è®¤æƒ…å†µä¸‹ï¼Œä¸€ä¸ªè¯·æ±‚æ— è®ºç»è¿‡å¤šå°‘ Filter åˆ°è¾¾ Servletï¼Œéƒ½æ˜¯ç”±ä¸€ä¸ªçº¿ç¨‹æ¥å¤„ç†çš„ã€‚è¿™ä¹Ÿæ˜¯ SecurityContextHolder çš„é»˜è®¤å­˜å‚¨ç­–ç•¥ï¼Œè¿™ç§å­˜å‚¨ç­–ç•¥æ„å‘³ç€å¦‚æœåœ¨å…·ä½“çš„ä¸šåŠ¡å¤„ç†ä»£ç ä¸­ï¼Œå¼€å¯äº†å­çº¿ç¨‹ï¼Œåœ¨å­çº¿ç¨‹ä¸­å»è·å–ç™»å½•ç”¨æˆ·æ•°æ®ï¼Œå°±ä¼šè·å–ä¸åˆ°ã€‚</li><li><code>MODE INHERITABLETHREADLOCAL</code>ï¼šè¿™ç§å­˜å‚¨æ¨¡å¼é€‚ç”¨äºå¤šçº¿ç¨‹ç¯å¢ƒï¼Œå¦‚æœå¸Œæœ›åœ¨å­çº¿ç¨‹ä¸­ä¹Ÿèƒ½å¤Ÿè·å–åˆ°ç™»å½•ç”¨æˆ·æ•°æ®ï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨è¿™ç§å­˜å‚¨æ¨¡å¼ã€‚</li><li><code>MODE GLOBAL</code>ï¼šè¿™ç§å­˜å‚¨æ¨¡å¼å®é™…ä¸Šæ˜¯å°†æ•°æ®ä¿å­˜åœ¨ä¸€ä¸ªé™æ€å˜é‡ä¸­ï¼Œåœ¨ JavaWebå¼€å‘ä¸­ï¼Œè¿™ç§æ¨¡å¼å¾ˆå°‘ä½¿ç”¨åˆ°ã€‚</li></ol><h4 id="SecurityContextHolderStrategy"><a href="#SecurityContextHolderStrategy" class="headerlink" title="SecurityContextHolderStrategy"></a>SecurityContextHolderStrategy</h4><p>é€šè¿‡ SecurityContextHolder å¯ä»¥å¾—çŸ¥ï¼ŒSecurityContextHolderStrategy æ¥å£ç”¨æ¥å®šä¹‰å­˜å‚¨ç­–ç•¥æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">SecurityContextHolderStrategy</span> &#123;</span><br><span class="line"><span class="keyword">void</span> <span class="title function_">clearContext</span><span class="params">()</span>;</span><br><span class="line">SecurityContext <span class="title function_">getContext</span><span class="params">()</span>;</span><br><span class="line"><span class="keyword">void</span> <span class="title function_">setContext</span><span class="params">(SecurityContext context)</span>;</span><br><span class="line">SecurityContext <span class="title function_">createEmptyContext</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥å£ä¸­ä¸€å…±å®šä¹‰äº†å››ä¸ªæ–¹æ³•ï¼š</p><ul><li><code>clearContext</code>ï¼šè¯¥æ–¹æ³•ç”¨æ¥æ¸…é™¤å­˜å‚¨çš„ SecurityContextå¯¹è±¡ã€‚</li><li><code>getContext</code>ï¼šè¯¥æ–¹æ³•ç”¨æ¥è·å–å­˜å‚¨çš„ SecurityContext å¯¹è±¡ã€‚</li><li><code>setContext</code>ï¼šè¯¥æ–¹æ³•ç”¨æ¥è®¾ç½®å­˜å‚¨çš„ SecurityContext å¯¹è±¡ã€‚</li><li><code>create Empty Context</code>ï¼šè¯¥æ–¹æ³•åˆ™ç”¨æ¥åˆ›å»ºä¸€ä¸ªç©ºçš„ SecurityContext å¯¹è±¡ã€‚</li></ul><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220113125407538-2049649.png" class=""><p>ä»ä¸Šé¢å¯ä»¥çœ‹å‡ºæ¯ä¸€ä¸ªå®ç°ç±»å¯¹åº”ä¸€ç§ç­–ç•¥çš„å®ç°ã€‚</p><h4 id="ä»£ç ä¸­è·å–è®¤è¯ä¹‹åç”¨æˆ·æ•°æ®"><a href="#ä»£ç ä¸­è·å–è®¤è¯ä¹‹åç”¨æˆ·æ•°æ®" class="headerlink" title="ä»£ç ä¸­è·å–è®¤è¯ä¹‹åç”¨æˆ·æ•°æ®"></a>ä»£ç ä¸­è·å–è®¤è¯ä¹‹åç”¨æˆ·æ•°æ®</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloController</span> &#123;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/hello&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="type">Authentication</span> <span class="variable">authentication</span> <span class="operator">=</span> SecurityContextHolder</span><br><span class="line">        .getContext().getAuthentication();</span><br><span class="line">      <span class="type">User</span> <span class="variable">principal</span> <span class="operator">=</span> (User) authentication.getPrincipal();</span><br><span class="line">      System.out.println(<span class="string">&quot;èº«ä»½ :&quot;</span>+principal.getUsername());</span><br><span class="line">      System.out.println(<span class="string">&quot;å‡­è¯ :&quot;</span>+authentication.getCredentials());</span><br><span class="line">      System.out.println(<span class="string">&quot;æƒé™ :&quot;</span>+authentication.getAuthorities());</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&quot;hello security&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="å¤šçº¿ç¨‹æƒ…å†µä¸‹è·å–ç”¨æˆ·æ•°æ®"><a href="#å¤šçº¿ç¨‹æƒ…å†µä¸‹è·å–ç”¨æˆ·æ•°æ®" class="headerlink" title="å¤šçº¿ç¨‹æƒ…å†µä¸‹è·å–ç”¨æˆ·æ•°æ®"></a>å¤šçº¿ç¨‹æƒ…å†µä¸‹è·å–ç”¨æˆ·æ•°æ®</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloController</span> &#123;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/hello&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">()</span> &#123;</span><br><span class="line">      <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123;</span><br><span class="line">        <span class="type">Authentication</span> <span class="variable">authentication</span> <span class="operator">=</span> SecurityContextHolder</span><br><span class="line">          .getContext().getAuthentication();</span><br><span class="line">        <span class="type">User</span> <span class="variable">principal</span> <span class="operator">=</span> (User) authentication.getPrincipal();</span><br><span class="line">        System.out.println(<span class="string">&quot;èº«ä»½ :&quot;</span>+principal.getUsername());</span><br><span class="line">        System.out.println(<span class="string">&quot;å‡­è¯ :&quot;</span>+authentication.getCredentials());</span><br><span class="line">        System.out.println(<span class="string">&quot;æƒé™ :&quot;</span>+authentication.getAuthorities());</span><br><span class="line">      &#125;).start();</span><br><span class="line">      <span class="keyword">return</span> <span class="string">&quot;hello security&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220113124141492.png" class=""><p><strong>å¯ä»¥çœ‹åˆ°é»˜è®¤ç­–ç•¥ï¼Œæ˜¯æ— æ³•åœ¨å­çº¿ç¨‹ä¸­è·å–ç”¨æˆ·ä¿¡æ¯ï¼Œå¦‚æœéœ€è¦åœ¨å­çº¿ç¨‹ä¸­è·å–å¿…é¡»ä½¿ç”¨ç¬¬äºŒç§ç­–ç•¥ï¼Œé»˜è®¤ç­–ç•¥æ˜¯é€šè¿‡ System.getProperty åŠ è½½çš„ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥é€šè¿‡å¢åŠ  VM Options å‚æ•°è¿›è¡Œä¿®æ”¹ã€‚</strong></p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">-Dspring.security.strategy</span>=<span class="string">MODE_INHERITABLETHREADLOCAL</span></span><br></pre></td></tr></table></figure><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220113124639102.png" class=""><h4 id="é¡µé¢ä¸Šè·å–ç”¨æˆ·ä¿¡æ¯"><a href="#é¡µé¢ä¸Šè·å–ç”¨æˆ·ä¿¡æ¯" class="headerlink" title="é¡µé¢ä¸Šè·å–ç”¨æˆ·ä¿¡æ¯"></a>é¡µé¢ä¸Šè·å–ç”¨æˆ·ä¿¡æ¯</h4><ul><li><p>å¼•å…¥ä¾èµ–</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.thymeleaf.extras<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>thymeleaf-extras-springsecurity5<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.0.4.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>é¡µé¢åŠ å…¥å‘½åç©ºé—´</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span> <span class="attr">xmlns:th</span>=<span class="string">&quot;https://www.thymeleaf.org&quot;</span> </span></span><br><span class="line"><span class="tag"><span class="attr">xmlns:sec</span>=<span class="string">&quot;http://www.thymeleaf.org/extras/spring-security&quot;</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>é¡µé¢ä¸­ä½¿ç”¨</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--è·å–è®¤è¯ç”¨æˆ·å--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">li</span> <span class="attr">sec:authentication</span>=<span class="string">&quot;principal.username&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">li</span> <span class="attr">sec:authentication</span>=<span class="string">&quot;principal.authorities&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">li</span> <span class="attr">sec:authentication</span>=<span class="string">&quot;principal.accountNonExpired&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">li</span> <span class="attr">sec:authentication</span>=<span class="string">&quot;principal.accountNonLocked&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">li</span> <span class="attr">sec:authentication</span>=<span class="string">&quot;principal.credentialsNonExpired&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="è‡ªå®šä¹‰è®¤è¯æ•°æ®æº"><a href="#è‡ªå®šä¹‰è®¤è¯æ•°æ®æº" class="headerlink" title="è‡ªå®šä¹‰è®¤è¯æ•°æ®æº"></a>è‡ªå®šä¹‰è®¤è¯æ•°æ®æº</h3><h4 id="è®¤è¯æµç¨‹åˆ†æ"><a href="#è®¤è¯æµç¨‹åˆ†æ" class="headerlink" title="è®¤è¯æµç¨‹åˆ†æ"></a>è®¤è¯æµç¨‹åˆ†æ</h4><p><a href="https://docs.spring.io/spring-security/reference/servlet/authentication/architecture.html">https://docs.spring.io/spring-security/reference/servlet/authentication/architecture.html</a></p><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220118060526805.png" class=""><ul><li>å‘èµ·è®¤è¯è¯·æ±‚ï¼Œè¯·æ±‚ä¸­æºå¸¦ç”¨æˆ·åã€å¯†ç ï¼Œè¯¥è¯·æ±‚ä¼šè¢«<code>UsernamePasswordAuthenticationFilter</code> æ‹¦æˆª</li><li>åœ¨<code>UsernamePasswordAuthenticationFilter</code>çš„<code>attemptAuthentication</code>æ–¹æ³•ä¸­å°†è¯·æ±‚ä¸­ç”¨æˆ·åå’Œå¯†ç ï¼Œå°è£…ä¸º<code>Authentication</code>å¯¹è±¡ï¼Œå¹¶äº¤ç»™<code>AuthenticationManager</code> è¿›è¡Œè®¤è¯</li><li>è®¤è¯æˆåŠŸï¼Œå°†è®¤è¯ä¿¡æ¯å­˜å‚¨åˆ° SecurityContextHodler ä»¥åŠè°ƒç”¨è®°ä½æˆ‘ç­‰ï¼Œå¹¶å›è°ƒ <code>AuthenticationSuccessHandler</code> å¤„ç†</li><li>è®¤è¯å¤±è´¥ï¼Œæ¸…é™¤ SecurityContextHodler ä»¥åŠ è®°ä½æˆ‘ä¸­ä¿¡æ¯ï¼Œå›è°ƒ <code>AuthenticationFailureHandler</code> å¤„ç†</li></ul><h4 id="ä¸‰è€…å…³ç³»"><a href="#ä¸‰è€…å…³ç³»" class="headerlink" title="ä¸‰è€…å…³ç³»"></a>ä¸‰è€…å…³ç³»</h4><p>ä»ä¸Šé¢åˆ†æä¸­å¾—çŸ¥ï¼ŒAuthenticationManager æ˜¯è®¤è¯çš„æ ¸å¿ƒç±»ï¼Œä½†å®é™…ä¸Šåœ¨åº•å±‚çœŸæ­£è®¤è¯æ—¶è¿˜ç¦»ä¸å¼€ ProviderManager ä»¥åŠ  AuthenticationProvider ã€‚ä»–ä»¬ä¸‰è€…å…³ç³»æ˜¯æ ·çš„å‘¢ï¼Ÿ</p><ul><li><code>AuthenticationManager</code> æ˜¯ä¸€ä¸ªè®¤è¯ç®¡ç†å™¨ï¼Œå®ƒå®šä¹‰äº† Spring Security è¿‡æ»¤å™¨è¦æ‰§è¡Œè®¤è¯æ“ä½œã€‚</li><li><code>ProviderManager</code> AuthenticationManageræ¥å£çš„å®ç°ç±»ã€‚Spring Security è®¤è¯æ—¶é»˜è®¤ä½¿ç”¨å°±æ˜¯ ProviderManagerã€‚</li><li><code>AuthenticationProvider</code> å°±æ˜¯é’ˆå¯¹ä¸åŒçš„èº«ä»½ç±»å‹æ‰§è¡Œçš„å…·ä½“çš„èº«ä»½è®¤è¯ã€‚</li></ul><p><strong>AuthenticationManager ä¸ ProviderManager</strong></p><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220118061756972.png" class=""><p>â€‹ProviderManager æ˜¯ AuthenticationManager çš„å”¯ä¸€å®ç°ï¼Œä¹Ÿæ˜¯ Spring Security é»˜è®¤ä½¿ç”¨å®ç°ã€‚ä»è¿™é‡Œä¸éš¾çœ‹å‡ºé»˜è®¤æƒ…å†µä¸‹AuthenticationManager å°±æ˜¯ä¸€ä¸ªProviderManagerã€‚</p><p><strong>ProviderManager ä¸ AuthenticationProvider</strong></p><p>æ‘˜è‡ªå®˜æ–¹: <a href="https://docs.spring.io/spring-security/reference/servlet/authentication/architecture.html">https://docs.spring.io/spring-security/reference/servlet/authentication/architecture.html</a></p><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220118060824066.png" class=""><p>â€‹åœ¨ Spring Seourity ä¸­ï¼Œå…è®¸ç³»ç»ŸåŒæ—¶æ”¯æŒå¤šç§ä¸åŒçš„è®¤è¯æ–¹å¼ï¼Œä¾‹å¦‚åŒæ—¶æ”¯æŒç”¨æˆ·å&#x2F;å¯†ç è®¤è¯ã€ReremberMe è®¤è¯ã€æ‰‹æœºå·ç åŠ¨æ€è®¤è¯ç­‰ï¼Œè€Œä¸åŒçš„è®¤è¯æ–¹å¼å¯¹åº”äº†ä¸åŒçš„ AuthenticationProviderï¼Œæ‰€ä»¥ä¸€ä¸ªå®Œæ•´çš„è®¤è¯æµç¨‹å¯èƒ½ç”±å¤šä¸ª AuthenticationProvider æ¥æä¾›ã€‚</p><p>â€‹å¤šä¸ª AuthenticationProvider å°†ç»„æˆä¸€ä¸ªåˆ—è¡¨ï¼Œè¿™ä¸ªåˆ—è¡¨å°†ç”± ProviderManager ä»£ç†ã€‚æ¢å¥è¯è¯´ï¼Œåœ¨ProviderManager ä¸­å­˜åœ¨ä¸€ä¸ª AuthenticationProvider åˆ—è¡¨ï¼Œåœ¨Provider Manager ä¸­éå†åˆ—è¡¨ä¸­çš„æ¯ä¸€ä¸ª AuthenticationProvider å»æ‰§è¡Œèº«ä»½è®¤è¯ï¼Œæœ€ç»ˆå¾—åˆ°è®¤è¯ç»“æœã€‚</p><p>â€‹ProviderManager æœ¬èº«ä¹Ÿå¯ä»¥å†é…ç½®ä¸€ä¸ª AuthenticationManager ä½œä¸º parentï¼Œè¿™æ ·å½“ProviderManager è®¤è¯å¤±è´¥ä¹‹åï¼Œå°±å¯ä»¥è¿›å…¥åˆ° parent ä¸­å†æ¬¡è¿›è¡Œè®¤è¯ã€‚ç†è®ºä¸Šæ¥è¯´ï¼ŒProviderManager çš„ parent å¯ä»¥æ˜¯ä»»æ„ç±»å‹çš„ AuthenticationManagerï¼Œä½†æ˜¯é€šå¸¸éƒ½æ˜¯ç”±<br>ProviderManager æ¥æ‰®æ¼” parent çš„è§’è‰²ï¼Œä¹Ÿå°±æ˜¯ ProviderManager æ˜¯ ProviderManager çš„ parentã€‚</p><p>â€‹ProviderManager æœ¬èº«ä¹Ÿå¯ä»¥æœ‰å¤šä¸ªï¼Œå¤šä¸ªProviderManager å…±ç”¨åŒä¸€ä¸ª parentã€‚æœ‰æ—¶ï¼Œä¸€ä¸ªåº”ç”¨ç¨‹åºæœ‰å—ä¿æŠ¤èµ„æºçš„é€»è¾‘ç»„ï¼ˆä¾‹å¦‚ï¼Œæ‰€æœ‰ç¬¦åˆè·¯å¾„æ¨¡å¼çš„ç½‘ç»œèµ„æºï¼Œå¦‚&#x2F;api&#x2F;**ï¼‰ï¼Œæ¯ä¸ªç»„å¯ä»¥æœ‰è‡ªå·±çš„ä¸“ç”¨ AuthenticationManagerã€‚é€šå¸¸ï¼Œæ¯ä¸ªç»„éƒ½æ˜¯ä¸€ä¸ªProviderManagerï¼Œå®ƒä»¬å…±äº«ä¸€ä¸ªçˆ¶çº§ã€‚ç„¶åï¼Œçˆ¶çº§æ˜¯ä¸€ç§ <code>å…¨å±€</code>èµ„æºï¼Œä½œä¸ºæ‰€æœ‰æä¾›è€…çš„åå¤‡èµ„æºã€‚</p><p>æ ¹æ®ä¸Šé¢çš„ä»‹ç»ï¼Œæˆ‘ä»¬ç»˜å‡ºæ–°çš„ AuthenticationManagerã€ProvideManager å’Œ AuthentictionProvider å…³ç³»</p><p>æ‘˜è‡ªå®˜ç½‘: <a href="https://spring.io/guides/topicals/spring-security-architecture">https://spring.io/guides/topicals/spring-security-architecture</a></p><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220118061343516.png" class=""><p> å¼„æ¸…æ¥šè®¤è¯åŸç†ä¹‹åæˆ‘ä»¬æ¥çœ‹ä¸‹å…·ä½“è®¤è¯æ—¶æ•°æ®æºçš„è·å–ã€‚<code>é»˜è®¤æƒ…å†µä¸‹ AuthenticationProvider  æ˜¯ç”± DaoAuthenticationProvider ç±»æ¥å®ç°è®¤è¯çš„ï¼Œåœ¨DaoAuthenticationProvider è®¤è¯æ—¶åˆé€šè¿‡ UserDetailsService å®Œæˆæ•°æ®æºçš„æ ¡éªŒã€‚</code>ä»–ä»¬ä¹‹é—´è°ƒç”¨å…³ç³»å¦‚ä¸‹ï¼š</p><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220114163045543.png" class=""><p><strong>æ€»ç»“: AuthenticationManager æ˜¯è®¤è¯ç®¡ç†å™¨ï¼Œåœ¨ Spring Security ä¸­æœ‰å…¨å±€AuthenticationManagerï¼Œä¹Ÿå¯ä»¥æœ‰å±€éƒ¨AuthenticationManagerã€‚å…¨å±€çš„AuthenticationManagerç”¨æ¥å¯¹å…¨å±€è®¤è¯è¿›è¡Œå¤„ç†ï¼Œå±€éƒ¨çš„AuthenticationManagerç”¨æ¥å¯¹æŸäº›ç‰¹æ®Šèµ„æºè®¤è¯å¤„ç†ã€‚å½“ç„¶æ— è®ºæ˜¯å…¨å±€è®¤è¯ç®¡ç†å™¨è¿˜æ˜¯å±€éƒ¨è®¤è¯ç®¡ç†å™¨éƒ½æ˜¯ç”± ProviderManger è¿›è¡Œå®ç°ã€‚ æ¯ä¸€ä¸ªProviderMangerä¸­éƒ½ä»£ç†ä¸€ä¸ªAuthenticationProviderçš„åˆ—è¡¨ï¼Œåˆ—è¡¨ä¸­æ¯ä¸€ä¸ªå®ç°ä»£è¡¨ä¸€ç§èº«ä»½è®¤è¯æ–¹å¼ã€‚è®¤è¯æ—¶åº•å±‚æ•°æ®æºéœ€è¦è°ƒç”¨ UserDetailService æ¥å®ç°ã€‚</strong></p><h4 id="é…ç½®å…¨å±€-AuthenticationManager"><a href="#é…ç½®å…¨å±€-AuthenticationManager" class="headerlink" title="é…ç½®å…¨å±€ AuthenticationManager"></a>é…ç½®å…¨å±€ AuthenticationManager</h4><p><a href="https://spring.io/guides/topicals/spring-security-architecture">https://spring.io/guides/topicals/spring-security-architecture</a></p><ul><li><p>é»˜è®¤çš„å…¨å±€ AuthenticationManager</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSecurityConfigurer</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initialize</span><span class="params">(AuthenticationManagerBuilder builder)</span> &#123;</span><br><span class="line">    <span class="comment">//builder..</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>springboot å¯¹ security è¿›è¡Œè‡ªåŠ¨é…ç½®æ—¶è‡ªåŠ¨åœ¨å·¥å‚ä¸­åˆ›å»ºä¸€ä¸ªå…¨å±€AuthenticationManager</li></ul><p><strong>æ€»ç»“</strong></p><ol><li>é»˜è®¤è‡ªåŠ¨é…ç½®åˆ›å»ºå…¨å±€AuthenticationManager é»˜è®¤æ‰¾å½“å‰é¡¹ç›®ä¸­æ˜¯å¦å­˜åœ¨è‡ªå®šä¹‰ UserDetailService å®ä¾‹ è‡ªåŠ¨å°†å½“å‰é¡¹ç›® UserDetailService å®ä¾‹è®¾ç½®ä¸ºæ•°æ®æº</li><li>é»˜è®¤è‡ªåŠ¨é…ç½®åˆ›å»ºå…¨å±€AuthenticationManager åœ¨å·¥å‚ä¸­ä½¿ç”¨æ—¶ç›´æ¥åœ¨ä»£ç ä¸­æ³¨å…¥å³å¯</li></ol></li><li><p>è‡ªå®šä¹‰å…¨å±€ AuthenticationManager</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSecurityConfigurer</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthenticationManagerBuilder builder)</span> &#123;</span><br><span class="line">  <span class="comment">//builder ....</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>è‡ªå®šä¹‰å…¨å±€ AuthenticationManager</li></ul><p><strong>æ€»ç»“</strong></p><ol><li>ä¸€æ—¦é€šè¿‡ configure æ–¹æ³•è‡ªå®šä¹‰ AuthenticationManagerå®ç° å°±å›å°†å·¥å‚ä¸­è‡ªåŠ¨é…ç½®AuthenticationManager è¿›è¡Œè¦†ç›–</li><li>ä¸€æ—¦é€šè¿‡ configure æ–¹æ³•è‡ªå®šä¹‰ AuthenticationManagerå®ç° éœ€è¦åœ¨å®ç°ä¸­æŒ‡å®šè®¤è¯æ•°æ®æºå¯¹è±¡ UserDetaiService å®ä¾‹</li><li>ä¸€æ—¦é€šè¿‡ configure æ–¹æ³•è‡ªå®šä¹‰ AuthenticationManagerå®ç° è¿™ç§æ–¹å¼åˆ›å»ºAuthenticationManagerå¯¹è±¡å·¥å‚å†…éƒ¨æœ¬åœ°ä¸€ä¸ª AuthenticationManager å¯¹è±¡ ä¸å…è®¸åœ¨å…¶ä»–è‡ªå®šä¹‰ç»„ä»¶ä¸­è¿›è¡Œæ³¨å…¥</li></ol></li><li><p>ç”¨æ¥åœ¨å·¥å‚ä¸­æš´éœ²è‡ªå®šä¹‰AuthenticationManager å®ä¾‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSecurityConfigurer</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">  </span><br><span class="line">    <span class="comment">//1.è‡ªå®šä¹‰AuthenticationManager  æ¨è  å¹¶æ²¡æœ‰åœ¨å·¥å‚ä¸­æš´éœ²å‡ºæ¥</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthenticationManagerBuilder builder)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;è‡ªå®šä¹‰AuthenticationManager: &quot;</span> + builder);</span><br><span class="line">        builder.userDetailsService(userDetailsService());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ä½œç”¨: ç”¨æ¥å°†è‡ªå®šä¹‰AuthenticationManageråœ¨å·¥å‚ä¸­è¿›è¡Œæš´éœ²,å¯ä»¥åœ¨ä»»ä½•ä½ç½®æ³¨å…¥</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> AuthenticationManager <span class="title function_">authenticationManagerBean</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.authenticationManagerBean();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li></ul><h4 id="è‡ªå®šä¹‰å†…å­˜æ•°æ®æº"><a href="#è‡ªå®šä¹‰å†…å­˜æ•°æ®æº" class="headerlink" title="è‡ªå®šä¹‰å†…å­˜æ•°æ®æº"></a>è‡ªå®šä¹‰å†…å­˜æ•°æ®æº</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSecurityConfigurer</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> UserDetailsService <span class="title function_">userDetailsService</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">InMemoryUserDetailsManager</span> <span class="variable">inMemoryUserDetailsManager</span></span><br><span class="line">                <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InMemoryUserDetailsManager</span>();</span><br><span class="line">        <span class="type">UserDetails</span> <span class="variable">u1</span> <span class="operator">=</span> User.withUsername(<span class="string">&quot;zhangs&quot;</span>)</span><br><span class="line">                .password(<span class="string">&quot;&#123;noop&#125;111&quot;</span>).roles(<span class="string">&quot;USER&quot;</span>).build();</span><br><span class="line">        inMemoryUserDetailsManager.createUser(u1);</span><br><span class="line">        <span class="keyword">return</span> inMemoryUserDetailsManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> </span><br><span class="line">      <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        auth.userDetailsService(userDetailsService());</span><br><span class="line">    &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="è‡ªå®šä¹‰æ•°æ®åº“æ•°æ®æº"><a href="#è‡ªå®šä¹‰æ•°æ®åº“æ•°æ®æº" class="headerlink" title="è‡ªå®šä¹‰æ•°æ®åº“æ•°æ®æº"></a>è‡ªå®šä¹‰æ•°æ®åº“æ•°æ®æº</h4><ul><li><p>è®¾è®¡è¡¨ç»“æ„</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- ç”¨æˆ·è¡¨</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `<span class="keyword">user</span>`</span><br><span class="line">(</span><br><span class="line">    `id`                    <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">    `username`              <span class="type">varchar</span>(<span class="number">32</span>)  <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `password`              <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `enabled`               tinyint(<span class="number">1</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `accountNonExpired`     tinyint(<span class="number">1</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `accountNonLocked`      tinyint(<span class="number">1</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `credentialsNonExpired` tinyint(<span class="number">1</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">4</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br><span class="line"><span class="comment">-- è§’è‰²è¡¨</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `role`</span><br><span class="line">(</span><br><span class="line">    `id`      <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">    `name`    <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `name_zh` <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">4</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br><span class="line"><span class="comment">-- ç”¨æˆ·è§’è‰²å…³ç³»è¡¨</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `user_role`</span><br><span class="line">(</span><br><span class="line">    `id`  <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">    `uid` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `rid` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">    KEY   `uid` (`uid`),</span><br><span class="line">    KEY   `rid` (`rid`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">5</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br></pre></td></tr></table></figure></li><li><p>æ’å…¥æµ‹è¯•æ•°æ®</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- æ’å…¥ç”¨æˆ·æ•°æ®</span></span><br><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line">  <span class="keyword">INSERT</span> <span class="keyword">INTO</span> `<span class="keyword">user</span>`</span><br><span class="line">  <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">&#x27;root&#x27;</span>, <span class="string">&#x27;&#123;noop&#125;123&#x27;</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">INSERT</span> <span class="keyword">INTO</span> `<span class="keyword">user</span>`</span><br><span class="line">  <span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="string">&#x27;admin&#x27;</span>, <span class="string">&#x27;&#123;noop&#125;123&#x27;</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">INSERT</span> <span class="keyword">INTO</span> `<span class="keyword">user</span>`</span><br><span class="line">  <span class="keyword">VALUES</span> (<span class="number">3</span>, <span class="string">&#x27;blr&#x27;</span>, <span class="string">&#x27;&#123;noop&#125;123&#x27;</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br><span class="line"><span class="comment">-- æ’å…¥è§’è‰²æ•°æ®</span></span><br><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line">  <span class="keyword">INSERT</span> <span class="keyword">INTO</span> `role`</span><br><span class="line">  <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">&#x27;ROLE_product&#x27;</span>, <span class="string">&#x27;å•†å“ç®¡ç†å‘˜&#x27;</span>);</span><br><span class="line">  <span class="keyword">INSERT</span> <span class="keyword">INTO</span> `role`</span><br><span class="line">  <span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="string">&#x27;ROLE_admin&#x27;</span>, <span class="string">&#x27;ç³»ç»Ÿç®¡ç†å‘˜&#x27;</span>);</span><br><span class="line">  <span class="keyword">INSERT</span> <span class="keyword">INTO</span> `role`</span><br><span class="line">  <span class="keyword">VALUES</span> (<span class="number">3</span>, <span class="string">&#x27;ROLE_user&#x27;</span>, <span class="string">&#x27;ç”¨æˆ·ç®¡ç†å‘˜&#x27;</span>);</span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br><span class="line"><span class="comment">-- æ’å…¥ç”¨æˆ·è§’è‰²æ•°æ®</span></span><br><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line">  <span class="keyword">INSERT</span> <span class="keyword">INTO</span> `user_role`</span><br><span class="line">  <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">INSERT</span> <span class="keyword">INTO</span> `user_role`</span><br><span class="line">  <span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">  <span class="keyword">INSERT</span> <span class="keyword">INTO</span> `user_role`</span><br><span class="line">  <span class="keyword">VALUES</span> (<span class="number">3</span>, <span class="number">2</span>, <span class="number">2</span>);</span><br><span class="line">  <span class="keyword">INSERT</span> <span class="keyword">INTO</span> `user_role`</span><br><span class="line">  <span class="keyword">VALUES</span> (<span class="number">4</span>, <span class="number">3</span>, <span class="number">3</span>);</span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br></pre></td></tr></table></figure></li><li><p>é¡¹ç›®ä¸­å¼•å…¥ä¾èµ–</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.38<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.7<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>é…ç½® springboot é…ç½®æ–‡ä»¶</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># datasource</span></span><br><span class="line"><span class="attr">spring.datasource.type</span>=<span class="string">com.alibaba.druid.pool.DruidDataSource</span></span><br><span class="line"><span class="attr">spring.datasource.driver-class-name</span>=<span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line"><span class="attr">spring.datasource.url</span>=<span class="string">jdbc:mysql://localhost:3306/security?characterEncoding=UTF-8&amp;useSSL=false</span></span><br><span class="line"><span class="attr">spring.datasource.username</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">spring.datasource.password</span>=<span class="string">root</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># mybatis</span></span><br><span class="line"><span class="attr">mybatis.mapper-locations</span>=<span class="string">classpath:com/baizhi/mapper/*.xml</span></span><br><span class="line"><span class="attr">mybatis.type-aliases-package</span>=<span class="string">com.baizhi.entity</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"># log</span></span><br><span class="line"><span class="attr">logging.level.com.baizhi</span>=<span class="string">debug</span></span><br></pre></td></tr></table></figure></li><li><p>åˆ›å»º entity</p><ul><li><p>åˆ›å»º user å¯¹è±¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span>  <span class="keyword">implements</span> <span class="title class_">UserDetails</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="keyword">private</span> Boolean enabled;</span><br><span class="line">    <span class="keyword">private</span> Boolean accountNonExpired;</span><br><span class="line">    <span class="keyword">private</span> Boolean accountNonLocked;</span><br><span class="line">    <span class="keyword">private</span> Boolean credentialsNonExpired;</span><br><span class="line">    <span class="keyword">private</span> List&lt;Role&gt; roles = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Collection&lt;? <span class="keyword">extends</span> <span class="title class_">GrantedAuthority</span>&gt; getAuthorities() &#123;</span><br><span class="line">        List&lt;GrantedAuthority&gt; grantedAuthorities = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        roles.forEach(role-&gt;grantedAuthorities.add(<span class="keyword">new</span> <span class="title class_">SimpleGrantedAuthority</span>(role.getName())));</span><br><span class="line">        <span class="keyword">return</span> grantedAuthorities;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getPassword</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getUsername</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> username;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isAccountNonExpired</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> accountNonExpired;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isAccountNonLocked</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> accountNonLocked;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isCredentialsNonExpired</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> credentialsNonExpired;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isEnabled</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> enabled;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//get/set....</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>åˆ›å»º role å¯¹è±¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Role</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String nameZh;</span><br><span class="line">  <span class="comment">//get set..</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul></li><li><p>åˆ›å»º UserDao æ¥å£</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserDao</span> &#123;</span><br><span class="line">    <span class="comment">//æ ¹æ®ç”¨æˆ·åæŸ¥è¯¢ç”¨æˆ·</span></span><br><span class="line">    User <span class="title function_">loadUserByUsername</span><span class="params">(String username)</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//æ ¹æ®ç”¨æˆ·idæŸ¥è¯¢è§’è‰²</span></span><br><span class="line">  List&lt;Role&gt; <span class="title function_">getRolesByUid</span><span class="params">(Integer uid)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>åˆ›å»º UserMapper å®ç°</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span> <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span> <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.baizhi.dao.UserDao&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--æŸ¥è¯¢å•ä¸ª--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;loadUserByUsername&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;User&quot;</span>&gt;</span></span><br><span class="line">        select id,</span><br><span class="line">               username,</span><br><span class="line">               password,</span><br><span class="line">               enabled,</span><br><span class="line">               accountNonExpired,</span><br><span class="line">               accountNonLocked,</span><br><span class="line">               credentialsNonExpired</span><br><span class="line">        from user</span><br><span class="line">        where username = #&#123;username&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--æŸ¥è¯¢æŒ‡å®šè¡Œæ•°æ®--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;getRolesByUid&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;Role&quot;</span>&gt;</span></span><br><span class="line">        select r.id,</span><br><span class="line">               r.name,</span><br><span class="line">               r.name_zh nameZh</span><br><span class="line">        from role r,</span><br><span class="line">             user_role ur</span><br><span class="line">        where r.id = ur.rid</span><br><span class="line">          and ur.uid = #&#123;uid&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>åˆ›å»º UserDetailService å®ä¾‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyUserDetailService</span> <span class="keyword">implements</span> <span class="title class_">UserDetailsService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span>  <span class="keyword">final</span> UserDao userDao;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyUserDetailService</span><span class="params">(UserDao userDao)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.userDao = userDao;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> UserDetails <span class="title function_">loadUserByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException &#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userDao.loadUserByUsername(username);</span><br><span class="line">        <span class="keyword">if</span>(ObjectUtils.isEmpty(user))<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;ç”¨æˆ·ä¸å­˜åœ¨&quot;</span>);</span><br><span class="line">        user.setRoles(userDao.getRolesByUid(user.getId()));</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>é…ç½® authenticationManager ä½¿ç”¨è‡ªå®šä¹‰UserDetailService</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSecurityConfigurer</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserDetailsService userDetailsService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">WebSecurityConfigurer</span><span class="params">(UserDetailsService userDetailsService)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.userDetailsService = userDetailsService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthenticationManagerBuilder builder)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        builder.userDetailsService(userDetailsService);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">      <span class="comment">//web security..</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>å¯åŠ¨æµ‹è¯•å³å¯</p></li></ul><hr><h3 id="æ·»åŠ è®¤è¯éªŒè¯ç "><a href="#æ·»åŠ è®¤è¯éªŒè¯ç " class="headerlink" title="æ·»åŠ è®¤è¯éªŒè¯ç "></a>æ·»åŠ è®¤è¯éªŒè¯ç </h3><h4 id="é…ç½®éªŒè¯ç "><a href="#é…ç½®éªŒè¯ç " class="headerlink" title="é…ç½®éªŒè¯ç "></a>é…ç½®éªŒè¯ç </h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.github.penggle<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>kaptcha<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">KaptchaConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Producer <span class="title function_">kaptcha</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Properties</span> <span class="variable">properties</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Properties</span>();</span><br><span class="line">        properties.setProperty(<span class="string">&quot;kaptcha.image.width&quot;</span>, <span class="string">&quot;150&quot;</span>);</span><br><span class="line">        properties.setProperty(<span class="string">&quot;kaptcha.image.height&quot;</span>, <span class="string">&quot;50&quot;</span>);</span><br><span class="line">        properties.setProperty(<span class="string">&quot;kaptcha.textproducer.char.string&quot;</span>, <span class="string">&quot;0123456789&quot;</span>);</span><br><span class="line">        properties.setProperty(<span class="string">&quot;kaptcha.textproducer.char.length&quot;</span>, <span class="string">&quot;4&quot;</span>);</span><br><span class="line">        <span class="type">Config</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Config</span>(properties);</span><br><span class="line">        <span class="type">DefaultKaptcha</span> <span class="variable">defaultKaptcha</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultKaptcha</span>();</span><br><span class="line">        defaultKaptcha.setConfig(config);</span><br><span class="line">        <span class="keyword">return</span> defaultKaptcha;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ä¼ ç»Ÿ-web-å¼€å‘"><a href="#ä¼ ç»Ÿ-web-å¼€å‘" class="headerlink" title="ä¼ ç»Ÿ web å¼€å‘"></a>ä¼ ç»Ÿ web å¼€å‘</h4><ul><li><p>ç”ŸæˆéªŒè¯ç  controller</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">KaptchaController</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Producer producer;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">KaptchaController</span><span class="params">(Producer producer)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.producer = producer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/vc.jpg&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getVerifyCode</span><span class="params">(HttpServletResponse response, HttpSession session)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        response.setContentType(<span class="string">&quot;image/png&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">code</span> <span class="operator">=</span> producer.createText();</span><br><span class="line">        session.setAttribute(<span class="string">&quot;kaptcha&quot;</span>, code);<span class="comment">//å¯ä»¥æ›´æ¢æˆ redis å®ç°</span></span><br><span class="line">        <span class="type">BufferedImage</span> <span class="variable">bi</span> <span class="operator">=</span> producer.createImage(code);</span><br><span class="line">        <span class="type">ServletOutputStream</span> <span class="variable">os</span> <span class="operator">=</span> response.getOutputStream();</span><br><span class="line">        ImageIO.write(bi, <span class="string">&quot;jpg&quot;</span>, os);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>è‡ªå®šä¹‰éªŒè¯ç å¼‚å¸¸ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">KaptchaNotMatchException</span> <span class="keyword">extends</span> <span class="title class_">AuthenticationException</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">KaptchaNotMatchException</span><span class="params">(String msg)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">KaptchaNotMatchException</span><span class="params">(String msg, Throwable cause)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(msg, cause);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>è‡ªå®šä¹‰filteréªŒè¯éªŒè¯ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">KaptchaFilter</span> <span class="keyword">extends</span> <span class="title class_">UsernamePasswordAuthenticationFilter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">KAPTCHA_KEY</span> <span class="operator">=</span> <span class="string">&quot;kaptcha&quot;</span>;<span class="comment">//é»˜è®¤å€¼</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">kaptcha</span> <span class="operator">=</span> KAPTCHA_KEY;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getKaptcha</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> kaptcha;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setKaptcha</span><span class="params">(String kaptcha)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.kaptcha = kaptcha;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Authentication <span class="title function_">attemptAuthentication</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> AuthenticationException &#123;</span><br><span class="line">        <span class="comment">//1.åˆ¤æ–­æ˜¯å¦æ˜¯ post æ–¹å¼</span></span><br><span class="line">        <span class="keyword">if</span> (request.getMethod().equals(<span class="string">&quot;POST&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AuthenticationServiceException</span>(<span class="string">&quot;Authentication method not supported: &quot;</span> + request.getMethod());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//2.è·å–éªŒè¯ç </span></span><br><span class="line">        <span class="type">String</span> <span class="variable">kaptcha</span> <span class="operator">=</span> request.getParameter(getKaptcha());</span><br><span class="line">        <span class="type">String</span> <span class="variable">sessionKaptcha</span> <span class="operator">=</span> (String) request.getSession().getAttribute(<span class="string">&quot;kaptcha&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!ObjectUtils.isEmpty(kaptcha) &amp;&amp; !ObjectUtils.isEmpty(sessionKaptcha) &amp;&amp;</span><br><span class="line">                kaptcha.equalsIgnoreCase(sessionKaptcha)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">super</span>.attemptAuthentication(request, response);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">KaptchaNotMatchException</span>(<span class="string">&quot;éªŒè¯ç è¾“å…¥é”™è¯¯!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>æ”¾è¡Œä»¥åŠé…ç½®éªŒè¯ç  filter</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSecurityConfigurer</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserDetailsService userDetailsService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">WebSecurityConfigurer</span><span class="params">(UserDetailsService userDetailsService)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.userDetailsService = userDetailsService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthenticationManagerBuilder builder)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        builder.userDetailsService(userDetailsService);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> AuthenticationManager <span class="title function_">authenticationManagerBean</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.authenticationManagerBean();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> KaptchaFilter <span class="title function_">kaptchaFilter</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">KaptchaFilter</span> <span class="variable">kaptchaFilter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">KaptchaFilter</span>();</span><br><span class="line">        <span class="comment">//æŒ‡å®šæ¥æ”¶éªŒè¯ç è¯·æ±‚å‚æ•°å</span></span><br><span class="line">        kaptchaFilter.setKaptcha(<span class="string">&quot;kaptcha&quot;</span>);</span><br><span class="line">        <span class="comment">//æŒ‡å®šè®¤è¯ç®¡ç†å™¨</span></span><br><span class="line">        kaptchaFilter.setAuthenticationManager(authenticationManagerBean());</span><br><span class="line">        <span class="comment">//æŒ‡å®šè®¤è¯æˆåŠŸå’Œå¤±è´¥å¤„ç†</span></span><br><span class="line">        kaptchaFilter.setAuthenticationSuccessHandler(<span class="keyword">new</span> <span class="title class_">MyAuthenticationSuccessHandler</span>());</span><br><span class="line">        kaptchaFilter.setAuthenticationFailureHandler(<span class="keyword">new</span> <span class="title class_">MyAuthenticationFailureHandler</span>());</span><br><span class="line">        <span class="comment">//æŒ‡å®šå¤„ç†ç™»å½•</span></span><br><span class="line">        kaptchaFilter.setFilterProcessesUrl(<span class="string">&quot;/doLogin&quot;</span>);</span><br><span class="line">        kaptchaFilter.setUsernameParameter(<span class="string">&quot;uname&quot;</span>);</span><br><span class="line">        kaptchaFilter.setPasswordParameter(<span class="string">&quot;passwd&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> kaptchaFilter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http.authorizeHttpRequests()</span><br><span class="line">                .mvcMatchers(<span class="string">&quot;/vc.jpg&quot;</span>).permitAll()</span><br><span class="line">                .mvcMatchers(<span class="string">&quot;/login.html&quot;</span>).permitAll()</span><br><span class="line">                .anyRequest().authenticated()</span><br><span class="line">                .and()</span><br><span class="line">                .formLogin()</span><br><span class="line">                .loginPage(<span class="string">&quot;/login.html&quot;</span>)</span><br><span class="line">              ...</span><br><span class="line">        http.addFilterAt(kaptchaFilter(), UsernamePasswordAuthenticationFilter.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>ç™»å½•é¡µé¢æ·»åŠ éªŒè¯ç </p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span> <span class="attr">th:action</span>=<span class="string">&quot;@&#123;/doLogin&#125;&quot;</span>&gt;</span></span><br><span class="line">    ç”¨æˆ·å:<span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">&quot;uname&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span>/&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    å¯†ç :<span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">&quot;passwd&quot;</span> <span class="attr">type</span>=<span class="string">&quot;password&quot;</span>/&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    éªŒè¯ç : <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">&quot;kaptcha&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span>/&gt;</span> <span class="tag">&lt;<span class="name">img</span> <span class="attr">alt</span>=<span class="string">&quot;&quot;</span> <span class="attr">th:src</span>=<span class="string">&quot;@&#123;/vc.jpg&#125;&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;ç™»å½•&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure></li></ul><h4 id="å‰åç«¯åˆ†ç¦»å¼€å‘"><a href="#å‰åç«¯åˆ†ç¦»å¼€å‘" class="headerlink" title="å‰åç«¯åˆ†ç¦»å¼€å‘"></a>å‰åç«¯åˆ†ç¦»å¼€å‘</h4><ul><li><p>ç”ŸæˆéªŒè¯ç  controller</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">KaptchaController</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Producer producer;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">KaptchaController</span><span class="params">(Producer producer)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.producer = producer;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/vc.png&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getVerifyCode</span><span class="params">(HttpSession session)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">//1.ç”ŸæˆéªŒè¯ç </span></span><br><span class="line">        <span class="type">String</span> <span class="variable">code</span> <span class="operator">=</span> producer.createText();</span><br><span class="line">        session.setAttribute(<span class="string">&quot;kaptcha&quot;</span>, code);<span class="comment">//å¯ä»¥æ›´æ¢æˆ redis å®ç°</span></span><br><span class="line">        <span class="type">BufferedImage</span> <span class="variable">bi</span> <span class="operator">=</span> producer.createImage(code);</span><br><span class="line">        <span class="comment">//2.å†™å…¥å†…å­˜</span></span><br><span class="line">        <span class="type">FastByteArrayOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FastByteArrayOutputStream</span>();</span><br><span class="line">        ImageIO.write(bi, <span class="string">&quot;png&quot;</span>, fos);</span><br><span class="line">        <span class="comment">//3.ç”Ÿæˆ base64</span></span><br><span class="line">        <span class="keyword">return</span> Base64.encodeBase64String(fos.toByteArray());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>å®šä¹‰éªŒè¯ç å¼‚å¸¸ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">KaptchaNotMatchException</span> <span class="keyword">extends</span> <span class="title class_">AuthenticationException</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">KaptchaNotMatchException</span><span class="params">(String msg)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">KaptchaNotMatchException</span><span class="params">(String msg, Throwable cause)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(msg, cause);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>åœ¨è‡ªå®šä¹‰LoginKaptchaFilterä¸­åŠ å…¥éªŒè¯ç éªŒè¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">//è‡ªå®šä¹‰ filter</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginKaptchaFilter</span> <span class="keyword">extends</span> <span class="title class_">UsernamePasswordAuthenticationFilter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">FORM_KAPTCHA_KEY</span> <span class="operator">=</span> <span class="string">&quot;kaptcha&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">kaptchaParameter</span> <span class="operator">=</span> FORM_KAPTCHA_KEY;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getKaptchaParameter</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> kaptchaParameter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setKaptchaParameter</span><span class="params">(String kaptchaParameter)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.kaptchaParameter = kaptchaParameter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Authentication <span class="title function_">attemptAuthentication</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> AuthenticationException &#123;</span><br><span class="line">        <span class="keyword">if</span> (!request.getMethod().equals(<span class="string">&quot;POST&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AuthenticationServiceException</span>(<span class="string">&quot;Authentication method not supported: &quot;</span> + request.getMethod());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//1.è·å–è¯·æ±‚æ•°æ®</span></span><br><span class="line">            Map&lt;String, String&gt; userInfo = <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>().readValue(request.getInputStream(), Map.class);</span><br><span class="line">            <span class="type">String</span> <span class="variable">kaptcha</span> <span class="operator">=</span> userInfo.get(getKaptchaParameter());<span class="comment">//ç”¨æ¥è·å–æ•°æ®ä¸­éªŒè¯ç </span></span><br><span class="line">            <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> userInfo.get(getUsernameParameter());<span class="comment">//ç”¨æ¥æ¥æ”¶ç”¨æˆ·å</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> userInfo.get(getPasswordParameter());<span class="comment">//ç”¨æ¥æ¥æ”¶å¯†ç </span></span><br><span class="line">            <span class="comment">//2.è·å– session ä¸­éªŒè¯ç </span></span><br><span class="line">            <span class="type">String</span> <span class="variable">sessionVerifyCode</span> <span class="operator">=</span> (String) request.getSession().getAttribute(<span class="string">&quot;kaptcha&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (!ObjectUtils.isEmpty(kaptcha) &amp;&amp; !ObjectUtils.isEmpty(sessionVerifyCode) &amp;&amp;</span><br><span class="line">                    kaptcha.equalsIgnoreCase(sessionVerifyCode)) &#123;</span><br><span class="line">                <span class="comment">//3.è·å–ç”¨æˆ·å å’Œå¯†ç è®¤è¯</span></span><br><span class="line">                <span class="type">UsernamePasswordAuthenticationToken</span> <span class="variable">authRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UsernamePasswordAuthenticationToken</span>(username, password);</span><br><span class="line">                setDetails(request, authRequest);</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">this</span>.getAuthenticationManager().authenticate(authRequest);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">KaptchaNotMatchException</span>(<span class="string">&quot;éªŒè¯ç ä¸åŒ¹é…!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>é…ç½®</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è‡ªå®šä¹‰å†…å­˜æ•°æ®æº</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> UserDetailsService <span class="title function_">userDetailsService</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">InMemoryUserDetailsManager</span> <span class="variable">inMemoryUserDetailsManager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InMemoryUserDetailsManager</span>();</span><br><span class="line">        inMemoryUserDetailsManager.createUser(User.withUsername(<span class="string">&quot;root&quot;</span>).password(<span class="string">&quot;&#123;noop&#125;123&quot;</span>).roles(<span class="string">&quot;admin&quot;</span>).build());</span><br><span class="line">        <span class="keyword">return</span> inMemoryUserDetailsManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        auth.userDetailsService(userDetailsService());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> AuthenticationManager <span class="title function_">authenticationManagerBean</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.authenticationManagerBean();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//é…ç½®</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> LoginKaptchaFilter <span class="title function_">loginKaptchaFilter</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">LoginKaptchaFilter</span> <span class="variable">loginKaptchaFilter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LoginKaptchaFilter</span>();</span><br><span class="line">        <span class="comment">//1.è®¤è¯ url</span></span><br><span class="line">        loginKaptchaFilter.setFilterProcessesUrl(<span class="string">&quot;/doLogin&quot;</span>);</span><br><span class="line">        <span class="comment">//2.è®¤è¯ æ¥æ”¶å‚æ•°</span></span><br><span class="line">        loginKaptchaFilter.setUsernameParameter(<span class="string">&quot;uname&quot;</span>);</span><br><span class="line">        loginKaptchaFilter.setPasswordParameter(<span class="string">&quot;passwd&quot;</span>);</span><br><span class="line">        loginKaptchaFilter.setKaptchaParameter(<span class="string">&quot;kaptcha&quot;</span>);</span><br><span class="line">        <span class="comment">//3.æŒ‡å®šè®¤è¯ç®¡ç†å™¨</span></span><br><span class="line">        loginKaptchaFilter.setAuthenticationManager(authenticationManagerBean());</span><br><span class="line">        <span class="comment">//4.æŒ‡å®šæˆåŠŸæ—¶å¤„ç†</span></span><br><span class="line">        loginKaptchaFilter.setAuthenticationSuccessHandler((req, resp, authentication) -&gt; &#123;</span><br><span class="line">            Map&lt;String, Object&gt; result = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, Object&gt;();</span><br><span class="line">            result.put(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;ç™»å½•æˆåŠŸ&quot;</span>);</span><br><span class="line">            result.put(<span class="string">&quot;ç”¨æˆ·ä¿¡æ¯&quot;</span>, authentication.getPrincipal());</span><br><span class="line">            resp.setContentType(<span class="string">&quot;application/json;charset=UTF-8&quot;</span>);</span><br><span class="line">            resp.setStatus(HttpStatus.OK.value());</span><br><span class="line">            <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>().writeValueAsString(result);</span><br><span class="line">            resp.getWriter().println(s);</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">//5.è®¤è¯å¤±è´¥å¤„ç†</span></span><br><span class="line">        loginKaptchaFilter.setAuthenticationFailureHandler((req, resp, ex) -&gt; &#123;</span><br><span class="line">            Map&lt;String, Object&gt; result = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, Object&gt;();</span><br><span class="line">            result.put(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;ç™»å½•å¤±è´¥: &quot;</span> + ex.getMessage());</span><br><span class="line">            resp.setStatus(HttpStatus.INTERNAL_SERVER_ERROR.value());</span><br><span class="line">            resp.setContentType(<span class="string">&quot;application/json;charset=UTF-8&quot;</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>().writeValueAsString(result);</span><br><span class="line">            resp.getWriter().println(s);</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> loginKaptchaFilter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http.authorizeRequests()</span><br><span class="line">                .mvcMatchers(<span class="string">&quot;/vc.jpg&quot;</span>).permitAll()</span><br><span class="line">                .anyRequest().authenticated()</span><br><span class="line">                .and()</span><br><span class="line">                .formLogin()</span><br><span class="line">                .and()</span><br><span class="line">                .exceptionHandling()</span><br><span class="line">                .authenticationEntryPoint((req, resp, ex) -&gt; &#123;</span><br><span class="line">                    resp.setContentType(<span class="string">&quot;application/json;charset=UTF-8&quot;</span>);</span><br><span class="line">                    resp.setStatus(HttpStatus.UNAUTHORIZED.value());</span><br><span class="line">                    resp.getWriter().println(<span class="string">&quot;å¿…é¡»è®¤è¯ä¹‹åæ‰èƒ½è®¿é—®!&quot;</span>);</span><br><span class="line">                &#125;)</span><br><span class="line">                .and()</span><br><span class="line">                .logout()</span><br><span class="line">                .and()</span><br><span class="line">                .csrf().disable();</span><br><span class="line"></span><br><span class="line">        http.addFilterAt(loginKaptchaFilter(), UsernamePasswordAuthenticationFilter.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure></li><li><p>æµ‹è¯•éªŒè¯</p></li></ul><h1 id="ç¬¬äº”ç« -å¯†ç åŠ å¯†"><a href="#ç¬¬äº”ç« -å¯†ç åŠ å¯†" class="headerlink" title="ç¬¬äº”ç«  å¯†ç åŠ å¯†"></a>ç¬¬äº”ç«  å¯†ç åŠ å¯†</h1><ul><li>å¯†ç ä¸ºä»€ä¹ˆè¦åŠ å¯†</li><li>å¸¸è§åŠ å¯†çš„è§£å†³æ–¹æ¡ˆ</li><li>PasswordEncoder è¯¦è§£</li><li>ä¼˜é›…ä½¿ç”¨åŠ å¯†</li></ul><h2 id="ç®€ä»‹-1"><a href="#ç®€ä»‹-1" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><h3 id="åŠ å¯†æ„ä¹‰"><a href="#åŠ å¯†æ„ä¹‰" class="headerlink" title="åŠ å¯†æ„ä¹‰"></a>åŠ å¯†æ„ä¹‰</h3><p>â€‹2011 å¹´12æœˆ21 æ—¥ï¼Œæœ‰äººåœ¨ç½‘ç»œä¸Šå…¬å¼€äº†ä¸€ä¸ªåŒ…å«600ä¸‡ä¸ª CSDN ç”¨æˆ·èµ„æ–™çš„æ•°æ®åº“ï¼Œæ•°æ®å…¨éƒ¨ä¸ºæ˜æ–‡å‚¨å­˜ï¼ŒåŒ…å«ç”¨æˆ·åã€å¯†ç ä»¥åŠæ³¨å†Œé‚®ç®±ã€‚äº‹ä»¶å‘ç”Ÿå CSDN åœ¨å¾®åšã€å®˜æ–¹ç½‘ç«™ç­‰æ¸ é“å‘å‡ºäº†å£°æ˜ï¼Œè§£é‡Šè¯´æ­¤æ•°æ®åº“ç³»2009 å¹´å¤‡ä»½æ‰€ç”¨ï¼Œå› ä¸æ˜åŸå› æ³„æ¼ï¼Œå·²ç»å‘è­¦æ–¹æŠ¥<br>æ¡ˆï¼Œååˆåœ¨å®˜ç½‘å‘å‡ºäº†å…¬å¼€é“æ­‰ä¿¡ã€‚åœ¨æ¥ä¸‹æ¥çš„åå¤šå¤©é‡Œï¼Œé‡‘å±±ã€ç½‘æ˜“ã€äº¬ä¸œã€å½“å½“ã€æ–°æµªç­‰å¤šå®¶å…¬å¸è¢«å·å…¥åˆ°è¿™æ¬¡äº‹ä»¶ä¸­ã€‚æ•´ä¸ªäº‹ä»¶ä¸­æœ€è§¦ç›®æƒŠå¿ƒçš„è«è¿‡äº CSDN æŠŠç”¨æˆ·å¯†ç æ˜æ–‡å­˜å‚¨ï¼Œç”±äºå¾ˆå¤šç”¨æˆ·æ˜¯å¤šä¸ªç½‘ç«™å…±ç”¨ä¸€ä¸ªå¯†ç ï¼Œå› æ­¤ä¸€ä¸ªç½‘ç«™å¯†ç æ³„æ¼å°±ä¼šé€ æˆå¾ˆå¤§çš„å®‰å…¨éšæ‚£ã€‚ç”±äºæœ‰äº†è¿™ä¹ˆå¤šå‰è½¦ä¹‹é‰´ï¼Œæˆ‘ä»¬ç°åœ¨åšç³»ç»Ÿæ—¶ï¼Œå¯†ç éƒ½è¦åŠ å¯†å¤„ç†ã€‚</p><p>åœ¨å‰é¢çš„æ¡ˆä¾‹ä¸­ï¼Œå‡¡æ˜¯æ¶‰åŠå¯†ç çš„åœ°æ–¹ï¼Œæˆ‘ä»¬éƒ½é‡‡ç”¨æ˜æ–‡å­˜å‚¨ï¼Œåœ¨å®é™…é¡¹ç›®ä¸­è¿™è‚¯å®šæ˜¯ä¸å¯å–çš„ï¼Œå› ä¸ºè¿™ä¼šå¸¦æ¥æé«˜çš„å®‰å…¨é£é™©ã€‚åœ¨ä¼ä¸šçº§åº”ç”¨ä¸­ï¼Œå¯†ç ä¸ä»…éœ€è¦åŠ å¯†ï¼Œè¿˜éœ€è¦åŠ <code>ç›</code>ï¼Œæœ€å¤§ç¨‹åº¦åœ°ä¿è¯å¯†ç å®‰å…¨ã€‚</p><h3 id="å¸¸è§æ–¹æ¡ˆ"><a href="#å¸¸è§æ–¹æ¡ˆ" class="headerlink" title="å¸¸è§æ–¹æ¡ˆ"></a>å¸¸è§æ–¹æ¡ˆ</h3><h4 id="Hash-ç®—æ³•"><a href="#Hash-ç®—æ³•" class="headerlink" title="Hash ç®—æ³•"></a>Hash ç®—æ³•</h4><p>â€‹æœ€æ—©æˆ‘ä»¬ä½¿ç”¨ç±»ä¼¼ SHA-256 ã€SHA-512 ã€MD5ç­‰è¿™æ ·çš„å•å‘ Hash ç®—æ³•ã€‚ç”¨æˆ·æ³¨å†ŒæˆåŠŸåï¼Œä¿å­˜åœ¨æ•°æ®åº“ä¸­ä¸å†æ˜¯ç”¨æˆ·çš„æ˜æ–‡å¯†ç ï¼Œè€Œæ˜¯ç»è¿‡ SHA-256 åŠ å¯†è®¡ç®—çš„ä¸€ä¸ªå­—è¡Œä¸²ï¼Œå½“ç”¨æˆ·è¿›è¡Œç™»å½•æ—¶ï¼Œç”¨æˆ·è¾“å…¥çš„æ˜æ–‡å¯†ç ç”¨ SHA-256 è¿›è¡ŒåŠ å¯†ï¼ŒåŠ å¯†å®Œæˆä¹‹åï¼Œå†å’Œå­˜å‚¨åœ¨æ•°æ®åº“ä¸­çš„å¯†ç è¿›è¡Œæ¯”å¯¹ï¼Œè¿›è€Œç¡®å®šç”¨æˆ·ç™»å½•ä¿¡æ¯æ˜¯å¦æœ‰æ•ˆã€‚å¦‚æœç³»ç»Ÿé­é‡æ”»å‡»ï¼Œæœ€å¤šä¹Ÿåªæ˜¯å­˜å‚¨åœ¨æ•°æ®åº“ä¸­çš„å¯†æ–‡è¢«æ³„æ¼ã€‚</p><p>â€‹è¿™æ ·å°±ç»å¯¹å®‰å…¨äº†å—ï¼Ÿç”±äºå½©è™¹è¡¨è¿™ç§æ”»å‡»æ–¹å¼çš„å­˜åœ¨ä»¥åŠéšç€è®¡ç®—æœºç¡¬ä»¶çš„å‘å±•ï¼Œæ¯ç§’æ‰§è¡Œæ•°åäº¿æ¬¡ HASHè®¡ç®—å·±ç»å˜å¾—è½»è½»æ¾æ¾ï¼Œè¿™æ„å‘³ç€å³ä½¿ç»™å¯†ç åŠ å¯†åŠ ç›ä¹Ÿä¸å†å®‰å…¨ã€‚</p><p>å‚è€ƒ: <a href="https://baike.baidu.com/item/%E5%BD%A9%E8%99%B9%E8%A1%A8/689313?fr=aladdin">å½©è™¹è¡¨</a></p><h4 id="å•å‘è‡ªé€‚åº”å‡½æ•°"><a href="#å•å‘è‡ªé€‚åº”å‡½æ•°" class="headerlink" title="å•å‘è‡ªé€‚åº”å‡½æ•°"></a>å•å‘è‡ªé€‚åº”å‡½æ•°<Adaptive One-way Functions></h4><p>åœ¨Spring Security ä¸­ï¼Œæˆ‘ä»¬ç°åœ¨æ˜¯ç”¨ä¸€ç§è‡ªé€‚åº”å•å‘å‡½æ•° (Adaptive One-way Functions)æ¥å¤„ç†å¯†ç é—®é¢˜ï¼Œè¿™ç§è‡ªé€‚åº”å•å‘å‡½æ•°åœ¨è¿›è¡Œå¯†ç åŒ¹é…æ—¶ï¼Œä¼šæœ‰æ„å ç”¨å¤§é‡ç³»ç»Ÿèµ„æºï¼ˆä¾‹å¦‚CPUã€å†…å­˜ç­‰ï¼‰ï¼Œè¿™æ ·å¯ä»¥å¢åŠ æ¶æ„ç”¨æˆ·æ”»å‡»ç³»ç»Ÿçš„éš¾åº¦ã€‚åœ¨Spring Securiy ä¸­ï¼Œå¼€å‘è€…å¯ä»¥é€šè¿‡ bcryptã€PBKDF2ã€sCrypt ä»¥åŠ argon2 æ¥ä½“éªŒè¿™ç§è‡ªé€‚åº”å•å‘å‡½æ•°åŠ å¯†ã€‚ç”±äºè‡ªé€‚åº”å•å‘å‡½æ•°æœ‰æ„å ç”¨å¤§é‡ç³»ç»Ÿèµ„æºï¼Œå› æ­¤æ¯ä¸ªç™»å½•è®¤è¯è¯·æ±‚éƒ½ä¼šå¤§å¤§é™ä½åº”ç”¨ç¨‹åºçš„æ€§èƒ½ï¼Œä½†æ˜¯ Spring Secuity ä¸ä¼šé‡‡å–ä»»ä½•æªæ–½æ¥æé«˜å¯†ç éªŒè¯é€Ÿåº¦ï¼Œå› ä¸ºå®ƒæ­£æ˜¯é€šè¿‡è¿™ç§æ–¹å¼æ¥å¢å¼ºç³»ç»Ÿçš„å®‰å…¨æ€§ã€‚</p><p>å‚è€ƒ 1: <a href="https://byronhe.gitbooks.io/libsodium/content/password_hashing/">https://byronhe.gitbooks.io/libsodium/content/password_hashing/</a></p><p>å‚è€ƒ 2: <a href="https://github.com/xitu/gold-miner/blob/master/TODO1/password-hashing-pbkdf2-scrypt-bcrypt-and-argon2.md">https://github.com/xitu/gold-miner/blob/master/TODO1/password-hashing-pbkdf2-scrypt-bcrypt-and-argon2.md</a></p><ul><li><p>BCryptPasswordEncoder</p><p>BCryptPasswordEncoder ä½¿ç”¨ bcrypt ç®—æ³•å¯¹å¯†ç è¿›è¡ŒåŠ å¯†ï¼Œä¸ºäº†æé«˜å¯†ç çš„å®‰å…¨æ€§ï¼Œbcryptç®—æ³•æ•…æ„é™ä½è¿è¡Œé€Ÿåº¦ï¼Œä»¥å¢å¼ºå¯†ç ç ´è§£çš„éš¾åº¦ã€‚åŒæ—¶ BCryptP asswordEncoder â€œä¸ºè‡ªå·±å¸¦ç›â€å¼€å‘è€…ä¸éœ€è¦é¢å¤–ç»´æŠ¤ä¸€ä¸ªâ€œç›â€ å­—æ®µï¼Œä½¿ç”¨ BCryptPasswordEncoder åŠ å¯†åçš„å­—ç¬¦ä¸²å°±å·²ç»â€œå¸¦ç›â€äº†ï¼Œå³ä½¿ç›¸åŒçš„æ˜æ–‡æ¯æ¬¡ç”Ÿæˆçš„åŠ å¯†å­—ç¬¦ä¸²éƒ½ä¸ç›¸åŒã€‚</p></li><li><p>Argon2PasswordEncoder</p><p>Argon2PasswordEncoder ä½¿ç”¨ Argon2 ç®—æ³•å¯¹å¯†ç è¿›è¡ŒåŠ å¯†ï¼ŒArgon2 æ›¾åœ¨ Password Hashing Competition ç«èµ›ä¸­è·èƒœã€‚ä¸ºäº†è§£å†³åœ¨å®šåˆ¶ç¡¬ä»¶ä¸Šå¯†ç å®¹æ˜“è¢«ç ´è§£çš„é—®é¢˜ï¼ŒArgon2ä¹Ÿæ˜¯æ•…æ„é™ä½è¿ç®—é€Ÿåº¦ï¼ŒåŒæ—¶éœ€è¦å¤§é‡å†…å­˜ï¼Œä»¥ç¡®ä¿ç³»ç»Ÿçš„å®‰å…¨æ€§ã€‚</p></li><li><p>Pbkdf2PasswordEncoder</p><p>Pbkdf2PasswordEncoder ä½¿ç”¨ PBKDF2 ç®—æ³•å¯¹å¯†ç è¿›è¡ŒåŠ å¯†ï¼Œå’Œå‰é¢å‡ ç§ç±»ä¼¼ï¼ŒPBKDF2</p><p>ç®—æ³•ä¹Ÿæ˜¯ä¸€ç§æ•…æ„é™ä½è¿ç®—é€Ÿåº¦çš„ç®—æ³•ï¼Œå½“éœ€è¦ FIPS (Federal Information Processing Standard,ç¾å›½è”é‚¦ä¿¡æ¯å¤„ç†æ ‡å‡†ï¼‰è®¤è¯æ—¶ï¼ŒPBKDF2 ç®—æ³•æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é€‰æ‹©ã€‚</p></li><li><p>SCryptPasswordEncoder</p><p>SCryptPasswordEncoder ä½¿ç”¨scrypt ç®—æ³•å¯¹å¯†ç è¿›è¡ŒåŠ å¯†ï¼Œå’Œå‰é¢çš„å‡ ç§ç±»ä¼¼ï¼Œserypt ä¹Ÿæ˜¯ä¸€ç§æ•…æ„é™ä½è¿ç®—é€Ÿåº¦çš„ç®—æ³•ï¼Œè€Œä¸”éœ€è¦å¤§é‡å†…å­˜ã€‚</p></li></ul><h2 id="PasswordEncoder"><a href="#PasswordEncoder" class="headerlink" title="PasswordEncoder"></a>PasswordEncoder</h2><p>é€šè¿‡å¯¹è®¤è¯æµç¨‹æºç åˆ†æå¾—çŸ¥ï¼Œå®é™…å¯†ç æ¯”è¾ƒæ˜¯ç”±PasswordEncoderå®Œæˆçš„ï¼Œå› æ­¤åªéœ€è¦ä½¿ç”¨PasswordEncoder ä¸åŒå®ç°å°±å¯ä»¥å®ç°ä¸åŒæ–¹å¼åŠ å¯†ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">PasswordEncoder</span> &#123;</span><br><span class="line">String <span class="title function_">encode</span><span class="params">(CharSequence rawPassword)</span>;</span><br><span class="line"><span class="type">boolean</span> <span class="title function_">matches</span><span class="params">(CharSequence rawPassword, String encodedPassword)</span>;</span><br><span class="line"><span class="keyword">default</span> <span class="type">boolean</span> <span class="title function_">upgradeEncoding</span><span class="params">(String encodedPassword)</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>encode ç”¨æ¥è¿›è¡Œæ˜æ–‡åŠ å¯†çš„</li><li>matches ç”¨æ¥æ¯”è¾ƒå¯†ç çš„æ–¹æ³•</li><li>upgradeEncoding ç”¨æ¥ç»™å¯†ç è¿›è¡Œå‡çº§çš„æ–¹æ³•</li></ul><p>é»˜è®¤æä¾›åŠ å¯†ç®—æ³•å¦‚ä¸‹:</p><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220127162622771.png" class=""><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220127162759461.png" class=""><h2 id="DelegatingPasswordEncoder"><a href="#DelegatingPasswordEncoder" class="headerlink" title="DelegatingPasswordEncoder"></a>DelegatingPasswordEncoder</h2><p>æ ¹æ®ä¸Šé¢ PasswordEncoderçš„ä»‹ç»ï¼Œå¯èƒ½ä¼šä»¥ä¸º Spring security ä¸­é»˜è®¤çš„å¯†ç åŠ å¯†æ–¹æ¡ˆåº”è¯¥æ˜¯å››ç§è‡ªé€‚åº”å•å‘åŠ å¯†å‡½æ•°ä¸­çš„ä¸€ç§ï¼Œå…¶å®ä¸ç„¶ï¼Œåœ¨ spring Security 5.0ä¹‹åï¼Œé»˜è®¤çš„å¯†ç åŠ å¯†æ–¹æ¡ˆå…¶å®æ˜¯ DelegatingPasswordEncoderã€‚ä»åå­—ä¸Šæ¥çœ‹ï¼ŒDelegatingPaswordEncoder æ˜¯ä¸€ä¸ªä»£ç†ç±»ï¼Œè€Œå¹¶éä¸€ç§å…¨æ–°çš„å¯†ç åŠ å¯†æ–¹æ¡ˆï¼ŒDeleggtinePasswordEncoder ä¸»è¦ç”¨æ¥ä»£ç†ä¸Šé¢ä»‹ç»çš„ä¸åŒçš„å¯†ç åŠ å¯†æ–¹æ¡ˆã€‚ä¸ºä»€ä¹ˆé‡‡DelegatingPasswordEncoder è€Œä¸æ˜¯æŸä¸€ä¸ªå…·ä½“åŠ å¯†æ–¹å¼ä½œä¸ºé»˜è®¤çš„å¯†ç åŠ å¯†æ–¹æ¡ˆå‘¢ï¼Ÿä¸»è¦è€ƒè™‘äº†å¦‚ä¸‹ä¸¤æ–¹é¢çš„å› ç´ ï¼š</p><ul><li><p>å…¼å®¹æ€§ï¼šä½¿ç”¨ DelegatingPasswrordEncoder å¯ä»¥å¸®åŠ©è®¸å¤šä½¿ç”¨æ—§å¯†ç åŠ å¯†æ–¹å¼çš„ç³»ç»Ÿé¡ºåˆ©è¿ç§»åˆ° Spring security ä¸­ï¼Œå®ƒå…è®¸åœ¨åŒä¸€ä¸ªç³»ç»Ÿä¸­åŒæ—¶å­˜åœ¨å¤šç§ä¸åŒçš„å¯†ç åŠ å¯†æ–¹æ¡ˆã€‚</p></li><li><p>ä¾¿æ·æ€§ï¼šå¯†ç å­˜å‚¨çš„æœ€ä½³æ–¹æ¡ˆä¸å¯èƒ½ä¸€ç›´ä¸å˜ï¼Œå¦‚æœä½¿ç”¨ DelegatingPasswordEncoderä½œä¸ºé»˜è®¤çš„å¯†ç åŠ å¯†æ–¹æ¡ˆï¼Œå½“éœ€è¦ä¿®æ”¹åŠ å¯†æ–¹æ¡ˆæ—¶ï¼Œåªéœ€è¦ä¿®æ”¹å¾ˆå°ä¸€éƒ¨åˆ†ä»£ç å°±å¯ä»¥å®ç°ã€‚</p></li></ul><h4 id="DelegatingPasswordEncoderæºç "><a href="#DelegatingPasswordEncoderæºç " class="headerlink" title="DelegatingPasswordEncoderæºç "></a>DelegatingPasswordEncoderæºç </h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DelegatingPasswordEncoder</span> <span class="keyword">implements</span> <span class="title class_">PasswordEncoder</span> &#123;</span><br><span class="line">  ....</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>encode ç”¨æ¥è¿›è¡Œæ˜æ–‡åŠ å¯†çš„</li><li>matches ç”¨æ¥æ¯”è¾ƒå¯†ç çš„æ–¹æ³•</li><li>upgradeEncoding ç”¨æ¥ç»™å¯†ç è¿›è¡Œå‡çº§çš„æ–¹æ³•</li></ul><h4 id="PasswordEncoderFactoriesæºç "><a href="#PasswordEncoderFactoriesæºç " class="headerlink" title="PasswordEncoderFactoriesæºç "></a>PasswordEncoderFactoriesæºç </h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> PasswordEncoder <span class="title function_">createDelegatingPasswordEncoder</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="type">String</span> <span class="variable">encodingId</span> <span class="operator">=</span> <span class="string">&quot;bcrypt&quot;</span>;</span><br><span class="line">Map&lt;String, PasswordEncoder&gt; encoders = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">encoders.put(encodingId, <span class="keyword">new</span> <span class="title class_">BCryptPasswordEncoder</span>());</span><br><span class="line">encoders.put(<span class="string">&quot;ldap&quot;</span>, <span class="keyword">new</span> <span class="title class_">org</span>.springframework.security.crypto.password.LdapShaPasswordEncoder());</span><br><span class="line">encoders.put(<span class="string">&quot;MD4&quot;</span>, <span class="keyword">new</span> <span class="title class_">org</span>.springframework.security.crypto.password.Md4PasswordEncoder());</span><br><span class="line">encoders.put(<span class="string">&quot;MD5&quot;</span>, <span class="keyword">new</span> <span class="title class_">org</span>.springframework.security.crypto.password.MessageDigestPasswordEncoder(<span class="string">&quot;MD5&quot;</span>));</span><br><span class="line">encoders.put(<span class="string">&quot;noop&quot;</span>, org.springframework.security.crypto.password.NoOpPasswordEncoder.getInstance());</span><br><span class="line">encoders.put(<span class="string">&quot;pbkdf2&quot;</span>, <span class="keyword">new</span> <span class="title class_">Pbkdf2PasswordEncoder</span>());</span><br><span class="line">encoders.put(<span class="string">&quot;scrypt&quot;</span>, <span class="keyword">new</span> <span class="title class_">SCryptPasswordEncoder</span>());</span><br><span class="line">encoders.put(<span class="string">&quot;SHA-1&quot;</span>, <span class="keyword">new</span> <span class="title class_">org</span>.springframework.security.crypto.password.MessageDigestPasswordEncoder(<span class="string">&quot;SHA-1&quot;</span>));</span><br><span class="line">encoders.put(<span class="string">&quot;SHA-256&quot;</span>,</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">org</span>.springframework.security.crypto.password.MessageDigestPasswordEncoder(<span class="string">&quot;SHA-256&quot;</span>));</span><br><span class="line">encoders.put(<span class="string">&quot;sha256&quot;</span>, <span class="keyword">new</span> <span class="title class_">org</span>.springframework.security.crypto.password.StandardPasswordEncoder());</span><br><span class="line">encoders.put(<span class="string">&quot;argon2&quot;</span>, <span class="keyword">new</span> <span class="title class_">Argon2PasswordEncoder</span>());</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">DelegatingPasswordEncoder</span>(encodingId, encoders);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å¦‚ä½•ä½¿ç”¨-PasswordEncoder"><a href="#å¦‚ä½•ä½¿ç”¨-PasswordEncoder" class="headerlink" title="å¦‚ä½•ä½¿ç”¨ PasswordEncoder"></a>å¦‚ä½•ä½¿ç”¨ PasswordEncoder</h2><ul><li>æŸ¥çœ‹WebSecurityConfigurerAdapterç±»ä¸­æºç </li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">LazyPasswordEncoder</span> <span class="keyword">implements</span> <span class="title class_">PasswordEncoder</span> &#123;</span><br><span class="line"><span class="keyword">private</span> ApplicationContext applicationContext;</span><br><span class="line"><span class="keyword">private</span> PasswordEncoder passwordEncoder;</span><br><span class="line">LazyPasswordEncoder(ApplicationContext applicationContext) &#123;</span><br><span class="line"><span class="built_in">this</span>.applicationContext = applicationContext;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">encode</span><span class="params">(CharSequence rawPassword)</span> &#123;</span><br><span class="line"><span class="keyword">return</span> getPasswordEncoder().encode(rawPassword);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">matches</span><span class="params">(CharSequence rawPassword, String encodedPassword)</span> &#123;</span><br><span class="line"><span class="keyword">return</span> getPasswordEncoder().matches(rawPassword, encodedPassword);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">upgradeEncoding</span><span class="params">(String encodedPassword)</span> &#123;</span><br><span class="line"><span class="keyword">return</span> getPasswordEncoder().upgradeEncoding(encodedPassword);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> PasswordEncoder <span class="title function_">getPasswordEncoder</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">this</span>.passwordEncoder != <span class="literal">null</span>) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="built_in">this</span>.passwordEncoder;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">PasswordEncoder</span> <span class="variable">passwordEncoder</span> <span class="operator">=</span> getBeanOrNull(PasswordEncoder.class);</span><br><span class="line"><span class="keyword">if</span> (passwordEncoder == <span class="literal">null</span>) &#123;</span><br><span class="line">passwordEncoder = PasswordEncoderFactories.createDelegatingPasswordEncoder();</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">this</span>.passwordEncoder = passwordEncoder;</span><br><span class="line"><span class="keyword">return</span> passwordEncoder;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> &lt;T&gt; T <span class="title function_">getBeanOrNull</span><span class="params">(Class&lt;T&gt; type)</span> &#123;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="built_in">this</span>.applicationContext.getBean(type);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">catch</span> (NoSuchBeanDefinitionException ex) &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="keyword">return</span> getPasswordEncoder().toString();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡æºç åˆ†æå¾—çŸ¥å¦‚æœåœ¨å·¥å‚ä¸­æŒ‡å®šäº†PasswordEncoderï¼Œå°±ä¼šä½¿ç”¨æŒ‡å®šPasswordEncoderï¼Œå¦åˆ™å°±ä¼šä½¿ç”¨é»˜è®¤DelegatingPasswordEncoderã€‚</p><h2 id="å¯†ç åŠ å¯†å®æˆ˜"><a href="#å¯†ç åŠ å¯†å®æˆ˜" class="headerlink" title="å¯†ç åŠ å¯†å®æˆ˜"></a>å¯†ç åŠ å¯†å®æˆ˜</h2><ul><li>æµ‹è¯•ç”Ÿæˆçš„å¯†ç </li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="comment">//1.BCryptPasswordEncoder</span></span><br><span class="line">  <span class="type">BCryptPasswordEncoder</span> <span class="variable">bCryptPasswordEncoder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BCryptPasswordEncoder</span>();</span><br><span class="line">  System.out.println(bCryptPasswordEncoder.encode(<span class="string">&quot;123&quot;</span>));</span><br><span class="line"></span><br><span class="line">  <span class="comment">//2.Pbkdf2PasswordEncoder</span></span><br><span class="line">  <span class="type">Pbkdf2PasswordEncoder</span> <span class="variable">pbkdf2PasswordEncoder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Pbkdf2PasswordEncoder</span>();</span><br><span class="line">  System.out.println(pbkdf2PasswordEncoder.encode(<span class="string">&quot;123&quot;</span>));</span><br><span class="line"></span><br><span class="line">  <span class="comment">//3.SCryptPasswordEncoder //éœ€è¦é¢å¤–å¼•å…¥ä¾èµ–</span></span><br><span class="line">  <span class="type">SCryptPasswordEncoder</span> <span class="variable">sCryptPasswordEncoder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SCryptPasswordEncoder</span>();</span><br><span class="line">  System.out.println(sCryptPasswordEncoder.encode(<span class="string">&quot;123&quot;</span>));</span><br><span class="line"></span><br><span class="line">  <span class="comment">//4.Argon2PasswordEncoder //éœ€è¦é¢å¤–å¼•å…¥ä¾èµ–</span></span><br><span class="line">  <span class="type">Argon2PasswordEncoder</span> <span class="variable">argon2PasswordEncoder</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Argon2PasswordEncoder</span>();</span><br><span class="line">  System.out.println(argon2PasswordEncoder.encode(<span class="string">&quot;123&quot;</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ä½¿ç”¨å›ºå®šå¯†ç åŠ å¯†æ–¹æ¡ˆ</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">     <span class="meta">@Bean</span></span><br><span class="line">     <span class="keyword">public</span> PasswordEncoder <span class="title function_">BcryptPasswordEncoder</span><span class="params">()</span> &#123;</span><br><span class="line">         <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BCryptPasswordEncoder</span>();</span><br><span class="line">     &#125;</span><br><span class="line">   <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> UserDetailsService <span class="title function_">userDetailsService</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">InMemoryUserDetailsManager</span> <span class="variable">inMemoryUserDetailsManager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InMemoryUserDetailsManager</span>();</span><br><span class="line">        inMemoryUserDetailsManager.createUser(User.withUsername(<span class="string">&quot;root&quot;</span>).password(<span class="string">&quot;$2a$10$WGFkRsZC0kzafTKOPcWONeLvNvg2jqd3U09qd5gjJGSHE5b0yoy6a&quot;</span>).roles(<span class="string">&quot;xxx&quot;</span>).build());</span><br><span class="line">        <span class="keyword">return</span> inMemoryUserDetailsManager;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ä½¿ç”¨çµæ´»å¯†ç åŠ å¯†æ–¹æ¡ˆ æ¨è</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">   <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> UserDetailsService <span class="title function_">userDetailsService</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">InMemoryUserDetailsManager</span> <span class="variable">inMemoryUserDetailsManager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InMemoryUserDetailsManager</span>();</span><br><span class="line">        inMemoryUserDetailsManager.createUser(User.withUsername(<span class="string">&quot;root&quot;</span>).password(<span class="string">&quot;&#123;bcrypt&#125;$2a$10$WGFkRsZC0kzafTKOPcWONeLvNvg2jqd3U09qd5gjJGSHE5b0yoy6a&quot;</span>).roles(<span class="string">&quot;xxx&quot;</span>).build());</span><br><span class="line">        <span class="keyword">return</span> inMemoryUserDetailsManager;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å¯†ç è‡ªåŠ¨å‡çº§"><a href="#å¯†ç è‡ªåŠ¨å‡çº§" class="headerlink" title="å¯†ç è‡ªåŠ¨å‡çº§"></a>å¯†ç è‡ªåŠ¨å‡çº§</h2><p>æ¨èä½¿ç”¨DelegatingPasswordEncoder çš„å¦å¤–ä¸€ä¸ªå¥½å¤„å°±æ˜¯è‡ªåŠ¨è¿›è¡Œå¯†ç åŠ å¯†æ–¹æ¡ˆçš„å‡çº§ï¼Œè¿™ä¸ªåŠŸèƒ½åœ¨æ•´åˆä¸€äº›è€çš„ç³»ç»Ÿæ—¶éå¸¸æœ‰ç”¨ã€‚</p><ul><li>å‡†å¤‡åº“è¡¨</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- ç”¨æˆ·è¡¨</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `<span class="keyword">user</span>`</span><br><span class="line">(</span><br><span class="line">    `id`                    <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">    `username`              <span class="type">varchar</span>(<span class="number">32</span>)  <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `password`              <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `enabled`               tinyint(<span class="number">1</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `accountNonExpired`     tinyint(<span class="number">1</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `accountNonLocked`      tinyint(<span class="number">1</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `credentialsNonExpired` tinyint(<span class="number">1</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">4</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br><span class="line"><span class="comment">-- è§’è‰²è¡¨</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `role`</span><br><span class="line">(</span><br><span class="line">    `id`      <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">    `name`    <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `name_zh` <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">4</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br><span class="line"><span class="comment">-- ç”¨æˆ·è§’è‰²å…³ç³»è¡¨</span></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `user_role`</span><br><span class="line">(</span><br><span class="line">    `id`  <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">    `uid` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    `rid` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">    <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">    KEY   `uid` (`uid`),</span><br><span class="line">    KEY   `rid` (`rid`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">5</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br></pre></td></tr></table></figure><ul><li>æ’å…¥æ•°æ®</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- æ’å…¥ç”¨æˆ·æ•°æ®</span></span><br><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line">  <span class="keyword">INSERT</span> <span class="keyword">INTO</span> `<span class="keyword">user</span>`</span><br><span class="line">  <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">&#x27;root&#x27;</span>, <span class="string">&#x27;&#123;noop&#125;123&#x27;</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">INSERT</span> <span class="keyword">INTO</span> `<span class="keyword">user</span>`</span><br><span class="line">  <span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="string">&#x27;admin&#x27;</span>, <span class="string">&#x27;&#123;noop&#125;123&#x27;</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">INSERT</span> <span class="keyword">INTO</span> `<span class="keyword">user</span>`</span><br><span class="line">  <span class="keyword">VALUES</span> (<span class="number">3</span>, <span class="string">&#x27;blr&#x27;</span>, <span class="string">&#x27;&#123;noop&#125;123&#x27;</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br><span class="line"><span class="comment">-- æ’å…¥è§’è‰²æ•°æ®</span></span><br><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line">  <span class="keyword">INSERT</span> <span class="keyword">INTO</span> `role`</span><br><span class="line">  <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">&#x27;ROLE_product&#x27;</span>, <span class="string">&#x27;å•†å“ç®¡ç†å‘˜&#x27;</span>);</span><br><span class="line">  <span class="keyword">INSERT</span> <span class="keyword">INTO</span> `role`</span><br><span class="line">  <span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="string">&#x27;ROLE_admin&#x27;</span>, <span class="string">&#x27;ç³»ç»Ÿç®¡ç†å‘˜&#x27;</span>);</span><br><span class="line">  <span class="keyword">INSERT</span> <span class="keyword">INTO</span> `role`</span><br><span class="line">  <span class="keyword">VALUES</span> (<span class="number">3</span>, <span class="string">&#x27;ROLE_user&#x27;</span>, <span class="string">&#x27;ç”¨æˆ·ç®¡ç†å‘˜&#x27;</span>);</span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br><span class="line"><span class="comment">-- æ’å…¥ç”¨æˆ·è§’è‰²æ•°æ®</span></span><br><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line">  <span class="keyword">INSERT</span> <span class="keyword">INTO</span> `user_role`</span><br><span class="line">  <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">INSERT</span> <span class="keyword">INTO</span> `user_role`</span><br><span class="line">  <span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line">  <span class="keyword">INSERT</span> <span class="keyword">INTO</span> `user_role`</span><br><span class="line">  <span class="keyword">VALUES</span> (<span class="number">3</span>, <span class="number">2</span>, <span class="number">2</span>);</span><br><span class="line">  <span class="keyword">INSERT</span> <span class="keyword">INTO</span> `user_role`</span><br><span class="line">  <span class="keyword">VALUES</span> (<span class="number">4</span>, <span class="number">3</span>, <span class="number">3</span>);</span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br></pre></td></tr></table></figure><ul><li>æ•´åˆ mybatis</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.38<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.8<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.datasource.type</span>=<span class="string">com.alibaba.druid.pool.DruidDataSource</span></span><br><span class="line"><span class="attr">spring.datasource.driver-class-name</span>=<span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line"><span class="attr">spring.datasource.url</span>=<span class="string">jdbc:mysql://localhost:3306/security?characterEncoding=UTF-8&amp;serverTimezone=UTC&amp;useSSL=false</span></span><br><span class="line"><span class="attr">spring.datasource.username</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">spring.datasource.password</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">mybatis.mapper-locations</span>=<span class="string">classpath:/mapper/*.xml</span></span><br><span class="line"><span class="attr">mybatis.type-aliases-package</span>=<span class="string">com.baizhi.entity</span></span><br><span class="line"><span class="attr">logging.level.com.baizhi.dao</span>=<span class="string">debug</span></span><br></pre></td></tr></table></figure><ul><li>ç¼–å†™å®ä½“ç±»</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> <span class="keyword">implements</span> <span class="title class_">UserDetails</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="keyword">private</span> Boolean enabled;</span><br><span class="line">    <span class="keyword">private</span> Boolean accountNonExpired;</span><br><span class="line">    <span class="keyword">private</span> Boolean accountNonLocked;</span><br><span class="line">    <span class="keyword">private</span> Boolean credentialsNonExpired;</span><br><span class="line">    <span class="keyword">private</span> List&lt;Role&gt; roles = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Collection&lt;? <span class="keyword">extends</span> <span class="title class_">GrantedAuthority</span>&gt; getAuthorities() &#123;</span><br><span class="line">        List&lt;SimpleGrantedAuthority&gt; authorities = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (Role role : roles) &#123;</span><br><span class="line">            authorities.add(<span class="keyword">new</span> <span class="title class_">SimpleGrantedAuthority</span>(role.getName()));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> authorities;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getPassword</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setPassword</span><span class="params">(String password)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.password = password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getUsername</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> username;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUsername</span><span class="params">(String username)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.username = username;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isAccountNonExpired</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> accountNonExpired;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAccountNonExpired</span><span class="params">(Boolean accountNonExpired)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.accountNonExpired = accountNonExpired;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isAccountNonLocked</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> accountNonLocked;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAccountNonLocked</span><span class="params">(Boolean accountNonLocked)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.accountNonLocked = accountNonLocked;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isCredentialsNonExpired</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> credentialsNonExpired;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCredentialsNonExpired</span><span class="params">(Boolean credentialsNonExpired)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.credentialsNonExpired = credentialsNonExpired;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isEnabled</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> enabled;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setEnabled</span><span class="params">(Boolean enabled)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.enabled = enabled;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setRoles</span><span class="params">(List&lt;Role&gt; roles)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.roles = roles;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">getId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setId</span><span class="params">(Integer id)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Role</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String nameZh;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">getId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setId</span><span class="params">(Integer id)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getNameZh</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> nameZh;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setNameZh</span><span class="params">(String nameZh)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.nameZh = nameZh;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>åˆ›å»ºdao</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserDao</span> &#123;</span><br><span class="line">    List&lt;Role&gt; <span class="title function_">getRolesByUid</span><span class="params">(Integer uid)</span>;</span><br><span class="line">    User <span class="title function_">loadUserByUsername</span><span class="params">(String username)</span>;</span><br><span class="line">  Integer <span class="title function_">updatePassword</span><span class="params">(<span class="meta">@Param(&quot;username&quot;)</span> String username,<span class="meta">@Param(&quot;password&quot;)</span> String password)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ç¼–å†™ mapper</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span></span></span><br><span class="line"><span class="meta">        <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.baizhi.dao.UserDao&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;loadUserByUsername&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;User&quot;</span>&gt;</span></span><br><span class="line">        select id,</span><br><span class="line">               username,</span><br><span class="line">               password,</span><br><span class="line">               enabled,</span><br><span class="line">               accountNonExpired,</span><br><span class="line">               accountNonLocked,</span><br><span class="line">               credentialsNonExpired</span><br><span class="line">        from `user`</span><br><span class="line">        where username = #&#123;username&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;getRolesByUid&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;Role&quot;</span>&gt;</span></span><br><span class="line">        select r.id,</span><br><span class="line">               r.name,</span><br><span class="line">               r.name_zh nameZh</span><br><span class="line">        from `role` r,</span><br><span class="line">             `user_role` ur</span><br><span class="line">        where r.id = ur.rid</span><br><span class="line">          and ur.uid = #&#123;uid&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">  <span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">&quot;updatePassword&quot;</span>&gt;</span></span><br><span class="line">      update `user` set password=#&#123;password&#125;</span><br><span class="line">      where username=#&#123;username&#125;</span><br><span class="line">  <span class="tag">&lt;/<span class="name">update</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>ç¼–å†™service å®ç°</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyUserDetailService</span> <span class="keyword">implements</span> <span class="title class_">UserDetailsService</span>,UserDetailsPasswordService &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserDao userDao;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyUserDetailService</span><span class="params">(UserDao userDao)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.userDao = userDao;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> UserDetails <span class="title function_">loadUserByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException &#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userDao.loadUserByUsername(username);</span><br><span class="line">        <span class="keyword">if</span> (ObjectUtils.isEmpty(user)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;ç”¨æˆ·ä¸å­˜åœ¨!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        user.setRoles(userDao.getRolesByUid(user.getId()));</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> UserDetails <span class="title function_">updatePassword</span><span class="params">(UserDetails user, String newPassword)</span> &#123;</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">result</span> <span class="operator">=</span> userDao.updatePassword(user.getUsername(), newPassword);</span><br><span class="line">        <span class="keyword">if</span> (result == <span class="number">1</span>) &#123;</span><br><span class="line">            ((User) user).setPassword(newPassword);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>é…ç½®securityconfig</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MyUserDetailService myUserDetailService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SecurityConfig</span><span class="params">(MyUserDetailService myUserDetailService)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.myUserDetailService = myUserDetailService;</span><br><span class="line">    &#125;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">//æŸ¥è¯¢æ•°æ®åº“</span></span><br><span class="line">        auth.userDetailsService(myUserDetailService);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å¯åŠ¨é¡¹ç›®æµ‹è¯•</li></ul><h1 id="ç¬¬å…­ç« -RememberMe"><a href="#ç¬¬å…­ç« -RememberMe" class="headerlink" title="ç¬¬å…­ç«  RememberMe"></a>ç¬¬å…­ç«  RememberMe</h1><ul><li>ç®€ä»‹</li><li>åŸºæœ¬ä½¿ç”¨</li><li>åŸç†åˆ†æ</li><li>æŒä¹…åŒ–ä»¤ç‰Œ</li></ul><h2 id="ç®€ä»‹-2"><a href="#ç®€ä»‹-2" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p>RememberMe è¿™ä¸ªåŠŸèƒ½éå¸¸å¸¸è§ï¼Œä¸‹å›¾å°±æ˜¯QQ é‚®ç®±ç™»å½•æ—¶çš„â€œè®°ä½æˆ‘â€ é€‰é¡¹ã€‚æåˆ° RememberMeï¼Œä¸€äº›åˆå­¦è€…å¾€å¾€ä¼šæœ‰ä¸€äº›è¯¯è§£ï¼Œè®¤ä¸º RememberMe åŠŸèƒ½å°±æ˜¯æŠŠç”¨æˆ·å&#x2F;å¯†ç ç”¨ Cookie ä¿å­˜åœ¨æµè§ˆå™¨ä¸­ï¼Œä¸‹æ¬¡ç™»å½•æ—¶ä¸ç”¨å†æ¬¡è¾“å…¥ç”¨æˆ·å&#x2F;å¯†ç ã€‚è¿™ä¸ªç†è§£æ˜¾ç„¶æ˜¯ä¸å¯¹çš„ã€‚æˆ‘ä»¬è¿™é‡Œæ‰€è¯´çš„ RememberMe æ˜¯ä¸€ç§æœåŠ¡å™¨ç«¯çš„è¡Œä¸ºã€‚ä¼ ç»Ÿçš„ç™»å½•æ–¹å¼åŸºäº Sessionä¼šè¯ï¼Œä¸€æ—¦ç”¨æˆ·çš„ä¼šè¯è¶…æ—¶è¿‡æœŸï¼Œå°±è¦å†æ¬¡ç™»å½•ï¼Œè¿™æ ·å¤ªè¿‡äºçƒ¦çã€‚å¦‚æœèƒ½æœ‰ä¸€ç§æœºåˆ¶ï¼Œè®©ç”¨æˆ·ä¼šè¯è¿‡æœŸä¹‹åï¼Œè¿˜èƒ½ç»§ç»­ä¿æŒè®¤è¯çŠ¶æ€ï¼Œå°±ä¼šæ–¹ä¾¿å¾ˆå¤šï¼ŒRememberMe å°±æ˜¯ä¸ºäº†è§£å†³è¿™ä¸€éœ€æ±‚è€Œç”Ÿçš„ã€‚</p><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220308185102746.png" class=""><p>å…·ä½“çš„å®ç°æ€è·¯å°±æ˜¯é€šè¿‡ Cookie æ¥è®°å½•å½“å‰ç”¨æˆ·èº«ä»½ã€‚å½“ç”¨æˆ·ç™»å½•æˆåŠŸä¹‹åï¼Œä¼šé€šè¿‡ä¸€å®šç®—æ³•ï¼Œå°†ç”¨æˆ·ä¿¡æ¯ã€æ—¶é—´æˆ³ç­‰è¿›è¡ŒåŠ å¯†ï¼ŒåŠ å¯†å®Œæˆåï¼Œé€šè¿‡å“åº”å¤´å¸¦å›å‰ç«¯å­˜å‚¨åœ¨cookieä¸­ï¼Œå½“æµè§ˆå™¨ä¼šè¯è¿‡æœŸä¹‹åï¼Œå¦‚æœå†æ¬¡è®¿é—®è¯¥ç½‘ç«™ï¼Œä¼šè‡ªåŠ¨å°† Cookie ä¸­çš„ä¿¡æ¯å‘é€ç»™æœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨å¯¹ Cookieä¸­çš„ä¿¡æ¯è¿›è¡Œæ ¡éªŒåˆ†æï¼Œè¿›è€Œç¡®å®šå‡ºç”¨æˆ·çš„èº«ä»½ï¼ŒCookieä¸­æ‰€ä¿å­˜çš„ç”¨æˆ·ä¿¡æ¯ä¹Ÿæ˜¯æœ‰æ—¶æ•ˆçš„ï¼Œä¾‹å¦‚ä¸‰å¤©ã€ä¸€å‘¨ç­‰ã€‚</p><h2 id="åŸºæœ¬ä½¿ç”¨"><a href="#åŸºæœ¬ä½¿ç”¨" class="headerlink" title="åŸºæœ¬ä½¿ç”¨"></a>åŸºæœ¬ä½¿ç”¨</h2><h3 id="å¼€å¯è®°ä½æˆ‘"><a href="#å¼€å¯è®°ä½æˆ‘" class="headerlink" title="å¼€å¯è®°ä½æˆ‘"></a>å¼€å¯è®°ä½æˆ‘</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http.authorizeRequests()</span><br><span class="line">                .mvcMatchers(<span class="string">&quot;/login.html&quot;</span>).permitAll()</span><br><span class="line">                .anyRequest().authenticated()</span><br><span class="line">                .and()</span><br><span class="line">                .formLogin()</span><br><span class="line">                <span class="comment">//...</span></span><br><span class="line">                .and()</span><br><span class="line">                .rememberMe() <span class="comment">//å¼€å¯è®°ä½æˆ‘åŠŸèƒ½</span></span><br><span class="line">                .and()</span><br><span class="line">                .csrf().disable();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ä½¿ç”¨è®°ä½æˆ‘"><a href="#ä½¿ç”¨è®°ä½æˆ‘" class="headerlink" title="ä½¿ç”¨è®°ä½æˆ‘"></a>ä½¿ç”¨è®°ä½æˆ‘</h3><p>å¯ä»¥çœ‹åˆ°ä¸€æ—¦æ‰“å¼€äº†è®°ä½æˆ‘åŠŸèƒ½ï¼Œç™»å½•é¡µé¢ä¸­ä¼šå¤šå‡ºä¸€ä¸ª RememberMe é€‰é¡¹ã€‚</p><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220308190409305.png" class=""><h3 id="æµ‹è¯•è®°ä½æˆ‘"><a href="#æµ‹è¯•è®°ä½æˆ‘" class="headerlink" title="æµ‹è¯•è®°ä½æˆ‘"></a>æµ‹è¯•è®°ä½æˆ‘</h3><p>ç™»å½•æ—¶å‹¾é€‰ RememberMe é€‰é¡¹ï¼Œç„¶åé‡å¯æœåŠ¡ç«¯ä¹‹åï¼Œåœ¨æµ‹è¯•æ¥å£æ˜¯å¦èƒ½å…ç™»å½•è®¿é—®ã€‚</p><h2 id="åŸç†åˆ†æ"><a href="#åŸç†åˆ†æ" class="headerlink" title="åŸç†åˆ†æ"></a>åŸç†åˆ†æ</h2><h3 id="RememberMeAuthenticationFilter"><a href="#RememberMeAuthenticationFilter" class="headerlink" title="RememberMeAuthenticationFilter"></a>RememberMeAuthenticationFilter</h3><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220317194843649.png" class=""><p>ä»ä¸Šå›¾ä¸­ï¼Œå½“åœ¨SecurityConfigé…ç½®ä¸­å¼€å¯äº†â€è®°ä½æˆ‘â€åŠŸèƒ½ä¹‹å,åœ¨è¿›è¡Œè®¤è¯æ—¶å¦‚æœå‹¾é€‰äº†â€è®°ä½æˆ‘â€é€‰é¡¹ï¼Œæ­¤æ—¶æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°ï¼Œåˆ†ææ•´ä¸ªç™»å½•è¿‡ç¨‹ã€‚é¦–å…ˆå½“æˆ‘ä»¬ç™»å½•æ—¶ï¼Œåœ¨ç™»å½•è¯·æ±‚ä¸­å¤šäº†ä¸€ä¸ª RememberMe çš„å‚æ•°ã€‚</p><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220308191736005.png" class=""><p>å¾ˆæ˜¾ç„¶ï¼Œè¿™ä¸ªå‚æ•°å°±æ˜¯å‘Šè¯‰æœåŠ¡å™¨åº”è¯¥å¼€å¯ RememberMeåŠŸèƒ½çš„ã€‚å¦‚æœè‡ªå®šä¹‰ç™»å½•é¡µé¢å¼€å¯ RememberMe åŠŸèƒ½åº”è¯¥å¤šåŠ å…¥ä¸€ä¸ªä¸€æ ·çš„è¯·æ±‚å‚æ•°å°±å¯ä»¥å•¦ã€‚è¯¥è¯·æ±‚ä¼šè¢« <code>RememberMeAuthenticationFilter</code>è¿›è¡Œæ‹¦æˆªç„¶åè‡ªåŠ¨ç™»å½•å…·ä½“å‚è§æºç :</p><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220317195930708.png" class=""><ul><li><p>(1ï¼‰è¯·æ±‚åˆ°è¾¾è¿‡æ»¤å™¨ä¹‹åï¼Œé¦–å…ˆåˆ¤æ–­ SecurityContextHolder ä¸­æ˜¯å¦æœ‰å€¼ï¼Œæ²¡å€¼çš„è¯è¡¨ç¤ºç”¨æˆ·å°šæœªç™»å½•ï¼Œæ­¤æ—¶è°ƒç”¨ autoLogin æ–¹æ³•è¿›è¡Œè‡ªåŠ¨ç™»å½•ã€‚</p></li><li><p>(2ï¼‰å½“è‡ªåŠ¨ç™»å½•æˆåŠŸåè¿”å›çš„rememberMeAuth ä¸ä¸ºnull æ—¶ï¼Œè¡¨ç¤ºè‡ªåŠ¨ç™»å½•æˆåŠŸï¼Œæ­¤æ—¶è°ƒç”¨ authenticate æ–¹æ³•å¯¹ key è¿›è¡Œæ ¡éªŒï¼Œå¹¶ä¸”å°†ç™»å½•æˆåŠŸçš„ç”¨æˆ·ä¿¡æ¯ä¿å­˜åˆ° SecurityContextHolder å¯¹è±¡ä¸­ï¼Œç„¶åè°ƒç”¨ç™»å½•æˆåŠŸå›è°ƒï¼Œå¹¶å‘å¸ƒç™»å½•æˆåŠŸäº‹ä»¶ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œç™»å½•æˆåŠŸçš„å›è°ƒå¹¶ä¸åŒ…å« RememberMeServices ä¸­çš„ 1oginSuccess æ–¹æ³•ã€‚</p></li><li><p>(3ï¼‰å¦‚æœè‡ªåŠ¨ç™»å½•å¤±è´¥ï¼Œåˆ™è°ƒç”¨ remenberMeServices.loginFailæ–¹æ³•å¤„ç†ç™»å½•å¤±è´¥å›è°ƒã€‚onUnsuccessfulAuthentication å’Œ onSuccessfulAuthentication éƒ½æ˜¯è¯¥è¿‡æ»¤å™¨ä¸­å®šä¹‰çš„ç©ºæ–¹æ³•ï¼Œå¹¶æ²¡æœ‰ä»»ä½•å®ç°è¿™å°±æ˜¯ RememberMeAuthenticationFilter è¿‡æ»¤å™¨æ‰€åšçš„äº‹æƒ…ï¼ŒæˆåŠŸå°† RememberMeServicesçš„æœåŠ¡é›†æˆè¿›æ¥ã€‚</p></li></ul><h3 id="RememberMeServices"><a href="#RememberMeServices" class="headerlink" title="RememberMeServices"></a>RememberMeServices</h3><p>è¿™é‡Œä¸€å…±å®šä¹‰äº†ä¸‰ä¸ªæ–¹æ³•ï¼š</p><ol><li>autoLogin æ–¹æ³•å¯ä»¥ä»è¯·æ±‚ä¸­æå–å‡ºéœ€è¦çš„å‚æ•°ï¼Œå®Œæˆè‡ªåŠ¨ç™»å½•åŠŸèƒ½ã€‚</li><li>loginFail æ–¹æ³•æ˜¯è‡ªåŠ¨ç™»å½•å¤±è´¥çš„å›è°ƒã€‚</li><li>1oginSuccess æ–¹æ³•æ˜¯è‡ªåŠ¨ç™»å½•æˆåŠŸçš„å›è°ƒã€‚</li></ol><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220317200522015.png" class=""><h3 id="TokenBasedRememberMeServices"><a href="#TokenBasedRememberMeServices" class="headerlink" title="TokenBasedRememberMeServices"></a>TokenBasedRememberMeServices</h3><p>åœ¨å¼€å¯è®°ä½æˆ‘åå¦‚æœæ²¡æœ‰åŠ å…¥é¢å¤–é…ç½®é»˜è®¤å®ç°å°±æ˜¯ç”±TokenBasedRememberMeServicesè¿›è¡Œçš„å®ç°ã€‚æŸ¥çœ‹è¿™ä¸ªç±»æºç ä¸­ processAutoLoginCookie æ–¹æ³•å®ç°:</p><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220317201055784.png" class=""><p>processAutoLoginCookie æ–¹æ³•ä¸»è¦ç”¨æ¥éªŒè¯ Cookie ä¸­çš„ä»¤ç‰Œä¿¡æ¯æ˜¯å¦åˆæ³•ï¼š</p><ol><li><p>é¦–å…ˆåˆ¤æ–­ cookieTokens é•¿åº¦æ˜¯å¦ä¸ºäº†ï¼Œä¸ä¸ºäº†è¯´æ˜æ ¼å¼ä¸å¯¹ï¼Œåˆ™ç›´æ¥æŠ›å‡ºå¼‚å¸¸ã€‚</p></li><li><p>ä»cookieTokens æ•°ç»„ä¸­æå–å‡ºç¬¬ 1é¡¹ï¼Œä¹Ÿå°±æ˜¯è¿‡æœŸæ—¶é—´ï¼Œåˆ¤æ–­ä»¤ç‰Œæ˜¯å¦è¿‡æœŸï¼Œå¦‚æœå·±ç»è¿‡æœŸï¼Œåˆ™æ‹‹å‡ºå¼‚å¸¸ã€‚</p></li><li><p>æ ¹æ®ç”¨æˆ·å ï¼ˆcookieTokens æ•°ç»„çš„ç¬¬ã€‚é¡¹ï¼‰æŸ¥è¯¢å‡ºå½“å‰ç”¨æˆ·å¯¹è±¡ã€‚</p></li><li><p>è°ƒç”¨ makeTokenSignature æ–¹æ³•ç”Ÿæˆä¸€ä¸ªç­¾åï¼Œç­¾åçš„ç”Ÿæˆè¿‡ç¨‹å¦‚ä¸‹ï¼šé¦–å…ˆå°†ç”¨æˆ·åã€ä»¤ç‰Œè¿‡æœŸæ—¶é—´ã€ç”¨æˆ·å¯†ç ä»¥åŠ key ç»„æˆä¸€ä¸ªå®‡ç¬¦ä¸²ï¼Œä¸­é—´ç”¨â€œï¼šâ€éš”å¼€ï¼Œç„¶åé€šè¿‡ MD5 æ¶ˆæ¯æ‘˜è¦ç®—æ³•å¯¹è¯¥å®‡ç¬¦ä¸²è¿›è¡ŒåŠ å¯†ï¼Œå¹¶å°†åŠ å¯†ç»“æœè½¬ä¸ºä¸€ä¸ªå­—ç¬¦ä¸²è¿”å›ã€‚</p></li><li><p>åˆ¤æ–­ç¬¬4 æ­¥ç”Ÿæˆçš„ç­¾åå’Œé€šè¿‡ Cookie ä¼ æ¥çš„ç­¾åæ˜¯å¦ç›¸ç­‰ï¼ˆå³ cookieTokens æ•°ç»„<br>çš„ç¬¬2é¡¹ï¼‰ï¼Œå¦‚æœç›¸ç­‰ï¼Œè¡¨ç¤ºä»¤ç‰Œåˆæ³•ï¼Œåˆ™ç›´æ¥è¿”å›ç”¨æˆ·å¯¹è±¡ï¼Œå¦åˆ™æ‹‹å‡ºå¼‚å¸¸ã€‚</p></li></ol><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220318142054096.png" class=""><ol><li><p>åœ¨è¿™ä¸ªå›è°ƒä¸­ï¼Œé¦–å…ˆè·å–ç”¨æˆ·ç»å’Œå¯†ç ä¿¡æ¯ï¼Œå¦‚æœç”¨æˆ·å¯†ç åœ¨ç”¨æˆ·ç™»å½•æˆåŠŸåä»successfulAuthenticationå¯¹è±¡ä¸­æ“¦é™¤ï¼Œåˆ™ä»æ•°æ®åº“ä¸­é‡æ–°åŠ è½½å‡ºç”¨æˆ·å¯†ç ã€‚</p></li><li><p>è®¡ç®—å‡ºä»¤ç‰Œçš„è¿‡æœŸæ—¶é—´ï¼Œä»¤ç‰Œé»˜è®¤æœ‰æ•ˆæœŸæ˜¯ä¸¤å‘¨ã€‚</p></li><li><p>æ ¹æ®ä»¤ç‰Œçš„è¿‡æœŸæ—¶é—´ã€ç”¨æˆ·åä»¥åŠç”¨æˆ·å¯†ç ï¼Œè®¡ç®—å‡ºä¸€ä¸ªç­¾åã€‚</p></li><li><p>è°ƒç”¨ setCookie æ–¹æ³•è®¾ç½® Cookieï¼Œ ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæ•°ç»„ä¸­ä¸€å…±åŒ…å«ä¸‰é¡¹ã€‚ç”¨æˆ·åã€è¿‡æœŸæ—¶é—´ä»¥åŠç­¾åï¼Œåœ¨setCookie æ–¹æ³•ä¸­ä¼šå°†æ•°ç»„è½¬ä¸ºå­—ç¬¦ä¸²ï¼Œå¹¶è¿›è¡Œ Base64ç¼–ç åå“åº”ç»™å‰ç«¯ã€‚</p></li></ol><h3 id="æ€»ç»“-1"><a href="#æ€»ç»“-1" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>å½“ç”¨æˆ·é€šè¿‡ç”¨æˆ·å&#x2F;å¯†ç çš„å½¢å¼ç™»å½•æˆåŠŸåï¼Œç³»ç»Ÿä¼šæ ¹æ®ç”¨æˆ·çš„ç”¨æˆ·åã€å¯†ç ä»¥åŠä»¤ç‰Œçš„è¿‡æœŸæ—¶é—´è®¡ç®—å‡ºä¸€ä¸ªç­¾åï¼Œè¿™ä¸ªç­¾åä½¿ç”¨ MD5 æ¶ˆæ¯æ‘˜è¦ç®—æ³•ç”Ÿæˆï¼Œæ˜¯ä¸å¯é€†çš„ã€‚ç„¶åå†å°†ç”¨æˆ·åã€ä»¤ç‰Œè¿‡æœŸæ—¶é—´ä»¥åŠç­¾åæ‹¼æ¥æˆä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œä¸­é—´ç”¨â€œ:â€ éš”å¼€ï¼Œå¯¹æ‹¼æ¥å¥½çš„å­—ç¬¦ä¸²è¿›è¡ŒBase64 ç¼–ç ï¼Œç„¶åå°†ç¼–ç åçš„ç»“æœè¿”å›åˆ°å‰ç«¯ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬åœ¨æµè§ˆå™¨ä¸­çœ‹åˆ°çš„ä»¤ç‰Œã€‚å½“ä¼šè¯è¿‡æœŸä¹‹åï¼Œè®¿é—®ç³»ç»Ÿèµ„æºæ—¶ä¼šè‡ªåŠ¨æºå¸¦ä¸ŠCookieä¸­çš„ä»¤ç‰Œï¼ŒæœåŠ¡ç«¯æ‹¿åˆ° Cookieä¸­çš„ä»¤ç‰Œåï¼Œå…ˆè¿›è¡Œ Bae64è§£ç ï¼Œè§£ç ååˆ†åˆ«æå–å‡ºä»¤ç‰Œä¸­çš„ä¸‰é¡¹æ•°æ®ï¼šæ¥ç€æ ¹æ®ä»¤ç‰Œä¸­çš„æ•°æ®åˆ¤æ–­ä»¤ç‰Œæ˜¯å¦å·²ç»è¿‡æœŸï¼Œå¦‚æœæ²¡æœ‰è¿‡æœŸï¼Œåˆ™æ ¹æ®ä»¤ç‰Œä¸­çš„ç”¨æˆ·åæŸ¥è¯¢å‡ºç”¨æˆ·ä¿¡æ¯ï¼šæ¥ç€å†è®¡ç®—å‡ºä¸€ä¸ªç­¾åå’Œä»¤ç‰Œä¸­çš„ç­¾åè¿›è¡Œå¯¹æ¯”ï¼Œå¦‚æœä¸€è‡´ï¼Œè¡¨ç¤ºä¼šç‰Œæ˜¯åˆæ³•ä»¤ç‰Œï¼Œè‡ªåŠ¨ç™»å½•æˆåŠŸï¼Œå¦åˆ™è‡ªåŠ¨ç™»å½•å¤±è´¥ã€‚</p><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220308192413735.png" class=""><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220319124115432.png" class=""><h2 id="å†…å­˜ä»¤ç‰Œ"><a href="#å†…å­˜ä»¤ç‰Œ" class="headerlink" title="å†…å­˜ä»¤ç‰Œ"></a>å†…å­˜ä»¤ç‰Œ</h2><h3 id="PersistentTokenBasedRememberMeServices"><a href="#PersistentTokenBasedRememberMeServices" class="headerlink" title="PersistentTokenBasedRememberMeServices"></a>PersistentTokenBasedRememberMeServices</h3><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220319104657210.png" class=""><ol><li>ä¸åŒäº TokonBasedRemornberMeServices ä¸­çš„ processAutologinCookie æ–¹æ³•ï¼Œè¿™é‡ŒcookieTokens æ•°ç»„çš„é•¿åº¦ä¸º2ï¼Œç¬¬ä¸€é¡¹æ˜¯seriesï¼Œç¬¬äºŒé¡¹æ˜¯ tokenã€‚</li><li>ä»cookieTokensæ•°ç»„ä¸­åˆ†åˆ°æå–å‡º series å’Œ tokenï¼ ç„¶åæ ¹æ® series å»å†…å­˜ä¸­æŸ¥è¯¢å‡ºä¸€ä¸ª PersistentRememberMeTokenå¯¹è±¡ã€‚å¦‚æœæŸ¥è¯¢å‡ºæ¥çš„å¯¹è±¡ä¸ºnullï¼Œè¡¨ç¤ºå†…å­˜ä¸­å¹¶æ²¡æœ‰serieså¯¹åº”çš„å€¼ï¼Œæœ¬æ¬¡è‡ªåŠ¨ç™»å½•å¤±è´¥ã€‚å¦‚æœæŸ¥è¯¢å‡ºæ¥çš„ token å’Œä» cookieTokens ä¸­è§£æå‡ºæ¥çš„tokenä¸ç›¸åŒï¼Œè¯´æ˜è‡ªåŠ¨ç™»å½•ä¼šç‰Œå·²ç»æ³„æ¼ï¼ˆæ¶æ„ç”¨æˆ·åˆ©ç”¨ä»¤ç‰Œç™»å½•åï¼Œå†…å­˜ä¸­çš„tokenå˜äº†)ï¼Œæ­¤æ—¶ç§»é™¤å½“å‰ç”¨æˆ·çš„æ‰€æœ‰è‡ªåŠ¨ç™»å½•è®°å½•å¹¶æŠ›å‡ºå¼‚å¸¸ã€‚</li><li>æ ¹æ®æ•°æ®åº“ä¸­æŸ¥è¯¢å‡ºæ¥çš„ç»“æœåˆ¤æ–­ä»¤ç‰Œæ˜¯å¦è¿‡æœŸï¼Œå¦‚æœè¿‡æœŸå°±æŠ›å‡ºå¼‚å¸¸ã€‚</li><li>ç”Ÿæˆä¸€ä¸ªæ–°çš„ PersistentRememberMeToken å¯¹è±¡ï¼Œç”¨æˆ·åå’Œseries ä¸å˜ï¼Œtoken é‡æ–°<br>ç”Ÿæˆï¼Œdate ä¹Ÿä½¿ç”¨å½“å‰æ—¶é—´ã€‚newToken ç”Ÿæˆåï¼Œæ ¹æ® series å»ä¿®æ”¹å†…å­˜ä¸­çš„ token å’Œ date(å³æ¯æ¬¡è‡ªåŠ¨ç™»å½•åéƒ½ä¼šäº§ç”Ÿæ–°çš„ token å’Œ dateï¼‰</li><li>è°ƒç”¨ addCookie æ–¹æ³•æ·»åŠ  Cookieï¼Œ åœ¨addCookie æ–¹æ³•ä¸­ï¼Œä¼šè°ƒç”¨åˆ°æˆ‘ä»¬å‰é¢æ‰€è¯´çš„<br>setCookie æ–¹æ³•ï¼Œä½†æ˜¯è¦æ³¨æ„ç¬¬ä¸€ä¸ªæ•°ç»„å‚æ•°ä¸­åªæœ‰ä¸¤é¡¹ï¼šseries å’Œ tokenï¼ˆå³è¿”å›åˆ°å‰ç«¯çš„ä»¤ç‰Œæ˜¯é€šè¿‡å¯¹ series å’Œ token è¿›è¡Œ Base64 ç¼–ç å¾—åˆ°çš„ï¼‰</li><li>æœ€åå°†æ ¹æ®ç”¨æˆ·åæŸ¥è¯¢ç”¨æˆ·å¯¹è±¡å¹¶è¿”å›ã€‚</li></ol><h3 id="ä½¿ç”¨å†…å­˜ä¸­ä»¤ç‰Œå®ç°"><a href="#ä½¿ç”¨å†…å­˜ä¸­ä»¤ç‰Œå®ç°" class="headerlink" title="ä½¿ç”¨å†…å­˜ä¸­ä»¤ç‰Œå®ç°"></a>ä½¿ç”¨å†…å­˜ä¸­ä»¤ç‰Œå®ç°</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123; </span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http.authorizeRequests()</span><br><span class="line">                .anyRequest().authenticated()</span><br><span class="line">                .and()</span><br><span class="line">                .formLogin()</span><br><span class="line">                .and()</span><br><span class="line">                .rememberMe() <span class="comment">//å¼€å¯è®°ä½æˆ‘åŠŸèƒ½</span></span><br><span class="line">                .rememberMeServices(rememberMeServices())</span><br><span class="line">                .and()</span><br><span class="line">                .csrf().disable();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RememberMeServices <span class="title function_">rememberMeServices</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">PersistentTokenBasedRememberMeServices</span>(</span><br><span class="line">             <span class="string">&quot;key&quot;</span>,<span class="comment">//å‚æ•° 1: è‡ªå®šä¹‰ä¸€ä¸ªç”Ÿæˆä»¤ç‰Œ key é»˜è®¤ UUID  </span></span><br><span class="line">               userDetailsService(), <span class="comment">//å‚æ•° 2:è®¤è¯æ•°æ®æº  </span></span><br><span class="line">               <span class="keyword">new</span> <span class="title class_">InMemoryTokenRepositoryImpl</span>());<span class="comment">//å‚æ•° 3:ä»¤ç‰Œå­˜å‚¨æ–¹å¼</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æŒä¹…åŒ–ä»¤ç‰Œ"><a href="#æŒä¹…åŒ–ä»¤ç‰Œ" class="headerlink" title="æŒä¹…åŒ–ä»¤ç‰Œ"></a>æŒä¹…åŒ–ä»¤ç‰Œ</h2><h3 id="å¼•å…¥ä¾èµ–"><a href="#å¼•å…¥ä¾èµ–" class="headerlink" title="å¼•å…¥ä¾èµ–"></a>å¼•å…¥ä¾èµ–</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.8<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.38<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="é…ç½®æ•°æ®æº"><a href="#é…ç½®æ•°æ®æº" class="headerlink" title="é…ç½®æ•°æ®æº"></a>é…ç½®æ•°æ®æº</h3><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.thymeleaf.cache</span>=<span class="string">false</span></span><br><span class="line"><span class="attr">spring.datasource.type</span>=<span class="string">com.alibaba.druid.pool.DruidDataSource</span></span><br><span class="line"><span class="attr">spring.datasource.driver-class-name</span>=<span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line"><span class="attr">spring.datasource.url</span>=<span class="string">jdbc:mysql://localhost:3306/security?characterEncoding=UTF-8</span></span><br><span class="line"><span class="attr">spring.datasource.username</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">spring.datasource.password</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">mybatis.mapper-locations</span>=<span class="string">classpath:mapper/*.xml</span></span><br><span class="line"><span class="attr">mybatis.type-aliases-package</span>=<span class="string">com.entity</span></span><br></pre></td></tr></table></figure><h3 id="é…ç½®æŒä¹…åŒ–ä»¤ç‰Œ"><a href="#é…ç½®æŒä¹…åŒ–ä»¤ç‰Œ" class="headerlink" title="é…ç½®æŒä¹…åŒ–ä»¤ç‰Œ"></a>é…ç½®æŒä¹…åŒ–ä»¤ç‰Œ</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DataSource dataSource;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> PersistentTokenRepository <span class="title function_">persistentTokenRepository</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="type">JdbcTokenRepositoryImpl</span> <span class="variable">jdbcTokenRepository</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JdbcTokenRepositoryImpl</span>();</span><br><span class="line">        jdbcTokenRepository.setCreateTableOnStartup(<span class="literal">false</span>);<span class="comment">//åªéœ€è¦æ²¡æœ‰è¡¨æ—¶è®¾ç½®ä¸º true</span></span><br><span class="line">        jdbcTokenRepository.setDataSource(dataSource);</span><br><span class="line">        <span class="keyword">return</span> jdbcTokenRepository;</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="comment">//..</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        http.authorizeRequests()</span><br><span class="line">                .mvcMatchers(<span class="string">&quot;/login.html&quot;</span>).permitAll()</span><br><span class="line">                .anyRequest().authenticated()</span><br><span class="line"> <span class="comment">//...</span></span><br><span class="line">                .logout()</span><br><span class="line">                .and()</span><br><span class="line">                .rememberMe() <span class="comment">//å¼€å¯è®°ä½æˆ‘åŠŸèƒ½</span></span><br><span class="line">                .tokenRepository(persistentTokenRepository())</span><br><span class="line">                .and()</span><br><span class="line">                .csrf().disable();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å¯åŠ¨é¡¹ç›®å¹¶æŸ¥çœ‹æ•°æ®åº“"><a href="#å¯åŠ¨é¡¹ç›®å¹¶æŸ¥çœ‹æ•°æ®åº“" class="headerlink" title="å¯åŠ¨é¡¹ç›®å¹¶æŸ¥çœ‹æ•°æ®åº“"></a>å¯åŠ¨é¡¹ç›®å¹¶æŸ¥çœ‹æ•°æ®åº“</h3><p>**æ³¨æ„:å¯åŠ¨é¡¹ç›®ä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªè¡¨,ç”¨æ¥ä¿å­˜è®°ä½æˆ‘çš„ token ä¿¡æ¯ **</p><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220224142025628.png" class=""><h3 id="å†æ¬¡æµ‹è¯•è®°ä½æˆ‘"><a href="#å†æ¬¡æµ‹è¯•è®°ä½æˆ‘" class="headerlink" title="å†æ¬¡æµ‹è¯•è®°ä½æˆ‘"></a>å†æ¬¡æµ‹è¯•è®°ä½æˆ‘</h3><p>åœ¨æµ‹è¯•å‘ç°å³ä½¿æœåŠ¡å™¨é‡æ–°å¯åŠ¨ï¼Œä¾ç„¶å¯ä»¥è‡ªåŠ¨ç™»å½•ã€‚</p><h2 id="è‡ªå®šä¹‰è®°ä½æˆ‘"><a href="#è‡ªå®šä¹‰è®°ä½æˆ‘" class="headerlink" title="è‡ªå®šä¹‰è®°ä½æˆ‘"></a>è‡ªå®šä¹‰è®°ä½æˆ‘</h2><h3 id="æŸ¥çœ‹è®°ä½æˆ‘æºç "><a href="#æŸ¥çœ‹è®°ä½æˆ‘æºç " class="headerlink" title="æŸ¥çœ‹è®°ä½æˆ‘æºç "></a>æŸ¥çœ‹è®°ä½æˆ‘æºç </h3><p>AbstractUserDetailsAuthenticationProviderç±»ä¸­authenticateæ–¹æ³•åœ¨æœ€åè®¤è¯æˆåŠŸä¹‹åå®ç°äº†è®°ä½æˆ‘åŠŸèƒ½ï¼Œä½†æ˜¯æŸ¥çœ‹æºç å¾—çŸ¥å¦‚æœå¼€å¯è®°ä½æˆ‘,å¿…é¡»è¿›è¡Œç›¸å…³çš„è®¾ç½® </p><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20200814184455083.png" class=""><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20200814184605516.png" class=""><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20200814184651238.png" class=""><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20200814185157418.png" class=""><h3 id="ä¼ ç»Ÿ-web-å¼€å‘è®°ä½æˆ‘å®ç°"><a href="#ä¼ ç»Ÿ-web-å¼€å‘è®°ä½æˆ‘å®ç°" class="headerlink" title="ä¼ ç»Ÿ web å¼€å‘è®°ä½æˆ‘å®ç°"></a>ä¼ ç»Ÿ web å¼€å‘è®°ä½æˆ‘å®ç°</h3><p>é€šè¿‡æºç åˆ†æå¾—çŸ¥å¿…é¡»åœ¨è®¤è¯è¯·æ±‚ä¸­åŠ å…¥å‚æ•°remember-meå€¼ä¸ºâ€true,on,yes,1â€å…¶ä¸­ä»»æ„ä¸€ä¸ªæ‰å¯ä»¥å®Œæˆè®°ä½æˆ‘åŠŸèƒ½,è¿™ä¸ªæ—¶å€™ä¿®æ”¹è®¤è¯ç•Œé¢:</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>ç™»å½•<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>ç”¨æˆ·ç™»å½•<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span> <span class="attr">th:action</span>=<span class="string">&quot;@&#123;/doLogin&#125;&quot;</span>&gt;</span></span><br><span class="line">    ç”¨æˆ·å:<span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">&quot;uname&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span>/&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    å¯†ç :<span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">&quot;passwd&quot;</span> <span class="attr">type</span>=<span class="string">&quot;password&quot;</span>/&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">  è®°ä½æˆ‘: <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;checkbox&quot;</span> <span class="attr">name</span>=<span class="string">&quot;remember-me&quot;</span> <span class="attr">value</span>=<span class="string">&quot;on|yes|true|1&quot;</span>/&gt;</span><span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;ç™»å½•&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>é…ç½®ä¸­å¼€å¯è®°ä½æˆ‘</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http.authorizeRequests()</span><br><span class="line">                .....</span><br><span class="line">                .and()</span><br><span class="line">                .rememberMe() <span class="comment">//å¼€å¯è®°ä½æˆ‘</span></span><br><span class="line">                <span class="comment">//.alwaysRemember(true) æ€»æ˜¯è®°ä½æˆ‘</span></span><br><span class="line">                .and()</span><br><span class="line">                .csrf().disable();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å‰åç«¯åˆ†ç¦»å¼€å‘è®°ä½æˆ‘å®ç°"><a href="#å‰åç«¯åˆ†ç¦»å¼€å‘è®°ä½æˆ‘å®ç°" class="headerlink" title="å‰åç«¯åˆ†ç¦»å¼€å‘è®°ä½æˆ‘å®ç°"></a>å‰åç«¯åˆ†ç¦»å¼€å‘è®°ä½æˆ‘å®ç°</h3><h4 id="è‡ªå®šä¹‰è®¤è¯ç±»-LoginFilter"><a href="#è‡ªå®šä¹‰è®¤è¯ç±»-LoginFilter" class="headerlink" title="è‡ªå®šä¹‰è®¤è¯ç±» LoginFilter"></a>è‡ªå®šä¹‰è®¤è¯ç±» LoginFilter</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è‡ªå®šä¹‰å‰åç«¯åˆ†ç¦»è®¤è¯ Filter</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginFilter</span> <span class="keyword">extends</span> <span class="title class_">UsernamePasswordAuthenticationFilter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Authentication <span class="title function_">attemptAuthentication</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> AuthenticationException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;========================================&quot;</span>);</span><br><span class="line">        <span class="comment">//1.åˆ¤æ–­æ˜¯å¦æ˜¯ post æ–¹å¼è¯·æ±‚</span></span><br><span class="line">        <span class="keyword">if</span> (!request.getMethod().equals(<span class="string">&quot;POST&quot;</span>)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AuthenticationServiceException</span>(<span class="string">&quot;Authentication method not supported: &quot;</span> + request.getMethod());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//2.åˆ¤æ–­æ˜¯å¦æ˜¯ json æ ¼å¼è¯·æ±‚ç±»å‹</span></span><br><span class="line">        <span class="keyword">if</span> (request.getContentType().equalsIgnoreCase(MediaType.APPLICATION_JSON_VALUE)) &#123;</span><br><span class="line">            <span class="comment">//3.ä» json æ•°æ®ä¸­è·å–ç”¨æˆ·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç è¿›è¡Œè®¤è¯ &#123;&quot;uname&quot;:&quot;xxx&quot;,&quot;password&quot;:&quot;xxx&quot;,&quot;remember-me&quot;:true&#125;</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Map&lt;String, String&gt; userInfo = <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>().readValue(request.getInputStream(), Map.class);</span><br><span class="line">                <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> userInfo.get(getUsernameParameter());</span><br><span class="line">                <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> userInfo.get(getPasswordParameter());</span><br><span class="line">                <span class="type">String</span> <span class="variable">rememberValue</span> <span class="operator">=</span> userInfo.get(AbstractRememberMeServices.DEFAULT_PARAMETER);</span><br><span class="line">                <span class="keyword">if</span> (!ObjectUtils.isEmpty(rememberValue)) &#123;</span><br><span class="line">                    request.setAttribute(AbstractRememberMeServices.DEFAULT_PARAMETER, rememberValue);</span><br><span class="line">                &#125;</span><br><span class="line">                System.out.println(<span class="string">&quot;ç”¨æˆ·å: &quot;</span> + username + <span class="string">&quot; å¯†ç : &quot;</span> + password + <span class="string">&quot; æ˜¯å¦è®°ä½æˆ‘: &quot;</span> + rememberValue);</span><br><span class="line">                <span class="type">UsernamePasswordAuthenticationToken</span> <span class="variable">authRequest</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UsernamePasswordAuthenticationToken</span>(username, password);</span><br><span class="line">                setDetails(request, authRequest);</span><br><span class="line">                <span class="keyword">return</span> <span class="built_in">this</span>.getAuthenticationManager().authenticate(authRequest);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.attemptAuthentication(request, response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="è‡ªå®šä¹‰-RememberMeService"><a href="#è‡ªå®šä¹‰-RememberMeService" class="headerlink" title="è‡ªå®šä¹‰ RememberMeService"></a>è‡ªå®šä¹‰ RememberMeService</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * è‡ªå®šä¹‰è®°ä½æˆ‘ services å®ç°ç±»</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyPersistentTokenBasedRememberMeServices</span> <span class="keyword">extends</span> <span class="title class_">PersistentTokenBasedRememberMeServices</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyPersistentTokenBasedRememberMeServices</span><span class="params">(String key, UserDetailsService userDetailsService, PersistentTokenRepository tokenRepository)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(key, userDetailsService, tokenRepository);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è‡ªå®šä¹‰å‰åç«¯åˆ†ç¦»è·å– remember-me æ–¹å¼</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">rememberMeRequested</span><span class="params">(HttpServletRequest request, String parameter)</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">paramValue</span> <span class="operator">=</span> request.getAttribute(parameter).toString();</span><br><span class="line">        <span class="keyword">if</span> (paramValue != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (paramValue.equalsIgnoreCase(<span class="string">&quot;true&quot;</span>) || paramValue.equalsIgnoreCase(<span class="string">&quot;on&quot;</span>)</span><br><span class="line">                    || paramValue.equalsIgnoreCase(<span class="string">&quot;yes&quot;</span>) || paramValue.equals(<span class="string">&quot;1&quot;</span>)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="é…ç½®è®°ä½æˆ‘"><a href="#é…ç½®è®°ä½æˆ‘" class="headerlink" title="é…ç½®è®°ä½æˆ‘"></a>é…ç½®è®°ä½æˆ‘</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> UserDetailsService <span class="title function_">userDetailsService</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//.....</span></span><br><span class="line">        <span class="keyword">return</span> inMemoryUserDetailsManager;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        auth.userDetailsService(userDetailsService());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> AuthenticationManager <span class="title function_">authenticationManagerBean</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.authenticationManagerBean();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è‡ªå®šä¹‰ filter äº¤ç»™å·¥å‚ç®¡ç†</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> LoginFilter <span class="title function_">loginFilter</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">LoginFilter</span> <span class="variable">loginFilter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LoginFilter</span>();</span><br><span class="line">        loginFilter.setFilterProcessesUrl(<span class="string">&quot;/doLogin&quot;</span>);<span class="comment">//æŒ‡å®šè®¤è¯ url</span></span><br><span class="line">        loginFilter.setUsernameParameter(<span class="string">&quot;uname&quot;</span>);<span class="comment">//æŒ‡å®šæ¥æ”¶json ç”¨æˆ·å key</span></span><br><span class="line">        loginFilter.setPasswordParameter(<span class="string">&quot;passwd&quot;</span>);<span class="comment">//æŒ‡å®šæ¥æ”¶ json å¯†ç  key</span></span><br><span class="line">        loginFilter.setAuthenticationManager(authenticationManagerBean());</span><br><span class="line">        loginFilter.setRememberMeServices(rememberMeServices()); <span class="comment">//è®¾ç½®è®¤è¯æˆåŠŸæ—¶ä½¿ç”¨è‡ªå®šä¹‰rememberMeService</span></span><br><span class="line">        <span class="comment">//è®¤è¯æˆåŠŸå¤„ç†</span></span><br><span class="line">        loginFilter.setAuthenticationSuccessHandler((req, resp, authentication) -&gt; &#123;</span><br><span class="line">            Map&lt;String, Object&gt; result = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, Object&gt;();</span><br><span class="line">            result.put(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;ç™»å½•æˆåŠŸ&quot;</span>);</span><br><span class="line">            result.put(<span class="string">&quot;ç”¨æˆ·ä¿¡æ¯&quot;</span>, authentication.getPrincipal());</span><br><span class="line">            resp.setContentType(<span class="string">&quot;application/json;charset=UTF-8&quot;</span>);</span><br><span class="line">            resp.setStatus(HttpStatus.OK.value());</span><br><span class="line">            <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>().writeValueAsString(result);</span><br><span class="line">            resp.getWriter().println(s);</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">//è®¤è¯å¤±è´¥å¤„ç†</span></span><br><span class="line">        loginFilter.setAuthenticationFailureHandler((req, resp, ex) -&gt; &#123;</span><br><span class="line">            Map&lt;String, Object&gt; result = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, Object&gt;();</span><br><span class="line">            result.put(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;ç™»å½•å¤±è´¥: &quot;</span> + ex.getMessage());</span><br><span class="line">            resp.setStatus(HttpStatus.INTERNAL_SERVER_ERROR.value());</span><br><span class="line">            resp.setContentType(<span class="string">&quot;application/json;charset=UTF-8&quot;</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>().writeValueAsString(result);</span><br><span class="line">            resp.getWriter().println(s);</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> loginFilter;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http.authorizeHttpRequests()</span><br><span class="line">                .anyRequest().authenticated()<span class="comment">//æ‰€æœ‰è¯·æ±‚å¿…é¡»è®¤è¯</span></span><br><span class="line">                .and()</span><br><span class="line">                .formLogin()</span><br><span class="line">                .and()</span><br><span class="line">                .rememberMe() <span class="comment">//å¼€å¯è®°ä½æˆ‘åŠŸèƒ½  cookie è¿›è¡Œå®ç°  1.è®¤è¯æˆåŠŸä¿å­˜è®°ä½æˆ‘ cookie åˆ°å®¢æˆ·ç«¯   2.åªæœ‰ cookie å†™å…¥å®¢æˆ·ç«¯æˆåŠŸæ‰èƒ½å®ç°è‡ªåŠ¨ç™»å½•åŠŸèƒ½</span></span><br><span class="line">                .rememberMeServices(rememberMeServices())  <span class="comment">//è®¾ç½®è‡ªåŠ¨ç™»å½•ä½¿ç”¨å“ªä¸ª rememberMeServices</span></span><br><span class="line">                .and()</span><br><span class="line">                .exceptionHandling()</span><br><span class="line">                .authenticationEntryPoint((req, resp, ex) -&gt; &#123;</span><br><span class="line">                    resp.setContentType(MediaType.APPLICATION_JSON_UTF8_VALUE);</span><br><span class="line">                    resp.setStatus(HttpStatus.UNAUTHORIZED.value());</span><br><span class="line">                    resp.getWriter().println(<span class="string">&quot;è¯·è®¤è¯ä¹‹åå†å»å¤„ç†!&quot;</span>);</span><br><span class="line">                &#125;)</span><br><span class="line">                .and()</span><br><span class="line">                .logout()</span><br><span class="line">                .logoutRequestMatcher(<span class="keyword">new</span> <span class="title class_">OrRequestMatcher</span>(</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">AntPathRequestMatcher</span>(<span class="string">&quot;/logout&quot;</span>, HttpMethod.DELETE.name()),</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">AntPathRequestMatcher</span>(<span class="string">&quot;/logout&quot;</span>, HttpMethod.GET.name())</span><br><span class="line">                ))</span><br><span class="line">                .logoutSuccessHandler((req, resp, auth) -&gt; &#123;</span><br><span class="line">                    Map&lt;String, Object&gt; result = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, Object&gt;();</span><br><span class="line">                    result.put(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;æ³¨é”€æˆåŠŸ&quot;</span>);</span><br><span class="line">                    result.put(<span class="string">&quot;ç”¨æˆ·ä¿¡æ¯&quot;</span>, auth.getPrincipal());</span><br><span class="line">                    resp.setContentType(<span class="string">&quot;application/json;charset=UTF-8&quot;</span>);</span><br><span class="line">                    resp.setStatus(HttpStatus.OK.value());</span><br><span class="line">                    <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>().writeValueAsString(result);</span><br><span class="line">                    resp.getWriter().println(s);</span><br><span class="line">                &#125;)</span><br><span class="line">                .and()</span><br><span class="line">                .csrf().disable();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// at: ç”¨æ¥æŸä¸ª filter æ›¿æ¢è¿‡æ»¤å™¨é“¾ä¸­å“ªä¸ª filter</span></span><br><span class="line">        <span class="comment">// before: æ”¾åœ¨è¿‡æ»¤å™¨é“¾ä¸­å“ªä¸ª filter ä¹‹å‰</span></span><br><span class="line">        <span class="comment">// after: æ”¾åœ¨è¿‡æ»¤å™¨é“¾ä¸­é‚£ä¸ª filter ä¹‹å</span></span><br><span class="line">        http.addFilterAt(loginFilter(), UsernamePasswordAuthenticationFilter.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> RememberMeServices <span class="title function_">rememberMeServices</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MyPersistentTokenBasedRememberMeServices</span>(UUID.randomUUID().toString(), userDetailsService(), <span class="keyword">new</span> <span class="title class_">InMemoryTokenRepositoryImpl</span>());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><hr><h1 id="ç¬¬ä¸ƒç« -ä¼šè¯ç®¡ç†"><a href="#ç¬¬ä¸ƒç« -ä¼šè¯ç®¡ç†" class="headerlink" title="ç¬¬ä¸ƒç«  ä¼šè¯ç®¡ç†"></a>ç¬¬ä¸ƒç«  ä¼šè¯ç®¡ç†</h1><ul><li>ç®€ä»‹</li><li>ä¼šè¯å¹¶å‘ç®¡ç†</li><li>ä¼šè¯å…±äº«å®æˆ˜</li></ul><h2 id="ç®€ä»‹-3"><a href="#ç®€ä»‹-3" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p>å½“æµè§ˆå™¨è°ƒç”¨ç™»å½•æ¥å£ç™»å½•æˆåŠŸåï¼ŒæœåŠ¡ç«¯ä¼šå’Œæµè§ˆå™¨ä¹‹é—´å»ºç«‹ä¸€ä¸ªä¼šè¯ (Session) æµè§ˆå™¨åœ¨æ¯æ¬¡å‘é€è¯·æ±‚æ—¶éƒ½ä¼šæºå¸¦ä¸€ä¸ª Sessionldï¼ŒæœåŠ¡ç«¯åˆ™æ ¹æ®è¿™ä¸ª Sessionld æ¥åˆ¤æ–­ç”¨æˆ·èº«ä»½ã€‚å½“æµè§ˆå™¨å…³é—­åï¼ŒæœåŠ¡ç«¯çš„ Session å¹¶ä¸ä¼šè‡ªåŠ¨é”€æ¯ï¼Œéœ€è¦å¼€å‘è€…æ‰‹åŠ¨åœ¨æœåŠ¡ç«¯è°ƒç”¨ Sessioné”€æ¯æ–¹æ³•ï¼Œæˆ–è€…ç­‰ Session è¿‡æœŸæ—¶é—´åˆ°äº†è‡ªåŠ¨é”€æ¯ã€‚åœ¨Spring Security ä¸­ï¼Œä¸HttpSessionç›¸å…³çš„åŠŸèƒ½ç”± SessionManagementFiter å’ŒSessionAutheaticationStrateey æ¥å£æ¥å¤„ç†ï¼ŒSessionManagomentFilter è¿‡æ»¤å™¨å°† Session ç›¸å…³æ“ä½œå§”æ‰˜ç»™ SessionAuthenticationStrateey æ¥å£å»å®Œæˆã€‚</p><h2 id="ä¼šè¯å¹¶å‘ç®¡ç†"><a href="#ä¼šè¯å¹¶å‘ç®¡ç†" class="headerlink" title="ä¼šè¯å¹¶å‘ç®¡ç†"></a>ä¼šè¯å¹¶å‘ç®¡ç†</h2><h3 id="ç®€ä»‹-4"><a href="#ç®€ä»‹-4" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h3><p>ä¼šè¯å¹¶å‘ç®¡ç†å°±æ˜¯æŒ‡åœ¨å½“å‰ç³»ç»Ÿä¸­ï¼ŒåŒä¸€ä¸ªç”¨æˆ·å¯ä»¥åŒæ—¶åˆ›å»ºå¤šå°‘ä¸ªä¼šè¯ï¼Œå¦‚æœä¸€ä¸ªè®¾å¤‡å¯¹åº”ä¸€ä¸ªä¼šè¯ï¼Œé‚£ä¹ˆä¹Ÿå¯ä»¥ç®€å•ç†è§£ä¸ºåŒä¸€ä¸ªç”¨æˆ·å¯ä»¥åŒæ—¶åœ¨å¤šå°‘å°è®¾å¤‡ä¸Šè¿›è¡Œç™»å½•ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒåŒä¸€ç”¨æˆ·åœ¨å¤šå°‘å°è®¾å¤‡ä¸Šç™»å½•å¹¶æ²¡æœ‰é™åˆ¶ï¼Œä¸è¿‡å¼€å‘è€…å¯ä»¥åœ¨ Spring Security ä¸­å¯¹æ­¤è¿›è¡Œé…ç½®ã€‚</p><h3 id="å¼€å¯ä¼šè¯ç®¡ç†"><a href="#å¼€å¯ä¼šè¯ç®¡ç†" class="headerlink" title="å¼€å¯ä¼šè¯ç®¡ç†"></a>å¼€å¯ä¼šè¯ç®¡ç†</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//...</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http.authorizeRequests()</span><br><span class="line">                .anyRequest().authenticated()</span><br><span class="line">                .and()</span><br><span class="line">                .formLogin()</span><br><span class="line">                .and()</span><br><span class="line">                .rememberMe()</span><br><span class="line">                .and()</span><br><span class="line">                .csrf().disable()</span><br><span class="line">                .sessionManagement()  <span class="comment">//å¼€å¯ä¼šè¯ç®¡ç†</span></span><br><span class="line">                .maximumSessions(<span class="number">1</span>);  <span class="comment">//è®¾ç½®ä¼šè¯å¹¶å‘æ•°ä¸º 1</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> HttpSessionEventPublisher <span class="title function_">httpSessionEventPublisher</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HttpSessionEventPublisher</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>sessionManagement() ç”¨æ¥å¼€å¯ä¼šè¯ç®¡ç†ã€maximumSessions æŒ‡å®šä¼šè¯çš„å¹¶å‘æ•°ä¸º 1ã€‚</li><li>HttpSessionEventPublisher æä¾›ä¸€ä¸€ä¸ªHtp SessionEvenePubishor-å®ä¾‹ã€‚Spring Securityä¸­é€šè¿‡ä¸€ä¸ª Map é›†åˆæ¥é›†æŠ¤å½“å‰çš„ Http Session è®°å½•ï¼Œè¿›è€Œå®ç°ä¼šè¯çš„å¹¶å‘ç®¡ç†ã€‚å½“ç”¨æˆ·ç™»å½•æˆåŠŸæ—¶ï¼Œå°±å‘é›†åˆä¸­æ·»åŠ ä¸€æ¡Http Session è®°å½•ï¼›å½“ä¼šè¯é”€æ¯æ—¶ï¼Œå°±ä»é›†åˆä¸­ç§»é™¤ä¸€æ¡ Httpsession è®°å½•ã€‚HtpSesionEvenPublisher å®ç°äº† Fttp SessionListener æ¥å£ï¼Œå¯ä»¥ç›‘å¬åˆ° HtpSession çš„åˆ›å»ºå’Œé”€æ¯€äº‹ä»¶ï¼Œå¹¶å°† Fltp Session çš„åˆ›å»º&#x2F;é”€æ¯äº‹ä»¶å‘å¸ƒå‡ºå»ï¼Œè¿™æ ·ï¼Œå½“æœ‰ HttpSession é”€æ¯€æ—¶ï¼ŒSpring Security å°±å¯ä»¥æ„ŸçŸ¥åˆ°è¯¥äº‹ä»¶äº†ã€‚</li></ol><h3 id="æµ‹è¯•ä¼šè¯ç®¡ç†"><a href="#æµ‹è¯•ä¼šè¯ç®¡ç†" class="headerlink" title="æµ‹è¯•ä¼šè¯ç®¡ç†"></a>æµ‹è¯•ä¼šè¯ç®¡ç†</h3><p>é…ç½®å®Œæˆåï¼Œå¯åŠ¨é¡¹ç›®ã€‚è¿™æ¬¡æµ‹è¯•æˆ‘ä»¬éœ€è¦ä¸¤ä¸ªæµè§ˆå™¨ï¼Œå¦‚æœä½¿ç”¨äº† Chrome æµè§ˆå™¨ï¼Œå¯ä»¥ä½¿ç”¨ Chrome æµè§ˆå™¨ä¸­çš„å¤šç”¨æˆ·æ–¹å¼ï¼ˆç›¸å½“äºä¸¤ä¸ªæµè§ˆå™¨ï¼‰å…ˆåœ¨ç¬¬ä¸€ä¸ªæµè§ˆå™¨ä¸­è¾“å…¥ <a href="http://localhost:8080ï¼Œæ­¤æ—¶ä¼šè‡ªåŠ¨è·³è½¬åˆ°ç™»å½•é¡µé¢ï¼Œå®Œæˆç™»å½•æ“ä½œï¼Œå°±å¯ä»¥è®¿é—®åˆ°æ•°æ®äº†ï¼›æ¥ä¸‹æ¥åœ¨ç¬¬äºŒä¸ªæµè§ˆå™¨ä¸­ä¹Ÿè¾“å…¥">http://localhost:8080ï¼Œæ­¤æ—¶ä¼šè‡ªåŠ¨è·³è½¬åˆ°ç™»å½•é¡µé¢ï¼Œå®Œæˆç™»å½•æ“ä½œï¼Œå°±å¯ä»¥è®¿é—®åˆ°æ•°æ®äº†ï¼›æ¥ä¸‹æ¥åœ¨ç¬¬äºŒä¸ªæµè§ˆå™¨ä¸­ä¹Ÿè¾“å…¥</a> <a href="http://localhost:8080ï¼Œä¹Ÿéœ€è¦ç™»å½•ï¼Œ">http://localhost:8080ï¼Œä¹Ÿéœ€è¦ç™»å½•ï¼Œ</a><br>å®Œæˆç™»å½•æ“ä½œï¼›å½“ç¬¬äºŒä¸ªæµè§ˆå™¨ç™»å½•æˆåŠŸåï¼Œå†å›åˆ°ç¬¬ä¸€ä¸ªæµè§ˆå™¨ï¼Œåˆ·æ–°é¡µé¢ã€‚ç»“æœå‡ºç°ä¸‹å›¾ï¼š<img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220308195448860.png" class=""></p><h2 id="ä¼šè¯å¤±æ•ˆå¤„ç†"><a href="#ä¼šè¯å¤±æ•ˆå¤„ç†" class="headerlink" title="ä¼šè¯å¤±æ•ˆå¤„ç†"></a>ä¼šè¯å¤±æ•ˆå¤„ç†</h2><h3 id="ä¼ ç»Ÿ-web-å¼€å‘å¤„ç†"><a href="#ä¼ ç»Ÿ-web-å¼€å‘å¤„ç†" class="headerlink" title="ä¼ ç»Ÿ web å¼€å‘å¤„ç†"></a>ä¼ ç»Ÿ web å¼€å‘å¤„ç†</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">  http.authorizeRequests()</span><br><span class="line">    .anyRequest().authenticated()</span><br><span class="line">    .and()</span><br><span class="line">    ....</span><br><span class="line">    .sessionManagement()  <span class="comment">//å¼€å¯ä¼šè¯ç®¡ç†</span></span><br><span class="line">    .maximumSessions(<span class="number">1</span>)  <span class="comment">//å…è®¸åŒä¸€ä¸ªç”¨æˆ·åªå…è®¸åˆ›å»ºä¸€ä¸ªä¼šè¯</span></span><br><span class="line">    .expiredUrl(<span class="string">&quot;/login&quot;</span>);<span class="comment">//ä¼šè¯è¿‡æœŸå¤„ç†</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å‰åç«¯åˆ†ç¦»å¼€å‘å¤„ç†"><a href="#å‰åç«¯åˆ†ç¦»å¼€å‘å¤„ç†" class="headerlink" title="å‰åç«¯åˆ†ç¦»å¼€å‘å¤„ç†"></a>å‰åç«¯åˆ†ç¦»å¼€å‘å¤„ç†</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">  http.authorizeRequests()</span><br><span class="line">    .anyRequest().authenticated()</span><br><span class="line">    .....</span><br><span class="line">    .sessionManagement()  <span class="comment">//å¼€å¯ä¼šè¯ç®¡ç†</span></span><br><span class="line">    .maximumSessions(<span class="number">1</span>)  <span class="comment">//å…è®¸åŒä¸€ä¸ªç”¨æˆ·åªå…è®¸åˆ›å»ºä¸€ä¸ªä¼šè¯</span></span><br><span class="line">    <span class="comment">//.expiredUrl(&quot;/login&quot;)//ä¼šè¯è¿‡æœŸå¤„ç†  ä¼ ç»Ÿ web å¼€å‘</span></span><br><span class="line">    .expiredSessionStrategy(event -&gt; &#123;</span><br><span class="line">      <span class="type">HttpServletResponse</span> <span class="variable">response</span> <span class="operator">=</span> event.getResponse();</span><br><span class="line">      response.setContentType(<span class="string">&quot;application/json;charset=UTF-8&quot;</span>);</span><br><span class="line">      Map&lt;String, Object&gt; result = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">      result.put(<span class="string">&quot;status&quot;</span>, <span class="number">500</span>);</span><br><span class="line">      result.put(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;å½“å‰ä¼šè¯å·²ç»å¤±æ•ˆ,è¯·é‡æ–°ç™»å½•!&quot;</span>);</span><br><span class="line">      <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>().writeValueAsString(result);</span><br><span class="line">      response.setContentType(<span class="string">&quot;application/json;charset=UTF-8&quot;</span>);</span><br><span class="line">      response.getWriter().println(s);</span><br><span class="line">      response.flushBuffer();</span><br><span class="line">    &#125;);<span class="comment">//å‰åç«¯åˆ†ç¦»å¼€å‘å¤„ç†</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ç¦æ­¢å†æ¬¡ç™»å½•"><a href="#ç¦æ­¢å†æ¬¡ç™»å½•" class="headerlink" title="ç¦æ­¢å†æ¬¡ç™»å½•"></a>ç¦æ­¢å†æ¬¡ç™»å½•</h2><p>é»˜è®¤çš„æ•ˆæœæ˜¯ä¸€ç§è¢« â€œæŒ¤ä¸‹çº¿â€çš„æ•ˆæœï¼Œåé¢ç™»å½•çš„ç”¨æˆ·ä¼šæŠŠå‰é¢ç™»å½•çš„ç”¨æˆ· â€œæŒ¤ä¸‹çº¿â€ã€‚è¿˜æœ‰ä¸€ç§æ˜¯ç¦æ­¢åæ¥è€…ç™»å½•ï¼Œå³ä¸€æ—¦å½“å‰ç”¨æˆ·ç™»å½•æˆåŠŸï¼Œåæ¥è€…æ— æ³•å†æ¬¡ä½¿ç”¨ç›¸åŒçš„ç”¨æˆ·ç™»å½•ï¼Œç›´åˆ°å½“å‰ç”¨æˆ·ä¸»åŠ¨æ³¨é”€ç™»å½•ï¼Œé…ç½®å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">  http.authorizeRequests()</span><br><span class="line">    .anyRequest().authenticated()</span><br><span class="line">    .and()</span><br><span class="line">    ....</span><br><span class="line">    .sessionManagement()  <span class="comment">//å¼€å¯ä¼šè¯ç®¡ç†</span></span><br><span class="line">    .maximumSessions(<span class="number">1</span>)  <span class="comment">//å…è®¸åŒä¸€ä¸ªç”¨æˆ·åªå…è®¸åˆ›å»ºä¸€ä¸ªä¼šè¯</span></span><br><span class="line">    <span class="comment">//.expiredUrl(&quot;/login&quot;)//ä¼šè¯è¿‡æœŸå¤„ç†  ä¼ ç»Ÿ web å¼€å‘</span></span><br><span class="line">    .expiredSessionStrategy(event -&gt; &#123;</span><br><span class="line">      <span class="type">HttpServletResponse</span> <span class="variable">response</span> <span class="operator">=</span> event.getResponse();</span><br><span class="line">      response.setContentType(<span class="string">&quot;application/json;charset=UTF-8&quot;</span>);</span><br><span class="line">      Map&lt;String, Object&gt; result = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">      result.put(<span class="string">&quot;status&quot;</span>, <span class="number">500</span>);</span><br><span class="line">      result.put(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;å½“å‰ä¼šè¯å·²ç»å¤±æ•ˆ,è¯·é‡æ–°ç™»å½•!&quot;</span>);</span><br><span class="line">      <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>().writeValueAsString(result);</span><br><span class="line">      response.getWriter().println(s);</span><br><span class="line">      response.flushBuffer();</span><br><span class="line">    &#125;)<span class="comment">//å‰åç«¯åˆ†ç¦»å¼€å‘å¤„ç†</span></span><br><span class="line">    .maxSessionsPreventsLogin(<span class="literal">true</span>);<span class="comment">//ç™»å½•ä¹‹åç¦æ­¢å†æ¬¡ç™»å½•</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ä¼šè¯å…±äº«"><a href="#ä¼šè¯å…±äº«" class="headerlink" title="ä¼šè¯å…±äº«"></a>ä¼šè¯å…±äº«</h2><p>å‰é¢æ‰€è®²çš„ä¼šè¯ç®¡ç†éƒ½æ˜¯å•æœºä¸Šçš„ä¼šè¯ç®¡ç†ï¼Œå¦‚æœå½“å‰æ˜¯é›†ç¾¤ç¯å¢ƒï¼Œå‰é¢æ‰€è®²çš„ä¼šè¯ç®¡<br>ç†æ–¹æ¡ˆå°±ä¼šå¤±æ•ˆã€‚æ­¤æ—¶å¯ä»¥åˆ©ç”¨ spring-session ç»“åˆ redis å®ç° session å…±äº«ã€‚</p><h3 id="å®æˆ˜"><a href="#å®æˆ˜" class="headerlink" title="å®æˆ˜"></a>å®æˆ˜</h3><h6 id="å¼•å…¥ä¾èµ–-1"><a href="#å¼•å…¥ä¾èµ–-1" class="headerlink" title="å¼•å…¥ä¾èµ–"></a>å¼•å…¥ä¾èµ–</h6><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.session<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-session-data-redis<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h6 id="ç¼–å†™é…ç½®"><a href="#ç¼–å†™é…ç½®" class="headerlink" title="ç¼–å†™é…ç½®"></a>ç¼–å†™é…ç½®</h6><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.redis.host</span>=<span class="string">localhost</span></span><br><span class="line"><span class="attr">spring.redis.port</span>=<span class="string">6379</span></span><br></pre></td></tr></table></figure><h6 id="é…ç½®Security"><a href="#é…ç½®Security" class="headerlink" title="é…ç½®Security"></a>é…ç½®Security</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.blr.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.fasterxml.jackson.databind.ObjectMapper;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.User;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetailsService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.provisioning.InMemoryUserDetailsManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.session.FindByIndexNameSessionRepository;</span><br><span class="line"><span class="keyword">import</span> org.springframework.session.security.SpringSessionBackedSessionRegistry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> FindByIndexNameSessionRepository sessionRepository;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SecurityConfig</span><span class="params">(FindByIndexNameSessionRepository sessionRepository)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.sessionRepository = sessionRepository;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> UserDetailsService <span class="title function_">userDetailsService</span><span class="params">()</span> &#123;</span><br><span class="line">        ....</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        auth.userDetailsService(userDetailsService());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http.authorizeRequests()</span><br><span class="line">                .anyRequest().authenticated()</span><br><span class="line">                .and()</span><br><span class="line">                .formLogin()</span><br><span class="line">                .and()</span><br><span class="line">                .rememberMe()</span><br><span class="line">                .and()</span><br><span class="line">                .csrf().disable()</span><br><span class="line">                .sessionManagement()  <span class="comment">//å¼€å¯ä¼šè¯ç®¡ç†</span></span><br><span class="line">                .maximumSessions(<span class="number">1</span>)  <span class="comment">//å…è®¸åŒä¸€ä¸ªç”¨æˆ·åªå…è®¸åˆ›å»ºä¸€ä¸ªä¼šè¯*/</span></span><br><span class="line">                .expiredUrl(<span class="string">&quot;/login&quot;</span>)<span class="comment">//ä¼šè¯è¿‡æœŸå¤„ç†  ä¼ ç»Ÿ web å¼€å‘</span></span><br><span class="line">                .expiredSessionStrategy(event -&gt; &#123;</span><br><span class="line">                    <span class="type">HttpServletResponse</span> <span class="variable">response</span> <span class="operator">=</span> event.getResponse();</span><br><span class="line">                    response.setContentType(<span class="string">&quot;application/json;charset=UTF-8&quot;</span>);</span><br><span class="line">                    Map&lt;String, Object&gt; result = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">                    result.put(<span class="string">&quot;status&quot;</span>, <span class="number">500</span>);</span><br><span class="line">                    result.put(<span class="string">&quot;msg&quot;</span>, <span class="string">&quot;å½“å‰ä¼šè¯å·²ç»å¤±æ•ˆ,è¯·é‡æ–°ç™»å½•!&quot;</span>);</span><br><span class="line">                    <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectMapper</span>().writeValueAsString(result);</span><br><span class="line">                    response.getWriter().println(s);</span><br><span class="line">                    response.flushBuffer();</span><br><span class="line">                &#125;).sessionRegistry(sessionRegistry());<span class="comment">//å‰åç«¯åˆ†ç¦»å¼€å‘å¤„ç†</span></span><br><span class="line">        <span class="comment">//.maxSessionsPreventsLogin(true);//ç™»å½•ä¹‹åç¦æ­¢å†æ¬¡ç™»å½•*/</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> SpringSessionBackedSessionRegistry <span class="title function_">sessionRegistry</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SpringSessionBackedSessionRegistry</span>(sessionRepository);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h6 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h6><h1 id="ç¬¬å…«ç« -CSRF-æ¼æ´ä¿æŠ¤"><a href="#ç¬¬å…«ç« -CSRF-æ¼æ´ä¿æŠ¤" class="headerlink" title="ç¬¬å…«ç«  CSRF æ¼æ´ä¿æŠ¤"></a>ç¬¬å…«ç«  CSRF æ¼æ´ä¿æŠ¤</h1><ul><li><p>CSRF ç®€ä»‹</p></li><li><p>CSRF é˜²å¾¡&amp;åŸºæœ¬é…ç½®</p></li><li><p>å®æˆ˜</p></li></ul><h3 id="ç®€ä»‹-5"><a href="#ç®€ä»‹-5" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h3><p>CSRF (Cross-Site Request Forgery è·¨ç«™è¯·æ±‚ä¼ªé€ )ï¼Œä¹Ÿå¯ç§°ä¸ºä¸€é”®å¼æ”»å‡» (one-click-attackï¼‰ï¼Œé€šå¸¸ç¼©å†™ä¸º <code>CSRF</code> æˆ–è€… <code>XSRF</code>ã€‚</p><p><code>CSRF</code> æ”»å‡»æ˜¯ä¸€ç§æŒŸæŒç”¨æˆ·åœ¨å½“å‰å·²ç™»å½•çš„æµè§ˆå™¨ä¸Šå‘é€æ¶æ„è¯·æ±‚çš„æ”»å‡»æ–¹æ³•ã€‚ç›¸å¯¹äºXSSåˆ©ç”¨ç”¨æˆ·å¯¹æŒ‡å®šç½‘ç«™çš„ä¿¡ä»»ï¼ŒCSRFåˆ™æ˜¯åˆ©ç”¨ç½‘ç«™å¯¹ç”¨æˆ·ç½‘é¡µæµè§ˆå™¨çš„ä¿¡ä»»ã€‚ç®€å•æ¥è¯´ï¼ŒCSRFæ˜¯è‡´å‡»è€…é€šè¿‡ä¸€äº›æŠ€æœ¯æ‰‹æ®µæ¬ºéª—ç”¨æˆ·çš„æµè§ˆå™¨ï¼Œå»è®¿é—®ä¸€ä¸ªç”¨æˆ·æ›¾ç»è®¤è¯è¿‡çš„ç½‘ç«™å¹¶æ‰§è¡Œæ¶æ„è¯·æ±‚ï¼Œä¾‹å¦‚å‘é€é‚®ä»¶ã€å‘æ¶ˆæ¯ã€ç”šè‡³è´¢äº§æ“ä½œ (å¦‚è½¬è´¦å’Œè´­ä¹°å•†å“ï¼‰ã€‚ç”±äºå®¢æˆ·ç«¯(æµè§ˆå™¨)å·²ç»åœ¨è¯¥ç½‘ç«™ä¸Šè®¤è¯è¿‡ï¼Œæ‰€ä»¥è¯¥ç½‘ç«™ä¼šè®¤ä¸ºæ˜¯çœŸæ­£ç”¨æˆ·åœ¨æ“ä½œè€Œæ‰§è¡Œè¯·æ±‚ï¼ˆå®é™…ä¸Šè¿™ä¸ªå¹¶éç”¨æˆ·çš„æœ¬æ„ï¼‰ã€‚</p><p><strong>ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼š</strong></p><p>å‡è®¾ blr ç°åœ¨ç™»å½•äº†æŸé“¶è¡Œçš„ç½‘ç«™å‡†å¤‡å®Œæˆä¸€é¡¹è½¬è´¦æ“ä½œï¼Œè½¬è´¦çš„é“¾æ¥å¦‚ä¸‹ï¼š</p><p><strong>https: &#x2F;&#x2F;bank .xxx .com&#x2F;withdraw?account&#x3D;blr&amp;amount&#x3D;1000&amp;for&#x3D;zhangsan</strong></p><p>å¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªé“¾æ¥æ˜¯æƒ³ä» blr è¿™ä¸ªè´¦æˆ·ä¸‹è½¬è´¦ 1000 å…ƒåˆ° zhangsan è´¦æˆ·ä¸‹ï¼Œå‡è®¾blr æ²¡æœ‰æ³¨é”€ç™»å½•è¯¥é“¶è¡Œçš„ç½‘ç«™ï¼Œå°±åœ¨åŒä¸€ä¸ªæµè§ˆå™¨æ–°çš„é€‰é¡¹å¡ä¸­æ‰“å¼€äº†ä¸€ä¸ªå±é™©ç½‘ç«™ï¼Œè¿™ä¸ªå±é™©ç½‘ç«™ä¸­æœ‰ä¸€å¹…å›¾ç‰‡ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><p><strong><img src="https ://bank.xxx.com/withdraw?account=blr&amount=1000&for=1isi"></strong></p><p>ä¸€æ—¦ç”¨æˆ·æ‰“å¼€äº†è¿™ä¸ªç½‘ç«™ï¼Œè¿™ä¸ªå›¾ç‰‡é“¾æ¥ä¸­çš„è¯·æ±‚å°±ä¼šè‡ªåŠ¨å‘é€å‡ºå»ã€‚ç”±äºæ˜¯åŒä¸€ä¸ªæµè§ˆå™¨å¹¶ä¸”ç”¨æˆ·å°šæœªæ³¨é”€ç™»å½•ï¼Œæ‰€ä»¥è¯¥è¯·æ±‚ä¼šè‡ªåŠ¨æºå¸¦ä¸Šå¯¹åº”çš„æœ‰æ•ˆçš„ Cookie ä¿¡æ¯ï¼Œè¿›è€Œå®Œæˆä¸€æ¬¡è½¬è´¦æ“ä½œã€‚è¿™å°±æ˜¯è·¨ç«™è¯·æ±‚ä¼ªé€ ã€‚</p><h3 id="CSRFæ”»å‡»æ¼”ç¤º"><a href="#CSRFæ”»å‡»æ¼”ç¤º" class="headerlink" title="CSRFæ”»å‡»æ¼”ç¤º"></a>CSRFæ”»å‡»æ¼”ç¤º</h3><h4 id="åˆ›å»ºé“¶è¡Œåº”ç”¨"><a href="#åˆ›å»ºé“¶è¡Œåº”ç”¨" class="headerlink" title="åˆ›å»ºé“¶è¡Œåº”ç”¨"></a>åˆ›å»ºé“¶è¡Œåº”ç”¨</h4><ul><li><p>å¼•å…¥ä¾èµ–</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>ä¿®æ”¹é…ç½®</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> UserDetailsService <span class="title function_">userDetailsService</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">InMemoryUserDetailsManager</span> <span class="variable">inMemoryUserDetailsManager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InMemoryUserDetailsManager</span>();</span><br><span class="line">        inMemoryUserDetailsManager.createUser(User.withUsername(<span class="string">&quot;root&quot;</span>).password(<span class="string">&quot;&#123;noop&#125;123&quot;</span>).roles(<span class="string">&quot;admin&quot;</span>).build());</span><br><span class="line">        <span class="keyword">return</span> inMemoryUserDetailsManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        auth.userDetailsService(userDetailsService());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http.authorizeRequests().anyRequest().authenticated()</span><br><span class="line">                .and().formLogin().and().csrf().disable();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>åˆ›å»º controller å¹¶å¯åŠ¨å¯åŠ¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/withdraw&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">withdraw</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;æ‰§è¡Œä¸€æ¬¡è½¬è´¦æ“ä½œ&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;æ‰§è¡Œä¸€æ¬¡è½¬è´¦æ“ä½œ&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h4 id="åˆ›å»ºæ¶æ„åº”ç”¨"><a href="#åˆ›å»ºæ¶æ„åº”ç”¨" class="headerlink" title="åˆ›å»ºæ¶æ„åº”ç”¨"></a>åˆ›å»ºæ¶æ„åº”ç”¨</h4><ul><li><p>åˆ›å»ºç®€å• springboot åº”ç”¨</p></li><li><p>ä¿®æ”¹é…ç½®</p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8081</span></span><br></pre></td></tr></table></figure></li><li><p>å‡†å¤‡æ”»å‡»é¡µé¢</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;http://127.0.0.1:8080/withdraw&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">value</span>=<span class="string">&quot;blr&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">&quot;money&quot;</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">value</span>=<span class="string">&quot;10000&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;ç‚¹æˆ‘&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="CSRF-é˜²å¾¡"><a href="#CSRF-é˜²å¾¡" class="headerlink" title="CSRF é˜²å¾¡"></a>CSRF é˜²å¾¡</h3><p><strong>CSRF</strong>æ”»å‡»çš„æ ¹æºåœ¨äºæµè§ˆå™¨é»˜è®¤çš„èº«ä»½éªŒè¯æœºåˆ¶(è‡ªåŠ¨æºå¸¦å½“å‰ç½‘ç«™çš„Cookieä¿¡æ¯)ï¼Œè¿™ç§æœºåˆ¶è™½ç„¶å¯ä»¥ä¿è¯è¯·æ±‚æ˜¯æ¥è‡ªç”¨æˆ·çš„æŸä¸ªæµè§ˆå™¨ï¼Œä½†æ˜¯æ— æ³•ç¡®ä¿è¿™è¯·æ±‚æ˜¯ç”¨æˆ·æˆæƒå‘é€ã€‚æ”»å‡»è€…å’Œç”¨æˆ·å‘é€çš„è¯·æ±‚ä¸€æ¨¡ä¸€æ ·ï¼Œè¿™æ„å‘³ç€æˆ‘ä»¬æ²¡æœ‰åŠæ³•å»ç›´æ¥æ‹’ç»è¿™é‡Œçš„æŸä¸€ä¸ªè¯·æ±‚ã€‚å¦‚æœèƒ½åœ¨åˆæ³•æ¸…æ±‚ä¸­é¢å¤–æºå¸¦ä¸€ä¸ªæ”»å‡»è€…æ— æ³•è·å–çš„å‚æ•°ï¼Œå°±å¯ä»¥æˆåŠŸåŒºåˆ†å‡ºä¸¤ç§ä¸åŒçš„è¯·æ±‚ï¼Œè¿›è€Œç›´æ¥æ‹’ç»æ‰æ¶æ„è¯·æ±‚ã€‚åœ¨ SpringSecurity ä¸­å°±æä¾›äº†è¿™ç§æœºåˆ¶æ¥é˜²å¾¡ CSRF æ”»å‡»ï¼Œè¿™ç§æœºåˆ¶æˆ‘ä»¬ç§°ä¹‹ä¸º<code>ä»¤ç‰ŒåŒæ­¥æ¨¡å¼</code>ã€‚</p><h4 id="ä»¤ç‰ŒåŒæ­¥æ¨¡å¼"><a href="#ä»¤ç‰ŒåŒæ­¥æ¨¡å¼" class="headerlink" title="ä»¤ç‰ŒåŒæ­¥æ¨¡å¼"></a>ä»¤ç‰ŒåŒæ­¥æ¨¡å¼</h4><p>è¿™æ˜¯ç›®å‰ä¸»æµçš„ CSRF æ”»å‡»é˜²å¾¡æ–¹æ¡ˆã€‚å…·ä½“çš„æ“ä½œæ–¹å¼å°±æ˜¯åœ¨æ¯ä¸€ä¸ª HTTP è¯·æ±‚ä¸­ï¼Œé™¤äº†é»˜è®¤è‡ªåŠ¨æºå¸¦çš„ Cookie å‚æ•°ä¹‹å¤–ï¼Œå†æä¾›ä¸€ä¸ªå®‰å…¨çš„ã€éšæœºç”Ÿæˆçš„å®‡ç¬¦ä¸²ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸º CSRF ä»¤ç‰Œã€‚è¿™ä¸ª CSRF ä»¤ç‰Œç”±æœåŠ¡ç«¯ç”Ÿæˆï¼Œç”Ÿæˆååœ¨ HtpSession ä¸­ä¿å­˜ä¸€ä»½ã€‚å½“å‰ç«¯è¯·æ±‚åˆ°è¾¾åï¼Œå°†è¯·æ±‚æºå¸¦çš„ CSRF ä»¤ç‰Œä¿¡æ¯å’ŒæœåŠ¡ç«¯ä¸­ä¿å­˜çš„ä»¤ç‰Œè¿›è¡Œå¯¹æ¯”ï¼Œå¦‚æœä¸¤è€…ä¸ç›¸ç­‰ï¼Œåˆ™æ‹’ç»æ‰è¯¥ HITTP è¯·æ±‚ã€‚</p><blockquote><p><strong>æ³¨æ„:</strong> è€ƒè™‘åˆ°ä¼šæœ‰ä¸€äº›å¤–éƒ¨ç«™ç‚¹é“¾æ¥åˆ°æˆ‘ä»¬çš„ç½‘ç«™ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦æ±‚è¯·æ±‚æ˜¯å¹‚ç­‰çš„ï¼Œè¿™æ ·å¯¹å­HEADã€OPTIONSã€TRACE ç­‰æ–¹æ³•å°±æ²¡æœ‰å¿…è¦ä½¿ç”¨ CSRF ä»¤ç‰Œäº†ï¼Œå¼ºè¡Œä½¿ç”¨å¯èƒ½ä¼šå¯¼è‡´ä»¤ç‰Œæ³„éœ²ï¼</p></blockquote><h4 id="å¼€å¯-CSRF-é˜²å¾¡"><a href="#å¼€å¯-CSRF-é˜²å¾¡" class="headerlink" title="å¼€å¯ CSRF é˜²å¾¡"></a>å¼€å¯ CSRF é˜²å¾¡</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http.</span><br><span class="line">          ...</span><br><span class="line">          formLogin()</span><br><span class="line">          .and()</span><br><span class="line">          .csrf(); <span class="comment">//å¼€å¯ csrf</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="æŸ¥çœ‹ç™»å½•é¡µé¢æºç "><a href="#æŸ¥çœ‹ç™»å½•é¡µé¢æºç " class="headerlink" title="æŸ¥çœ‹ç™»å½•é¡µé¢æºç "></a>æŸ¥çœ‹ç™»å½•é¡µé¢æºç </h4><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220418191456109.png" class=""><h3 id="ä¼ ç»Ÿwebå¼€å‘ä½¿ç”¨CSRF"><a href="#ä¼ ç»Ÿwebå¼€å‘ä½¿ç”¨CSRF" class="headerlink" title="ä¼ ç»Ÿwebå¼€å‘ä½¿ç”¨CSRF"></a>ä¼ ç»Ÿwebå¼€å‘ä½¿ç”¨CSRF</h3><p>å¼€å¯CSRFé˜²å¾¡åä¼šè‡ªåŠ¨åœ¨æäº¤çš„è¡¨å•ä¸­åŠ å…¥å¦‚ä¸‹ä»£ç ï¼Œå¦‚æœä¸èƒ½è‡ªåŠ¨åŠ å…¥ï¼Œéœ€è¦åœ¨å¼€å¯ä¹‹åæ‰‹åŠ¨åŠ å…¥å¦‚ä¸‹ä»£ç ï¼Œå¹¶éšç€è¯·æ±‚æäº¤ã€‚è·å–æœåŠ¡ç«¯ä»¤ç‰Œæ–¹å¼å¦‚ä¸‹:</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">th:name</span>=<span class="string">&quot;$&#123;_csrf.parameterName&#125;&quot;</span> <span class="attr">th:value</span>=<span class="string">&quot;$&#123;_csrf.token&#125;&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure><h4 id="å¼€å‘æµ‹è¯•-controller"><a href="#å¼€å‘æµ‹è¯•-controller" class="headerlink" title="å¼€å‘æµ‹è¯• controller"></a>å¼€å‘æµ‹è¯• controller</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloController</span> &#123;</span><br><span class="line">    <span class="meta">@PostMapping(&quot;/hello&quot;)</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;hello success&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;hello success&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/index.html&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">index</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;index&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="åˆ›å»º-html"><a href="#åˆ›å»º-html" class="headerlink" title="åˆ›å»º html"></a>åˆ›å»º html</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>æµ‹è¯• CSRF é˜²å¾¡<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">th:action</span>=<span class="string">&quot;@&#123;/hello&#125;&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;hello&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="æµ‹è¯•æŸ¥çœ‹index-htmlæºç "><a href="#æµ‹è¯•æŸ¥çœ‹index-htmlæºç " class="headerlink" title="æµ‹è¯•æŸ¥çœ‹index.htmlæºç "></a>æµ‹è¯•æŸ¥çœ‹index.htmlæºç </h4><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220418193519717.png" class=""><h3 id="å‰åç«¯åˆ†ç¦»ä½¿ç”¨-CSRF"><a href="#å‰åç«¯åˆ†ç¦»ä½¿ç”¨-CSRF" class="headerlink" title="å‰åç«¯åˆ†ç¦»ä½¿ç”¨ CSRF"></a>å‰åç«¯åˆ†ç¦»ä½¿ç”¨ CSRF</h3><p>å‰åç«¯åˆ†ç¦»å¼€å‘æ—¶ï¼Œåªéœ€è¦å°†ç”Ÿæˆ csrf æ”¾å…¥åˆ°cookie ä¸­ï¼Œå¹¶åœ¨è¯·æ±‚æ—¶è·å– cookie ä¸­ä»¤ç‰Œä¿¡æ¯è¿›è¡Œæäº¤å³å¯ã€‚</p><h4 id="ä¿®æ”¹-CSRF-å­˜å…¥-Cookie"><a href="#ä¿®æ”¹-CSRF-å­˜å…¥-Cookie" class="headerlink" title="ä¿®æ”¹ CSRF å­˜å…¥ Cookie"></a>ä¿®æ”¹ CSRF å­˜å…¥ Cookie</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http.authorizeRequests().anyRequest().authenticated()</span><br><span class="line">                .and()</span><br><span class="line">                .formLogin()</span><br><span class="line">                .and()</span><br><span class="line">                .csrf()</span><br><span class="line">                .csrfTokenRepository(CookieCsrfTokenRepository.withHttpOnlyFalse());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="è®¿é—®ç™»å½•ç•Œé¢æŸ¥çœ‹-cookie"><a href="#è®¿é—®ç™»å½•ç•Œé¢æŸ¥çœ‹-cookie" class="headerlink" title="è®¿é—®ç™»å½•ç•Œé¢æŸ¥çœ‹ cookie"></a>è®¿é—®ç™»å½•ç•Œé¢æŸ¥çœ‹ cookie</h4><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220418194059737.png" class=""><h4 id="å‘é€è¯·æ±‚æºå¸¦ä»¤ç‰Œå³å¯"><a href="#å‘é€è¯·æ±‚æºå¸¦ä»¤ç‰Œå³å¯" class="headerlink" title="å‘é€è¯·æ±‚æºå¸¦ä»¤ç‰Œå³å¯"></a>å‘é€è¯·æ±‚æºå¸¦ä»¤ç‰Œå³å¯</h4><ul><li>è¯·æ±‚å‚æ•°ä¸­æºå¸¦ä»¤ç‰Œ</li></ul><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">key:</span> <span class="string">_csrf</span>  </span><br><span class="line"><span class="string">value:&quot;xxx&quot;</span></span><br></pre></td></tr></table></figure><ul><li>è¯·æ±‚å¤´ä¸­æºå¸¦ä»¤ç‰Œ</li></ul><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">X-XSRF-TOKEN:value</span><br></pre></td></tr></table></figure><h1 id="ç¬¬ä¹ç« -è·¨åŸŸ"><a href="#ç¬¬ä¹ç« -è·¨åŸŸ" class="headerlink" title="ç¬¬ä¹ç«  è·¨åŸŸ"></a>ç¬¬ä¹ç«  è·¨åŸŸ</h1><ul><li>Spring å¤„ç†æ–¹æ¡ˆã€‚</li><li>Spring Security å¤„ç†æ–¹æ¡ˆã€‚</li></ul><h2 id="ç®€ä»‹-6"><a href="#ç®€ä»‹-6" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p>è·¨åŸŸé—®é¢˜æ˜¯å®é™…åº”ç”¨å¼€å‘ä¸­ä¸€ä¸ªéå¸¸å¸¸è§çš„éœ€æ±‚ï¼Œåœ¨ Spring æ¡†æ¶ä¸­å¯¹äºè·¨åŸŸé—®é¢˜çš„å¤„ç†æ–¹æ¡ˆæœ‰å¥½å‡ ç§ï¼Œå¼• äº† Spring Security ä¹‹åï¼Œè·¨åŸŸé—®é¢˜çš„å¤„ç†æ–¹æ¡ˆåˆå¢åŠ äº†ã€‚</p><h2 id="ä»€ä¹ˆæ˜¯-CORS"><a href="#ä»€ä¹ˆæ˜¯-CORS" class="headerlink" title="ä»€ä¹ˆæ˜¯ CORS"></a>ä»€ä¹ˆæ˜¯ CORS</h2><p>CORS (Cross-Origin Resource Sharing ï¼‰æ˜¯ç”± W3Cåˆ¶å®šçš„ä¸€ç§è·¨åŸŸèµ„æºå…±äº«æŠ€æœ¯æ ‡å‡†ï¼Œå…¶ç›®çš„å°±æ˜¯ä¸ºäº†è§£å†³å‰ç«¯çš„è·¨åŸŸè¯·æ±‚ã€‚åœ¨JavaEE å¼€å‘ä¸­ï¼Œæœ€å¸¸è§çš„å‰ç«¯è·¨åŸŸè¯·æ±‚è§£å†³æ–¹æ¡ˆæ˜¯æ—©æœŸçš„JSONPï¼Œä½†æ˜¯ JSONP åªæ”¯æŒ GET è¯·æ±‚ï¼Œè¿™æ˜¯ä¸€ä¸ªå¾ˆå¤§çš„ç¼ºé™·ï¼Œè€Œ CORS åˆ™æ”¯ç‰¹å¤šç§ HTTTPè¯·æ±‚æ–¹æ³•ï¼Œä¹Ÿæ˜¯ç›®å‰ä¸»æµçš„è·¨åŸŸè§£å†³æ–¹æ¡ˆã€‚</p><p>CORS ä¸­æ–°å¢äº†ä¸€ç»„HTTP è¯·æ±‚å¤´å­—æ®µï¼Œé€šè¿‡è¿™äº›å­—æ®µï¼ŒæœåŠ¡å™¨å‘Šè¯‰æµè§ˆå™¨ï¼Œé‚£äº›ç½‘ç«™é€šè¿‡æµè§ˆå™¨æœ‰æƒé™è®¿é—®å“ªäº›èµ„æºã€‚åŒæ—¶è§„å®šï¼Œå¯¹é‚£äº›å¯èƒ½ä¿®æ”¹æœåŠ¡å™¨æ•°æ®çš„HTTPè¯·æ±‚æ–¹æ³• ï¼ˆå¦‚GETä»¥å¤–çš„HTTP è¯·æ±‚ç­‰)ï¼Œæµè§ˆå™¨å¿…é¡»é¦–å…ˆä½¿ç”¨ OPTIONS æ–¹æ³•å‘èµ·ä¸€ä¸ªé¢„æ£€è¯·æ±‚(prenightstï¼‰ï¼Œé¢„æ£€è¯·æ±‚çš„ç›®çš„æ˜¯æŸ¥çœ‹æœåŠ¡ç«¯æ˜¯å¦æ”¯æŒå³å°†å‘èµ·çš„è·¨åŸŸè¯·æ±‚ï¼Œå¦‚æœæœåŠ¡ç«¯å…è®¸ï¼Œæ‰å‘é€å®é™…çš„ HTTP è¯·æ±‚ã€‚åœ¨é¢„æ£€è¯·æ±‚çš„è¿”å›ä¸­ï¼ŒæœåŠ¡å™¨ç«¯ä¹Ÿå¯ä»¥é€šçŸ¥å®¢æˆ·ç«¯ï¼Œæ˜¯å¦éœ€è¦æºå¸¦èº«ä»½å‡­è¯ï¼ˆå¦‚ Cookiesã€HTTP è®¤è¯ä¿¡æ¯ç­‰ï¼‰ã€‚</p><blockquote><p> CORS: åŒæº&#x2F;åŒåŸŸ &#x3D; åè®®+ä¸»æœº+ç«¯å£</p></blockquote><h3 id="ç®€å•è¯·æ±‚"><a href="#ç®€å•è¯·æ±‚" class="headerlink" title="ç®€å•è¯·æ±‚"></a>ç®€å•è¯·æ±‚</h3><p>GET è¯·æ±‚ä¸ºä¾‹ï¼Œå¦‚æœéœ€è¦å‘èµ·ä¸€ä¸ªè·¨åŸŸè¯·æ±‚ï¼Œåˆ™è¯·æ±‚å¤´å¦‚ä¸‹ï¼š</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>localhost:8080</span><br><span class="line"><span class="attribute">Origin</span><span class="punctuation">: </span>http://localhost:8081</span><br><span class="line">Referer:http://localhost:8081/index.html</span><br></pre></td></tr></table></figure><p>å¦‚æœæœåŠ¡ç«¯æ”¯æŒè¯¥è·¨åŸŸè¯·æ±‚ï¼Œé‚£ä¹ˆè¿”å›çš„å“åº”å¤´ä¸­å°†åŒ…å«å¦‚ä¸‹å­—æ®µï¼š</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Access-Control-Allow-Origin:http://localhost: 8081</span><br></pre></td></tr></table></figure><p>Access-Control-Allow-Origin å­—æ®µç”¨æ¥å‘Šè¯‰æµè§ˆå™¨å¯ä»¥è®¿é—®è¯¥èµ„æºçš„åŸŸï¼Œå½“æµè§ˆå™¨æ”¶åˆ°è¿™æ ·çš„å“åº”å¤´ä¿¡æ¯ä¹‹åï¼Œæå–å‡º Access-Control-Allow-Origin å­—æ®µä¸­çš„å€¼ï¼Œ å‘ç°è¯¥å€¼åŒ…å«å½“å‰é¡µé¢æ‰€åœ¨çš„åŸŸï¼Œå°±çŸ¥é“è¿™ä¸ªè·¨åŸŸæ˜¯è¢«å…è®¸çš„ï¼Œå› æ­¤å°±ä¸å†å¯¹å‰ç«¯çš„è·¨åŸŸè¯·æ±‚è¿›è¡Œé™åˆ¶ã€‚è¿™å±äºç®€å•è¯·æ±‚ï¼Œå³ä¸éœ€è¦è¿›è¡Œé¢„æ£€è¯·æ±‚çš„è·¨åŸŸã€‚</p><h3 id="éç®€å•è¯·æ±‚"><a href="#éç®€å•è¯·æ±‚" class="headerlink" title="éç®€å•è¯·æ±‚"></a>éç®€å•è¯·æ±‚</h3><p>å¯¹äºä¸€äº›éç®€å•è¯·æ±‚ï¼Œä¼šé¦–å…ˆå‘é€ä¸€ä¸ªé¢„æ£€è¯·æ±‚ã€‚é¢„æ£€è¯·æ±‚ç±»ä¼¼ä¸‹é¢è¿™æ ·ï¼š</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">OPTIONS</span> <span class="string">/put</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>localhost:8080</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>keep-alive</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>*/*</span><br><span class="line">Access-Control-Request-Method:PUT</span><br><span class="line"><span class="attribute">Origin</span><span class="punctuation">: </span>http://localhost: 8081</span><br><span class="line">Referer:http://localhost:8081/index.html</span><br></pre></td></tr></table></figure><p>è¯·æ±‚æ–¹æ³•æ˜¯ OPTIONSï¼Œè¯·æ±‚å¤´Origin å°±å‘Šè¯‰æœåŠ¡ç«¯å½“å‰é¡µé¢æ‰€åœ¨åŸŸï¼Œè¯·æ±‚å¤´ Access-Control-Request-Methods å‘Šè¯‰æœåŠ¡å™¨ç«¯å³å°†å‘èµ·çš„è·¨åŸŸè¯·æ±‚æ‰€ä½¿ç”¨çš„ä¸‡æ³•ã€‚æœåŠ¡ç«¯å¯¹æ­¤è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœå…è®¸å³å°†å‘èµ·çš„è·¨åŸŸè¯·æ±‚ï¼Œåˆ™ä¼šç»™å‡ºå¦‚ä¸‹å“åº”ï¼š</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">HTTP/1.1</span> <span class="number">200</span></span><br><span class="line">Access-Control-Allow-Origin:http://localhost: 8081</span><br><span class="line"><span class="attribute">Access-Control-Request-Methods</span><span class="punctuation">: </span>PUT</span><br><span class="line"><span class="attribute">Access-Control-Max-Age</span><span class="punctuation">: </span>3600</span><br></pre></td></tr></table></figure><p>Access-Control-Allow-Metbods å­—æ®µè¡¨ç¤ºå…è®¸çš„è·¨åŸŸæ–¹æ³•ï¼šAccess-Control-Max-Age å­—æ®µè¡¨ç¤ºé¢„æ£€è¯·æ±‚çš„æœ‰æ•ˆæœŸï¼Œå•ä½ä¸ºç§’ï¼Œåœ¨æœ‰æ•ˆæœŸå†…å¦‚æœå‘èµ·è¯¥è·¨åŸŸè¯·æ±‚ï¼Œåˆ™ä¸ç”¨å†æ¬¡å‘èµ·é¢„æ£€è¯·æ±‚ã€‚é¢„æ£€è¯·æ±‚ç»“æœ¿åï¼Œæ¥ä¸‹æ¥å°±ä¼šå‘èµ·ä¸€ä¸ªçœŸæ­£çš„è·¨åŸŸè¯·æ±‚ï¼Œè·¨åŸŸè¯·æ±‚å’Œå‰é¢çš„ç®€å•è¯·æ±‚è·¨åŸŸæ­¥éª¤ç±»ä¼¼ã€‚</p><h2 id="Spring-è·¨åŸŸè§£å†³æ–¹æ¡ˆ"><a href="#Spring-è·¨åŸŸè§£å†³æ–¹æ¡ˆ" class="headerlink" title="Spring è·¨åŸŸè§£å†³æ–¹æ¡ˆ"></a>Spring è·¨åŸŸè§£å†³æ–¹æ¡ˆ</h2><h3 id="CrossOrigin"><a href="#CrossOrigin" class="headerlink" title="@CrossOrigin"></a>@CrossOrigin</h3><p>Spring ä¸­ç¬¬ä¸€ç§å¤„ç†è·¨åŸŸçš„æ–¹å¼æ˜¯é€šè¿‡@CrossOrigin æ³¨è§£æ¥æ ‡è®°æ”¯æŒè·¨åŸŸï¼Œè¯¥æ³¨è§£å¯ä»¥æ·»åŠ åœ¨æ–¹æ³•ä¸Šï¼Œä¹Ÿå¯ä»¥æ·»åŠ åœ¨ Controller ä¸Šã€‚å½“æ·»åŠ åœ¨ Controller ä¸Šæ—¶ï¼Œè¡¨ç¤º Controller ä¸­çš„æ‰€</p><p>æœ‰æ¥å£éƒ½æ”¯æŒè·¨åŸŸï¼Œå…·ä½“é…ç½®å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> Class HelloController&#123;</span><br><span class="line"><span class="meta">@CrossOrigin</span> (origins =<span class="string">&quot;http://localhost:8081&quot;</span>)</span><br><span class="line"><span class="meta">@PostMapping</span> (<span class="string">&quot;/post&quot;</span>)</span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">post</span> <span class="params">()</span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">&quot;hello post&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>@CrossOrigin æ³¨è§£å„å±æ€§å«ä¹‰å¦‚ä¸‹ï¼š</p><ul><li><p>alowCredentialsï¼šæµè§ˆå™¨æ˜¯å¦åº”å½“å‘é€å‡­è¯ä¿¡æ¯ï¼Œå¦‚ Cookieã€‚</p></li><li><p>allowedHeadersï¼š è¯·æ±‚è¢«å…è®¸çš„è¯·æ±‚å¤´å­—æ®µï¼Œ<code>*</code>è¡¨ç¤ºæ‰€æœ‰å­—æ®µã€‚</p></li><li><p>exposedHeadersï¼šå“ªäº›å“åº”å¤´å¯ä»¥ä½œä¸ºå“åº”çš„ä¸€éƒ¨åˆ†æš´éœ²å‡ºæ¥ã€‚</p><p><code>æ³¨æ„ï¼Œè¿™é‡Œåªå¯ä»¥ä¸€ä¸€åˆ—ä¸¾ï¼Œé€šé…ç¬¦ * åœ¨è¿™é‡Œæ˜¯æ— æ•ˆçš„ã€‚</code></p></li><li><p>maxAgeï¼šé¢„æ£€è¯·æ±‚çš„æœ‰æ•ˆæœŸï¼Œæœ‰æ•ˆæœŸå†…ä¸å¿…å†æ¬¡å‘é€é¢„æ£€è¯·æ±‚ï¼Œé»˜è®¤æ˜¯<code>1800 </code>ç§’ã€‚</p></li><li><p>methodsï¼šå…è®¸çš„è¯·æ±‚æ–¹æ³•ï¼Œ<code>*</code> è¡¨ç¤ºå…è®¸æ‰€æœ‰æ–¹æ³•ã€‚</p></li><li><p>originsï¼šå…è®¸çš„åŸŸï¼Œ<code>*</code>è¡¨ç¤ºå…è®¸æ‰€æœ‰åŸŸã€‚</p></li></ul><h3 id="addCrosMapping"><a href="#addCrosMapping" class="headerlink" title="addCrosMapping"></a>addCrosMapping</h3><p>@CrossOrigin æ³¨è§£éœ€è¦æ·»åŠ åœ¨ä¸åŒçš„ Controller ä¸Šã€‚æ‰€ä»¥è¿˜æœ‰ä¸€ç§å…¨å±€é…ç½®æ–¹æ³•ï¼Œå°±æ˜¯é€šè¿‡é‡å†™ WebMvcConfigurerComposite#addCorsMappingsæ–¹æ³•æ¥å®ç°ï¼Œå…·ä½“é…ç½®å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Configuration</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebMvcConfig</span> <span class="keyword">implements</span> <span class="title class_">WebMvcConfigurer</span>&#123;</span><br><span class="line">  Override</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addCorsMappings</span> <span class="params">(CorsRegistry registry)</span>&#123;</span><br><span class="line">    registry.addMapping(<span class="string">&quot;/**&quot;</span>) <span class="comment">//å¤„ç†çš„è¯·æ±‚åœ°å€</span></span><br><span class="line">    .allowedMethods (<span class="string">&quot;*&quot;</span>)</span><br><span class="line">    â€¢allowedorigins(<span class="string">&quot;*&quot;</span>)</span><br><span class="line">    .allowedHeaders (<span class="string">&quot;*&quot;</span>)</span><br><span class="line">    .allowCredentials (<span class="literal">false</span>)</span><br><span class="line">    â€¢exposedHeaders (<span class="string">&quot;&quot;</span>)</span><br><span class="line">    .maxAge (<span class="number">3600</span>) ;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="CrosFilter"><a href="#CrosFilter" class="headerlink" title="CrosFilter"></a>CrosFilter</h3><p>Cosr Filter æ˜¯Spring Web ä¸­æä¾›çš„ä¸€ä¸ªå¤„ç†è·¨åŸŸçš„è¿‡æ»¤å™¨ï¼Œå¼€å‘è€…ä¹Ÿå¯ä»¥é€šè¿‡è¯¥è¿‡è¯¥è¿‡æ»¤å™¨å¤„ç†è·¨åŸŸã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebMvcConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    FilterRegistrationBean&lt;CorsFilter&gt; <span class="title function_">corsFilter</span><span class="params">()</span> &#123;</span><br><span class="line">        FilterRegistrationBean&lt;CorsFilter&gt; registrationBean = <span class="keyword">new</span> <span class="title class_">FilterRegistrationBean</span>&lt;&gt;();</span><br><span class="line">        <span class="type">CorsConfiguration</span> <span class="variable">corsConfiguration</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CorsConfiguration</span>();</span><br><span class="line">        corsConfiguration.setAllowedHeaders(Arrays.asList(<span class="string">&quot;*&quot;</span>));</span><br><span class="line">        corsConfiguration.setAllowedMethods(Arrays.asList(<span class="string">&quot;*&quot;</span>));</span><br><span class="line">        corsConfiguration.setAllowedOrigins(Arrays.asList(<span class="string">&quot;*&quot;</span>));</span><br><span class="line">        corsConfiguration.setMaxAge(<span class="number">3600L</span>);</span><br><span class="line">        <span class="type">UrlBasedCorsConfigurationSource</span> <span class="variable">source</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UrlBasedCorsConfigurationSource</span>();</span><br><span class="line">        source.registerCorsConfiguration(<span class="string">&quot;/**&quot;</span>, corsConfiguration);</span><br><span class="line">        registrationBean.setFilter(<span class="keyword">new</span> <span class="title class_">CorsFilter</span>(source));</span><br><span class="line">        registrationBean.setOrder(-<span class="number">1</span>);<span class="comment">//filter 0 1</span></span><br><span class="line">        <span class="keyword">return</span> registrationBean;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Spring-Security-è·¨åŸŸè§£å†³æ–¹æ¡ˆ"><a href="#Spring-Security-è·¨åŸŸè§£å†³æ–¹æ¡ˆ" class="headerlink" title="Spring Security è·¨åŸŸè§£å†³æ–¹æ¡ˆ"></a>Spring Security è·¨åŸŸè§£å†³æ–¹æ¡ˆ</h2><h3 id="åŸç†åˆ†æ-1"><a href="#åŸç†åˆ†æ-1" class="headerlink" title="åŸç†åˆ†æ"></a>åŸç†åˆ†æ</h3><p>å½“æˆ‘ä»¬ä¸ºé¡¹ç›®æ·»åŠ äº† Spring Security ä¾èµ–ä¹‹åï¼Œå‘ç°ä¸Šé¢ä¸‰ç§è·¨åŸŸæ–¹å¼æœ‰çš„å¤±æ•ˆäº†ï¼Œæœ‰<br>åˆ™å¯ä»¥ç»§ç»­ä½¿ç”¨ï¼Œè¿™æ˜¯æ€ä¹ˆå›äº‹ï¼Ÿ</p><p>é€šè¿‡@CrossOrigin æ³¨è§£æˆ–è€…é‡å†™ addCorsMappings æ–¹æ³•é…ç½®è·¨åŸŸï¼Œç»Ÿç»Ÿå¤±æ•ˆäº†ï¼Œé€š<br>CorsFilter é…ç½®çš„è·¨åŸŸï¼Œæœ‰æ²¡æœ‰å¤±æ•ˆåˆ™è¦çœ‹è¿‡æ»¤å™¨çš„ä¼˜å…ˆçº§ï¼Œå¦‚æœè¿‡æ»¤å™¨ä¼˜å…ˆçº§é«˜äº Sp<br>Security è¿‡æ»¤å™¨ï¼Œå³å…ˆäº Spring Security è¿‡æ»¤å™¨æ‰§è¡Œï¼Œåˆ™ CorsFiter æ‰€é…ç½®çš„è·¨åŸŸå¤„ç†ä¾ç„¶æœ‰æ•ˆï¼›å¦‚æœè¿‡æ»¤å™¨ä¼˜å…ˆçº§ä½äº Spring Security è¿‡æ»¤å™¨ï¼Œåˆ™ CorsFilter æ‰€é…ç½®çš„è·¨åŸŸå¤„ç†å°±ä¼šå¤±æ•ˆã€‚</p><p>ä¸ºäº†ç†æ¸…æ¥šè¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å…ˆç®€ç•¥äº†è§£ä¸€ä¸‹ Filterã€DispatchserServlet ä»¥åŠInterceptor æ‰§è¡Œé¡ºåºã€‚</p><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220521074711128.png" class=""><p>ç†æ¸…æ¥šäº†æ‰§è¡Œé¡ºåºï¼Œæˆ‘ä»¬å†æ¥çœ‹è·¨åŸŸè¯·æ±‚è¿‡ç¨‹ã€‚ç”±äºéç®€å•è¯·æ±‚éƒ½è¦é¦–å…ˆå‘é€ä¸€ä¸ªé¢„æ£€è¯·æ±‚<br>requestï¼‰ï¼Œè€Œé¢„æ£€è¯·æ±‚å¹¶ä¸ä¼šæºå¸¦è®¤è¯ä¿¡æ¯ï¼Œæ‰€ä»¥é¢„æ£€è¯·æ±‚å°±æœ‰è¢« Spring Security æ‹¦æˆªçš„å¯èƒ½ã€‚å› æ­¤é€šè¿‡@CrossOrigin æ³¨è§£æˆ–è€…é‡å†™ addCorsMappings æ–¹æ³•é…ç½®è·¨åŸŸå°±ä¼šå¤±æ•ˆã€‚å¦‚æœä½¿ç”¨ CorsFilter é…ç½®çš„è·¨åŸŸï¼Œåªè¦è¿‡æ»¤å™¨ä¼˜å…ˆçº§é«˜äº SpringSecurity è¿‡æ»¤å™¨å°±ä¸ä¼šæœ‰é—®é¢˜ã€‚åä¹‹åŒæ ·ä¼šå‡ºç°é—®é¢˜ã€‚</p><h3 id="è§£å†³æ–¹æ¡ˆ-1"><a href="#è§£å†³æ–¹æ¡ˆ-1" class="headerlink" title="è§£å†³æ–¹æ¡ˆ"></a>è§£å†³æ–¹æ¡ˆ</h3><p>Spring Security ä¸­ä¹Ÿæä¾›äº†æ›´ä¸“ä¸šçš„æ–¹å¼æ¥è§£å†³é¢„æ£€è¯·æ±‚æ‰€é¢ä¸´çš„é—®é¢˜ã€‚å¦‚ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http.authorizeRequests().anyRequest()</span><br><span class="line">                .authenticated()</span><br><span class="line">                .and()</span><br><span class="line">                .formLogin()</span><br><span class="line">                .and()</span><br><span class="line">                .cors() <span class="comment">//è·¨åŸŸå¤„ç†æ–¹æ¡ˆ</span></span><br><span class="line">                .configurationSource(configurationSource())</span><br><span class="line">                .and()</span><br><span class="line">                .csrf().disable();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    CorsConfigurationSource <span class="title function_">configurationSource</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">CorsConfiguration</span> <span class="variable">corsConfiguration</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CorsConfiguration</span>();</span><br><span class="line">        corsConfiguration.setAllowedHeaders(Arrays.asList(<span class="string">&quot;*&quot;</span>));</span><br><span class="line">        corsConfiguration.setAllowedMethods(Arrays.asList(<span class="string">&quot;*&quot;</span>));</span><br><span class="line">        corsConfiguration.setAllowedOrigins(Arrays.asList(<span class="string">&quot;*&quot;</span>));</span><br><span class="line">        corsConfiguration.setMaxAge(<span class="number">3600L</span>);</span><br><span class="line">        <span class="type">UrlBasedCorsConfigurationSource</span> <span class="variable">source</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UrlBasedCorsConfigurationSource</span>();</span><br><span class="line">        source.registerCorsConfiguration(<span class="string">&quot;/**&quot;</span>, corsConfiguration);</span><br><span class="line">        <span class="keyword">return</span> source;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="ç¬¬åç« -å¼‚å¸¸å¤„ç†"><a href="#ç¬¬åç« -å¼‚å¸¸å¤„ç†" class="headerlink" title="ç¬¬åç«  å¼‚å¸¸å¤„ç†"></a>ç¬¬åç«  å¼‚å¸¸å¤„ç†</h1><ul><li>Spring Security å¼‚å¸¸ä½“ç³»</li><li>è‡ªå®šä¹‰å¼‚å¸¸é…ç½®</li></ul><h3 id="å¼‚å¸¸ä½“ç³»"><a href="#å¼‚å¸¸ä½“ç³»" class="headerlink" title="å¼‚å¸¸ä½“ç³»"></a>å¼‚å¸¸ä½“ç³»</h3><p>Spring Security ä¸­å¼‚å¸¸ä¸»è¦åˆ†ä¸ºä¸¤å¤§ç±»:</p><ul><li>AuthenticationException:  è®¤è¯å¼‚å¸¸</li><li>AccessDeniedException:    æˆæƒå¼‚å¸¸</li></ul><p>å…¶ä¸­è®¤è¯æ‰€æ¶‰åŠå¼‚å¸¸ç±»å‹æ¯”è¾ƒå¤šï¼Œé»˜è®¤æä¾›çš„å¼‚å¸¸ç±»å‹å¦‚ä¸‹ï¼š</p><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220430213210778.png" class=""><p>ç›¸æ¯”äºè®¤è¯å¼‚å¸¸ï¼Œæƒé™å¼‚å¸¸ç±»å°±è¦å°‘äº†å¾ˆå¤šï¼Œé»˜è®¤æä¾›çš„æƒé™å¼‚å¸¸å¦‚ä¸‹ï¼š</p><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220430213344621.png" class=""><p>åœ¨å®é™…é¡¹ç›®å¼€å‘ä¸­ï¼Œå¦‚æœé»˜è®¤æä¾›å¼‚å¸¸æ— æ³•æ»¡è¶³éœ€æ±‚æ—¶ï¼Œå°±éœ€è¦æ ¹æ®å®é™…éœ€è¦æ¥è‡ªå®šä¹‰å¼‚å¸¸ç±»ã€‚</p><h3 id="è‡ªå®šä¹‰å¼‚å¸¸å¤„ç†é…ç½®"><a href="#è‡ªå®šä¹‰å¼‚å¸¸å¤„ç†é…ç½®" class="headerlink" title="è‡ªå®šä¹‰å¼‚å¸¸å¤„ç†é…ç½®"></a>è‡ªå®šä¹‰å¼‚å¸¸å¤„ç†é…ç½®</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http.authorizeRequests().anyRequest()</span><br><span class="line">                .authenticated()</span><br><span class="line">          <span class="comment">//.....</span></span><br><span class="line">                .and()</span><br><span class="line">                .exceptionHandling()<span class="comment">//å¼‚å¸¸å¤„ç†</span></span><br><span class="line">                .authenticationEntryPoint((request, response, e) -&gt; &#123;</span><br><span class="line">                  response.setContentType(<span class="string">&quot;application/json;charset=UTF-8&quot;</span>);</span><br><span class="line">                  response.setStatus(HttpStatus.UNAUTHORIZED.value());</span><br><span class="line">                  response.getWriter().write(<span class="string">&quot;å°šæœªè®¤è¯ï¼Œè¯·è¿›è¡Œè®¤è¯æ“ä½œï¼&quot;</span>);</span><br><span class="line">                &#125;)</span><br><span class="line">                .accessDeniedHandler((request, response, e) -&gt; &#123;</span><br><span class="line">                  response.setContentType(<span class="string">&quot;application/json;charset=UTF-8&quot;</span>);</span><br><span class="line">                  response.setStatus(HttpStatus.FORBIDDEN.value());</span><br><span class="line">                  response.getWriter().write(<span class="string">&quot;æ— æƒè®¿é—®!&quot;</span>);</span><br><span class="line">                &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="ç¬¬åä¸€ç« -æˆæƒ"><a href="#ç¬¬åä¸€ç« -æˆæƒ" class="headerlink" title="ç¬¬åä¸€ç«  æˆæƒ"></a>ç¬¬åä¸€ç«  æˆæƒ</h1><ul><li>ä»€ä¹ˆæ˜¯æƒé™ç®¡ç†</li><li>æƒé™ç®¡ç†æ ¸å¿ƒæ¦‚å¿µ</li><li>Spring Security æƒé™ç®¡ç†ç­–ç•¥</li><li>åŸºäº URL åœ°å€çš„æƒé™ç®¡ç†</li><li>åŸºäºæ–¹æ³•çš„æƒé™ç®¡ç†</li><li>å®æˆ˜</li></ul><h3 id="æƒé™ç®¡ç†-1"><a href="#æƒé™ç®¡ç†-1" class="headerlink" title="æƒé™ç®¡ç†"></a>æƒé™ç®¡ç†</h3><h4 id="è®¤è¯-2"><a href="#è®¤è¯-2" class="headerlink" title="è®¤è¯"></a>è®¤è¯</h4><p><strong>èº«ä»½è®¤è¯</strong>ï¼Œå°±æ˜¯åˆ¤æ–­ä¸€ä¸ªç”¨æˆ·æ˜¯å¦ä¸ºåˆæ³•ç”¨æˆ·çš„å¤„ç†è¿‡ç¨‹ã€‚Spring Security ä¸­æ”¯æŒå¤šç§ä¸åŒæ–¹å¼çš„è®¤è¯ï¼Œä½†æ˜¯æ— è®ºå¼€å‘è€…ä½¿ç”¨é‚£ç§æ–¹å¼è®¤è¯ï¼Œéƒ½ä¸ä¼šå½±å“æˆæƒåŠŸèƒ½ä½¿ç”¨ã€‚å› ä¸º Spring Security å¾ˆå¥½åšåˆ°äº†è®¤è¯å’Œæˆæƒè§£è€¦ã€‚</p><h4 id="æˆæƒ-2"><a href="#æˆæƒ-2" class="headerlink" title="æˆæƒ"></a>æˆæƒ</h4><p><strong>æˆæƒ</strong>ï¼Œå³è®¿é—®æ§åˆ¶ï¼Œæ§åˆ¶è°èƒ½è®¿é—®å“ªäº›èµ„æºã€‚ç®€å•çš„ç†è§£æˆæƒå°±æ˜¯æ ¹æ®ç³»ç»Ÿæå‰è®¾ç½®å¥½çš„è§„åˆ™ï¼Œç»™ç”¨æˆ·åˆ†é…å¯ä»¥è®¿é—®æŸä¸€ä¸ªèµ„æºçš„æƒé™ï¼Œç”¨æˆ·æ ¹æ®è‡ªå·±æ‰€å…·æœ‰æƒé™ï¼Œå»æ‰§è¡Œç›¸åº”æ“ä½œã€‚</p><h3 id="æˆæƒæ ¸å¿ƒæ¦‚å¿µ"><a href="#æˆæƒæ ¸å¿ƒæ¦‚å¿µ" class="headerlink" title="æˆæƒæ ¸å¿ƒæ¦‚å¿µ"></a>æˆæƒæ ¸å¿ƒæ¦‚å¿µ</h3><p>åœ¨å‰é¢å­¦ä¹ è®¤è¯è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¾—çŸ¥è®¤è¯æˆåŠŸä¹‹åä¼šå°†å½“å‰ç™»å½•ç”¨æˆ·ä¿¡æ¯ä¿å­˜åˆ° Authentication å¯¹è±¡ä¸­ï¼ŒAuthentication å¯¹è±¡ä¸­æœ‰ä¸€ä¸ª getAuthorities() æ–¹æ³•ï¼Œç”¨æ¥è¿”å›å½“å‰ç™»å½•ç”¨æˆ·å…·å¤‡çš„æƒé™ä¿¡æ¯ï¼Œä¹Ÿå°±æ˜¯å½“å‰ç”¨æˆ·å…·æœ‰æƒé™ä¿¡æ¯ã€‚è¯¥æ–¹æ³•çš„è¿”å›å€¼ä¸º Collection&lt;? extends GrantedAuthority&gt;ï¼Œå½“éœ€è¦è¿›è¡Œæƒé™åˆ¤æ–­æ—¶ï¼Œå°±å›æ ¹æ®é›†åˆè¿”å›æƒé™ä¿¡æ¯è°ƒç”¨ç›¸åº”æ–¹æ³•è¿›è¡Œåˆ¤æ–­ã€‚</p><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220523110143445.png" class=""><p>é‚£ä¹ˆé—®é¢˜æ¥äº†ï¼Œé’ˆå¯¹äºè¿™ä¸ªè¿”å›å€¼ GrantedAuthority åº”è¯¥å¦‚ä½•ç†è§£å‘¢? æ˜¯è§’è‰²è¿˜æ˜¯æƒé™?</p><p>æˆ‘ä»¬é’ˆå¯¹äºæˆæƒå¯ä»¥æ˜¯<code>åŸºäºè§’è‰²æƒé™ç®¡ç†</code>å’Œ<code>åŸºäºèµ„æºæƒé™ç®¡ç†</code> ï¼Œä»è®¾è®¡å±‚é¢ä¸Šæ¥è¯´ï¼Œè§’è‰²å’Œæƒé™æ˜¯ä¸¤ä¸ªå®Œå…¨ä¸åŒçš„ä¸œè¥¿ï¼šæƒé™æ˜¯ä¸€äº›å…·ä½“æ“ä½œï¼Œè§’è‰²åˆ™æ˜¯æŸäº›æƒé™é›†åˆã€‚å¦‚ï¼šREAD_BOOK å’Œ ROLE_ADMIN æ˜¯å®Œå…¨ä¸åŒçš„ã€‚å› æ­¤è‡³äºè¿”å›å€¼æ˜¯ä»€ä¹ˆå–å†³äºä½ çš„ä¸šåŠ¡è®¾è®¡æƒ…å†µï¼š</p><ul><li><p>åŸºäºè§’è‰²æƒé™è®¾è®¡å°±æ˜¯: <code>ç”¨æˆ·&lt;=&gt;è§’è‰²&lt;=&gt;èµ„æº</code> ä¸‰è€…å…³ç³» è¿”å›å°±æ˜¯ç”¨æˆ·çš„<code>è§’è‰²</code> </p></li><li><p>åŸºäºèµ„æºæƒé™è®¾è®¡å°±æ˜¯: <code>ç”¨æˆ·&lt;=&gt;æƒé™&lt;=&gt;èµ„æº</code> ä¸‰è€…å…³ç³» è¿”å›å°±æ˜¯ç”¨æˆ·çš„<code>æƒé™</code> </p></li><li><p>åŸºäºè§’è‰²å’Œèµ„æºæƒé™è®¾è®¡å°±æ˜¯: <code>ç”¨æˆ·&lt;=&gt;è§’è‰²&lt;=&gt;æƒé™&lt;=&gt;èµ„æº</code> è¿”å›ç»Ÿç§°ä¸ºç”¨æˆ·çš„<code>æƒé™</code></p></li></ul><p>ä¸ºä»€ä¹ˆå¯ä»¥ç»Ÿç§°ä¸ºæƒé™ï¼Œå› ä¸ºä»ä»£ç å±‚é¢è§’è‰²å’Œæƒé™æ²¡æœ‰å¤ªå¤§ä¸åŒéƒ½æ˜¯æƒé™ï¼Œç‰¹åˆ«æ˜¯åœ¨ Spring Security ä¸­ï¼Œè§’è‰²å’Œæƒé™å¤„ç†æ–¹å¼åŸºæœ¬ä¸Šéƒ½æ˜¯ä¸€æ ·çš„ã€‚å”¯ä¸€åŒºåˆ« SpringSecurity åœ¨å¾ˆå¤šæ—¶å€™ä¼šè‡ªåŠ¨ç»™è§’è‰²æ·»åŠ ä¸€ä¸ª<code>ROLE_</code>å‰ç¼€ï¼Œè€Œæƒé™åˆ™ä¸ä¼šè‡ªåŠ¨æ·»åŠ ã€‚</p><h3 id="æƒé™ç®¡ç†ç­–ç•¥"><a href="#æƒé™ç®¡ç†ç­–ç•¥" class="headerlink" title="æƒé™ç®¡ç†ç­–ç•¥"></a>æƒé™ç®¡ç†ç­–ç•¥</h3><p>Spring Security ä¸­æä¾›çš„æƒé™ç®¡ç†ç­–ç•¥ä¸»è¦æœ‰ä¸¤ç§ç±»å‹:</p><ul><li><p>åŸºäºè¿‡æ»¤å™¨(URL)çš„æƒé™ç®¡ç† (FilterSecurityInterceptor)</p><ul><li>åŸºäºè¿‡æ»¤å™¨çš„æƒé™ç®¡ç†ä¸»è¦æ˜¯ç”¨æ¥æ‹¦æˆª HTTP è¯·æ±‚ï¼Œæ‹¦æˆªä¸‹æ¥ä¹‹åï¼Œæ ¹æ® HTTP è¯·æ±‚åœ°å€è¿›è¡Œæƒé™æ ¡éªŒã€‚</li></ul></li><li><p>åŸºäº AOP (æ–¹æ³•)çš„æƒé™ç®¡ç†   (MethodSecurityInterceptor)</p><ul><li>åŸºäº AOP æƒé™ç®¡ç†ä¸»è¦æ˜¯ç”¨æ¥å¤„ç†æ–¹æ³•çº§åˆ«çš„æƒé™é—®é¢˜ã€‚å½“éœ€è¦è°ƒç”¨æŸä¸€ä¸ªæ–¹æ³•æ—¶ï¼Œé€šè¿‡ AOP å°†æ“ä½œæ‹¦æˆªä¸‹æ¥ï¼Œç„¶ååˆ¤æ–­ç”¨æˆ·æ˜¯å¦å…·å¤‡ç›¸å…³çš„æƒé™ã€‚</li></ul></li></ul><h3 id="åŸºäº-URL-æƒé™ç®¡ç†"><a href="#åŸºäº-URL-æƒé™ç®¡ç†" class="headerlink" title="åŸºäº URL æƒé™ç®¡ç†"></a>åŸºäº URL æƒé™ç®¡ç†</h3><ul><li>å¼€å‘ controller</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DemoController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/admin&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">admin</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;admin ok&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/user&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">user</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;user ok&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/getInfo&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getInfo</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;info ok&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>é…ç½®æˆæƒ</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.blr.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.User;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.userdetails.UserDetailsService;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.provisioning.InMemoryUserDetailsManager;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//åˆ›å»ºå†…å­˜æ•°æ®æº</span></span><br><span class="line">    <span class="keyword">public</span> UserDetailsService <span class="title function_">userDetailsService</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">InMemoryUserDetailsManager</span> <span class="variable">inMemoryUserDetailsManager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InMemoryUserDetailsManager</span>();</span><br><span class="line">        inMemoryUserDetailsManager.createUser(User.withUsername(<span class="string">&quot;root&quot;</span>).password(<span class="string">&quot;&#123;noop&#125;123&quot;</span>).roles(<span class="string">&quot;ADMIN&quot;</span>).build());</span><br><span class="line">        inMemoryUserDetailsManager.createUser(User.withUsername(<span class="string">&quot;win7&quot;</span>).password(<span class="string">&quot;&#123;noop&#125;123&quot;</span>).roles(<span class="string">&quot;USER&quot;</span>).build());</span><br><span class="line">        inMemoryUserDetailsManager.createUser(User.withUsername(<span class="string">&quot;lisi&quot;</span>).password(<span class="string">&quot;&#123;noop&#125;123&quot;</span>).roles(<span class="string">&quot;READ_BOOK&quot;</span>).build());</span><br><span class="line">        <span class="keyword">return</span> inMemoryUserDetailsManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        auth.userDetailsService(userDetailsService());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http.authorizeHttpRequests()</span><br><span class="line">                .antMatchers(<span class="string">&quot;/admin/**&quot;</span>).hasRole(<span class="string">&quot;ADMIN&quot;</span>)</span><br><span class="line">                .antMatchers(<span class="string">&quot;/user/**&quot;</span>).hasAnyRole(<span class="string">&quot;USER&quot;</span>, <span class="string">&quot;ADMIN&quot;</span>)</span><br><span class="line">                .antMatchers(<span class="string">&quot;/getInfo&quot;</span>).hasRole(<span class="string">&quot;READ_BOOK&quot;</span>)</span><br><span class="line">                .anyRequest().authenticated()</span><br><span class="line">                .and().formLogin()</span><br><span class="line">                .and().csrf().disable();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>å¯åŠ¨é¡¹ç›®æµ‹è¯•</li></ul><h4 id="æƒé™è¡¨è¾¾å¼"><a href="#æƒé™è¡¨è¾¾å¼" class="headerlink" title="æƒé™è¡¨è¾¾å¼"></a>æƒé™è¡¨è¾¾å¼</h4><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220523153200373.png" class=""><table><thead><tr><th>æ–¹æ³•</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>hasAuthority(String authority)</td><td>å½“å‰ç”¨æˆ·æ˜¯å¦å…·å¤‡æŒ‡å®šæƒé™</td></tr><tr><td>hasAnyAuthority(Stringâ€¦ authorities)</td><td>å½“å‰ç”¨æˆ·æ˜¯å¦å…·å¤‡æŒ‡å®šæƒé™ä¸­ä»»æ„ä¸€ä¸ª</td></tr><tr><td>hasRole(String role)</td><td>å½“å‰ç”¨æˆ·æ˜¯å¦å…·å¤‡æŒ‡å®šè§’è‰²</td></tr><tr><td>hasAnyRole(Stringâ€¦ roles);</td><td>å½“å‰ç”¨æˆ·æ˜¯å¦å…·å¤‡æŒ‡å®šè§’è‰²ä¸­ä»»æ„ä¸€ä¸ª</td></tr><tr><td>permitAll();</td><td>æ”¾è¡Œæ‰€æœ‰è¯·æ±‚&#x2F;è°ƒç”¨</td></tr><tr><td>denyAll();</td><td>æ‹’ç»æ‰€æœ‰è¯·æ±‚&#x2F;è°ƒç”¨</td></tr><tr><td>isAnonymous();</td><td>å½“å‰ç”¨æˆ·æ˜¯å¦æ˜¯ä¸€ä¸ªåŒ¿åç”¨æˆ·</td></tr><tr><td>isAuthenticated();</td><td>å½“å‰ç”¨æˆ·æ˜¯å¦å·²ç»è®¤è¯æˆåŠŸ</td></tr><tr><td>isRememberMe();</td><td>å½“å‰ç”¨æˆ·æ˜¯å¦é€šè¿‡ Remember-Me è‡ªåŠ¨ç™»å½•</td></tr><tr><td>isFullyAuthenticated();</td><td>å½“å‰ç”¨æˆ·æ˜¯å¦æ—¢ä¸æ˜¯åŒ¿åç”¨æˆ·åˆä¸æ˜¯é€šè¿‡ Remember-Me è‡ªåŠ¨ç™»å½•çš„</td></tr><tr><td>hasPermission(Object targetId, Object permission);</td><td>å½“å‰ç”¨æˆ·æ˜¯å¦å…·å¤‡æŒ‡å®šç›®æ ‡çš„æŒ‡å®šæƒé™ä¿¡æ¯</td></tr><tr><td>hasPermission(Object targetId, String targetType, Object permission);</td><td>å½“å‰ç”¨æˆ·æ˜¯å¦å…·å¤‡æŒ‡å®šç›®æ ‡çš„æŒ‡å®šæƒé™ä¿¡æ¯</td></tr></tbody></table><h3 id="åŸºäº-æ–¹æ³•-æƒé™ç®¡ç†"><a href="#åŸºäº-æ–¹æ³•-æƒé™ç®¡ç†" class="headerlink" title="åŸºäº æ–¹æ³• æƒé™ç®¡ç†"></a>åŸºäº æ–¹æ³• æƒé™ç®¡ç†</h3><p>åŸºäºæ–¹æ³•çš„æƒé™ç®¡ç†ä¸»è¦æ˜¯é€šè¿‡ A0P æ¥å®ç°çš„ï¼ŒSpring Security ä¸­é€šè¿‡ MethodSecurityInterceptor æ¥æä¾›ç›¸å…³çš„å®ç°ã€‚ä¸åŒåœ¨äº FilterSecurityInterceptor åªæ˜¯åœ¨è¯·æ±‚ä¹‹å‰è¿›è¡Œå‰ç½®å¤„ç†ï¼ŒMethodSecurityInterceptor é™¤äº†å‰ç½®å¤„ç†ä¹‹å¤–è¿˜å¯ä»¥è¿›è¡Œåç½®å¤„ç†ã€‚å‰ç½®å¤„ç†å°±æ˜¯åœ¨è¯·æ±‚ä¹‹å‰åˆ¤æ–­æ˜¯å¦å…·å¤‡ç›¸åº”çš„æƒé™ï¼Œåç½®å¤„ç†åˆ™æ˜¯å¯¹æ–¹æ³•çš„æ‰§è¡Œç»“æœè¿›è¡ŒäºŒæ¬¡è¿‡æ»¤ã€‚å‰ç½®å¤„ç†å’Œåç½®å¤„ç†åˆ†åˆ«å¯¹åº”äº†ä¸åŒçš„å®ç°ç±»ã€‚</p><h4 id="EnableGlobalMethodSecurity"><a href="#EnableGlobalMethodSecurity" class="headerlink" title="@EnableGlobalMethodSecurity"></a>@EnableGlobalMethodSecurity</h4><p>EnableGlobalMethodSecurity è¯¥æ³¨è§£æ˜¯ç”¨æ¥å¼€å¯æƒé™æ³¨è§£ï¼Œç”¨æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableGlobalMethodSecurity(prePostEnabled=true,securedEnabled=true, jsr250Enabled=true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebsecurityConfigurerAdapter</span>&#123;&#125;</span><br></pre></td></tr></table></figure><ul><li><strong>perPostEnabled</strong>: å¼€å¯ Spring Security æä¾›çš„å››ä¸ªæƒé™æ³¨è§£ï¼Œ@PostAuthorizeã€@PostFilterã€@PreAuthorize ä»¥åŠ@PreFilterã€‚</li><li><strong>securedEnabled</strong>: å¼€å¯ Spring Security æä¾›çš„ @Secured æ³¨è§£æ”¯æŒï¼Œè¯¥æ³¨è§£ä¸æ”¯æŒæƒé™è¡¨è¾¾å¼</li><li><strong>jsr250Enabled</strong>: å¼€å¯ JSR-250 æä¾›çš„æ³¨è§£ï¼Œä¸»è¦æ˜¯@DenyAllã€@PermitAllã€@RolesAll åŒæ ·è¿™äº›æ³¨è§£ä¹Ÿä¸æ”¯æŒæƒé™è¡¨è¾¾å¼</li></ul><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># ä»¥ä¸Šæ³¨è§£å«ä¹‰å¦‚ä¸‹:</span></span><br><span class="line"><span class="bullet">-</span> @PostAuthorizeï¼š åœ¨ç›®å‰æ ‡æ–¹æ³•æ‰§è¡Œä¹‹åè¿›è¡Œæƒé™æ ¡éªŒã€‚</span><br><span class="line"><span class="bullet">-</span> @PostFiterï¼š åœ¨ç›®æ ‡æ–¹æ³•æ‰§è¡Œä¹‹åå¯¹æ–¹æ³•çš„è¿”å›ç»“æœè¿›è¡Œè¿‡æ»¤ã€‚</span><br><span class="line"><span class="bullet">-</span> @PreAuthorizeï¼šåœ¨ç›®æ ‡æ–¹æ³•æ‰§è¡Œä¹‹å‰è¿›è¡Œæƒé™æ ¡éªŒã€‚</span><br><span class="line"><span class="bullet">-</span> @PreFiterï¼šåœ¨ç›®å‰æ ‡æ–¹æ³•æ‰§è¡Œä¹‹å‰å¯¹æ–¹æ³•å‚æ•°è¿›è¡Œè¿‡æ»¤ã€‚</span><br><span class="line"><span class="bullet">-</span> @Securedï¼šè®¿é—®ç›®æ ‡æ–¹æ³•å¿…é¡»å…·å„ç›¸åº”çš„è§’è‰²ã€‚</span><br><span class="line"><span class="bullet">-</span> @DenyAllï¼šæ‹’ç»æ‰€æœ‰è®¿é—®ã€‚</span><br><span class="line"><span class="bullet">-</span> @PermitAllï¼šå…è®¸æ‰€æœ‰è®¿é—®ã€‚</span><br><span class="line"><span class="bullet">-</span> @RolesAllowedï¼šè®¿é—®ç›®æ ‡æ–¹æ³•å¿…é¡»å…·å¤‡ç›¸åº”çš„è§’è‰²ã€‚</span><br></pre></td></tr></table></figure><p>è¿™äº›åŸºäºæ–¹æ³•çš„æƒé™ç®¡ç†ç›¸å…³çš„æ³¨è§£ï¼Œä¸€èˆ¬æ¥è¯´åªè¦è®¾ç½® <strong>prePostEnabled&#x3D;true</strong> å°±å¤Ÿç”¨äº†ã€‚</p><h4 id="åŸºæœ¬ç”¨æ³•"><a href="#åŸºæœ¬ç”¨æ³•" class="headerlink" title="åŸºæœ¬ç”¨æ³•"></a>åŸºæœ¬ç”¨æ³•</h4><ul><li>å¼€å¯æ³¨è§£ä½¿ç”¨</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableGlobalMethodSecurity(prePostEnabled=true,securedEnabled=true, jsr250Enabled=true)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebsecurityConfigurerAdapter</span>&#123;&#125;</span><br></pre></td></tr></table></figure><ul><li>ä½¿ç”¨æ³¨è§£</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/hello&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthorizeMethodController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PreAuthorize(&quot;hasRole(&#x27;ADMIN&#x27;) and authentication.name==&#x27;root&#x27;&quot;)</span></span><br><span class="line">    <span class="meta">@GetMapping</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PreAuthorize(&quot;authentication.name==#name&quot;)</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/name&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;hello:&quot;</span> + name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PreFilter(value = &quot;filterObject.id%2!=0&quot;,filterTarget = &quot;users&quot;)</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/users&quot;)</span>  <span class="comment">//filterTarget å¿…é¡»æ˜¯ æ•°ç»„  é›†åˆ</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addUsers</span><span class="params">(<span class="meta">@RequestBody</span> List&lt;User&gt; users)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;users = &quot;</span> + users);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostAuthorize(&quot;returnObject.id==1&quot;)</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/userId&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">getUserById</span><span class="params">(Integer id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">User</span>(id, <span class="string">&quot;blr&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostFilter(&quot;filterObject.id%2==0&quot;)</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/lists&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;User&gt; <span class="title function_">getAll</span><span class="params">()</span> &#123;</span><br><span class="line">        List&lt;User&gt; users = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            users.add(<span class="keyword">new</span> <span class="title class_">User</span>(i, <span class="string">&quot;blr:&quot;</span> + i));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> users;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Secured(&#123;&quot;ROLE_USER&quot;&#125;)</span> <span class="comment">//åªèƒ½åˆ¤æ–­è§’è‰²</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/secured&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">getUserByUsername</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="number">99</span>, <span class="string">&quot;secured&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Secured(&#123;&quot;ROLE_ADMIN&quot;,&quot;ROLE_USER&quot;&#125;)</span> <span class="comment">//å…·æœ‰å…¶ä¸­ä¸€ä¸ªå³å¯</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/username&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> User <span class="title function_">getUserByUsername2</span><span class="params">(String username)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="number">99</span>, username);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PermitAll</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/permitAll&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">permitAll</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;PermitAll&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@DenyAll</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/denyAll&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">denyAll</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;DenyAll&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RolesAllowed(&#123;&quot;ROLE_ADMIN&quot;,&quot;ROLE_USER&quot;&#125;)</span> <span class="comment">//å…·æœ‰å…¶ä¸­ä¸€ä¸ªè§’è‰²å³å¯</span></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/rolesAllowed&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">rolesAllowed</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;RolesAllowed&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="åŸç†åˆ†æ-2"><a href="#åŸç†åˆ†æ-2" class="headerlink" title="åŸç†åˆ†æ"></a>åŸç†åˆ†æ</h2><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220618140440796.png" class=""><ul><li><strong>ConfigAttribute</strong> åœ¨ Spring Security ä¸­ï¼Œç”¨æˆ·è¯·æ±‚ä¸€ä¸ªèµ„æº(é€šå¸¸æ˜¯ä¸€ä¸ªæ¥å£æˆ–è€…ä¸€ä¸ª Java æ–¹æ³•)éœ€è¦çš„è§’è‰²ä¼šè¢«å°è£…æˆä¸€ä¸ª ConfigAttribute å¯¹è±¡ï¼Œåœ¨ ConfigAttribute ä¸­åªæœ‰ä¸€ä¸ª getAttributeæ–¹æ³•ï¼Œè¯¥æ–¹æ³•è¿”å›ä¸€ä¸ª String å­—ç¬¦ä¸²ï¼Œå°±æ˜¯è§’è‰²çš„åç§°ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œè§’è‰²åç§°éƒ½å¸¦æœ‰ä¸€ä¸ª <code>ROLE_</code> å‰ç¼€ï¼ŒæŠ•ç¥¨å™¨ AccessDecisionVoter æ‰€åšçš„äº‹æƒ…ï¼Œå…¶å®å°±æ˜¯æ¯”è¾ƒç”¨æˆ·æ‰€å…·å„çš„è§’è‰²å’Œè¯·æ±‚æŸä¸ªèµ„æºæ‰€éœ€çš„ ConfigAtuibute ä¹‹é—´çš„å…³ç³»ã€‚</li><li><strong>AccesDecisionVoter å’Œ AccessDecisionManager</strong> éƒ½æœ‰ä¼—å¤šçš„å®ç°ç±»ï¼Œåœ¨ AccessDecisionManager ä¸­ä¼šæ¢ä¸ªéå† AccessDecisionVoterï¼Œè¿›è€Œå†³å®šæ˜¯å¦å…è®¸ç”¨æˆ·è®¿é—®ï¼Œå› è€Œ AaccesDecisionVoter å’Œ AccessDecisionManager ä¸¤è€…çš„å…³ç³»ç±»ä¼¼äº AuthenticationProvider å’Œ ProviderManager çš„å…³ç³»ã€‚</li></ul><h2 id="å®æˆ˜-1"><a href="#å®æˆ˜-1" class="headerlink" title="å®æˆ˜"></a>å®æˆ˜</h2><p>åœ¨å‰é¢çš„æ¡ˆä¾‹ä¸­ï¼Œæˆ‘ä»¬é…ç½®çš„ URL æ‹¦æˆªè§„åˆ™å’Œè¯·æ±‚ URL æ‰€éœ€è¦çš„æƒé™éƒ½æ˜¯é€šè¿‡ä»£ç æ¥é…ç½®çš„ï¼Œè¿™æ ·å°±æ¯”è¾ƒæ­»æ¿ï¼Œå¦‚æœæƒ³è¦è°ƒæ•´è®¿é—®æŸä¸€ä¸ª URL æ‰€éœ€è¦çš„æƒé™ï¼Œå°±éœ€è¦ä¿®æ”¹ä»£ç ã€‚</p><p>åŠ¨æ€ç®¡ç†æƒé™è§„åˆ™å°±æ˜¯æˆ‘ä»¬å°† URL æ‹¦æˆªè§„åˆ™å’Œè®¿é—® URI æ‰€éœ€è¦çš„æƒé™éƒ½ä¿å­˜åœ¨æ•°æ®åº“ä¸­ï¼Œè¿™æ ·ï¼Œåœ¨ä¸ä¿®æ”¹æºä»£ç çš„æƒ…å†µä¸‹ï¼Œåªéœ€è¦ä¿®æ”¹æ•°æ®åº“ä¸­çš„æ•°æ®ï¼Œå°±å¯ä»¥å¯¹æƒé™è¿›è¡Œè°ƒæ•´ã€‚</p><p><code>ç”¨æˆ·&lt;--ä¸­é—´è¡¨--&gt; è§’è‰² &lt;--ä¸­é—´è¡¨--&gt; èœå•</code></p><h3 id="åº“è¡¨è®¾è®¡"><a href="#åº“è¡¨è®¾è®¡" class="headerlink" title="åº“è¡¨è®¾è®¡"></a>åº“è¡¨è®¾è®¡</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">SET</span> NAMES utf8mb4;</span><br><span class="line"><span class="keyword">SET</span> FOREIGN_KEY_CHECKS <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for menu</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `menu`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `menu` (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `<span class="keyword">pattern</span>` <span class="type">varchar</span>(<span class="number">128</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">4</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Records of menu</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `menu` <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">&#x27;/admin/**&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `menu` <span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="string">&#x27;/user/**&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `menu` <span class="keyword">VALUES</span> (<span class="number">3</span>, <span class="string">&#x27;/guest/**&#x27;</span>);</span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for menu_role</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `menu_role`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `menu_role` (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `mid` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `rid` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  KEY `mid` (`mid`),</span><br><span class="line">  KEY `rid` (`rid`),</span><br><span class="line">  <span class="keyword">CONSTRAINT</span> `menu_role_ibfk_1` <span class="keyword">FOREIGN</span> KEY (`mid`) <span class="keyword">REFERENCES</span> `menu` (`id`),</span><br><span class="line">  <span class="keyword">CONSTRAINT</span> `menu_role_ibfk_2` <span class="keyword">FOREIGN</span> KEY (`rid`) <span class="keyword">REFERENCES</span> `role` (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">5</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Records of menu_role</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `menu_role` <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `menu_role` <span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `menu_role` <span class="keyword">VALUES</span> (<span class="number">3</span>, <span class="number">3</span>, <span class="number">3</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `menu_role` <span class="keyword">VALUES</span> (<span class="number">4</span>, <span class="number">3</span>, <span class="number">2</span>);</span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for role</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `role`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `role` (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `name` <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `nameZh` <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">4</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Records of role</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `role` <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">&#x27;ROLE_ADMIN&#x27;</span>, <span class="string">&#x27;ç³»ç»Ÿç®¡ç†å‘˜&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `role` <span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="string">&#x27;ROLE_USER&#x27;</span>, <span class="string">&#x27;æ™®é€šç”¨æˆ·&#x27;</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `role` <span class="keyword">VALUES</span> (<span class="number">3</span>, <span class="string">&#x27;ROLE_GUEST&#x27;</span>, <span class="string">&#x27;æ¸¸å®¢&#x27;</span>);</span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for user</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `<span class="keyword">user</span>`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `<span class="keyword">user</span>` (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `username` <span class="type">varchar</span>(<span class="number">32</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `password` <span class="type">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `enabled` tinyint(<span class="number">1</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `locked` tinyint(<span class="number">1</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">4</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Records of user</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `<span class="keyword">user</span>` <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">&#x27;admin&#x27;</span>, <span class="string">&#x27;&#123;noop&#125;123&#x27;</span>, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `<span class="keyword">user</span>` <span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="string">&#x27;user&#x27;</span>, <span class="string">&#x27;&#123;noop&#125;123&#x27;</span>, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `<span class="keyword">user</span>` <span class="keyword">VALUES</span> (<span class="number">3</span>, <span class="string">&#x27;blr&#x27;</span>, <span class="string">&#x27;&#123;noop&#125;123&#x27;</span>, <span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for user_role</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `user_role`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `user_role` (</span><br><span class="line">  `id` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  `uid` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `rid` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`id`),</span><br><span class="line">  KEY `uid` (`uid`),</span><br><span class="line">  KEY `rid` (`rid`),</span><br><span class="line">  <span class="keyword">CONSTRAINT</span> `user_role_ibfk_1` <span class="keyword">FOREIGN</span> KEY (`uid`) <span class="keyword">REFERENCES</span> `<span class="keyword">user</span>` (`id`),</span><br><span class="line">  <span class="keyword">CONSTRAINT</span> `user_role_ibfk_2` <span class="keyword">FOREIGN</span> KEY (`rid`) <span class="keyword">REFERENCES</span> `role` (`id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB AUTO_INCREMENT<span class="operator">=</span><span class="number">5</span> <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Records of user_role</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">BEGIN</span>;</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `user_role` <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `user_role` <span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="number">1</span>, <span class="number">2</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `user_role` <span class="keyword">VALUES</span> (<span class="number">3</span>, <span class="number">2</span>, <span class="number">2</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `user_role` <span class="keyword">VALUES</span> (<span class="number">4</span>, <span class="number">3</span>, <span class="number">3</span>);</span><br><span class="line"><span class="keyword">COMMIT</span>;</span><br><span class="line"><span class="keyword">SET</span> FOREIGN_KEY_CHECKS <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure><h3 id="åˆ›å»º-springboot-åº”ç”¨"><a href="#åˆ›å»º-springboot-åº”ç”¨" class="headerlink" title="åˆ›å»º springboot åº”ç”¨"></a>åˆ›å»º springboot åº”ç”¨</h3><ul><li><p>å¼•å…¥ä¾èµ–</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.38<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>druid<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.8<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>é…ç½®é…ç½®æ–‡ä»¶</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server.port</span>=<span class="string">8080</span></span><br><span class="line"><span class="attr">spring.datasource.type</span>=<span class="string">com.alibaba.druid.pool.DruidDataSource</span></span><br><span class="line"><span class="attr">spring.datasource.driver-class-name</span>=<span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line"><span class="attr">spring.datasource.url</span>=<span class="string">jdbc:mysql://localhost:3306/security?characterEncoding=UTF-8</span></span><br><span class="line"><span class="attr">spring.datasource.username</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">spring.datasource.password</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">mybatis.mapper-locations</span>=<span class="string">classpath:com/blr/mapper/*.xml</span></span><br><span class="line"><span class="attr">mybatis.type-aliases-package</span>=<span class="string">com.blr.entity</span></span><br></pre></td></tr></table></figure></li><li><p>åˆ›å»ºå®ä½“ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> <span class="keyword">implements</span> <span class="title class_">UserDetails</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> enabled;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> locked;</span><br><span class="line">    <span class="keyword">private</span> List&lt;Role&gt; roles;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Collection&lt;? <span class="keyword">extends</span> <span class="title class_">GrantedAuthority</span>&gt; getAuthorities() &#123;</span><br><span class="line">        <span class="keyword">return</span> roles.stream().map(r -&gt; <span class="keyword">new</span> <span class="title class_">SimpleGrantedAuthority</span>(r.getName())).collect(Collectors.toList());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getPassword</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getUsername</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> username;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isAccountNonExpired</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isAccountNonLocked</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> !locked;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isCredentialsNonExpired</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isEnabled</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> enabled;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setId</span><span class="params">(Integer id)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setPassword</span><span class="params">(String password)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.password = password;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUsername</span><span class="params">(String username)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.username = username;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setEnabled</span><span class="params">(<span class="type">boolean</span> enabled)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.enabled = enabled;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setLocked</span><span class="params">(<span class="type">boolean</span> locked)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.locked = locked;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setRoles</span><span class="params">(List&lt;Role&gt; roles)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.roles = roles;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">getId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;Role&gt; <span class="title function_">getRoles</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> roles;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Role</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String nameZh;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">getId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setId</span><span class="params">(Integer id)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getNameZh</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> nameZh;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setNameZh</span><span class="params">(String nameZh)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.nameZh = nameZh;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Menu</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> String pattern;</span><br><span class="line">    <span class="keyword">private</span> List&lt;Role&gt; roles;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;Role&gt; <span class="title function_">getRoles</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> roles;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setRoles</span><span class="params">(List&lt;Role&gt; roles)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.roles = roles;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">getId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setId</span><span class="params">(Integer id)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getPattern</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> pattern;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setPattern</span><span class="params">(String pattern)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.pattern = pattern;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>åˆ›å»º mapper æ¥å£</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserMapper</span> &#123;</span><br><span class="line">    List&lt;Role&gt; <span class="title function_">getUserRoleByUid</span><span class="params">(Integer uid)</span>;</span><br><span class="line">    User <span class="title function_">loadUserByUsername</span><span class="params">(String username)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">MenuMapper</span> &#123;</span><br><span class="line">    List&lt;Menu&gt; <span class="title function_">getAllMenu</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>åˆ›å»º mapper æ–‡ä»¶</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span></span></span><br><span class="line"><span class="meta">        <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span></span></span><br><span class="line"><span class="meta">        <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.blr.mapper.UserMapper&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;loadUserByUsername&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;com.blr.entity.User&quot;</span>&gt;</span></span><br><span class="line">        select *</span><br><span class="line">        from user</span><br><span class="line">        where username = #&#123;username&#125;;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;getUserRoleByUid&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;com.blr.entity.Role&quot;</span>&gt;</span></span><br><span class="line">        select r.*</span><br><span class="line">        from role r,</span><br><span class="line">             user_role ur</span><br><span class="line">        where ur.uid = #&#123;uid&#125;</span><br><span class="line">          and ur.rid = r.id</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.blr.mapper.MenuMapper&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">resultMap</span> <span class="attr">id</span>=<span class="string">&quot;MenuResultMap&quot;</span> <span class="attr">type</span>=<span class="string">&quot;com.blr.entity.Menu&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">id</span> <span class="attr">property</span>=<span class="string">&quot;id&quot;</span> <span class="attr">column</span>=<span class="string">&quot;id&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">result</span> <span class="attr">property</span>=<span class="string">&quot;pattern&quot;</span> <span class="attr">column</span>=<span class="string">&quot;pattern&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">result</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">collection</span> <span class="attr">property</span>=<span class="string">&quot;roles&quot;</span> <span class="attr">ofType</span>=<span class="string">&quot;com.blr.entity.Role&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span> <span class="attr">column</span>=<span class="string">&quot;rid&quot;</span> <span class="attr">property</span>=<span class="string">&quot;id&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;rname&quot;</span> <span class="attr">property</span>=<span class="string">&quot;name&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">result</span> <span class="attr">column</span>=<span class="string">&quot;rnameZh&quot;</span> <span class="attr">property</span>=<span class="string">&quot;nameZh&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">collection</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">resultMap</span>&gt;</span></span><br><span class="line">  </span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;getAllMenu&quot;</span> <span class="attr">resultMap</span>=<span class="string">&quot;MenuResultMap&quot;</span>&gt;</span></span><br><span class="line">        select m.*, r.id as rid, r.name as rname, r.nameZh as rnameZh</span><br><span class="line">        from menu m</span><br><span class="line">                 left join menu_role mr on m.`id` = mr.`mid`</span><br><span class="line">                 left join role r on r.`id` = mr.`rid`</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure></li><li><p>åˆ›å»º service æ¥å£</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserService</span> <span class="keyword">implements</span> <span class="title class_">UserDetailsService</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserMapper userMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">UserService</span><span class="params">(UserMapper userMapper)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.userMapper = userMapper;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> UserDetails <span class="title function_">loadUserByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException &#123;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userMapper.loadUserByUsername(username);</span><br><span class="line">        <span class="keyword">if</span> (user == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UsernameNotFoundException</span>(<span class="string">&quot;ç”¨æˆ·ä¸å­˜åœ¨&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        user.setRoles(userMapper.getUserRoleByUid(user.getId()));</span><br><span class="line">        <span class="keyword">return</span> user;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MenuService</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MenuMapper menuMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MenuService</span><span class="params">(MenuMapper menuMapper)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.menuMapper = menuMapper;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> List&lt;Menu&gt; <span class="title function_">getAllMenu</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> menuMapper.getAllMenu();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>åˆ›å»ºæµ‹è¯• controller</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloController</span> &#123;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/admin/hello&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">admin</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;hello admin&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/user/hello&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">user</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;hello user&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/guest/hello&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">guest</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;hello guest&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/hello&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>åˆ›å»º CustomSecurityMetadataSource</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomSecurityMetadataSource</span> <span class="keyword">implements</span> <span class="title class_">FilterInvocationSecurityMetadataSource</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MenuService menuService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CustomSecurityMetadataSource</span><span class="params">(MenuService menuService)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.menuService = menuService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">AntPathMatcher</span> <span class="variable">antPathMatcher</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AntPathMatcher</span>();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Collection&lt;ConfigAttribute&gt; <span class="title function_">getAttributes</span><span class="params">(Object object)</span> <span class="keyword">throws</span> IllegalArgumentException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">requestURI</span> <span class="operator">=</span> ((FilterInvocation) object).getRequest().getRequestURI();</span><br><span class="line">        List&lt;Menu&gt; allMenu = menuService.getAllMenu();</span><br><span class="line">        <span class="keyword">for</span> (Menu menu : allMenu) &#123;</span><br><span class="line">            <span class="keyword">if</span> (antPathMatcher.match(menu.getPattern(), requestURI)) &#123;</span><br><span class="line">                String[] roles = menu.getRoles().stream().map(r -&gt; r.getName()).toArray(String[]::<span class="keyword">new</span>);</span><br><span class="line">                <span class="keyword">return</span> SecurityConfig.createList(roles);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Collection&lt;ConfigAttribute&gt; <span class="title function_">getAllConfigAttributes</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">supports</span><span class="params">(Class&lt;?&gt; clazz)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> FilterInvocation.class.isAssignableFrom(clazz);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>é…ç½® Security é…ç½®</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CustomSecurityMetadataSource customSecurityMetadataSource;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">SecurityConfig</span><span class="params">(CustomSecurityMetadataSource customSecurityMetadataSource, UserService userService)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.customSecurityMetadataSource = customSecurityMetadataSource;</span><br><span class="line">        <span class="built_in">this</span>.userService = userService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        auth.userDetailsService(userService);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> http.getSharedObject(ApplicationContext.class);</span><br><span class="line">        http.apply(<span class="keyword">new</span> <span class="title class_">UrlAuthorizationConfigurer</span>&lt;&gt;(applicationContext))</span><br><span class="line">                .withObjectPostProcessor(<span class="keyword">new</span> <span class="title class_">ObjectPostProcessor</span>&lt;FilterSecurityInterceptor&gt;() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> &lt;O <span class="keyword">extends</span> <span class="title class_">FilterSecurityInterceptor</span>&gt; O <span class="title function_">postProcess</span><span class="params">(O object)</span> &#123;</span><br><span class="line">                        object.setSecurityMetadataSource(customSecurityMetadataSource);</span><br><span class="line">                        object.setRejectPublicInvocations(<span class="literal">true</span>);</span><br><span class="line">                        <span class="keyword">return</span> object;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">        http.formLogin()</span><br><span class="line">                .and()</span><br><span class="line">                .csrf().disable();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>å¯åŠ¨å…¥å£ç±»è¿›è¡Œæµ‹è¯•</p></li></ul><h1 id="ç¬¬åäºŒç« -OAuth2"><a href="#ç¬¬åäºŒç« -OAuth2" class="headerlink" title="ç¬¬åäºŒç«  OAuth2"></a>ç¬¬åäºŒç«  OAuth2</h1><ul><li>OAuth2 ç®€ä»‹</li><li>å››ç§æˆæƒæ¨¡å¼</li><li>Spring Security OAuth2</li><li>GitHub æˆæƒç™»å½•</li><li>æˆæƒæœåŠ¡å™¨ä¸èµ„æºæœåŠ¡å™¨</li><li>ä½¿ç”¨ JWT</li></ul><h2 id="OAuth2-ç®€ä»‹"><a href="#OAuth2-ç®€ä»‹" class="headerlink" title="OAuth2 ç®€ä»‹"></a>OAuth2 ç®€ä»‹</h2><p>OAuth æ˜¯ä¸€ä¸ªå¼€æ”¾çš„éå¸¸é‡è¦çš„è®¤è¯æ ‡å‡†&#x2F;åè®®ï¼Œè¯¥æ ‡å‡†å…è®¸ç”¨æˆ·è®©ç¬¬ä¸‰æ–¹åº”ç”¨è®¿é—®è¯¥ç”¨æˆ·åœ¨æŸä¸€ç½‘ç«™ä¸Šå­˜å‚¨çš„ç§å¯†èµ„æºï¼ˆå¦‚å¤´åƒã€ç…§ç‰‡ã€è§†é¢‘ç­‰ï¼‰ï¼Œå¹¶ä¸”åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­æ— é¡»å°†ç”¨æˆ·åå’Œå¯†ç æä¾›ç»™ç¬¬ä¸‰æ–¹åº”ç”¨ã€‚é€šè¿‡ä»¤ç‰Œï¼ˆtokenï¼‰å¯ä»¥å®ç°è¿™ä¸€åŠŸèƒ½ï¼Œæ¯ä¸€ä¸ªä»¤ç‰Œæˆæƒä¸€ä¸ªç‰¹å®šçš„ç½‘ç«™åœ¨ç‰¹å®šçš„æ—¶æ®µå†…å…è®¸å¯ç‰¹å®šçš„èµ„æºã€‚OAuth è®©ç”¨æˆ·å¯ä»¥æˆæƒç¬¬ä¸‰æ–¹ç½‘ç«™çµæ´»è®¿é—®å®ƒä»¬å­˜å‚¨åœ¨å¦å¤–ä¸€äº›èµ„æºæœåŠ¡å™¨ä¸Šçš„ç‰¹å®šä¿¡æ¯ï¼Œè€Œéæ‰€æœ‰å†…å®¹ã€‚å¯¹äºç”¨æˆ·è€Œè¨€ï¼Œæˆ‘ä»¬åœ¨äº’è”ç½‘åº”ç”¨ä¸­æœ€å¸¸è§çš„ OAuth åº”ç”¨å°±æ˜¯å„ç§ç¬¬ä¸‰æ–¹ç™»å½•ï¼Œä¾‹å¦‚QQæˆæƒç™»å½•ã€å¾®ä¿¡æˆæƒç™»å½•ã€å¾®åšæˆæƒç™»å½•ã€GitHub æˆæƒç™»å½•ç­‰ã€‚</p><p>ä¾‹å¦‚ç”¨æˆ·æƒ³ç™»å½• Ruby Chinaï¼Œä¼ ç»Ÿæ–¹å¼æ˜¯ä½¿ç”¨ç”¨æˆ·åå¯†ç ä½†æ˜¯è¿™æ ·å¹¶ä¸å®‰å…¨ï¼Œå› ä¸ºç½‘ç«™ä¼šå­˜å‚¨ä½ çš„ç”¨æˆ·åå¯†ç ï¼Œè¿™æ ·å¯èƒ½ä¼šå¯¼è‡´å¯†ç æ³„éœ²ã€‚è¿™ç§æˆæƒæ–¹å¼å®‰å…¨éšæ‚£å¾ˆå¤§ï¼Œå¦‚æœä½¿ç”¨ OAuth åè®®å°±èƒ½å¾ˆå¥½åœ°è§£å†³è¿™ä¸€é—®é¢˜ã€‚</p><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220711201517843.png" class=""><blockquote><p>æ³¨æ„: OAuth2 æ˜¯OAuth åè®®çš„ä¸‹ä¸€ç‰ˆæœ¬ï¼Œä½†ä¸å…¼å®¹ OAuth 1.0ã€‚ OAuth2 å…³æ³¨å®¢æˆ·ç«¯å¼€å‘è€…çš„ç®€æ˜“æ€§ï¼ŒåŒæ—¶ä¸º Web åº”ç”¨ã€æ¡Œé¢åº”ç”¨ã€ç§»åŠ¨è®¾å¤‡ã€IoT è®¾å¤‡æä¾›ä¸“é—¨çš„è®¤è¯æµç¨‹ã€‚</p></blockquote><h2 id="OAuth2-æˆæƒæ€»ä½“æµç¨‹"><a href="#OAuth2-æˆæƒæ€»ä½“æµç¨‹" class="headerlink" title="OAuth2 æˆæƒæ€»ä½“æµç¨‹"></a>OAuth2 æˆæƒæ€»ä½“æµç¨‹</h2><p>è§’è‰²æ¢³ç†:    ç¬¬ä¸‰æ–¹åº”ç”¨   &lt;â€”-&gt;  å­˜å‚¨ç”¨æˆ·ç§å¯†ä¿¡æ¯åº”ç”¨  â€”-&gt; æˆæƒæœåŠ¡å™¨  â€”-&gt; èµ„æºæœåŠ¡å™¨</p><p>æ•´ä½“æµç¨‹å¦‚ä¸‹:ï¼ˆå›¾ç‰‡æ¥è‡ª RFC6749æ–‡æ¡£ <a href="https://tools.ietf.org/html/rfc6749">https://tools.ietf.org/html/rfc6749</a>)</p><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220625085816021.png" class=""><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> ï¼ˆAï¼‰ç”¨æˆ·æ‰“å¼€å®¢æˆ·ç«¯ä»¥åï¼Œå®¢æˆ·ç«¯è¦æ±‚ç”¨æˆ·ç»™äºˆæˆæƒã€‚</span><br><span class="line"><span class="bullet">-</span> ï¼ˆBï¼‰ç”¨æˆ·åŒæ„ç»™äºˆå®¢æˆ·ç«¯æˆæƒã€‚</span><br><span class="line"><span class="bullet">-</span> ï¼ˆCï¼‰å®¢æˆ·ç«¯ä½¿ç”¨ä¸Šä¸€æ­¥è·å¾—çš„æˆæƒï¼Œå‘è®¤è¯æœåŠ¡å™¨ç”³è¯·ä»¤ç‰Œã€‚</span><br><span class="line"><span class="bullet">-</span> ï¼ˆDï¼‰è®¤è¯æœåŠ¡å™¨å¯¹å®¢æˆ·ç«¯è¿›è¡Œè®¤è¯ä»¥åï¼Œç¡®è®¤æ— è¯¯ï¼ŒåŒæ„å‘æ”¾ä»¤ç‰Œã€‚</span><br><span class="line"><span class="bullet">-</span> ï¼ˆEï¼‰å®¢æˆ·ç«¯ä½¿ç”¨ä»¤ç‰Œï¼Œå‘èµ„æºæœåŠ¡å™¨ç”³è¯·è·å–èµ„æºã€‚</span><br><span class="line"><span class="bullet">-</span> ï¼ˆFï¼‰èµ„æºæœåŠ¡å™¨ç¡®è®¤ä»¤ç‰Œæ— è¯¯ï¼ŒåŒæ„å‘å®¢æˆ·ç«¯å¼€æ”¾èµ„æºã€‚</span><br></pre></td></tr></table></figure><p>ä»ä¸Šå›¾ä¸­æˆ‘ä»¬å¯ä»¥çœ‹å‡ºå…­ä¸ªæ­¥éª¤ä¹‹ä¸­ï¼ŒBæ˜¯å…³é”®ï¼Œå³ç”¨æˆ·æ€æ ·æ‰èƒ½ç»™äºå®¢æˆ·ç«¯æˆæƒã€‚åŒæ—¶ä¼šå‘ç° OAuth2 ä¸­åŒ…å«å››ç§ä¸åŒçš„è§’è‰²ï¼š</p><ul><li><strong>Clientï¼š</strong>ç¬¬ä¸‰æ–¹åº”ç”¨ã€‚</li><li><strong>Resource Owner</strong>ï¼šèµ„æºæ‰€æœ‰è€…ã€‚</li><li><strong>Authorization Server</strong> ï¼šæˆæƒæœåŠ¡å™¨ã€‚</li><li><strong>Resource Server</strong>ï¼š èµ„æºæœåŠ¡å™¨ã€‚</li></ul><h2 id="å››ç§æˆæƒæ¨¡å¼"><a href="#å››ç§æˆæƒæ¨¡å¼" class="headerlink" title="å››ç§æˆæƒæ¨¡å¼"></a>å››ç§æˆæƒæ¨¡å¼</h2><h3 id="æˆæƒç æ¨¡å¼"><a href="#æˆæƒç æ¨¡å¼" class="headerlink" title="æˆæƒç æ¨¡å¼"></a>æˆæƒç æ¨¡å¼</h3><p><strong>æˆæƒç æ¨¡å¼ï¼ˆ<code>Authorization Code</code>ï¼‰</strong> æ˜¯åŠŸèƒ½æœ€å®Œæ•´ã€æµç¨‹æœ€ä¸¥å¯†ã€æœ€å®‰å…¨å¹¶ä¸”ä½¿ç”¨æœ€å¹¿æ³›çš„ä¸€ç§OAuth2æˆæƒæ¨¡å¼ã€‚åŒæ—¶ä¹Ÿæ˜¯æœ€å¤æ‚çš„ä¸€ç§æˆæƒæ¨¡å¼ï¼Œå®ƒçš„ç‰¹ç‚¹å°±æ˜¯é€šè¿‡å®¢æˆ·ç«¯çš„åå°æœåŠ¡å™¨ï¼Œä¸<code>æœåŠ¡æä¾›å•†</code>çš„è®¤è¯æœåŠ¡å™¨è¿›è¡Œäº’åŠ¨ã€‚å…¶å…·ä½“çš„æˆæƒæµç¨‹å¦‚å›¾æ‰€ç¤ºï¼ˆå›¾ç‰‡æ¥è‡ª RFC6749æ–‡æ¡£ <a href="https://tools.ietf.org/html/rfc6749">https://tools.ietf.org/html/rfc6749</a>)</p><ul><li>Third-party applicationï¼šç¬¬ä¸‰æ–¹åº”ç”¨ç¨‹åºï¼Œç®€ç§°â€å®¢æˆ·ç«¯â€ï¼ˆclientï¼‰ï¼›</li><li>Resource Ownerï¼šèµ„æºæ‰€æœ‰è€…ï¼Œç®€ç§°â€ç”¨æˆ·â€ï¼ˆuserï¼‰ï¼›</li><li>User Agentï¼šç”¨æˆ·ä»£ç†ï¼Œæ˜¯æŒ‡æµè§ˆå™¨ï¼›</li><li>Authorization Serverï¼šè®¤è¯æœåŠ¡å™¨ï¼Œå³æœåŠ¡ç«¯ä¸“é—¨ç”¨æ¥å¤„ç†è®¤è¯çš„æœåŠ¡å™¨ï¼›</li><li>Resource Serverï¼šèµ„æºæœåŠ¡å™¨ï¼Œå³æœåŠ¡ç«¯å­˜æ”¾ç”¨æˆ·ç”Ÿæˆçš„èµ„æºçš„æœåŠ¡å™¨ã€‚å®ƒä¸è®¤è¯æœåŠ¡å™¨ï¼Œå¯ä»¥æ˜¯åŒä¸€å°æœåŠ¡å™¨ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸åŒçš„æœåŠ¡å™¨ã€‚</li></ul><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220625090018332.png" class=""><p>å…·ä½“æµç¨‹å¦‚ä¸‹:</p><ul><li><p>ï¼ˆAï¼‰ç”¨æˆ·è®¿é—®ç¬¬ä¸‰æ–¹åº”ç”¨ï¼Œç¬¬ä¸‰æ–¹åº”ç”¨é€šè¿‡æµè§ˆå™¨å¯¼å‘è®¤è¯æœåŠ¡å™¨ã€‚</p></li><li><p>ï¼ˆBï¼‰ç”¨æˆ·é€‰æ‹©æ˜¯å¦ç»™äºˆå®¢æˆ·ç«¯æˆæƒã€‚</p></li><li><p>ï¼ˆCï¼‰å‡è®¾ç”¨æˆ·ç»™äºˆæˆæƒï¼Œè®¤è¯æœåŠ¡å™¨å°†ç”¨æˆ·å¯¼å‘å®¢æˆ·ç«¯äº‹å…ˆæŒ‡å®šçš„â€é‡å®šå‘URIâ€ï¼ˆredirection URIï¼‰ï¼ŒåŒæ—¶é™„ä¸Šä¸€ä¸ªæˆæƒç ã€‚</p></li><li><p>ï¼ˆDï¼‰å®¢æˆ·ç«¯æ”¶åˆ°æˆæƒç ï¼Œé™„ä¸Šæ—©å…ˆçš„â€é‡å®šå‘URIâ€ï¼Œå‘è®¤è¯æœåŠ¡å™¨ç”³è¯·ä»¤ç‰Œã€‚è¿™ä¸€æ­¥æ˜¯åœ¨å®¢æˆ·ç«¯çš„åå°çš„æœåŠ¡å™¨ä¸Šå®Œæˆçš„ï¼Œå¯¹ç”¨æˆ·ä¸å¯è§ã€‚</p></li><li><p>ï¼ˆEï¼‰è®¤è¯æœåŠ¡å™¨æ ¸å¯¹äº†æˆæƒç å’Œé‡å®šå‘URIï¼Œç¡®è®¤æ— è¯¯åï¼Œå‘å®¢æˆ·ç«¯å‘é€è®¿é—®ä»¤ç‰Œï¼ˆaccess tokenï¼‰å’Œæ›´æ–°ä»¤ç‰Œï¼ˆrefresh tokenï¼‰ã€‚</p></li></ul><p>æ ¸å¿ƒå‚æ•°:</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://wx.com/oauth/authorize?response_type=code&amp;client_id=CLIENT_ID&amp;redirect_uri=http://www.baidu.com&amp;scope=read</span><br></pre></td></tr></table></figure><table><thead><tr><th>å­—æ®µ</th><th>æè¿°</th></tr></thead><tbody><tr><td>client_id</td><td>æˆæƒæœåŠ¡å™¨æ³¨å†Œåº”ç”¨åçš„å”¯ä¸€æ ‡è¯†</td></tr><tr><td>response_type</td><td>å¿…é¡» å›ºå®šå€¼  åœ¨æˆæƒç ä¸­å¿…é¡»ä¸º code</td></tr><tr><td>redirect_uri</td><td>å¿…é¡» é€šè¿‡å®¢æˆ·ç«¯æ³¨å†Œçš„é‡å®šå‘URL</td></tr><tr><td>scope</td><td>å¿…é¡» ä»¤ç‰Œå¯ä»¥è®¿é—®èµ„æºæƒé™ read åªè¯»   all è¯»å†™</td></tr><tr><td>state</td><td>å¯é€‰ å­˜åœ¨åŸæ ·è¿”å›å®¢æˆ·ç«¯ ç”¨æ¥é˜²æ­¢ CSRFè·¨ç«™æ”»å‡»</td></tr></tbody></table><h3 id="ç®€åŒ–æ¨¡å¼"><a href="#ç®€åŒ–æ¨¡å¼" class="headerlink" title="ç®€åŒ–æ¨¡å¼"></a>ç®€åŒ–æ¨¡å¼</h3><p><strong>ç®€åŒ–æ¨¡å¼ï¼ˆ<code>implicit</code> grant typeï¼‰</strong>ä¸é€šè¿‡ç¬¬ä¸‰æ–¹åº”ç”¨ç¨‹åºçš„æœåŠ¡å™¨ï¼Œç›´æ¥åœ¨æµè§ˆå™¨ä¸­å‘è®¤è¯æœåŠ¡å™¨ç”³è¯·ä»¤ç‰Œï¼Œè·³è¿‡äº†â€æˆæƒç â€è¿™ä¸ªæ­¥éª¤ï¼Œå› æ­¤å¾—åã€‚æ‰€æœ‰æ­¥éª¤åœ¨æµè§ˆå™¨ä¸­å®Œæˆï¼Œä»¤ç‰Œå¯¹è®¿é—®è€…æ˜¯å¯è§çš„ï¼Œä¸”å®¢æˆ·ç«¯ä¸éœ€è¦è®¤è¯ã€‚å…¶å…·ä½“çš„æˆæƒæµç¨‹å¦‚å›¾æ‰€ç¤ºï¼ˆå›¾ç‰‡æ¥è‡ª RFC6749æ–‡æ¡£ <a href="https://tools.ietf.org/html/rfc6749">https://tools.ietf.org/html/rfc6749</a>)</p><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220625090540320.png" class=""><p>å…·ä½“æ­¥éª¤å¦‚ä¸‹:</p><ul><li>ï¼ˆAï¼‰ç¬¬ä¸‰æ–¹åº”ç”¨å°†ç”¨æˆ·å¯¼å‘è®¤è¯æœåŠ¡å™¨ã€‚</li><li>ï¼ˆBï¼‰ç”¨æˆ·å†³å®šæ˜¯å¦ç»™äºå®¢æˆ·ç«¯æˆæƒã€‚</li><li>ï¼ˆCï¼‰å‡è®¾ç”¨æˆ·ç»™äºˆæˆæƒï¼Œè®¤è¯æœåŠ¡å™¨å°†ç”¨æˆ·å¯¼å‘å®¢æˆ·ç«¯æŒ‡å®šçš„â€é‡å®šå‘URIâ€ï¼Œå¹¶åœ¨URIçš„Hashéƒ¨åˆ†åŒ…å«äº†è®¿é—®ä»¤ç‰Œã€‚#token</li><li>ï¼ˆDï¼‰æµè§ˆå™¨å‘èµ„æºæœåŠ¡å™¨å‘å‡ºè¯·æ±‚ï¼Œå…¶ä¸­ä¸åŒ…æ‹¬ä¸Šä¸€æ­¥æ”¶åˆ°çš„Hashå€¼ã€‚</li><li>ï¼ˆEï¼‰èµ„æºæœåŠ¡å™¨è¿”å›ä¸€ä¸ªç½‘é¡µï¼Œå…¶ä¸­åŒ…å«çš„ä»£ç å¯ä»¥è·å–Hashå€¼ä¸­çš„ä»¤ç‰Œã€‚</li><li>ï¼ˆFï¼‰æµè§ˆå™¨æ‰§è¡Œä¸Šä¸€æ­¥è·å¾—çš„è„šæœ¬ï¼Œæå–å‡ºä»¤ç‰Œã€‚</li><li>ï¼ˆGï¼‰æµè§ˆå™¨å°†ä»¤ç‰Œå‘ç»™å®¢æˆ·ç«¯ã€‚</li></ul><p>æ ¸å¿ƒå‚æ•°:</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://wx.com/oauth/authorize?response_type=token&amp;client_id=CLIENT_ID&amp;redirect_uri=http://www.baidu.com&amp;scope=read</span><br></pre></td></tr></table></figure><table><thead><tr><th>å­—æ®µ</th><th>æè¿°</th></tr></thead><tbody><tr><td>client_id</td><td>æˆæƒæœåŠ¡å™¨æ³¨å†Œåº”ç”¨åçš„å”¯ä¸€æ ‡è¯†</td></tr><tr><td>response_type</td><td>å¿…é¡» å›ºå®šå€¼  åœ¨æˆæƒç ä¸­å¿…é¡»ä¸º token</td></tr><tr><td>redirect_uri</td><td>å¿…é¡» é€šè¿‡å®¢æˆ·ç«¯æ³¨å†Œçš„é‡å®šå‘URL</td></tr><tr><td>scope</td><td>å¿…é¡» ä»¤ç‰Œå¯ä»¥è®¿é—®èµ„æºæƒé™</td></tr><tr><td>state</td><td>å¯é€‰ å­˜åœ¨åŸæ ·è¿”å›å®¢æˆ·ç«¯ ç”¨æ¥é˜²æ­¢ CSRFè·¨ç«™æ”»å‡»</td></tr></tbody></table><h3 id="å¯†ç æ¨¡å¼"><a href="#å¯†ç æ¨¡å¼" class="headerlink" title="å¯†ç æ¨¡å¼"></a>å¯†ç æ¨¡å¼</h3><p><strong>å¯†ç æ¨¡å¼ï¼ˆResource Owner <code>Password</code> Credentials Grantï¼‰</strong>ä¸­ï¼Œç”¨æˆ·å‘å®¢æˆ·ç«¯æä¾›è‡ªå·±çš„ç”¨æˆ·åå’Œå¯†ç ã€‚å®¢æˆ·ç«¯ä½¿ç”¨è¿™äº›ä¿¡æ¯ï¼Œå‘â€æœåŠ¡å•†æä¾›å•†â€ç´¢è¦æˆæƒã€‚åœ¨è¿™ç§æ¨¡å¼ä¸­ï¼Œç”¨æˆ·å¿…é¡»æŠŠè‡ªå·±çš„å¯†ç ç»™å®¢æˆ·ç«¯ï¼Œä½†æ˜¯å®¢æˆ·ç«¯ä¸å¾—å‚¨å­˜å¯†ç ã€‚è¿™é€šå¸¸ç”¨åœ¨ç”¨æˆ·å¯¹å®¢æˆ·ç«¯é«˜åº¦ä¿¡ä»»çš„æƒ…å†µä¸‹ï¼Œæ¯”å¦‚å®¢æˆ·ç«¯æ˜¯æ“ä½œç³»ç»Ÿçš„ä¸€éƒ¨åˆ†ï¼Œæˆ–è€…ç”±ä¸€ä¸ªç›¸åŒå…¬å¸å‡ºå“ã€‚è€Œè®¤è¯æœåŠ¡å™¨åªæœ‰åœ¨å…¶ä»–æˆæƒæ¨¡å¼æ— æ³•æ‰§è¡Œçš„æƒ…å†µä¸‹ï¼Œæ‰èƒ½è€ƒè™‘ä½¿ç”¨è¿™ç§æ¨¡å¼ã€‚å…¶å…·ä½“çš„æˆæƒæµç¨‹å¦‚å›¾æ‰€ç¤ºï¼ˆå›¾ç‰‡æ¥è‡ª RFC6749æ–‡æ¡£ <a href="https://tools.ietf.org/html/rfc6749">https://tools.ietf.org/html/rfc6749</a>)</p><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220625090710221.png" class=""><p>å…·ä½“æ­¥éª¤å¦‚ä¸‹:</p><ul><li><p>ï¼ˆAï¼‰ç”¨æˆ·å‘å®¢æˆ·ç«¯æä¾›ç”¨æˆ·åå’Œå¯†ç ã€‚</p></li><li><p>ï¼ˆBï¼‰å®¢æˆ·ç«¯å°†ç”¨æˆ·åå’Œå¯†ç å‘ç»™è®¤è¯æœåŠ¡å™¨ï¼Œå‘åè€…è¯·æ±‚ä»¤ç‰Œã€‚</p></li><li><p>ï¼ˆCï¼‰è®¤è¯æœåŠ¡å™¨ç¡®è®¤æ— è¯¯åï¼Œå‘å®¢æˆ·ç«¯æä¾›è®¿é—®ä»¤ç‰Œã€‚</p></li></ul><p>æ ¸å¿ƒå‚æ•°: </p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://wx.com/token?grant_type=password&amp;username=USERNAME&amp;password=PASSWORD&amp;client_id=CLIENT_ID</span><br></pre></td></tr></table></figure><h3 id="å®¢æˆ·ç«¯æ¨¡å¼"><a href="#å®¢æˆ·ç«¯æ¨¡å¼" class="headerlink" title="å®¢æˆ·ç«¯æ¨¡å¼"></a>å®¢æˆ·ç«¯æ¨¡å¼</h3><p><strong>å®¢æˆ·ç«¯æ¨¡å¼ï¼ˆ<code>Client Credentials</code> Grantï¼‰</strong>æŒ‡å®¢æˆ·ç«¯ä»¥è‡ªå·±çš„åä¹‰ï¼Œè€Œä¸æ˜¯ä»¥ç”¨æˆ·çš„åä¹‰ï¼Œå‘â€æœåŠ¡æä¾›å•†â€è¿›è¡Œè®¤è¯ã€‚ä¸¥æ ¼åœ°è¯´ï¼Œå®¢æˆ·ç«¯æ¨¡å¼å¹¶ä¸å±äºOAuthæ¡†æ¶æ‰€è¦è§£å†³çš„é—®é¢˜ã€‚åœ¨è¿™ç§æ¨¡å¼ä¸­ï¼Œç”¨æˆ·ç›´æ¥å‘å®¢æˆ·ç«¯æ³¨å†Œï¼Œå®¢æˆ·ç«¯ä»¥è‡ªå·±çš„åä¹‰è¦æ±‚â€æœåŠ¡æä¾›å•†â€æä¾›æœåŠ¡ï¼Œå…¶å®ä¸å­˜åœ¨æˆæƒé—®é¢˜ã€‚</p><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220625090900509.png" class=""><p>å…·ä½“æ­¥éª¤å¦‚ä¸‹:</p><ul><li><p>ï¼ˆAï¼‰å®¢æˆ·ç«¯å‘è®¤è¯æœåŠ¡å™¨è¿›è¡Œèº«ä»½è®¤è¯ï¼Œå¹¶è¦æ±‚ä¸€ä¸ªè®¿é—®ä»¤ç‰Œã€‚</p></li><li><p>ï¼ˆBï¼‰è®¤è¯æœåŠ¡å™¨ç¡®è®¤æ— è¯¯åï¼Œå‘å®¢æˆ·ç«¯æä¾›è®¿é—®ä»¤ç‰Œã€‚</p></li></ul><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://wx.com/token?grant_type=client_credentials&amp;client_id=CLIENT_ID&amp;client_secret=CLIENT_SECRET</span><br></pre></td></tr></table></figure><h2 id="OAuth2-æ ‡å‡†æ¥å£"><a href="#OAuth2-æ ‡å‡†æ¥å£" class="headerlink" title="OAuth2 æ ‡å‡†æ¥å£"></a>OAuth2 æ ‡å‡†æ¥å£</h2><ul><li><p><code>/oauth/authorize</code>ï¼šæˆæƒç«¯ç‚¹</p></li><li><p><code>/oauth/token</code>ï¼šè·å–ä»¤ç‰Œç«¯ç‚¹</p></li><li><p>&#x2F;oauth&#x2F;confirm_accessï¼šç”¨æˆ·ç¡®è®¤æˆæƒæäº¤ç«¯ç‚¹</p></li><li><p>&#x2F;oauth&#x2F;errorï¼šæˆæƒæœåŠ¡é”™è¯¯ä¿¡æ¯ç«¯ç‚¹</p></li><li><p>&#x2F;oauth&#x2F;check_tokenï¼šç”¨äºèµ„æºæœåŠ¡è®¿é—®çš„ä»¤ç‰Œè§£æç«¯ç‚¹</p></li><li><p>&#x2F;oauth&#x2F;token_keyï¼šæä¾›å…¬æœ‰å¯†åŒ™çš„ç«¯ç‚¹ï¼Œå¦‚æœä½¿ç”¨JWTä»¤ç‰Œçš„è¯</p></li></ul><h2 id="GitHub-æˆæƒç™»å½•"><a href="#GitHub-æˆæƒç™»å½•" class="headerlink" title="GitHub æˆæƒç™»å½•"></a>GitHub æˆæƒç™»å½•</h2><h3 id="åˆ›å»º-OAuth-åº”ç”¨"><a href="#åˆ›å»º-OAuth-åº”ç”¨" class="headerlink" title="åˆ›å»º OAuth åº”ç”¨"></a>åˆ›å»º OAuth åº”ç”¨</h3><p>è®¿é—® github å¹¶ç™»å½•ï¼Œåœ¨<a href="https://github.com/settings/profile%E4%B8%AD%E6%89%BE%E5%88%B0">https://github.com/settings/profileä¸­æ‰¾åˆ°</a> Developer Settings é€‰é¡¹</p><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220601100844019.png" class=""><ul><li>åˆ›å»º OAuth Appå¹¶è¾“å…¥ä¸€ä¸‹åŸºæœ¬ä¿¡æ¯:</li></ul><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220601101157267.png" class=""><ul><li>æ³¨å†ŒæˆåŠŸåä¼šè·å–åˆ°å¯¹åº”çš„ Client ID å’Œ Client Secretã€‚</li></ul><p>!<img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220601101312113.png" class=""></p><h3 id="é¡¹ç›®å¼€å‘"><a href="#é¡¹ç›®å¼€å‘" class="headerlink" title="é¡¹ç›®å¼€å‘"></a>é¡¹ç›®å¼€å‘</h3><ul><li>åˆ›å»º springboot åº”ç”¨ï¼Œå¹¶å¼•å…¥ä¾èµ–</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-oauth2-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>åˆ›å»ºæµ‹è¯• controller</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/hello&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> DefaultOAuth2User <span class="title function_">hello</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;hello &quot;</span>);</span><br><span class="line">        <span class="type">Authentication</span> <span class="variable">authentication</span> <span class="operator">=</span> SecurityContextHolder.getContext().getAuthentication();</span><br><span class="line">        <span class="keyword">return</span> (DefaultOAuth2User) authentication.getPrincipal();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>é…ç½® security</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http.authorizeRequests()</span><br><span class="line">                .anyRequest().authenticated()</span><br><span class="line">                .and()</span><br><span class="line">                .oauth2Login();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>é…ç½®é…ç½®æ–‡ä»¶</li></ul><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server.port</span>=<span class="string">8080</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring.security.oauth2.client.registration.github.client-id</span>=<span class="string">d6ea299b9ade3cd3b97d</span></span><br><span class="line"><span class="attr">spring.security.oauth2.client.registration.github.client-secret</span>=<span class="string">aaa44b2675a7b636b1b43371e509e88ee9013816</span></span><br><span class="line"><span class="comment">#  ä¸€å®šè¦ä¸é‡å®šå‘å›è°ƒ URL ä¸€è‡´</span></span><br><span class="line"><span class="attr">spring.security.oauth2.client.registration.github.redirect-uri</span>=<span class="string">http://localhost:8080/login/oauth2/code/github</span></span><br></pre></td></tr></table></figure><ul><li>å¯åŠ¨æµ‹è¯•</li></ul><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220601102620149.png" class=""><ul><li>ç‚¹å‡» github ç™»å½•,ç‚¹å‡»æˆæƒ è®¿é—® hello æ¥å£</li></ul><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220601102749454.png" class=""><h2 id="Spring-Security-OAuth2"><a href="#Spring-Security-OAuth2" class="headerlink" title="Spring Security OAuth2"></a>Spring Security OAuth2</h2><p>Spring Security å¯¹ OAuth2 æä¾›äº†å¾ˆå¥½çš„æ”¯æŒï¼Œè¿™ä½¿å¾—æˆ‘ä»¬åœ¨ Spring Securityä¸­ä½¿ç”¨ OAuth2 éå¸¸åœ°æ–¹ä¾¿ã€‚ç„¶è€Œç”±äºå†å²åŸå› ï¼ŒSpring Seaurityå¯¹ OAuth2 çš„æ”¯æŒæ¯”è¾ƒæ··ä¹±ï¼Œè¿™é‡Œç®€å•æ¢³ç†ä¸€ä¸‹ã€‚</p><p>å¤§çº¦åå¹´å‰ï¼ŒSpring å¼•å…¥äº†ä¸€ä¸ªç¤¾åŒºé©±åŠ¨çš„å¼€æºé¡¹ç›® Spring Security OAuthï¼Œ å¹¶å°†å…¶çº³å…¥ Spring é¡¹ç›®ç»„åˆä¸­ã€‚åˆ°ä»Šå¤©ä¸ºæ­¢ï¼Œè¿™ä¸ªé¡¹ç›®å·±ç»å‘å±•æˆä¸ºä¸€ä¸ªæˆç†Ÿçš„é¡¹ç›®ï¼Œå¯ä»¥æ”¯æŒå¤§éƒ¨åˆ†OAuth è§„èŒƒï¼ŒåŒ…æ‹¬èµ„æºæœåŠ¡å™¨ã€ å®¢æˆ·ç«¯å’ŒæˆæƒæœåŠ¡å™¨ç­‰ã€‚</p><p>ç„¶è€Œæ—©æœŸçš„é¡¹ç›®å­˜åœ¨ä¸€äº›é—®é¢˜ï¼Œä¾‹å¦‚ï¼š</p><ul><li><p>OAuth æ˜¯åœ¨æ—©æœŸå®Œæˆçš„ï¼Œå¼€å‘è€…æ— æ³•é¢„æ–™æœªæ¥çš„å˜åŒ–ä»¥åŠè¿™äº›ä»£ç åˆ°åº•è¦è¢«æ€ä¹ˆä½¿ç”¨ï¼Œ</p><p>è¿™å¯¼è‡´å¾ˆå¤š Spring é¡¹ç›®æä¾›äº†è‡ªå·±çš„ OAuth æ”¯æŒï¼Œä¹Ÿå°±å¸¦æ¥äº† OAuth æ”¯æŒçš„ç¢ç‰‡åŒ–ã€‚</p></li><li><p>æœ€æ—©çš„OAuthé¡¹ç›®åŒæ—¶æ”¯ç‰¹ OAuth1.0 å’Œ OAuth2.0ï¼Œè€Œç°åœ¨OAuth1.0 æ—©å·²ç»ä¸å†ä½¿ç”¨ï¼Œ</p><p>å¯ä»¥æ”¾å¼ƒäº†ã€‚</p></li><li><p>ç°åœ¨æˆ‘ä»¬æœ‰æ›´å¤šçš„åº“å¯ä»¥é€‰æ‹©ï¼Œå¯ä»¥åœ¨è¿™äº›åº“çš„åŸºç¡€ä¸Šå»å¼€å‘ï¼Œä»¥ä¾¿æ›´å¥½åœ°æ”¯æŒJWTç­‰æ–°æŠ€æœ¯ã€‚</p></li></ul><p>åŸºäºä»¥ä¸Šè¿™äº›åŸå› ï¼Œå®˜æ–¹å†³å®šé‡å†™ Spring Security OAuthï¼Œ ä»¥ä¾¿æ›´å¥½åœ°åè°ƒ Spring å’ŒOAuthï¼Œå¹¶ç®€åŒ–ä»£ç åº“ï¼Œä½¿Spring çš„ OAuth æ”¯æŒæ›´åŠ çµæ´»ã€‚ç„¶è€Œï¼Œåœ¨é‡å†™çš„è¿‡ç¨‹ä¸­ï¼Œå‘ç”Ÿäº†ä¸å°‘æ³¢æŠ˜ã€‚</p><p>2018å¹´1æœˆ30æ—¥ï¼ŒSpring å®˜æ–¹å‘äº†ä¸€ä¸ªé€šçŸ¥ï¼Œè¡¨ç¤ºè¦é€æ¸åœæ­¢ç°æœ‰çš„ OAuth2æ”¯æŒï¼Œç„¶ååœ¨ Spring Security 5ä¸­æ„å»ºä¸‹ä¸€ä»£ OAuth2.0 æ”¯æŒã€‚è¿™ä¹ˆåšçš„åŸå› æ˜¯å› ä¸ºå½“æ—¶ OAuth2 çš„è½åœ°æ–¹æ¡ˆæ¯”è¾ƒæ··ä¹±ï¼Œåœ¨ Spring Security OAuthã€ Spring Cloud Securityã€Spring Boot 1.5.x ä»¥åŠå½“æ—¶æœ€æ–°çš„Spring Security 5.x ä¸­éƒ½æä¾›äº†å¯¹ OAuth2 çš„å®ç°ã€‚ä»¥è‡³äºå½“å¼€å‘è€…éœ€è¦ä½¿ç”¨ OAuth2 æ—¶ï¼Œä¸å¾—ä¸é—®ï¼Œåˆ°åº•é€‰å“ªä¸€ä¸ªä¾èµ–åˆé€‚å‘¢ï¼Ÿ</p><p>æ‰€ä»¥Spring å®˜æ–¹å†³å®šæœ‰å¿…è¦å°† OAuth2.0 çš„æ”¯æŒç»Ÿä¸€åˆ°ä¸€ä¸ªé¡¹ç›®ä¸­ï¼Œä»¥ä¾¿ä¸ºç”¨æˆ·æä¾›æ˜ç¡®çš„é€‰æ‹©ï¼Œå¹¶é¿å…ä»»ä½•æ½œåœ¨çš„æ··ä¹±ï¼ŒåŒæ—¶ OAuth2.0 çš„å¼€å‘æ–‡æ¡£ä¹Ÿè¦é‡æ–°ç¼–å†™ï¼Œä»¥æ–¹ä¾¿å¼€å‘äººå‘˜å­¦ä¹ ã€‚æ‰€æœ‰çš„å†³å®šå°†åœ¨ Spring Security 5 ä¸­å¼€å§‹ï¼Œæ„å»ºä¸‹ä¸€ä»£ OAuth2.0çš„æ”¯æŒã€‚ä»é‚£ä¸ªæ—¶å€™èµ·ï¼ŒSpring Security OAuth é¡¹ç›®å°±æ­£å¼å¤„äºç»´æŠ¤æ¨¡å¼ã€‚å®˜æ–¹å°†æä¾›è‡³å°‘ä¸€å¹´çš„é”™è¯†&#x2F;å®‰å…¨ä¿®å¤ç¨‹åºï¼Œå¹¶ä¸”ä¼šè€ƒè™‘æ·»åŠ æ¬¡è¦åŠŸèƒ½ï¼Œä½†ä¸ä¼šæ·»åŠ ä¸»è¦åŠŸèƒ½ã€‚åŒæ—¶å°† Spring Security OAuthä¸­çš„æ‰€æœ‰åŠŸèƒ½é‡æ„åˆ° Spring Security 5.x ä¸­ã€‚</p><p>åˆ°äº†2019å¹´11æœˆ14æ—¥ï¼ŒSpring å®˜æ–¹åˆå‘å¸ƒä¸€ä¸ªé€šçŸ¥ï¼Œè¿™æ¬¡çš„é€šçŸ¥é¦–å…ˆè¡¨ç¤º Spring Security OAuth åœ¨è¿å¾€ Spring Security 5.x çš„è¿‡ç¨‹éå¸¸é¡ºåˆ©ï¼Œå¤§éƒ½åˆ†è¿ç¨‹å·¥ä½œå·²ç»å®Œæˆäº†ï¼Œå‰©ä¸‹çš„å°†åœ¨5.3 ç‰ˆæœ¬ä¸­å®Œæˆè¿ç§»ï¼Œåœ¨è¿ç§»çš„è¿‡ç¨‹ä¸­è¿˜æ·»åŠ äº†è®¸å¤šæ–°åŠŸèƒ½ã€‚åŒ…æ‹¬å¯¹ OpenID Connect1.0 çš„æ”¯æŒã€‚åŒæ—¶è¿˜å®£å¸ƒå°†ä¸å†æ”¯æŒæˆæƒæœåŠ¡å™¨ï¼Œä¸æ”¯æŒçš„åŸå› æœ‰ä¸¤ä¸ªï¼š</p><ol><li><code>åœ¨2019å¹´ï¼Œå·²ç»æœ‰å¤§é‡çš„å•†ä¸šå’Œå¼€æºæˆæƒæœåŠ¡å™¨å¯ç”¨ã€‚</code></li><li><code>æˆæƒæœåŠ¡å™¨æ˜¯ä½¿ç”¨ä¸€ä¸ªåº“æ¥æ„å»ºäº§å“ï¼Œè€Œ Spring Security ä½œä¸ºæ¡†æ¶ï¼Œå¹¶ä¸é€‚åˆåšè¿™ä»¶äº‹æƒ…ã€‚</code></li></ol><p>ä¸€çŸ³æ¿€èµ·åƒå±‚æµªï¼Œè®¸å¤šå¼€å‘è€…è¡¨ç¤ºå¯¹æ­¤éš¾ä»¥æ¥å—ã€‚è¿™ä»¶äº‹ä¹Ÿåœ¨Spring ç¤¾åŒºå¼•å‘äº†æ¿€çƒˆçš„è®¨è®ºï¼Œå¥½åœ¨ Spring å®˜æ–¹æ„¿æ„å€¾å¬æ¥è‡ªç¤¾åŒºçš„å£°éŸ³ã€‚</p><p>åˆ°äº†2020å¹´4æœˆ15æ—¥ï¼ŒSpring å®˜æ–¹å®£å¸ƒå¯åŠ¨ Spring Authorization server é¡¹ç›®ã€‚è¿™æ˜¯ä¸€ä¸ªç”± Spring Security å›¢é˜Ÿé¢†å¯¼çš„ç¤¾åŒºé©±åŠ¨çš„é¡¹ç›®ï¼Œè‡´åŠ›äºå‘ Spring ç¤¾åŒºæä¾› Authorization Serveræ”¯æŒï¼Œä¹Ÿå°±æ˜¯è¯´ï¼ŒSpring åˆé‡æ–°æ”¯æŒæˆæƒæœåŠ¡å™¨äº†ã€‚</p><p>2020å¹´8æœˆ21æ—¥ï¼ŒSpring Authorization Server 0.0.1 æ­£å¼å‘å¸ƒï¼</p><p>è¿™å°±æ˜¯ OAuth2 åœ¨Spring å®¶æ—ä¸­çš„å‘å±•å†ç¨‹äº†ã€‚åœ¨åé¢çš„å­¦ä¹ ä¸­ï¼Œå®¢æˆ·ç«¯å’Œèµ„æºæœåŠ¡å™¨éƒ½å°†é‡‡ç”¨æœ€æ–°çš„æ–¹å¼æ¥æ„å»ºï¼ŒæˆæƒæœåŠ¡å™¨ä¾ç„¶é‡‡ç”¨æ—§çš„æ–¹å¼æ¥æ„å»ºï¼Œå› ä¸ºç›®å‰çš„ Spring Authorization Server 0.0.1 åŠŸèƒ½è¾ƒå°‘ä¸” BUG è¾ƒå¤šã€‚</p><p>ä¸€èˆ¬æ¥è¯´ï¼Œå½“æˆ‘ä»¬åœ¨é¡¹ç›®ä¸­ä½¿ç”¨ OAuth2 æ—¶ï¼Œéƒ½æ˜¯å¼€å‘å®¢æˆ·ç«¯ï¼ŒæˆæƒæœåŠ¡å™¨å’Œèµ„æºæœåŠ¡å™¨éƒ½æ˜¯ç”±å¤–éƒ¨æä¾›ã€‚ä¾‹å¦‚æˆ‘ä»¬æƒ³åœ¨è‡ªå·±æ­å»ºç½‘ç«™ä¸Šé›†æˆ GitHub ç¬¬ä¸‰æ–¹ç™»å½•ï¼Œåªéœ€è¦å¼€å‘è‡ªå·±çš„å®¢æˆ·ç«¯å³å¯ï¼Œè®¤è¯æœåŠ¡å™¨å’ŒæˆæƒæœåŠ¡å™¨éƒ½æ˜¯ç”± GitHub æä¾›çš„ã€‚</p><h2 id="æˆæƒã€èµ„æºæœåŠ¡å™¨"><a href="#æˆæƒã€èµ„æºæœåŠ¡å™¨" class="headerlink" title="æˆæƒã€èµ„æºæœåŠ¡å™¨"></a>æˆæƒã€èµ„æºæœåŠ¡å™¨</h2><p>å‰é¢çš„ GitHub æˆæƒç™»å½•ä¸»è¦å‘å¤§å®¶å±•ç¤ºäº† OAuth2 ä¸­å®¢æˆ·ç«¯çš„å·¥ä½œæ¨¡å¼ã€‚å¯¹äºå¤§éƒ¨åˆ†çš„å¼€å‘è€…è€Œè¨€ï¼Œæ—¥å¸¸æ¥è§¦åˆ°çš„ OAuth2 éƒ½æ˜¯å¼€å‘å®¢æˆ·ç«¯ï¼Œä¾‹å¦‚æ¥å…¥ QQ ç™»å½•ã€æ¥å…¥å¾®ä¿¡ç™»å½•ç­‰ã€‚ä¸è¿‡ä¹Ÿæœ‰å°‘é‡åœºæ™¯ï¼Œå¯èƒ½éœ€è¦å¼€å‘è€…æä¾›æˆæƒæœåŠ¡å™¨ä¸èµ„æºæœåŠ¡å™¨ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±é€šè¿‡ä¸€ä¸ªå®Œæ•´çš„æ¡ˆä¾‹æ¼”ç¤ºå¦‚ä½•æ­å»ºæˆæƒæœåŠ¡å™¨ä¸èµ„æºæœåŠ¡å™¨ã€‚</p><p>æ­å»ºæˆæƒæœåŠ¡å™¨ï¼Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©ä¸€äº›ç°æˆçš„å¼€æºé¡¹ç›®ï¼Œç›´æ¥è¿è¡Œå³å¯ï¼Œä¾‹å¦‚ï¼š</p><ul><li>Keycloakï¼š RedFat å…¬å¸æä¾›çš„å¼€æºå·¥å…·ï¼Œæä¾›äº†å¾ˆå¤šå®ç”¨åŠŸèƒ½ï¼Œå€’å¦‚å•ç‚¹ç™»å½•ã€æ”¯æŒOpenIDã€å¯è§†åŒ–åå°ç®¡ç†ç­‰ã€‚</li><li>Apache Oltu: Apache ä¸Šçš„å¼€æºé¡¹ç›®ï¼Œæœ€è¿‘å‡ å¹´æ²¡æ€ä¹ˆç»´æŠ¤äº†ã€‚</li></ul><p>æ¥ä¸‹æ¥æˆ‘ä»¬å°†æ­å»ºä¸€ä¸ªåŒ…å«æˆæƒæœåŠ¡å™¨ã€èµ„æºæœåŠ¡å™¨ä»¥åŠå®¢æˆ·ç«¯åœ¨å†…çš„ OAuth2 æ¡ˆä¾‹ã€‚</p><p>é¡¹ç›®è§„åˆ’é¦–å…ˆæŠŠé¡¹ç›®åˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼š</p><ul><li>æˆæƒæœåŠ¡å™¨ï¼šé‡‡ç”¨è¾ƒæ—©çš„ spring-cloud-starter-oauth2 æ¥æ­å»ºæˆæƒæœåŠ¡å™¨ã€‚</li><li>èµ„æºæœåŠ¡å™¨ï¼šé‡‡ç”¨æœ€æ–°çš„ Spring Security 5.x æ­å»ºèµ„æºæœåŠ¡å™¨ï¼Œ</li><li>å®¢æˆ·ç«¯: é‡‡ç”¨æœ€æ–°çš„ Spring Security5.x æ­å»ºå®¢æˆ·ç«¯ã€‚</li></ul><h3 id="æˆæƒæœåŠ¡å™¨æ­å»º"><a href="#æˆæƒæœåŠ¡å™¨æ­å»º" class="headerlink" title="æˆæƒæœåŠ¡å™¨æ­å»º"></a>æˆæƒæœåŠ¡å™¨æ­å»º</h3><h4 id="1-åŸºäºå†…å­˜å®¢æˆ·ç«¯å’Œä»¤ç‰Œå­˜å‚¨"><a href="#1-åŸºäºå†…å­˜å®¢æˆ·ç«¯å’Œä»¤ç‰Œå­˜å‚¨" class="headerlink" title="1. åŸºäºå†…å­˜å®¢æˆ·ç«¯å’Œä»¤ç‰Œå­˜å‚¨"></a>1. åŸºäºå†…å­˜å®¢æˆ·ç«¯å’Œä»¤ç‰Œå­˜å‚¨</h4><p>åˆ›å»º springboot åº”ç”¨,å¹¶å¼•å…¥ä¾èµ–</p><blockquote><p>æ³¨æ„: é™ä½ springboot ç‰ˆæœ¬ä¸º 2.2.5.RELEASE</p></blockquote><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-oauth2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.5.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ç¼–å†™é…ç½®ç±»,æ·»åŠ  security é…ç½®ç±»ä»¥åŠ oauth é…ç½®ç±»</p><blockquote><p>Spring Security é…ç½®ç±»:</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> PasswordEncoder <span class="title function_">passwordEncoder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BCryptPasswordEncoder</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">protected</span> AuthenticationManager <span class="title function_">authenticationManager</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.authenticationManager();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> UserDetailsService <span class="title function_">userDetailsService</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">InMemoryUserDetailsManager</span> <span class="variable">inMemoryUserDetailsManager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InMemoryUserDetailsManager</span>();</span><br><span class="line">        <span class="type">UserDetails</span> <span class="variable">user</span> <span class="operator">=</span> User.withUsername(<span class="string">&quot;root&quot;</span>).password(passwordEncoder().encode(<span class="string">&quot;123&quot;</span>)).roles(<span class="string">&quot;ADMIN&quot;</span>).build();</span><br><span class="line">        inMemoryUserDetailsManager.createUser(user);</span><br><span class="line">        <span class="keyword">return</span> inMemoryUserDetailsManager;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        auth.userDetailsService(userDetailsService());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http.csrf().disable().formLogin();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>Authorization Server é…ç½®ç±»:</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableAuthorizationServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AuthorizationServer</span> <span class="keyword">extends</span> <span class="title class_">AuthorizationServerConfigurerAdapter</span> &#123;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PasswordEncoder passwordEncoder;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> UserDetailsService userDetailsService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">AuthorizationServer</span><span class="params">(PasswordEncoder passwordEncoder, UserDetailsService userDetailsService)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.passwordEncoder = passwordEncoder;</span><br><span class="line">        <span class="built_in">this</span>.userDetailsService = userDetailsService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * é…ç½®å®¢æˆ·ç«¯ç»†èŠ‚ å¦‚ å®¢æˆ·ç«¯ id ç§˜é’¥ é‡å®šå‘ url ç­‰</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(ClientDetailsServiceConfigurer clients)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        clients.inMemory().withClient(<span class="string">&quot;client&quot;</span>)</span><br><span class="line">                .secret(passwordEncoder.encode(<span class="string">&quot;secret&quot;</span>))</span><br><span class="line">                .redirectUris(<span class="string">&quot;http://www.baidu.com&quot;</span>)</span><br><span class="line">                .scopes(<span class="string">&quot;client:read,user:read&quot;</span>)</span><br><span class="line">                .authorizedGrantTypes(<span class="string">&quot;authorization_code&quot;</span>, <span class="string">&quot;refresh_token&quot;</span>,<span class="string">&quot;implicit&quot;</span>,<span class="string">&quot;password&quot;</span>,<span class="string">&quot;client_credentials&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthorizationServerEndpointsConfigurer endpoints)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        endpoints.userDetailsService(userDetailsService);<span class="comment">//å¼€å¯åˆ·æ–°ä»¤ç‰Œå¿…é¡»æŒ‡å®š</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯åŠ¨æœåŠ¡,ç™»å½•ä¹‹åè¿›è¡Œæˆæƒç è·å–</p><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220811212147719.png" class=""><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:8080/oauth/authorize?client_id=client&amp;response_type=code&amp;redirect_uri=http://www.baidu.com</span><br></pre></td></tr></table></figure><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220811212242159.png" class=""><p>ç‚¹å‡»æˆæƒè·å–æˆæƒç </p><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220811212334084.png" class=""><p>æ ¹æ®æˆæƒç ,ç”³è¯·ä»¤ç‰Œ</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST -H &quot;Content-Type: application/x-www-form-urlencoded&quot; -d &#x27;grant_type=authorization_code&amp;code=IwvCtx&amp;redirect_uri=http://www.baidu.com&#x27; &quot;http://client:secret@localhost:8080/oauth/token&quot;</span><br></pre></td></tr></table></figure><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220811212426451.png" class=""><p>åˆ·æ–°ä»¤ç‰Œ</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST -H &quot;Content-Type: application/x-www-form-urlencoded&quot; -d &#x27;grant_type=refresh_token&amp;refresh_token=f6583d8a-598c-46bb-81d8-01fa6484cf05&amp;client_id=client&#x27; &quot;http://client:secret@localhost:8080/oauth/token&quot;</span><br></pre></td></tr></table></figure><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220811212512798.png" class=""><h4 id="2-åŸºäºæ•°æ®åº“å®¢æˆ·ç«¯å’Œä»¤ç‰Œå­˜å‚¨"><a href="#2-åŸºäºæ•°æ®åº“å®¢æˆ·ç«¯å’Œä»¤ç‰Œå­˜å‚¨" class="headerlink" title="2. åŸºäºæ•°æ®åº“å®¢æˆ·ç«¯å’Œä»¤ç‰Œå­˜å‚¨"></a>2. åŸºäºæ•°æ®åº“å®¢æˆ·ç«¯å’Œä»¤ç‰Œå­˜å‚¨</h4><p>åœ¨ä¸Šé¢çš„æ¡ˆä¾‹ä¸­ï¼ŒTokenStore çš„é»˜è®¤å®ç°ä¸º InMemoryTokenStore å³å†…å­˜å­˜å‚¨ï¼Œå¯¹äº Client ä¿¡æ¯ï¼ŒClientDetailsService æ¥å£è´Ÿè´£ä»å­˜å‚¨ä»“åº“ä¸­è¯»å–æ•°æ®ï¼Œåœ¨ä¸Šé¢çš„æ¡ˆä¾‹ä¸­é»˜è®¤ä½¿ç”¨çš„ä¹Ÿæ˜¯ InMemoryClientDetailsService å®ç°ç±»ã€‚</p><p>å¦‚æœè¦æƒ³ä½¿ç”¨æ•°æ®åº“å­˜å‚¨ï¼Œåªè¦æä¾›è¿™äº›æ¥å£çš„å®ç°ç±»å³å¯ï¼Œè€Œæ¡†æ¶å·²ç»ä¸ºæˆ‘ä»¬å†™å¥½ JdbcTokenStore å’Œ JdbcClientDetailsService</p><p>å»ºè¡¨:</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/spring-projects/spring-security-oauth/blob/master/spring-security-oauth2/src/test/resources/schema.sql</span><br><span class="line"># æ³¨æ„: å¹¶ç”¨ BLOB æ›¿æ¢è¯­å¥ä¸­çš„ LONGVARBINARY ç±»å‹</span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">SET</span> NAMES utf8mb4;</span><br><span class="line"><span class="keyword">SET</span> FOREIGN_KEY_CHECKS <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for clientdetails</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `clientdetails`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `clientdetails` (</span><br><span class="line">  `appId` <span class="type">varchar</span>(<span class="number">256</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `resourceIds` <span class="type">varchar</span>(<span class="number">256</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `appSecret` <span class="type">varchar</span>(<span class="number">256</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `<span class="keyword">scope</span>` <span class="type">varchar</span>(<span class="number">256</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `grantTypes` <span class="type">varchar</span>(<span class="number">256</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `redirectUrl` <span class="type">varchar</span>(<span class="number">256</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `authorities` <span class="type">varchar</span>(<span class="number">256</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `access_token_validity` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `refresh_token_validity` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `additionalInformation` <span class="type">varchar</span>(<span class="number">4096</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `autoApproveScopes` <span class="type">varchar</span>(<span class="number">256</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`appId`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for oauth_access_token</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `oauth_access_token`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `oauth_access_token` (</span><br><span class="line">  `token_id` <span class="type">varchar</span>(<span class="number">256</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `token` <span class="type">blob</span>,</span><br><span class="line">  `authentication_id` <span class="type">varchar</span>(<span class="number">256</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `user_name` <span class="type">varchar</span>(<span class="number">256</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `client_id` <span class="type">varchar</span>(<span class="number">256</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `authentication` <span class="type">blob</span>,</span><br><span class="line">  `refresh_token` <span class="type">varchar</span>(<span class="number">256</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`authentication_id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for oauth_approvals</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `oauth_approvals`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `oauth_approvals` (</span><br><span class="line">  `userId` <span class="type">varchar</span>(<span class="number">256</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `clientId` <span class="type">varchar</span>(<span class="number">256</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `<span class="keyword">scope</span>` <span class="type">varchar</span>(<span class="number">256</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `status` <span class="type">varchar</span>(<span class="number">10</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `expiresAt` <span class="type">timestamp</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">DEFAULT</span> <span class="built_in">CURRENT_TIMESTAMP</span> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="built_in">CURRENT_TIMESTAMP</span>,</span><br><span class="line">  `lastModifiedAt` <span class="type">date</span> <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span></span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for oauth_client_details</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `oauth_client_details`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `oauth_client_details` (</span><br><span class="line">  `client_id` <span class="type">varchar</span>(<span class="number">256</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `resource_ids` <span class="type">varchar</span>(<span class="number">256</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `client_secret` <span class="type">varchar</span>(<span class="number">256</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `<span class="keyword">scope</span>` <span class="type">varchar</span>(<span class="number">256</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `authorized_grant_types` <span class="type">varchar</span>(<span class="number">256</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `web_server_redirect_uri` <span class="type">varchar</span>(<span class="number">256</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `authorities` <span class="type">varchar</span>(<span class="number">256</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `access_token_validity` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `refresh_token_validity` <span class="type">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `additional_information` <span class="type">varchar</span>(<span class="number">4096</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `autoapprove` <span class="type">varchar</span>(<span class="number">256</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`client_id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for oauth_client_token</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `oauth_client_token`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `oauth_client_token` (</span><br><span class="line">  `token_id` <span class="type">varchar</span>(<span class="number">256</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `token` <span class="type">blob</span>,</span><br><span class="line">  `authentication_id` <span class="type">varchar</span>(<span class="number">256</span>) <span class="keyword">NOT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `user_name` <span class="type">varchar</span>(<span class="number">256</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `client_id` <span class="type">varchar</span>(<span class="number">256</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> KEY (`authentication_id`)</span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for oauth_code</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `oauth_code`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `oauth_code` (</span><br><span class="line">  `code` <span class="type">varchar</span>(<span class="number">256</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `authentication` <span class="type">blob</span></span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="comment">-- Table structure for oauth_refresh_token</span></span><br><span class="line"><span class="comment">-- ----------------------------</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> IF <span class="keyword">EXISTS</span> `oauth_refresh_token`;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> `oauth_refresh_token` (</span><br><span class="line">  `token_id` <span class="type">varchar</span>(<span class="number">256</span>) <span class="keyword">DEFAULT</span> <span class="keyword">NULL</span>,</span><br><span class="line">  `token` <span class="type">blob</span>,</span><br><span class="line">  `authentication` <span class="type">blob</span></span><br><span class="line">) ENGINE<span class="operator">=</span>InnoDB <span class="keyword">DEFAULT</span> CHARSET<span class="operator">=</span>utf8mb4;</span><br><span class="line"></span><br><span class="line"><span class="keyword">SET</span> FOREIGN_KEY_CHECKS <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- å†™å…¥å®¢æˆ·ç«¯ä¿¡æ¯</span></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> `oauth_client_details` <span class="keyword">VALUES</span> (<span class="string">&#x27;client&#x27;</span>, <span class="keyword">NULL</span>, <span class="string">&#x27;$2a$10$QCsINtuRfP8kM112xRVdvuI58MrefLlEP2mM0kzB5KZCPhnOf4392&#x27;</span>, <span class="string">&#x27;read&#x27;</span>, <span class="string">&#x27;authorization_code,refresh_token&#x27;</span>, <span class="string">&#x27;http://www.baidu.com&#x27;</span>, <span class="keyword">NULL</span>, <span class="keyword">NULL</span>, <span class="keyword">NULL</span>, <span class="keyword">NULL</span>, <span class="keyword">NULL</span>);</span><br></pre></td></tr></table></figure><p>å¼•å…¥ä¾èµ–</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ç¼–å†™é…ç½®æ–‡ä»¶</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.datasource.driver-class-name</span>=<span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line"><span class="attr">spring.datasource.url</span>=<span class="string">jdbc:mysql://localhost:3306/oauth?characterEncoding=UTF-8</span></span><br><span class="line"><span class="attr">spring.datasource.username</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">spring.datasource.password</span>=<span class="string">root</span></span><br></pre></td></tr></table></figure><p>ç¼–å†™æ•°æ®åº“ä¿¡æ¯å®ç°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableAuthorizationServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JdbcAuthorizationServer</span> <span class="keyword">extends</span> <span class="title class_">AuthorizationServerConfigurerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AuthenticationManager authenticationManager;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PasswordEncoder passwordEncoder;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DataSource dataSource;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">JdbcAuthorizationServer</span><span class="params">(AuthenticationManager authenticationManager, PasswordEncoder passwordEncoder, DataSource dataSource)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.authenticationManager = authenticationManager;</span><br><span class="line">        <span class="built_in">this</span>.passwordEncoder = passwordEncoder;</span><br><span class="line">        <span class="built_in">this</span>.dataSource = dataSource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span> <span class="comment">// å£°æ˜TokenStoreå®ç°</span></span><br><span class="line">    <span class="keyword">public</span> TokenStore <span class="title function_">tokenStore</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">JdbcTokenStore</span>(dataSource);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span> <span class="comment">// å£°æ˜ ClientDetailså®ç°</span></span><br><span class="line">    <span class="keyword">public</span> ClientDetailsService <span class="title function_">clientDetails</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">JdbcClientDetailsService</span> <span class="variable">jdbcClientDetailsService</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JdbcClientDetailsService</span>(dataSource);</span><br><span class="line">        jdbcClientDetailsService.setPasswordEncoder(passwordEncoder);</span><br><span class="line">        <span class="keyword">return</span> jdbcClientDetailsService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="comment">//é…ç½®ä½¿ç”¨æ•°æ®åº“å®ç°</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthorizationServerEndpointsConfigurer endpoints)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        endpoints.authenticationManager(authenticationManager);<span class="comment">//è®¤è¯ç®¡ç†å™¨</span></span><br><span class="line">        endpoints.tokenStore(tokenStore());<span class="comment">//é…ç½®ä»¤ç‰Œå­˜å‚¨ä¸ºæ•°æ®åº“å­˜å‚¨</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// é…ç½®TokenServiceså‚æ•°</span></span><br><span class="line">        <span class="type">DefaultTokenServices</span> <span class="variable">tokenServices</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DefaultTokenServices</span>();<span class="comment">//ä¿®æ”¹é»˜è®¤ä»¤ç‰Œç”ŸæˆæœåŠ¡</span></span><br><span class="line">        tokenServices.setTokenStore(endpoints.getTokenStore());<span class="comment">//åŸºäºæ•°æ®åº“ä»¤ç‰Œç”Ÿæˆ</span></span><br><span class="line">        tokenServices.setSupportRefreshToken(<span class="literal">true</span>);<span class="comment">//æ˜¯å¦æ”¯æŒåˆ·æ–°ä»¤ç‰Œ</span></span><br><span class="line">        tokenServices.setReuseRefreshToken(<span class="literal">true</span>);<span class="comment">//æ˜¯å¦é‡å¤ä½¿ç”¨åˆ·æ–°ä»¤ç‰Œï¼ˆç›´åˆ°è¿‡æœŸï¼‰</span></span><br><span class="line"></span><br><span class="line">        tokenServices.setClientDetailsService(endpoints.getClientDetailsService());<span class="comment">//è®¾ç½®å®¢æˆ·ç«¯ä¿¡æ¯</span></span><br><span class="line">        tokenServices.setTokenEnhancer(endpoints.getTokenEnhancer());<span class="comment">//ç”¨æ¥æ§åˆ¶ä»¤ç‰Œå­˜å‚¨å¢å¼ºç­–ç•¥</span></span><br><span class="line">        <span class="comment">//è®¿é—®ä»¤ç‰Œçš„é»˜è®¤æœ‰æ•ˆæœŸï¼ˆä»¥ç§’ä¸ºå•ä½ï¼‰ã€‚è¿‡æœŸçš„ä»¤ç‰Œä¸ºé›¶æˆ–è´Ÿæ•°ã€‚</span></span><br><span class="line">        tokenServices.setAccessTokenValiditySeconds((<span class="type">int</span>) TimeUnit.DAYS.toSeconds(<span class="number">30</span>)); <span class="comment">// 30å¤©</span></span><br><span class="line">        <span class="comment">//åˆ·æ–°ä»¤ç‰Œçš„æœ‰æ•ˆæ€§ï¼ˆä»¥ç§’ä¸ºå•ä½ï¼‰ã€‚å¦‚æœå°äºæˆ–ç­‰äºé›¶ï¼Œåˆ™ä»¤ç‰Œå°†ä¸ä¼šè¿‡æœŸ</span></span><br><span class="line">        tokenServices.setRefreshTokenValiditySeconds((<span class="type">int</span>) TimeUnit.DAYS.toSeconds(<span class="number">3</span>)); <span class="comment">//3å¤©</span></span><br><span class="line">        endpoints.tokenServices(tokenServices);<span class="comment">//ä½¿ç”¨é…ç½®ä»¤ç‰ŒæœåŠ¡</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(ClientDetailsServiceConfigurer clients)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        clients.withClientDetails(clientDetails());<span class="comment">//ä½¿ç”¨ jdbcå­˜å‚¨</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯åŠ¨æµ‹è¯•,å‘ç°æ•°æ®åº“ä¸­å·²ç»å­˜å‚¨ç›¸å…³çš„ä»¤ç‰Œ</p><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220811220339448.png" class=""><h3 id="èµ„æºæœåŠ¡å™¨æ­å»º"><a href="#èµ„æºæœåŠ¡å™¨æ­å»º" class="headerlink" title="èµ„æºæœåŠ¡å™¨æ­å»º"></a>èµ„æºæœåŠ¡å™¨æ­å»º</h3><p>å¼•å…¥ä¾èµ–</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.reporting.outputEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.reporting.outputEncoding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">spring-boot.version</span>&gt;</span>2.2.5.RELEASE<span class="tag">&lt;/<span class="name">spring-boot.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">spring-cloud.version</span>&gt;</span>Hoxton.SR9<span class="tag">&lt;/<span class="name">spring-cloud.version</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-oauth2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.security<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-security-oauth2-resource-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.junit.vintage<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit-vintage-engine<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.security<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-security-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-cloud.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring-boot.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br></pre></td></tr></table></figure><p>åˆ›å»ºèµ„æº</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloController</span> &#123;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/hello&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;hello!&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¼–å†™èµ„æºæœåŠ¡å™¨é…ç½®ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableResourceServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ResourceServerConfig</span> <span class="keyword">extends</span> <span class="title class_">ResourceServerConfigurerAdapter</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DataSource dataSource;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ResourceServerConfig</span><span class="params">(DataSource dataSource)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.dataSource = dataSource;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(ResourceServerSecurityConfigurer resources)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        resources.tokenStore(tokenStore());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> TokenStore <span class="title function_">tokenStore</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">JdbcTokenStore</span>(dataSource);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¼–å†™é…ç½®æ–‡ä»¶</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åº”ç”¨æœåŠ¡ WEB è®¿é—®ç«¯å£</span></span><br><span class="line"><span class="attr">server.port</span>=<span class="string">8081</span></span><br><span class="line"><span class="attr">spring.datasource.driver-class-name</span>=<span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line"><span class="attr">spring.datasource.url</span>=<span class="string">jdbc:mysql://localhost:3306/security?characterEncoding=UTF-8</span></span><br><span class="line"><span class="attr">spring.datasource.username</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">spring.datasource.password</span>=<span class="string">root</span></span><br><span class="line"><span class="attr">logging.level.org.springframework.jdbc.core</span>=<span class="string">debug</span></span><br></pre></td></tr></table></figure><p>å¯åŠ¨æµ‹è¯•,ç”Ÿæˆä»¤ç‰Œä¹‹åå¸¦æœ‰ä»¤ç‰Œè®¿é—®:</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -H &quot;Authorization:Bearer dffa62d2-1078-457e-8a2b-4bd46fae0f47&quot; http://localhost:8081/hello</span><br></pre></td></tr></table></figure><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220812153300057.png" class=""><h2 id="ä½¿ç”¨-JWT"><a href="#ä½¿ç”¨-JWT" class="headerlink" title="ä½¿ç”¨ JWT"></a>ä½¿ç”¨ JWT</h2><h3 id="æˆæƒæœåŠ¡å™¨é¢å‘-JWT-ä»¤ç‰Œ"><a href="#æˆæƒæœåŠ¡å™¨é¢å‘-JWT-ä»¤ç‰Œ" class="headerlink" title="æˆæƒæœåŠ¡å™¨é¢å‘ JWT ä»¤ç‰Œ"></a>æˆæƒæœåŠ¡å™¨é¢å‘ JWT ä»¤ç‰Œ</h3><p>é…ç½®é¢å‘ JWT ä»¤ç‰Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableAuthorizationServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JwtAuthServerConfig</span> <span class="keyword">extends</span> <span class="title class_">AuthorizationServerConfigurerAdapter</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PasswordEncoder passwordEncoder;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AuthenticationManager authenticationManager;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DataSource dataSource;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">JwtAuthServerConfig</span><span class="params">(PasswordEncoder passwordEncoder, AuthenticationManager authenticationManager, DataSource dataSource)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.passwordEncoder = passwordEncoder;</span><br><span class="line">        <span class="built_in">this</span>.authenticationManager = authenticationManager;</span><br><span class="line">        <span class="built_in">this</span>.dataSource = dataSource;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span> <span class="comment">//é…ç½®ä½¿ç”¨ jwt æ–¹å¼é¢å‘ä»¤ç‰Œ,åŒæ—¶é…ç½® jwt è½¬æ¢å™¨</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(AuthorizationServerEndpointsConfigurer endpoints)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        endpoints.tokenStore(tokenStore())</span><br><span class="line">                .accessTokenConverter(jwtAccessTokenConverter())</span><br><span class="line">                .authenticationManager(authenticationManager);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span><span class="comment">//ä½¿ç”¨JWTæ–¹å¼ç”Ÿæˆä»¤ç‰Œ</span></span><br><span class="line">    <span class="keyword">public</span> TokenStore <span class="title function_">tokenStore</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">JwtTokenStore</span>(jwtAccessTokenConverter());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span><span class="comment">//ä½¿ç”¨åŒä¸€ä¸ªå¯†é’¥æ¥ç¼–ç  JWT ä¸­çš„  OAuth2 ä»¤ç‰Œ</span></span><br><span class="line">    <span class="keyword">public</span> JwtAccessTokenConverter <span class="title function_">jwtAccessTokenConverter</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">JwtAccessTokenConverter</span> <span class="variable">converter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JwtAccessTokenConverter</span>();</span><br><span class="line">        converter.setSigningKey(<span class="string">&quot;123&quot;</span>);<span class="comment">//å¯ä»¥é‡‡ç”¨å±æ€§æ³¨å…¥æ–¹å¼ ç”Ÿäº§ä¸­å»ºè®®åŠ å¯†</span></span><br><span class="line">        <span class="keyword">return</span> converter;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span> <span class="comment">// å£°æ˜ ClientDetailså®ç°</span></span><br><span class="line">    <span class="keyword">public</span> ClientDetailsService <span class="title function_">clientDetails</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">JdbcClientDetailsService</span> <span class="variable">jdbcClientDetailsService</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JdbcClientDetailsService</span>(dataSource);</span><br><span class="line">        jdbcClientDetailsService.setPasswordEncoder(passwordEncoder);</span><br><span class="line">        <span class="keyword">return</span> jdbcClientDetailsService;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span><span class="comment">//ä½¿ç”¨æ•°æ®åº“æ–¹å¼å®¢æˆ·ç«¯å­˜å‚¨</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(ClientDetailsServiceConfigurer clients)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        clients.withClientDetails(clientDetails());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯åŠ¨æœåŠ¡,æ ¹æ®æˆæƒç è·å–ä»¤ç‰Œ</p><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220812155121319.png" class=""><h3 id="ä½¿ç”¨-JWT-ä»¤ç‰Œèµ„æºæœåŠ¡å™¨"><a href="#ä½¿ç”¨-JWT-ä»¤ç‰Œèµ„æºæœåŠ¡å™¨" class="headerlink" title="ä½¿ç”¨ JWT ä»¤ç‰Œèµ„æºæœåŠ¡å™¨"></a>ä½¿ç”¨ JWT ä»¤ç‰Œèµ„æºæœåŠ¡å™¨</h3><p>é…ç½®èµ„æºæœåŠ¡å™¨è§£æjwt</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableResourceServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JwtResourceServerConfig</span> <span class="keyword">extends</span> <span class="title class_">ResourceServerConfigurerAdapter</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(ResourceServerSecurityConfigurer resources)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        resources.tokenStore(tokenStore());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> TokenStore <span class="title function_">tokenStore</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">JwtTokenStore</span>(jwtAccessTokenConverter());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> JwtAccessTokenConverter <span class="title function_">jwtAccessTokenConverter</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">JwtAccessTokenConverter</span> <span class="variable">jwtAccessTokenConverter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JwtAccessTokenConverter</span>();</span><br><span class="line">        jwtAccessTokenConverter.setSigningKey(<span class="string">&quot;123&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> jwtAccessTokenConverter;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯åŠ¨æµ‹è¯•,é€šè¿‡ jwt ä»¤ç‰Œè®¿é—®èµ„æº</p><figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -H &quot;Authorization:Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE2NjAzMzM4MjgsInVzZXJfbmFtZSI6InJvb3QiLCJhdXRob3JpdGllcyI6WyJST0xFX0FETUlOIl0sImp0aSI6ImJmZGVjMzg1LWQyYmYtNDc5Yi05YjhhLTgyZWE4YTRkNzgzMyIsImNsaWVudF9pZCI6ImNsaWVudCIsInNjb3BlIjpbImFwcDpyZWFkIl19.QlELW7LMLuD4OghbEFFzJpIxjW80hC3WHd3I0PiuI7Y&quot; http://localhost:8081/hello</span><br></pre></td></tr></table></figure><img src="/2023/06/24/SpringSecurity%C2%A9%E7%BC%96%E7%A8%8B%E4%B8%8D%E8%89%AF%E4%BA%BA/image-20220812160042315.png" class="">]]></content>
      
      
      <categories>
          
          <category> SpringSecurity </category>
          
          <category> å®‰å…¨è®¤è¯æ¡†æ¶ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
            <tag> SpringSecurity </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>YlanMini-Spring Â© pepsi-wyl</title>
      <link href="/2023/04/26/YlanMini-Spring-%C2%A9-pepsi-wyl/"/>
      <url>/2023/04/26/YlanMini-Spring-%C2%A9-pepsi-wyl/</url>
      
        <content type="html"><![CDATA[<h1 id="YlanMini-Spring"><a href="#YlanMini-Spring" class="headerlink" title="YlanMini-Spring"></a>YlanMini-Spring</h1><h2 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h2><p>Githubä»“åº“é“¾æ¥: <a href="https://github.com/pepsi-wyl/YlanMini-Spring">https://github.com/pepsi-wyl/YlanMini-Spring</a>  </p><img src="/2023/04/26/YlanMini-Spring-%C2%A9-pepsi-wyl/1682429105899-8a176b27-715f-4670-b259-b13d6d3c8672.png" class=""> <p>ä¸€ä¸ªç®€åŒ–ç‰ˆçš„springæ¡†æ¶ï¼Œä¸»è¦å®ç°äº† Spring IOC(ä¾èµ–æ³¨å…¥) å’Œ Spring AOP(é¢å‘åˆ‡é¢ç¼–ç¨‹)ï¼Œå®ç°è¾ƒSpringæºç ç®€å•ï¼Œæœ‰åŠ©äºå­¦ä¹ å’Œç†è§£Springæ€æƒ³å’Œæºç ã€‚ï¼Œä¸»è¦å®ç°äº† Spring IOC(ä¾èµ–æ³¨å…¥) å’Œ Spring AOP(é¢å‘åˆ‡é¢ç¼–ç¨‹)ï¼Œå®ç°è¾ƒSpringæºç ç®€å•ï¼Œæœ‰åŠ©äºå­¦ä¹ å’Œç†è§£Springæ€æƒ³å’Œæºç ã€‚<br>ä½¿ç”¨ä¸‰çº§ç¼“å­˜è§£å†³å±æ€§æ³¨å…¥å’Œsetæ–¹æ³•æ³¨å…¥çš„å¾ªç¯ä¾èµ–é—®é¢˜ï¼Œ@Lazyæ³¨è§£ã€ObjectFactory è§£å†³æ„é€ æ–¹æ³•æ³¨å…¥çš„å¾ªç¯ä¾èµ–é—®é¢˜ã€‚<br>å®Œæˆäº†5ç§é€šçŸ¥ç±»å‹ (@Beforeã€ @AfterReturningã€@Afterã€@AfterThrowingã€@Around)çš„è§£æï¼Œå¯¹ç¬¦åˆåˆ‡ç‚¹çš„ç›®æ ‡å¯¹è±¡è¿›è¡Œä»£ç†å¢å¼ºï¼Œå¹¶å¯¹é€šçŸ¥è¿›è¡Œé¡ºåºé“¾å¼è°ƒç”¨ã€‚</p><h2 id="IOC"><a href="#IOC" class="headerlink" title="IOC"></a>IOC</h2><h3 id="å®ç°åŠŸèƒ½åŠä¸»è¦æµç¨‹"><a href="#å®ç°åŠŸèƒ½åŠä¸»è¦æµç¨‹" class="headerlink" title="å®ç°åŠŸèƒ½åŠä¸»è¦æµç¨‹"></a>å®ç°åŠŸèƒ½åŠä¸»è¦æµç¨‹</h3><ol><li>å®Œæˆç»„ä»¶çš„æ‰«æï¼Œç”¨ @Componentæ³¨è§£ æ ‡è®°ç»„ä»¶ï¼Œç”¨ @Scopeæ³¨è§£ æ ‡è®°ç»„ä»¶ä½œç”¨åŸŸï¼Œç”¨ @ComponentScanæ³¨è§£ æ ‡è®°è¦æ‰«æçš„åŒ…ï¼Œ åœ¨å®¹å™¨åˆå§‹åŒ–æ—¶é€’å½’æ‰«ææŒ‡å®šåŒ…ä¸‹çš„ç»„ä»¶ï¼Œå¹¶å°è£…æˆBeanDefinitionï¼Œå…¶å­˜å‚¨Beançš„scopeå±æ€§å’Œclazzå±æ€§ï¼Œå¹¶æœ€åæ·»åŠ åˆ° beanDefinitionMapä¸­ï¼Œå…¶keyä¸ºbeanNameï¼Œvalueä¸ºBeanDefinitionå¯¹è±¡ã€‚</li><li>å®Œæˆ BeanPostProcessor çš„æ³¨å†Œï¼ŒåŒ…æ‹¬æ³¨å†Œ AnnotationAwareAspectJAutoProxyCreatorç±» æ¥è¿›è¡ŒAOPè‡ªåŠ¨åˆ›å»ºä»£ç†å’Œæ³¨å†Œç”¨æˆ·è‡ªå®šä¹‰çš„ BeanPostProcessorï¼Œå¹¶å¯¹è¿™äº›ç»„ä»¶è¿›è¡Œå®ä¾‹åŒ–æ”¾å…¥ singletonObjectså•ä¾‹æ± ã€Œä¸€çº§ç¼“å­˜ã€ä¸­ï¼Œå¹¶æœ€åæ·»åŠ åˆ° beanPostProcessorListä¸­ä¿å­˜ã€‚</li><li>å®Œæˆ Bean ç”Ÿå‘½å‘¨æœŸã€Œåˆ›å»ºã€ä¾èµ–æ³¨å…¥ã€åˆå§‹åŒ–ã€é”€æ¯ã€ã€‚</li><li>åˆ›å»º Bean å¯¹è±¡å‰ï¼Œå¯¹å½“å‰æ­£åœ¨åˆ›å»ºçš„ Bean è¿›è¡Œæ£€æŸ¥ï¼Œå¦‚æœå½“å‰Beançš„å®ä¾‹æ­£åœ¨åˆ›å»ºåˆ™æŠ›å‡ºå¼‚å¸¸ï¼Œå•ä¾‹Bean åˆ©ç”¨ singletonsCurrentlyInCreationé›†åˆ ä¸­æ˜¯å¦å­˜å‚¨è¯¥Beanï¼ŒåŸå‹Beanåˆ™åˆ©ç”¨ThreadLocalè¿›è¡Œæ£€æŸ¥ã€‚</li><li>åˆ›å»º Bean å¯¹è±¡å®ä¾‹é˜¶æ®µï¼Œé¦–é€‰æ— å‚æ„é€ å™¨è¿›è¡Œåˆ›å»ºå¯¹è±¡ï¼Œæ²¡æœ‰æ— å‚æ„é€ å™¨æ—¶åªèƒ½é€‰ç”¨æœ‰å‚æ„é€ å™¨ã€‚é€‰ç”¨æœ‰å‚æ„é€ å™¨æ³¨å…¥æ—¶ï¼Œæ²¡æœ‰å‘ç”Ÿå¾ªç¯ä¾èµ–æ—¶ç›´æ¥ä»å®¹å™¨ä¸­å–å¯¹è±¡ä¾èµ–æ³¨å…¥å³å¯ï¼Œå‘ç”Ÿå¾ªç¯ä¾èµ–æ—¶ï¼Œä½¿ç”¨ @Lazyæ³¨è§£ ç›´æ¥ç”Ÿæˆä»£ç†å¯¹è±¡æˆ– ObjectFactory ç”Ÿæˆä¸‰çº§ç¼“å­˜è¿›è¡Œè§£å†³ã€‚</li><li>åˆ›å»º Bean å¯¹è±¡ä¾èµ–æ³¨å…¥é˜¶æ®µï¼Œè§£æå­—æ®µå’Œæ„é€ æ–¹æ³•ä¸Šçš„ @Autowiredæ³¨è§£ï¼Œå­—æ®µä¸Šçš„ @Autowiredæ³¨è§£ ç›´æ¥æ ¹æ®å­—æ®µåç§°ä»å®¹å™¨ä¸­ byName æŸ¥æ‰¾ä¾èµ–ï¼Œæ„é€ æ–¹æ³•ä¸Šçš„ @Autowiredæ³¨è§£ ç›´æ¥æ ¹æ®å‚æ•°åç§°ä»å®¹å™¨ä¸­ byName æŸ¥æ‰¾ä¾èµ–ç„¶åinvokeæ–¹æ³•åå°„æ³¨å…¥å±æ€§ã€‚</li><li>åˆ›å»º Bean å¯¹è±¡åˆå§‹åŒ–é˜¶æ®µï¼Œé¦–å…ˆå®Œæˆ å„ç§Awareæ¥å£ å›è°ƒï¼Œç„¶åå®Œæˆ BeanPostProcessor ä¸­ postProcessBeforeInitializationæ–¹æ³• çš„è°ƒç”¨ï¼Œç„¶åå®Œæˆ InitializingBean ä¸­ afterPropertiesSetæ–¹æ³• çš„è°ƒç”¨ï¼Œæœ€åå®Œæˆ BeanPostProcessor ä¸­ postProcessAfterInitializationæ–¹æ³• çš„è°ƒç”¨ï¼Œå…¶ä¸­postProcessAfterInitializationæ–¹æ³• çš„è°ƒç”¨æ˜¯æ‰§è¡ŒAOPè‡ªåŠ¨ä»£ç†çš„æ­£å¸¸å…¥å£ã€‚</li><li>åˆ›å»º Bean å¯¹è±¡æ³¨å†ŒDisposableBeané˜¶æ®µï¼Œå°†å®ç° DisposableBeanæ¥å£ æˆ–è€… AutoCloseableæ¥å£ çš„ç±»åˆ©ç”¨é€‚é…å™¨æ¨¡å¼å°è£…è¿›DisposableBeanAdapterä¸­å¹¶å­˜å…¥ disposableBeans Mapä¸­ï¼Œåœ¨å¯¹è±¡é”€æ¯å’Œå®¹å™¨é”€æ¯æ—¶ç›´æ¥è°ƒç”¨è¯¥é›†åˆå³å¯ã€‚</li><li>åˆ›å»º Bean å¯¹è±¡åï¼Œå¯¹å½“å‰æ­£åœ¨åˆ›å»ºçš„ Bean è¿›è¡Œæ£€æŸ¥ï¼Œå¦‚æœå½“å‰Beançš„å®ä¾‹è¢«å…¶ä»–çº¿ç¨‹ä¿®æ”¹åˆ™æŠ›å‡ºå¼‚å¸¸ï¼Œå•ä¾‹Bean åˆ©ç”¨ singletonsCurrentlyInCreationé›†åˆ ä¸­æ˜¯å¦å­˜å‚¨è¯¥Beanï¼ŒåŸå‹Beanåˆ™åˆ©ç”¨ThreadLocalè¿›è¡Œæ£€æŸ¥ã€‚</li><li>å¯¹è±¡çš„é”€æ¯å’Œå®¹å™¨çš„é”€æ¯æ—¶ï¼Œç›´æ¥è°ƒç”¨disposableBeans Mapä¸­çš„å¯¹è±¡çš„é”€æ¯æ–¹æ³•ï¼Œå¦‚æœæ˜¯å®¹å™¨é”€æ¯åˆ™éœ€è¦æ¸…ç©ºä¸‰å¤„ç¼“å­˜ã€‚</li><li>æ•´ä¸ªIOCå®¹å™¨ä½¿ç”¨ä¸‰çº§ç¼“å­˜è¿›è¡Œè®¾è®¡ï¼Œè§£å†³ã€Œå±æ€§æ³¨å…¥å’Œ set æ–¹æ³•æ³¨å…¥ã€çš„å¾ªç¯ä¾èµ–é—®é¢˜ï¼Œä¹Ÿè§£å†³äº†æ¶‰åŠæ³¨å…¥ä»£ç†å¯¹è±¡çš„å¾ªç¯ä¾èµ–é—®é¢˜ï¼Œä½†å¾ªç¯ä¾èµ–çš„ä¸¤ä¸ªå¯¹è±¡è‡³å°‘æœ‰ä¸€ä¸ªæ˜¯å•ä¾‹ï¼Œä¸ç„¶ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚æ¯æ¬¡åœ¨getBeanè·å–å¯¹è±¡æ—¶ï¼Œéƒ½å…ˆæ‰§è¡ŒgetSingletonæ–¹æ³•ä»ä¸‰å¤„ç¼“å­˜ä¸­è·å–ï¼Œå¦‚æœåœ¨ä¸‰çº§ç¼“å­˜ä¸­æœ‰è¯¥å¯¹è±¡åˆ™æ‰§è¡Œ Lambdaè¡¨è¾¾å¼ç”Ÿæˆä»£ç†å¯¹è±¡æ‰§è¡ŒAOPæµç¨‹å¹¶æ”¾å…¥äºŒçº§ç¼“å­˜ä¸­ï¼Œå¦‚æœä¸‰å¤„ç¼“å­˜ä¸­éƒ½æ²¡æœ‰è¯¥å¯¹è±¡åˆ™è¿›è¡Œåˆ›å»ºBeanå¯¹è±¡ã€‚åˆ›å»ºBeanæ—¶èµ°ä¸Šè¿°Beançš„ç”Ÿå‘½å‘¨æœŸæµç¨‹ï¼Œ ä½†æ˜¯åˆ›å»ºçš„Beanéƒ½æ”¾åœ¨ä¸‰çº§ç¼“å­˜å¤„(æå‰æ›å…‰)ï¼Œç”±äºå¯èƒ½åœ¨ä¾èµ–æ³¨å…¥çš„æ˜¯æ—¶å€™é€ æˆå¾ªç¯ä¾èµ–ï¼Œä¸€æ—¦å‘ç”Ÿå¾ªç¯ä¾èµ–ï¼Œè¯¥ç±»Lambdaè¡¨è¾¾å¼ä¼šæ‰§è¡Œä»£ç†å¯¹è±¡ç”ŸæˆAOPæµç¨‹å¹¶æ”¾å…¥äºŒçº§ç¼“å­˜ä¸­(æ›å…‰æ—¶æœº)ï¼Œåˆ›å»ºBeanä¹‹åç›´æ¥æ”¾å…¥ä¸€çº§ç¼“å­˜ä¸­å³å¯ã€‚</li></ol><h3 id="å›¾è§£"><a href="#å›¾è§£" class="headerlink" title="å›¾è§£"></a>å›¾è§£</h3><h5 id="å•ä¾‹setterå¾ªç¯ä¾èµ–"><a href="#å•ä¾‹setterå¾ªç¯ä¾èµ–" class="headerlink" title="å•ä¾‹setterå¾ªç¯ä¾èµ–"></a>å•ä¾‹setterå¾ªç¯ä¾èµ–</h5><img src="/2023/04/26/YlanMini-Spring-%C2%A9-pepsi-wyl/1682491617628-3d9e0643-b22c-4ebc-95c1-85b35ceb69f8.png" class=""> <h5 id="å•ä¾‹æ„é€ å™¨æ³¨å…¥å¾ªç¯ä¾èµ–"><a href="#å•ä¾‹æ„é€ å™¨æ³¨å…¥å¾ªç¯ä¾èµ–" class="headerlink" title="å•ä¾‹æ„é€ å™¨æ³¨å…¥å¾ªç¯ä¾èµ–"></a>å•ä¾‹æ„é€ å™¨æ³¨å…¥å¾ªç¯ä¾èµ–</h5><img src="/2023/04/26/YlanMini-Spring-%C2%A9-pepsi-wyl/1682491945866-b87957b0-2feb-486b-9d65-8b5530cbdc30.png" class=""> <h5 id="AOPé‡ä¸Šå¾ªç¯ä¾èµ–"><a href="#AOPé‡ä¸Šå¾ªç¯ä¾èµ–" class="headerlink" title="AOPé‡ä¸Šå¾ªç¯ä¾èµ–"></a>AOPé‡ä¸Šå¾ªç¯ä¾èµ–</h5><img src="/2023/04/26/YlanMini-Spring-%C2%A9-pepsi-wyl/1682491032969-bf5926a0-e472-4d99-89b5-da01d3649693.jpeg" class=""> <h2 id="AOP"><a href="#AOP" class="headerlink" title="AOP"></a>AOP</h2><h3 id="å®ç°åŠŸèƒ½åŠä¸»è¦æµç¨‹-1"><a href="#å®ç°åŠŸèƒ½åŠä¸»è¦æµç¨‹-1" class="headerlink" title="å®ç°åŠŸèƒ½åŠä¸»è¦æµç¨‹"></a>å®ç°åŠŸèƒ½åŠä¸»è¦æµç¨‹</h3><ol><li>å®Œæˆåˆ‡é¢å’Œé€šçŸ¥çš„å®šä¹‰ï¼Œä½¿ç”¨ @Aspectæ³¨è§£ æ ‡è®°åˆ‡é¢ï¼Œä½¿ç”¨ @Beforeã€@AfterReturningã€@Afterã€@AfterThrowingã€@Around æ ‡è®°é€šçŸ¥ï¼Œä½¿ç”¨åˆ‡ç‚¹è¡¨è¾¾å¼expressionå®šä¹‰åˆ‡å…¥ç‚¹ï¼Œå¯¹ç¬¦åˆåˆ‡ç‚¹çš„ç›®æ ‡å¯¹è±¡è¿›è¡Œä»£ç†å¢å¼ºï¼Œåº”ç”¨åœ¨ç›®æ ‡æ–¹æ³•ä¸Šçš„å¤šä¸ªé€šçŸ¥ä¼šé“¾å¼è°ƒç”¨æ‰§è¡Œï¼Œä¸”å®ç°äº†é€šçŸ¥çš„è°ƒç”¨é¡ºåºæ§åˆ¶ Advisor åˆ‡é¢æ’åºã€‚</li><li>å¯ä»¥ä½¿ç”¨ AopContext è·å–å½“å‰çº¿ç¨‹æ­£åœ¨è¿è¡Œçš„ AOP ä»£ç†å¯¹è±¡ã€‚</li><li>é€šè¿‡ BeanPostProcessor çš„å®ç°ç±» AnnotationAwareAspectJAutoProxyCreator å¯¹ç¬¦åˆåˆ‡ç‚¹çš„ç›®æ ‡å¯¹è±¡è¿›è¡Œè‡ªåŠ¨ä»£ç†å¢å¼ºã€‚å‘ç”Ÿå¾ªç¯ä¾èµ–æ—¶åœ¨ä¾èµ–æ³¨å…¥é˜¶æ®µæ‰§è¡Œ SmartInstantiationAwareBeanPostProcessoræ¥å£ ä¸­çš„ getEarlyBeanReferenceæ–¹æ³• æå‰åˆ›å»ºä»£ç†ï¼Œåœ¨æ²¡æœ‰å‘ç”Ÿå¾ªç¯ä¾èµ–æ—¶æ‰§è¡ŒBeanPostProcessor æ¥å£ ä¸­çš„ postProcessAfterInitialization æ–¹æ³•åˆ›å»ºä»£ç†ï¼Œä½¿ç”¨ç¼“å­˜æŠ€æœ¯é¿å…äº†ä»£ç†å¯¹è±¡çš„é‡å¤åˆ›å»ºï¼Œä¸è®ºæ˜¯æå‰ä»£ç†è¿˜æ˜¯æ­£å¸¸ä»£ç†éƒ½ä¼šé€šè¿‡ wrapIfNecessary æ–¹æ³•(åˆ›å»ºä»£ç†å…¥å£)è¿›è¡Œåˆ›å»ºä»£ç†å¯¹è±¡ã€‚</li><li>åœ¨ wrapIfNecessary æ–¹æ³•æ‰§è¡Œæ—¶ï¼Œä¼šå»æ‰¾å…·å¤‡æ¡ä»¶çš„Advisorã€‚æ‰¾å…·å¤‡æ¡ä»¶çš„Advisorçš„æ—¶å€™ï¼Œä¼šå…ˆæ‰¾å€™é€‰Advisorã€‚åœ¨æ‰¾å€™é€‰Advisoræ—¶ï¼Œä¼šéå†IOCå®¹å™¨ä¸­æ‰€æœ‰Beanåˆ¤æ–­æ˜¯å¦æ˜¯ @Aspectæ³¨è§£ æ ‡è®°çš„ç±»ï¼Œå¹¶è°ƒç”¨ DefaultAspectJAdvisorFactoryç±» ä¸­çš„ getAdvisorsæ–¹æ³•è¿›è¡Œè§£æï¼Œå¹¶å¯¹æ¯ä¸€ä¸ªé€šçŸ¥å°è£…æˆDefaultPointcutAdvisor å³Pointcut&#x2F;MethodMatcherå’Œadviceï¼Œè¿”å›å€™é€‰Advisoré›†åˆï¼Œå…¶ä¸­å¯¹å€™é€‰Advisorä½¿ç”¨ç¼“å­˜æŠ€æœ¯ï¼Œå®¹å™¨åªä¼šåŠ è½½æ‰§è¡Œä¸€æ¬¡ã€‚æ‰¾åˆ°å€™é€‰æ¡ä»¶Advisoræ—¶ï¼Œéå†å€™é€‰Advisoré›†åˆæ‰§è¡ŒMethodMatcheræ¥å£ çš„ matchesæ–¹æ³• çœ‹æ˜¯å¦èƒ½åŒ¹é…ä¸Šè¯¥classï¼Œè¿”å›å…·å¤‡æ¡ä»¶çš„Advisoré›†åˆï¼Œä¹‹åå¯¹è¿™äº›å…·å¤‡æ¡ä»¶çš„Advisoré›†åˆåˆ©ç”¨æ¯”è¾ƒå™¨è¿›è¡Œæ’åºã€‚æœ€åæ‰§è¡Œ createProxy åˆ›å»ºä»£ç†ã€‚</li><li>æ‰§è¡Œ createProxy åˆ›å»ºä»£ç†æ—¶ï¼Œåˆ›å»º ProxyFactoryå·¥å‚å¹¶æ‰§è¡Œ getProxyæ–¹æ³•ã€‚getProxyæ–¹æ³•è°ƒç”¨ createAopProxyæ–¹æ³•ï¼Œåˆ¤æ–­ä»£ç†å¯¹è±¡ä½¿ç”¨JdkDynamicAopProxy è¿˜æ˜¯ ObjenesisCglibAopProxyï¼Œå¹¶è°ƒç”¨å…·ä½“å®ç°ç±»çš„ getProxyæ–¹æ³•ã€‚JdkDynamicAopProxy åœ¨ getProxyæ–¹æ³•ä¸­è°ƒç”¨Proxy.newProxyInstanceæ–¹æ³• ç”Ÿæˆä»£ç†ç±»ã€‚</li><li>JdkDynamicAopProxy åœ¨ invokeæ–¹æ³• ä¸­è°ƒç”¨ ProxyFactory çš„ getInterceptorsAndDynamicInterceptionAdviceæ–¹æ³•ï¼ŒæŠŠå…·å¤‡æ¡ä»¶çš„Advisorå°è£…æˆ MethodInterceptor å¯¹è±¡ï¼Œç”Ÿæˆæ‹¦æˆªå™¨é“¾ chain(methodInterceptors)ã€‚åˆ›å»º DefaultMethodInvocationå¯¹è±¡ å¹¶è°ƒç”¨ proceedæ–¹æ³•ï¼Œé€ä¸€è°ƒç”¨MethodInterceptorçš„ invokeæ–¹æ³•ï¼Œè€Œåœ¨MethodInterceptorçš„å®ç°ç±»ä¸­ä¼šè°ƒç”¨MethodInvocationçš„ proceedæ–¹æ³•ï¼Œè¿™æ ·æ ¹æ®è´£ä»»é“¾è®¾è®¡æ¨¡å¼æ‰§è¡ŒAdviceï¼Œè¾¾åˆ°äº†å¢å¼ºçš„ç›®çš„ã€‚</li></ol><h4 id="å›¾è§£-1"><a href="#å›¾è§£-1" class="headerlink" title="å›¾è§£"></a>å›¾è§£</h4><h5 id="æ‹¦æˆªå™¨æ‰§è¡Œé¡ºåº"><a href="#æ‹¦æˆªå™¨æ‰§è¡Œé¡ºåº" class="headerlink" title="æ‹¦æˆªå™¨æ‰§è¡Œé¡ºåº"></a>æ‹¦æˆªå™¨æ‰§è¡Œé¡ºåº</h5><img src="/2023/04/26/YlanMini-Spring-%C2%A9-pepsi-wyl/1682496493884-72bef4db-32df-4201-9f4a-19ab590dd141.png" class=""> <h5 id="AOPè‡ªåŠ¨ä»£ç†æ—¶æœº"><a href="#AOPè‡ªåŠ¨ä»£ç†æ—¶æœº" class="headerlink" title="AOPè‡ªåŠ¨ä»£ç†æ—¶æœº"></a>AOPè‡ªåŠ¨ä»£ç†æ—¶æœº</h5><img src="/2023/04/26/YlanMini-Spring-%C2%A9-pepsi-wyl/1682496569323-480d90df-ab55-4a61-b936-155b5325364f.png" class=""> <h5 id="AOPé‡ä¸Šå¾ªç¯ä¾èµ–-1"><a href="#AOPé‡ä¸Šå¾ªç¯ä¾èµ–-1" class="headerlink" title="AOPé‡ä¸Šå¾ªç¯ä¾èµ–"></a>AOPé‡ä¸Šå¾ªç¯ä¾èµ–</h5><img src="/2023/04/26/YlanMini-Spring-%C2%A9-pepsi-wyl/1682496461092-420886a1-b2aa-4d53-aaf4-f79b6de5eadf.jpeg" class=""> <h2 id="ä½¿ç”¨åˆ°çš„è®¾è®¡æ¨¡å¼"><a href="#ä½¿ç”¨åˆ°çš„è®¾è®¡æ¨¡å¼" class="headerlink" title="ä½¿ç”¨åˆ°çš„è®¾è®¡æ¨¡å¼"></a>ä½¿ç”¨åˆ°çš„è®¾è®¡æ¨¡å¼</h2><ul><li>å•ä¾‹(æ¯”è¾ƒå™¨)</li><li>å·¥å‚(ObjectFactoryä¸‰çº§ç¼“å­˜)</li><li>ä»£ç†(JDK ç”ŸæˆåŠ¨æ€ä»£ç†å¯¹è±¡)</li><li>è´£ä»»é“¾(é€šçŸ¥çš„é“¾å¼è°ƒç”¨)</li><li>é€‚é…å™¨(é€‚é…å„ç§é”€æ¯æ–¹æ³•çš„è°ƒç”¨)</li></ul><h2 id="è‡´è°¢"><a href="#è‡´è°¢" class="headerlink" title="è‡´è°¢"></a>è‡´è°¢</h2><p>Spring IOCæºç è§£æ <a href="https://blog.csdn.net/chaitoudaren/category_9799707.html">https://blog.csdn.net/chaitoudaren/category_9799707.html</a><br>Spring AOPæºç è§£æ <a href="https://blog.csdn.net/chaitoudaren/category_9803816.html">https://blog.csdn.net/chaitoudaren/category_9803816.html</a>  </p>]]></content>
      
      
      <categories>
          
          <category> Spring </category>
          
          <category> é¡¹ç›® </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Spring </tag>
            
            <tag> IOC </tag>
            
            <tag> AOP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JUC</title>
      <link href="/2023/04/02/JUC/"/>
      <url>/2023/04/02/JUC/</url>
      
        <content type="html"><![CDATA[<h1 id="JUC"><a href="#JUC" class="headerlink" title="JUC"></a>JUC</h1><h2 id="è¿›ç¨‹"><a href="#è¿›ç¨‹" class="headerlink" title="è¿›ç¨‹"></a>è¿›ç¨‹</h2><h3 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h3><p>è¿›ç¨‹ï¼šç¨‹åºæ˜¯é™æ­¢çš„ï¼Œè¿›ç¨‹å®ä½“çš„è¿è¡Œè¿‡ç¨‹å°±æ˜¯è¿›ç¨‹ï¼Œæ˜¯ç³»ç»Ÿè¿›è¡Œ<strong>èµ„æºåˆ†é…çš„åŸºæœ¬å•ä½</strong></p><p>è¿›ç¨‹çš„ç‰¹å¾ï¼šå¹¶å‘æ€§ã€å¼‚æ­¥æ€§ã€åŠ¨æ€æ€§ã€ç‹¬ç«‹æ€§ã€ç»“æ„æ€§</p><p><strong>çº¿ç¨‹</strong>ï¼šçº¿ç¨‹æ˜¯å±äºè¿›ç¨‹çš„ï¼Œæ˜¯ä¸€ä¸ªåŸºæœ¬çš„ CPU æ‰§è¡Œå•å…ƒï¼Œæ˜¯ç¨‹åºæ‰§è¡Œæµçš„æœ€å°å•å…ƒã€‚çº¿ç¨‹æ˜¯è¿›ç¨‹ä¸­çš„ä¸€ä¸ªå®ä½“ï¼Œæ˜¯ç³»ç»Ÿ<strong>ç‹¬ç«‹è°ƒåº¦çš„åŸºæœ¬å•ä½</strong>ï¼Œçº¿ç¨‹æœ¬èº«ä¸æ‹¥æœ‰ç³»ç»Ÿèµ„æºï¼Œåªæ‹¥æœ‰ä¸€ç‚¹åœ¨è¿è¡Œä¸­å¿…ä¸å¯å°‘çš„èµ„æºï¼Œä¸åŒå±ä¸€ä¸ªè¿›ç¨‹çš„å…¶ä»–çº¿ç¨‹å…±äº«è¿›ç¨‹æ‰€æ‹¥æœ‰çš„å…¨éƒ¨èµ„æº</p><p>å…³ç³»ï¼šä¸€ä¸ªè¿›ç¨‹å¯ä»¥åŒ…å«å¤šä¸ªçº¿ç¨‹ï¼Œè¿™å°±æ˜¯å¤šçº¿ç¨‹ï¼Œæ¯”å¦‚çœ‹è§†é¢‘æ˜¯è¿›ç¨‹ï¼Œå›¾ç”»ã€å£°éŸ³ã€å¹¿å‘Šç­‰å°±æ˜¯å¤šä¸ªçº¿ç¨‹</p><p>çº¿ç¨‹çš„ä½œç”¨ï¼šä½¿å¤šé“ç¨‹åºæ›´å¥½çš„å¹¶å‘æ‰§è¡Œï¼Œæé«˜èµ„æºåˆ©ç”¨ç‡å’Œç³»ç»Ÿååé‡ï¼Œå¢å¼ºæ“ä½œç³»ç»Ÿçš„å¹¶å‘æ€§èƒ½</p><p>å¹¶å‘å¹¶è¡Œï¼š</p><ul><li>å¹¶è¡Œï¼šåœ¨åŒä¸€æ—¶åˆ»ï¼Œæœ‰å¤šä¸ªæŒ‡ä»¤åœ¨å¤šä¸ª CPU ä¸ŠåŒæ—¶æ‰§è¡Œ</li><li>å¹¶å‘ï¼šåœ¨åŒä¸€æ—¶åˆ»ï¼Œæœ‰å¤šä¸ªæŒ‡ä»¤åœ¨å•ä¸ª CPU ä¸Šäº¤æ›¿æ‰§è¡Œ</li></ul><p>åŒæ­¥å¼‚æ­¥ï¼š</p><ul><li>éœ€è¦ç­‰å¾…ç»“æœè¿”å›ï¼Œæ‰èƒ½ç»§ç»­è¿è¡Œå°±æ˜¯åŒæ­¥</li><li>ä¸éœ€è¦ç­‰å¾…ç»“æœè¿”å›ï¼Œå°±èƒ½ç»§ç»­è¿è¡Œå°±æ˜¯å¼‚æ­¥</li></ul><p>å‚è€ƒè§†é¢‘ï¼š<a href="https://www.bilibili.com/video/BV16J411h7Rd">https://www.bilibili.com/video/BV16J411h7Rd</a></p><p>ç¬”è®°çš„æ•´ä½“ç»“æ„ä¾æ®è§†é¢‘ç¼–å†™ï¼Œå¹¶éšç€å­¦ä¹ çš„æ·±å…¥è¡¥å……äº†å¾ˆå¤šçŸ¥è¯†</p><hr><h3 id="å¯¹æ¯”"><a href="#å¯¹æ¯”" class="headerlink" title="å¯¹æ¯”"></a>å¯¹æ¯”</h3><p>çº¿ç¨‹è¿›ç¨‹å¯¹æ¯”ï¼š</p><ul><li><p>è¿›ç¨‹åŸºæœ¬ä¸Šç›¸äº’ç‹¬ç«‹çš„ï¼Œè€Œçº¿ç¨‹å­˜åœ¨äºè¿›ç¨‹å†…ï¼Œæ˜¯è¿›ç¨‹çš„ä¸€ä¸ªå­é›†</p></li><li><p>è¿›ç¨‹æ‹¥æœ‰å…±äº«çš„èµ„æºï¼Œå¦‚å†…å­˜ç©ºé—´ç­‰ï¼Œä¾›å…¶<strong>å†…éƒ¨çš„çº¿ç¨‹å…±äº«</strong></p></li><li><p>è¿›ç¨‹é—´é€šä¿¡è¾ƒä¸ºå¤æ‚</p><p>åŒä¸€å°è®¡ç®—æœºçš„è¿›ç¨‹é€šä¿¡ç§°ä¸º IPCï¼ˆInter-process communicationï¼‰</p><ul><li>ä¿¡å·é‡ï¼šä¿¡å·é‡æ˜¯ä¸€ä¸ªè®¡æ•°å™¨ï¼Œç”¨äºå¤šè¿›ç¨‹å¯¹å…±äº«æ•°æ®çš„è®¿é—®ï¼Œè§£å†³åŒæ­¥ç›¸å…³çš„é—®é¢˜å¹¶é¿å…ç«äº‰æ¡ä»¶</li><li>å…±äº«å­˜å‚¨ï¼šå¤šä¸ªè¿›ç¨‹å¯ä»¥è®¿é—®åŒä¸€å—å†…å­˜ç©ºé—´ï¼Œéœ€è¦ä½¿ç”¨ä¿¡å·é‡ç”¨æ¥åŒæ­¥å¯¹å…±äº«å­˜å‚¨çš„è®¿é—®</li><li>ç®¡é“é€šä¿¡ï¼šç®¡é“æ˜¯ç”¨äºè¿æ¥ä¸€ä¸ªè¯»è¿›ç¨‹å’Œä¸€ä¸ªå†™è¿›ç¨‹ä»¥å®ç°å®ƒä»¬ä¹‹é—´é€šä¿¡çš„ä¸€ä¸ªå…±äº«æ–‡ä»¶ pipe æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶åŒä¸€æ—¶é—´åªå…è®¸ä¸€ä¸ªè¿›ç¨‹è®¿é—®ï¼Œæ‰€ä»¥åªæ”¯æŒ<strong>åŠåŒå·¥é€šä¿¡</strong><ul><li>åŒ¿åç®¡é“ï¼ˆPipesï¼‰ï¼šç”¨äºå…·æœ‰äº²ç¼˜å…³ç³»çš„çˆ¶å­è¿›ç¨‹é—´æˆ–è€…å…„å¼Ÿè¿›ç¨‹ä¹‹é—´çš„é€šä¿¡</li><li>å‘½åç®¡é“ï¼ˆNames Pipesï¼‰ï¼šä»¥ç£ç›˜æ–‡ä»¶çš„æ–¹å¼å­˜åœ¨ï¼Œå¯ä»¥å®ç°æœ¬æœºä»»æ„ä¸¤ä¸ªè¿›ç¨‹é€šä¿¡ï¼Œéµå¾ª FIFO</li></ul></li><li>æ¶ˆæ¯é˜Ÿåˆ—ï¼šå†…æ ¸ä¸­å­˜å‚¨æ¶ˆæ¯çš„é“¾è¡¨ï¼Œç”±æ¶ˆæ¯é˜Ÿåˆ—æ ‡è¯†ç¬¦æ ‡è¯†ï¼Œèƒ½åœ¨ä¸åŒè¿›ç¨‹ä¹‹é—´æä¾›<strong>å…¨åŒå·¥é€šä¿¡</strong>ï¼Œå¯¹æ¯”ç®¡é“ï¼š<ul><li>åŒ¿åç®¡é“å­˜åœ¨äºå†…å­˜ä¸­çš„æ–‡ä»¶ï¼›å‘½åç®¡é“å­˜åœ¨äºå®é™…çš„ç£ç›˜ä»‹è´¨æˆ–è€…æ–‡ä»¶ç³»ç»Ÿï¼›æ¶ˆæ¯é˜Ÿåˆ—å­˜æ”¾åœ¨å†…æ ¸ä¸­ï¼Œåªæœ‰åœ¨å†…æ ¸é‡å¯ï¼ˆæ“ä½œç³»ç»Ÿé‡å¯ï¼‰æˆ–è€…æ˜¾ç¤ºåœ°åˆ é™¤ä¸€ä¸ªæ¶ˆæ¯é˜Ÿåˆ—æ—¶ï¼Œè¯¥æ¶ˆæ¯é˜Ÿåˆ—æ‰è¢«çœŸæ­£åˆ é™¤</li><li>è¯»è¿›ç¨‹å¯ä»¥æ ¹æ®æ¶ˆæ¯ç±»å‹æœ‰é€‰æ‹©åœ°æ¥æ”¶æ¶ˆæ¯ï¼Œè€Œä¸åƒ FIFO é‚£æ ·åªèƒ½é»˜è®¤åœ°æ¥æ”¶</li></ul></li></ul><p>ä¸åŒè®¡ç®—æœºä¹‹é—´çš„<strong>è¿›ç¨‹é€šä¿¡</strong>ï¼Œéœ€è¦é€šè¿‡ç½‘ç»œï¼Œå¹¶éµå®ˆå…±åŒçš„åè®®ï¼Œä¾‹å¦‚ HTTP</p><ul><li>å¥—æ¥å­—ï¼šä¸å…¶å®ƒé€šä¿¡æœºåˆ¶ä¸åŒçš„æ˜¯ï¼Œå¯ç”¨äºä¸åŒæœºå™¨é—´çš„äº’ç›¸é€šä¿¡</li></ul></li><li><p>çº¿ç¨‹é€šä¿¡ç›¸å¯¹ç®€å•ï¼Œå› ä¸ºçº¿ç¨‹ä¹‹é—´å…±äº«è¿›ç¨‹å†…çš„å†…å­˜ï¼Œä¸€ä¸ªä¾‹å­æ˜¯å¤šä¸ªçº¿ç¨‹å¯ä»¥è®¿é—®åŒä¸€ä¸ªå…±äº«å˜é‡</p><p><strong>Java ä¸­çš„é€šä¿¡æœºåˆ¶</strong>ï¼švolatileã€ç­‰å¾…&#x2F;é€šçŸ¥æœºåˆ¶ã€join æ–¹å¼ã€InheritableThreadLocalã€MappedByteBuffer</p></li><li><p>çº¿ç¨‹æ›´è½»é‡ï¼Œçº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢æˆæœ¬ä¸€èˆ¬ä¸Šè¦æ¯”è¿›ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ä½</p></li></ul><hr><h2 id="çº¿ç¨‹"><a href="#çº¿ç¨‹" class="headerlink" title="çº¿ç¨‹"></a>çº¿ç¨‹</h2><h3 id="åˆ›å»ºçº¿ç¨‹"><a href="#åˆ›å»ºçº¿ç¨‹" class="headerlink" title="åˆ›å»ºçº¿ç¨‹"></a>åˆ›å»ºçº¿ç¨‹</h3><h4 id="Thread"><a href="#Thread" class="headerlink" title="Thread"></a>Thread</h4><p>Thread åˆ›å»ºçº¿ç¨‹æ–¹å¼ï¼šåˆ›å»ºçº¿ç¨‹ç±»ï¼ŒåŒ¿åå†…éƒ¨ç±»æ–¹å¼</p><ul><li><strong>start() æ–¹æ³•åº•å±‚å…¶å®æ˜¯ç»™ CPU æ³¨å†Œå½“å‰çº¿ç¨‹ï¼Œå¹¶ä¸”è§¦å‘ run() æ–¹æ³•æ‰§è¡Œ</strong></li><li>çº¿ç¨‹çš„å¯åŠ¨å¿…é¡»è°ƒç”¨ start() æ–¹æ³•ï¼Œå¦‚æœçº¿ç¨‹ç›´æ¥è°ƒç”¨ run() æ–¹æ³•ï¼Œç›¸å½“äºå˜æˆäº†æ™®é€šç±»çš„æ‰§è¡Œï¼Œæ­¤æ—¶ä¸»çº¿ç¨‹å°†åªæœ‰æ‰§è¡Œè¯¥çº¿ç¨‹</li><li>å»ºè®®çº¿ç¨‹å…ˆåˆ›å»ºå­çº¿ç¨‹ï¼Œä¸»çº¿ç¨‹çš„ä»»åŠ¡æ”¾åœ¨ä¹‹åï¼Œå¦åˆ™ä¸»çº¿ç¨‹ï¼ˆmainï¼‰æ°¸è¿œæ˜¯å…ˆæ‰§è¡Œå®Œ</li></ul><p>Thread æ„é€ å™¨ï¼š</p><ul><li><code>public Thread()</code></li><li><code>public Thread(String name)</code></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadDemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyThread</span>();</span><br><span class="line">        t.start();</span><br><span class="line">       <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span> ; i &lt; <span class="number">100</span> ; i++ )&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;mainçº¿ç¨‹&quot;</span> + i)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// mainçº¿ç¨‹è¾“å‡ºæ”¾åœ¨ä¸Šé¢ å°±å˜æˆæœ‰å…ˆåé¡ºåºäº†ï¼Œå› ä¸ºæ˜¯ main çº¿ç¨‹é©±åŠ¨çš„å­çº¿ç¨‹è¿è¡Œ</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyThread</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span> ; i &lt; <span class="number">100</span> ; i++ ) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;å­çº¿ç¨‹è¾“å‡ºï¼š&quot;</span>+i)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»§æ‰¿ Thread ç±»çš„ä¼˜ç¼ºç‚¹ï¼š</p><ul><li>ä¼˜ç‚¹ï¼šç¼–ç ç®€å•</li><li>ç¼ºç‚¹ï¼šçº¿ç¨‹ç±»å·²ç»ç»§æ‰¿äº† Thread ç±»æ— æ³•ç»§æ‰¿å…¶ä»–ç±»äº†ï¼ŒåŠŸèƒ½ä¸èƒ½é€šè¿‡ç»§æ‰¿æ‹“å±•ï¼ˆå•ç»§æ‰¿çš„å±€é™æ€§ï¼‰</li></ul><hr><h4 id="Runnable"><a href="#Runnable" class="headerlink" title="Runnable"></a>Runnable</h4><p>Runnable åˆ›å»ºçº¿ç¨‹æ–¹å¼ï¼šåˆ›å»ºçº¿ç¨‹ç±»ï¼ŒåŒ¿åå†…éƒ¨ç±»æ–¹å¼</p><p>Thread çš„æ„é€ å™¨ï¼š</p><ul><li><code>public Thread(Runnable target)</code></li><li><code>public Thread(Runnable target, String name)</code></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadDemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Runnable</span> <span class="variable">target</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyRunnable</span>();</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(target,<span class="string">&quot;1å·çº¿ç¨‹&quot;</span>);</span><br><span class="line">t1.start();</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(target);<span class="comment">//Thread-0</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyRunnable</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span> ; i &lt; <span class="number">10</span> ; i++ )&#123;</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">&quot;-&gt;&quot;</span> + i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>Thread ç±»æœ¬èº«ä¹Ÿæ˜¯å®ç°äº† Runnable æ¥å£</strong>ï¼ŒThread ç±»ä¸­æŒæœ‰ Runnable çš„å±æ€§ï¼Œæ‰§è¡Œçº¿ç¨‹ run æ–¹æ³•åº•å±‚æ˜¯è°ƒç”¨ Runnable#runï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Thread</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Runnable target;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (target != <span class="literal">null</span>) &#123;</span><br><span class="line">          <span class="comment">// åº•å±‚è°ƒç”¨çš„æ˜¯ Runnable çš„ run æ–¹æ³•</span></span><br><span class="line">            target.run();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Runnable æ–¹å¼çš„ä¼˜ç¼ºç‚¹ï¼š</p><ul><li><p>ç¼ºç‚¹ï¼šä»£ç å¤æ‚ä¸€ç‚¹ã€‚</p></li><li><p>ä¼˜ç‚¹ï¼š</p><ol><li><p>çº¿ç¨‹ä»»åŠ¡ç±»åªæ˜¯å®ç°äº† Runnable æ¥å£ï¼Œå¯ä»¥ç»§ç»­ç»§æ‰¿å…¶ä»–ç±»ï¼Œé¿å…äº†å•ç»§æ‰¿çš„å±€é™æ€§</p></li><li><p>åŒä¸€ä¸ªçº¿ç¨‹ä»»åŠ¡å¯¹è±¡å¯ä»¥è¢«åŒ…è£…æˆå¤šä¸ªçº¿ç¨‹å¯¹è±¡</p></li><li><p>é€‚åˆå¤šä¸ªå¤šä¸ªçº¿ç¨‹å»å…±äº«åŒä¸€ä¸ªèµ„æº</p></li><li><p>å®ç°è§£è€¦æ“ä½œï¼Œçº¿ç¨‹ä»»åŠ¡ä»£ç å¯ä»¥è¢«å¤šä¸ªçº¿ç¨‹å…±äº«ï¼Œçº¿ç¨‹ä»»åŠ¡ä»£ç å’Œçº¿ç¨‹ç‹¬ç«‹</p></li><li><p>çº¿ç¨‹æ± å¯ä»¥æ”¾å…¥å®ç° Runnable æˆ– Callable çº¿ç¨‹ä»»åŠ¡å¯¹è±¡</p></li></ol></li></ul><p>â€‹     </p><hr><h4 id="Callable"><a href="#Callable" class="headerlink" title="Callable"></a>Callable</h4><p>å®ç° Callable æ¥å£ï¼š</p><ol><li>å®šä¹‰ä¸€ä¸ªçº¿ç¨‹ä»»åŠ¡ç±»å®ç° Callable æ¥å£ï¼Œç”³æ˜çº¿ç¨‹æ‰§è¡Œçš„ç»“æœç±»å‹</li><li>é‡å†™çº¿ç¨‹ä»»åŠ¡ç±»çš„ call æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å¯ä»¥ç›´æ¥è¿”å›æ‰§è¡Œçš„ç»“æœ</li><li>åˆ›å»ºä¸€ä¸ª Callable çš„çº¿ç¨‹ä»»åŠ¡å¯¹è±¡</li><li>æŠŠ Callable çš„çº¿ç¨‹ä»»åŠ¡å¯¹è±¡<strong>åŒ…è£…æˆä¸€ä¸ªæœªæ¥ä»»åŠ¡å¯¹è±¡</strong></li><li>æŠŠæœªæ¥ä»»åŠ¡å¯¹è±¡åŒ…è£…æˆçº¿ç¨‹å¯¹è±¡</li><li>è°ƒç”¨çº¿ç¨‹çš„ start() æ–¹æ³•å¯åŠ¨çº¿ç¨‹</li></ol><p><code>public FutureTask(Callable&lt;V&gt; callable)</code>ï¼šæœªæ¥ä»»åŠ¡å¯¹è±¡ï¼Œåœ¨çº¿ç¨‹æ‰§è¡Œå®Œåå¾—åˆ°çº¿ç¨‹çš„æ‰§è¡Œç»“æœ</p><ul><li>FutureTask å°±æ˜¯ Runnable å¯¹è±¡ï¼Œå› ä¸º <strong>Thread ç±»åªèƒ½æ‰§è¡Œ Runnable å®ä¾‹çš„ä»»åŠ¡å¯¹è±¡</strong>ï¼Œæ‰€ä»¥æŠŠ Callable åŒ…è£…æˆæœªæ¥ä»»åŠ¡å¯¹è±¡</li><li>çº¿ç¨‹æ± éƒ¨åˆ†è¯¦è§£äº† FutureTask çš„æºç </li></ul><p><code>public V get()</code>ï¼šåŒæ­¥ç­‰å¾… task æ‰§è¡Œå®Œæ¯•çš„ç»“æœï¼Œå¦‚æœåœ¨çº¿ç¨‹ä¸­è·å–å¦ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œç»“æœï¼Œä¼šé˜»å¡ç­‰å¾…ï¼Œç”¨äºçº¿ç¨‹åŒæ­¥</p><ul><li>get() çº¿ç¨‹ä¼šé˜»å¡ç­‰å¾…ä»»åŠ¡æ‰§è¡Œå®Œæˆ</li><li>run() æ‰§è¡Œå®Œåä¼šæŠŠç»“æœè®¾ç½®åˆ° FutureTask  çš„ä¸€ä¸ªæˆå‘˜å˜é‡ï¼Œget() çº¿ç¨‹å¯ä»¥è·å–åˆ°è¯¥å˜é‡çš„å€¼</li></ul><p>ä¼˜ç¼ºç‚¹ï¼š</p><ul><li>ä¼˜ç‚¹ï¼šåŒ Runnableï¼Œå¹¶ä¸”èƒ½å¾—åˆ°çº¿ç¨‹æ‰§è¡Œçš„ç»“æœ</li><li>ç¼ºç‚¹ï¼šç¼–ç å¤æ‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadDemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Callable</span> <span class="variable">call</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyCallable</span>();</span><br><span class="line">        FutureTask&lt;String&gt; task = <span class="keyword">new</span> <span class="title class_">FutureTask</span>&lt;&gt;(call);</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(task);</span><br><span class="line">        t.start();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> task.get(); <span class="comment">// è·å–callæ–¹æ³•è¿”å›çš„ç»“æœï¼ˆæ­£å¸¸/å¼‚å¸¸ç»“æœï¼‰</span></span><br><span class="line">            System.out.println(s);</span><br><span class="line">        &#125;  <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyCallable</span> <span class="keyword">implements</span> <span class="title class_">Callable</span>&lt;String&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span><span class="comment">//é‡å†™çº¿ç¨‹ä»»åŠ¡ç±»æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> Thread.currentThread().getName() + <span class="string">&quot;-&gt;&quot;</span> + <span class="string">&quot;Hello World&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h3 id="çº¿ç¨‹æ–¹æ³•"><a href="#çº¿ç¨‹æ–¹æ³•" class="headerlink" title="çº¿ç¨‹æ–¹æ³•"></a>çº¿ç¨‹æ–¹æ³•</h3><h4 id="API"><a href="#API" class="headerlink" title="API"></a>API</h4><p>Thread ç±» APIï¼š</p><table><thead><tr><th>æ–¹æ³•</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>public void start()</td><td>å¯åŠ¨ä¸€ä¸ªæ–°çº¿ç¨‹ï¼ŒJavaè™šæ‹Ÿæœºè°ƒç”¨æ­¤çº¿ç¨‹çš„ run æ–¹æ³•</td></tr><tr><td>public void run()</td><td>çº¿ç¨‹å¯åŠ¨åè°ƒç”¨è¯¥æ–¹æ³•</td></tr><tr><td>public void setName(String name)</td><td>ç»™å½“å‰çº¿ç¨‹å–åå­—</td></tr><tr><td>public void getName()</td><td>è·å–å½“å‰çº¿ç¨‹çš„åå­—<br />çº¿ç¨‹å­˜åœ¨é»˜è®¤åç§°ï¼šå­çº¿ç¨‹æ˜¯ Thread-ç´¢å¼•ï¼Œä¸»çº¿ç¨‹æ˜¯ main</td></tr><tr><td>public static Thread currentThread()</td><td>è·å–å½“å‰çº¿ç¨‹å¯¹è±¡ï¼Œä»£ç åœ¨å“ªä¸ªçº¿ç¨‹ä¸­æ‰§è¡Œ</td></tr><tr><td>public static void sleep(long time)</td><td>è®©å½“å‰çº¿ç¨‹ä¼‘çœ å¤šå°‘æ¯«ç§’å†ç»§ç»­æ‰§è¡Œ<br /><strong>Thread.sleep(0)</strong> : è®©æ“ä½œç³»ç»Ÿç«‹åˆ»é‡æ–°è¿›è¡Œä¸€æ¬¡ CPU ç«äº‰</td></tr><tr><td>public static native void yield()</td><td>æç¤ºçº¿ç¨‹è°ƒåº¦å™¨è®©å‡ºå½“å‰çº¿ç¨‹å¯¹ CPU çš„ä½¿ç”¨</td></tr><tr><td>public final int getPriority()</td><td>è¿”å›æ­¤çº¿ç¨‹çš„ä¼˜å…ˆçº§</td></tr><tr><td>public final void setPriority(int priority)</td><td>æ›´æ”¹æ­¤çº¿ç¨‹çš„ä¼˜å…ˆçº§ï¼Œå¸¸ç”¨ 1 5 10</td></tr><tr><td>public void interrupt()</td><td>ä¸­æ–­è¿™ä¸ªçº¿ç¨‹ï¼Œå¼‚å¸¸å¤„ç†æœºåˆ¶</td></tr><tr><td>public static boolean interrupted()</td><td>åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦è¢«æ‰“æ–­ï¼Œæ¸…é™¤æ‰“æ–­æ ‡è®°</td></tr><tr><td>public boolean isInterrupted()</td><td>åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦è¢«æ‰“æ–­ï¼Œä¸æ¸…é™¤æ‰“æ–­æ ‡è®°</td></tr><tr><td>public final void join()</td><td>ç­‰å¾…è¿™ä¸ªçº¿ç¨‹ç»“æŸ</td></tr><tr><td>public final void join(long millis)</td><td>ç­‰å¾…è¿™ä¸ªçº¿ç¨‹æ­»äº¡ millis æ¯«ç§’ï¼Œ0 æ„å‘³ç€æ°¸è¿œç­‰å¾…</td></tr><tr><td>public final native boolean isAlive()</td><td>çº¿ç¨‹æ˜¯å¦å­˜æ´»ï¼ˆè¿˜æ²¡æœ‰è¿è¡Œå®Œæ¯•ï¼‰</td></tr><tr><td>public final void setDaemon(boolean on)</td><td>å°†æ­¤çº¿ç¨‹æ ‡è®°ä¸ºå®ˆæŠ¤çº¿ç¨‹æˆ–ç”¨æˆ·çº¿ç¨‹</td></tr></tbody></table><hr><h4 id="run-start"><a href="#run-start" class="headerlink" title="run start"></a>run start</h4><p>runï¼šç§°ä¸ºçº¿ç¨‹ä½“ï¼ŒåŒ…å«äº†è¦æ‰§è¡Œçš„è¿™ä¸ªçº¿ç¨‹çš„å†…å®¹ï¼Œæ–¹æ³•è¿è¡Œç»“æŸï¼Œæ­¤çº¿ç¨‹éšå³ç»ˆæ­¢ã€‚ç›´æ¥è°ƒç”¨ run æ˜¯åœ¨ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œäº† runï¼Œæ²¡æœ‰å¯åŠ¨æ–°çš„çº¿ç¨‹ï¼Œéœ€è¦é¡ºåºæ‰§è¡Œ</p><p>startï¼šä½¿ç”¨ start æ˜¯å¯åŠ¨æ–°çš„çº¿ç¨‹ï¼Œæ­¤çº¿ç¨‹å¤„äºå°±ç»ªï¼ˆå¯è¿è¡Œï¼‰çŠ¶æ€ï¼Œé€šè¿‡æ–°çš„çº¿ç¨‹é—´æ¥æ‰§è¡Œ run ä¸­çš„ä»£ç </p><p>è¯´æ˜ï¼š<strong>çº¿ç¨‹æ§åˆ¶èµ„æºç±»</strong></p><p>run() æ–¹æ³•ä¸­çš„å¼‚å¸¸ä¸èƒ½æŠ›å‡ºï¼Œåªèƒ½ try&#x2F;catch</p><ul><li>å› ä¸ºçˆ¶ç±»ä¸­æ²¡æœ‰æŠ›å‡ºä»»ä½•å¼‚å¸¸ï¼Œå­ç±»ä¸èƒ½æ¯”çˆ¶ç±»æŠ›å‡ºæ›´å¤šçš„å¼‚å¸¸</li><li><strong>å¼‚å¸¸ä¸èƒ½è·¨çº¿ç¨‹ä¼ æ’­å› main() ä¸­</strong>ï¼Œå› æ­¤å¿…é¡»åœ¨æœ¬åœ°è¿›è¡Œå¤„ç†</li></ul><hr><h4 id="sleep-yield"><a href="#sleep-yield" class="headerlink" title="sleep yield"></a>sleep yield</h4><p>sleepï¼š</p><ul><li>è°ƒç”¨ sleep ä¼šè®©å½“å‰çº¿ç¨‹ä» <code>Running</code> è¿›å…¥ <code>Timed Waiting</code> çŠ¶æ€ï¼ˆé˜»å¡ï¼‰</li><li>sleep() æ–¹æ³•çš„è¿‡ç¨‹ä¸­ï¼Œ<strong>çº¿ç¨‹ä¸ä¼šé‡Šæ”¾å¯¹è±¡é”</strong></li><li>å…¶å®ƒçº¿ç¨‹å¯ä»¥ä½¿ç”¨ interrupt æ–¹æ³•æ‰“æ–­æ­£åœ¨ç¡çœ çš„çº¿ç¨‹ï¼Œè¿™æ—¶ sleep æ–¹æ³•ä¼šæŠ›å‡º InterruptedException</li><li>ç¡çœ ç»“æŸåçš„çº¿ç¨‹æœªå¿…ä¼šç«‹åˆ»å¾—åˆ°æ‰§è¡Œï¼Œéœ€è¦æŠ¢å  CPU</li><li>å»ºè®®ç”¨ TimeUnit çš„ sleep ä»£æ›¿ Thread çš„ sleep æ¥è·å¾—æ›´å¥½çš„å¯è¯»æ€§</li></ul><p>yieldï¼š</p><ul><li>è°ƒç”¨ yield ä¼šè®©æç¤ºçº¿ç¨‹è°ƒåº¦å™¨è®©å‡ºå½“å‰çº¿ç¨‹å¯¹ CPU çš„ä½¿ç”¨</li><li>å…·ä½“çš„å®ç°ä¾èµ–äºæ“ä½œç³»ç»Ÿçš„ä»»åŠ¡è°ƒåº¦å™¨</li><li><strong>ä¼šæ”¾å¼ƒ CPU èµ„æºï¼Œé”èµ„æºä¸ä¼šé‡Šæ”¾</strong></li></ul><hr><h4 id="join"><a href="#join" class="headerlink" title="join"></a>join</h4><p>public final void join()ï¼šç­‰å¾…è¿™ä¸ªçº¿ç¨‹ç»“æŸ</p><p>åŸç†ï¼šè°ƒç”¨è€…è½®è¯¢æ£€æŸ¥çº¿ç¨‹ alive çŠ¶æ€ï¼Œt1.join() ç­‰ä»·äºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">join</span><span class="params">(<span class="type">long</span> millis)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="comment">// è°ƒç”¨è€…çº¿ç¨‹è¿›å…¥ thread çš„ waitSet ç­‰å¾…, ç›´åˆ°å½“å‰çº¿ç¨‹è¿è¡Œç»“æŸ</span></span><br><span class="line">    <span class="keyword">while</span> (isAlive()) &#123;</span><br><span class="line">        wait(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>join æ–¹æ³•æ˜¯è¢« synchronized ä¿®é¥°çš„ï¼Œæœ¬è´¨ä¸Šæ˜¯ä¸€ä¸ªå¯¹è±¡é”ï¼Œå…¶å†…éƒ¨çš„ wait æ–¹æ³•è°ƒç”¨ä¹Ÿæ˜¯é‡Šæ”¾é”çš„ï¼Œä½†æ˜¯<strong>é‡Šæ”¾çš„æ˜¯å½“å‰çš„çº¿ç¨‹å¯¹è±¡é”ï¼Œè€Œä¸æ˜¯å¤–é¢çš„é”</strong></p></li><li><p>å½“è°ƒç”¨æŸä¸ªçº¿ç¨‹ï¼ˆt1ï¼‰çš„ join æ–¹æ³•åï¼Œè¯¥çº¿ç¨‹ï¼ˆt1ï¼‰æŠ¢å åˆ° CPU èµ„æºï¼Œå°±ä¸å†é‡Šæ”¾ï¼Œç›´åˆ°çº¿ç¨‹æ‰§è¡Œå®Œæ¯•</p></li></ul><p>çº¿ç¨‹åŒæ­¥ï¼š</p><ul><li>join å®ç°çº¿ç¨‹åŒæ­¥ï¼Œå› ä¸ºä¼šé˜»å¡ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹çš„ç»“æŸï¼Œæ‰èƒ½ç»§ç»­å‘ä¸‹è¿è¡Œ<ul><li>éœ€è¦å¤–éƒ¨å…±äº«å˜é‡ï¼Œä¸ç¬¦åˆé¢å‘å¯¹è±¡å°è£…çš„æ€æƒ³</li><li>å¿…é¡»ç­‰å¾…çº¿ç¨‹ç»“æŸï¼Œä¸èƒ½é…åˆçº¿ç¨‹æ± ä½¿ç”¨</li></ul></li><li>Future å®ç°ï¼ˆåŒæ­¥ï¼‰ï¼šget() æ–¹æ³•é˜»å¡ç­‰å¾…æ‰§è¡Œç»“æœ<ul><li>main çº¿ç¨‹æ¥æ”¶ç»“æœ</li><li>get æ–¹æ³•æ˜¯è®©è°ƒç”¨çº¿ç¨‹åŒæ­¥ç­‰å¾…</li></ul></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="type">int</span> <span class="variable">r</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        test1();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">test1</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            r = <span class="number">10</span>;</span><br><span class="line">        &#125;);</span><br><span class="line">        t1.start();</span><br><span class="line">        t1.join();<span class="comment">//ä¸ç­‰å¾…çº¿ç¨‹æ‰§è¡Œç»“æŸï¼Œè¾“å‡ºçš„10</span></span><br><span class="line">        System.out.println(r);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h4 id="interrupt"><a href="#interrupt" class="headerlink" title="interrupt"></a>interrupt</h4><h5 id="æ‰“æ–­çº¿ç¨‹"><a href="#æ‰“æ–­çº¿ç¨‹" class="headerlink" title="æ‰“æ–­çº¿ç¨‹"></a>æ‰“æ–­çº¿ç¨‹</h5><p><code>public void interrupt()</code>ï¼šæ‰“æ–­è¿™ä¸ªçº¿ç¨‹ï¼Œå¼‚å¸¸å¤„ç†æœºåˆ¶</p><p><code>public static boolean interrupted()</code>ï¼šåˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦è¢«æ‰“æ–­ï¼Œæ‰“æ–­è¿”å› trueï¼Œ<strong>æ¸…é™¤æ‰“æ–­æ ‡è®°</strong>ï¼Œè¿ç»­è°ƒç”¨ä¸¤æ¬¡ä¸€å®šè¿”å› false</p><p><code>public boolean isInterrupted()</code>ï¼šåˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦è¢«æ‰“æ–­ï¼Œä¸æ¸…é™¤æ‰“æ–­æ ‡è®°</p><p>æ‰“æ–­çš„çº¿ç¨‹ä¼šå‘ç”Ÿä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œæ“ä½œç³»ç»Ÿä¼šä¿å­˜çº¿ç¨‹ä¿¡æ¯ï¼ŒæŠ¢å åˆ° CPU åä¼šä»ä¸­æ–­çš„åœ°æ–¹æ¥ç€è¿è¡Œï¼ˆæ‰“æ–­ä¸æ˜¯åœæ­¢ï¼‰</p><ul><li><p>sleepã€waitã€join æ–¹æ³•éƒ½ä¼šè®©çº¿ç¨‹è¿›å…¥é˜»å¡çŠ¶æ€ï¼Œæ‰“æ–­çº¿ç¨‹<strong>ä¼šæ¸…ç©ºæ‰“æ–­çŠ¶æ€</strong>ï¼ˆfalseï¼‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="string">&quot;t1&quot;</span>);</span><br><span class="line">    t1.start();</span><br><span class="line">    Thread.sleep(<span class="number">500</span>);</span><br><span class="line">    t1.interrupt();</span><br><span class="line">    System.out.println(<span class="string">&quot; æ‰“æ–­çŠ¶æ€: &#123;&#125;&quot;</span> + t1.isInterrupted());<span class="comment">// æ‰“æ–­çŠ¶æ€: &#123;&#125;false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>æ‰“æ–­æ­£å¸¸è¿è¡Œçš„çº¿ç¨‹ï¼šä¸ä¼šæ¸…ç©ºæ‰“æ–­çŠ¶æ€ï¼ˆtrueï¼‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123;</span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="type">Thread</span> <span class="variable">current</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">interrupted</span> <span class="operator">=</span> current.isInterrupted();</span><br><span class="line">            <span class="keyword">if</span>(interrupted) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot; æ‰“æ–­çŠ¶æ€: &#123;&#125;&quot;</span> + interrupted);<span class="comment">//æ‰“æ–­çŠ¶æ€: &#123;&#125;true</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="string">&quot;t2&quot;</span>);</span><br><span class="line">    t2.start();</span><br><span class="line">    Thread.sleep(<span class="number">500</span>);</span><br><span class="line">    t2.interrupt();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><hr><h5 id="æ‰“æ–­-park"><a href="#æ‰“æ–­-park" class="headerlink" title="æ‰“æ–­ park"></a>æ‰“æ–­ park</h5><p>park ä½œç”¨ç±»ä¼¼ sleepï¼Œæ‰“æ–­ park çº¿ç¨‹ï¼Œä¸ä¼šæ¸…ç©ºæ‰“æ–­çŠ¶æ€ï¼ˆtrueï¼‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;park...&quot;</span>);</span><br><span class="line">        LockSupport.park();</span><br><span class="line">        System.out.println(<span class="string">&quot;unpark...&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;æ‰“æ–­çŠ¶æ€ï¼š&quot;</span> + Thread.currentThread().isInterrupted());<span class="comment">//æ‰“æ–­çŠ¶æ€ï¼štrue</span></span><br><span class="line">    &#125;, <span class="string">&quot;t1&quot;</span>);</span><br><span class="line">    t1.start();</span><br><span class="line">    Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">    t1.interrupt();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœæ‰“æ–­æ ‡è®°å·²ç»æ˜¯ true, åˆ™ park ä¼šå¤±æ•ˆ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">LockSupport.park();</span><br><span class="line">System.out.println(<span class="string">&quot;unpark...&quot;</span>);</span><br><span class="line">LockSupport.park();<span class="comment">//å¤±æ•ˆï¼Œä¸ä¼šé˜»å¡</span></span><br><span class="line">System.out.println(<span class="string">&quot;unpark...&quot;</span>);<span class="comment">//å’Œä¸Šä¸€ä¸ªunparkåŒæ—¶æ‰§è¡Œ</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥ä¿®æ”¹è·å–æ‰“æ–­çŠ¶æ€æ–¹æ³•ï¼Œä½¿ç”¨ <code>Thread.interrupted()</code>ï¼Œæ¸…é™¤æ‰“æ–­æ ‡è®°</p><p>LockSupport ç±»åœ¨ åŒæ­¥ â†’ park-un è¯¦è§£</p><hr><h5 id="ç»ˆæ­¢æ¨¡å¼"><a href="#ç»ˆæ­¢æ¨¡å¼" class="headerlink" title="ç»ˆæ­¢æ¨¡å¼"></a>ç»ˆæ­¢æ¨¡å¼</h5><p>ç»ˆæ­¢æ¨¡å¼ä¹‹ä¸¤é˜¶æ®µç»ˆæ­¢æ¨¡å¼ï¼šTwo Phase Termination</p><p>ç›®æ ‡ï¼šåœ¨ä¸€ä¸ªçº¿ç¨‹ T1 ä¸­å¦‚ä½•ä¼˜é›…ç»ˆæ­¢çº¿ç¨‹ T2ï¼Ÿä¼˜é›…æŒ‡çš„æ˜¯ç»™ T2 ä¸€ä¸ªåç½®å¤„ç†å™¨</p><p>é”™è¯¯æ€æƒ³ï¼š</p><ul><li>ä½¿ç”¨çº¿ç¨‹å¯¹è±¡çš„ stop() æ–¹æ³•åœæ­¢çº¿ç¨‹ï¼šstop æ–¹æ³•ä¼šçœŸæ­£æ€æ­»çº¿ç¨‹ï¼Œå¦‚æœè¿™æ—¶çº¿ç¨‹é”ä½äº†å…±äº«èµ„æºï¼Œå½“å®ƒè¢«æ€æ­»åå°±å†ä¹Ÿæ²¡æœ‰æœºä¼šé‡Šæ”¾é”ï¼Œå…¶å®ƒçº¿ç¨‹å°†æ°¸è¿œæ— æ³•è·å–é”</li><li>ä½¿ç”¨ System.exit(int) æ–¹æ³•åœæ­¢çº¿ç¨‹ï¼šç›®çš„ä»…æ˜¯åœæ­¢ä¸€ä¸ªçº¿ç¨‹ï¼Œä½†è¿™ç§åšæ³•ä¼šè®©æ•´ä¸ªç¨‹åºéƒ½åœæ­¢</li></ul><p>ä¸¤é˜¶æ®µç»ˆæ­¢æ¨¡å¼å›¾ç¤ºï¼š</p><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/JUC-ä¸¤é˜¶æ®µç»ˆæ­¢æ¨¡å¼.png" style="zoom: 67%;" /><p>æ‰“æ–­çº¿ç¨‹å¯èƒ½åœ¨ä»»ä½•æ—¶é—´ï¼Œæ‰€ä»¥éœ€è¦è€ƒè™‘åœ¨ä»»ä½•æ—¶åˆ»è¢«æ‰“æ–­çš„å¤„ç†æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">TwoPhaseTermination</span> <span class="variable">tpt</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TwoPhaseTermination</span>();</span><br><span class="line">        tpt.start();</span><br><span class="line">        Thread.sleep(<span class="number">3500</span>);</span><br><span class="line">        tpt.stop();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TwoPhaseTermination</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Thread monitor;</span><br><span class="line">    <span class="comment">// å¯åŠ¨ç›‘æ§çº¿ç¨‹</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> &#123;</span><br><span class="line">        monitor = <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                    <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">                    <span class="keyword">if</span> (thread.isInterrupted()) &#123;</span><br><span class="line">                        System.out.println(<span class="string">&quot;åç½®å¤„ç†&quot;</span>);</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        Thread.sleep(<span class="number">1000</span>);<span class="comment">// ç¡çœ </span></span><br><span class="line">                        System.out.println(<span class="string">&quot;æ‰§è¡Œç›‘æ§è®°å½•&quot;</span>);<span class="comment">// åœ¨æ­¤è¢«æ‰“æ–­ä¸ä¼šå¼‚å¸¸</span></span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;<span class="comment">// åœ¨ç¡çœ æœŸé—´è¢«æ‰“æ–­ï¼Œè¿›å…¥å¼‚å¸¸å¤„ç†çš„é€»è¾‘</span></span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                        <span class="comment">// é‡æ–°è®¾ç½®æ‰“æ–­æ ‡è®°ï¼Œæ‰“æ–­ sleep ä¼šæ¸…é™¤æ‰“æ–­çŠ¶æ€</span></span><br><span class="line">                        thread.interrupt();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        monitor.start();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// åœæ­¢ç›‘æ§çº¿ç¨‹</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">stop</span><span class="params">()</span> &#123;</span><br><span class="line">        monitor.interrupt();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h4 id="daemon"><a href="#daemon" class="headerlink" title="daemon"></a>daemon</h4><p><code>public final void setDaemon(boolean on)</code>ï¼šå¦‚æœæ˜¯ true ï¼Œå°†æ­¤çº¿ç¨‹æ ‡è®°ä¸ºå®ˆæŠ¤çº¿ç¨‹ </p><p>çº¿ç¨‹<strong>å¯åŠ¨å‰</strong>è°ƒç”¨æ­¤æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;running&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// è®¾ç½®è¯¥çº¿ç¨‹ä¸ºå®ˆæŠ¤çº¿ç¨‹</span></span><br><span class="line">t.setDaemon(<span class="literal">true</span>);</span><br><span class="line">t.start();</span><br></pre></td></tr></table></figure><p>ç”¨æˆ·çº¿ç¨‹ï¼šå¹³å¸¸åˆ›å»ºçš„æ™®é€šçº¿ç¨‹</p><p>å®ˆæŠ¤çº¿ç¨‹ï¼šæœåŠ¡äºç”¨æˆ·çº¿ç¨‹ï¼Œåªè¦å…¶å®ƒéå®ˆæŠ¤çº¿ç¨‹è¿è¡Œç»“æŸäº†ï¼Œå³ä½¿å®ˆæŠ¤çº¿ç¨‹ä»£ç æ²¡æœ‰æ‰§è¡Œå®Œï¼Œä¹Ÿä¼šå¼ºåˆ¶ç»“æŸã€‚å®ˆæŠ¤è¿›ç¨‹æ˜¯<strong>è„±ç¦»äºç»ˆç«¯å¹¶ä¸”åœ¨åå°è¿è¡Œçš„è¿›ç¨‹</strong>ï¼Œè„±ç¦»ç»ˆç«¯æ˜¯ä¸ºäº†é¿å…åœ¨æ‰§è¡Œçš„è¿‡ç¨‹ä¸­çš„ä¿¡æ¯åœ¨ç»ˆç«¯ä¸Šæ˜¾ç¤º</p><p>è¯´æ˜ï¼šå½“è¿è¡Œçš„çº¿ç¨‹éƒ½æ˜¯å®ˆæŠ¤çº¿ç¨‹ï¼ŒJava è™šæ‹Ÿæœºå°†é€€å‡ºï¼Œå› ä¸ºæ™®é€šçº¿ç¨‹æ‰§è¡Œå®Œåï¼ŒJVM æ˜¯å®ˆæŠ¤çº¿ç¨‹ï¼Œä¸ä¼šç»§ç»­è¿è¡Œä¸‹å»</p><p>å¸¸è§çš„å®ˆæŠ¤çº¿ç¨‹ï¼š</p><ul><li>åƒåœ¾å›æ”¶å™¨çº¿ç¨‹å°±æ˜¯ä¸€ç§å®ˆæŠ¤çº¿ç¨‹</li><li>Tomcat ä¸­çš„ Acceptor å’Œ Poller çº¿ç¨‹éƒ½æ˜¯å®ˆæŠ¤çº¿ç¨‹ï¼Œæ‰€ä»¥ Tomcat æ¥æ”¶åˆ° shutdown å‘½ä»¤åï¼Œä¸ä¼šç­‰å¾…å®ƒä»¬å¤„ç†å®Œå½“å‰è¯·æ±‚</li></ul><hr><h4 id="ä¸æ¨è"><a href="#ä¸æ¨è" class="headerlink" title="ä¸æ¨è"></a>ä¸æ¨è</h4><p>ä¸æ¨èä½¿ç”¨çš„æ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•å·²è¿‡æ—¶ï¼Œå®¹æ˜“ç ´ååŒæ­¥ä»£ç å—ï¼Œé€ æˆçº¿ç¨‹æ­»é”ï¼š</p><ul><li><p><code>public final void stop()</code>ï¼šåœæ­¢çº¿ç¨‹è¿è¡Œ</p><p>åºŸå¼ƒåŸå› ï¼šæ–¹æ³•ç²—æš´ï¼Œé™¤éå¯èƒ½æ‰§è¡Œ finally ä»£ç å—ä»¥åŠé‡Šæ”¾ synchronized å¤–ï¼Œçº¿ç¨‹å°†ç›´æ¥è¢«ç»ˆæ­¢ï¼Œå¦‚æœçº¿ç¨‹æŒæœ‰ JUC çš„äº’æ–¥é”å¯èƒ½å¯¼è‡´é”æ¥ä¸åŠé‡Šæ”¾ï¼Œé€ æˆå…¶ä»–çº¿ç¨‹æ°¸è¿œç­‰å¾…çš„å±€é¢</p></li><li><p><code>public final void suspend()</code>ï¼š<strong>æŒ‚èµ·ï¼ˆæš‚åœï¼‰çº¿ç¨‹è¿è¡Œ</strong></p><p>åºŸå¼ƒåŸå› ï¼šå¦‚æœç›®æ ‡çº¿ç¨‹åœ¨æš‚åœæ—¶å¯¹ç³»ç»Ÿèµ„æºæŒæœ‰é”ï¼Œåˆ™åœ¨ç›®æ ‡çº¿ç¨‹æ¢å¤ä¹‹å‰æ²¡æœ‰çº¿ç¨‹å¯ä»¥è®¿é—®è¯¥èµ„æºï¼Œå¦‚æœ<strong>æ¢å¤ç›®æ ‡çº¿ç¨‹çš„çº¿ç¨‹</strong>åœ¨è°ƒç”¨ resume ä¹‹å‰ä¼šå°è¯•è®¿é—®æ­¤å…±äº«èµ„æºï¼Œåˆ™ä¼šå¯¼è‡´æ­»é”</p></li><li><p><code>public final void resume()</code>ï¼šæ¢å¤çº¿ç¨‹è¿è¡Œ</p></li></ul><hr><h3 id="çº¿ç¨‹åŸç†"><a href="#çº¿ç¨‹åŸç†" class="headerlink" title="çº¿ç¨‹åŸç†"></a>çº¿ç¨‹åŸç†</h3><h4 id="è¿è¡Œæœºåˆ¶"><a href="#è¿è¡Œæœºåˆ¶" class="headerlink" title="è¿è¡Œæœºåˆ¶"></a>è¿è¡Œæœºåˆ¶</h4><p>Java Virtual Machine Stacksï¼ˆJava è™šæ‹Ÿæœºæ ˆï¼‰ï¼šæ¯ä¸ªçº¿ç¨‹å¯åŠ¨åï¼Œè™šæ‹Ÿæœºå°±ä¼šä¸ºå…¶åˆ†é…ä¸€å—æ ˆå†…å­˜</p><ul><li>æ¯ä¸ªæ ˆç”±å¤šä¸ªæ ˆå¸§ï¼ˆFrameï¼‰ç»„æˆï¼Œå¯¹åº”ç€æ¯æ¬¡æ–¹æ³•è°ƒç”¨æ—¶æ‰€å ç”¨çš„å†…å­˜</li><li>æ¯ä¸ªçº¿ç¨‹åªèƒ½æœ‰ä¸€ä¸ªæ´»åŠ¨æ ˆå¸§ï¼Œå¯¹åº”ç€å½“å‰æ­£åœ¨æ‰§è¡Œçš„é‚£ä¸ªæ–¹æ³•</li></ul><p>çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼ˆThread Context Switchï¼‰ï¼šä¸€äº›åŸå› å¯¼è‡´ CPU ä¸å†æ‰§è¡Œå½“å‰çº¿ç¨‹ï¼Œè½¬è€Œæ‰§è¡Œå¦ä¸€ä¸ªçº¿ç¨‹</p><ul><li>çº¿ç¨‹çš„ CPU æ—¶é—´ç‰‡ç”¨å®Œ</li><li>åƒåœ¾å›æ”¶</li><li>æœ‰æ›´é«˜ä¼˜å…ˆçº§çš„çº¿ç¨‹éœ€è¦è¿è¡Œ</li><li>çº¿ç¨‹è‡ªå·±è°ƒç”¨äº† sleepã€yieldã€waitã€joinã€park ç­‰æ–¹æ³•</li></ul><p>ç¨‹åºè®¡æ•°å™¨ï¼ˆProgram Counter Registerï¼‰ï¼šè®°ä½ä¸‹ä¸€æ¡ JVM æŒ‡ä»¤çš„æ‰§è¡Œåœ°å€ï¼Œæ˜¯çº¿ç¨‹ç§æœ‰çš„</p><p>å½“ Context Switch å‘ç”Ÿæ—¶ï¼Œéœ€è¦ç”±æ“ä½œç³»ç»Ÿä¿å­˜å½“å‰çº¿ç¨‹çš„çŠ¶æ€ï¼ˆPCB ä¸­ï¼‰ï¼Œå¹¶æ¢å¤å¦ä¸€ä¸ªçº¿ç¨‹çš„çŠ¶æ€ï¼ŒåŒ…æ‹¬ç¨‹åºè®¡æ•°å™¨ã€è™šæ‹Ÿæœºæ ˆä¸­æ¯ä¸ªæ ˆå¸§çš„ä¿¡æ¯ï¼Œå¦‚å±€éƒ¨å˜é‡ã€æ“ä½œæ•°æ ˆã€è¿”å›åœ°å€ç­‰</p><p>JVM è§„èŒƒå¹¶æ²¡æœ‰é™å®šçº¿ç¨‹æ¨¡å‹ï¼Œä»¥ HotSopot ä¸ºä¾‹ï¼š</p><ul><li>Java çš„çº¿ç¨‹æ˜¯å†…æ ¸çº§çº¿ç¨‹ï¼ˆ1:1 çº¿ç¨‹æ¨¡å‹ï¼‰ï¼Œæ¯ä¸ª Java çº¿ç¨‹éƒ½æ˜ å°„åˆ°ä¸€ä¸ªæ“ä½œç³»ç»ŸåŸç”Ÿçº¿ç¨‹ï¼Œéœ€è¦æ¶ˆè€—ä¸€å®šçš„å†…æ ¸èµ„æºï¼ˆå †æ ˆï¼‰</li><li><strong>çº¿ç¨‹çš„è°ƒåº¦æ˜¯åœ¨å†…æ ¸æ€è¿è¡Œçš„ï¼Œè€Œçº¿ç¨‹ä¸­çš„ä»£ç æ˜¯åœ¨ç”¨æˆ·æ€è¿è¡Œ</strong>ï¼Œæ‰€ä»¥çº¿ç¨‹åˆ‡æ¢ï¼ˆçŠ¶æ€æ”¹å˜ï¼‰ä¼šå¯¼è‡´ç”¨æˆ·ä¸å†…æ ¸æ€è½¬æ¢è¿›è¡Œç³»ç»Ÿè°ƒç”¨ï¼Œè¿™æ˜¯éå¸¸æ¶ˆè€—æ€§èƒ½</li></ul><p>Java ä¸­ main æ–¹æ³•å¯åŠ¨çš„æ˜¯ä¸€ä¸ªè¿›ç¨‹ä¹Ÿæ˜¯ä¸€ä¸ªä¸»çº¿ç¨‹ï¼Œmain æ–¹æ³•é‡Œé¢çš„å…¶ä»–çº¿ç¨‹å‡ä¸ºå­çº¿ç¨‹ï¼Œmain çº¿ç¨‹æ˜¯è¿™äº›çº¿ç¨‹çš„çˆ¶çº¿ç¨‹</p><hr><h4 id="çº¿ç¨‹è°ƒåº¦"><a href="#çº¿ç¨‹è°ƒåº¦" class="headerlink" title="çº¿ç¨‹è°ƒåº¦"></a>çº¿ç¨‹è°ƒåº¦</h4><p>çº¿ç¨‹è°ƒåº¦æŒ‡ç³»ç»Ÿä¸ºçº¿ç¨‹åˆ†é…å¤„ç†å™¨ä½¿ç”¨æƒçš„è¿‡ç¨‹ï¼Œæ–¹å¼æœ‰ä¸¤ç§ï¼šååŒå¼çº¿ç¨‹è°ƒåº¦ã€æŠ¢å å¼çº¿ç¨‹è°ƒåº¦ï¼ˆJava é€‰æ‹©ï¼‰</p><p>ååŒå¼çº¿ç¨‹è°ƒåº¦ï¼šçº¿ç¨‹çš„æ‰§è¡Œæ—¶é—´ç”±çº¿ç¨‹æœ¬èº«æ§åˆ¶</p><ul><li>ä¼˜ç‚¹ï¼šçº¿ç¨‹åšå®Œä»»åŠ¡æ‰é€šçŸ¥ç³»ç»Ÿåˆ‡æ¢åˆ°å…¶ä»–çº¿ç¨‹ï¼Œç›¸å½“äºæ‰€æœ‰çº¿ç¨‹ä¸²è¡Œæ‰§è¡Œï¼Œä¸ä¼šå‡ºç°çº¿ç¨‹åŒæ­¥é—®é¢˜</li><li>ç¼ºç‚¹ï¼šçº¿ç¨‹æ‰§è¡Œæ—¶é—´ä¸å¯æ§ï¼Œå¦‚æœä»£ç ç¼–å†™å‡ºç°é—®é¢˜ï¼Œå¯èƒ½å¯¼è‡´ç¨‹åºä¸€ç›´é˜»å¡ï¼Œå¼•èµ·ç³»ç»Ÿçš„å¥”æºƒ</li></ul><p>æŠ¢å å¼çº¿ç¨‹è°ƒåº¦ï¼šçº¿ç¨‹çš„æ‰§è¡Œæ—¶é—´ç”±ç³»ç»Ÿåˆ†é…</p><ul><li>ä¼˜ç‚¹ï¼šçº¿ç¨‹æ‰§è¡Œæ—¶é—´å¯æ§ï¼Œä¸ä¼šå› ä¸ºä¸€ä¸ªçº¿ç¨‹çš„é—®é¢˜è€Œå¯¼è‡´æ•´ä½“ç³»ç»Ÿä¸å¯ç”¨</li><li>ç¼ºç‚¹ï¼šæ— æ³•ä¸»åŠ¨ä¸ºæŸä¸ªçº¿ç¨‹å¤šåˆ†é…æ—¶é—´</li></ul><p>Java æä¾›äº†çº¿ç¨‹ä¼˜å…ˆçº§çš„æœºåˆ¶ï¼Œä¼˜å…ˆçº§ä¼šæç¤ºï¼ˆhintï¼‰è°ƒåº¦å™¨ä¼˜å…ˆè°ƒåº¦è¯¥çº¿ç¨‹ï¼Œä½†è¿™ä»…ä»…æ˜¯ä¸€ä¸ªæç¤ºï¼Œè°ƒåº¦å™¨å¯ä»¥å¿½ç•¥å®ƒã€‚åœ¨çº¿ç¨‹çš„å°±ç»ªçŠ¶æ€æ—¶ï¼Œå¦‚æœ CPU æ¯”è¾ƒå¿™ï¼Œé‚£ä¹ˆä¼˜å…ˆçº§é«˜çš„çº¿ç¨‹ä¼šè·å¾—æ›´å¤šçš„æ—¶é—´ç‰‡ï¼Œä½† CPU é—²æ—¶ï¼Œä¼˜å…ˆçº§å‡ ä¹æ²¡ä½œç”¨</p><p>è¯´æ˜ï¼šå¹¶ä¸èƒ½é€šè¿‡ä¼˜å…ˆçº§æ¥åˆ¤æ–­çº¿ç¨‹æ‰§è¡Œçš„å…ˆåé¡ºåº</p><hr><h4 id="æœªæ¥ä¼˜åŒ–"><a href="#æœªæ¥ä¼˜åŒ–" class="headerlink" title="æœªæ¥ä¼˜åŒ–"></a>æœªæ¥ä¼˜åŒ–</h4><p>å†…æ ¸çº§çº¿ç¨‹è°ƒåº¦çš„æˆæœ¬è¾ƒå¤§ï¼Œæ‰€ä»¥å¼•å…¥äº†æ›´è½»é‡çº§çš„åç¨‹ã€‚ç”¨æˆ·çº¿ç¨‹çš„è°ƒåº¦ç”±ç”¨æˆ·è‡ªå·±å®ç°ï¼ˆå¤šå¯¹ä¸€çš„çº¿ç¨‹æ¨¡å‹ï¼Œå¤š<strong>ä¸ªç”¨æˆ·çº¿ç¨‹æ˜ å°„åˆ°ä¸€ä¸ªå†…æ ¸çº§çº¿ç¨‹</strong>ï¼‰ï¼Œè¢«è®¾è®¡ä¸ºååŒå¼è°ƒåº¦ï¼Œæ‰€ä»¥å«åç¨‹</p><ul><li>æœ‰æ ˆåç¨‹ï¼šåç¨‹ä¼šå®Œæ•´çš„åšè°ƒç”¨æ ˆçš„ä¿æŠ¤ã€æ¢å¤å·¥ä½œï¼Œæ‰€ä»¥å«æœ‰æ ˆåç¨‹</li><li>æ— æ ˆåç¨‹ï¼šæœ¬è´¨ä¸Šæ˜¯ä¸€ç§æœ‰é™çŠ¶æ€æœºï¼ŒçŠ¶æ€ä¿å­˜åœ¨é—­åŒ…é‡Œï¼Œæ¯”æœ‰æ ˆåç¨‹æ›´è½»é‡ï¼Œä½†æ˜¯åŠŸèƒ½æœ‰é™</li></ul><p>æœ‰æ ˆåç¨‹ä¸­æœ‰ä¸€ç§ç‰¹ä¾‹å«çº¤ç¨‹ï¼Œåœ¨æ–°å¹¶å‘æ¨¡å‹ä¸­ï¼Œä¸€æ®µçº¤ç¨‹çš„ä»£ç è¢«åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œæ‰§è¡Œè¿‡ç¨‹å’Œè°ƒåº¦å™¨ï¼š</p><ul><li>æ‰§è¡Œè¿‡ç¨‹ï¼šç”¨äºç»´æŠ¤æ‰§è¡Œç°åœºï¼Œä¿æŠ¤ã€æ¢å¤ä¸Šä¸‹æ–‡çŠ¶æ€</li><li>è°ƒåº¦å™¨ï¼šè´Ÿè´£ç¼–æ’æ‰€æœ‰è¦æ‰§è¡Œçš„ä»£ç é¡ºåº</li></ul><hr><h3 id="çº¿ç¨‹çŠ¶æ€"><a href="#çº¿ç¨‹çŠ¶æ€" class="headerlink" title="çº¿ç¨‹çŠ¶æ€"></a>çº¿ç¨‹çŠ¶æ€</h3><p>è¿›ç¨‹çš„çŠ¶æ€å‚è€ƒæ“ä½œç³»ç»Ÿï¼šåˆ›å»ºæ€ã€å°±ç»ªæ€ã€è¿è¡Œæ€ã€é˜»å¡æ€ã€ç»ˆæ­¢æ€</p><p>çº¿ç¨‹ç”±ç”Ÿåˆ°æ­»çš„å®Œæ•´è¿‡ç¨‹ï¼ˆç”Ÿå‘½å‘¨æœŸï¼‰ï¼šå½“çº¿ç¨‹è¢«åˆ›å»ºå¹¶å¯åŠ¨ä»¥åï¼Œæ—¢ä¸æ˜¯ä¸€å¯åŠ¨å°±è¿›å…¥äº†æ‰§è¡ŒçŠ¶æ€ï¼Œä¹Ÿä¸æ˜¯ä¸€ç›´å¤„äºæ‰§è¡ŒçŠ¶æ€ï¼Œåœ¨ API ä¸­ <code>java.lang.Thread.State</code> è¿™ä¸ªæšä¸¾ä¸­ç»™å‡ºäº†å…­ç§çº¿ç¨‹çŠ¶æ€ï¼š</p><table><thead><tr><th>çº¿ç¨‹çŠ¶æ€</th><th>å¯¼è‡´çŠ¶æ€å‘ç”Ÿæ¡ä»¶</th></tr></thead><tbody><tr><td>NEWï¼ˆæ–°å»ºï¼‰</td><td>çº¿ç¨‹åˆšè¢«åˆ›å»ºï¼Œä½†æ˜¯å¹¶æœªå¯åŠ¨ï¼Œè¿˜æ²¡è°ƒç”¨ start æ–¹æ³•ï¼Œåªæœ‰çº¿ç¨‹å¯¹è±¡ï¼Œæ²¡æœ‰çº¿ç¨‹ç‰¹å¾</td></tr><tr><td>Runnableï¼ˆå¯è¿è¡Œï¼‰</td><td>çº¿ç¨‹å¯ä»¥åœ¨ Java è™šæ‹Ÿæœºä¸­è¿è¡Œçš„çŠ¶æ€ï¼Œå¯èƒ½æ­£åœ¨è¿è¡Œè‡ªå·±ä»£ç ï¼Œä¹Ÿå¯èƒ½æ²¡æœ‰ï¼Œè¿™å–å†³äºæ“ä½œç³»ç»Ÿå¤„ç†å™¨ï¼Œè°ƒç”¨äº† t.start() æ–¹æ³•ï¼šå°±ç»ªï¼ˆç»å…¸å«æ³•ï¼‰</td></tr><tr><td>Blockedï¼ˆé˜»å¡ï¼‰</td><td>å½“ä¸€ä¸ªçº¿ç¨‹è¯•å›¾è·å–ä¸€ä¸ªå¯¹è±¡é”ï¼Œè€Œè¯¥å¯¹è±¡é”è¢«å…¶ä»–çš„çº¿ç¨‹æŒæœ‰ï¼Œåˆ™è¯¥çº¿ç¨‹è¿›å…¥ Blocked çŠ¶æ€ï¼›å½“è¯¥çº¿ç¨‹æŒæœ‰é”æ—¶ï¼Œè¯¥çº¿ç¨‹å°†å˜æˆ Runnable çŠ¶æ€</td></tr><tr><td>Waitingï¼ˆæ— é™ç­‰å¾…ï¼‰</td><td>ä¸€ä¸ªçº¿ç¨‹åœ¨ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œä¸€ä¸ªï¼ˆå”¤é†’ï¼‰åŠ¨ä½œæ—¶ï¼Œè¯¥çº¿ç¨‹è¿›å…¥ Waiting çŠ¶æ€ï¼Œè¿›å…¥è¿™ä¸ªçŠ¶æ€åä¸èƒ½è‡ªåŠ¨å”¤é†’ï¼Œå¿…é¡»ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨ notify æˆ–è€… notifyAll æ–¹æ³•æ‰èƒ½å”¤é†’</td></tr><tr><td>Timed Waiting ï¼ˆé™æœŸç­‰å¾…ï¼‰</td><td>æœ‰å‡ ä¸ªæ–¹æ³•æœ‰è¶…æ—¶å‚æ•°ï¼Œè°ƒç”¨å°†è¿›å…¥ Timed Waiting çŠ¶æ€ï¼Œè¿™ä¸€çŠ¶æ€å°†ä¸€ç›´ä¿æŒåˆ°è¶…æ—¶æœŸæ»¡æˆ–è€…æ¥æ”¶åˆ°å”¤é†’é€šçŸ¥ã€‚å¸¦æœ‰è¶…æ—¶å‚æ•°çš„å¸¸ç”¨æ–¹æ³•æœ‰ Thread.sleep ã€Object.wait</td></tr><tr><td>Teminatedï¼ˆç»“æŸï¼‰</td><td>run æ–¹æ³•æ­£å¸¸é€€å‡ºè€Œæ­»äº¡ï¼Œæˆ–è€…å› ä¸ºæ²¡æœ‰æ•è·çš„å¼‚å¸¸ç»ˆæ­¢äº† run æ–¹æ³•è€Œæ­»äº¡</td></tr></tbody></table><p><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/JUC-%E7%BA%BF%E7%A8%8B6%E7%A7%8D%E7%8A%B6%E6%80%81.png"></p><ul><li><p>NEW â†’ RUNNABLEï¼šå½“è°ƒç”¨ t.start() æ–¹æ³•æ—¶ï¼Œç”± NEW â†’ RUNNABLE</p></li><li><p>RUNNABLE &lt;â€“&gt; WAITINGï¼š</p><ul><li><p>è°ƒç”¨ obj.wait() æ–¹æ³•æ—¶</p><p>è°ƒç”¨ obj.notify()ã€obj.notifyAll()ã€t.interrupt()ï¼š</p><ul><li>ç«äº‰é”æˆåŠŸï¼Œt çº¿ç¨‹ä» WAITING â†’ RUNNABLE</li><li>ç«äº‰é”å¤±è´¥ï¼Œt çº¿ç¨‹ä» WAITING â†’ BLOCKED</li></ul></li><li><p>å½“å‰çº¿ç¨‹è°ƒç”¨ t.join() æ–¹æ³•ï¼Œæ³¨æ„æ˜¯å½“å‰çº¿ç¨‹åœ¨ t çº¿ç¨‹å¯¹è±¡çš„ç›‘è§†å™¨ä¸Šç­‰å¾…</p></li><li><p>å½“å‰çº¿ç¨‹è°ƒç”¨ LockSupport.park() æ–¹æ³•</p></li></ul></li><li><p>RUNNABLE &lt;â€“&gt; TIMED_WAITINGï¼šè°ƒç”¨ obj.wait(long n) æ–¹æ³•ã€å½“å‰çº¿ç¨‹è°ƒç”¨ t.join(long n) æ–¹æ³•ã€å½“å‰çº¿ç¨‹è°ƒç”¨ Thread.sleep(long n)</p></li><li><p>RUNNABLE &lt;â€“&gt; BLOCKEDï¼št çº¿ç¨‹ç”¨ synchronized(obj) è·å–äº†å¯¹è±¡é”æ—¶ç«äº‰å¤±è´¥</p></li></ul><hr><h3 id="æŸ¥çœ‹çº¿ç¨‹"><a href="#æŸ¥çœ‹çº¿ç¨‹" class="headerlink" title="æŸ¥çœ‹çº¿ç¨‹"></a>æŸ¥çœ‹çº¿ç¨‹</h3><p>Windowsï¼š</p><ul><li>ä»»åŠ¡ç®¡ç†å™¨å¯ä»¥æŸ¥çœ‹è¿›ç¨‹å’Œçº¿ç¨‹æ•°ï¼Œä¹Ÿå¯ä»¥ç”¨æ¥æ€æ­»è¿›ç¨‹</li><li>tasklist æŸ¥çœ‹è¿›ç¨‹</li><li>taskkill æ€æ­»è¿›ç¨‹</li></ul><p>Linuxï¼š</p><ul><li>ps -ef æŸ¥çœ‹æ‰€æœ‰è¿›ç¨‹</li><li>ps -fT -p <PID> æŸ¥çœ‹æŸä¸ªè¿›ç¨‹ï¼ˆPIDï¼‰çš„æ‰€æœ‰çº¿ç¨‹</li><li>kill æ€æ­»è¿›ç¨‹</li><li>top æŒ‰å¤§å†™ H åˆ‡æ¢æ˜¯å¦æ˜¾ç¤ºçº¿ç¨‹</li><li>top -H -p <PID> æŸ¥çœ‹æŸä¸ªè¿›ç¨‹ï¼ˆPIDï¼‰çš„æ‰€æœ‰çº¿ç¨‹</li></ul><p>Javaï¼š</p><ul><li>jps å‘½ä»¤æŸ¥çœ‹æ‰€æœ‰ Java è¿›ç¨‹</li><li>jstack <PID> æŸ¥çœ‹æŸä¸ª Java è¿›ç¨‹ï¼ˆPIDï¼‰çš„æ‰€æœ‰çº¿ç¨‹çŠ¶æ€</li><li>jconsole æ¥æŸ¥çœ‹æŸä¸ª Java è¿›ç¨‹ä¸­çº¿ç¨‹çš„è¿è¡Œæƒ…å†µï¼ˆå›¾å½¢ç•Œé¢ï¼‰</li></ul><hr><h2 id="åŒæ­¥"><a href="#åŒæ­¥" class="headerlink" title="åŒæ­¥"></a>åŒæ­¥</h2><h3 id="ä¸´ç•ŒåŒº"><a href="#ä¸´ç•ŒåŒº" class="headerlink" title="ä¸´ç•ŒåŒº"></a>ä¸´ç•ŒåŒº</h3><p>ä¸´ç•Œèµ„æºï¼šä¸€æ¬¡ä»…å…è®¸ä¸€ä¸ªè¿›ç¨‹ä½¿ç”¨çš„èµ„æºæˆä¸ºä¸´ç•Œèµ„æº</p><p>ä¸´ç•ŒåŒºï¼šè®¿é—®ä¸´ç•Œèµ„æºçš„ä»£ç å—</p><p>ç«æ€æ¡ä»¶ï¼šå¤šä¸ªçº¿ç¨‹åœ¨ä¸´ç•ŒåŒºå†…æ‰§è¡Œï¼Œç”±äºä»£ç çš„æ‰§è¡Œåºåˆ—ä¸åŒè€Œå¯¼è‡´ç»“æœæ— æ³•é¢„æµ‹ï¼Œç§°ä¹‹ä¸ºå‘ç”Ÿäº†ç«æ€æ¡ä»¶</p><p>ä¸€ä¸ªç¨‹åºè¿è¡Œå¤šä¸ªçº¿ç¨‹æ˜¯æ²¡æœ‰é—®é¢˜ï¼Œå¤šä¸ªçº¿ç¨‹è¯»å…±äº«èµ„æºä¹Ÿæ²¡æœ‰é—®é¢˜ï¼Œåœ¨å¤šä¸ªçº¿ç¨‹å¯¹å…±äº«èµ„æºè¯»å†™æ“ä½œæ—¶å‘ç”ŸæŒ‡ä»¤äº¤é”™ï¼Œå°±ä¼šå‡ºç°é—®é¢˜</p><p>ä¸ºäº†é¿å…ä¸´ç•ŒåŒºçš„ç«æ€æ¡ä»¶å‘ç”Ÿï¼ˆè§£å†³çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼‰ï¼š</p><ul><li>é˜»å¡å¼çš„è§£å†³æ–¹æ¡ˆï¼šsynchronizedï¼Œlock</li><li>éé˜»å¡å¼çš„è§£å†³æ–¹æ¡ˆï¼šåŸå­å˜é‡</li></ul><p>ç®¡ç¨‹ï¼ˆmonitorï¼‰ï¼šç”±å±€éƒ¨äºè‡ªå·±çš„è‹¥å¹²å…¬å…±å˜é‡å’Œæ‰€æœ‰è®¿é—®è¿™äº›å…¬å…±å˜é‡çš„è¿‡ç¨‹æ‰€ç»„æˆçš„è½¯ä»¶æ¨¡å—ï¼Œä¿è¯åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªè¿›ç¨‹åœ¨ç®¡ç¨‹å†…æ´»åŠ¨ï¼Œå³ç®¡ç¨‹å†…å®šä¹‰çš„æ“ä½œåœ¨åŒä¸€æ—¶åˆ»åªè¢«ä¸€ä¸ªè¿›ç¨‹è°ƒç”¨ï¼ˆç”±ç¼–è¯‘å™¨å®ç°ï¼‰</p><p><strong>synchronizedï¼šå¯¹è±¡é”ï¼Œä¿è¯äº†ä¸´ç•ŒåŒºå†…ä»£ç çš„åŸå­æ€§</strong>ï¼Œé‡‡ç”¨äº’æ–¥çš„æ–¹å¼è®©åŒä¸€æ—¶åˆ»è‡³å¤šåªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½æŒæœ‰å¯¹è±¡é”ï¼Œå…¶å®ƒçº¿ç¨‹è·å–è¿™ä¸ªå¯¹è±¡é”æ—¶ä¼šé˜»å¡ï¼Œä¿è¯æ‹¥æœ‰é”çš„çº¿ç¨‹å¯ä»¥å®‰å…¨çš„æ‰§è¡Œä¸´ç•ŒåŒºå†…çš„ä»£ç ï¼Œä¸ç”¨æ‹…å¿ƒçº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢</p><p>äº’æ–¥å’ŒåŒæ­¥éƒ½å¯ä»¥é‡‡ç”¨ synchronized å…³é”®å­—æ¥å®Œæˆï¼ŒåŒºåˆ«ï¼š</p><ul><li>äº’æ–¥æ˜¯ä¿è¯ä¸´ç•ŒåŒºçš„ç«æ€æ¡ä»¶å‘ç”Ÿï¼ŒåŒä¸€æ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œä¸´ç•ŒåŒºä»£ç </li><li>åŒæ­¥æ˜¯ç”±äºçº¿ç¨‹æ‰§è¡Œçš„å…ˆåã€é¡ºåºä¸åŒã€éœ€è¦ä¸€ä¸ªçº¿ç¨‹ç­‰å¾…å…¶å®ƒçº¿ç¨‹è¿è¡Œåˆ°æŸä¸ªç‚¹</li></ul><p>æ€§èƒ½ï¼š</p><ul><li>çº¿ç¨‹å®‰å…¨ï¼Œæ€§èƒ½å·®</li><li>çº¿ç¨‹ä¸å®‰å…¨æ€§èƒ½å¥½ï¼Œå‡å¦‚å¼€å‘ä¸­ä¸ä¼šå­˜åœ¨å¤šçº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œå»ºè®®ä½¿ç”¨çº¿ç¨‹ä¸å®‰å…¨çš„è®¾è®¡ç±»</li></ul><hr><h3 id="syn-ed"><a href="#syn-ed" class="headerlink" title="syn-ed"></a>syn-ed</h3><h4 id="ä½¿ç”¨é”"><a href="#ä½¿ç”¨é”" class="headerlink" title="ä½¿ç”¨é”"></a>ä½¿ç”¨é”</h4><h5 id="åŒæ­¥å—"><a href="#åŒæ­¥å—" class="headerlink" title="åŒæ­¥å—"></a>åŒæ­¥å—</h5><p>é”å¯¹è±¡ï¼šç†è®ºä¸Šå¯ä»¥æ˜¯<strong>ä»»æ„çš„å”¯ä¸€å¯¹è±¡</strong></p><p>synchronized æ˜¯å¯é‡å…¥ã€ä¸å…¬å¹³çš„é‡é‡çº§é”</p><p>åŸåˆ™ä¸Šï¼š</p><ul><li>é”å¯¹è±¡å»ºè®®ä½¿ç”¨å…±äº«èµ„æº</li><li>åœ¨å®ä¾‹æ–¹æ³•ä¸­ä½¿ç”¨ this ä½œä¸ºé”å¯¹è±¡ï¼Œé”ä½çš„ this æ­£å¥½æ˜¯å…±äº«èµ„æº</li><li>åœ¨é™æ€æ–¹æ³•ä¸­ä½¿ç”¨ç±»å .class å­—èŠ‚ç ä½œä¸ºé”å¯¹è±¡ï¼Œå› ä¸ºé™æ€æˆå‘˜å±äºç±»ï¼Œè¢«æ‰€æœ‰å®ä¾‹å¯¹è±¡å…±äº«ï¼Œæ‰€ä»¥éœ€è¦é”ä½ç±»</li></ul><p>åŒæ­¥ä»£ç å—æ ¼å¼ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">synchronized</span>(é”å¯¹è±¡)&#123;</span><br><span class="line"><span class="comment">// è®¿é—®å…±äº«èµ„æºçš„æ ¸å¿ƒä»£ç </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®ä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">demo</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="type">int</span> <span class="variable">counter</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="comment">//staticä¿®é¥°ï¼Œåˆ™å…ƒç´ æ˜¯å±äºç±»æœ¬èº«çš„ï¼Œä¸å±äºå¯¹è±¡  ï¼Œä¸ç±»ä¸€èµ·åŠ è½½ä¸€æ¬¡ï¼Œåªæœ‰ä¸€ä¸ª</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">room</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5000</span>; i++) &#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (room) &#123;</span><br><span class="line">                    counter++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;t1&quot;</span>);</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">t2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5000</span>; i++) &#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (room) &#123;</span><br><span class="line">                    counter--;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;t2&quot;</span>);</span><br><span class="line">        t1.start();</span><br><span class="line">        t2.start();</span><br><span class="line">        t1.join();</span><br><span class="line">        t2.join();</span><br><span class="line">        System.out.println(counter);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h5 id="åŒæ­¥æ–¹æ³•"><a href="#åŒæ­¥æ–¹æ³•" class="headerlink" title="åŒæ­¥æ–¹æ³•"></a>åŒæ­¥æ–¹æ³•</h5><p>æŠŠå‡ºç°çº¿ç¨‹å®‰å…¨é—®é¢˜çš„æ ¸å¿ƒæ–¹æ³•é”èµ·æ¥ï¼Œæ¯æ¬¡åªèƒ½ä¸€ä¸ªçº¿ç¨‹è¿›å…¥è®¿é—®</p><p>synchronized ä¿®é¥°çš„æ–¹æ³•çš„ä¸å…·å¤‡ç»§æ‰¿æ€§ï¼Œæ‰€ä»¥å­ç±»æ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ï¼Œå¦‚æœå­ç±»çš„æ–¹æ³•ä¹Ÿè¢« synchronized ä¿®é¥°ï¼Œä¸¤ä¸ªé”å¯¹è±¡å…¶å®æ˜¯ä¸€æŠŠé”ï¼Œè€Œä¸”æ˜¯<strong>å­ç±»å¯¹è±¡ä½œä¸ºé”</strong></p><p>ç”¨æ³•ï¼šç›´æ¥ç»™æ–¹æ³•åŠ ä¸Šä¸€ä¸ªä¿®é¥°ç¬¦ synchronized</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//åŒæ­¥æ–¹æ³•</span></span><br><span class="line">ä¿®é¥°ç¬¦ <span class="keyword">synchronized</span> è¿”å›å€¼ç±»å‹ æ–¹æ³•å(æ–¹æ³•å‚æ•°) &#123; </span><br><span class="line">æ–¹æ³•ä½“ï¼›</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//åŒæ­¥é™æ€æ–¹æ³•</span></span><br><span class="line">ä¿®é¥°ç¬¦ <span class="keyword">static</span> <span class="keyword">synchronized</span> è¿”å›å€¼ç±»å‹ æ–¹æ³•å(æ–¹æ³•å‚æ•°) &#123; </span><br><span class="line">æ–¹æ³•ä½“ï¼›</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŒæ­¥æ–¹æ³•åº•å±‚ä¹Ÿæ˜¯æœ‰é”å¯¹è±¡çš„ï¼š</p><ul><li><p>å¦‚æœæ–¹æ³•æ˜¯å®ä¾‹æ–¹æ³•ï¼šåŒæ­¥æ–¹æ³•é»˜è®¤ç”¨ this ä½œä¸ºçš„é”å¯¹è±¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;&#125; <span class="comment">//ç­‰ä»·äº</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">synchronized</span>(<span class="built_in">this</span>) &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>å¦‚æœæ–¹æ³•æ˜¯é™æ€æ–¹æ³•ï¼šåŒæ­¥æ–¹æ³•é»˜è®¤ç”¨ç±»å .class ä½œä¸ºçš„é”å¯¹è±¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Test</span>&#123;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//ç­‰ä»·äº</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Test</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span>(Test.class) &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><hr><h5 id="çº¿ç¨‹å…«é”"><a href="#çº¿ç¨‹å…«é”" class="headerlink" title="çº¿ç¨‹å…«é”"></a>çº¿ç¨‹å…«é”</h5><p>çº¿ç¨‹å…«é”å°±æ˜¯è€ƒå¯Ÿ synchronized é”ä½çš„æ˜¯å“ªä¸ªå¯¹è±¡ï¼Œç›´æ¥ç™¾åº¦æœç´¢ç›¸å…³çš„å®ä¾‹</p><p>è¯´æ˜ï¼šä¸»è¦å…³æ³¨é”ä½çš„å¯¹è±¡æ˜¯ä¸æ˜¯åŒä¸€ä¸ª</p><ul><li>é”ä½ç±»å¯¹è±¡ï¼Œæ‰€æœ‰ç±»çš„å®ä¾‹çš„æ–¹æ³•éƒ½æ˜¯å®‰å…¨çš„ï¼Œç±»çš„æ‰€æœ‰å®ä¾‹éƒ½ç›¸å½“äºåŒä¸€æŠŠé”</li><li>é”ä½ this å¯¹è±¡ï¼Œåªæœ‰åœ¨å½“å‰å®ä¾‹å¯¹è±¡çš„çº¿ç¨‹å†…æ˜¯å®‰å…¨çš„ï¼Œå¦‚æœæœ‰å¤šä¸ªå®ä¾‹å°±ä¸å®‰å…¨</li></ul><p>çº¿ç¨‹ä¸å®‰å…¨ï¼šå› ä¸ºé”ä½çš„ä¸æ˜¯åŒä¸€ä¸ªå¯¹è±¡ï¼Œçº¿ç¨‹ 1 è°ƒç”¨ a æ–¹æ³•é”ä½çš„ç±»å¯¹è±¡ï¼Œçº¿ç¨‹ 2 è°ƒç”¨ b æ–¹æ³•é”ä½çš„ n2 å¯¹è±¡ï¼Œä¸æ˜¯åŒä¸€ä¸ªå¯¹è±¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Number</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">a</span><span class="params">()</span>&#123;</span><br><span class="line">Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">b</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;2&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">Number</span> <span class="variable">n1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Number</span>();</span><br><span class="line">    <span class="type">Number</span> <span class="variable">n2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Number</span>();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123; n1.a(); &#125;).start();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123; n2.b(); &#125;).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>çº¿ç¨‹å®‰å…¨ï¼šå› ä¸º n1 è°ƒç”¨ a() æ–¹æ³•ï¼Œé”ä½çš„æ˜¯ç±»å¯¹è±¡ï¼Œn2 è°ƒç”¨ b() æ–¹æ³•ï¼Œé”ä½çš„ä¹Ÿæ˜¯ç±»å¯¹è±¡ï¼Œæ‰€ä»¥çº¿ç¨‹å®‰å…¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Number</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">a</span><span class="params">()</span>&#123;</span><br><span class="line">Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">b</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;2&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">Number</span> <span class="variable">n1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Number</span>();</span><br><span class="line">    <span class="type">Number</span> <span class="variable">n2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Number</span>();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123; n1.a(); &#125;).start();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123; n2.b(); &#125;).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h4 id="é”åŸç†"><a href="#é”åŸç†" class="headerlink" title="é”åŸç†"></a>é”åŸç†</h4><h5 id="Monitor"><a href="#Monitor" class="headerlink" title="Monitor"></a>Monitor</h5><p>Monitor è¢«ç¿»è¯‘ä¸ºç›‘è§†å™¨æˆ–ç®¡ç¨‹</p><p>æ¯ä¸ª Java å¯¹è±¡éƒ½å¯ä»¥å…³è”ä¸€ä¸ª Monitor å¯¹è±¡ï¼ŒMonitor ä¹Ÿæ˜¯ classï¼Œå…¶<strong>å®ä¾‹å­˜å‚¨åœ¨å †ä¸­</strong>ï¼Œå¦‚æœä½¿ç”¨ synchronized ç»™å¯¹è±¡ä¸Šé”ï¼ˆé‡é‡çº§ï¼‰ä¹‹åï¼Œè¯¥å¯¹è±¡å¤´çš„ Mark Word ä¸­å°±è¢«è®¾ç½®æŒ‡å‘ Monitor å¯¹è±¡çš„æŒ‡é’ˆï¼Œè¿™å°±æ˜¯é‡é‡çº§é”</p><ul><li><p>Mark Word ç»“æ„ï¼šæœ€åä¸¤ä½æ˜¯<strong>é”æ ‡å¿—ä½</strong></p><p><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/JUC-Monitor-MarkWord%E7%BB%93%E6%9E%8432%E4%BD%8D.png"></p></li><li><p>64 ä½è™šæ‹Ÿæœº Mark Wordï¼š</p><p><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/JUC-Monitor-MarkWord%E7%BB%93%E6%9E%8464%E4%BD%8D.png"></p></li></ul><p>å·¥ä½œæµç¨‹ï¼š</p><ul><li>å¼€å§‹æ—¶ Monitor ä¸­ Owner ä¸º null</li><li>å½“ Thread-2 æ‰§è¡Œ synchronized(obj) å°±ä¼šå°† Monitor çš„æ‰€æœ‰è€… Owner ç½®ä¸º Thread-2ï¼ŒMonitor ä¸­åªèƒ½æœ‰ä¸€ä¸ª Ownerï¼Œ<strong>obj å¯¹è±¡çš„ Mark Word æŒ‡å‘ Monitor</strong>ï¼ŒæŠŠ<strong>å¯¹è±¡åŸæœ‰çš„ MarkWord å­˜å…¥çº¿ç¨‹æ ˆä¸­çš„é”è®°å½•</strong>ä¸­ï¼ˆè½»é‡çº§é”éƒ¨åˆ†è¯¦è§£ï¼‰<img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/JUC-Monitorå·¥ä½œåŸç†1.png" style="zoom:67%;" /></li><li>åœ¨ Thread-2 ä¸Šé”çš„è¿‡ç¨‹ï¼ŒThread-3ã€Thread-4ã€Thread-5 ä¹Ÿæ‰§è¡Œ synchronized(obj)ï¼Œå°±ä¼šè¿›å…¥ EntryList BLOCKEDï¼ˆåŒå‘é“¾è¡¨ï¼‰</li><li>Thread-2 æ‰§è¡Œå®ŒåŒæ­¥ä»£ç å—çš„å†…å®¹ï¼Œæ ¹æ® obj å¯¹è±¡å¤´ä¸­ Monitor åœ°å€å¯»æ‰¾ï¼Œè®¾ç½® Owner ä¸ºç©ºï¼ŒæŠŠçº¿ç¨‹æ ˆçš„é”è®°å½•ä¸­çš„å¯¹è±¡å¤´çš„å€¼è®¾ç½®å› MarkWord</li><li>å”¤é†’ EntryList ä¸­ç­‰å¾…çš„çº¿ç¨‹æ¥ç«äº‰é”ï¼Œç«äº‰æ˜¯<strong>éå…¬å¹³çš„</strong>ï¼Œå¦‚æœè¿™æ—¶æœ‰æ–°çš„çº¿ç¨‹æƒ³è¦è·å–é”ï¼Œå¯èƒ½ç›´æ¥å°±æŠ¢å åˆ°äº†ï¼Œé˜»å¡é˜Ÿåˆ—çš„çº¿ç¨‹å°±ä¼šç»§ç»­é˜»å¡</li><li>WaitSet ä¸­çš„ Thread-0ï¼Œæ˜¯ä»¥å‰è·å¾—è¿‡é”ï¼Œä½†æ¡ä»¶ä¸æ»¡è¶³è¿›å…¥ WAITING çŠ¶æ€çš„çº¿ç¨‹ï¼ˆwait-notify æœºåˆ¶ï¼‰</li></ul><p><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/JUC-Monitor%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%862.png"></p><p>æ³¨æ„ï¼š</p><ul><li>synchronized å¿…é¡»æ˜¯è¿›å…¥åŒä¸€ä¸ªå¯¹è±¡çš„ Monitor æ‰æœ‰ä¸Šè¿°çš„æ•ˆæœ</li><li>ä¸åŠ  synchronized çš„å¯¹è±¡ä¸ä¼šå…³è”ç›‘è§†å™¨ï¼Œä¸éµä»ä»¥ä¸Šè§„åˆ™</li></ul><hr><h5 id="å­—èŠ‚ç "><a href="#å­—èŠ‚ç " class="headerlink" title="å­—èŠ‚ç "></a>å­—èŠ‚ç </h5><p>ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">Object</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">    <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;ok&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: <span class="keyword">new</span>#<span class="number">2</span><span class="comment">// new Object</span></span><br><span class="line"><span class="number">3</span>: dup</span><br><span class="line"><span class="number">4</span>: invokespecial #<span class="number">1</span> <span class="comment">// invokespecial &lt;init&gt;:()Vï¼Œéè™šæ–¹æ³•</span></span><br><span class="line"><span class="number">7</span>: astore_1 <span class="comment">// lockå¼•ç”¨ -&gt; lock</span></span><br><span class="line"><span class="number">8</span>: aload_1<span class="comment">// lock ï¼ˆsynchronizedå¼€å§‹ï¼‰</span></span><br><span class="line"><span class="number">9</span>: dup<span class="comment">// ä¸€ä»½ç”¨æ¥åˆå§‹åŒ–ï¼Œä¸€ä»½ç”¨æ¥å¼•ç”¨</span></span><br><span class="line"><span class="number">10</span>: astore_2 <span class="comment">// lockå¼•ç”¨ -&gt; slot 2</span></span><br><span class="line"><span class="number">11</span>: monitorenter <span class="comment">// ã€å°† lockå¯¹è±¡ MarkWord ç½®ä¸º Monitor æŒ‡é’ˆã€‘</span></span><br><span class="line"><span class="number">12</span>: getstatic #<span class="number">3</span><span class="comment">// System.out</span></span><br><span class="line"><span class="number">15</span>: ldc #<span class="number">4</span><span class="comment">// &quot;ok&quot;</span></span><br><span class="line"><span class="number">17</span>: invokevirtual #<span class="number">5</span> <span class="comment">// invokevirtual println:(Ljava/lang/String;)V</span></span><br><span class="line"><span class="number">20</span>: aload_2 <span class="comment">// slot 2(lockå¼•ç”¨)</span></span><br><span class="line"><span class="number">21</span>: monitorexit <span class="comment">// ã€å°† lockå¯¹è±¡ MarkWord é‡ç½®, å”¤é†’ EntryListã€‘</span></span><br><span class="line"><span class="number">22</span>: goto <span class="number">30</span></span><br><span class="line"><span class="number">25</span>: astore_3 <span class="comment">// any -&gt; slot 3</span></span><br><span class="line"><span class="number">26</span>: aload_2 <span class="comment">// slot 2(lockå¼•ç”¨)</span></span><br><span class="line"><span class="number">27</span>: monitorexit <span class="comment">// ã€å°† lockå¯¹è±¡ MarkWord é‡ç½®, å”¤é†’ EntryListã€‘</span></span><br><span class="line"><span class="number">28</span>: aload_3</span><br><span class="line"><span class="number">29</span>: athrow</span><br><span class="line"><span class="number">30</span>: <span class="keyword">return</span></span><br><span class="line">Exception table:</span><br><span class="line">    from to target type</span><br><span class="line">      <span class="number">12</span> <span class="number">22</span> <span class="number">25</span> any</span><br><span class="line">      <span class="number">25</span> <span class="number">28</span> <span class="number">25</span> any</span><br><span class="line">LineNumberTable: ...</span><br><span class="line">LocalVariableTable:</span><br><span class="line">    Start Length Slot Name Signature</span><br><span class="line">    <span class="number">0</span> <span class="number">31</span> <span class="number">0</span> args [Ljava/lang/String;</span><br><span class="line">    <span class="number">8</span> <span class="number">23</span> <span class="number">1</span> lock Ljava/lang/Object;</span><br></pre></td></tr></table></figure><p>è¯´æ˜ï¼š</p><ul><li>é€šè¿‡å¼‚å¸¸ <strong>try-catch æœºåˆ¶</strong>ï¼Œç¡®ä¿ä¸€å®šä¼šè¢«è§£é”</li><li>æ–¹æ³•çº§åˆ«çš„ synchronized ä¸ä¼šåœ¨å­—èŠ‚ç æŒ‡ä»¤ä¸­æœ‰æ‰€ä½“ç°</li></ul><hr><h4 id="é”å‡çº§"><a href="#é”å‡çº§" class="headerlink" title="é”å‡çº§"></a>é”å‡çº§</h4><h5 id="å‡çº§è¿‡ç¨‹"><a href="#å‡çº§è¿‡ç¨‹" class="headerlink" title="å‡çº§è¿‡ç¨‹"></a>å‡çº§è¿‡ç¨‹</h5><p><strong>synchronized æ˜¯å¯é‡å…¥ã€ä¸å…¬å¹³çš„é‡é‡çº§é”</strong>ï¼Œæ‰€ä»¥å¯ä»¥å¯¹å…¶è¿›è¡Œä¼˜åŒ–</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">æ— é” -&gt; åå‘é” -&gt; è½»é‡çº§é” -&gt; é‡é‡çº§é”<span class="comment">// éšç€ç«äº‰çš„å¢åŠ ï¼Œåªèƒ½é”å‡çº§ï¼Œä¸èƒ½é™çº§</span></span><br></pre></td></tr></table></figure><p><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/JUC-%E9%94%81%E5%8D%87%E7%BA%A7%E8%BF%87%E7%A8%8B.png"></p><hr><h5 id="åå‘é”"><a href="#åå‘é”" class="headerlink" title="åå‘é”"></a>åå‘é”</h5><p>åå‘é”çš„æ€æƒ³æ˜¯åå‘äºè®©ç¬¬ä¸€ä¸ªè·å–é”å¯¹è±¡çš„çº¿ç¨‹ï¼Œè¿™ä¸ªçº¿ç¨‹ä¹‹åé‡æ–°è·å–è¯¥é”ä¸å†éœ€è¦åŒæ­¥æ“ä½œï¼š</p><ul><li><p>å½“é”å¯¹è±¡ç¬¬ä¸€æ¬¡è¢«çº¿ç¨‹è·å¾—çš„æ—¶å€™è¿›å…¥åå‘çŠ¶æ€ï¼Œæ ‡è®°ä¸º 101ï¼ŒåŒæ—¶<strong>ä½¿ç”¨ CAS æ“ä½œå°†çº¿ç¨‹ ID è®°å½•åˆ° Mark Word</strong>ã€‚å¦‚æœ CAS æ“ä½œæˆåŠŸï¼Œè¿™ä¸ªçº¿ç¨‹ä»¥åè¿›å…¥è¿™ä¸ªé”ç›¸å…³çš„åŒæ­¥å—ï¼ŒæŸ¥çœ‹è¿™ä¸ªçº¿ç¨‹ ID æ˜¯è‡ªå·±çš„å°±è¡¨ç¤ºæ²¡æœ‰ç«äº‰ï¼Œå°±ä¸éœ€è¦å†è¿›è¡Œä»»ä½•åŒæ­¥æ“ä½œ</p></li><li><p>å½“æœ‰å¦å¤–ä¸€ä¸ªçº¿ç¨‹å»å°è¯•è·å–è¿™ä¸ªé”å¯¹è±¡æ—¶ï¼Œåå‘çŠ¶æ€å°±å®£å‘Šç»“æŸï¼Œæ­¤æ—¶æ’¤é”€åå‘ï¼ˆRevoke Biasï¼‰åæ¢å¤åˆ°æœªé”å®šæˆ–è½»é‡çº§é”çŠ¶æ€</p></li></ul><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/JUC-Monitor-MarkWordç»“æ„64ä½.png" style="zoom: 67%;" /><p>ä¸€ä¸ªå¯¹è±¡åˆ›å»ºæ—¶ï¼š</p><ul><li><p>å¦‚æœå¼€å¯äº†åå‘é”ï¼ˆé»˜è®¤å¼€å¯ï¼‰ï¼Œé‚£ä¹ˆå¯¹è±¡åˆ›å»ºåï¼ŒMarkWord å€¼ä¸º 0x05 å³æœ€å 3 ä½ä¸º 101ï¼Œthreadã€epochã€age éƒ½ä¸º 0</p></li><li><p>åå‘é”æ˜¯é»˜è®¤æ˜¯å»¶è¿Ÿçš„ï¼Œä¸ä¼šåœ¨ç¨‹åºå¯åŠ¨æ—¶ç«‹å³ç”Ÿæ•ˆï¼Œå¦‚æœæƒ³é¿å…å»¶è¿Ÿï¼Œå¯ä»¥åŠ  VM å‚æ•° <code>-XX:BiasedLockingStartupDelay=0</code> æ¥ç¦ç”¨å»¶è¿Ÿã€‚JDK 8 å»¶è¿Ÿ 4s å¼€å¯åå‘é”åŸå› ï¼šåœ¨åˆšå¼€å§‹æ‰§è¡Œä»£ç æ—¶ï¼Œä¼šæœ‰å¥½å¤šçº¿ç¨‹æ¥æŠ¢é”ï¼Œå¦‚æœå¼€åå‘é”æ•ˆç‡åè€Œé™ä½</p></li><li><p>å½“ä¸€ä¸ªå¯¹è±¡å·²ç»è®¡ç®—è¿‡ hashCodeï¼Œå°±å†ä¹Ÿæ— æ³•è¿›å…¥åå‘çŠ¶æ€äº†</p></li><li><p>æ·»åŠ  VM å‚æ•° <code>-XX:-UseBiasedLocking</code> ç¦ç”¨åå‘é”</p></li></ul><p>æ’¤é”€åå‘é”çš„çŠ¶æ€ï¼š</p><ul><li>è°ƒç”¨å¯¹è±¡çš„ hashCodeï¼šåå‘é”çš„å¯¹è±¡ MarkWord ä¸­å­˜å‚¨çš„æ˜¯çº¿ç¨‹ idï¼Œè°ƒç”¨ hashCode å¯¼è‡´åå‘é”è¢«æ’¤é”€</li><li>å½“æœ‰å…¶å®ƒçº¿ç¨‹ä½¿ç”¨åå‘é”å¯¹è±¡æ—¶ï¼Œä¼šå°†åå‘é”å‡çº§ä¸ºè½»é‡çº§é”</li><li>è°ƒç”¨ wait&#x2F;notifyï¼Œéœ€è¦ç”³è¯· Monitorï¼Œè¿›å…¥ WaitSet</li></ul><p><strong>æ‰¹é‡æ’¤é”€</strong>ï¼šå¦‚æœå¯¹è±¡è¢«å¤šä¸ªçº¿ç¨‹è®¿é—®ï¼Œä½†æ²¡æœ‰ç«äº‰ï¼Œè¿™æ—¶åå‘äº†çº¿ç¨‹ T1 çš„å¯¹è±¡ä»æœ‰æœºä¼šé‡æ–°åå‘ T2ï¼Œé‡åå‘ä¼šé‡ç½®å¯¹è±¡çš„ Thread ID</p><ul><li><p>æ‰¹é‡é‡åå‘ï¼šå½“æ’¤é”€åå‘é”é˜ˆå€¼è¶…è¿‡ 20 æ¬¡åï¼ŒJVM ä¼šè§‰å¾—æ˜¯ä¸æ˜¯åå‘é”™äº†ï¼Œäºæ˜¯åœ¨ç»™è¿™äº›å¯¹è±¡åŠ é”æ—¶é‡æ–°åå‘è‡³åŠ é”çº¿ç¨‹</p></li><li><p>æ‰¹é‡æ’¤é”€ï¼šå½“æ’¤é”€åå‘é”é˜ˆå€¼è¶…è¿‡ 40 æ¬¡åï¼ŒJVM ä¼šè§‰å¾—è‡ªå·±ç¡®å®åå‘é”™äº†ï¼Œæ ¹æœ¬å°±ä¸è¯¥åå‘ï¼Œäºæ˜¯æ•´ä¸ªç±»çš„æ‰€æœ‰å¯¹è±¡éƒ½ä¼šå˜ä¸ºä¸å¯åå‘çš„ï¼Œæ–°å»ºçš„å¯¹è±¡ä¹Ÿæ˜¯ä¸å¯åå‘çš„</p></li></ul><hr><h5 id="è½»é‡çº§é”"><a href="#è½»é‡çº§é”" class="headerlink" title="è½»é‡çº§é”"></a>è½»é‡çº§é”</h5><p>ä¸€ä¸ªå¯¹è±¡æœ‰å¤šä¸ªçº¿ç¨‹è¦åŠ é”ï¼Œä½†åŠ é”çš„æ—¶é—´æ˜¯é”™å¼€çš„ï¼ˆæ²¡æœ‰ç«äº‰ï¼‰ï¼Œå¯ä»¥ä½¿ç”¨è½»é‡çº§é”æ¥ä¼˜åŒ–ï¼Œè½»é‡çº§é”å¯¹ä½¿ç”¨è€…æ˜¯é€æ˜çš„ï¼ˆä¸å¯è§ï¼‰</p><p>å¯é‡å…¥é”ï¼šçº¿ç¨‹å¯ä»¥è¿›å…¥ä»»ä½•ä¸€ä¸ªå®ƒå·²ç»æ‹¥æœ‰çš„é”æ‰€åŒæ­¥ç€çš„ä»£ç å—ï¼Œå¯é‡å…¥é”æœ€å¤§çš„ä½œç”¨æ˜¯<strong>é¿å…æ­»é”</strong></p><p>è½»é‡çº§é”åœ¨æ²¡æœ‰ç«äº‰æ—¶ï¼ˆé”é‡å…¥æ—¶ï¼‰ï¼Œæ¯æ¬¡é‡å…¥ä»ç„¶éœ€è¦æ‰§è¡Œ CAS æ“ä½œï¼ŒJava 6 æ‰å¼•å…¥çš„åå‘é”æ¥ä¼˜åŒ–</p><p>é”é‡å…¥å®ä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">method1</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">synchronized</span>( obj ) &#123;</span><br><span class="line">        <span class="comment">// åŒæ­¥å— A</span></span><br><span class="line">        method2();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">method2</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">synchronized</span>( obj ) &#123;</span><br><span class="line">    <span class="comment">// åŒæ­¥å— B</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>åˆ›å»ºé”è®°å½•ï¼ˆLock Recordï¼‰å¯¹è±¡ï¼Œæ¯ä¸ªçº¿ç¨‹çš„<strong>æ ˆå¸§</strong>éƒ½ä¼šåŒ…å«ä¸€ä¸ªé”è®°å½•çš„ç»“æ„ï¼Œå­˜å‚¨é”å®šå¯¹è±¡çš„ Mark Word</p><p><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/JUC-%E8%BD%BB%E9%87%8F%E7%BA%A7%E9%94%81%E5%8E%9F%E7%90%861.png"></p></li><li><p>è®©é”è®°å½•ä¸­ Object reference æŒ‡å‘é”ä½çš„å¯¹è±¡ï¼Œå¹¶å°è¯•ç”¨ CAS æ›¿æ¢ Object çš„ Mark Wordï¼Œå°† Mark Word çš„å€¼å­˜å…¥é”è®°å½•</p></li><li><p>å¦‚æœ CAS æ›¿æ¢æˆåŠŸï¼Œå¯¹è±¡å¤´ä¸­å­˜å‚¨äº†é”è®°å½•åœ°å€å’ŒçŠ¶æ€ 00ï¼ˆè½»é‡çº§é”ï¼‰ ï¼Œè¡¨ç¤ºç”±è¯¥çº¿ç¨‹ç»™å¯¹è±¡åŠ é”<br><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/JUC-%E8%BD%BB%E9%87%8F%E7%BA%A7%E9%94%81%E5%8E%9F%E7%90%862.png"></p></li><li><p>å¦‚æœ CAS å¤±è´¥ï¼Œæœ‰ä¸¤ç§æƒ…å†µï¼š</p><ul><li>å¦‚æœæ˜¯å…¶å®ƒçº¿ç¨‹å·²ç»æŒæœ‰äº†è¯¥ Object çš„è½»é‡çº§é”ï¼Œè¿™æ—¶è¡¨æ˜æœ‰ç«äº‰ï¼Œè¿›å…¥é”è†¨èƒ€è¿‡ç¨‹</li><li>å¦‚æœæ˜¯çº¿ç¨‹è‡ªå·±æ‰§è¡Œäº† synchronized é”é‡å…¥ï¼Œå°±æ·»åŠ ä¸€æ¡ Lock Record ä½œä¸ºé‡å…¥çš„è®¡æ•°</li></ul><p><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/JUC-%E8%BD%BB%E9%87%8F%E7%BA%A7%E9%94%81%E5%8E%9F%E7%90%863.png"></p></li><li><p>å½“é€€å‡º synchronized ä»£ç å—ï¼ˆè§£é”æ—¶ï¼‰</p><ul><li>å¦‚æœæœ‰å–å€¼ä¸º null çš„é”è®°å½•ï¼Œè¡¨ç¤ºæœ‰é‡å…¥ï¼Œè¿™æ—¶é‡ç½®é”è®°å½•ï¼Œè¡¨ç¤ºé‡å…¥è®¡æ•°å‡ 1</li><li>å¦‚æœé”è®°å½•çš„å€¼ä¸ä¸º nullï¼Œè¿™æ—¶ä½¿ç”¨ CAS <strong>å°† Mark Word çš„å€¼æ¢å¤ç»™å¯¹è±¡å¤´</strong><ul><li>æˆåŠŸï¼Œåˆ™è§£é”æˆåŠŸ</li><li>å¤±è´¥ï¼Œè¯´æ˜è½»é‡çº§é”è¿›è¡Œäº†é”è†¨èƒ€æˆ–å·²ç»å‡çº§ä¸ºé‡é‡çº§é”ï¼Œè¿›å…¥é‡é‡çº§é”è§£é”æµç¨‹</li></ul></li></ul></li></ul><hr><h5 id="é”è†¨èƒ€"><a href="#é”è†¨èƒ€" class="headerlink" title="é”è†¨èƒ€"></a>é”è†¨èƒ€</h5><p>åœ¨å°è¯•åŠ è½»é‡çº§é”çš„è¿‡ç¨‹ä¸­ï¼ŒCAS æ“ä½œæ— æ³•æˆåŠŸï¼Œå¯èƒ½æ˜¯å…¶å®ƒçº¿ç¨‹ä¸ºæ­¤å¯¹è±¡åŠ ä¸Šäº†è½»é‡çº§é”ï¼ˆæœ‰ç«äº‰ï¼‰ï¼Œè¿™æ—¶éœ€è¦è¿›è¡Œé”è†¨èƒ€ï¼Œå°†è½»é‡çº§é”å˜ä¸º<strong>é‡é‡çº§é”</strong></p><ul><li><p>å½“ Thread-1 è¿›è¡Œè½»é‡çº§åŠ é”æ—¶ï¼ŒThread-0 å·²ç»å¯¹è¯¥å¯¹è±¡åŠ äº†è½»é‡çº§é”</p><p><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/JUC-%E9%87%8D%E9%87%8F%E7%BA%A7%E9%94%81%E5%8E%9F%E7%90%861.png"></p></li><li><p>Thread-1 åŠ è½»é‡çº§é”å¤±è´¥ï¼Œè¿›å…¥é”è†¨èƒ€æµç¨‹ï¼šä¸º Object å¯¹è±¡ç”³è¯· Monitor é”ï¼Œ<strong>é€šè¿‡ Object å¯¹è±¡å¤´è·å–åˆ°æŒé”çº¿ç¨‹</strong>ï¼Œå°† Monitor çš„ Owner ç½®ä¸º Thread-0ï¼Œå°† Object çš„å¯¹è±¡å¤´æŒ‡å‘é‡é‡çº§é”åœ°å€ï¼Œç„¶åè‡ªå·±è¿›å…¥ Monitor çš„ EntryList BLOCKED</p><p><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/JUC-%E9%87%8D%E9%87%8F%E7%BA%A7%E9%94%81%E5%8E%9F%E7%90%862.png"></p></li><li><p>å½“ Thread-0 é€€å‡ºåŒæ­¥å—è§£é”æ—¶ï¼Œä½¿ç”¨ CAS å°† Mark Word çš„å€¼æ¢å¤ç»™å¯¹è±¡å¤´å¤±è´¥ï¼Œè¿™æ—¶è¿›å…¥é‡é‡çº§è§£é”æµç¨‹ï¼Œå³æŒ‰ç…§ Monitor åœ°å€æ‰¾åˆ° Monitor å¯¹è±¡ï¼Œè®¾ç½® Owner ä¸º nullï¼Œå”¤é†’ EntryList ä¸­ BLOCKED çº¿ç¨‹</p></li></ul><hr><h4 id="é”ä¼˜åŒ–"><a href="#é”ä¼˜åŒ–" class="headerlink" title="é”ä¼˜åŒ–"></a>é”ä¼˜åŒ–</h4><h5 id="è‡ªæ—‹é”"><a href="#è‡ªæ—‹é”" class="headerlink" title="è‡ªæ—‹é”"></a>è‡ªæ—‹é”</h5><p>é‡é‡çº§é”ç«äº‰æ—¶ï¼Œå°è¯•è·å–é”çš„çº¿ç¨‹ä¸ä¼šç«‹å³é˜»å¡ï¼Œå¯ä»¥ä½¿ç”¨<strong>è‡ªæ—‹</strong>ï¼ˆé»˜è®¤ 10 æ¬¡ï¼‰æ¥è¿›è¡Œä¼˜åŒ–ï¼Œé‡‡ç”¨å¾ªç¯çš„æ–¹å¼å»å°è¯•è·å–é”</p><p>æ³¨æ„ï¼š</p><ul><li>è‡ªæ—‹å ç”¨ CPU æ—¶é—´ï¼Œå•æ ¸ CPU è‡ªæ—‹å°±æ˜¯æµªè´¹æ—¶é—´ï¼Œå› ä¸ºåŒä¸€æ—¶åˆ»åªèƒ½è¿è¡Œä¸€ä¸ªçº¿ç¨‹ï¼Œå¤šæ ¸ CPU è‡ªæ—‹æ‰èƒ½å‘æŒ¥ä¼˜åŠ¿</li><li>è‡ªæ—‹å¤±è´¥çš„çº¿ç¨‹ä¼šè¿›å…¥é˜»å¡çŠ¶æ€</li></ul><p>ä¼˜ç‚¹ï¼šä¸ä¼šè¿›å…¥é˜»å¡çŠ¶æ€ï¼Œ<strong>å‡å°‘çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢çš„æ¶ˆè€—</strong></p><p>ç¼ºç‚¹ï¼šå½“è‡ªæ—‹çš„çº¿ç¨‹è¶Šæ¥è¶Šå¤šæ—¶ï¼Œä¼šä¸æ–­çš„æ¶ˆè€— CPU èµ„æº</p><p>è‡ªæ—‹é”æƒ…å†µï¼š</p><ul><li><p>è‡ªæ—‹æˆåŠŸçš„æƒ…å†µï¼š<br><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/JUC-è‡ªæ—‹æˆåŠŸ.png" style="zoom: 80%;" /></p></li><li><p>è‡ªæ—‹å¤±è´¥çš„æƒ…å†µï¼š</p><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/JUC-è‡ªæ—‹å¤±è´¥.png" style="zoom:80%;" /></li></ul><p>è‡ªæ—‹é”è¯´æ˜ï¼š</p><ul><li>åœ¨ Java 6 ä¹‹åè‡ªæ—‹é”æ˜¯è‡ªé€‚åº”çš„ï¼Œæ¯”å¦‚å¯¹è±¡åˆšåˆšçš„ä¸€æ¬¡è‡ªæ—‹æ“ä½œæˆåŠŸè¿‡ï¼Œé‚£ä¹ˆè®¤ä¸ºè¿™æ¬¡è‡ªæ—‹æˆåŠŸçš„å¯èƒ½æ€§ä¼šé«˜ï¼Œå°±å¤šè‡ªæ—‹å‡ æ¬¡ï¼›åä¹‹ï¼Œå°±å°‘è‡ªæ—‹ç”šè‡³ä¸è‡ªæ—‹ï¼Œæ¯”è¾ƒæ™ºèƒ½</li><li>Java 7 ä¹‹åä¸èƒ½æ§åˆ¶æ˜¯å¦å¼€å¯è‡ªæ—‹åŠŸèƒ½ï¼Œç”± JVM æ§åˆ¶</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//æ‰‹å†™è‡ªæ—‹é”</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SpinLock</span> &#123;</span><br><span class="line">    <span class="comment">// æ³›å‹è£…çš„æ˜¯Threadï¼ŒåŸå­å¼•ç”¨çº¿ç¨‹</span></span><br><span class="line">    AtomicReference&lt;Thread&gt; atomicReference = <span class="keyword">new</span> <span class="title class_">AtomicReference</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">        System.out.println(thread.getName() + <span class="string">&quot; come in&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//å¼€å§‹è‡ªæ—‹ï¼ŒæœŸæœ›å€¼ä¸ºnullï¼Œæ›´æ–°å€¼æ˜¯å½“å‰çº¿ç¨‹</span></span><br><span class="line">        <span class="keyword">while</span> (!atomicReference.compareAndSet(<span class="literal">null</span>, thread)) &#123;</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">            System.out.println(thread.getName() + <span class="string">&quot; æ­£åœ¨è‡ªæ—‹&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(thread.getName() + <span class="string">&quot; è‡ªæ—‹æˆåŠŸ&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//çº¿ç¨‹ä½¿ç”¨å®Œé”æŠŠå¼•ç”¨å˜ä¸ºnull</span></span><br><span class="line">atomicReference.compareAndSet(thread, <span class="literal">null</span>);</span><br><span class="line">        System.out.println(thread.getName() + <span class="string">&quot; invoke unlock&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">SpinLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SpinLock</span>();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="comment">//å æœ‰é”</span></span><br><span class="line">            lock.lock();</span><br><span class="line">            Thread.sleep(<span class="number">10000</span>); </span><br><span class="line"></span><br><span class="line">            <span class="comment">//é‡Šæ”¾é”</span></span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;,<span class="string">&quot;t1&quot;</span>).start();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è®©mainçº¿ç¨‹æš‚åœ1ç§’ï¼Œä½¿å¾—t1çº¿ç¨‹ï¼Œå…ˆæ‰§è¡Œ</span></span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            lock.lock();</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;,<span class="string">&quot;t2&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h5 id="é”æ¶ˆé™¤"><a href="#é”æ¶ˆé™¤" class="headerlink" title="é”æ¶ˆé™¤"></a>é”æ¶ˆé™¤</h5><p>é”æ¶ˆé™¤æ˜¯æŒ‡å¯¹äºè¢«æ£€æµ‹å‡ºä¸å¯èƒ½å­˜åœ¨ç«äº‰çš„å…±äº«æ•°æ®çš„é”è¿›è¡Œæ¶ˆé™¤ï¼Œè¿™æ˜¯ JVM <strong>å³æ—¶ç¼–è¯‘å™¨çš„ä¼˜åŒ–</strong></p><p>é”æ¶ˆé™¤ä¸»è¦æ˜¯é€šè¿‡<strong>é€ƒé€¸åˆ†æ</strong>æ¥æ”¯æŒï¼Œå¦‚æœå †ä¸Šçš„å…±äº«æ•°æ®ä¸å¯èƒ½é€ƒé€¸å‡ºå»è¢«å…¶å®ƒçº¿ç¨‹è®¿é—®åˆ°ï¼Œé‚£ä¹ˆå°±å¯ä»¥æŠŠå®ƒä»¬å½“æˆç§æœ‰æ•°æ®å¯¹å¾…ï¼Œä¹Ÿå°±å¯ä»¥å°†å®ƒä»¬çš„é”è¿›è¡Œæ¶ˆé™¤ï¼ˆåŒæ­¥æ¶ˆé™¤ï¼šJVM é€ƒé€¸åˆ†æï¼‰</p><hr><h5 id="é”ç²—åŒ–"><a href="#é”ç²—åŒ–" class="headerlink" title="é”ç²—åŒ–"></a>é”ç²—åŒ–</h5><p>å¯¹ç›¸åŒå¯¹è±¡å¤šæ¬¡åŠ é”ï¼Œå¯¼è‡´çº¿ç¨‹å‘ç”Ÿå¤šæ¬¡é‡å…¥ï¼Œé¢‘ç¹çš„åŠ é”æ“ä½œå°±ä¼šå¯¼è‡´æ€§èƒ½æŸè€—ï¼Œå¯ä»¥ä½¿ç”¨é”ç²—åŒ–æ–¹å¼ä¼˜åŒ–</p><p>å¦‚æœè™šæ‹Ÿæœºæ¢æµ‹åˆ°ä¸€ä¸²çš„æ“ä½œéƒ½å¯¹åŒä¸€ä¸ªå¯¹è±¡åŠ é”ï¼Œå°†ä¼šæŠŠåŠ é”çš„èŒƒå›´æ‰©å±•ï¼ˆç²—åŒ–ï¼‰åˆ°æ•´ä¸ªæ“ä½œåºåˆ—çš„å¤–éƒ¨</p><ul><li><p>ä¸€äº›çœ‹èµ·æ¥æ²¡æœ‰åŠ é”çš„ä»£ç ï¼Œå…¶å®éšå¼çš„åŠ äº†å¾ˆå¤šé”ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">concatString</span><span class="params">(String s1, String s2, String s3)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> s1 + s2 + s3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>String æ˜¯ä¸€ä¸ªä¸å¯å˜çš„ç±»ï¼Œç¼–è¯‘å™¨ä¼šå¯¹ String çš„æ‹¼æ¥è‡ªåŠ¨ä¼˜åŒ–ã€‚åœ¨ JDK 1.5 ä¹‹å‰ï¼Œè½¬åŒ–ä¸º StringBuffer å¯¹è±¡çš„è¿ç»­ append() æ“ä½œï¼Œæ¯ä¸ª append() æ–¹æ³•ä¸­éƒ½æœ‰ä¸€ä¸ªåŒæ­¥å—</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">concatString</span><span class="params">(String s1, String s2, String s3)</span> &#123;</span><br><span class="line">    <span class="type">StringBuffer</span> <span class="variable">sb</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringBuffer</span>();</span><br><span class="line">    sb.append(s1);</span><br><span class="line">    sb.append(s2);</span><br><span class="line">    sb.append(s3);</span><br><span class="line">    <span class="keyword">return</span> sb.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p>æ‰©å±•åˆ°ç¬¬ä¸€ä¸ª append() æ“ä½œä¹‹å‰ç›´è‡³æœ€åä¸€ä¸ª append() æ“ä½œä¹‹åï¼Œåªéœ€è¦åŠ é”ä¸€æ¬¡å°±å¯ä»¥</p><hr><h4 id="å¤šæŠŠé”"><a href="#å¤šæŠŠé”" class="headerlink" title="å¤šæŠŠé”"></a>å¤šæŠŠé”</h4><p>å¤šæŠŠä¸ç›¸å¹²çš„é”ï¼šä¸€é—´å¤§å±‹å­æœ‰ä¸¤ä¸ªåŠŸèƒ½ç¡è§‰ã€å­¦ä¹ ï¼Œäº’ä¸ç›¸å¹²ã€‚ç°åœ¨ä¸€äººè¦å­¦ä¹ ï¼Œä¸€äººè¦ç¡è§‰ï¼Œå¦‚æœåªç”¨ä¸€é—´å±‹å­ï¼ˆä¸€ä¸ªå¯¹è±¡é”ï¼‰çš„è¯ï¼Œé‚£ä¹ˆå¹¶å‘åº¦å¾ˆä½</p><p>å°†é”çš„ç²’åº¦ç»†åˆ†ï¼š</p><ul><li>å¥½å¤„ï¼Œæ˜¯å¯ä»¥å¢å¼ºå¹¶å‘åº¦</li><li>åå¤„ï¼Œå¦‚æœä¸€ä¸ªçº¿ç¨‹éœ€è¦åŒæ—¶è·å¾—å¤šæŠŠé”ï¼Œå°±å®¹æ˜“å‘ç”Ÿæ­»é”</li></ul><p>è§£å†³æ–¹æ³•ï¼šå‡†å¤‡å¤šä¸ªå¯¹è±¡é”</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">BigRoom</span> <span class="variable">bigRoom</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BigRoom</span>();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123; bigRoom.study(); &#125;).start();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123; bigRoom.sleep(); &#125;).start();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BigRoom</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">studyRoom</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">sleepRoom</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sleep</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (sleepRoom) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;sleeping 2 å°æ—¶&quot;</span>);</span><br><span class="line">            Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">study</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (studyRoom) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;study 1 å°æ—¶&quot;</span>);</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h4 id="æ´»è·ƒæ€§"><a href="#æ´»è·ƒæ€§" class="headerlink" title="æ´»è·ƒæ€§"></a>æ´»è·ƒæ€§</h4><h5 id="æ­»é”"><a href="#æ­»é”" class="headerlink" title="æ­»é”"></a>æ­»é”</h5><h6 id="å½¢æˆ"><a href="#å½¢æˆ" class="headerlink" title="å½¢æˆ"></a>å½¢æˆ</h6><p>æ­»é”ï¼šå¤šä¸ªçº¿ç¨‹åŒæ—¶è¢«é˜»å¡ï¼Œå®ƒä»¬ä¸­çš„ä¸€ä¸ªæˆ–è€…å…¨éƒ¨éƒ½åœ¨ç­‰å¾…æŸä¸ªèµ„æºè¢«é‡Šæ”¾ï¼Œç”±äºçº¿ç¨‹è¢«æ— é™æœŸåœ°é˜»å¡ï¼Œå› æ­¤ç¨‹åºä¸å¯èƒ½æ­£å¸¸ç»ˆæ­¢</p><p>Java æ­»é”äº§ç”Ÿçš„å››ä¸ªå¿…è¦æ¡ä»¶ï¼š</p><ol><li>äº’æ–¥æ¡ä»¶ï¼Œå³å½“èµ„æºè¢«ä¸€ä¸ªçº¿ç¨‹ä½¿ç”¨ï¼ˆå æœ‰ï¼‰æ—¶ï¼Œåˆ«çš„çº¿ç¨‹ä¸èƒ½ä½¿ç”¨</li><li>ä¸å¯å‰¥å¤ºæ¡ä»¶ï¼Œèµ„æºè¯·æ±‚è€…ä¸èƒ½å¼ºåˆ¶ä»èµ„æºå æœ‰è€…æ‰‹ä¸­å¤ºå–èµ„æºï¼Œèµ„æºåªèƒ½ç”±èµ„æºå æœ‰è€…ä¸»åŠ¨é‡Šæ”¾</li><li>è¯·æ±‚å’Œä¿æŒæ¡ä»¶ï¼Œå³å½“èµ„æºè¯·æ±‚è€…åœ¨è¯·æ±‚å…¶ä»–çš„èµ„æºçš„åŒæ—¶ä¿æŒå¯¹åŸæœ‰èµ„æºçš„å æœ‰</li><li>å¾ªç¯ç­‰å¾…æ¡ä»¶ï¼Œå³å­˜åœ¨ä¸€ä¸ªç­‰å¾…å¾ªç¯é˜Ÿåˆ—ï¼šp1 è¦ p2 çš„èµ„æºï¼Œp2 è¦ p1 çš„èµ„æºï¼Œå½¢æˆäº†ä¸€ä¸ªç­‰å¾…ç¯è·¯</li></ol><p>å››ä¸ªæ¡ä»¶éƒ½æˆç«‹çš„æ—¶å€™ï¼Œä¾¿å½¢æˆæ­»é”ã€‚æ­»é”æƒ…å†µä¸‹æ‰“ç ´ä¸Šè¿°ä»»ä½•ä¸€ä¸ªæ¡ä»¶ï¼Œä¾¿å¯è®©æ­»é”æ¶ˆå¤±</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Dead</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">Object</span> <span class="variable">resources1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">Object</span> <span class="variable">resources2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="comment">// çº¿ç¨‹1ï¼šå ç”¨èµ„æº1 ï¼Œè¯·æ±‚èµ„æº2</span></span><br><span class="line">            <span class="keyword">synchronized</span>(resources1)&#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;çº¿ç¨‹1å·²ç»å ç”¨äº†èµ„æº1ï¼Œå¼€å§‹è¯·æ±‚èµ„æº2&quot;</span>);</span><br><span class="line">                Thread.sleep(<span class="number">2000</span>);<span class="comment">//ä¼‘æ¯ä¸¤ç§’ï¼Œé˜²æ­¢çº¿ç¨‹1ç›´æ¥è¿è¡Œå®Œæˆã€‚</span></span><br><span class="line">                <span class="comment">//2ç§’å†…çº¿ç¨‹2è‚¯å®šå¯ä»¥é”ä½èµ„æº2</span></span><br><span class="line">                <span class="keyword">synchronized</span> (resources2)&#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;çº¿ç¨‹1å·²ç»å ç”¨äº†èµ„æº2&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="comment">// çº¿ç¨‹2ï¼šå ç”¨èµ„æº2 ï¼Œè¯·æ±‚èµ„æº1</span></span><br><span class="line">            <span class="keyword">synchronized</span>(resources2)&#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;çº¿ç¨‹2å·²ç»å ç”¨äº†èµ„æº2ï¼Œå¼€å§‹è¯·æ±‚èµ„æº1&quot;</span>);</span><br><span class="line">                Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">                <span class="keyword">synchronized</span> (resources1)&#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;çº¿ç¨‹2å·²ç»å ç”¨äº†èµ„æº1&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;&#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h6 id="å®šä½"><a href="#å®šä½" class="headerlink" title="å®šä½"></a>å®šä½</h6><p>å®šä½æ­»é”çš„æ–¹æ³•ï¼š</p><ul><li><p>ä½¿ç”¨ jps å®šä½è¿›ç¨‹ idï¼Œå†ç”¨ <code>jstack id</code> å®šä½æ­»é”ï¼Œæ‰¾åˆ°æ­»é”çš„çº¿ç¨‹å»æŸ¥çœ‹æºç ï¼Œè§£å†³ä¼˜åŒ–</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;Thread-1&quot;</span> <span class="comment">#12 prio=5 os_prio=0 tid=0x000000001eb69000 nid=0xd40 waiting formonitor entry [0x000000001f54f000]</span></span><br><span class="line">java.lang.Thread.State: BLOCKED (on object monitor)</span><br><span class="line"><span class="comment">#çœç•¥    </span></span><br><span class="line"><span class="string">&quot;Thread-1&quot;</span> <span class="comment">#12 prio=5 os_prio=0 tid=0x000000001eb69000 nid=0xd40 waiting for monitor entry [0x000000001f54f000]</span></span><br><span class="line">java.lang.Thread.State: BLOCKED (on object monitor)</span><br><span class="line"><span class="comment">#çœç•¥</span></span><br><span class="line"></span><br><span class="line">Found one Java-level deadlock:</span><br><span class="line">===================================================</span><br><span class="line"><span class="string">&quot;Thread-1&quot;</span>:</span><br><span class="line">    waiting to lock monitor 0x000000000361d378 (object 0x000000076b5bf1c0, a java.lang.Object),</span><br><span class="line">    <span class="built_in">which</span> is held by <span class="string">&quot;Thread-0&quot;</span></span><br><span class="line"><span class="string">&quot;Thread-0&quot;</span>:</span><br><span class="line">    waiting to lock monitor 0x000000000361e768 (object 0x000000076b5bf1d0, a java.lang.Object),</span><br><span class="line">    <span class="built_in">which</span> is held by <span class="string">&quot;Thread-1&quot;</span></span><br><span class="line">    </span><br><span class="line">Java stack information <span class="keyword">for</span> the threads listed above:</span><br><span class="line">===================================================</span><br><span class="line"><span class="string">&quot;Thread-1&quot;</span>:</span><br><span class="line">    at thread.TestDeadLock.lambda$main<span class="variable">$1</span>(TestDeadLock.java:28)</span><br><span class="line">    - waiting to lock &lt;0x000000076b5bf1c0&gt; (a java.lang.Object)</span><br><span class="line">    - locked &lt;0x000000076b5bf1d0&gt; (a java.lang.Object)</span><br><span class="line">    at thread.TestDeadLock$$Lambda<span class="variable">$2</span>/883049899.run(Unknown Source)</span><br><span class="line">    at java.lang.Thread.run(Thread.java:745)</span><br><span class="line"><span class="string">&quot;Thread-0&quot;</span>:</span><br><span class="line">    at thread.TestDeadLock.lambda$main<span class="variable">$0</span>(TestDeadLock.java:15)</span><br><span class="line">    - waiting to lock &lt;0x000000076b5bf1d0&gt; (a java.lang.Object)</span><br><span class="line">    - locked &lt;0x000000076b5bf1c0&gt; (a java.lang.Object)</span><br><span class="line">    at thread.TestDeadLock$$Lambda<span class="variable">$1</span>/495053715</span><br></pre></td></tr></table></figure></li><li><p>Linux ä¸‹å¯ä»¥é€šè¿‡ top å…ˆå®šä½åˆ° CPU å ç”¨é«˜çš„ Java è¿›ç¨‹ï¼Œå†åˆ©ç”¨ <code>top -Hp è¿›ç¨‹id</code> æ¥å®šä½æ˜¯å“ªä¸ªçº¿ç¨‹ï¼Œæœ€åå†ç”¨ jstack <pid>çš„è¾“å‡ºæ¥çœ‹å„ä¸ªçº¿ç¨‹æ ˆ</p></li><li><p>é¿å…æ­»é”ï¼šé¿å…æ­»é”è¦æ³¨æ„åŠ é”é¡ºåº</p></li><li><p>å¯ä»¥ä½¿ç”¨ jconsole å·¥å…·ï¼Œåœ¨ <code>jdk\bin</code> ç›®å½•ä¸‹</p></li></ul><hr><h5 id="æ´»é”"><a href="#æ´»é”" class="headerlink" title="æ´»é”"></a>æ´»é”</h5><p>æ´»é”ï¼šæŒ‡çš„æ˜¯ä»»åŠ¡æˆ–è€…æ‰§è¡Œè€…æ²¡æœ‰è¢«é˜»å¡ï¼Œç”±äºæŸäº›æ¡ä»¶æ²¡æœ‰æ»¡è¶³ï¼Œå¯¼è‡´ä¸€ç›´é‡å¤å°è¯•â€”å¤±è´¥â€”å°è¯•â€”å¤±è´¥çš„è¿‡ç¨‹</p><p>ä¸¤ä¸ªçº¿ç¨‹äº’ç›¸æ”¹å˜å¯¹æ–¹çš„ç»“æŸæ¡ä»¶ï¼Œæœ€åè°ä¹Ÿæ— æ³•ç»“æŸï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">TestLiveLock</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">volatile</span> <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">10</span>;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="comment">// æœŸæœ›å‡åˆ° 0 é€€å‡ºå¾ªç¯</span></span><br><span class="line">            <span class="keyword">while</span> (count &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                Thread.sleep(<span class="number">200</span>);</span><br><span class="line">                count--;</span><br><span class="line">                System.out.println(<span class="string">&quot;çº¿ç¨‹ä¸€count:&quot;</span> + count);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;t1&quot;</span>).start();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="comment">// æœŸæœ›è¶…è¿‡ 20 é€€å‡ºå¾ªç¯</span></span><br><span class="line">            <span class="keyword">while</span> (count &lt; <span class="number">20</span>) &#123;</span><br><span class="line">                Thread.sleep(<span class="number">200</span>);</span><br><span class="line">                count++;</span><br><span class="line">                System.out.println(<span class="string">&quot;çº¿ç¨‹äºŒcount:&quot;</span>+ count);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;t2&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h5 id="é¥¥é¥¿"><a href="#é¥¥é¥¿" class="headerlink" title="é¥¥é¥¿"></a>é¥¥é¥¿</h5><p>é¥¥é¥¿ï¼šä¸€ä¸ªçº¿ç¨‹ç”±äºä¼˜å…ˆçº§å¤ªä½ï¼Œå§‹ç»ˆå¾—ä¸åˆ° CPU è°ƒåº¦æ‰§è¡Œï¼Œä¹Ÿä¸èƒ½å¤Ÿç»“æŸ</p><hr><h3 id="wait-ify"><a href="#wait-ify" class="headerlink" title="wait-ify"></a>wait-ify</h3><h4 id="åŸºæœ¬ä½¿ç”¨"><a href="#åŸºæœ¬ä½¿ç”¨" class="headerlink" title="åŸºæœ¬ä½¿ç”¨"></a>åŸºæœ¬ä½¿ç”¨</h4><p>éœ€è¦è·å–å¯¹è±¡é”åæ‰å¯ä»¥è°ƒç”¨ <code>é”å¯¹è±¡.wait()</code>ï¼Œnotify éšæœºå”¤é†’ä¸€ä¸ªçº¿ç¨‹ï¼ŒnotifyAll å”¤é†’æ‰€æœ‰çº¿ç¨‹å»ç«äº‰ CPU</p><p>Object ç±» APIï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">notify</span><span class="params">()</span>:å”¤é†’æ­£åœ¨ç­‰å¾…å¯¹è±¡ç›‘è§†å™¨çš„å•ä¸ªçº¿ç¨‹ã€‚</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">notifyAll</span><span class="params">()</span>:å”¤é†’æ­£åœ¨ç­‰å¾…å¯¹è±¡ç›‘è§†å™¨çš„æ‰€æœ‰çº¿ç¨‹ã€‚</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">wait</span><span class="params">()</span>:å¯¼è‡´å½“å‰çº¿ç¨‹ç­‰å¾…ï¼Œç›´åˆ°å¦ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨è¯¥å¯¹è±¡çš„ notify() æ–¹æ³•æˆ– notifyAll()æ–¹æ³•ã€‚</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">wait</span><span class="params">(<span class="type">long</span> timeout)</span>:æœ‰æ—¶é™çš„ç­‰å¾…, åˆ°næ¯«ç§’åç»“æŸç­‰å¾…ï¼Œæˆ–æ˜¯è¢«å”¤é†’</span><br></pre></td></tr></table></figure><p>è¯´æ˜ï¼š<strong>wait æ˜¯æŒ‚èµ·çº¿ç¨‹ï¼Œéœ€è¦å”¤é†’çš„éƒ½æ˜¯æŒ‚èµ·æ“ä½œ</strong>ï¼Œé˜»å¡çº¿ç¨‹å¯ä»¥è‡ªå·±å»äº‰æŠ¢é”ï¼ŒæŒ‚èµ·çš„çº¿ç¨‹éœ€è¦å”¤é†’åå»äº‰æŠ¢é”</p><p>å¯¹æ¯” sleep()ï¼š</p><ul><li>åŸç†ä¸åŒï¼šsleep() æ–¹æ³•æ˜¯å±äº Thread ç±»ï¼Œæ˜¯çº¿ç¨‹ç”¨æ¥æ§åˆ¶è‡ªèº«æµç¨‹çš„ï¼Œä½¿æ­¤çº¿ç¨‹æš‚åœæ‰§è¡Œä¸€æ®µæ—¶é—´è€ŒæŠŠæ‰§è¡Œæœºä¼šè®©ç»™å…¶ä»–çº¿ç¨‹ï¼›wait() æ–¹æ³•å±äº Object ç±»ï¼Œç”¨äºçº¿ç¨‹é—´é€šä¿¡</li><li>å¯¹<strong>é”çš„å¤„ç†æœºåˆ¶</strong>ä¸åŒï¼šè°ƒç”¨ sleep() æ–¹æ³•çš„è¿‡ç¨‹ä¸­ï¼Œçº¿ç¨‹ä¸ä¼šé‡Šæ”¾å¯¹è±¡é”ï¼Œå½“è°ƒç”¨ wait() æ–¹æ³•çš„æ—¶å€™ï¼Œçº¿ç¨‹ä¼šæ”¾å¼ƒå¯¹è±¡é”ï¼Œè¿›å…¥ç­‰å¾…æ­¤å¯¹è±¡çš„ç­‰å¾…é”å®šæ± ï¼ˆä¸é‡Šæ”¾é”å…¶ä»–çº¿ç¨‹æ€ä¹ˆæŠ¢å åˆ°é”æ‰§è¡Œå”¤é†’æ“ä½œï¼‰ï¼Œä½†æ˜¯éƒ½ä¼šé‡Šæ”¾ CPU</li><li>ä½¿ç”¨åŒºåŸŸä¸åŒï¼šwait() æ–¹æ³•å¿…é¡»æ”¾åœ¨<strong>åŒæ­¥æ§åˆ¶æ–¹æ³•å’ŒåŒæ­¥ä»£ç å—ï¼ˆå…ˆè·å–é”ï¼‰</strong>ä¸­ä½¿ç”¨ï¼Œsleep() æ–¹æ³•åˆ™å¯ä»¥æ”¾åœ¨ä»»ä½•åœ°æ–¹ä½¿ç”¨</li></ul><p>åº•å±‚åŸç†ï¼š</p><ul><li>Owner çº¿ç¨‹å‘ç°æ¡ä»¶ä¸æ»¡è¶³ï¼Œè°ƒç”¨ wait æ–¹æ³•ï¼Œå³å¯è¿›å…¥ WaitSet å˜ä¸º WAITING çŠ¶æ€</li><li>BLOCKED å’Œ WAITING çš„çº¿ç¨‹éƒ½å¤„äºé˜»å¡çŠ¶æ€ï¼Œä¸å ç”¨ CPU æ—¶é—´ç‰‡</li><li>BLOCKED çº¿ç¨‹ä¼šåœ¨ Owner çº¿ç¨‹é‡Šæ”¾é”æ—¶å”¤é†’</li><li>WAITING çº¿ç¨‹ä¼šåœ¨ Owner çº¿ç¨‹è°ƒç”¨ notify æˆ– notifyAll æ—¶å”¤é†’ï¼Œå”¤é†’åå¹¶ä¸æ„å‘³è€…ç«‹åˆ»è·å¾—é”ï¼Œ<strong>éœ€è¦è¿›å…¥ EntryList é‡æ–°ç«äº‰</strong></li></ul><p><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/JUC-Monitor%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%862.png"></p><hr><h4 id="ä»£ç ä¼˜åŒ–"><a href="#ä»£ç ä¼˜åŒ–" class="headerlink" title="ä»£ç ä¼˜åŒ–"></a>ä»£ç ä¼˜åŒ–</h4><p>è™šå‡å”¤é†’ï¼šnotify åªèƒ½éšæœºå”¤é†’ä¸€ä¸ª WaitSet ä¸­çš„çº¿ç¨‹ï¼Œè¿™æ—¶å¦‚æœæœ‰å…¶å®ƒçº¿ç¨‹ä¹Ÿåœ¨ç­‰å¾…ï¼Œé‚£ä¹ˆå°±å¯èƒ½å”¤é†’ä¸äº†æ­£ç¡®çš„çº¿ç¨‹</p><p>è§£å†³æ–¹æ³•ï¼šé‡‡ç”¨ notifyAll</p><p>notifyAll ä»…è§£å†³æŸä¸ªçº¿ç¨‹çš„å”¤é†’é—®é¢˜ï¼Œä½¿ç”¨ if + wait åˆ¤æ–­ä»…æœ‰ä¸€æ¬¡æœºä¼šï¼Œä¸€æ—¦æ¡ä»¶ä¸æˆç«‹ï¼Œæ— æ³•é‡æ–°åˆ¤æ–­</p><p>è§£å†³æ–¹æ³•ï¼šç”¨ while + waitï¼Œå½“æ¡ä»¶ä¸æˆç«‹ï¼Œå†æ¬¡ wait</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf4j(topic = &quot;c.demo&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">demo</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">room</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line">    <span class="keyword">static</span> <span class="type">boolean</span> <span class="variable">hasCigarette</span> <span class="operator">=</span> <span class="literal">false</span>;    <span class="comment">//æœ‰æ²¡æœ‰çƒŸ</span></span><br><span class="line">    <span class="keyword">static</span> <span class="type">boolean</span> <span class="variable">hasTakeout</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (room) &#123;</span><br><span class="line">                log.debug(<span class="string">&quot;æœ‰çƒŸæ²¡ï¼Ÿ[&#123;&#125;]&quot;</span>, hasCigarette);</span><br><span class="line">                <span class="keyword">while</span> (!hasCigarette) &#123;<span class="comment">//whileé˜²æ­¢è™šå‡å”¤é†’</span></span><br><span class="line">                    log.debug(<span class="string">&quot;æ²¡çƒŸï¼Œå…ˆæ­‡ä¼šï¼&quot;</span>);</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        room.wait();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                log.debug(<span class="string">&quot;æœ‰çƒŸæ²¡ï¼Ÿ[&#123;&#125;]&quot;</span>, hasCigarette);</span><br><span class="line">                <span class="keyword">if</span> (hasCigarette) &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;å¯ä»¥å¼€å§‹å¹²æ´»äº†&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;æ²¡å¹²æˆæ´»...&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;å°å—&quot;</span>).start();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (room) &#123;</span><br><span class="line">                <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">                log.debug(<span class="string">&quot;å¤–å–é€åˆ°æ²¡ï¼Ÿ[&#123;&#125;]&quot;</span>, hasTakeout);</span><br><span class="line">                <span class="keyword">if</span> (!hasTakeout) &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;æ²¡å¤–å–ï¼Œå…ˆæ­‡ä¼šï¼&quot;</span>);</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        room.wait();</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                log.debug(<span class="string">&quot;å¤–å–é€åˆ°æ²¡ï¼Ÿ[&#123;&#125;]&quot;</span>, hasTakeout);</span><br><span class="line">                <span class="keyword">if</span> (hasTakeout) &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;å¯ä»¥å¼€å§‹å¹²æ´»äº†&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;æ²¡å¹²æˆæ´»...&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;å°å¥³&quot;</span>).start();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="comment">// è¿™é‡Œèƒ½ä¸èƒ½åŠ  synchronized (room)ï¼Ÿ</span></span><br><span class="line">            <span class="keyword">synchronized</span> (room) &#123;</span><br><span class="line">                hasTakeout = <span class="literal">true</span>;</span><br><span class="line"><span class="comment">//log.debug(&quot;çƒŸåˆ°äº†å™¢ï¼&quot;);</span></span><br><span class="line">                log.debug(<span class="string">&quot;å¤–å–åˆ°äº†å™¢ï¼&quot;</span>);</span><br><span class="line">                room.notifyAll();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;é€å¤–å–çš„&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h3 id="park-un"><a href="#park-un" class="headerlink" title="park-un"></a>park-un</h3><p>LockSupport æ˜¯ç”¨æ¥åˆ›å»ºé”å’Œå…¶ä»–åŒæ­¥ç±»çš„<strong>çº¿ç¨‹åŸè¯­</strong></p><p>LockSupport ç±»æ–¹æ³•ï¼š</p><ul><li><code>LockSupport.park()</code>ï¼šæš‚åœå½“å‰çº¿ç¨‹ï¼ŒæŒ‚èµ·åŸè¯­</li><li><code>LockSupport.unpark(æš‚åœçš„çº¿ç¨‹å¯¹è±¡)</code>ï¼šæ¢å¤æŸä¸ªçº¿ç¨‹çš„è¿è¡Œ</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;start...&quot;</span>);<span class="comment">//1</span></span><br><span class="line">Thread.sleep(<span class="number">1000</span>);<span class="comment">// Thread.sleep(3000)</span></span><br><span class="line">        <span class="comment">// å…ˆ park å† unpark å’Œå…ˆ unpark å† park æ•ˆæœä¸€æ ·ï¼Œéƒ½ä¼šç›´æ¥æ¢å¤çº¿ç¨‹çš„è¿è¡Œ</span></span><br><span class="line">        System.out.println(<span class="string">&quot;park...&quot;</span>);<span class="comment">//2</span></span><br><span class="line">        LockSupport.park();</span><br><span class="line">        System.out.println(<span class="string">&quot;resume...&quot;</span>);<span class="comment">//4</span></span><br><span class="line">    &#125;,<span class="string">&quot;t1&quot;</span>);</span><br><span class="line">    t1.start();</span><br><span class="line">   Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">    System.out.println(<span class="string">&quot;unpark...&quot;</span>);<span class="comment">//3</span></span><br><span class="line">    LockSupport.unpark(t1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>LockSupport å‡ºç°å°±æ˜¯ä¸ºäº†å¢å¼º wait &amp; notify çš„åŠŸèƒ½ï¼š</p><ul><li>waitï¼Œnotify å’Œ notifyAll å¿…é¡»é…åˆ Object Monitor ä¸€èµ·ä½¿ç”¨ï¼Œè€Œ parkã€unpark ä¸éœ€è¦</li><li>park &amp; unpark <strong>ä»¥çº¿ç¨‹ä¸ºå•ä½</strong>æ¥é˜»å¡å’Œå”¤é†’çº¿ç¨‹ï¼Œè€Œ notify åªèƒ½éšæœºå”¤é†’ä¸€ä¸ªç­‰å¾…çº¿ç¨‹ï¼ŒnotifyAll æ˜¯å”¤é†’æ‰€æœ‰ç­‰å¾…çº¿ç¨‹</li><li>park &amp; unpark å¯ä»¥å…ˆ unparkï¼Œè€Œ wait &amp; notify ä¸èƒ½å…ˆ notifyã€‚ç±»æ¯”ç”Ÿäº§æ¶ˆè´¹ï¼Œå…ˆæ¶ˆè´¹å‘ç°æœ‰äº§å“å°±æ¶ˆè´¹ï¼Œæ²¡æœ‰å°±ç­‰å¾…ï¼›å…ˆç”Ÿäº§å°±ç›´æ¥äº§ç”Ÿå•†å“ï¼Œç„¶åçº¿ç¨‹ç›´æ¥æ¶ˆè´¹</li><li>wait ä¼šé‡Šæ”¾é”èµ„æºè¿›å…¥ç­‰å¾…é˜Ÿåˆ—ï¼Œ<strong>park ä¸ä¼šé‡Šæ”¾é”èµ„æº</strong>ï¼Œåªè´Ÿè´£é˜»å¡å½“å‰çº¿ç¨‹ï¼Œä¼šé‡Šæ”¾ CPU</li></ul><p>åŸç†ï¼šç±»ä¼¼ç”Ÿäº§è€…æ¶ˆè´¹è€…</p><ul><li>å…ˆ parkï¼š<ol><li>å½“å‰çº¿ç¨‹è°ƒç”¨ Unsafe.park() æ–¹æ³•</li><li>æ£€æŸ¥ _counter ï¼Œæœ¬æƒ…å†µä¸º 0ï¼Œè¿™æ—¶è·å¾— _mutex äº’æ–¥é”</li><li>çº¿ç¨‹è¿›å…¥ _cond æ¡ä»¶å˜é‡æŒ‚èµ·</li><li>è°ƒç”¨ Unsafe.unpark(Thread_0) æ–¹æ³•ï¼Œè®¾ç½® _counter ä¸º 1</li><li>å”¤é†’ _cond æ¡ä»¶å˜é‡ä¸­çš„ Thread_0ï¼ŒThread_0 æ¢å¤è¿è¡Œï¼Œè®¾ç½® _counter ä¸º 0</li></ol></li></ul><p><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/JUC-park%E5%8E%9F%E7%90%861.png"></p><ul><li><p>å…ˆ unparkï¼š</p><ol><li>è°ƒç”¨ Unsafe.unpark(Thread_0) æ–¹æ³•ï¼Œè®¾ç½® _counter ä¸º 1</li><li>å½“å‰çº¿ç¨‹è°ƒç”¨ Unsafe.park() æ–¹æ³•</li><li>æ£€æŸ¥ _counter ï¼Œæœ¬æƒ…å†µä¸º 1ï¼Œè¿™æ—¶çº¿ç¨‹æ— éœ€æŒ‚èµ·ï¼Œç»§ç»­è¿è¡Œï¼Œè®¾ç½® _counter ä¸º 0</li></ol><p><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/JUC-park%E5%8E%9F%E7%90%862.png"></p></li></ul><hr><h3 id="å®‰å…¨åˆ†æ"><a href="#å®‰å…¨åˆ†æ" class="headerlink" title="å®‰å…¨åˆ†æ"></a>å®‰å…¨åˆ†æ</h3><p>æˆå‘˜å˜é‡å’Œé™æ€å˜é‡ï¼š</p><ul><li>å¦‚æœå®ƒä»¬æ²¡æœ‰å…±äº«ï¼Œåˆ™çº¿ç¨‹å®‰å…¨</li><li>å¦‚æœå®ƒä»¬è¢«å…±äº«äº†ï¼Œæ ¹æ®å®ƒä»¬çš„çŠ¶æ€æ˜¯å¦èƒ½å¤Ÿæ”¹å˜ï¼Œåˆ†ä¸¤ç§æƒ…å†µï¼š<ul><li>å¦‚æœåªæœ‰è¯»æ“ä½œï¼Œåˆ™çº¿ç¨‹å®‰å…¨</li><li>å¦‚æœæœ‰è¯»å†™æ“ä½œï¼Œåˆ™è¿™æ®µä»£ç æ˜¯ä¸´ç•ŒåŒºï¼Œéœ€è¦è€ƒè™‘çº¿ç¨‹å®‰å…¨é—®é¢˜</li></ul></li></ul><p>å±€éƒ¨å˜é‡ï¼š</p><ul><li>å±€éƒ¨å˜é‡æ˜¯çº¿ç¨‹å®‰å…¨çš„</li><li>å±€éƒ¨å˜é‡å¼•ç”¨çš„å¯¹è±¡ä¸ä¸€å®šçº¿ç¨‹å®‰å…¨ï¼ˆé€ƒé€¸åˆ†æï¼‰ï¼š<ul><li>å¦‚æœè¯¥å¯¹è±¡æ²¡æœ‰é€ƒç¦»æ–¹æ³•çš„ä½œç”¨è®¿é—®ï¼Œå®ƒæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼ˆæ¯ä¸€ä¸ªæ–¹æ³•æœ‰ä¸€ä¸ªæ ˆå¸§ï¼‰</li><li>å¦‚æœè¯¥å¯¹è±¡é€ƒç¦»æ–¹æ³•çš„ä½œç”¨èŒƒå›´ï¼Œéœ€è¦è€ƒè™‘çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼ˆæš´éœ²å¼•ç”¨ï¼‰</li></ul></li></ul><p>å¸¸è§çº¿ç¨‹å®‰å…¨ç±»ï¼šStringã€Integerã€StringBufferã€Randomã€Vectorã€Hashtableã€java.util.concurrent åŒ…</p><ul><li><p>çº¿ç¨‹å®‰å…¨çš„æ˜¯æŒ‡ï¼Œå¤šä¸ªçº¿ç¨‹è°ƒç”¨å®ƒä»¬åŒä¸€ä¸ªå®ä¾‹çš„æŸä¸ªæ–¹æ³•æ—¶ï¼Œæ˜¯çº¿ç¨‹å®‰å…¨çš„</p></li><li><p><strong>æ¯ä¸ªæ–¹æ³•æ˜¯åŸå­çš„ï¼Œä½†å¤šä¸ªæ–¹æ³•çš„ç»„åˆä¸æ˜¯åŸå­çš„</strong>ï¼Œåªèƒ½ä¿è¯è°ƒç”¨çš„æ–¹æ³•å†…éƒ¨å®‰å…¨ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Hashtable</span> <span class="variable">table</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hashtable</span>();</span><br><span class="line"><span class="comment">// çº¿ç¨‹1ï¼Œçº¿ç¨‹2</span></span><br><span class="line"><span class="keyword">if</span>(table.get(<span class="string">&quot;key&quot;</span>) == <span class="literal">null</span>) &#123;</span><br><span class="line">table.put(<span class="string">&quot;key&quot;</span>, value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p>æ— çŠ¶æ€ç±»çº¿ç¨‹å®‰å…¨ï¼Œå°±æ˜¯æ²¡æœ‰æˆå‘˜å˜é‡çš„ç±»</p><p>ä¸å¯å˜ç±»çº¿ç¨‹å®‰å…¨ï¼šStringã€Integer ç­‰éƒ½æ˜¯ä¸å¯å˜ç±»ï¼Œ<strong>å†…éƒ¨çš„çŠ¶æ€ä¸å¯ä»¥æ”¹å˜</strong>ï¼Œæ‰€ä»¥æ–¹æ³•æ˜¯çº¿ç¨‹å®‰å…¨</p><ul><li><p>replace ç­‰æ–¹æ³•åº•å±‚æ˜¯æ–°å»ºä¸€ä¸ªå¯¹è±¡ï¼Œå¤åˆ¶è¿‡å»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;String,Object&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();<span class="comment">// çº¿ç¨‹ä¸å®‰å…¨</span></span><br><span class="line"><span class="type">String</span> <span class="variable">S1</span> <span class="operator">=</span> <span class="string">&quot;...&quot;</span>;<span class="comment">// çº¿ç¨‹å®‰å…¨</span></span><br><span class="line"><span class="keyword">final</span> <span class="type">String</span> <span class="variable">S2</span> <span class="operator">=</span> <span class="string">&quot;...&quot;</span>;<span class="comment">// çº¿ç¨‹å®‰å…¨</span></span><br><span class="line"><span class="type">Date</span> <span class="variable">D1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Date</span>();<span class="comment">// çº¿ç¨‹ä¸å®‰å…¨</span></span><br><span class="line"><span class="keyword">final</span> <span class="type">Date</span> <span class="variable">D2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Date</span>();<span class="comment">// çº¿ç¨‹ä¸å®‰å…¨ï¼Œfinalè®©D2å¼•ç”¨çš„å¯¹è±¡ä¸èƒ½å˜ï¼Œä½†å¯¹è±¡çš„å†…å®¹å¯ä»¥å˜</span></span><br></pre></td></tr></table></figure></li></ul><p>æŠ½è±¡æ–¹æ³•å¦‚æœæœ‰å‚æ•°ï¼Œè¢«é‡å†™åè¡Œä¸ºä¸ç¡®å®šå¯èƒ½é€ æˆçº¿ç¨‹ä¸å®‰å…¨ï¼Œè¢«ç§°ä¹‹ä¸ºå¤–æ˜Ÿæ–¹æ³•ï¼š<code>public abstract foo(Student s);</code></p><hr><h3 id="åŒæ­¥æ¨¡å¼"><a href="#åŒæ­¥æ¨¡å¼" class="headerlink" title="åŒæ­¥æ¨¡å¼"></a>åŒæ­¥æ¨¡å¼</h3><h4 id="ä¿æŠ¤æ€§æš‚åœ"><a href="#ä¿æŠ¤æ€§æš‚åœ" class="headerlink" title="ä¿æŠ¤æ€§æš‚åœ"></a>ä¿æŠ¤æ€§æš‚åœ</h4><h5 id="å•ä»»åŠ¡ç‰ˆ"><a href="#å•ä»»åŠ¡ç‰ˆ" class="headerlink" title="å•ä»»åŠ¡ç‰ˆ"></a>å•ä»»åŠ¡ç‰ˆ</h5><p>Guarded Suspensionï¼Œç”¨åœ¨ä¸€ä¸ªçº¿ç¨‹ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹çš„æ‰§è¡Œç»“æœ</p><ul><li>æœ‰ä¸€ä¸ªç»“æœéœ€è¦ä»ä¸€ä¸ªçº¿ç¨‹ä¼ é€’åˆ°å¦ä¸€ä¸ªçº¿ç¨‹ï¼Œè®©å®ƒä»¬å…³è”åŒä¸€ä¸ª GuardedObject</li><li>å¦‚æœæœ‰ç»“æœä¸æ–­ä»ä¸€ä¸ªçº¿ç¨‹åˆ°å¦ä¸€ä¸ªçº¿ç¨‹é‚£ä¹ˆå¯ä»¥ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆè§ç”Ÿäº§è€…&#x2F;æ¶ˆè´¹è€…ï¼‰</li><li>JDK ä¸­ï¼Œjoin çš„å®ç°ã€Future çš„å®ç°ï¼Œé‡‡ç”¨çš„å°±æ˜¯æ­¤æ¨¡å¼</li></ul><p><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/JUC-%E4%BF%9D%E6%8A%A4%E6%80%A7%E6%9A%82%E5%81%9C.png"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">GuardedObject</span> <span class="variable">object</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GuardedObjectV2</span>();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        object.complete(Arrays.asList(<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>));</span><br><span class="line">    &#125;).start();</span><br><span class="line">    </span><br><span class="line">    <span class="type">Object</span> <span class="variable">response</span> <span class="operator">=</span> object.get(<span class="number">2500</span>);</span><br><span class="line">    <span class="keyword">if</span> (response != <span class="literal">null</span>) &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;get response: [&#123;&#125;] lines&quot;</span>, ((List&lt;String&gt;) response).size());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;can&#x27;t get response&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">GuardedObject</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Object response;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è·å–ç»“æœ</span></span><br><span class="line">    <span class="comment">//timeout :æœ€å¤§ç­‰å¾…æ—¶é—´</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">get</span><span class="params">(<span class="type">long</span> millis)</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">            <span class="comment">// 1) è®°å½•æœ€åˆæ—¶é—´</span></span><br><span class="line">            <span class="type">long</span> <span class="variable">begin</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">            <span class="comment">// 2) å·²ç»ç»å†çš„æ—¶é—´</span></span><br><span class="line">            <span class="type">long</span> <span class="variable">timePassed</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">while</span> (response == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 4) å‡è®¾ millis æ˜¯ 1000ï¼Œç»“æœåœ¨ 400 æ—¶å”¤é†’äº†ï¼Œé‚£ä¹ˆè¿˜æœ‰ 600 è¦ç­‰</span></span><br><span class="line">                <span class="type">long</span> <span class="variable">waitTime</span> <span class="operator">=</span> millis - timePassed;</span><br><span class="line">                log.debug(<span class="string">&quot;waitTime: &#123;&#125;&quot;</span>, waitTime);</span><br><span class="line">                <span class="comment">//ç»å†æ—¶é—´è¶…è¿‡æœ€å¤§ç­‰å¾…æ—¶é—´é€€å‡ºå¾ªç¯</span></span><br><span class="line">                <span class="keyword">if</span> (waitTime &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    log.debug(<span class="string">&quot;break...&quot;</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    lock.wait(waitTime);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 3) å¦‚æœæå‰è¢«å”¤é†’ï¼Œè¿™æ—¶å·²ç»ç»å†çš„æ—¶é—´å‡è®¾ä¸º 400</span></span><br><span class="line">                timePassed = System.currentTimeMillis() - begin;</span><br><span class="line">                log.debug(<span class="string">&quot;timePassed: &#123;&#125;, object is null &#123;&#125;&quot;</span>,</span><br><span class="line">                        timePassed, response == <span class="literal">null</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> response;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//äº§ç”Ÿç»“æœ</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">complete</span><span class="params">(Object response)</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">            <span class="comment">// æ¡ä»¶æ»¡è¶³ï¼Œé€šçŸ¥ç­‰å¾…çº¿ç¨‹</span></span><br><span class="line">            <span class="built_in">this</span>.response = response;</span><br><span class="line">            log.debug(<span class="string">&quot;notify...&quot;</span>);</span><br><span class="line">            lock.notifyAll();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h5 id="å¤šä»»åŠ¡ç‰ˆ"><a href="#å¤šä»»åŠ¡ç‰ˆ" class="headerlink" title="å¤šä»»åŠ¡ç‰ˆ"></a>å¤šä»»åŠ¡ç‰ˆ</h5><p>å¤šä»»åŠ¡ç‰ˆä¿æŠ¤æ€§æš‚åœï¼š</p><p><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/JUC-%E4%BF%9D%E6%8A%A4%E6%80%A7%E6%9A%82%E5%81%9C%E5%A4%9A%E4%BB%BB%E5%8A%A1%E7%89%88.png"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">People</span>().start();</span><br><span class="line">    &#125;</span><br><span class="line">    Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">    <span class="keyword">for</span> (Integer id : Mailboxes.getIds()) &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Postman</span>(id, id + <span class="string">&quot;å·å¿«é€’åˆ°äº†&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf4j(topic = &quot;c.People&quot;)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">People</span> <span class="keyword">extends</span> <span class="title class_">Thread</span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// æ”¶ä¿¡</span></span><br><span class="line">        <span class="type">GuardedObject</span> <span class="variable">guardedObject</span> <span class="operator">=</span> Mailboxes.createGuardedObject();</span><br><span class="line">        log.debug(<span class="string">&quot;å¼€å§‹æ”¶ä¿¡i d:&#123;&#125;&quot;</span>, guardedObject.getId());</span><br><span class="line">        <span class="type">Object</span> <span class="variable">mail</span> <span class="operator">=</span> guardedObject.get(<span class="number">5000</span>);</span><br><span class="line">        log.debug(<span class="string">&quot;æ”¶åˆ°ä¿¡id:&#123;&#125;ï¼Œå†…å®¹:&#123;&#125;&quot;</span>, guardedObject.getId(),mail);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Postman</span> <span class="keyword">extends</span> <span class="title class_">Thread</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> id;</span><br><span class="line">    <span class="keyword">private</span> String mail;</span><br><span class="line">    <span class="comment">//æ„é€ æ–¹æ³•</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">GuardedObject</span> <span class="variable">guardedObject</span> <span class="operator">=</span> Mailboxes.getGuardedObject(id);</span><br><span class="line">        log.debug(<span class="string">&quot;å¼€å§‹é€ä¿¡i d:&#123;&#125;ï¼Œå†…å®¹:&#123;&#125;&quot;</span>, guardedObject.getId(),mail);</span><br><span class="line">        guardedObject.complete(mail);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span>  <span class="title class_">Mailboxes</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;Integer, GuardedObject&gt; boxes = <span class="keyword">new</span> <span class="title class_">Hashtable</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">id</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//äº§ç”Ÿå”¯ä¸€çš„id</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="type">int</span> <span class="title function_">generateId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> id++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> GuardedObject <span class="title function_">getGuardedObject</span><span class="params">(<span class="type">int</span> id)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> boxes.remove(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> GuardedObject <span class="title function_">createGuardedObject</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">GuardedObject</span> <span class="variable">go</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">GuardedObject</span>(generateId());</span><br><span class="line">        boxes.put(go.getId(), go);</span><br><span class="line">        <span class="keyword">return</span> go;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Set&lt;Integer&gt; <span class="title function_">getIds</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> boxes.keySet();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">GuardedObject</span> &#123;</span><br><span class="line">    <span class="comment">//æ ‡è¯†ï¼ŒGuarded Object</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> id;<span class="comment">//æ·»åŠ get setæ–¹æ³•</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h4 id="é¡ºåºè¾“å‡º"><a href="#é¡ºåºè¾“å‡º" class="headerlink" title="é¡ºåºè¾“å‡º"></a>é¡ºåºè¾“å‡º</h4><p>é¡ºåºè¾“å‡º 2  1 </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="comment">//try &#123; Thread.sleep(1000); &#125; catch (InterruptedException e) &#123; &#125;</span></span><br><span class="line">            <span class="comment">// å½“æ²¡æœ‰è®¸å¯æ—¶ï¼Œå½“å‰çº¿ç¨‹æš‚åœè¿è¡Œï¼›æœ‰è®¸å¯æ—¶ï¼Œç”¨æ‰è¿™ä¸ªè®¸å¯ï¼Œå½“å‰çº¿ç¨‹æ¢å¤è¿è¡Œ</span></span><br><span class="line">            LockSupport.park();</span><br><span class="line">            System.out.println(<span class="string">&quot;1&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;2&quot;</span>);</span><br><span class="line">            <span class="comment">// ç»™çº¿ç¨‹ t1 å‘æ”¾ã€è®¸å¯ã€ï¼ˆå¤šæ¬¡è¿ç»­è°ƒç”¨ unpark åªä¼šå‘æ”¾ä¸€ä¸ªã€è®¸å¯ã€ï¼‰</span></span><br><span class="line">            LockSupport.unpark(t1);</span><br><span class="line">            <span class="keyword">try</span> &#123; Thread.sleep(<span class="number">500</span>); &#125; <span class="keyword">catch</span> (InterruptedException e) &#123; &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    t1.start();</span><br><span class="line">    t2.start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h4 id="äº¤æ›¿è¾“å‡º"><a href="#äº¤æ›¿è¾“å‡º" class="headerlink" title="äº¤æ›¿è¾“å‡º"></a>äº¤æ›¿è¾“å‡º</h4><p>è¿ç»­è¾“å‡º 5 æ¬¡ abc</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">day2_14</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">AwaitSignal</span> <span class="variable">awaitSignal</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AwaitSignal</span>(<span class="number">5</span>);</span><br><span class="line">        <span class="type">Condition</span> <span class="variable">a</span> <span class="operator">=</span> awaitSignal.newCondition();</span><br><span class="line">        <span class="type">Condition</span> <span class="variable">b</span> <span class="operator">=</span> awaitSignal.newCondition();</span><br><span class="line">        <span class="type">Condition</span> <span class="variable">c</span> <span class="operator">=</span> awaitSignal.newCondition();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            awaitSignal.print(<span class="string">&quot;a&quot;</span>, a, b);</span><br><span class="line">        &#125;).start();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            awaitSignal.print(<span class="string">&quot;b&quot;</span>, b, c);</span><br><span class="line">        &#125;).start();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            awaitSignal.print(<span class="string">&quot;c&quot;</span>, c, a);</span><br><span class="line">        &#125;).start();</span><br><span class="line"></span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        awaitSignal.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            a.signal();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            awaitSignal.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AwaitSignal</span> <span class="keyword">extends</span> <span class="title class_">ReentrantLock</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> loopNumber;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">AwaitSignal</span><span class="params">(<span class="type">int</span> loopNumber)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.loopNumber = loopNumber;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//å‚æ•°1ï¼šæ‰“å°å†…å®¹  å‚æ•°äºŒï¼šæ¡ä»¶å˜é‡  å‚æ•°äºŒï¼šå”¤é†’ä¸‹ä¸€ä¸ª</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">print</span><span class="params">(String str, Condition condition, Condition next)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; loopNumber; i++) &#123;</span><br><span class="line">            lock();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                condition.await();</span><br><span class="line">                System.out.print(str);</span><br><span class="line">                next.signal();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h3 id="å¼‚æ­¥æ¨¡å¼"><a href="#å¼‚æ­¥æ¨¡å¼" class="headerlink" title="å¼‚æ­¥æ¨¡å¼"></a>å¼‚æ­¥æ¨¡å¼</h3><h4 id="ä¼ ç»Ÿç‰ˆ"><a href="#ä¼ ç»Ÿç‰ˆ" class="headerlink" title="ä¼ ç»Ÿç‰ˆ"></a>ä¼ ç»Ÿç‰ˆ</h4><p>å¼‚æ­¥æ¨¡å¼ä¹‹ç”Ÿäº§è€…&#x2F;æ¶ˆè´¹è€…ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ShareData</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">number</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">Lock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line">    <span class="keyword">private</span> <span class="type">Condition</span> <span class="variable">condition</span> <span class="operator">=</span> lock.newCondition();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">increment</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="comment">// åŒæ­¥ä»£ç å—ï¼ŒåŠ é”</span></span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// åˆ¤æ–­  é˜²æ­¢è™šå‡å”¤é†’</span></span><br><span class="line">            <span class="keyword">while</span>(number != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// ç­‰å¾…ä¸èƒ½ç”Ÿäº§</span></span><br><span class="line">                condition.await();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å¹²æ´»</span></span><br><span class="line">            number++;</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">&quot;\t &quot;</span> + number);</span><br><span class="line">            <span class="comment">// é€šçŸ¥ å”¤é†’</span></span><br><span class="line">            condition.signalAll();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">decrement</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="comment">// åŒæ­¥ä»£ç å—ï¼ŒåŠ é”</span></span><br><span class="line">        lock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// åˆ¤æ–­ é˜²æ­¢è™šå‡å”¤é†’</span></span><br><span class="line">            <span class="keyword">while</span>(number == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// ç­‰å¾…ä¸èƒ½æ¶ˆè´¹</span></span><br><span class="line">                condition.await();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å¹²æ´»</span></span><br><span class="line">            number--;</span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">&quot;\t &quot;</span> + number);</span><br><span class="line">            <span class="comment">// é€šçŸ¥ å”¤é†’</span></span><br><span class="line">            condition.signalAll();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TraditionalProducerConsumer</span> &#123;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">ShareData</span> <span class="variable">shareData</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ShareData</span>();</span><br><span class="line">        <span class="comment">// t1çº¿ç¨‹ï¼Œç”Ÿäº§</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">            shareData.increment();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;t1&quot;</span>).start();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// t2çº¿ç¨‹ï¼Œæ¶ˆè´¹</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">shareData.decrement();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">&quot;t2&quot;</span>).start(); </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="æ”¹è¿›ç‰ˆ"><a href="#æ”¹è¿›ç‰ˆ" class="headerlink" title="æ”¹è¿›ç‰ˆ"></a>æ”¹è¿›ç‰ˆ</h4><p>å¼‚æ­¥æ¨¡å¼ä¹‹ç”Ÿäº§è€…&#x2F;æ¶ˆè´¹è€…ï¼š</p><ul><li>æ¶ˆè´¹é˜Ÿåˆ—å¯ä»¥ç”¨æ¥å¹³è¡¡ç”Ÿäº§å’Œæ¶ˆè´¹çš„çº¿ç¨‹èµ„æºï¼Œä¸éœ€è¦äº§ç”Ÿç»“æœå’Œæ¶ˆè´¹ç»“æœçš„çº¿ç¨‹ä¸€ä¸€å¯¹åº”</li><li>ç”Ÿäº§è€…ä»…è´Ÿè´£äº§ç”Ÿç»“æœæ•°æ®ï¼Œä¸å…³å¿ƒæ•°æ®è¯¥å¦‚ä½•å¤„ç†ï¼Œè€Œæ¶ˆè´¹è€…ä¸“å¿ƒå¤„ç†ç»“æœæ•°æ®</li><li>æ¶ˆæ¯é˜Ÿåˆ—æ˜¯æœ‰å®¹é‡é™åˆ¶çš„ï¼Œæ»¡æ—¶ä¸ä¼šå†åŠ å…¥æ•°æ®ï¼Œç©ºæ—¶ä¸ä¼šå†æ¶ˆè€—æ•°æ®</li><li>JDK ä¸­å„ç§é˜»å¡é˜Ÿåˆ—ï¼Œé‡‡ç”¨çš„å°±æ˜¯è¿™ç§æ¨¡å¼</li></ul><p><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/JUC-%E7%94%9F%E4%BA%A7%E8%80%85%E6%B6%88%E8%B4%B9%E8%80%85%E6%A8%A1%E5%BC%8F.png"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">demo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">MessageQueue</span> <span class="variable">queue</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MessageQueue</span>(<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">id</span> <span class="operator">=</span> i;</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">                queue.put(<span class="keyword">new</span> <span class="title class_">Message</span>(id,<span class="string">&quot;å€¼&quot;</span>+id));</span><br><span class="line">            &#125;, <span class="string">&quot;ç”Ÿäº§è€…&quot;</span> + i).start();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                    <span class="type">Message</span> <span class="variable">message</span> <span class="operator">=</span> queue.take();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,<span class="string">&quot;æ¶ˆè´¹è€…&quot;</span>).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æ¶ˆæ¯é˜Ÿåˆ—ç±»ï¼ŒJavaé—´çº¿ç¨‹ä¹‹é—´é€šä¿¡</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MessageQueue</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> LinkedList&lt;Message&gt; list = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();<span class="comment">//æ¶ˆæ¯çš„é˜Ÿåˆ—é›†åˆ</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> capacity;<span class="comment">//é˜Ÿåˆ—å®¹é‡</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MessageQueue</span><span class="params">(<span class="type">int</span> capacity)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.capacity = capacity;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//è·å–æ¶ˆæ¯</span></span><br><span class="line">    <span class="keyword">public</span> Message <span class="title function_">take</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//æ£€æŸ¥é˜Ÿåˆ—æ˜¯å¦ä¸ºç©º</span></span><br><span class="line">        <span class="keyword">synchronized</span> (list) &#123;</span><br><span class="line">            <span class="keyword">while</span> (list.isEmpty()) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    sout(Thread.currentThread().getName() + <span class="string">&quot;:é˜Ÿåˆ—ä¸ºç©ºï¼Œæ¶ˆè´¹è€…çº¿ç¨‹ç­‰å¾…&quot;</span>);</span><br><span class="line">                    list.wait();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//ä»é˜Ÿåˆ—çš„å¤´éƒ¨è·å–æ¶ˆæ¯è¿”å›</span></span><br><span class="line">            <span class="type">Message</span> <span class="variable">message</span> <span class="operator">=</span> list.removeFirst();</span><br><span class="line">            sout(Thread.currentThread().getName() + <span class="string">&quot;ï¼šå·²æ¶ˆè´¹æ¶ˆæ¯--&quot;</span> + message);</span><br><span class="line">            list.notifyAll();</span><br><span class="line">            <span class="keyword">return</span> message;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å­˜å…¥æ¶ˆæ¯</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">put</span><span class="params">(Message message)</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (list) &#123;</span><br><span class="line">            <span class="comment">//æ£€æŸ¥é˜Ÿåˆ—æ˜¯å¦æ»¡</span></span><br><span class="line">            <span class="keyword">while</span> (list.size() == capacity) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    sout(Thread.currentThread().getName()+<span class="string">&quot;:é˜Ÿåˆ—ä¸ºå·²æ»¡ï¼Œç”Ÿäº§è€…çº¿ç¨‹ç­‰å¾…&quot;</span>);</span><br><span class="line">                    list.wait();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//å°†æ¶ˆæ¯åŠ å…¥é˜Ÿåˆ—å°¾éƒ¨</span></span><br><span class="line">            list.addLast(message);</span><br><span class="line">            sout(Thread.currentThread().getName() + <span class="string">&quot;:å·²ç”Ÿäº§æ¶ˆæ¯--&quot;</span> + message);</span><br><span class="line">            list.notifyAll();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Message</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> id;</span><br><span class="line">    <span class="keyword">private</span> Object value;</span><br><span class="line"><span class="comment">//get set</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h4 id="é˜»å¡é˜Ÿåˆ—"><a href="#é˜»å¡é˜Ÿåˆ—" class="headerlink" title="é˜»å¡é˜Ÿåˆ—"></a>é˜»å¡é˜Ÿåˆ—</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">ExecutorService</span> <span class="variable">consumer</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">1</span>);</span><br><span class="line">    <span class="type">ExecutorService</span> <span class="variable">producer</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">1</span>);</span><br><span class="line">    BlockingQueue&lt;Integer&gt; queue = <span class="keyword">new</span> <span class="title class_">SynchronousQueue</span>&lt;&gt;();</span><br><span class="line">    producer.submit(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;ç”Ÿäº§...&quot;</span>);</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">            queue.put(<span class="number">10</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    consumer.submit(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;ç­‰å¾…æ¶ˆè´¹...&quot;</span>);</span><br><span class="line">            <span class="type">Integer</span> <span class="variable">result</span> <span class="operator">=</span> queue.take();</span><br><span class="line">            System.out.println(<span class="string">&quot;ç»“æœä¸º:&quot;</span> + result);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h2 id="å†…å­˜"><a href="#å†…å­˜" class="headerlink" title="å†…å­˜"></a>å†…å­˜</h2><h3 id="JMM"><a href="#JMM" class="headerlink" title="JMM"></a>JMM</h3><h4 id="å†…å­˜æ¨¡å‹"><a href="#å†…å­˜æ¨¡å‹" class="headerlink" title="å†…å­˜æ¨¡å‹"></a>å†…å­˜æ¨¡å‹</h4><p>Java å†…å­˜æ¨¡å‹æ˜¯ Java Memory Modelï¼ˆJMMï¼‰ï¼Œæœ¬èº«æ˜¯ä¸€ç§<strong>æŠ½è±¡çš„æ¦‚å¿µ</strong>ï¼Œå®é™…ä¸Šå¹¶ä¸å­˜åœ¨ï¼Œæè¿°çš„æ˜¯ä¸€ç»„è§„åˆ™æˆ–è§„èŒƒï¼Œé€šè¿‡è¿™ç»„è§„èŒƒå®šä¹‰äº†ç¨‹åºä¸­å„ä¸ªå˜é‡ï¼ˆåŒ…æ‹¬å®ä¾‹å­—æ®µï¼Œé™æ€å­—æ®µå’Œæ„æˆæ•°ç»„å¯¹è±¡çš„å…ƒç´ ï¼‰çš„è®¿é—®æ–¹å¼</p><p>JMM ä½œç”¨ï¼š</p><ul><li>å±è”½å„ç§ç¡¬ä»¶å’Œæ“ä½œç³»ç»Ÿçš„å†…å­˜è®¿é—®å·®å¼‚ï¼Œå®ç°è®© Java ç¨‹åºåœ¨å„ç§å¹³å°ä¸‹éƒ½èƒ½è¾¾åˆ°ä¸€è‡´çš„å†…å­˜è®¿é—®æ•ˆæœ</li><li>è§„å®šäº†çº¿ç¨‹å’Œå†…å­˜ä¹‹é—´çš„ä¸€äº›å…³ç³»</li></ul><p>æ ¹æ® JMM çš„è®¾è®¡ï¼Œç³»ç»Ÿå­˜åœ¨ä¸€ä¸ªä¸»å†…å­˜ï¼ˆMain Memoryï¼‰ï¼ŒJava ä¸­æ‰€æœ‰å˜é‡éƒ½å­˜å‚¨åœ¨ä¸»å­˜ä¸­ï¼Œå¯¹äºæ‰€æœ‰çº¿ç¨‹éƒ½æ˜¯å…±äº«çš„ï¼›æ¯æ¡çº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„å·¥ä½œå†…å­˜ï¼ˆWorking Memoryï¼‰ï¼Œå·¥ä½œå†…å­˜ä¸­ä¿å­˜çš„æ˜¯ä¸»å­˜ä¸­æŸäº›<strong>å˜é‡çš„æ‹·è´</strong>ï¼Œçº¿ç¨‹å¯¹æ‰€æœ‰å˜é‡çš„æ“ä½œéƒ½æ˜¯å…ˆå¯¹å˜é‡è¿›è¡Œæ‹·è´ï¼Œç„¶ååœ¨å·¥ä½œå†…å­˜ä¸­è¿›è¡Œï¼Œä¸èƒ½ç›´æ¥æ“ä½œä¸»å†…å­˜ä¸­çš„å˜é‡ï¼›çº¿ç¨‹ä¹‹é—´æ— æ³•ç›¸äº’ç›´æ¥è®¿é—®ï¼Œçº¿ç¨‹é—´çš„é€šä¿¡ï¼ˆä¼ é€’ï¼‰å¿…é¡»é€šè¿‡ä¸»å†…å­˜æ¥å®Œæˆ</p><p><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/JMM%E5%86%85%E5%AD%98%E6%A8%A1%E5%9E%8B.png"></p><p>ä¸»å†…å­˜å’Œå·¥ä½œå†…å­˜ï¼š</p><ul><li>ä¸»å†…å­˜ï¼šè®¡ç®—æœºçš„å†…å­˜ï¼Œä¹Ÿå°±æ˜¯ç»å¸¸æåˆ°çš„ 8G å†…å­˜ï¼Œ16G å†…å­˜ï¼Œå­˜å‚¨æ‰€æœ‰å…±äº«å˜é‡çš„å€¼</li><li>å·¥ä½œå†…å­˜ï¼šå­˜å‚¨è¯¥çº¿ç¨‹ä½¿ç”¨åˆ°çš„å…±äº«å˜é‡åœ¨ä¸»å†…å­˜çš„çš„å€¼çš„å‰¯æœ¬æ‹·è´</li></ul><p><strong>JVM å’Œ JMM ä¹‹é—´çš„å…³ç³»</strong>ï¼šJMM ä¸­çš„ä¸»å†…å­˜ã€å·¥ä½œå†…å­˜ä¸ JVM ä¸­çš„ Java å †ã€æ ˆã€æ–¹æ³•åŒºç­‰å¹¶ä¸æ˜¯åŒä¸€ä¸ªå±‚æ¬¡çš„å†…å­˜åˆ’åˆ†ï¼Œè¿™ä¸¤è€…åŸºæœ¬ä¸Šæ˜¯æ²¡æœ‰å…³ç³»çš„ï¼Œå¦‚æœä¸¤è€…ä¸€å®šè¦å‹‰å¼ºå¯¹åº”èµ·æ¥ï¼š</p><ul><li>ä¸»å†…å­˜ä¸»è¦å¯¹åº”äº Java å †ä¸­çš„å¯¹è±¡å®ä¾‹æ•°æ®éƒ¨åˆ†ï¼Œè€Œå·¥ä½œå†…å­˜åˆ™å¯¹åº”äºè™šæ‹Ÿæœºæ ˆä¸­çš„éƒ¨åˆ†åŒºåŸŸ</li><li>ä»æ›´ä½å±‚æ¬¡ä¸Šè¯´ï¼Œä¸»å†…å­˜ç›´æ¥å¯¹åº”äºç‰©ç†ç¡¬ä»¶çš„å†…å­˜ï¼Œå·¥ä½œå†…å­˜å¯¹åº”å¯„å­˜å™¨å’Œé«˜é€Ÿç¼“å­˜</li></ul><hr><h4 id="å†…å­˜äº¤äº’"><a href="#å†…å­˜äº¤äº’" class="headerlink" title="å†…å­˜äº¤äº’"></a>å†…å­˜äº¤äº’</h4><p>Java å†…å­˜æ¨¡å‹å®šä¹‰äº† 8 ä¸ªæ“ä½œæ¥å®Œæˆä¸»å†…å­˜å’Œå·¥ä½œå†…å­˜çš„äº¤äº’æ“ä½œï¼Œæ¯ä¸ªæ“ä½œéƒ½æ˜¯<strong>åŸå­</strong>çš„</p><p>éåŸå­åå®šï¼šæ²¡æœ‰è¢« volatile ä¿®é¥°çš„ longã€double å¤–ï¼Œé»˜è®¤æŒ‰ç…§ä¸¤æ¬¡ 32 ä½çš„æ“ä½œ</p><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/JMM-å†…å­˜äº¤äº’.png" style="zoom: 67%;" /><ul><li>lockï¼šä½œç”¨äºä¸»å†…å­˜ï¼Œå°†ä¸€ä¸ªå˜é‡æ ‡è¯†ä¸ºè¢«ä¸€ä¸ªçº¿ç¨‹ç‹¬å çŠ¶æ€ï¼ˆå¯¹åº” monitorenterï¼‰</li><li>unclockï¼šä½œç”¨äºä¸»å†…å­˜ï¼Œå°†ä¸€ä¸ªå˜é‡ä»ç‹¬å çŠ¶æ€é‡Šæ”¾å‡ºæ¥ï¼Œé‡Šæ”¾åçš„å˜é‡æ‰å¯ä»¥è¢«å…¶ä»–çº¿ç¨‹é”å®šï¼ˆå¯¹åº” monitorexitï¼‰</li><li>readï¼šä½œç”¨äºä¸»å†…å­˜ï¼ŒæŠŠä¸€ä¸ªå˜é‡çš„å€¼ä»ä¸»å†…å­˜ä¼ è¾“åˆ°å·¥ä½œå†…å­˜ä¸­</li><li>loadï¼šä½œç”¨äºå·¥ä½œå†…å­˜ï¼Œåœ¨ read ä¹‹åæ‰§è¡Œï¼ŒæŠŠ read å¾—åˆ°çš„å€¼æ”¾å…¥å·¥ä½œå†…å­˜çš„å˜é‡å‰¯æœ¬ä¸­</li><li>useï¼šä½œç”¨äºå·¥ä½œå†…å­˜ï¼ŒæŠŠå·¥ä½œå†…å­˜ä¸­ä¸€ä¸ªå˜é‡çš„å€¼ä¼ é€’ç»™<strong>æ‰§è¡Œå¼•æ“</strong>ï¼Œæ¯å½“é‡åˆ°ä¸€ä¸ªä½¿ç”¨åˆ°å˜é‡çš„æ“ä½œæ—¶éƒ½è¦ä½¿ç”¨è¯¥æŒ‡ä»¤</li><li>assignï¼šä½œç”¨äºå·¥ä½œå†…å­˜ï¼ŒæŠŠä»æ‰§è¡Œå¼•æ“æ¥æ”¶åˆ°çš„ä¸€ä¸ªå€¼èµ‹ç»™å·¥ä½œå†…å­˜çš„å˜é‡</li><li>storeï¼šä½œç”¨äºå·¥ä½œå†…å­˜ï¼ŒæŠŠå·¥ä½œå†…å­˜çš„ä¸€ä¸ªå˜é‡çš„å€¼ä¼ é€åˆ°ä¸»å†…å­˜ä¸­</li><li>writeï¼šä½œç”¨äºä¸»å†…å­˜ï¼Œåœ¨ store ä¹‹åæ‰§è¡Œï¼ŒæŠŠ store å¾—åˆ°çš„å€¼æ”¾å…¥ä¸»å†…å­˜çš„å˜é‡ä¸­</li></ul><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://github.com/CyC2018/CS-Notes/blob/master/notes/Java%20%E5%B9%B6%E5%8F%91.md">https://github.com/CyC2018/CS-Notes/blob/master/notes/Java%20%E5%B9%B6%E5%8F%91.md</a></p><hr><h4 id="ä¸‰å¤§ç‰¹æ€§"><a href="#ä¸‰å¤§ç‰¹æ€§" class="headerlink" title="ä¸‰å¤§ç‰¹æ€§"></a>ä¸‰å¤§ç‰¹æ€§</h4><h5 id="å¯è§æ€§"><a href="#å¯è§æ€§" class="headerlink" title="å¯è§æ€§"></a>å¯è§æ€§</h5><p>å¯è§æ€§ï¼šæ˜¯æŒ‡å½“å¤šä¸ªçº¿ç¨‹è®¿é—®åŒä¸€ä¸ªå˜é‡æ—¶ï¼Œä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†è¿™ä¸ªå˜é‡çš„å€¼ï¼Œå…¶ä»–çº¿ç¨‹èƒ½å¤Ÿç«‹å³çœ‹å¾—åˆ°ä¿®æ”¹çš„å€¼</p><p>å­˜åœ¨ä¸å¯è§é—®é¢˜çš„æ ¹æœ¬åŸå› æ˜¯ç”±äºç¼“å­˜çš„å­˜åœ¨ï¼Œçº¿ç¨‹æŒæœ‰çš„æ˜¯å…±äº«å˜é‡çš„å‰¯æœ¬ï¼Œæ— æ³•æ„ŸçŸ¥å…¶ä»–çº¿ç¨‹å¯¹äºå…±äº«å˜é‡çš„æ›´æ”¹ï¼Œå¯¼è‡´è¯»å–çš„å€¼ä¸æ˜¯æœ€æ–°çš„ã€‚ä½†æ˜¯ final ä¿®é¥°çš„å˜é‡æ˜¯<strong>ä¸å¯å˜</strong>çš„ï¼Œå°±ç®—æœ‰ç¼“å­˜ï¼Œä¹Ÿä¸ä¼šå­˜åœ¨ä¸å¯è§çš„é—®é¢˜</p><p>main çº¿ç¨‹å¯¹ run å˜é‡çš„ä¿®æ”¹å¯¹äº t çº¿ç¨‹ä¸å¯è§ï¼Œå¯¼è‡´äº† t çº¿ç¨‹æ— æ³•åœæ­¢ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="type">boolean</span> <span class="variable">run</span> <span class="operator">=</span> <span class="literal">true</span>;<span class="comment">//æ·»åŠ volatile</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123;</span><br><span class="line">        <span class="keyword">while</span>(run)&#123;</span><br><span class="line">        <span class="comment">// ....</span></span><br><span class="line">        &#125;</span><br><span class="line">&#125;);</span><br><span class="line">    t.start();</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    run = <span class="literal">false</span>; <span class="comment">// çº¿ç¨‹tä¸ä¼šå¦‚é¢„æƒ³çš„åœä¸‹æ¥</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŸå› ï¼š</p><ul><li>åˆå§‹çŠ¶æ€ï¼Œ t çº¿ç¨‹åˆšå¼€å§‹ä»ä¸»å†…å­˜è¯»å–äº† run çš„å€¼åˆ°å·¥ä½œå†…å­˜</li><li>å› ä¸º t çº¿ç¨‹è¦é¢‘ç¹ä»ä¸»å†…å­˜ä¸­è¯»å– run çš„å€¼ï¼ŒJIT ç¼–è¯‘å™¨ä¼šå°† run çš„å€¼ç¼“å­˜è‡³è‡ªå·±å·¥ä½œå†…å­˜ä¸­çš„é«˜é€Ÿç¼“å­˜ä¸­ï¼Œå‡å°‘å¯¹ä¸»å­˜ä¸­ run çš„è®¿é—®ï¼Œæé«˜æ•ˆç‡</li><li>1 ç§’ä¹‹åï¼Œmain çº¿ç¨‹ä¿®æ”¹äº† run çš„å€¼ï¼Œå¹¶åŒæ­¥è‡³ä¸»å­˜ï¼Œè€Œ t æ˜¯ä»è‡ªå·±å·¥ä½œå†…å­˜ä¸­çš„é«˜é€Ÿç¼“å­˜ä¸­è¯»å–è¿™ä¸ªå˜é‡çš„å€¼ï¼Œç»“æœæ°¸è¿œæ˜¯æ—§å€¼</li></ul><p><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/JMM-%E5%8F%AF%E8%A7%81%E6%80%A7%E4%BE%8B%E5%AD%90.png"></p><hr><h5 id="åŸå­æ€§"><a href="#åŸå­æ€§" class="headerlink" title="åŸå­æ€§"></a>åŸå­æ€§</h5><p>åŸå­æ€§ï¼šä¸å¯åˆ†å‰²ï¼Œå®Œæ•´æ€§ï¼Œä¹Ÿå°±æ˜¯è¯´æŸä¸ªçº¿ç¨‹æ­£åœ¨åšæŸä¸ªå…·ä½“ä¸šåŠ¡æ—¶ï¼Œä¸­é—´ä¸å¯ä»¥è¢«åˆ†å‰²ï¼Œéœ€è¦å…·ä½“å®Œæˆï¼Œè¦ä¹ˆåŒæ—¶æˆåŠŸï¼Œè¦ä¹ˆåŒæ—¶å¤±è´¥ï¼Œä¿è¯æŒ‡ä»¤ä¸ä¼šå—åˆ°çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢çš„å½±å“ </p><p>å®šä¹‰åŸå­æ“ä½œçš„ä½¿ç”¨è§„åˆ™ï¼š</p><ol><li>ä¸å…è®¸ read å’Œ loadã€store å’Œ write æ“ä½œä¹‹ä¸€å•ç‹¬å‡ºç°ï¼Œå¿…é¡»é¡ºåºæ‰§è¡Œï¼Œä½†æ˜¯ä¸è¦æ±‚è¿ç»­</li><li>ä¸å…è®¸ä¸€ä¸ªçº¿ç¨‹ä¸¢å¼ƒ assign æ“ä½œï¼Œå¿…é¡»åŒæ­¥å›ä¸»å­˜</li><li>ä¸å…è®¸ä¸€ä¸ªçº¿ç¨‹æ— åŸå› åœ°ï¼ˆæ²¡æœ‰å‘ç”Ÿè¿‡ä»»ä½• assign æ“ä½œï¼‰æŠŠæ•°æ®ä»å·¥ä½œå†…å­˜åŒæ­¥ä¼šä¸»å†…å­˜ä¸­</li><li>ä¸€ä¸ªæ–°çš„å˜é‡åªèƒ½åœ¨ä¸»å†…å­˜ä¸­è¯ç”Ÿï¼Œä¸å…è®¸åœ¨å·¥ä½œå†…å­˜ä¸­ç›´æ¥ä½¿ç”¨ä¸€ä¸ªæœªè¢«åˆå§‹åŒ–ï¼ˆassign æˆ–è€… loadï¼‰çš„å˜é‡ï¼Œå³å¯¹ä¸€ä¸ªå˜é‡å®æ–½ use å’Œ store æ“ä½œä¹‹å‰ï¼Œå¿…é¡»å…ˆè‡ªè¡Œ assign å’Œ load æ“ä½œ</li><li>ä¸€ä¸ªå˜é‡åœ¨åŒä¸€æ—¶åˆ»åªå…è®¸ä¸€æ¡çº¿ç¨‹å¯¹å…¶è¿›è¡Œ lock æ“ä½œï¼Œä½† lock æ“ä½œå¯ä»¥è¢«åŒä¸€çº¿ç¨‹é‡å¤æ‰§è¡Œå¤šæ¬¡ï¼Œå¤šæ¬¡æ‰§è¡Œ lock åï¼Œåªæœ‰<strong>æ‰§è¡Œç›¸åŒæ¬¡æ•°çš„ unlock</strong> æ“ä½œï¼Œå˜é‡æ‰ä¼šè¢«è§£é”ï¼Œ<strong>lock å’Œ unlock å¿…é¡»æˆå¯¹å‡ºç°</strong></li><li>å¦‚æœå¯¹ä¸€ä¸ªå˜é‡æ‰§è¡Œ lock æ“ä½œï¼Œå°†ä¼š<strong>æ¸…ç©ºå·¥ä½œå†…å­˜ä¸­æ­¤å˜é‡çš„å€¼</strong>ï¼Œåœ¨æ‰§è¡Œå¼•æ“ä½¿ç”¨è¿™ä¸ªå˜é‡ä¹‹å‰éœ€è¦é‡æ–°ä»ä¸»å­˜åŠ è½½</li><li>å¦‚æœä¸€ä¸ªå˜é‡äº‹å…ˆæ²¡æœ‰è¢« lock æ“ä½œé”å®šï¼Œåˆ™ä¸å…è®¸æ‰§è¡Œ unlock æ“ä½œï¼Œä¹Ÿä¸å…è®¸å» unlock ä¸€ä¸ªè¢«å…¶ä»–çº¿ç¨‹é”å®šçš„å˜é‡</li><li>å¯¹ä¸€ä¸ªå˜é‡æ‰§è¡Œ unlock æ“ä½œä¹‹å‰ï¼Œå¿…é¡»<strong>å…ˆæŠŠæ­¤å˜é‡åŒæ­¥åˆ°ä¸»å†…å­˜</strong>ä¸­ï¼ˆæ‰§è¡Œ store å’Œ write æ“ä½œï¼‰</li></ol><hr><h5 id="æœ‰åºæ€§"><a href="#æœ‰åºæ€§" class="headerlink" title="æœ‰åºæ€§"></a>æœ‰åºæ€§</h5><p>æœ‰åºæ€§ï¼šåœ¨æœ¬çº¿ç¨‹å†…è§‚å¯Ÿï¼Œæ‰€æœ‰æ“ä½œéƒ½æ˜¯æœ‰åºçš„ï¼›åœ¨ä¸€ä¸ªçº¿ç¨‹è§‚å¯Ÿå¦ä¸€ä¸ªçº¿ç¨‹ï¼Œæ‰€æœ‰æ“ä½œéƒ½æ˜¯æ— åºçš„ï¼Œæ— åºæ˜¯å› ä¸ºå‘ç”Ÿäº†æŒ‡ä»¤é‡æ’åº</p><p>CPU çš„åŸºæœ¬å·¥ä½œæ˜¯æ‰§è¡Œå­˜å‚¨çš„æŒ‡ä»¤åºåˆ—ï¼Œå³ç¨‹åºï¼Œç¨‹åºçš„æ‰§è¡Œè¿‡ç¨‹å®é™…ä¸Šæ˜¯ä¸æ–­åœ°å–å‡ºæŒ‡ä»¤ã€åˆ†ææŒ‡ä»¤ã€æ‰§è¡ŒæŒ‡ä»¤çš„è¿‡ç¨‹ï¼Œä¸ºäº†æé«˜æ€§èƒ½ï¼Œç¼–è¯‘å™¨å’Œå¤„ç†å™¨ä¼šå¯¹æŒ‡ä»¤é‡æ’ï¼Œä¸€èˆ¬åˆ†ä¸ºä»¥ä¸‹ä¸‰ç§ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">æºä»£ç  -&gt; ç¼–è¯‘å™¨ä¼˜åŒ–çš„é‡æ’ -&gt; æŒ‡ä»¤å¹¶è¡Œçš„é‡æ’ -&gt; å†…å­˜ç³»ç»Ÿçš„é‡æ’ -&gt; æœ€ç»ˆæ‰§è¡ŒæŒ‡ä»¤</span><br></pre></td></tr></table></figure><p>ç°ä»£ CPU æ”¯æŒå¤šçº§æŒ‡ä»¤æµæ°´çº¿ï¼Œå‡ ä¹æ‰€æœ‰çš„å†¯â€¢è¯ºä¼Šæ›¼å‹è®¡ç®—æœºçš„ CPUï¼Œå…¶å·¥ä½œéƒ½å¯ä»¥åˆ†ä¸º 5 ä¸ªé˜¶æ®µï¼šå–æŒ‡ä»¤ã€æŒ‡ä»¤è¯‘ç ã€æ‰§è¡ŒæŒ‡ä»¤ã€è®¿å­˜å–æ•°å’Œç»“æœå†™å›ï¼Œå¯ä»¥ç§°ä¹‹ä¸º<strong>äº”çº§æŒ‡ä»¤æµæ°´çº¿</strong>ã€‚CPU å¯ä»¥åœ¨ä¸€ä¸ªæ—¶é’Ÿå‘¨æœŸå†…ï¼ŒåŒæ—¶è¿è¡Œäº”æ¡æŒ‡ä»¤çš„<strong>ä¸åŒé˜¶æ®µ</strong>ï¼ˆæ¯ä¸ªçº¿ç¨‹ä¸åŒçš„é˜¶æ®µï¼‰ï¼Œæœ¬è´¨ä¸Šæµæ°´çº¿æŠ€æœ¯å¹¶ä¸èƒ½ç¼©çŸ­å•æ¡æŒ‡ä»¤çš„æ‰§è¡Œæ—¶é—´ï¼Œä½†å˜ç›¸åœ°æé«˜äº†æŒ‡ä»¤åœ°ååç‡</p><p>å¤„ç†å™¨åœ¨è¿›è¡Œé‡æ’åºæ—¶ï¼Œå¿…é¡»è¦è€ƒè™‘<strong>æŒ‡ä»¤ä¹‹é—´çš„æ•°æ®ä¾èµ–æ€§</strong></p><ul><li>å•çº¿ç¨‹ç¯å¢ƒä¹Ÿå­˜åœ¨æŒ‡ä»¤é‡æ’ï¼Œç”±äºå­˜åœ¨ä¾èµ–æ€§ï¼Œæœ€ç»ˆæ‰§è¡Œç»“æœå’Œä»£ç é¡ºåºçš„ç»“æœä¸€è‡´</li><li>å¤šçº¿ç¨‹ç¯å¢ƒä¸­çº¿ç¨‹äº¤æ›¿æ‰§è¡Œï¼Œç”±äºç¼–è¯‘å™¨ä¼˜åŒ–é‡æ’ï¼Œä¼šè·å–å…¶ä»–çº¿ç¨‹å¤„åœ¨ä¸åŒé˜¶æ®µçš„æŒ‡ä»¤åŒæ—¶æ‰§è¡Œ</li></ul><p>è¡¥å……çŸ¥è¯†ï¼š</p><ul><li>æŒ‡ä»¤å‘¨æœŸæ˜¯å–å‡ºä¸€æ¡æŒ‡ä»¤å¹¶æ‰§è¡Œè¿™æ¡æŒ‡ä»¤çš„æ—¶é—´ï¼Œä¸€èˆ¬ç”±è‹¥å¹²ä¸ªæœºå™¨å‘¨æœŸç»„æˆ</li><li>æœºå™¨å‘¨æœŸä¹Ÿç§°ä¸º CPU å‘¨æœŸï¼Œä¸€æ¡æŒ‡ä»¤çš„æ‰§è¡Œè¿‡ç¨‹åˆ’åˆ†ä¸ºè‹¥å¹²ä¸ªé˜¶æ®µï¼ˆå¦‚å–æŒ‡ã€è¯‘ç ã€æ‰§è¡Œç­‰ï¼‰ï¼Œæ¯ä¸€é˜¶æ®µå®Œæˆä¸€ä¸ªåŸºæœ¬æ“ä½œï¼Œå®Œæˆä¸€ä¸ªåŸºæœ¬æ“ä½œæ‰€éœ€è¦çš„æ—¶é—´ç§°ä¸ºæœºå™¨å‘¨æœŸ</li><li>æŒ¯è¡å‘¨æœŸæŒ‡å‘¨æœŸæ€§ä¿¡å·ä½œå‘¨æœŸæ€§é‡å¤å˜åŒ–çš„æ—¶é—´é—´éš”</li></ul><hr><h3 id="cache"><a href="#cache" class="headerlink" title="cache"></a>cache</h3><h4 id="ç¼“å­˜æœºåˆ¶"><a href="#ç¼“å­˜æœºåˆ¶" class="headerlink" title="ç¼“å­˜æœºåˆ¶"></a>ç¼“å­˜æœºåˆ¶</h4><h5 id="ç¼“å­˜ç»“æ„"><a href="#ç¼“å­˜ç»“æ„" class="headerlink" title="ç¼“å­˜ç»“æ„"></a>ç¼“å­˜ç»“æ„</h5><p>åœ¨è®¡ç®—æœºç³»ç»Ÿä¸­ï¼ŒCPU é«˜é€Ÿç¼“å­˜ï¼ˆCPU Cacheï¼Œç®€ç§°ç¼“å­˜ï¼‰æ˜¯ç”¨äºå‡å°‘å¤„ç†å™¨è®¿é—®å†…å­˜æ‰€éœ€å¹³å‡æ—¶é—´çš„éƒ¨ä»¶ï¼›åœ¨å­˜å‚¨ä½“ç³»ä¸­ä½äºè‡ªé¡¶å‘ä¸‹çš„ç¬¬äºŒå±‚ï¼Œä»…æ¬¡äº CPU å¯„å­˜å™¨ï¼›å…¶å®¹é‡è¿œå°äºå†…å­˜ï¼Œä½†é€Ÿåº¦å´å¯ä»¥æ¥è¿‘å¤„ç†å™¨çš„é¢‘ç‡</p><p>CPU å¤„ç†å™¨é€Ÿåº¦è¿œè¿œå¤§äºåœ¨ä¸»å†…å­˜ä¸­çš„ï¼Œä¸ºäº†è§£å†³é€Ÿåº¦å·®å¼‚ï¼Œåœ¨å®ƒä»¬ä¹‹é—´æ¶è®¾äº†å¤šçº§ç¼“å­˜ï¼Œå¦‚ L1ã€L2ã€L3 çº§åˆ«çš„ç¼“å­˜ï¼Œè¿™äº›ç¼“å­˜ç¦» CPU è¶Šè¿‘å°±è¶Šå¿«ï¼Œå°†é¢‘ç¹æ“ä½œçš„æ•°æ®ç¼“å­˜åˆ°è¿™é‡Œï¼ŒåŠ å¿«è®¿é—®é€Ÿåº¦</p><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/JMM-CPUç¼“å­˜ç»“æ„.png" style="zoom: 50%;" /><table><thead><tr><th>ä» CPU åˆ°</th><th>å¤§çº¦éœ€è¦çš„æ—¶é’Ÿå‘¨æœŸ</th></tr></thead><tbody><tr><td>å¯„å­˜å™¨</td><td>1 cycle (4GHz çš„ CPU çº¦ä¸º 0.25ns)</td></tr><tr><td>L1</td><td>3~4 cycle</td></tr><tr><td>L2</td><td>10~20 cycle</td></tr><tr><td>L3</td><td>40~45 cycle</td></tr><tr><td>å†…å­˜</td><td>120~240 cycle</td></tr></tbody></table><h5 id="ç¼“å­˜ä½¿ç”¨"><a href="#ç¼“å­˜ä½¿ç”¨" class="headerlink" title="ç¼“å­˜ä½¿ç”¨"></a>ç¼“å­˜ä½¿ç”¨</h5><p>å½“å¤„ç†å™¨å‘å‡ºå†…å­˜è®¿é—®è¯·æ±‚æ—¶ï¼Œä¼šå…ˆæŸ¥çœ‹ç¼“å­˜å†…æ˜¯å¦æœ‰è¯·æ±‚æ•°æ®ï¼Œå¦‚æœå­˜åœ¨ï¼ˆå‘½ä¸­ï¼‰ï¼Œåˆ™ä¸ç”¨è®¿é—®å†…å­˜ç›´æ¥è¿”å›è¯¥æ•°æ®ï¼›å¦‚æœä¸å­˜åœ¨ï¼ˆå¤±æ•ˆï¼‰ï¼Œåˆ™è¦å…ˆæŠŠå†…å­˜ä¸­çš„ç›¸åº”æ•°æ®è½½å…¥ç¼“å­˜ï¼Œå†å°†å…¶è¿”å›å¤„ç†å™¨</p><p>ç¼“å­˜ä¹‹æ‰€ä»¥æœ‰æ•ˆï¼Œä¸»è¦å› ä¸ºç¨‹åºè¿è¡Œæ—¶å¯¹å†…å­˜çš„è®¿é—®å‘ˆç°å±€éƒ¨æ€§ï¼ˆLocalityï¼‰ç‰¹å¾ã€‚æ—¢åŒ…æ‹¬ç©ºé—´å±€éƒ¨æ€§ï¼ˆSpatial Localityï¼‰ï¼Œä¹ŸåŒ…æ‹¬æ—¶é—´å±€éƒ¨æ€§ï¼ˆTemporal Localityï¼‰ï¼Œæœ‰æ•ˆåˆ©ç”¨è¿™ç§å±€éƒ¨æ€§ï¼Œç¼“å­˜å¯ä»¥è¾¾åˆ°æé«˜çš„å‘½ä¸­ç‡</p><hr><h4 id="ä¼ªå…±äº«"><a href="#ä¼ªå…±äº«" class="headerlink" title="ä¼ªå…±äº«"></a>ä¼ªå…±äº«</h4><p><strong>ç¼“å­˜ä»¥ç¼“å­˜è¡Œ cache line ä¸ºå•ä½</strong>ï¼Œæ¯ä¸ªç¼“å­˜è¡Œå¯¹åº”ç€ä¸€å—å†…å­˜ï¼Œä¸€èˆ¬æ˜¯ 64 byteï¼ˆ8 ä¸ª longï¼‰ï¼Œåœ¨ CPU ä»ä¸»å­˜è·å–æ•°æ®æ—¶ï¼Œä»¥ cache line ä¸ºå•ä½åŠ è½½ï¼Œäºæ˜¯ç›¸é‚»çš„æ•°æ®ä¼šä¸€å¹¶åŠ è½½åˆ°ç¼“å­˜ä¸­</p><p>ç¼“å­˜ä¼šé€ æˆæ•°æ®å‰¯æœ¬çš„äº§ç”Ÿï¼Œå³åŒä¸€ä»½æ•°æ®ä¼šç¼“å­˜åœ¨ä¸åŒæ ¸å¿ƒçš„ç¼“å­˜è¡Œä¸­ï¼ŒCPU è¦ä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ï¼Œéœ€è¦åšåˆ°æŸä¸ª CPU æ ¸å¿ƒæ›´æ”¹äº†æ•°æ®ï¼Œå…¶å®ƒ CPU æ ¸å¿ƒå¯¹åº”çš„<strong>æ•´ä¸ªç¼“å­˜è¡Œå¿…é¡»å¤±æ•ˆ</strong>ï¼Œè¿™å°±æ˜¯ä¼ªå…±äº«</p><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/JUC-å†…å­˜ä¼ªå…±äº«.png" style="zoom: 67%;" /><p>è§£å†³æ–¹æ³•ï¼š</p><ul><li><p>paddingï¼šé€šè¿‡å¡«å……ï¼Œè®©æ•°æ®è½åœ¨ä¸åŒçš„ cache line ä¸­</p></li><li><p>@Contendedï¼šåŸç†å‚è€ƒ æ— é” â†’ Adder â†’ ä¼˜åŒ–æœºåˆ¶ â†’ ä¼ªå…±äº«</p></li></ul><p>Linux æŸ¥çœ‹ CPU ç¼“å­˜è¡Œï¼š</p><ul><li>å‘½ä»¤ï¼š<code>cat /sys/devices/system/cpu/cpu0/cache/index0/coherency_line_size64</code></li><li>å†…å­˜åœ°å€æ ¼å¼ï¼š[é«˜ä½ç»„æ ‡è®°] [ä½ä½ç´¢å¼•] [åç§»é‡]</li></ul><hr><h4 id="ç¼“å­˜ä¸€è‡´"><a href="#ç¼“å­˜ä¸€è‡´" class="headerlink" title="ç¼“å­˜ä¸€è‡´"></a>ç¼“å­˜ä¸€è‡´</h4><p>ç¼“å­˜ä¸€è‡´æ€§ï¼šå½“å¤šä¸ªå¤„ç†å™¨è¿ç®—ä»»åŠ¡éƒ½æ¶‰åŠåˆ°åŒä¸€å—ä¸»å†…å­˜åŒºåŸŸçš„æ—¶å€™ï¼Œå°†å¯èƒ½å¯¼è‡´å„è‡ªçš„ç¼“å­˜æ•°æ®ä¸ä¸€æ ·</p><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/JUC-ç¼“å­˜ä¸€è‡´æ€§.png" style="zoom:80%;" /><p>MESIï¼ˆModified Exclusive Shared Or Invalidï¼‰æ˜¯ä¸€ç§å¹¿æ³›ä½¿ç”¨çš„<strong>æ”¯æŒå†™å›ç­–ç•¥çš„ç¼“å­˜ä¸€è‡´æ€§åè®®</strong>ï¼ŒCPU ä¸­æ¯ä¸ªç¼“å­˜è¡Œï¼ˆcaceh lineï¼‰ä½¿ç”¨ 4 ç§çŠ¶æ€è¿›è¡Œæ ‡è®°ï¼ˆä½¿ç”¨é¢å¤–çš„ä¸¤ä½ bit è¡¨ç¤º)ï¼š</p><ul><li><p>Mï¼šè¢«ä¿®æ”¹ï¼ˆModifiedï¼‰</p><p>è¯¥ç¼“å­˜è¡Œåªè¢«ç¼“å­˜åœ¨è¯¥ CPU çš„ç¼“å­˜ä¸­ï¼Œå¹¶ä¸”æ˜¯è¢«ä¿®æ”¹è¿‡çš„ï¼Œä¸ä¸»å­˜ä¸­çš„æ•°æ®ä¸ä¸€è‡´ (dirty)ï¼Œè¯¥ç¼“å­˜è¡Œä¸­çš„å†…å­˜éœ€è¦å†™å› (write back) ä¸»å­˜ã€‚è¯¥çŠ¶æ€çš„æ•°æ®å†æ¬¡è¢«ä¿®æ”¹ä¸ä¼šå‘é€å¹¿æ’­ï¼Œå› ä¸ºå…¶ä»–æ ¸å¿ƒçš„æ•°æ®å·²ç»åœ¨ç¬¬ä¸€æ¬¡ä¿®æ”¹æ—¶å¤±æ•ˆä¸€æ¬¡</p><p>å½“è¢«å†™å›ä¸»å­˜ä¹‹åï¼Œè¯¥ç¼“å­˜è¡Œçš„çŠ¶æ€ä¼šå˜æˆç‹¬äº« (exclusive) çŠ¶æ€</p></li><li><p>Eï¼šç‹¬äº«çš„ï¼ˆExclusiveï¼‰</p><p>è¯¥ç¼“å­˜è¡Œåªè¢«ç¼“å­˜åœ¨è¯¥ CPU çš„ç¼“å­˜ä¸­ï¼Œæ˜¯æœªè¢«ä¿®æ”¹è¿‡çš„ (clear)ï¼Œä¸ä¸»å­˜ä¸­æ•°æ®ä¸€è‡´ï¼Œä¿®æ”¹æ•°æ®ä¸éœ€è¦é€šçŸ¥å…¶ä»– CPU æ ¸å¿ƒï¼Œè¯¥çŠ¶æ€å¯ä»¥åœ¨ä»»ä½•æ—¶åˆ»æœ‰å…¶å®ƒ CPU è¯»å–è¯¥å†…å­˜æ—¶å˜æˆå…±äº«çŠ¶æ€ (shared)</p><p>å½“ CPU ä¿®æ”¹è¯¥ç¼“å­˜è¡Œä¸­å†…å®¹æ—¶ï¼Œè¯¥çŠ¶æ€å¯ä»¥å˜æˆ Modified çŠ¶æ€</p></li><li><p>Sï¼šå…±äº«çš„ï¼ˆSharedï¼‰</p><p>è¯¥çŠ¶æ€æ„å‘³ç€è¯¥ç¼“å­˜è¡Œå¯èƒ½è¢«å¤šä¸ª CPU ç¼“å­˜ï¼Œå¹¶ä¸”å„ä¸ªç¼“å­˜ä¸­çš„æ•°æ®ä¸ä¸»å­˜æ•°æ®ä¸€è‡´ï¼Œå½“ CPU ä¿®æ”¹è¯¥ç¼“å­˜è¡Œä¸­ï¼Œä¼šå‘å…¶å®ƒ CPU æ ¸å¿ƒå¹¿æ’­ä¸€ä¸ªè¯·æ±‚ï¼Œä½¿è¯¥ç¼“å­˜è¡Œå˜æˆæ— æ•ˆçŠ¶æ€ (Invalid)ï¼Œç„¶åå†æ›´æ–°å½“å‰ Cache é‡Œçš„æ•°æ®</p></li><li><p>Iï¼šæ— æ•ˆçš„ï¼ˆInvalidï¼‰</p><p>è¯¥ç¼“å­˜æ˜¯æ— æ•ˆçš„ï¼Œå¯èƒ½æœ‰å…¶å®ƒ CPU ä¿®æ”¹äº†è¯¥ç¼“å­˜è¡Œ</p></li></ul><p>è§£å†³æ–¹æ³•ï¼šå„ä¸ªå¤„ç†å™¨è®¿é—®ç¼“å­˜æ—¶éƒ½éµå¾ªä¸€äº›åè®®ï¼Œåœ¨è¯»å†™æ—¶è¦æ ¹æ®åè®®è¿›è¡Œæ“ä½œï¼Œåè®®ä¸»è¦æœ‰ MSIã€MESI ç­‰</p><hr><h4 id="å¤„ç†æœºåˆ¶"><a href="#å¤„ç†æœºåˆ¶" class="headerlink" title="å¤„ç†æœºåˆ¶"></a>å¤„ç†æœºåˆ¶</h4><p>å•æ ¸ CPU å¤„ç†å™¨ä¼šè‡ªåŠ¨ä¿è¯åŸºæœ¬å†…å­˜æ“ä½œçš„åŸå­æ€§</p><p>å¤šæ ¸ CPU å¤„ç†å™¨ï¼Œæ¯ä¸ª CPU å¤„ç†å™¨å†…ç»´æŠ¤äº†ä¸€å—å†…å­˜ï¼Œæ¯ä¸ªå†…æ ¸å†…éƒ¨ç»´æŠ¤ç€ä¸€å—ç¼“å­˜ï¼Œå½“å¤šçº¿ç¨‹å¹¶å‘è¯»å†™æ—¶ï¼Œå°±ä¼šå‡ºç°ç¼“å­˜æ•°æ®ä¸ä¸€è‡´çš„æƒ…å†µã€‚å¤„ç†å™¨æä¾›ï¼š</p><ul><li>æ€»çº¿é”å®šï¼šå½“å¤„ç†å™¨è¦æ“ä½œå…±äº«å˜é‡æ—¶ï¼Œåœ¨ BUS æ€»çº¿ä¸Šå‘å‡ºä¸€ä¸ª LOCK ä¿¡å·ï¼Œå…¶ä»–å¤„ç†å™¨å°±æ— æ³•æ“ä½œè¿™ä¸ªå…±äº«å˜é‡ï¼Œè¯¥æ“ä½œä¼šå¯¼è‡´å¤§é‡é˜»å¡ï¼Œä»è€Œå¢åŠ ç³»ç»Ÿçš„æ€§èƒ½å¼€é”€ï¼ˆ<strong>å¹³å°çº§åˆ«çš„åŠ é”</strong>ï¼‰</li><li>ç¼“å­˜é”å®šï¼šå½“å¤„ç†å™¨å¯¹ç¼“å­˜ä¸­çš„å…±äº«å˜é‡è¿›è¡Œäº†æ“ä½œï¼Œå…¶ä»–å¤„ç†å™¨æœ‰å—…æ¢æœºåˆ¶ï¼Œå°†å„è‡ªç¼“å­˜ä¸­çš„è¯¥å…±äº«å˜é‡çš„å¤±æ•ˆï¼Œè¯»å–æ—¶ä¼šé‡æ–°ä»ä¸»å†…å­˜ä¸­è¯»å–æœ€æ–°çš„æ•°æ®ï¼ŒåŸºäº MESI ç¼“å­˜ä¸€è‡´æ€§åè®®æ¥å®ç°</li></ul><p>æœ‰å¦‚ä¸‹ä¸¤ç§æƒ…å†µå¤„ç†å™¨ä¸ä¼šä½¿ç”¨ç¼“å­˜é”å®šï¼š</p><ul><li><p>å½“æ“ä½œçš„æ•°æ®è·¨å¤šä¸ªç¼“å­˜è¡Œï¼Œæˆ–æ²¡è¢«ç¼“å­˜åœ¨å¤„ç†å™¨å†…éƒ¨ï¼Œåˆ™å¤„ç†å™¨ä¼šä½¿ç”¨æ€»çº¿é”å®š</p></li><li><p>æœ‰äº›å¤„ç†å™¨ä¸æ”¯æŒç¼“å­˜é”å®šï¼Œæ¯”å¦‚ï¼šIntel 486 å’Œ Pentium å¤„ç†å™¨ä¹Ÿä¼šè°ƒç”¨æ€»çº¿é”å®š</p></li></ul><p>æ€»çº¿æœºåˆ¶ï¼š</p><ul><li><p>æ€»çº¿å—…æ¢ï¼šæ¯ä¸ªå¤„ç†å™¨é€šè¿‡å—…æ¢åœ¨æ€»çº¿ä¸Šä¼ æ’­çš„æ•°æ®æ¥æ£€æŸ¥è‡ªå·±ç¼“å­˜å€¼æ˜¯å¦è¿‡æœŸäº†ï¼Œå½“å¤„ç†å™¨å‘ç°è‡ªå·±çš„ç¼“å­˜å¯¹åº”çš„å†…å­˜åœ°å€çš„æ•°æ®è¢«ä¿®æ”¹ï¼Œå°±<strong>å°†å½“å‰å¤„ç†å™¨çš„ç¼“å­˜è¡Œè®¾ç½®ä¸ºæ— æ•ˆçŠ¶æ€</strong>ï¼Œå½“å¤„ç†å™¨å¯¹è¿™ä¸ªæ•°æ®è¿›è¡Œæ“ä½œæ—¶ï¼Œä¼šé‡æ–°ä»å†…å­˜ä¸­æŠŠæ•°æ®è¯»å–åˆ°å¤„ç†å™¨ç¼“å­˜ä¸­</p></li><li><p>æ€»çº¿é£æš´ï¼šå½“æŸä¸ª CPU æ ¸å¿ƒæ›´æ–°äº† Cache ä¸­çš„æ•°æ®ï¼Œè¦æŠŠè¯¥äº‹ä»¶å¹¿æ’­é€šçŸ¥åˆ°å…¶ä»–æ ¸å¿ƒï¼ˆ<strong>å†™ä¼ æ’­</strong>ï¼‰ï¼ŒCPU éœ€è¦æ¯æ—¶æ¯åˆ»ç›‘å¬æ€»çº¿ä¸Šçš„ä¸€åˆ‡æ´»åŠ¨ï¼Œä½†æ˜¯ä¸ç®¡åˆ«çš„æ ¸å¿ƒçš„ Cache æ˜¯å¦ç¼“å­˜ç›¸åŒçš„æ•°æ®ï¼Œéƒ½éœ€è¦å‘å‡ºä¸€ä¸ªå¹¿æ’­äº‹ä»¶ï¼Œä¸æ–­çš„ä»ä¸»å†…å­˜å—…æ¢å’Œ CAS å¾ªç¯ï¼Œæ— æ•ˆçš„äº¤äº’ä¼šå¯¼è‡´æ€»çº¿å¸¦å®½è¾¾åˆ°å³°å€¼ï¼›å› æ­¤ä¸è¦å¤§é‡ä½¿ç”¨ volatile å…³é”®å­—ï¼Œä½¿ç”¨ volatileã€syschonized éƒ½éœ€è¦æ ¹æ®å®é™…åœºæ™¯</p></li></ul><hr><h3 id="volatile"><a href="#volatile" class="headerlink" title="volatile"></a>volatile</h3><h4 id="åŒæ­¥æœºåˆ¶"><a href="#åŒæ­¥æœºåˆ¶" class="headerlink" title="åŒæ­¥æœºåˆ¶"></a>åŒæ­¥æœºåˆ¶</h4><p>volatile æ˜¯ Java è™šæ‹Ÿæœºæä¾›çš„<strong>è½»é‡çº§</strong>çš„åŒæ­¥æœºåˆ¶ï¼ˆä¸‰å¤§ç‰¹æ€§ï¼‰</p><ul><li>ä¿è¯å¯è§æ€§</li><li>ä¸ä¿è¯åŸå­æ€§</li><li>ä¿è¯æœ‰åºæ€§ï¼ˆç¦æ­¢æŒ‡ä»¤é‡æ’ï¼‰</li></ul><p>æ€§èƒ½ï¼švolatile ä¿®é¥°çš„å˜é‡è¿›è¡Œè¯»æ“ä½œä¸æ™®é€šå˜é‡å‡ ä¹æ²¡ä»€ä¹ˆå·®åˆ«ï¼Œä½†æ˜¯å†™æ“ä½œç›¸å¯¹æ…¢ä¸€äº›ï¼Œå› ä¸ºéœ€è¦åœ¨æœ¬åœ°ä»£ç ä¸­æ’å…¥å¾ˆå¤šå†…å­˜å±éšœæ¥ä¿è¯æŒ‡ä»¤ä¸ä¼šå‘ç”Ÿä¹±åºæ‰§è¡Œï¼Œä½†æ˜¯å¼€é”€æ¯”é”è¦å°</p><p>synchronized æ— æ³•ç¦æ­¢æŒ‡ä»¤é‡æ’å’Œå¤„ç†å™¨ä¼˜åŒ–ï¼Œä¸ºä»€ä¹ˆå¯ä»¥ä¿è¯æœ‰åºæ€§å¯è§æ€§</p><ul><li>åŠ äº†é”ä¹‹åï¼Œåªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹è·å¾—åˆ°äº†é”ï¼Œè·å¾—ä¸åˆ°é”çš„çº¿ç¨‹å°±è¦é˜»å¡ï¼Œæ‰€ä»¥åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œï¼Œç›¸å½“äºå•çº¿ç¨‹ï¼Œç”±äºæ•°æ®ä¾èµ–æ€§çš„å­˜åœ¨ï¼Œå•çº¿ç¨‹çš„æŒ‡ä»¤é‡æ’æ˜¯æ²¡æœ‰é—®é¢˜çš„</li><li>çº¿ç¨‹åŠ é”å‰ï¼Œå°†<strong>æ¸…ç©ºå·¥ä½œå†…å­˜</strong>ä¸­å…±äº«å˜é‡çš„å€¼ï¼Œä½¿ç”¨å…±äº«å˜é‡æ—¶éœ€è¦ä»ä¸»å†…å­˜ä¸­é‡æ–°è¯»å–æœ€æ–°çš„å€¼ï¼›çº¿ç¨‹è§£é”å‰ï¼Œå¿…é¡»æŠŠå…±äº«å˜é‡çš„æœ€æ–°å€¼<strong>åˆ·æ–°åˆ°ä¸»å†…å­˜</strong>ä¸­ï¼ˆJMM å†…å­˜äº¤äº’ç« èŠ‚æœ‰è®²ï¼‰</li></ul><hr><h4 id="æŒ‡ä»¤é‡æ’"><a href="#æŒ‡ä»¤é‡æ’" class="headerlink" title="æŒ‡ä»¤é‡æ’"></a>æŒ‡ä»¤é‡æ’</h4><p>volatile ä¿®é¥°çš„å˜é‡ï¼Œå¯ä»¥ç¦ç”¨æŒ‡ä»¤é‡æ’</p><p>æŒ‡ä»¤é‡æ’å®ä¾‹ï¼š</p><ul><li><p>example 1ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">mySort</span><span class="params">()</span> &#123;</span><br><span class="line"><span class="type">int</span> <span class="variable">x</span> <span class="operator">=</span> <span class="number">11</span>;<span class="comment">//è¯­å¥1</span></span><br><span class="line"><span class="type">int</span> <span class="variable">y</span> <span class="operator">=</span> <span class="number">12</span>;<span class="comment">//è¯­å¥2  è°å…ˆæ‰§è¡Œæ•ˆæœä¸€æ ·</span></span><br><span class="line">x = x + <span class="number">5</span>;<span class="comment">//è¯­å¥3</span></span><br><span class="line">y = x * x;<span class="comment">//è¯­å¥4</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œé¡ºåºæ˜¯ï¼š1 2 3 4ã€2 1 3 4ã€1 3 2 4</p><p>æŒ‡ä»¤é‡æ’ä¹Ÿæœ‰é™åˆ¶ä¸ä¼šå‡ºç°ï¼š4321ï¼Œè¯­å¥ 4 éœ€è¦ä¾èµ–äº y ä»¥åŠ x çš„ç”³æ˜ï¼Œå› ä¸ºå­˜åœ¨æ•°æ®ä¾èµ–ï¼Œæ— æ³•é¦–å…ˆæ‰§è¡Œ</p></li><li><p>example 2ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="variable">num</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"><span class="type">boolean</span> <span class="variable">ready</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line"><span class="comment">// çº¿ç¨‹1 æ‰§è¡Œæ­¤æ–¹æ³•</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">actor1</span><span class="params">(I_Result r)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span>(ready) &#123;</span><br><span class="line">    r.r1 = num + num;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    r.r1 = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// çº¿ç¨‹2 æ‰§è¡Œæ­¤æ–¹æ³•</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">actor2</span><span class="params">(I_Result r)</span> &#123;</span><br><span class="line">num = <span class="number">2</span>;</span><br><span class="line">ready = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æƒ…å†µä¸€ï¼šçº¿ç¨‹ 1 å…ˆæ‰§è¡Œï¼Œready &#x3D; falseï¼Œç»“æœä¸º r.r1 &#x3D; 1</p><p>æƒ…å†µäºŒï¼šçº¿ç¨‹ 2 å…ˆæ‰§è¡Œ num &#x3D; 2ï¼Œä½†è¿˜æ²¡æ‰§è¡Œ ready &#x3D; trueï¼Œçº¿ç¨‹ 1 æ‰§è¡Œï¼Œç»“æœä¸º r.r1 &#x3D; 1</p><p>æƒ…å†µä¸‰ï¼šçº¿ç¨‹ 2 å…ˆæ‰§è¡Œ ready &#x3D; trueï¼Œçº¿ç¨‹ 1 æ‰§è¡Œï¼Œè¿›å…¥ if åˆ†æ”¯ç»“æœä¸º r.r1 &#x3D; 4</p><p>æƒ…å†µå››ï¼šçº¿ç¨‹ 2 æ‰§è¡Œ ready &#x3D; trueï¼Œåˆ‡æ¢åˆ°çº¿ç¨‹ 1ï¼Œè¿›å…¥ if åˆ†æ”¯ä¸º r.r1 &#x3D; 0ï¼Œå†åˆ‡å›çº¿ç¨‹ 2 æ‰§è¡Œ num &#x3D; 2ï¼Œå‘ç”ŸæŒ‡ä»¤é‡æ’</p></li></ul><hr><h4 id="åº•å±‚åŸç†"><a href="#åº•å±‚åŸç†" class="headerlink" title="åº•å±‚åŸç†"></a>åº•å±‚åŸç†</h4><h5 id="ç¼“å­˜ä¸€è‡´-1"><a href="#ç¼“å­˜ä¸€è‡´-1" class="headerlink" title="ç¼“å­˜ä¸€è‡´"></a>ç¼“å­˜ä¸€è‡´</h5><p>ä½¿ç”¨ volatile ä¿®é¥°çš„å…±äº«å˜é‡ï¼Œåº•å±‚é€šè¿‡æ±‡ç¼– lock å‰ç¼€æŒ‡ä»¤è¿›è¡Œç¼“å­˜é”å®šï¼Œåœ¨çº¿ç¨‹ä¿®æ”¹å®Œå…±äº«å˜é‡åå†™å›ä¸»å­˜ï¼Œå…¶ä»–çš„ CPU æ ¸å¿ƒä¸Šè¿è¡Œçš„çº¿ç¨‹é€šè¿‡ CPU æ€»çº¿å—…æ¢æœºåˆ¶ä¼šä¿®æ”¹å…¶å…±äº«å˜é‡ä¸ºå¤±æ•ˆçŠ¶æ€ï¼Œè¯»å–æ—¶ä¼šé‡æ–°ä»ä¸»å†…å­˜ä¸­è¯»å–æœ€æ–°çš„æ•°æ®</p><p>lock å‰ç¼€æŒ‡ä»¤å°±ç›¸å½“äºå†…å­˜å±éšœï¼ŒMemory Barrierï¼ˆMemory Fenceï¼‰</p><ul><li>å¯¹ volatile å˜é‡çš„å†™æŒ‡ä»¤åä¼šåŠ å…¥å†™å±éšœ</li><li>å¯¹ volatile å˜é‡çš„è¯»æŒ‡ä»¤å‰ä¼šåŠ å…¥è¯»å±éšœ</li></ul><p>å†…å­˜å±éšœæœ‰ä¸‰ä¸ªä½œç”¨ï¼š</p><ul><li>ç¡®ä¿å¯¹å†…å­˜çš„è¯»-æ”¹-å†™æ“ä½œåŸå­æ‰§è¡Œ</li><li>é˜»æ­¢å±éšœä¸¤ä¾§çš„æŒ‡ä»¤é‡æ’åº</li><li>å¼ºåˆ¶æŠŠç¼“å­˜ä¸­çš„è„æ•°æ®å†™å›ä¸»å†…å­˜ï¼Œè®©ç¼“å­˜è¡Œä¸­ç›¸åº”çš„æ•°æ®å¤±æ•ˆ</li></ul><hr><h5 id="å†…å­˜å±éšœ"><a href="#å†…å­˜å±éšœ" class="headerlink" title="å†…å­˜å±éšœ"></a>å†…å­˜å±éšœ</h5><p>ä¿è¯<strong>å¯è§æ€§</strong>ï¼š</p><ul><li><p>å†™å±éšœï¼ˆsfenceï¼ŒStore Barrierï¼‰ä¿è¯åœ¨è¯¥å±éšœä¹‹å‰çš„ï¼Œå¯¹å…±äº«å˜é‡çš„æ”¹åŠ¨ï¼Œéƒ½åŒæ­¥åˆ°ä¸»å­˜å½“ä¸­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">actor2</span><span class="params">(I_Result r)</span> &#123;</span><br><span class="line">    num = <span class="number">2</span>;</span><br><span class="line">    ready = <span class="literal">true</span>; <span class="comment">// ready æ˜¯ volatile èµ‹å€¼å¸¦å†™å±éšœ</span></span><br><span class="line">    <span class="comment">// å†™å±éšœ</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>è¯»å±éšœï¼ˆlfenceï¼ŒLoad Barrierï¼‰ä¿è¯åœ¨è¯¥å±éšœä¹‹åçš„ï¼Œå¯¹å…±äº«å˜é‡çš„è¯»å–ï¼Œä»ä¸»å­˜åˆ·æ–°å˜é‡å€¼ï¼ŒåŠ è½½çš„æ˜¯ä¸»å­˜ä¸­æœ€æ–°æ•°æ®</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">actor1</span><span class="params">(I_Result r)</span> &#123;</span><br><span class="line">    <span class="comment">// è¯»å±éšœ</span></span><br><span class="line">    <span class="comment">// ready æ˜¯ volatile è¯»å–å€¼å¸¦è¯»å±éšœ</span></span><br><span class="line">    <span class="keyword">if</span>(ready) &#123;</span><br><span class="line">    r.r1 = num + num;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    r.r1 = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/JMM-volatileä¿è¯å¯è§æ€§.png" style="zoom:67%;" /></li><li><p>å…¨èƒ½å±éšœï¼šmfenceï¼ˆmodify&#x2F;mix Barrierï¼‰ï¼Œå…¼å…· sfence å’Œ lfence çš„åŠŸèƒ½</p></li></ul><p>ä¿è¯<strong>æœ‰åºæ€§</strong>ï¼š</p><ul><li>å†™å±éšœä¼šç¡®ä¿æŒ‡ä»¤é‡æ’åºæ—¶ï¼Œä¸ä¼šå°†å†™å±éšœä¹‹å‰çš„ä»£ç æ’åœ¨å†™å±éšœä¹‹å</li><li>è¯»å±éšœä¼šç¡®ä¿æŒ‡ä»¤é‡æ’åºæ—¶ï¼Œä¸ä¼šå°†è¯»å±éšœä¹‹åçš„ä»£ç æ’åœ¨è¯»å±éšœä¹‹å‰</li></ul><p>ä¸èƒ½è§£å†³æŒ‡ä»¤äº¤é”™ï¼š</p><ul><li><p>å†™å±éšœä»…ä»…æ˜¯ä¿è¯ä¹‹åçš„è¯»èƒ½å¤Ÿè¯»åˆ°æœ€æ–°çš„ç»“æœï¼Œä½†ä¸èƒ½ä¿è¯å…¶ä»–çº¿ç¨‹çš„è¯»è·‘åˆ°å†™å±éšœä¹‹å‰</p></li><li><p>æœ‰åºæ€§çš„ä¿è¯ä¹Ÿåªæ˜¯ä¿è¯äº†æœ¬çº¿ç¨‹å†…ç›¸å…³ä»£ç ä¸è¢«é‡æ’åº</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">volatile</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;i++&#125;);</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;i--&#125;);</span><br></pre></td></tr></table></figure><p>i++ åç¼–è¯‘åçš„æŒ‡ä»¤ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: iconst_1<span class="comment">// å½“intå–å€¼ -1~5 æ—¶ï¼ŒJVMé‡‡ç”¨iconstæŒ‡ä»¤å°†å¸¸é‡å‹å…¥æ ˆä¸­</span></span><br><span class="line"><span class="number">1</span>: istore_1<span class="comment">// å°†æ“ä½œæ•°æ ˆé¡¶æ•°æ®å¼¹å‡ºï¼Œå­˜å…¥å±€éƒ¨å˜é‡è¡¨çš„ slot 1</span></span><br><span class="line"><span class="number">2</span>: iinc<span class="number">1</span>, <span class="number">1</span></span><br></pre></td></tr></table></figure><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/JMM-volatileä¸èƒ½ä¿è¯åŸå­æ€§.png" style="zoom:67%;" /></li></ul><hr><h5 id="äº¤äº’è§„åˆ™"><a href="#äº¤äº’è§„åˆ™" class="headerlink" title="äº¤äº’è§„åˆ™"></a>äº¤äº’è§„åˆ™</h5><p>å¯¹äº volatile ä¿®é¥°çš„å˜é‡ï¼š</p><ul><li>çº¿ç¨‹å¯¹å˜é‡çš„ use ä¸ loadã€read æ“ä½œæ˜¯ç›¸å…³è”çš„ï¼Œæ‰€ä»¥å˜é‡ä½¿ç”¨å‰å¿…é¡»å…ˆä»ä¸»å­˜åŠ è½½</li><li>çº¿ç¨‹å¯¹å˜é‡çš„ assign ä¸ storeã€write æ“ä½œæ˜¯ç›¸å…³è”çš„ï¼Œæ‰€ä»¥å˜é‡ä½¿ç”¨åå¿…é¡»åŒæ­¥è‡³ä¸»å­˜</li><li>çº¿ç¨‹ 1 å’Œçº¿ç¨‹ 2 è°å…ˆå¯¹å˜é‡æ‰§è¡Œ read æ“ä½œï¼Œå°±ä¼šå…ˆè¿›è¡Œ write æ“ä½œï¼Œé˜²æ­¢æŒ‡ä»¤é‡æ’</li></ul><hr><h4 id="åŒç«¯æ£€é”"><a href="#åŒç«¯æ£€é”" class="headerlink" title="åŒç«¯æ£€é”"></a>åŒç«¯æ£€é”</h4><h5 id="æ£€é”æœºåˆ¶"><a href="#æ£€é”æœºåˆ¶" class="headerlink" title="æ£€é”æœºåˆ¶"></a>æ£€é”æœºåˆ¶</h5><p>Double-Checked Lockingï¼šåŒç«¯æ£€é”æœºåˆ¶</p><p>DCLï¼ˆåŒç«¯æ£€é”ï¼‰æœºåˆ¶ä¸ä¸€å®šæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼ŒåŸå› æ˜¯æœ‰æŒ‡ä»¤é‡æ’çš„å­˜åœ¨ï¼ŒåŠ å…¥ volatile å¯ä»¥ç¦æ­¢æŒ‡ä»¤é‡æ’</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Singleton</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">Singleton</span><span class="params">()</span> &#123; &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">Singleton</span> <span class="variable">INSTANCE</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Singleton <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(INSTANCE == <span class="literal">null</span>) &#123; <span class="comment">// t2ï¼Œè¿™é‡Œçš„åˆ¤æ–­ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„</span></span><br><span class="line">            <span class="comment">// é¦–æ¬¡è®¿é—®ä¼šåŒæ­¥ï¼Œè€Œä¹‹åçš„ä½¿ç”¨æ²¡æœ‰ synchronized</span></span><br><span class="line">            <span class="keyword">synchronized</span>(Singleton.class) &#123;</span><br><span class="line">                <span class="comment">// è¿™é‡Œæ˜¯çº¿ç¨‹å®‰å…¨çš„åˆ¤æ–­ï¼Œé˜²æ­¢å…¶ä»–çº¿ç¨‹åœ¨å½“å‰çº¿ç¨‹ç­‰å¾…é”çš„æœŸé—´å®Œæˆäº†åˆå§‹åŒ–</span></span><br><span class="line">                <span class="keyword">if</span> (INSTANCE == <span class="literal">null</span>) &#123; </span><br><span class="line">                    INSTANCE = <span class="keyword">new</span> <span class="title class_">Singleton</span>();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> INSTANCE;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸é” INSTANCE çš„åŸå› ï¼š</p><ul><li>INSTANCE è¦é‡æ–°èµ‹å€¼</li><li>INSTANCE æ˜¯ nullï¼Œçº¿ç¨‹åŠ é”ä¹‹å‰éœ€è¦è·å–å¯¹è±¡çš„å¼•ç”¨ï¼Œè®¾ç½®å¯¹è±¡å¤´ï¼Œnull æ²¡æœ‰å¼•ç”¨</li></ul><p>å®ç°ç‰¹ç‚¹ï¼š </p><ul><li>æ‡’æƒ°åˆå§‹åŒ–</li><li>é¦–æ¬¡ä½¿ç”¨ getInstance() æ‰ä½¿ç”¨ synchronized åŠ é”ï¼Œåç»­ä½¿ç”¨æ—¶æ— éœ€åŠ é”</li><li>ç¬¬ä¸€ä¸ª if ä½¿ç”¨äº† INSTANCE å˜é‡ï¼Œæ˜¯åœ¨åŒæ­¥å—ä¹‹å¤–ï¼Œä½†åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹ä¼šäº§ç”Ÿé—®é¢˜</li></ul><hr><h5 id="DCLé—®é¢˜"><a href="#DCLé—®é¢˜" class="headerlink" title="DCLé—®é¢˜"></a>DCLé—®é¢˜</h5><p>getInstance æ–¹æ³•å¯¹åº”çš„å­—èŠ‚ç ä¸ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: getstatic #<span class="number">2</span> <span class="comment">// Field INSTANCE:Ltest/Singleton;</span></span><br><span class="line"><span class="number">3</span>: ifnonnull <span class="number">37</span></span><br><span class="line"><span class="number">6</span>: ldc #<span class="number">3</span> <span class="comment">// class test/Singleton</span></span><br><span class="line"><span class="number">8</span>: dup</span><br><span class="line"><span class="number">9</span>: astore_0</span><br><span class="line"><span class="number">10</span>: monitorenter</span><br><span class="line"><span class="number">11</span>: getstatic #<span class="number">2</span> <span class="comment">// Field INSTANCE:Ltest/Singleton;</span></span><br><span class="line"><span class="number">14</span>: ifnonnull <span class="number">27</span></span><br><span class="line"><span class="number">17</span>: <span class="keyword">new</span> #<span class="number">3</span> <span class="comment">// class test/Singleton</span></span><br><span class="line"><span class="number">20</span>: dup</span><br><span class="line"><span class="number">21</span>: invokespecial #<span class="number">4</span> <span class="comment">// Method &quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line"><span class="number">24</span>: putstatic #<span class="number">2</span> <span class="comment">// Field INSTANCE:Ltest/Singleton;</span></span><br><span class="line"><span class="number">27</span>: aload_0</span><br><span class="line"><span class="number">28</span>: monitorexit</span><br><span class="line"><span class="number">29</span>: goto <span class="number">37</span></span><br><span class="line"><span class="number">32</span>: astore_1</span><br><span class="line"><span class="number">33</span>: aload_0</span><br><span class="line"><span class="number">34</span>: monitorexit</span><br><span class="line"><span class="number">35</span>: aload_1</span><br><span class="line"><span class="number">36</span>: athrow</span><br><span class="line"><span class="number">37</span>: getstatic #<span class="number">2</span> <span class="comment">// Field INSTANCE:Ltest/Singleton;</span></span><br><span class="line"><span class="number">40</span>: areturn</span><br></pre></td></tr></table></figure><ul><li>17 è¡¨ç¤ºåˆ›å»ºå¯¹è±¡ï¼Œå°†å¯¹è±¡å¼•ç”¨å…¥æ ˆ </li><li>20 è¡¨ç¤ºå¤åˆ¶ä¸€ä»½å¯¹è±¡å¼•ç”¨ï¼Œå¼•ç”¨åœ°å€</li><li>21 è¡¨ç¤ºåˆ©ç”¨ä¸€ä¸ªå¯¹è±¡å¼•ç”¨ï¼Œè°ƒç”¨æ„é€ æ–¹æ³•åˆå§‹åŒ–å¯¹è±¡</li><li>24 è¡¨ç¤ºåˆ©ç”¨ä¸€ä¸ªå¯¹è±¡å¼•ç”¨ï¼Œèµ‹å€¼ç»™ static INSTANCE</li></ul><p><strong>æ­¥éª¤ 21 å’Œ 24 ä¹‹é—´ä¸å­˜åœ¨æ•°æ®ä¾èµ–å…³ç³»</strong>ï¼Œè€Œä¸”æ— è®ºé‡æ’å‰åï¼Œç¨‹åºçš„æ‰§è¡Œç»“æœåœ¨å•çº¿ç¨‹ä¸­å¹¶æ²¡æœ‰æ”¹å˜ï¼Œå› æ­¤è¿™ç§é‡æ’ä¼˜åŒ–æ˜¯å…è®¸çš„</p><ul><li>å…³é”®åœ¨äº 0:getstatic è¿™è¡Œä»£ç åœ¨ monitor æ§åˆ¶ä¹‹å¤–ï¼Œå¯ä»¥è¶Šè¿‡ monitor è¯»å– INSTANCE å˜é‡çš„å€¼</li><li>å½“å…¶ä»–çº¿ç¨‹è®¿é—® INSTANCE ä¸ä¸º null æ—¶ï¼Œç”±äº INSTANCE å®ä¾‹æœªå¿…å·²åˆå§‹åŒ–ï¼Œé‚£ä¹ˆ t2 æ‹¿åˆ°çš„æ˜¯å°†æ˜¯ä¸€ä¸ªæœªåˆå§‹åŒ–å®Œæ¯•çš„å•ä¾‹è¿”å›ï¼Œè¿™å°±é€ æˆäº†çº¿ç¨‹å®‰å…¨çš„é—®é¢˜</li></ul><p><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/JMM-DCL%E5%87%BA%E7%8E%B0%E7%9A%84%E9%97%AE%E9%A2%98.png"></p><hr><h5 id="è§£å†³æ–¹æ³•"><a href="#è§£å†³æ–¹æ³•" class="headerlink" title="è§£å†³æ–¹æ³•"></a>è§£å†³æ–¹æ³•</h5><p>æŒ‡ä»¤é‡æ’åªä¼šä¿è¯ä¸²è¡Œè¯­ä¹‰çš„æ‰§è¡Œä¸€è‡´æ€§ï¼ˆå•çº¿ç¨‹ï¼‰ï¼Œä½†å¹¶ä¸ä¼šå…³ç³»å¤šçº¿ç¨‹é—´çš„è¯­ä¹‰ä¸€è‡´æ€§</p><p>å¼•å…¥ volatileï¼Œæ¥ä¿è¯å‡ºç°æŒ‡ä»¤é‡æ’çš„é—®é¢˜ï¼Œä»è€Œä¿è¯å•ä¾‹æ¨¡å¼çš„çº¿ç¨‹å®‰å…¨æ€§ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> <span class="type">SingletonDemo</span> <span class="variable">INSTANCE</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br></pre></td></tr></table></figure><hr><h3 id="ha-be"><a href="#ha-be" class="headerlink" title="ha-be"></a>ha-be</h3><p>happens-before å…ˆè¡Œå‘ç”Ÿ</p><p>Java å†…å­˜æ¨¡å‹å…·å¤‡ä¸€äº›å…ˆå¤©çš„â€œæœ‰åºæ€§â€ï¼Œå³ä¸éœ€è¦é€šè¿‡ä»»ä½•åŒæ­¥æ‰‹æ®µï¼ˆvolatileã€synchronized ç­‰ï¼‰å°±èƒ½å¤Ÿå¾—åˆ°ä¿è¯çš„å®‰å…¨ï¼Œè¿™ä¸ªé€šå¸¸ä¹Ÿç§°ä¸º happens-before åŸåˆ™ï¼Œå®ƒæ˜¯å¯è§æ€§ä¸æœ‰åºæ€§çš„ä¸€å¥—è§„åˆ™æ€»ç»“</p><p>ä¸ç¬¦åˆ happens-before è§„åˆ™ï¼ŒJMM å¹¶ä¸èƒ½ä¿è¯ä¸€ä¸ªçº¿ç¨‹çš„å¯è§æ€§å’Œæœ‰åºæ€§</p><ol><li><p>ç¨‹åºæ¬¡åºè§„åˆ™ (Program Order Rule)ï¼šä¸€ä¸ªçº¿ç¨‹å†…ï¼Œé€»è¾‘ä¸Šä¹¦å†™åœ¨å‰é¢çš„æ“ä½œå…ˆè¡Œå‘ç”Ÿäºä¹¦å†™åœ¨åé¢çš„æ“ä½œ ï¼Œå› ä¸ºå¤šä¸ªæ“ä½œä¹‹é—´æœ‰å…ˆåä¾èµ–å…³ç³»ï¼Œåˆ™ä¸å…è®¸å¯¹è¿™äº›æ“ä½œè¿›è¡Œé‡æ’åº</p></li><li><p>é”å®šè§„åˆ™ (Monitor Lock Rule)ï¼šä¸€ä¸ª unlock æ“ä½œå…ˆè¡Œå‘ç”Ÿäºåé¢ï¼ˆæ—¶é—´çš„å…ˆåï¼‰å¯¹åŒä¸€ä¸ªé”çš„ lock æ“ä½œï¼Œæ‰€ä»¥çº¿ç¨‹è§£é” m ä¹‹å‰å¯¹å˜é‡çš„å†™ï¼ˆè§£é”å‰ä¼šåˆ·æ–°åˆ°ä¸»å†…å­˜ä¸­ï¼‰ï¼Œå¯¹äºæ¥ä¸‹æ¥å¯¹ m åŠ é”çš„å…¶å®ƒçº¿ç¨‹å¯¹è¯¥å˜é‡çš„è¯»å¯è§</p></li><li><p><strong>volatile å˜é‡è§„åˆ™</strong>  (Volatile Variable Rule)ï¼šå¯¹ volatile å˜é‡çš„å†™æ“ä½œå…ˆè¡Œå‘ç”Ÿäºåé¢å¯¹è¿™ä¸ªå˜é‡çš„è¯»</p></li><li><p>ä¼ é€’è§„åˆ™ (Transitivity)ï¼šå…·æœ‰ä¼ é€’æ€§ï¼Œå¦‚æœæ“ä½œ A å…ˆè¡Œå‘ç”Ÿäºæ“ä½œ Bï¼Œè€Œæ“ä½œ B åˆå…ˆè¡Œå‘ç”Ÿäºæ“ä½œ Cï¼Œåˆ™å¯ä»¥å¾—å‡ºæ“ä½œ A å…ˆè¡Œå‘ç”Ÿäºæ“ä½œ C</p></li><li><p>çº¿ç¨‹å¯åŠ¨è§„åˆ™ (Thread Start Rule)ï¼šThread å¯¹è±¡çš„ start()æ–¹ æ³•å…ˆè¡Œå‘ç”Ÿäºæ­¤çº¿ç¨‹ä¸­çš„æ¯ä¸€ä¸ªæ“ä½œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="type">int</span> <span class="variable">x</span> <span class="operator">=</span> <span class="number">10</span>;<span class="comment">//çº¿ç¨‹ start å‰å¯¹å˜é‡çš„å†™ï¼Œå¯¹è¯¥çº¿ç¨‹å¼€å§‹åå¯¹è¯¥å˜é‡çš„è¯»å¯è§</span></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">Thread</span>(()-&gt;&#123;System.out.println(x);&#125;,<span class="string">&quot;t1&quot;</span>).start();</span><br></pre></td></tr></table></figure></li><li><p>çº¿ç¨‹ä¸­æ–­è§„åˆ™ (Thread Interruption Rule)ï¼šå¯¹çº¿ç¨‹ interrupt() æ–¹æ³•çš„è°ƒç”¨å…ˆè¡Œå‘ç”Ÿäºè¢«ä¸­æ–­çº¿ç¨‹çš„ä»£ç æ£€æµ‹åˆ°ä¸­æ–­äº‹ä»¶çš„å‘ç”Ÿ</p></li><li><p>çº¿ç¨‹ç»ˆæ­¢è§„åˆ™ (Thread Termination Rule)ï¼šçº¿ç¨‹ä¸­æ‰€æœ‰çš„æ“ä½œéƒ½å…ˆè¡Œå‘ç”Ÿäºçº¿ç¨‹çš„ç»ˆæ­¢æ£€æµ‹ï¼Œå¯ä»¥é€šè¿‡ Thread.join() æ–¹æ³•ç»“æŸã€Thread.isAlive() çš„è¿”å›å€¼æ‰‹æ®µæ£€æµ‹åˆ°çº¿ç¨‹å·²ç»ç»ˆæ­¢æ‰§è¡Œ</p></li><li><p>å¯¹è±¡ç»ˆç»“è§„åˆ™ï¼ˆFinaizer Ruleï¼‰ï¼šä¸€ä¸ªå¯¹è±¡çš„åˆå§‹åŒ–å®Œæˆï¼ˆæ„é€ å‡½æ•°æ‰§è¡Œç»“æŸï¼‰å…ˆè¡Œå‘ç”Ÿäºå®ƒçš„ finalize() æ–¹æ³•çš„å¼€å§‹</p></li></ol><hr><h3 id="è®¾è®¡æ¨¡å¼"><a href="#è®¾è®¡æ¨¡å¼" class="headerlink" title="è®¾è®¡æ¨¡å¼"></a>è®¾è®¡æ¨¡å¼</h3><h4 id="ç»ˆæ­¢æ¨¡å¼-1"><a href="#ç»ˆæ­¢æ¨¡å¼-1" class="headerlink" title="ç»ˆæ­¢æ¨¡å¼"></a>ç»ˆæ­¢æ¨¡å¼</h4><p>ç»ˆæ­¢æ¨¡å¼ä¹‹ä¸¤é˜¶æ®µç»ˆæ­¢æ¨¡å¼ï¼šåœæ­¢æ ‡è®°ç”¨ volatile æ˜¯ä¸ºäº†ä¿è¯è¯¥å˜é‡åœ¨å¤šä¸ªçº¿ç¨‹ä¹‹é—´çš„å¯è§æ€§</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">TwoPhaseTermination</span> &#123;</span><br><span class="line">    <span class="comment">// ç›‘æ§çº¿ç¨‹</span></span><br><span class="line">    <span class="keyword">private</span> Thread monitor;</span><br><span class="line">    <span class="comment">// åœæ­¢æ ‡è®°</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">boolean</span> <span class="variable">stop</span> <span class="operator">=</span> <span class="literal">false</span>;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¯åŠ¨ç›‘æ§çº¿ç¨‹</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> &#123;</span><br><span class="line">        monitor = <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">                <span class="keyword">if</span> (stop) &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;åç½®å¤„ç†&quot;</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">1000</span>);<span class="comment">// ç¡çœ </span></span><br><span class="line">                    System.out.println(thread.getName() + <span class="string">&quot;æ‰§è¡Œç›‘æ§è®°å½•&quot;</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                   System.out.println(<span class="string">&quot;è¢«æ‰“æ–­ï¼Œé€€å‡ºç¡çœ &quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        monitor.start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åœæ­¢ç›‘æ§çº¿ç¨‹</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">stop</span><span class="params">()</span> &#123;</span><br><span class="line">        stop = <span class="literal">true</span>;</span><br><span class="line">        monitor.interrupt();<span class="comment">// è®©çº¿ç¨‹å°½å¿«é€€å‡ºTimed Waiting</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// æµ‹è¯•</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="type">TwoPhaseTermination</span> <span class="variable">tpt</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TwoPhaseTermination</span>();</span><br><span class="line">    tpt.start();</span><br><span class="line">    Thread.sleep(<span class="number">3500</span>);</span><br><span class="line">    System.out.println(<span class="string">&quot;åœæ­¢ç›‘æ§&quot;</span>);</span><br><span class="line">    tpt.stop();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h4 id="Balking"><a href="#Balking" class="headerlink" title="Balking"></a>Balking</h4><p>Balking ï¼ˆçŠ¹è±«ï¼‰æ¨¡å¼ç”¨åœ¨ä¸€ä¸ªçº¿ç¨‹å‘ç°å¦ä¸€ä¸ªçº¿ç¨‹æˆ–æœ¬çº¿ç¨‹å·²ç»åšäº†æŸä¸€ä»¶ç›¸åŒçš„äº‹ï¼Œé‚£ä¹ˆæœ¬çº¿ç¨‹å°±æ— éœ€å†åšäº†ï¼Œç›´æ¥ç»“æŸè¿”å›</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MonitorService</span> &#123;</span><br><span class="line">    <span class="comment">// ç”¨æ¥è¡¨ç¤ºæ˜¯å¦å·²ç»æœ‰çº¿ç¨‹å·²ç»åœ¨æ‰§è¡Œå¯åŠ¨äº†</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">boolean</span> <span class="variable">starting</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;å°è¯•å¯åŠ¨ç›‘æ§çº¿ç¨‹...&quot;</span>);</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (starting) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            starting = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// çœŸæ­£å¯åŠ¨ç›‘æ§çº¿ç¨‹...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¹æ¯”ä¿æŠ¤æ€§æš‚åœæ¨¡å¼ï¼šä¿æŠ¤æ€§æš‚åœæ¨¡å¼ç”¨åœ¨ä¸€ä¸ªçº¿ç¨‹ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹çš„æ‰§è¡Œç»“æœï¼Œå½“æ¡ä»¶ä¸æ»¡è¶³æ—¶çº¿ç¨‹ç­‰å¾…</p><p>ä¾‹å­ï¼šå¸Œæœ› doInit() æ–¹æ³•ä»…è¢«è°ƒç”¨ä¸€æ¬¡ï¼Œä¸‹é¢çš„å®ç°å‡ºç°çš„é—®é¢˜ï¼š</p><ul><li>å½“ t1 çº¿ç¨‹è¿›å…¥ init() å‡†å¤‡ doInit()ï¼Œt2 çº¿ç¨‹è¿›æ¥ï¼Œinitialized è¿˜ä¸ºf alseï¼Œåˆ™ t2 å°±åˆåˆå§‹åŒ–ä¸€æ¬¡</li><li>volatile é€‚åˆä¸€ä¸ªçº¿ç¨‹å†™ï¼Œå…¶ä»–çº¿ç¨‹è¯»çš„æƒ…å†µï¼Œè¿™ä¸ªä»£ç éœ€è¦åŠ é”</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestVolatile</span> &#123;</span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">boolean</span> <span class="variable">initialized</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (initialized) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    doInit();</span><br><span class="line">    initialized = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doInit</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h2 id="æ— é”"><a href="#æ— é”" class="headerlink" title="æ— é”"></a>æ— é”</h2><h3 id="CAS"><a href="#CAS" class="headerlink" title="CAS"></a>CAS</h3><h4 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h4><p>æ— é”ç¼–ç¨‹ï¼šLock Free</p><p>CAS çš„å…¨ç§°æ˜¯ Compare-And-Swapï¼Œæ˜¯ <strong>CPU å¹¶å‘åŸè¯­</strong></p><ul><li>CAS å¹¶å‘åŸè¯­ä½“ç°åœ¨ Java è¯­è¨€ä¸­å°±æ˜¯ sun.misc.Unsafe ç±»çš„å„ä¸ªæ–¹æ³•ï¼Œè°ƒç”¨ UnSafe ç±»ä¸­çš„ CAS æ–¹æ³•ï¼ŒJVM ä¼šå®ç°å‡º CAS æ±‡ç¼–æŒ‡ä»¤ï¼Œè¿™æ˜¯ä¸€ç§å®Œå…¨ä¾èµ–äºç¡¬ä»¶çš„åŠŸèƒ½ï¼Œå®ç°äº†åŸå­æ“ä½œ</li><li>CAS æ˜¯ä¸€ç§ç³»ç»ŸåŸè¯­ï¼ŒåŸè¯­å±äºæ“ä½œç³»ç»ŸèŒƒç•´ï¼Œæ˜¯ç”±è‹¥å¹²æ¡æŒ‡ä»¤ç»„æˆ ï¼Œç”¨äºå®ŒæˆæŸä¸ªåŠŸèƒ½çš„ä¸€ä¸ªè¿‡ç¨‹ï¼Œå¹¶ä¸”åŸè¯­çš„æ‰§è¡Œå¿…é¡»æ˜¯è¿ç»­çš„ï¼Œæ‰§è¡Œè¿‡ç¨‹ä¸­ä¸å…è®¸è¢«ä¸­æ–­ï¼Œæ‰€ä»¥ CAS æ˜¯ä¸€æ¡ CPU çš„åŸå­æŒ‡ä»¤ï¼Œä¸ä¼šé€ æˆæ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ï¼Œæ˜¯çº¿ç¨‹å®‰å…¨çš„</li></ul><p>åº•å±‚åŸç†ï¼šCAS çš„åº•å±‚æ˜¯ <code>lock cmpxchg</code> æŒ‡ä»¤ï¼ˆX86 æ¶æ„ï¼‰ï¼Œåœ¨å•æ ¸å’Œå¤šæ ¸ CPU ä¸‹éƒ½èƒ½å¤Ÿä¿è¯æ¯”è¾ƒäº¤æ¢çš„åŸå­æ€§</p><ul><li><p>ç¨‹åºæ˜¯åœ¨å•æ ¸å¤„ç†å™¨ä¸Šè¿è¡Œï¼Œä¼šçœç•¥ lock å‰ç¼€ï¼Œå•å¤„ç†å™¨è‡ªèº«ä¼šç»´æŠ¤å¤„ç†å™¨å†…çš„é¡ºåºä¸€è‡´æ€§ï¼Œä¸éœ€è¦ lock å‰ç¼€çš„å†…å­˜å±éšœæ•ˆæœ</p></li><li><p>ç¨‹åºæ˜¯åœ¨å¤šæ ¸å¤„ç†å™¨ä¸Šè¿è¡Œï¼Œä¼šä¸º cmpxchg æŒ‡ä»¤åŠ ä¸Š lock å‰ç¼€ã€‚å½“æŸä¸ªæ ¸æ‰§è¡Œåˆ°å¸¦ lock çš„æŒ‡ä»¤æ—¶ï¼ŒCPU ä¼šæ‰§è¡Œ<strong>æ€»çº¿é”å®šæˆ–ç¼“å­˜é”å®š</strong>ï¼Œå°†ä¿®æ”¹çš„å˜é‡å†™å…¥åˆ°ä¸»å­˜ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸ä¼šè¢«çº¿ç¨‹çš„è°ƒåº¦æœºåˆ¶æ‰€æ‰“æ–­ï¼Œä¿è¯äº†å¤šä¸ªçº¿ç¨‹å¯¹å†…å­˜æ“ä½œçš„åŸå­æ€§</p></li></ul><p>ä½œç”¨ï¼šæ¯”è¾ƒå½“å‰å·¥ä½œå†…å­˜ä¸­çš„å€¼å’Œä¸»ç‰©ç†å†…å­˜ä¸­çš„å€¼ï¼Œå¦‚æœç›¸åŒåˆ™æ‰§è¡Œè§„å®šæ“ä½œï¼Œå¦åˆ™ç»§ç»­æ¯”è¾ƒç›´åˆ°ä¸»å†…å­˜å’Œå·¥ä½œå†…å­˜çš„å€¼ä¸€è‡´ä¸ºæ­¢</p><p>CAS ç‰¹ç‚¹ï¼š</p><ul><li>CAS ä½“ç°çš„æ˜¯<strong>æ— é”å¹¶å‘ã€æ— é˜»å¡å¹¶å‘</strong>ï¼Œçº¿ç¨‹ä¸ä¼šé™·å…¥é˜»å¡ï¼Œçº¿ç¨‹ä¸éœ€è¦é¢‘ç¹åˆ‡æ¢çŠ¶æ€ï¼ˆä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œç³»ç»Ÿè°ƒç”¨ï¼‰</li><li>CAS æ˜¯åŸºäºä¹è§‚é”çš„æ€æƒ³</li></ul><p>CAS ç¼ºç‚¹ï¼š</p><ul><li>æ‰§è¡Œçš„æ˜¯å¾ªç¯æ“ä½œï¼Œå¦‚æœæ¯”è¾ƒä¸æˆåŠŸä¸€ç›´åœ¨å¾ªç¯ï¼Œæœ€å·®çš„æƒ…å†µæŸä¸ªçº¿ç¨‹ä¸€ç›´å–åˆ°çš„å€¼å’Œé¢„æœŸå€¼éƒ½ä¸ä¸€æ ·ï¼Œå°±ä¼šæ— é™å¾ªç¯å¯¼è‡´é¥¥é¥¿ï¼Œ<strong>ä½¿ç”¨ CAS çº¿ç¨‹æ•°ä¸è¦è¶…è¿‡ CPU çš„æ ¸å¿ƒæ•°</strong>ï¼Œé‡‡ç”¨åˆ†æ®µ CAS å’Œè‡ªåŠ¨è¿ç§»æœºåˆ¶</li><li>åªèƒ½ä¿è¯ä¸€ä¸ªå…±äº«å˜é‡çš„åŸå­æ“ä½œ<ul><li>å¯¹äºä¸€ä¸ªå…±äº«å˜é‡æ‰§è¡Œæ“ä½œæ—¶ï¼Œå¯ä»¥é€šè¿‡å¾ªç¯ CAS çš„æ–¹å¼æ¥ä¿è¯åŸå­æ“ä½œ</li><li>å¯¹äºå¤šä¸ªå…±äº«å˜é‡æ“ä½œæ—¶ï¼Œå¾ªç¯ CAS å°±æ— æ³•ä¿è¯æ“ä½œçš„åŸå­æ€§ï¼Œè¿™ä¸ªæ—¶å€™<strong>åªèƒ½ç”¨é”æ¥ä¿è¯åŸå­æ€§</strong></li></ul></li><li>å¼•å‡ºæ¥ ABA é—®é¢˜</li></ul><hr><h4 id="ä¹è§‚é”"><a href="#ä¹è§‚é”" class="headerlink" title="ä¹è§‚é”"></a>ä¹è§‚é”</h4><p>CAS ä¸ synchronized æ€»ç»“ï¼š</p><ul><li>synchronized æ˜¯ä»æ‚²è§‚çš„è§’åº¦å‡ºå‘ï¼šæ€»æ˜¯å‡è®¾æœ€åçš„æƒ…å†µï¼Œæ¯æ¬¡å»æ‹¿æ•°æ®çš„æ—¶å€™éƒ½è®¤ä¸ºåˆ«äººä¼šä¿®æ”¹ï¼Œæ‰€ä»¥æ¯æ¬¡åœ¨æ‹¿æ•°æ®çš„æ—¶å€™éƒ½ä¼šä¸Šé”ï¼Œè¿™æ ·åˆ«äººæƒ³æ‹¿è¿™ä¸ªæ•°æ®å°±ä¼šé˜»å¡ï¼ˆå…±äº«èµ„æºæ¯æ¬¡åªç»™ä¸€ä¸ªçº¿ç¨‹ä½¿ç”¨ï¼Œå…¶å®ƒçº¿ç¨‹é˜»å¡ï¼Œç”¨å®Œåå†æŠŠèµ„æºè½¬è®©ç»™å…¶å®ƒçº¿ç¨‹ï¼‰ï¼Œå› æ­¤ synchronized ä¹Ÿç§°ä¹‹ä¸ºæ‚²è§‚é”ï¼ŒReentrantLock ä¹Ÿæ˜¯ä¸€ç§æ‚²è§‚é”ï¼Œæ€§èƒ½è¾ƒå·®</li><li>CAS æ˜¯ä»ä¹è§‚çš„è§’åº¦å‡ºå‘ï¼šæ€»æ˜¯å‡è®¾æœ€å¥½çš„æƒ…å†µï¼Œæ¯æ¬¡å»æ‹¿æ•°æ®çš„æ—¶å€™éƒ½è®¤ä¸ºåˆ«äººä¸ä¼šä¿®æ”¹ï¼Œæ‰€ä»¥ä¸ä¼šä¸Šé”ï¼Œä½†æ˜¯åœ¨æ›´æ–°çš„æ—¶å€™ä¼šåˆ¤æ–­ä¸€ä¸‹åœ¨æ­¤æœŸé—´åˆ«äººæœ‰æ²¡æœ‰å»æ›´æ–°è¿™ä¸ªæ•°æ®ã€‚<strong>å¦‚æœåˆ«äººä¿®æ”¹è¿‡ï¼Œåˆ™è·å–ç°åœ¨æœ€æ–°çš„å€¼ï¼Œå¦‚æœåˆ«äººæ²¡ä¿®æ”¹è¿‡ï¼Œç›´æ¥ä¿®æ”¹å…±äº«æ•°æ®çš„å€¼</strong>ï¼ŒCAS è¿™ç§æœºåˆ¶ä¹Ÿç§°ä¹‹ä¸ºä¹è§‚é”ï¼Œç»¼åˆæ€§èƒ½è¾ƒå¥½</li></ul><hr><h3 id="Atomic"><a href="#Atomic" class="headerlink" title="Atomic"></a>Atomic</h3><h4 id="å¸¸ç”¨API"><a href="#å¸¸ç”¨API" class="headerlink" title="å¸¸ç”¨API"></a>å¸¸ç”¨API</h4><p>å¸¸è§åŸå­ç±»ï¼šAtomicIntegerã€AtomicBooleanã€AtomicLong</p><p>æ„é€ æ–¹æ³•ï¼š</p><ul><li><code>public AtomicInteger()</code>ï¼šåˆå§‹åŒ–ä¸€ä¸ªé»˜è®¤å€¼ä¸º 0 çš„åŸå­å‹ Integer</li><li><code>public AtomicInteger(int initialValue)</code>ï¼šåˆå§‹åŒ–ä¸€ä¸ªæŒ‡å®šå€¼çš„åŸå­å‹ Integer</li></ul><p>å¸¸ç”¨APIï¼š</p><table><thead><tr><th>æ–¹æ³•</th><th>ä½œç”¨</th></tr></thead><tbody><tr><td>public final int get()</td><td>è·å– AtomicInteger çš„å€¼</td></tr><tr><td>public final int getAndIncrement()</td><td>ä»¥åŸå­æ–¹å¼å°†å½“å‰å€¼åŠ  1ï¼Œè¿”å›çš„æ˜¯è‡ªå¢å‰çš„å€¼</td></tr><tr><td>public final int incrementAndGet()</td><td>ä»¥åŸå­æ–¹å¼å°†å½“å‰å€¼åŠ  1ï¼Œè¿”å›çš„æ˜¯è‡ªå¢åçš„å€¼</td></tr><tr><td>public final int getAndSet(int value)</td><td>ä»¥åŸå­æ–¹å¼è®¾ç½®ä¸º newValue çš„å€¼ï¼Œè¿”å›æ—§å€¼</td></tr><tr><td>public final int addAndGet(int data)</td><td>ä»¥åŸå­æ–¹å¼å°†è¾“å…¥çš„æ•°å€¼ä¸å®ä¾‹ä¸­çš„å€¼ç›¸åŠ å¹¶è¿”å›<br />å®ä¾‹ï¼šAtomicInteger é‡Œçš„ value</td></tr></tbody></table><hr><h4 id="åŸç†åˆ†æ"><a href="#åŸç†åˆ†æ" class="headerlink" title="åŸç†åˆ†æ"></a>åŸç†åˆ†æ</h4><p><strong>AtomicInteger åŸç†</strong>ï¼šè‡ªæ—‹é”  + CAS ç®—æ³•</p><p>CAS ç®—æ³•ï¼šæœ‰ 3 ä¸ªæ“ä½œæ•°ï¼ˆå†…å­˜å€¼ Vï¼Œ æ—§çš„é¢„æœŸå€¼ Aï¼Œè¦ä¿®æ”¹çš„å€¼ Bï¼‰</p><ul><li>å½“æ—§çš„é¢„æœŸå€¼ A &#x3D;&#x3D; å†…å­˜å€¼ V   æ­¤æ—¶å¯ä»¥ä¿®æ”¹ï¼Œå°† V æ”¹ä¸º B</li><li>å½“æ—§çš„é¢„æœŸå€¼ A !&#x3D;  å†…å­˜å€¼ V   æ­¤æ—¶ä¸èƒ½ä¿®æ”¹ï¼Œå¹¶é‡æ–°è·å–ç°åœ¨çš„æœ€æ–°å€¼ï¼Œé‡æ–°è·å–çš„åŠ¨ä½œå°±æ˜¯è‡ªæ—‹</li></ul><p>åˆ†æ getAndSet æ–¹æ³•ï¼š</p><ul><li><p>AtomicIntegerï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">getAndSet</span><span class="params">(<span class="type">int</span> newValue)</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * this: å½“å‰å¯¹è±¡</span></span><br><span class="line"><span class="comment">    * valueOffset:å†…å­˜åç§»é‡ï¼Œå†…å­˜åœ°å€</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">return</span> unsafe.getAndSetInt(<span class="built_in">this</span>, valueOffset, newValue);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>valueOffsetï¼šåç§»é‡è¡¨ç¤ºè¯¥å˜é‡å€¼ç›¸å¯¹äºå½“å‰å¯¹è±¡åœ°å€çš„åç§»ï¼ŒUnsafe å°±æ˜¯æ ¹æ®å†…å­˜åç§»åœ°å€è·å–æ•°æ®</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">valueOffset = unsafe.objectFieldOffset</span><br><span class="line">                (AtomicInteger.class.getDeclaredField(<span class="string">&quot;value&quot;</span>));</span><br><span class="line"><span class="comment">//è°ƒç”¨æœ¬åœ°æ–¹æ³•   --&gt;</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">native</span> <span class="type">long</span> <span class="title function_">objectFieldOffset</span><span class="params">(Field var1)</span>;</span><br></pre></td></tr></table></figure></li><li><p>unsafe ç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// val1: AtomicIntegerå¯¹è±¡æœ¬èº«ï¼Œvar2: è¯¥å¯¹è±¡å€¼å¾—å¼•ç”¨åœ°å€ï¼Œvar4: éœ€è¦å˜åŠ¨çš„æ•°</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">getAndSetInt</span><span class="params">(Object var1, <span class="type">long</span> var2, <span class="type">int</span> var4)</span> &#123;</span><br><span class="line">    <span class="type">int</span> var5;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">// var5: ç”¨ var1 å’Œ var2 æ‰¾åˆ°çš„å†…å­˜ä¸­çš„çœŸå®å€¼</span></span><br><span class="line">        var5 = <span class="built_in">this</span>.getIntVolatile(var1, var2);</span><br><span class="line">    &#125; <span class="keyword">while</span>(!<span class="built_in">this</span>.compareAndSwapInt(var1, var2, var5, var4));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> var5;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>var5ï¼šä»ä¸»å†…å­˜ä¸­æ‹·è´åˆ°å·¥ä½œå†…å­˜ä¸­çš„å€¼ï¼ˆæ¯æ¬¡éƒ½è¦ä»ä¸»å†…å­˜æ‹¿åˆ°æœ€æ–°çš„å€¼åˆ°æœ¬åœ°å†…å­˜ï¼‰ï¼Œç„¶åæ‰§è¡Œ <code>compareAndSwapInt()</code> å†å’Œä¸»å†…å­˜çš„å€¼è¿›è¡Œæ¯”è¾ƒï¼Œå‡è®¾æ–¹æ³•è¿”å› falseï¼Œé‚£ä¹ˆå°±ä¸€ç›´æ‰§è¡Œ while æ–¹æ³•ï¼Œç›´åˆ°æœŸæœ›çš„å€¼å’ŒçœŸå®å€¼ä¸€æ ·ï¼Œä¿®æ”¹æ•°æ®</p></li><li><p>å˜é‡ value ç”¨ volatile ä¿®é¥°ï¼Œä¿è¯äº†å¤šçº¿ç¨‹ä¹‹é—´çš„å†…å­˜å¯è§æ€§ï¼Œé¿å…çº¿ç¨‹ä»å·¥ä½œç¼“å­˜ä¸­è·å–å¤±æ•ˆçš„å˜é‡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">int</span> value</span><br></pre></td></tr></table></figure><p><strong>CAS å¿…é¡»å€ŸåŠ© volatile æ‰èƒ½è¯»å–åˆ°å…±äº«å˜é‡çš„æœ€æ–°å€¼æ¥å®ç°æ¯”è¾ƒå¹¶äº¤æ¢çš„æ•ˆæœ</strong></p></li></ul><p>åˆ†æ getAndUpdate æ–¹æ³•ï¼š</p><ul><li><p>getAndUpdateï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">getAndUpdate</span><span class="params">(IntUnaryOperator updateFunction)</span> &#123;</span><br><span class="line">    <span class="type">int</span> prev, next;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        prev = get();<span class="comment">//å½“å‰å€¼ï¼Œcasçš„æœŸæœ›å€¼</span></span><br><span class="line">        next = updateFunction.applyAsInt(prev);<span class="comment">//æœŸæœ›å€¼æ›´æ–°åˆ°è¯¥å€¼</span></span><br><span class="line">    &#125; <span class="keyword">while</span> (!compareAndSet(prev, next));<span class="comment">//è‡ªæ—‹</span></span><br><span class="line">    <span class="keyword">return</span> prev;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‡½æ•°å¼æ¥å£ï¼šå¯ä»¥è‡ªå®šä¹‰æ“ä½œé€»è¾‘</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">AtomicInteger</span> <span class="variable">a</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>();</span><br><span class="line">a.getAndUpdate(i -&gt; i + <span class="number">10</span>);</span><br></pre></td></tr></table></figure></li><li><p>compareAndSetï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">compareAndSet</span><span class="params">(<span class="type">int</span> expect, <span class="type">int</span> update)</span> &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * this: å½“å‰å¯¹è±¡</span></span><br><span class="line"><span class="comment">    * valueOffset:å†…å­˜åç§»é‡ï¼Œå†…å­˜åœ°å€</span></span><br><span class="line"><span class="comment">    * expect:æœŸæœ›çš„å€¼</span></span><br><span class="line"><span class="comment">    * update: æ›´æ–°çš„å€¼</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">return</span> unsafe.compareAndSwapInt(<span class="built_in">this</span>, valueOffset, expect, update);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><hr><h4 id="åŸå­å¼•ç”¨"><a href="#åŸå­å¼•ç”¨" class="headerlink" title="åŸå­å¼•ç”¨"></a>åŸå­å¼•ç”¨</h4><p>åŸå­å¼•ç”¨ï¼šå¯¹ Object è¿›è¡ŒåŸå­æ“ä½œï¼Œæä¾›ä¸€ç§è¯»å’Œå†™éƒ½æ˜¯åŸå­æ€§çš„å¯¹è±¡å¼•ç”¨å˜é‡</p><p>åŸå­å¼•ç”¨ç±»ï¼šAtomicReferenceã€AtomicStampedReferenceã€AtomicMarkableReference</p><p>AtomicReference ç±»ï¼š</p><ul><li><p>æ„é€ æ–¹æ³•ï¼š<code>AtomicReference&lt;T&gt; atomicReference = new AtomicReference&lt;T&gt;()</code></p></li><li><p>å¸¸ç”¨ APIï¼š</p><ul><li><code>public final boolean compareAndSet(V expectedValue, V newValue)</code>ï¼šCAS æ“ä½œ</li><li><code>public final void set(V newValue)</code>ï¼šå°†å€¼è®¾ç½®ä¸º newValue </li><li><code>public final V get()</code>ï¼šè¿”å›å½“å‰å€¼</li></ul></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AtomicReferenceDemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Student</span> <span class="variable">s1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="number">33</span>, <span class="string">&quot;z3&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// åˆ›å»ºåŸå­å¼•ç”¨åŒ…è£…ç±»</span></span><br><span class="line">        AtomicReference&lt;Student&gt; atomicReference = <span class="keyword">new</span> <span class="title class_">AtomicReference</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">// è®¾ç½®ä¸»å†…å­˜å…±äº«å˜é‡ä¸ºs1</span></span><br><span class="line">        atomicReference.set(s1);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ¯”è¾ƒå¹¶äº¤æ¢ï¼Œå¦‚æœç°åœ¨ä¸»ç‰©ç†å†…å­˜çš„å€¼ä¸º z3ï¼Œé‚£ä¹ˆäº¤æ¢æˆ l4</span></span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="type">Student</span> <span class="variable">s2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Student</span>(<span class="number">44</span>, <span class="string">&quot;l4&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (atomicReference.compareAndSet(s1, s2)) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(atomicReference.get());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Student</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="comment">//ã€‚ã€‚ã€‚ã€‚</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h4 id="åŸå­æ•°ç»„"><a href="#åŸå­æ•°ç»„" class="headerlink" title="åŸå­æ•°ç»„"></a>åŸå­æ•°ç»„</h4><p>åŸå­æ•°ç»„ç±»ï¼šAtomicIntegerArrayã€AtomicLongArrayã€AtomicReferenceArray</p><p>AtomicIntegerArray ç±»æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">*   ithe index</span></span><br><span class="line"><span class="comment">* expect the expected value</span></span><br><span class="line"><span class="comment">* update the new value</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">compareAndSet</span><span class="params">(<span class="type">int</span> i, <span class="type">int</span> expect, <span class="type">int</span> update)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> compareAndSetRaw(checkedByteOffset(i), expect, update);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h4 id="åŸå­æ›´æ–°å™¨"><a href="#åŸå­æ›´æ–°å™¨" class="headerlink" title="åŸå­æ›´æ–°å™¨"></a>åŸå­æ›´æ–°å™¨</h4><p>åŸå­æ›´æ–°å™¨ç±»ï¼šAtomicReferenceFieldUpdaterã€AtomicIntegerFieldUpdaterã€AtomicLongFieldUpdater</p><p>åˆ©ç”¨å­—æ®µæ›´æ–°å™¨ï¼Œå¯ä»¥é’ˆå¯¹å¯¹è±¡çš„æŸä¸ªåŸŸï¼ˆFieldï¼‰è¿›è¡ŒåŸå­æ“ä½œï¼Œåªèƒ½é…åˆ volatile ä¿®é¥°çš„å­—æ®µä½¿ç”¨ï¼Œå¦åˆ™ä¼šå‡ºç°å¼‚å¸¸ <code>IllegalArgumentException: Must be volatile type</code></p><p>å¸¸ç”¨ APIï¼š</p><ul><li><code>static &lt;U&gt; AtomicIntegerFieldUpdater&lt;U&gt; newUpdater(Class&lt;U&gt; c, String fieldName)</code>ï¼šæ„é€ æ–¹æ³•</li><li><code>abstract boolean compareAndSet(T obj, int expect, int update)</code>ï¼šCAS</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UpdateDemo</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">int</span> field;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">AtomicIntegerFieldUpdater</span> <span class="variable">fieldUpdater</span> <span class="operator">=</span> AtomicIntegerFieldUpdater</span><br><span class="line">            .newUpdater(UpdateDemo.class, <span class="string">&quot;field&quot;</span>);</span><br><span class="line">        <span class="type">UpdateDemo</span> <span class="variable">updateDemo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UpdateDemo</span>();</span><br><span class="line">        fieldUpdater.compareAndSet(updateDemo, <span class="number">0</span>, <span class="number">10</span>);</span><br><span class="line">        System.out.println(updateDemo.field);<span class="comment">//10</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h4 id="åŸå­ç´¯åŠ å™¨"><a href="#åŸå­ç´¯åŠ å™¨" class="headerlink" title="åŸå­ç´¯åŠ å™¨"></a>åŸå­ç´¯åŠ å™¨</h4><p>åŸå­ç´¯åŠ å™¨ç±»ï¼šLongAdderã€DoubleAdderã€LongAccumulatorã€DoubleAccumulator </p><p>LongAdder å’Œ LongAccumulator åŒºåˆ«ï¼š</p><p>ç›¸åŒç‚¹ï¼š</p><ul><li>LongAddr ä¸ LongAccumulator ç±»éƒ½æ˜¯ä½¿ç”¨éé˜»å¡ç®—æ³• CAS å®ç°çš„</li><li>LongAddr ç±»æ˜¯ LongAccumulator ç±»çš„ä¸€ä¸ªç‰¹ä¾‹ï¼Œåªæ˜¯ LongAccumulator æä¾›äº†æ›´å¼ºå¤§çš„åŠŸèƒ½ï¼Œå¯ä»¥è‡ªå®šä¹‰ç´¯åŠ è§„åˆ™ï¼Œå½“accumulatorFunction ä¸º null æ—¶å°±ç­‰ä»·äº LongAddr</li></ul><p>ä¸åŒç‚¹ï¼š</p><ul><li><p>è°ƒç”¨ casBase æ—¶ï¼ŒLongAccumulator ä½¿ç”¨ function.applyAsLong(b &#x3D; base, x) æ¥è®¡ç®—ï¼ŒLongAddr ä½¿ç”¨ casBase(b &#x3D; base, b + x) </p></li><li><p>LongAccumulator ç±»åŠŸèƒ½æ›´åŠ å¼ºå¤§ï¼Œæ„é€ æ–¹æ³•å‚æ•°ä¸­</p><ul><li>accumulatorFunction æ˜¯ä¸€ä¸ªåŒç›®è¿ç®—å™¨æ¥å£ï¼Œå¯ä»¥æŒ‡å®šç´¯åŠ è§„åˆ™ï¼Œæ¯”å¦‚ç´¯åŠ æˆ–è€…ç›¸ä¹˜ï¼Œå…¶æ ¹æ®è¾“å…¥çš„ä¸¤ä¸ªå‚æ•°è¿”å›ä¸€ä¸ªè®¡ç®—å€¼ï¼ŒLongAdder å†…ç½®ç´¯åŠ è§„åˆ™</li><li>identity åˆ™æ˜¯ LongAccumulator ç´¯åŠ å™¨çš„åˆå§‹å€¼ï¼ŒLongAccumulator å¯ä»¥ä¸ºç´¯åŠ å™¨æä¾›é0çš„åˆå§‹å€¼ï¼Œè€Œ LongAdder åªèƒ½æä¾›é»˜è®¤çš„ 0</li></ul></li></ul><hr><h3 id="Adder"><a href="#Adder" class="headerlink" title="Adder"></a>Adder</h3><h4 id="ä¼˜åŒ–æœºåˆ¶"><a href="#ä¼˜åŒ–æœºåˆ¶" class="headerlink" title="ä¼˜åŒ–æœºåˆ¶"></a>ä¼˜åŒ–æœºåˆ¶</h4><p>LongAdder æ˜¯ Java8 æä¾›çš„ç±»ï¼Œè·Ÿ AtomicLong æœ‰ç›¸åŒçš„æ•ˆæœï¼Œä½†å¯¹ CAS æœºåˆ¶è¿›è¡Œäº†ä¼˜åŒ–ï¼Œå°è¯•ä½¿ç”¨åˆ†æ®µ CAS ä»¥åŠè‡ªåŠ¨åˆ†æ®µè¿ç§»çš„æ–¹å¼æ¥å¤§å¹…åº¦æå‡å¤šçº¿ç¨‹é«˜å¹¶å‘æ‰§è¡Œ CAS æ“ä½œçš„æ€§èƒ½</p><p>CAS åº•å±‚å®ç°æ˜¯åœ¨ä¸€ä¸ªå¾ªç¯ä¸­ä¸æ–­åœ°å°è¯•ä¿®æ”¹ç›®æ ‡å€¼ï¼Œç›´åˆ°ä¿®æ”¹æˆåŠŸã€‚å¦‚æœç«äº‰ä¸æ¿€çƒˆä¿®æ”¹æˆåŠŸç‡å¾ˆé«˜ï¼Œå¦åˆ™å¤±è´¥ç‡å¾ˆé«˜ï¼Œå¤±è´¥åè¿™äº›é‡å¤çš„åŸå­æ€§æ“ä½œä¼šè€—è´¹æ€§èƒ½ï¼ˆå¯¼è‡´å¤§é‡çº¿ç¨‹<strong>ç©ºå¾ªç¯ï¼Œè‡ªæ—‹è½¬</strong>ï¼‰</p><p>ä¼˜åŒ–æ ¸å¿ƒæ€æƒ³ï¼šæ•°æ®åˆ†ç¦»ï¼Œå°† AtomicLong çš„<strong>å•ç‚¹çš„æ›´æ–°å‹åŠ›åˆ†æ‹…åˆ°å„ä¸ªèŠ‚ç‚¹ï¼Œç©ºé—´æ¢æ—¶é—´</strong>ï¼Œåœ¨ä½å¹¶å‘çš„æ—¶å€™ç›´æ¥æ›´æ–°ï¼Œå¯ä»¥ä¿éšœå’Œ AtomicLong çš„æ€§èƒ½åŸºæœ¬ä¸€è‡´ï¼Œè€Œåœ¨é«˜å¹¶å‘çš„æ—¶å€™é€šè¿‡åˆ†æ•£å‡å°‘ç«äº‰ï¼Œæé«˜äº†æ€§èƒ½</p><p><strong>åˆ†æ®µ CAS æœºåˆ¶</strong>ï¼š</p><ul><li>åœ¨å‘ç”Ÿç«äº‰æ—¶ï¼Œåˆ›å»º Cell æ•°ç»„ç”¨äºå°†ä¸åŒçº¿ç¨‹çš„æ“ä½œç¦»æ•£ï¼ˆé€šè¿‡ hash ç­‰ç®—æ³•æ˜ å°„ï¼‰åˆ°ä¸åŒçš„èŠ‚ç‚¹ä¸Š</li><li>è®¾ç½®å¤šä¸ªç´¯åŠ å•å…ƒï¼ˆä¼šæ ¹æ®éœ€è¦æ‰©å®¹ï¼Œæœ€å¤§ä¸º CPU æ ¸æ•°ï¼‰ï¼ŒTherad-0 ç´¯åŠ  Cell[0]ï¼Œè€Œ Thread-1 ç´¯åŠ  Cell[1] ç­‰ï¼Œæœ€åå°†ç»“æœæ±‡æ€»</li><li>åœ¨ç´¯åŠ æ—¶æ“ä½œçš„ä¸åŒçš„ Cell å˜é‡ï¼Œå› æ­¤å‡å°‘äº† CAS é‡è¯•å¤±è´¥ï¼Œä»è€Œæé«˜æ€§èƒ½</li></ul><p><strong>è‡ªåŠ¨åˆ†æ®µè¿ç§»æœºåˆ¶</strong>ï¼šæŸä¸ª Cell çš„ value æ‰§è¡Œ CAS å¤±è´¥ï¼Œå°±ä¼šè‡ªåŠ¨å¯»æ‰¾å¦ä¸€ä¸ª Cell åˆ†æ®µå†…çš„ value å€¼è¿›è¡Œ CAS æ“ä½œ</p><hr><h4 id="ä¼ªå…±äº«-1"><a href="#ä¼ªå…±äº«-1" class="headerlink" title="ä¼ªå…±äº«"></a>ä¼ªå…±äº«</h4><p>Cell ä¸ºç´¯åŠ å•å…ƒï¼šæ•°ç»„è®¿é—®ç´¢å¼•æ˜¯é€šè¿‡ Thread é‡Œçš„ threadLocalRandomProbe åŸŸå–æ¨¡å®ç°çš„ï¼Œè¿™ä¸ªåŸŸæ˜¯ ThreadLocalRandom æ›´æ–°çš„</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Striped64.Cell</span></span><br><span class="line"><span class="meta">@sun</span>.misc.Contended <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Cell</span> &#123;</span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">long</span> value;</span><br><span class="line">    Cell(<span class="type">long</span> x) &#123; value = x; &#125;</span><br><span class="line">    <span class="comment">// ç”¨ cas æ–¹å¼è¿›è¡Œç´¯åŠ , prev è¡¨ç¤ºæ—§å€¼, next è¡¨ç¤ºæ–°å€¼</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">cas</span><span class="params">(<span class="type">long</span> prev, <span class="type">long</span> next)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> UNSAFE.compareAndSwapLong(<span class="built_in">this</span>, valueOffset, prev, next);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// çœç•¥ä¸é‡è¦ä»£ç </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Cell æ˜¯æ•°ç»„å½¢å¼ï¼Œ<strong>åœ¨å†…å­˜ä¸­æ˜¯è¿ç»­å­˜å‚¨çš„</strong>ï¼Œ64 ä½ç³»ç»Ÿä¸­ï¼Œä¸€ä¸ª Cell ä¸º 24 å­—èŠ‚ï¼ˆ16 å­—èŠ‚çš„å¯¹è±¡å¤´å’Œ 8 å­—èŠ‚çš„ valueï¼‰ï¼Œæ¯ä¸€ä¸ª cache line ä¸º 64 å­—èŠ‚ï¼Œå› æ­¤ç¼“å­˜è¡Œå¯ä»¥å­˜ä¸‹ 2 ä¸ªçš„ Cell å¯¹è±¡ï¼Œå½“ Core-0 è¦ä¿®æ”¹ Cell[0]ã€Core-1 è¦ä¿®æ”¹ Cell[1]ï¼Œæ— è®ºè°ä¿®æ”¹æˆåŠŸéƒ½ä¼šå¯¼è‡´å½“å‰ç¼“å­˜è¡Œå¤±æ•ˆï¼Œä»è€Œå¯¼è‡´å¯¹æ–¹çš„æ•°æ®å¤±æ•ˆï¼Œéœ€è¦é‡æ–°å»ä¸»å­˜è·å–ï¼Œå½±å“æ•ˆç‡</p><p><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/JUC-%E4%BC%AA%E5%85%B1%E4%BA%AB1.png"></p><p>@sun.misc.Contendedï¼šé˜²æ­¢ç¼“å­˜è¡Œä¼ªå…±äº«ï¼Œåœ¨ä½¿ç”¨æ­¤æ³¨è§£çš„å¯¹è±¡æˆ–å­—æ®µçš„å‰åå„å¢åŠ  128 å­—èŠ‚å¤§å°çš„ paddingï¼Œä½¿ç”¨ 2 å€äºå¤§å¤šæ•°ç¡¬ä»¶ç¼“å­˜è¡Œè®© CPU å°†å¯¹è±¡é¢„è¯»è‡³ç¼“å­˜æ—¶<strong>å ç”¨ä¸åŒçš„ç¼“å­˜è¡Œ</strong>ï¼Œè¿™æ ·å°±ä¸ä¼šé€ æˆå¯¹æ–¹ç¼“å­˜è¡Œçš„å¤±æ•ˆ</p><p><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/JUC-%E4%BC%AA%E5%85%B1%E4%BA%AB2.png"></p><hr><h4 id="æºç è§£æ"><a href="#æºç è§£æ" class="headerlink" title="æºç è§£æ"></a>æºç è§£æ</h4><p>Striped64 ç±»æˆå‘˜å±æ€§ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¡¨ç¤ºå½“å‰è®¡ç®—æœºCPUæ•°é‡</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">NCPU</span> <span class="operator">=</span> Runtime.getRuntime().availableProcessors()</span><br><span class="line"><span class="comment">// ç´¯åŠ å•å…ƒæ•°ç»„, æ‡’æƒ°åˆå§‹åŒ–</span></span><br><span class="line"><span class="keyword">transient</span> <span class="keyword">volatile</span> Cell[] cells;</span><br><span class="line"><span class="comment">// åŸºç¡€å€¼, å¦‚æœæ²¡æœ‰ç«äº‰, åˆ™ç”¨ cas ç´¯åŠ è¿™ä¸ªåŸŸï¼Œå½“ cells æ‰©å®¹æ—¶ï¼Œä¹Ÿä¼šå°†æ•°æ®å†™åˆ° base ä¸­</span></span><br><span class="line"><span class="keyword">transient</span> <span class="keyword">volatile</span> <span class="type">long</span> base;</span><br><span class="line"><span class="comment">// åœ¨ cells åˆå§‹åŒ–æˆ–æ‰©å®¹æ—¶åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œ, é€šè¿‡ CAS æ›´æ–° cellsBusy ç½®ä¸º 1 æ¥å®ç°ä¸€ä¸ªé”</span></span><br><span class="line"><span class="keyword">transient</span> <span class="keyword">volatile</span> <span class="type">int</span> cellsBusy;</span><br></pre></td></tr></table></figure><p>å·¥ä½œæµç¨‹ï¼š</p><ul><li><p>cells å ç”¨å†…å­˜æ˜¯ç›¸å¯¹æ¯”è¾ƒå¤§çš„ï¼Œæ˜¯æƒ°æ€§åŠ è½½çš„ï¼Œåœ¨æ— ç«äº‰æˆ–è€…å…¶ä»–çº¿ç¨‹æ­£åœ¨åˆå§‹åŒ– cells æ•°ç»„çš„æƒ…å†µä¸‹ï¼Œç›´æ¥æ›´æ–° base åŸŸ</p></li><li><p>åœ¨ç¬¬ä¸€æ¬¡å‘ç”Ÿç«äº‰æ—¶ï¼ˆcasBase å¤±è´¥ï¼‰ä¼šåˆ›å»ºä¸€ä¸ªå¤§å°ä¸º 2 çš„ cells æ•°ç»„ï¼Œå°†å½“å‰ç´¯åŠ çš„å€¼åŒ…è£…ä¸º Cell å¯¹è±¡ï¼Œæ”¾å…¥æ˜ å°„çš„æ§½ä½ä¸Š</p></li><li><p>åˆ†æ®µç´¯åŠ çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœå½“å‰çº¿ç¨‹å¯¹åº”çš„ cells æ§½ä½ä¸ºç©ºï¼Œå°±ä¼šæ–°å»º Cell å¡«å……ï¼Œå¦‚æœå‡ºç°ç«äº‰ï¼Œå°±ä¼šé‡æ–°è®¡ç®—çº¿ç¨‹å¯¹åº”çš„æ§½ä½ï¼Œç»§ç»­è‡ªæ—‹å°è¯•ä¿®æ”¹</p></li><li><p>åˆ†æ®µè¿ç§»åè¿˜å‡ºç°ç«äº‰å°±ä¼šæ‰©å®¹ cells æ•°ç»„é•¿åº¦ä¸ºåŸæ¥çš„ä¸¤å€ï¼Œç„¶å rehashï¼Œ<strong>æ•°ç»„é•¿åº¦æ€»æ˜¯ 2 çš„ n æ¬¡å¹‚</strong>ï¼Œé»˜è®¤æœ€å¤§ä¸º CPU æ ¸æ•°ï¼Œä½†æ˜¯å¯ä»¥è¶…è¿‡ï¼Œå¦‚æœæ ¸æ•°æ˜¯ 6 æ ¸ï¼Œæ•°ç»„æœ€é•¿æ˜¯ 8</p></li></ul><p>æ–¹æ³•åˆ†æï¼š</p><ul><li><p>LongAdder#addï¼šç´¯åŠ æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">add</span><span class="params">(<span class="type">long</span> x)</span> &#123;</span><br><span class="line">    <span class="comment">// as ä¸ºç´¯åŠ å•å…ƒæ•°ç»„çš„å¼•ç”¨ï¼Œb ä¸ºåŸºç¡€å€¼ï¼Œv è¡¨ç¤ºæœŸæœ›å€¼</span></span><br><span class="line">    <span class="comment">// m è¡¨ç¤º cells æ•°ç»„çš„é•¿åº¦ - 1ï¼Œa è¡¨ç¤ºå½“å‰çº¿ç¨‹å‘½ä¸­çš„ cell å•å…ƒæ ¼</span></span><br><span class="line">    Cell[] as; <span class="type">long</span> b, v; <span class="type">int</span> m; Cell a;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// cells ä¸ä¸ºç©ºè¯´æ˜ cells å·²ç»è¢«åˆå§‹åŒ–ï¼Œçº¿ç¨‹å‘ç”Ÿäº†ç«äº‰ï¼Œå»æ›´æ–°å¯¹åº”çš„ cell æ§½ä½</span></span><br><span class="line">    <span class="comment">// è¿›å…¥ || åçš„é€»è¾‘å»æ›´æ–° base åŸŸï¼Œæ›´æ–°å¤±è´¥è¡¨ç¤ºå‘ç”Ÿç«äº‰è¿›å…¥æ¡ä»¶</span></span><br><span class="line">    <span class="keyword">if</span> ((as = cells) != <span class="literal">null</span> || !casBase(b = base, b + x)) &#123;</span><br><span class="line">        <span class="comment">// uncontended ä¸º true è¡¨ç¤º cell æ²¡æœ‰ç«äº‰</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">uncontended</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ¡ä»¶ä¸€: true è¯´æ˜ cells æœªåˆå§‹åŒ–ï¼Œå¤šçº¿ç¨‹å†™ base å‘ç”Ÿç«äº‰éœ€è¦è¿›è¡Œåˆå§‹åŒ– cells æ•°ç»„</span></span><br><span class="line">        <span class="comment">//  fasle è¯´æ˜ cells å·²ç»åˆå§‹åŒ–ï¼Œè¿›è¡Œä¸‹ä¸€ä¸ªæ¡ä»¶å¯»æ‰¾è‡ªå·±çš„ cell å»ç´¯åŠ </span></span><br><span class="line">        <span class="comment">// æ¡ä»¶äºŒ: getProbe() è·å– hash å€¼ï¼Œ&amp; m çš„é€»è¾‘å’Œ HashMap çš„é€»è¾‘ç›¸åŒï¼Œä¿è¯æ•£åˆ—çš„å‡åŒ€æ€§</span></span><br><span class="line">        <span class="comment">//   true è¯´æ˜å½“å‰çº¿ç¨‹å¯¹åº”ä¸‹æ ‡çš„ cell ä¸ºç©ºï¼Œéœ€è¦åˆ›å»º cell</span></span><br><span class="line">        <span class="comment">//        false è¯´æ˜å½“å‰çº¿ç¨‹å¯¹åº”çš„ cell ä¸ä¸ºç©ºï¼Œè¿›è¡Œä¸‹ä¸€ä¸ªæ¡ä»¶ã€å°† x å€¼ç´¯åŠ åˆ°å¯¹åº”çš„ cell ä¸­ã€‘</span></span><br><span class="line">        <span class="comment">// æ¡ä»¶ä¸‰: æœ‰å–åç¬¦å·ï¼Œfalse è¯´æ˜ cas æˆåŠŸï¼Œç›´æ¥è¿”å›ï¼Œtrue è¯´æ˜å¤±è´¥ï¼Œå½“å‰çº¿ç¨‹å¯¹åº”çš„ cell æœ‰ç«äº‰</span></span><br><span class="line">        <span class="keyword">if</span> (as == <span class="literal">null</span> || (m = as.length - <span class="number">1</span>) &lt; <span class="number">0</span> ||</span><br><span class="line">            (a = as[getProbe() &amp; m]) == <span class="literal">null</span> ||</span><br><span class="line">            !(uncontended = a.cas(v = a.value, v + x)))</span><br><span class="line">            longAccumulate(x, <span class="literal">null</span>, uncontended);</span><br><span class="line">        <span class="comment">// ã€uncontended åœ¨å¯¹åº”çš„ cell ä¸Šç´¯åŠ å¤±è´¥çš„æ—¶å€™æ‰ä¸º falseï¼Œå…¶ä½™æƒ…å†µå‡ä¸º trueã€‘</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>Striped64#longAccumulateï¼šcell æ•°ç»„åˆ›å»º</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// x  null false | true</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">longAccumulate</span><span class="params">(<span class="type">long</span> x, LongBinaryOperator fn, <span class="type">boolean</span> wasUncontended)</span> &#123;</span><br><span class="line">    <span class="type">int</span> h;</span><br><span class="line">    <span class="comment">// å½“å‰çº¿ç¨‹è¿˜æ²¡æœ‰å¯¹åº”çš„ cell, éœ€è¦éšæœºç”Ÿæˆä¸€ä¸ª hash å€¼ç”¨æ¥å°†å½“å‰çº¿ç¨‹ç»‘å®šåˆ° cell</span></span><br><span class="line">    <span class="keyword">if</span> ((h = getProbe()) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// åˆå§‹åŒ– probeï¼Œè·å– hash å€¼</span></span><br><span class="line">        ThreadLocalRandom.current(); </span><br><span class="line">        h = getProbe();</span><br><span class="line">        <span class="comment">// é»˜è®¤æƒ…å†µä¸‹ å½“å‰çº¿ç¨‹è‚¯å®šæ˜¯å†™å…¥åˆ°äº† cells[0] ä½ç½®ï¼Œä¸æŠŠå®ƒå½“åšä¸€æ¬¡çœŸæ­£çš„ç«äº‰</span></span><br><span class="line">        wasUncontended = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è¡¨ç¤ºã€æ‰©å®¹æ„å‘ã€‘ï¼Œfalse ä¸€å®šä¸ä¼šæ‰©å®¹ï¼Œtrue å¯èƒ½ä¼šæ‰©å®¹</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">collide</span> <span class="operator">=</span> <span class="literal">false</span>; </span><br><span class="line">    <span class="comment">//è‡ªæ—‹</span></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="comment">// as è¡¨ç¤ºcellså¼•ç”¨ï¼Œa è¡¨ç¤ºå½“å‰çº¿ç¨‹å‘½ä¸­çš„ cellï¼Œn è¡¨ç¤º cells æ•°ç»„é•¿åº¦ï¼Œv è¡¨ç¤º æœŸæœ›å€¼</span></span><br><span class="line">        Cell[] as; Cell a; <span class="type">int</span> n; <span class="type">long</span> v;</span><br><span class="line">        <span class="comment">// ã€CASE1ã€‘: è¡¨ç¤º cells å·²ç»åˆå§‹åŒ–äº†ï¼Œå½“å‰çº¿ç¨‹åº”è¯¥å°†æ•°æ®å†™å…¥åˆ°å¯¹åº”çš„ cell ä¸­</span></span><br><span class="line">        <span class="keyword">if</span> ((as = cells) != <span class="literal">null</span> &amp;&amp; (n = as.length) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// CASE1.1: true è¡¨ç¤ºå½“å‰çº¿ç¨‹å¯¹åº”çš„ç´¢å¼•ä¸‹æ ‡çš„ Cell ä¸º nullï¼Œéœ€è¦åˆ›å»º new Cell</span></span><br><span class="line">            <span class="keyword">if</span> ((a = as[(n - <span class="number">1</span>) &amp; h]) == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// åˆ¤æ–­ cellsBusy æ˜¯å¦è¢«é”</span></span><br><span class="line">                <span class="keyword">if</span> (cellsBusy == <span class="number">0</span>) &#123;   </span><br><span class="line">                    <span class="comment">// åˆ›å»º cell, åˆå§‹ç´¯åŠ å€¼ä¸º x</span></span><br><span class="line">                    <span class="type">Cell</span> <span class="variable">r</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Cell</span>(x);  </span><br><span class="line">                    <span class="comment">// åŠ é”</span></span><br><span class="line">                    <span class="keyword">if</span> (cellsBusy == <span class="number">0</span> &amp;&amp; casCellsBusy()) &#123;</span><br><span class="line">                        <span class="comment">// åˆ›å»ºæˆåŠŸæ ‡è®°ï¼Œè¿›å…¥ã€åˆ›å»º cell é€»è¾‘ã€‘</span></span><br><span class="line">                        <span class="type">boolean</span> <span class="variable">created</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            Cell[] rs; <span class="type">int</span> m, j;</span><br><span class="line">                            <span class="comment">// æŠŠå½“å‰ cells æ•°ç»„èµ‹å€¼ç»™ rsï¼Œå¹¶ä¸”ä¸ä¸º null</span></span><br><span class="line">                            <span class="keyword">if</span> ((rs = cells) != <span class="literal">null</span> &amp;&amp;</span><br><span class="line">                                (m = rs.length) &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">                                <span class="comment">// å†æ¬¡åˆ¤æ–­é˜²æ­¢å…¶å®ƒçº¿ç¨‹åˆå§‹åŒ–è¿‡è¯¥ä½ç½®ï¼Œå½“å‰çº¿ç¨‹å†æ¬¡åˆå§‹åŒ–è¯¥ä½ç½®ä¼šé€ æˆæ•°æ®ä¸¢å¤±</span></span><br><span class="line">                                <span class="comment">// å› ä¸ºè¿™é‡Œæ˜¯çº¿ç¨‹å®‰å…¨çš„åˆ¤æ–­ï¼Œè¿›è¡Œçš„é€»è¾‘ä¸ä¼šè¢«å…¶ä»–çº¿ç¨‹å½±å“</span></span><br><span class="line">                                rs[j = (m - <span class="number">1</span>) &amp; h] == <span class="literal">null</span>) &#123;</span><br><span class="line">                                <span class="comment">// æŠŠæ–°åˆ›å»ºçš„ cell å¡«å……è‡³å½“å‰ä½ç½®</span></span><br><span class="line">                                rs[j] = r;</span><br><span class="line">                                created = <span class="literal">true</span>;<span class="comment">// è¡¨ç¤ºåˆ›å»ºå®Œæˆ</span></span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                            cellsBusy = <span class="number">0</span>;<span class="comment">// è§£é”</span></span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (created)<span class="comment">// true è¡¨ç¤ºåˆ›å»ºå®Œæˆï¼Œå¯ä»¥æ¨å‡ºå¾ªç¯äº†</span></span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                collide = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// CASE1.2: æ¡ä»¶æˆç«‹è¯´æ˜çº¿ç¨‹å¯¹åº”çš„ cell æœ‰ç«äº‰, æ”¹å˜çº¿ç¨‹å¯¹åº”çš„ cell æ¥é‡è¯• cas</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (!wasUncontended)</span><br><span class="line">                wasUncontended = <span class="literal">true</span>;</span><br><span class="line">            <span class="comment">// CASE 1.3: å½“å‰çº¿ç¨‹ rehash è¿‡ï¼Œå¦‚æœæ–°å‘½ä¸­çš„ cell ä¸ä¸ºç©ºï¼Œå°±å°è¯•ç´¯åŠ ï¼Œfalse è¯´æ˜æ–°å‘½ä¸­ä¹Ÿæœ‰ç«äº‰</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (a.cas(v = a.value, ((fn == <span class="literal">null</span>) ? v + x : fn.applyAsLong(v, x))))</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="comment">// CASE 1.4: cells é•¿åº¦å·²ç»è¶…è¿‡äº†æœ€å¤§é•¿åº¦ CPU å†…æ ¸çš„æ•°é‡æˆ–è€…å·²ç»æ‰©å®¹</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (n &gt;= NCPU || cells != as)</span><br><span class="line">                collide = <span class="literal">false</span>; <span class="comment">// æ‰©å®¹æ„å‘æ”¹ä¸ºfalseï¼Œã€è¡¨ç¤ºä¸èƒ½æ‰©å®¹äº†ã€‘</span></span><br><span class="line">            <span class="comment">// CASE 1.5: æ›´æ”¹æ‰©å®¹æ„å‘ï¼Œå¦‚æœ n &gt;= NCPUï¼Œè¿™é‡Œå°±æ°¸è¿œä¸ä¼šæ‰§è¡Œåˆ°ï¼Œcase1.4 æ°¸è¿œå…ˆäº 1.5 æ‰§è¡Œ</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (!collide)</span><br><span class="line">                collide = <span class="literal">true</span>;</span><br><span class="line">            <span class="comment">// CASE 1.6: ã€æ‰©å®¹é€»è¾‘ã€‘ï¼Œè¿›è¡ŒåŠ é”</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (cellsBusy == <span class="number">0</span> &amp;&amp; casCellsBusy()) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// çº¿ç¨‹å®‰å…¨çš„æ£€æŸ¥ï¼Œé˜²æ­¢æœŸé—´è¢«å…¶ä»–çº¿ç¨‹æ‰©å®¹äº†</span></span><br><span class="line">                    <span class="keyword">if</span> (cells == as) &#123;     </span><br><span class="line">                        <span class="comment">// æ‰©å®¹ä¸ºä»¥å‰çš„ 2 å€</span></span><br><span class="line">                        Cell[] rs = <span class="keyword">new</span> <span class="title class_">Cell</span>[n &lt;&lt; <span class="number">1</span>];</span><br><span class="line">                        <span class="comment">// éå†ç§»åŠ¨å€¼</span></span><br><span class="line">                        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; n; ++i)</span><br><span class="line">                            rs[i] = as[i];</span><br><span class="line">                        <span class="comment">// æŠŠæ‰©å®¹åçš„å¼•ç”¨ç»™ cells</span></span><br><span class="line">                        cells = rs;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    cellsBusy = <span class="number">0</span>;<span class="comment">// è§£é”</span></span><br><span class="line">                &#125;</span><br><span class="line">                collide = <span class="literal">false</span>;<span class="comment">// æ‰©å®¹æ„å‘æ”¹ä¸º falseï¼Œè¡¨ç¤ºä¸æ‰©å®¹äº†</span></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// é‡ç½®å½“å‰çº¿ç¨‹ Hash å€¼ï¼Œè¿™å°±æ˜¯ã€åˆ†æ®µè¿ç§»æœºåˆ¶ã€‘</span></span><br><span class="line">            h = advanceProbe(h);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ã€CASE2ã€‘: è¿è¡Œåˆ°è¿™è¯´æ˜ cells è¿˜æœªåˆå§‹åŒ–ï¼Œas ä¸ºnull</span></span><br><span class="line">        <span class="comment">// åˆ¤æ–­æ˜¯å¦æ²¡æœ‰åŠ é”ï¼Œæ²¡æœ‰åŠ é”å°±ç”¨ CAS åŠ é”</span></span><br><span class="line">        <span class="comment">// æ¡ä»¶äºŒåˆ¤æ–­æ˜¯å¦å…¶å®ƒçº¿ç¨‹åœ¨å½“å‰çº¿ç¨‹ç»™ as èµ‹å€¼ä¹‹åä¿®æ”¹äº† cellsï¼Œè¿™é‡Œä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„åˆ¤æ–­</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (cellsBusy == <span class="number">0</span> &amp;&amp; cells == as &amp;&amp; casCellsBusy()) &#123;</span><br><span class="line">            <span class="comment">// åˆå§‹åŒ–æ ‡å¿—ï¼Œå¼€å§‹ ã€åˆå§‹åŒ– cells æ•°ç»„ã€‘</span></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">init</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123; </span><br><span class="line">               <span class="comment">// å†æ¬¡åˆ¤æ–­ cells == as é˜²æ­¢å…¶å®ƒçº¿ç¨‹å·²ç»æå‰åˆå§‹åŒ–äº†ï¼Œå½“å‰çº¿ç¨‹å†æ¬¡åˆå§‹åŒ–å¯¼è‡´ä¸¢å¤±æ•°æ®</span></span><br><span class="line">                <span class="comment">// å› ä¸ºè¿™é‡Œæ˜¯ã€çº¿ç¨‹å®‰å…¨çš„ï¼Œé‡æ–°æ£€æŸ¥ï¼Œç»å…¸ DCLã€‘</span></span><br><span class="line">                <span class="keyword">if</span> (cells == as) &#123;</span><br><span class="line">                    Cell[] rs = <span class="keyword">new</span> <span class="title class_">Cell</span>[<span class="number">2</span>];<span class="comment">// åˆå§‹åŒ–æ•°ç»„å¤§å°ä¸º2</span></span><br><span class="line">                    rs[h &amp; <span class="number">1</span>] = <span class="keyword">new</span> <span class="title class_">Cell</span>(x);<span class="comment">// å¡«å……çº¿ç¨‹å¯¹åº”çš„cell</span></span><br><span class="line">                    cells = rs;</span><br><span class="line">                    init = <span class="literal">true</span>;<span class="comment">// åˆå§‹åŒ–æˆåŠŸï¼Œæ ‡è®°ç½®ä¸º true</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                cellsBusy = <span class="number">0</span>;<span class="comment">// è§£é”å•Š</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (init)</span><br><span class="line">                <span class="keyword">break</span>;<span class="comment">// åˆå§‹åŒ–æˆåŠŸç›´æ¥è·³å‡ºè‡ªæ—‹</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ã€CASE3ã€‘: è¿è¡Œåˆ°è¿™è¯´æ˜å…¶ä»–çº¿ç¨‹åœ¨åˆå§‹åŒ– cellsï¼Œå½“å‰çº¿ç¨‹å°†å€¼ç´¯åŠ åˆ° baseï¼Œç´¯åŠ æˆåŠŸç›´æ¥ç»“æŸè‡ªæ—‹</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (casBase(v = base, ((fn == <span class="literal">null</span>) ? v + x :</span><br><span class="line">                                    fn.applyAsLong(v, x))))</span><br><span class="line">            <span class="keyword">break</span>; </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>sumï¼šè·å–æœ€ç»ˆç»“æœé€šè¿‡ sum æ•´åˆï¼Œ<strong>ä¿è¯æœ€ç»ˆä¸€è‡´æ€§ï¼Œä¸ä¿è¯å¼ºä¸€è‡´æ€§</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">long</span> <span class="title function_">sum</span><span class="params">()</span> &#123;</span><br><span class="line">    Cell[] as = cells; Cell a;</span><br><span class="line">    <span class="type">long</span> <span class="variable">sum</span> <span class="operator">=</span> base;</span><br><span class="line">    <span class="keyword">if</span> (as != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// éå† ç´¯åŠ </span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; as.length; ++i) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((a = as[i]) != <span class="literal">null</span>)</span><br><span class="line">                sum += a.value;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sum;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><hr><h3 id="ABA"><a href="#ABA" class="headerlink" title="ABA"></a>ABA</h3><p>ABA é—®é¢˜ï¼šå½“è¿›è¡Œè·å–ä¸»å†…å­˜å€¼æ—¶ï¼Œè¯¥å†…å­˜å€¼åœ¨å†™å…¥ä¸»å†…å­˜æ—¶å·²ç»è¢«ä¿®æ”¹äº† N æ¬¡ï¼Œä½†æ˜¯æœ€ç»ˆåˆæ”¹æˆåŸæ¥çš„å€¼</p><p>å…¶ä»–çº¿ç¨‹å…ˆæŠŠ A æ”¹æˆ B åˆæ”¹å› Aï¼Œä¸»çº¿ç¨‹<strong>ä»…èƒ½åˆ¤æ–­å‡ºå…±äº«å˜é‡çš„å€¼ä¸æœ€åˆå€¼ A æ˜¯å¦ç›¸åŒ</strong>ï¼Œä¸èƒ½æ„ŸçŸ¥åˆ°è¿™ç§ä» A æ”¹ä¸º B åˆ æ”¹å› A çš„æƒ…å†µï¼Œè¿™æ—¶ CAS è™½ç„¶æˆåŠŸï¼Œä½†æ˜¯è¿‡ç¨‹å­˜åœ¨é—®é¢˜</p><ul><li><p>æ„é€ æ–¹æ³•ï¼š</p><ul><li><code>public AtomicStampedReference(V initialRef, int initialStamp)</code>ï¼šåˆå§‹å€¼å’Œåˆå§‹ç‰ˆæœ¬å·</li></ul></li><li><p>å¸¸ç”¨APIï¼š</p><ul><li><code> public boolean compareAndSet(V expectedReference, V newReference, int expectedStamp, int newStamp)</code>ï¼š<strong>æœŸæœ›å¼•ç”¨å’ŒæœŸæœ›ç‰ˆæœ¬å·éƒ½ä¸€è‡´</strong>æ‰è¿›è¡Œ CAS ä¿®æ”¹æ•°æ®</li><li><code>public void set(V newReference, int newStamp)</code>ï¼šè®¾ç½®å€¼å’Œç‰ˆæœ¬å·</li><li><code>public V getReference()</code>ï¼šè¿”å›å¼•ç”¨çš„å€¼</li><li><code>public int getStamp()</code>ï¼šè¿”å›å½“å‰ç‰ˆæœ¬å·</li></ul></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    AtomicStampedReference&lt;Integer&gt; atomicReference = <span class="keyword">new</span> <span class="title class_">AtomicStampedReference</span>&lt;&gt;(<span class="number">100</span>,<span class="number">1</span>);</span><br><span class="line">    <span class="type">int</span> <span class="variable">startStamp</span> <span class="operator">=</span> atomicReference.getStamp();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt;&#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">stamp</span> <span class="operator">=</span> atomicReference.getStamp();</span><br><span class="line">        atomicReference.compareAndSet(<span class="number">100</span>, <span class="number">101</span>, stamp, stamp + <span class="number">1</span>);</span><br><span class="line">        stamp = atomicReference.getStamp();</span><br><span class="line">        atomicReference.compareAndSet(<span class="number">101</span>, <span class="number">100</span>, stamp, stamp + <span class="number">1</span>);</span><br><span class="line">    &#125;,<span class="string">&quot;t1&quot;</span>).start();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt;&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!atomicReference.compareAndSet(<span class="number">100</span>, <span class="number">200</span>, startStamp, startStamp + <span class="number">1</span>)) &#123;</span><br><span class="line">            System.out.println(atomicReference.getReference());<span class="comment">//100</span></span><br><span class="line">            System.out.println(Thread.currentThread().getName() + <span class="string">&quot;çº¿ç¨‹ä¿®æ”¹å¤±è´¥&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,<span class="string">&quot;t2&quot;</span>).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h3 id="Unsafe"><a href="#Unsafe" class="headerlink" title="Unsafe"></a>Unsafe</h3><p>Unsafe æ˜¯ CAS çš„æ ¸å¿ƒç±»ï¼Œç”±äº Java æ— æ³•ç›´æ¥è®¿é—®åº•å±‚ç³»ç»Ÿï¼Œéœ€è¦é€šè¿‡æœ¬åœ°ï¼ˆNativeï¼‰æ–¹æ³•æ¥è®¿é—®</p><p>Unsafe ç±»å­˜åœ¨ sun.misc åŒ…ï¼Œå…¶ä¸­æ‰€æœ‰æ–¹æ³•éƒ½æ˜¯ native ä¿®é¥°çš„ï¼Œéƒ½æ˜¯ç›´æ¥è°ƒç”¨<strong>æ“ä½œç³»ç»Ÿåº•å±‚èµ„æº</strong>æ‰§è¡Œç›¸åº”çš„ä»»åŠ¡ï¼ŒåŸºäºè¯¥ç±»å¯ä»¥ç›´æ¥æ“ä½œç‰¹å®šçš„å†…å­˜æ•°æ®ï¼Œå…¶å†…éƒ¨æ–¹æ³•æ“ä½œç±»ä¼¼ C çš„æŒ‡é’ˆ</p><p>æ¨¡æ‹Ÿå®ç°åŸå­æ•´æ•°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">MyAtomicInteger</span> <span class="variable">atomicInteger</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyAtomicInteger</span>(<span class="number">10</span>);</span><br><span class="line">    <span class="keyword">if</span> (atomicInteger.compareAndSwap(<span class="number">20</span>)) &#123;</span><br><span class="line">        System.out.println(atomicInteger.getValue());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyAtomicInteger</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Unsafe UNSAFE;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> VALUE_OFFSET;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">int</span> value;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//Unsafe unsafe = Unsafe.getUnsafe()è¿™æ ·ä¼šæŠ¥é”™ï¼Œéœ€è¦åå°„è·å–</span></span><br><span class="line">            <span class="type">Field</span> <span class="variable">theUnsafe</span> <span class="operator">=</span> Unsafe.class.getDeclaredField(<span class="string">&quot;theUnsafe&quot;</span>);</span><br><span class="line">            theUnsafe.setAccessible(<span class="literal">true</span>);</span><br><span class="line">            UNSAFE = (Unsafe) theUnsafe.get(<span class="literal">null</span>);</span><br><span class="line">            <span class="comment">// è·å– value å±æ€§çš„å†…å­˜åœ°å€ï¼Œvalue å±æ€§æŒ‡å‘è¯¥åœ°å€ï¼Œç›´æ¥è®¾ç½®è¯¥åœ°å€çš„å€¼å¯ä»¥ä¿®æ”¹ value çš„å€¼</span></span><br><span class="line">            VALUE_OFFSET = UNSAFE.objectFieldOffset(</span><br><span class="line">                   MyAtomicInteger.class.getDeclaredField(<span class="string">&quot;value&quot;</span>));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchFieldException | IllegalAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyAtomicInteger</span><span class="params">(<span class="type">int</span> value)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.value = value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getValue</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">compareAndSwap</span><span class="params">(<span class="type">int</span> update)</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">prev</span> <span class="operator">=</span> <span class="built_in">this</span>.value;</span><br><span class="line">            <span class="type">int</span> <span class="variable">next</span> <span class="operator">=</span> update;</span><br><span class="line">            <span class="comment">//å½“å‰å¯¹è±¡  å†…å­˜åç§»é‡    æœŸæœ›å€¼ æ›´æ–°å€¼</span></span><br><span class="line">            <span class="keyword">if</span> (UNSAFE.compareAndSwapInt(<span class="built_in">this</span>, VALUE_OFFSET, prev, update)) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;CASæˆåŠŸ&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h3 id="final"><a href="#final" class="headerlink" title="final"></a>final</h3><h4 id="åŸç†-1"><a href="#åŸç†-1" class="headerlink" title="åŸç†"></a>åŸç†</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestFinal</span> &#123;</span><br><span class="line"><span class="keyword">final</span> <span class="type">int</span> <span class="variable">a</span> <span class="operator">=</span> <span class="number">20</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å­—èŠ‚ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span>: aload_0</span><br><span class="line"><span class="number">1</span>: invokespecial #<span class="number">1</span> <span class="comment">// Method java/lang/Object.&quot;&lt;init&gt;&quot;:()V</span></span><br><span class="line"><span class="number">4</span>: aload_0</span><br><span class="line"><span class="number">5</span>: bipush <span class="number">20</span><span class="comment">// å°†å€¼ç›´æ¥æ”¾å…¥æ ˆä¸­</span></span><br><span class="line"><span class="number">7</span>: putfield #<span class="number">2</span> <span class="comment">// Field a:I</span></span><br><span class="line">&lt;-- å†™å±éšœ</span><br><span class="line"><span class="number">10</span>: <span class="keyword">return</span></span><br></pre></td></tr></table></figure><p>final å˜é‡çš„èµ‹å€¼é€šè¿‡ putfield æŒ‡ä»¤æ¥å®Œæˆï¼Œåœ¨è¿™æ¡æŒ‡ä»¤ä¹‹åä¹Ÿä¼šåŠ å…¥å†™å±éšœï¼Œä¿è¯åœ¨å…¶å®ƒçº¿ç¨‹è¯»åˆ°å®ƒçš„å€¼æ—¶ä¸ä¼šå‡ºç°ä¸º 0 çš„æƒ…å†µ</p><p>å…¶ä»–çº¿ç¨‹è®¿é—® final ä¿®é¥°çš„å˜é‡</p><ul><li><strong>å¤åˆ¶ä¸€ä»½æ”¾å…¥æ ˆä¸­</strong>ç›´æ¥è®¿é—®ï¼Œæ•ˆç‡é«˜</li><li>å¤§äº short æœ€å¤§å€¼ä¼šå°†å…¶å¤åˆ¶åˆ°ç±»çš„å¸¸é‡æ± ï¼Œè®¿é—®æ—¶ä»å¸¸é‡æ± è·å–</li></ul><hr><h4 id="ä¸å¯å˜"><a href="#ä¸å¯å˜" class="headerlink" title="ä¸å¯å˜"></a>ä¸å¯å˜</h4><p>ä¸å¯å˜ï¼šå¦‚æœä¸€ä¸ªå¯¹è±¡ä¸èƒ½å¤Ÿä¿®æ”¹å…¶å†…éƒ¨çŠ¶æ€ï¼ˆå±æ€§ï¼‰ï¼Œé‚£ä¹ˆå°±æ˜¯ä¸å¯å˜å¯¹è±¡</p><p>ä¸å¯å˜å¯¹è±¡çº¿ç¨‹å®‰å…¨çš„ï¼Œä¸å­˜åœ¨å¹¶å‘ä¿®æ”¹å’Œå¯è§æ€§é—®é¢˜ï¼Œæ˜¯å¦ä¸€ç§é¿å…ç«äº‰çš„æ–¹å¼</p><p>String ç±»ä¹Ÿæ˜¯ä¸å¯å˜çš„ï¼Œè¯¥ç±»å’Œç±»ä¸­æ‰€æœ‰å±æ€§éƒ½æ˜¯ final çš„</p><ul><li><p>ç±»ç”¨ final ä¿®é¥°ä¿è¯äº†è¯¥ç±»ä¸­çš„æ–¹æ³•ä¸èƒ½è¢«è¦†ç›–ï¼Œé˜²æ­¢å­ç±»æ— æ„é—´ç ´åä¸å¯å˜æ€§</p></li><li><p>æ— å†™å…¥æ–¹æ³•ï¼ˆsetï¼‰ç¡®ä¿å¤–éƒ¨ä¸èƒ½å¯¹å†…éƒ¨å±æ€§è¿›è¡Œä¿®æ”¹</p></li><li><p>å±æ€§ç”¨ final ä¿®é¥°ä¿è¯äº†è¯¥å±æ€§æ˜¯åªè¯»çš„ï¼Œä¸èƒ½ä¿®æ”¹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">String</span></span><br><span class="line">    <span class="keyword">implements</span> <span class="title class_">java</span>.io.Serializable, Comparable&lt;String&gt;, CharSequence &#123;</span><br><span class="line">    <span class="comment">/** The value is used for character storage. */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">char</span> value[];</span><br><span class="line">    <span class="comment">//....</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>æ›´æ”¹ String ç±»æ•°æ®æ—¶ï¼Œä¼šæ„é€ æ–°å­—ç¬¦ä¸²å¯¹è±¡ï¼Œç”Ÿæˆæ–°çš„ char[] valueï¼Œé€šè¿‡<strong>åˆ›å»ºå‰¯æœ¬å¯¹è±¡æ¥é¿å…å…±äº«çš„æ–¹å¼ç§°ä¹‹ä¸ºä¿æŠ¤æ€§æ‹·è´</strong></p></li></ul><hr><h3 id="State"><a href="#State" class="headerlink" title="State"></a>State</h3><p>æ— çŠ¶æ€ï¼šæˆå‘˜å˜é‡ä¿å­˜çš„æ•°æ®ä¹Ÿå¯ä»¥ç§°ä¸ºçŠ¶æ€ä¿¡æ¯ï¼Œæ— çŠ¶æ€å°±æ˜¯æ²¡æœ‰æˆå‘˜å˜é‡</p><p>Servlet ä¸ºäº†ä¿è¯å…¶çº¿ç¨‹å®‰å…¨ï¼Œä¸€èˆ¬ä¸ä¸º Servlet è®¾ç½®æˆå‘˜å˜é‡ï¼Œè¿™ç§æ²¡æœ‰ä»»ä½•æˆå‘˜å˜é‡çš„ç±»æ˜¯çº¿ç¨‹å®‰å…¨çš„</p><hr><h3 id="Local"><a href="#Local" class="headerlink" title="Local"></a>Local</h3><h4 id="åŸºæœ¬ä»‹ç»"><a href="#åŸºæœ¬ä»‹ç»" class="headerlink" title="åŸºæœ¬ä»‹ç»"></a>åŸºæœ¬ä»‹ç»</h4><p>ThreadLocal ç±»ç”¨æ¥æä¾›çº¿ç¨‹å†…éƒ¨çš„å±€éƒ¨å˜é‡ï¼Œè¿™ç§å˜é‡åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹è®¿é—®ï¼ˆé€šè¿‡ get å’Œ set æ–¹æ³•è®¿é—®ï¼‰æ—¶èƒ½ä¿è¯å„ä¸ªçº¿ç¨‹çš„å˜é‡ç›¸å¯¹ç‹¬ç«‹äºå…¶ä»–çº¿ç¨‹å†…çš„å˜é‡ï¼Œåˆ†é…åœ¨å †å†…çš„ <strong>TLAB</strong> ä¸­</p><p>ThreadLocal å®ä¾‹é€šå¸¸æ¥è¯´éƒ½æ˜¯ <code>private static</code> ç±»å‹çš„ï¼Œå±äºä¸€ä¸ªçº¿ç¨‹çš„æœ¬åœ°å˜é‡ï¼Œç”¨äºå…³è”çº¿ç¨‹å’Œçº¿ç¨‹ä¸Šä¸‹æ–‡ã€‚æ¯ä¸ªçº¿ç¨‹éƒ½ä¼šåœ¨ ThreadLocal ä¸­ä¿å­˜ä¸€ä»½è¯¥çº¿ç¨‹ç‹¬æœ‰çš„æ•°æ®ï¼Œæ‰€ä»¥æ˜¯çº¿ç¨‹å®‰å…¨çš„</p><p>ThreadLocal ä½œç”¨ï¼š</p><ul><li><p>çº¿ç¨‹å¹¶å‘ï¼šåº”ç”¨åœ¨å¤šçº¿ç¨‹å¹¶å‘çš„åœºæ™¯ä¸‹</p></li><li><p>ä¼ é€’æ•°æ®ï¼šé€šè¿‡ ThreadLocal å®ç°åœ¨åŒä¸€çº¿ç¨‹ä¸åŒå‡½æ•°æˆ–ç»„ä»¶ä¸­ä¼ é€’å…¬å…±å˜é‡ï¼Œå‡å°‘ä¼ é€’å¤æ‚åº¦</p></li><li><p>çº¿ç¨‹éš”ç¦»ï¼šæ¯ä¸ªçº¿ç¨‹çš„å˜é‡éƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œä¸ä¼šäº’ç›¸å½±å“</p></li></ul><p>å¯¹æ¯” synchronizedï¼š</p><table><thead><tr><th></th><th>synchronized</th><th>ThreadLocal</th></tr></thead><tbody><tr><td>åŸç†</td><td>åŒæ­¥æœºåˆ¶é‡‡ç”¨<strong>ä»¥æ—¶é—´æ¢ç©ºé—´</strong>çš„æ–¹å¼ï¼Œåªæä¾›äº†ä¸€ä»½å˜é‡ï¼Œè®©ä¸åŒçš„çº¿ç¨‹æ’é˜Ÿè®¿é—®</td><td>ThreadLocal é‡‡ç”¨<strong>ä»¥ç©ºé—´æ¢æ—¶é—´</strong>çš„æ–¹å¼ï¼Œä¸ºæ¯ä¸ªçº¿ç¨‹éƒ½æä¾›äº†ä¸€ä»½å˜é‡çš„å‰¯æœ¬ï¼Œä»è€Œå®ç°åŒæ—¶è®¿é—®è€Œç›¸ä¸å¹²æ‰°</td></tr><tr><td>ä¾§é‡ç‚¹</td><td>å¤šä¸ªçº¿ç¨‹ä¹‹é—´è®¿é—®èµ„æºçš„åŒæ­¥</td><td>å¤šçº¿ç¨‹ä¸­è®©æ¯ä¸ªçº¿ç¨‹ä¹‹é—´çš„æ•°æ®ç›¸äº’éš”ç¦»</td></tr></tbody></table><hr><h4 id="åŸºæœ¬ä½¿ç”¨-1"><a href="#åŸºæœ¬ä½¿ç”¨-1" class="headerlink" title="åŸºæœ¬ä½¿ç”¨"></a>åŸºæœ¬ä½¿ç”¨</h4><h5 id="å¸¸ç”¨æ–¹æ³•"><a href="#å¸¸ç”¨æ–¹æ³•" class="headerlink" title="å¸¸ç”¨æ–¹æ³•"></a>å¸¸ç”¨æ–¹æ³•</h5><table><thead><tr><th>æ–¹æ³•</th><th>æè¿°</th></tr></thead><tbody><tr><td>ThreadLocal&lt;&gt;()</td><td>åˆ›å»º ThreadLocal å¯¹è±¡</td></tr><tr><td>protected T initialValue()</td><td>è¿”å›å½“å‰çº¿ç¨‹å±€éƒ¨å˜é‡çš„åˆå§‹å€¼</td></tr><tr><td>public void set( T value)</td><td>è®¾ç½®å½“å‰çº¿ç¨‹ç»‘å®šçš„å±€éƒ¨å˜é‡</td></tr><tr><td>public T get()</td><td>è·å–å½“å‰çº¿ç¨‹ç»‘å®šçš„å±€éƒ¨å˜é‡</td></tr><tr><td>public void remove()</td><td>ç§»é™¤å½“å‰çº¿ç¨‹ç»‘å®šçš„å±€éƒ¨å˜é‡</td></tr></tbody></table><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyDemo</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ThreadLocal&lt;String&gt; tl = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String content;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">getContent</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// è·å–å½“å‰çº¿ç¨‹ç»‘å®šçš„å˜é‡</span></span><br><span class="line">        <span class="keyword">return</span> tl.get();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">setContent</span><span class="params">(String content)</span> &#123;</span><br><span class="line">        <span class="comment">// å˜é‡contentç»‘å®šåˆ°å½“å‰çº¿ç¨‹</span></span><br><span class="line">        tl.set(content);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">MyDemo</span> <span class="variable">demo</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyDemo</span>();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">            <span class="type">Thread</span> <span class="variable">thread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                    <span class="comment">// è®¾ç½®æ•°æ®</span></span><br><span class="line">                    demo.setContent(Thread.currentThread().getName() + <span class="string">&quot;çš„æ•°æ®&quot;</span>);</span><br><span class="line">                    System.out.println(<span class="string">&quot;-----------------------&quot;</span>);</span><br><span class="line">                    System.out.println(Thread.currentThread().getName() + <span class="string">&quot;---&gt;&quot;</span> + demo.getContent());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            thread.setName(<span class="string">&quot;çº¿ç¨‹&quot;</span> + i);</span><br><span class="line">            thread.start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h5 id="åº”ç”¨åœºæ™¯"><a href="#åº”ç”¨åœºæ™¯" class="headerlink" title="åº”ç”¨åœºæ™¯"></a>åº”ç”¨åœºæ™¯</h5><p>ThreadLocal é€‚ç”¨äºä¸‹é¢ä¸¤ç§åœºæ™¯ï¼š</p><ul><li>æ¯ä¸ªçº¿ç¨‹éœ€è¦æœ‰è‡ªå·±å•ç‹¬çš„å®ä¾‹</li><li>å®ä¾‹éœ€è¦åœ¨å¤šä¸ªæ–¹æ³•ä¸­å…±äº«ï¼Œä½†ä¸å¸Œæœ›è¢«å¤šçº¿ç¨‹å…±äº«</li></ul><p>ThreadLocal æ–¹æ¡ˆæœ‰ä¸¤ä¸ªçªå‡ºçš„ä¼˜åŠ¿ï¼š </p><ol><li>ä¼ é€’æ•°æ®ï¼šä¿å­˜æ¯ä¸ªçº¿ç¨‹ç»‘å®šçš„æ•°æ®ï¼Œåœ¨éœ€è¦çš„åœ°æ–¹å¯ä»¥ç›´æ¥è·å–ï¼Œé¿å…å‚æ•°ç›´æ¥ä¼ é€’å¸¦æ¥çš„ä»£ç è€¦åˆé—®é¢˜</li><li>çº¿ç¨‹éš”ç¦»ï¼šå„çº¿ç¨‹ä¹‹é—´çš„æ•°æ®ç›¸äº’éš”ç¦»å´åˆå…·å¤‡å¹¶å‘æ€§ï¼Œé¿å…åŒæ­¥æ–¹å¼å¸¦æ¥çš„æ€§èƒ½æŸå¤±</li></ol><p>ThreadLocal ç”¨äºæ•°æ®è¿æ¥çš„äº‹åŠ¡ç®¡ç†ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JdbcUtils</span> &#123;</span><br><span class="line">    <span class="comment">// ThreadLocalå¯¹è±¡ï¼Œå°†connectionç»‘å®šåœ¨å½“å‰çº¿ç¨‹ä¸­</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;Connection&gt; tl = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>();</span><br><span class="line">    <span class="comment">// c3p0 æ•°æ®åº“è¿æ¥æ± å¯¹è±¡å±æ€§</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">ComboPooledDataSource</span> <span class="variable">ds</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ComboPooledDataSource</span>();</span><br><span class="line">    <span class="comment">// è·å–è¿æ¥</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Connection <span class="title function_">getConnection</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">        <span class="comment">//å–å‡ºå½“å‰çº¿ç¨‹ç»‘å®šçš„connectionå¯¹è±¡</span></span><br><span class="line">        <span class="type">Connection</span> <span class="variable">conn</span> <span class="operator">=</span> tl.get();</span><br><span class="line">        <span class="keyword">if</span> (conn == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">//å¦‚æœæ²¡æœ‰ï¼Œåˆ™ä»è¿æ¥æ± ä¸­å–å‡º</span></span><br><span class="line">            conn = ds.getConnection();</span><br><span class="line">            <span class="comment">//å†å°†connectionå¯¹è±¡ç»‘å®šåˆ°å½“å‰çº¿ç¨‹ä¸­ï¼Œéå¸¸é‡è¦çš„æ“ä½œ</span></span><br><span class="line">            tl.set(conn);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> conn;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”¨ ThreadLocal ä½¿ SimpleDateFormat ä»ç‹¬äº«å˜é‡å˜æˆå•ä¸ªçº¿ç¨‹å˜é‡ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ThreadLocalDateUtil</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ThreadLocal&lt;DateFormat&gt; threadLocal = <span class="keyword">new</span> <span class="title class_">ThreadLocal</span>&lt;DateFormat&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> DateFormat <span class="title function_">initialValue</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SimpleDateFormat</span>(<span class="string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Date <span class="title function_">parse</span><span class="params">(String dateStr)</span> <span class="keyword">throws</span> ParseException &#123;</span><br><span class="line">        <span class="keyword">return</span> threadLocal.get().parse(dateStr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">format</span><span class="params">(Date date)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> threadLocal.get().format(date);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h4 id="å®ç°åŸç†"><a href="#å®ç°åŸç†" class="headerlink" title="å®ç°åŸç†"></a>å®ç°åŸç†</h4><h5 id="åº•å±‚ç»“æ„"><a href="#åº•å±‚ç»“æ„" class="headerlink" title="åº•å±‚ç»“æ„"></a>åº•å±‚ç»“æ„</h5><p>JDK8 ä»¥å‰ï¼šæ¯ä¸ª ThreadLocal éƒ½åˆ›å»ºä¸€ä¸ª Mapï¼Œç„¶åç”¨çº¿ç¨‹ä½œä¸º Map çš„ keyï¼Œè¦å­˜å‚¨çš„å±€éƒ¨å˜é‡ä½œä¸º Map çš„ valueï¼Œè¾¾åˆ°å„ä¸ªçº¿ç¨‹çš„å±€éƒ¨å˜é‡éš”ç¦»çš„æ•ˆæœã€‚è¿™ç§ç»“æ„ä¼šé€ æˆ Map ç»“æ„è¿‡å¤§å’Œå†…å­˜æ³„éœ²ï¼Œå› ä¸º Thread åœæ­¢åæ— æ³•é€šè¿‡ key åˆ é™¤å¯¹åº”çš„æ•°æ®</p><p><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/JUC-ThreadLocal%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84JDK8%E5%89%8D.png"></p><p>JDK8 ä»¥åï¼šæ¯ä¸ª Thread ç»´æŠ¤ä¸€ä¸ª ThreadLocalMapï¼Œè¿™ä¸ª Map çš„ key æ˜¯ ThreadLocal å®ä¾‹æœ¬èº«ï¼Œvalue æ˜¯çœŸæ­£è¦å­˜å‚¨çš„å€¼</p><ul><li><strong>æ¯ä¸ª Thread çº¿ç¨‹å†…éƒ¨éƒ½æœ‰ä¸€ä¸ª Map (ThreadLocalMap)</strong></li><li>Map é‡Œé¢å­˜å‚¨ ThreadLocal å¯¹è±¡ï¼ˆkeyï¼‰å’Œçº¿ç¨‹çš„ç§æœ‰å˜é‡ï¼ˆvalueï¼‰</li><li>Thread å†…éƒ¨çš„ Map æ˜¯ç”± ThreadLocal ç»´æŠ¤çš„ï¼Œç”± ThreadLocal è´Ÿè´£å‘ map è·å–å’Œè®¾ç½®çº¿ç¨‹çš„å˜é‡å€¼</li><li>å¯¹äºä¸åŒçš„çº¿ç¨‹ï¼Œæ¯æ¬¡è·å–å‰¯æœ¬å€¼æ—¶ï¼Œåˆ«çš„çº¿ç¨‹å¹¶ä¸èƒ½è·å–åˆ°å½“å‰çº¿ç¨‹çš„å‰¯æœ¬å€¼ï¼Œå½¢æˆå‰¯æœ¬çš„éš”ç¦»ï¼Œäº’ä¸å¹²æ‰°</li></ul><p><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/JUC-ThreadLocal%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84JDK8%E5%90%8E.png"></p><p>JDK8 å‰åå¯¹æ¯”ï¼š</p><ul><li>æ¯ä¸ª Map å­˜å‚¨çš„ Entry æ•°é‡ä¼šå˜å°‘ï¼Œå› ä¸ºä¹‹å‰çš„å­˜å‚¨æ•°é‡ç”± Thread çš„æ•°é‡å†³å®šï¼Œç°åœ¨ç”± ThreadLocal çš„æ•°é‡å†³å®šï¼Œåœ¨å®é™…ç¼–ç¨‹å½“ä¸­ï¼Œå¾€å¾€ ThreadLocal çš„æ•°é‡è¦å°‘äº Thread çš„æ•°é‡</li><li>å½“ Thread é”€æ¯ä¹‹åï¼Œå¯¹åº”çš„ ThreadLocalMap ä¹Ÿä¼šéšä¹‹é”€æ¯ï¼Œèƒ½å‡å°‘å†…å­˜çš„ä½¿ç”¨ï¼Œ<strong>é˜²æ­¢å†…å­˜æ³„éœ²</strong></li></ul><hr><h5 id="æˆå‘˜å˜é‡"><a href="#æˆå‘˜å˜é‡" class="headerlink" title="æˆå‘˜å˜é‡"></a>æˆå‘˜å˜é‡</h5><ul><li><p>Thread ç±»çš„ç›¸å…³å±æ€§ï¼š<strong>æ¯ä¸€ä¸ªçº¿ç¨‹æŒæœ‰ä¸€ä¸ª ThreadLocalMap å¯¹è±¡</strong>ï¼Œå­˜æ”¾ç”± ThreadLocal å’Œæ•°æ®ç»„æˆçš„ Entry é”®å€¼å¯¹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ThreadLocal.<span class="type">ThreadLocalMap</span> <span class="variable">threadLocals</span> <span class="operator">=</span> <span class="literal">null</span></span><br></pre></td></tr></table></figure></li><li><p>è®¡ç®— ThreadLocal å¯¹è±¡çš„å“ˆå¸Œå€¼ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">threadLocalHashCode</span> <span class="operator">=</span> nextHashCode()</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ <code>threadLocalHashCode &amp; (table.length - 1)</code> è®¡ç®—å½“å‰ entry éœ€è¦å­˜æ”¾çš„ä½ç½®</p></li><li><p>æ¯åˆ›å»ºä¸€ä¸ª ThreadLocal å¯¹è±¡å°±ä¼šä½¿ç”¨ nextHashCode åˆ†é…ä¸€ä¸ª hash å€¼ç»™è¿™ä¸ªå¯¹è±¡ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">AtomicInteger</span> <span class="variable">nextHashCode</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>()</span><br></pre></td></tr></table></figure></li><li><p>æ–æ³¢é‚£å¥‘æ•°ä¹Ÿå«é»„é‡‘åˆ†å‰²æ•°ï¼Œhash çš„<strong>å¢é‡</strong>å°±æ˜¯è¿™ä¸ªæ•°å­—ï¼Œå¸¦æ¥çš„å¥½å¤„æ˜¯ hash åˆ†å¸ƒéå¸¸å‡åŒ€ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">HASH_INCREMENT</span> <span class="operator">=</span> <span class="number">0x61c88647</span></span><br></pre></td></tr></table></figure></li></ul><hr><h5 id="æˆå‘˜æ–¹æ³•"><a href="#æˆå‘˜æ–¹æ³•" class="headerlink" title="æˆå‘˜æ–¹æ³•"></a>æˆå‘˜æ–¹æ³•</h5><p>æ–¹æ³•éƒ½æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå› ä¸º ThreadLocal å±äºä¸€ä¸ªçº¿ç¨‹çš„ï¼ŒThreadLocal ä¸­çš„æ–¹æ³•ï¼Œé€»è¾‘éƒ½æ˜¯è·å–å½“å‰çº¿ç¨‹ç»´æŠ¤çš„ ThreadLocalMap å¯¹è±¡ï¼Œç„¶åè¿›è¡Œæ•°æ®çš„å¢åˆ æ”¹æŸ¥ï¼Œæ²¡æœ‰æŒ‡å®šåˆå§‹å€¼çš„ threadlcoal å¯¹è±¡é»˜è®¤èµ‹å€¼ä¸º null</p><ul><li><p>initialValue()ï¼šè¿”å›è¯¥çº¿ç¨‹å±€éƒ¨å˜é‡çš„åˆå§‹å€¼</p><ul><li>å»¶è¿Ÿè°ƒç”¨çš„æ–¹æ³•ï¼Œåœ¨æ‰§è¡Œ get æ–¹æ³•æ—¶æ‰æ‰§è¡Œ</li><li>è¯¥æ–¹æ³•ç¼ºçœï¼ˆé»˜è®¤ï¼‰å®ç°ç›´æ¥è¿”å›ä¸€ä¸ª null</li><li>å¦‚æœæƒ³è¦ä¸€ä¸ªåˆå§‹å€¼ï¼Œå¯ä»¥é‡å†™æ­¤æ–¹æ³•ï¼Œ è¯¥æ–¹æ³•æ˜¯ä¸€ä¸ª <code>protected</code> çš„æ–¹æ³•ï¼Œä¸ºäº†è®©å­ç±»è¦†ç›–è€Œè®¾è®¡çš„</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> T <span class="title function_">initialValue</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>nextHashCode()ï¼šè®¡ç®—å“ˆå¸Œå€¼ï¼ŒThreadLocal çš„æ•£åˆ—æ–¹å¼ç§°ä¹‹ä¸º<strong>æ–æ³¢é‚£å¥‘æ•£åˆ—</strong>ï¼Œæ¯æ¬¡è·å–å“ˆå¸Œå€¼éƒ½ä¼šåŠ ä¸Š HASH_INCREMENTï¼Œè¿™æ ·åšå¯ä»¥å°½é‡é¿å… hash å†²çªï¼Œè®©å“ˆå¸Œå€¼èƒ½å‡åŒ€çš„åˆ†å¸ƒåœ¨ 2 çš„ n æ¬¡æ–¹çš„æ•°ç»„ä¸­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">nextHashCode</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// å“ˆå¸Œå€¼è‡ªå¢ä¸€ä¸ª HASH_INCREMENT æ•°å€¼</span></span><br><span class="line">    <span class="keyword">return</span> nextHashCode.getAndAdd(HASH_INCREMENT);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>set()ï¼šä¿®æ”¹å½“å‰çº¿ç¨‹ä¸å½“å‰ threadlocal å¯¹è±¡ç›¸å…³è”çš„çº¿ç¨‹å±€éƒ¨å˜é‡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">set</span><span class="params">(T value)</span> &#123;</span><br><span class="line">    <span class="comment">// è·å–å½“å‰çº¿ç¨‹å¯¹è±¡</span></span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">    <span class="comment">// è·å–æ­¤çº¿ç¨‹å¯¹è±¡ä¸­ç»´æŠ¤çš„ ThreadLocalMap å¯¹è±¡</span></span><br><span class="line">    <span class="type">ThreadLocalMap</span> <span class="variable">map</span> <span class="operator">=</span> getMap(t);</span><br><span class="line">    <span class="comment">// åˆ¤æ–­ map æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">    <span class="keyword">if</span> (map != <span class="literal">null</span>)</span><br><span class="line">        <span class="comment">// è°ƒç”¨ threadLocalMap.set æ–¹æ³•è¿›è¡Œé‡å†™æˆ–è€…æ·»åŠ </span></span><br><span class="line">        map.set(<span class="built_in">this</span>, value);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="comment">// map ä¸ºç©ºï¼Œè°ƒç”¨ createMap è¿›è¡Œ ThreadLocalMap å¯¹è±¡çš„åˆå§‹åŒ–ã€‚å‚æ•°1æ˜¯å½“å‰çº¿ç¨‹ï¼Œå‚æ•°2æ˜¯å±€éƒ¨å˜é‡</span></span><br><span class="line">        createMap(t, value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è·å–å½“å‰çº¿ç¨‹ Thread å¯¹åº”ç»´æŠ¤çš„ ThreadLocalMap </span></span><br><span class="line">ThreadLocalMap <span class="title function_">getMap</span><span class="params">(Thread t)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> t.threadLocals;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// åˆ›å»ºå½“å‰çº¿ç¨‹Threadå¯¹åº”ç»´æŠ¤çš„ThreadLocalMap </span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">createMap</span><span class="params">(Thread t, T firstValue)</span> &#123;</span><br><span class="line">    <span class="comment">// ã€è¿™é‡Œçš„ this æ˜¯è°ƒç”¨æ­¤æ–¹æ³•çš„ threadLocalã€‘ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„ Map å¹¶è®¾ç½®ç¬¬ä¸€ä¸ªæ•°æ®</span></span><br><span class="line">    t.threadLocals = <span class="keyword">new</span> <span class="title class_">ThreadLocalMap</span>(<span class="built_in">this</span>, firstValue);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>get()ï¼šè·å–å½“å‰çº¿ç¨‹ä¸å½“å‰ ThreadLocal å¯¹è±¡ç›¸å…³è”çš„çº¿ç¨‹å±€éƒ¨å˜é‡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> T <span class="title function_">get</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">    <span class="type">ThreadLocalMap</span> <span class="variable">map</span> <span class="operator">=</span> getMap(t);</span><br><span class="line">    <span class="comment">// å¦‚æœæ­¤mapå­˜åœ¨</span></span><br><span class="line">    <span class="keyword">if</span> (map != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// ä»¥å½“å‰çš„ ThreadLocal ä¸º keyï¼Œè°ƒç”¨ getEntry è·å–å¯¹åº”çš„å­˜å‚¨å®ä½“ e</span></span><br><span class="line">        ThreadLocalMap.<span class="type">Entry</span> <span class="variable">e</span> <span class="operator">=</span> map.getEntry(<span class="built_in">this</span>);</span><br><span class="line">        <span class="comment">// å¯¹ e è¿›è¡Œåˆ¤ç©º </span></span><br><span class="line">        <span class="keyword">if</span> (e != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// è·å–å­˜å‚¨å®ä½“ e å¯¹åº”çš„ valueå€¼</span></span><br><span class="line">            <span class="type">T</span> <span class="variable">result</span> <span class="operator">=</span> (T)e.value;</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/*æœ‰ä¸¤ç§æƒ…å†µæœ‰æ‰§è¡Œå½“å‰ä»£ç </span></span><br><span class="line"><span class="comment">      ç¬¬ä¸€ç§æƒ…å†µ: map ä¸å­˜åœ¨ï¼Œè¡¨ç¤ºæ­¤çº¿ç¨‹æ²¡æœ‰ç»´æŠ¤çš„ ThreadLocalMap å¯¹è±¡</span></span><br><span class="line"><span class="comment">      ç¬¬äºŒç§æƒ…å†µ: map å­˜åœ¨, ä½†æ˜¯ã€æ²¡æœ‰ä¸å½“å‰ ThreadLocal å…³è”çš„ entryã€‘ï¼Œå°±ä¼šè®¾ç½®ä¸ºé»˜è®¤å€¼ */</span></span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–å½“å‰çº¿ç¨‹ä¸å½“å‰ threadLocal å¯¹è±¡ç›¸å…³è”çš„ value</span></span><br><span class="line">    <span class="keyword">return</span> setInitialValue();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> T <span class="title function_">setInitialValue</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// è°ƒç”¨initialValueè·å–åˆå§‹åŒ–çš„å€¼ï¼Œæ­¤æ–¹æ³•å¯ä»¥è¢«å­ç±»é‡å†™, å¦‚æœä¸é‡å†™é»˜è®¤è¿”å› null</span></span><br><span class="line">    <span class="type">T</span> <span class="variable">value</span> <span class="operator">=</span> initialValue();</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">    <span class="type">ThreadLocalMap</span> <span class="variable">map</span> <span class="operator">=</span> getMap(t);</span><br><span class="line">    <span class="comment">// åˆ¤æ–­ map æ˜¯å¦åˆå§‹åŒ–è¿‡</span></span><br><span class="line">    <span class="keyword">if</span> (map != <span class="literal">null</span>)</span><br><span class="line">        <span class="comment">// å­˜åœ¨åˆ™è°ƒç”¨ map.set è®¾ç½®æ­¤å®ä½“ entryï¼Œvalue æ˜¯é»˜è®¤çš„å€¼</span></span><br><span class="line">        map.set(<span class="built_in">this</span>, value);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="comment">// è°ƒç”¨ createMap è¿›è¡Œ ThreadLocalMap å¯¹è±¡çš„åˆå§‹åŒ–ä¸­</span></span><br><span class="line">        createMap(t, value);</span><br><span class="line">    <span class="comment">// è¿”å›çº¿ç¨‹ä¸å½“å‰ threadLocal å…³è”çš„å±€éƒ¨å˜é‡</span></span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>remove()ï¼šç§»é™¤å½“å‰çº¿ç¨‹ä¸å½“å‰ threadLocal å¯¹è±¡ç›¸å…³è”çš„çº¿ç¨‹å±€éƒ¨å˜é‡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">remove</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// è·å–å½“å‰çº¿ç¨‹å¯¹è±¡ä¸­ç»´æŠ¤çš„ ThreadLocalMap å¯¹è±¡</span></span><br><span class="line">    <span class="type">ThreadLocalMap</span> <span class="variable">m</span> <span class="operator">=</span> getMap(Thread.currentThread());</span><br><span class="line">    <span class="keyword">if</span> (m != <span class="literal">null</span>)</span><br><span class="line">        <span class="comment">// map å­˜åœ¨åˆ™è°ƒç”¨ map.removeï¼Œthisæ—¶å½“å‰ThreadLocalï¼Œä»¥thisä¸ºkeyåˆ é™¤å¯¹åº”çš„å®ä½“</span></span><br><span class="line">        m.remove(<span class="built_in">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><hr><h4 id="LocalMap"><a href="#LocalMap" class="headerlink" title="LocalMap"></a>LocalMap</h4><h5 id="æˆå‘˜å±æ€§"><a href="#æˆå‘˜å±æ€§" class="headerlink" title="æˆå‘˜å±æ€§"></a>æˆå‘˜å±æ€§</h5><p>ThreadLocalMap æ˜¯ ThreadLocal çš„å†…éƒ¨ç±»ï¼Œæ²¡æœ‰å®ç° Map æ¥å£ï¼Œç”¨ç‹¬ç«‹çš„æ–¹å¼å®ç°äº† Map çš„åŠŸèƒ½ï¼Œå…¶å†…éƒ¨ Entry ä¹Ÿæ˜¯ç‹¬ç«‹å®ç°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆå§‹åŒ–å½“å‰ map å†…éƒ¨æ•£åˆ—è¡¨æ•°ç»„çš„åˆå§‹é•¿åº¦ 16</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">INITIAL_CAPACITY</span> <span class="operator">=</span> <span class="number">16</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å­˜æ”¾æ•°æ®çš„tableï¼Œæ•°ç»„é•¿åº¦å¿…é¡»æ˜¯2çš„æ•´æ¬¡å¹‚ã€‚</span></span><br><span class="line"><span class="keyword">private</span> Entry[] table;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ•°ç»„é‡Œé¢ entrys çš„ä¸ªæ•°ï¼Œå¯ä»¥ç”¨äºåˆ¤æ–­ table å½“å‰ä½¿ç”¨é‡æ˜¯å¦è¶…è¿‡é˜ˆå€¼</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿›è¡Œæ‰©å®¹çš„é˜ˆå€¼ï¼Œè¡¨ä½¿ç”¨é‡å¤§äºå®ƒçš„æ—¶å€™è¿›è¡Œæ‰©å®¹ã€‚</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">int</span> threshold;</span><br></pre></td></tr></table></figure><p>å­˜å‚¨ç»“æ„ Entryï¼š</p><ul><li>Entry ç»§æ‰¿ WeakReferenceï¼Œkey æ˜¯å¼±å¼•ç”¨ï¼Œç›®çš„æ˜¯å°† ThreadLocal å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸå’Œçº¿ç¨‹ç”Ÿå‘½å‘¨æœŸè§£ç»‘</li><li>Entry é™åˆ¶åªèƒ½ç”¨ ThreadLocal ä½œä¸º keyï¼Œkey ä¸º null (entry.get() &#x3D;&#x3D; null) æ„å‘³ç€ key ä¸å†è¢«å¼•ç”¨ï¼Œentry ä¹Ÿå¯ä»¥ä» table ä¸­æ¸…é™¤</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Entry</span> <span class="keyword">extends</span> <span class="title class_">WeakReference</span>&lt;ThreadLocal&lt;?&gt;&gt; &#123;</span><br><span class="line">    Object value;</span><br><span class="line">    Entry(ThreadLocal&lt;?&gt; k, Object v) &#123;</span><br><span class="line">        <span class="comment">// this.referent = referent = key;</span></span><br><span class="line">        <span class="built_in">super</span>(k);</span><br><span class="line">        value = v;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ„é€ æ–¹æ³•ï¼šå»¶è¿Ÿåˆå§‹åŒ–çš„ï¼Œçº¿ç¨‹ç¬¬ä¸€æ¬¡å­˜å‚¨ threadLocal - value æ—¶æ‰ä¼šåˆ›å»º threadLocalMap å¯¹è±¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ThreadLocalMap(ThreadLocal&lt;?&gt; firstKey, Object firstValue) &#123;</span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–tableï¼Œåˆ›å»ºä¸€ä¸ªé•¿åº¦ä¸º16çš„Entryæ•°ç»„</span></span><br><span class="line">    table = <span class="keyword">new</span> <span class="title class_">Entry</span>[INITIAL_CAPACITY];</span><br><span class="line">    <span class="comment">// ã€å¯»å€ç®—æ³•ã€‘è®¡ç®—ç´¢å¼•</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> firstKey.threadLocalHashCode &amp; (INITIAL_CAPACITY - <span class="number">1</span>);</span><br><span class="line">    <span class="comment">// åˆ›å»º entry å¯¹è±¡ï¼Œå­˜æ”¾åˆ°æŒ‡å®šä½ç½®çš„ slot ä¸­</span></span><br><span class="line">    table[i] = <span class="keyword">new</span> <span class="title class_">Entry</span>(firstKey, firstValue);</span><br><span class="line">    <span class="comment">// æ•°æ®æ€»é‡æ˜¯ 1</span></span><br><span class="line">    size = <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// å°†é˜ˆå€¼è®¾ç½®ä¸º ï¼ˆå½“å‰æ•°ç»„é•¿åº¦ * 2ï¼‰/ 3ã€‚</span></span><br><span class="line">    setThreshold(INITIAL_CAPACITY);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h5 id="æˆå‘˜æ–¹æ³•-1"><a href="#æˆå‘˜æ–¹æ³•-1" class="headerlink" title="æˆå‘˜æ–¹æ³•"></a>æˆå‘˜æ–¹æ³•</h5><ul><li><p>set()ï¼šæ·»åŠ æ•°æ®ï¼ŒThreadLocalMap ä½¿ç”¨<strong>çº¿æ€§æ¢æµ‹æ³•æ¥è§£å†³å“ˆå¸Œå†²çª</strong></p><ul><li><p>è¯¥æ–¹æ³•ä¼šä¸€ç›´æ¢æµ‹ä¸‹ä¸€ä¸ªåœ°å€ï¼Œç›´åˆ°æœ‰ç©ºçš„åœ°å€åæ’å…¥ï¼Œè‹¥æ’å…¥å Map æ•°é‡è¶…è¿‡é˜ˆå€¼ï¼Œæ•°ç»„ä¼šæ‰©å®¹ä¸ºåŸæ¥çš„ 2 å€</p><p>å‡è®¾å½“å‰ table é•¿åº¦ä¸º16ï¼Œè®¡ç®—å‡ºæ¥ key çš„ hash å€¼ä¸º 14ï¼Œå¦‚æœ table[14] ä¸Šå·²ç»æœ‰å€¼ï¼Œå¹¶ä¸”å…¶ key ä¸å½“å‰ key ä¸ä¸€è‡´ï¼Œé‚£ä¹ˆå°±å‘ç”Ÿäº† hash å†²çªï¼Œè¿™ä¸ªæ—¶å€™å°† 14 åŠ  1 å¾—åˆ° 15ï¼Œå– table[15] è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœè¿˜æ˜¯å†²çªä¼šå›åˆ° 0ï¼Œå– table[0]ï¼Œä»¥æ­¤ç±»æ¨ï¼Œç›´åˆ°å¯ä»¥æ’å…¥ï¼Œå¯ä»¥æŠŠ Entry[]  table çœ‹æˆä¸€ä¸ª<strong>ç¯å½¢æ•°ç»„</strong></p></li><li><p>çº¿æ€§æ¢æµ‹æ³•ä¼šå‡ºç°<strong>å †ç§¯é—®é¢˜</strong>ï¼Œå¯ä»¥é‡‡å–å¹³æ–¹æ¢æµ‹æ³•è§£å†³</p></li><li><p>åœ¨æ¢æµ‹è¿‡ç¨‹ä¸­ ThreadLocal ä¼šå¤ç”¨ key ä¸º null çš„è„ Entry å¯¹è±¡ï¼Œå¹¶è¿›è¡Œåƒåœ¾æ¸…ç†ï¼Œé˜²æ­¢å‡ºç°å†…å­˜æ³„æ¼</p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">set</span><span class="params">(ThreadLocal&lt;?&gt; key, Object value)</span> &#123;</span><br><span class="line">    <span class="comment">// è·å–æ•£åˆ—è¡¨</span></span><br><span class="line">    ThreadLocal.ThreadLocalMap.Entry[] tab = table;</span><br><span class="line">    <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> tab.length;</span><br><span class="line">    <span class="comment">// å“ˆå¸Œå¯»å€</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> key.threadLocalHashCode &amp; (len-<span class="number">1</span>);</span><br><span class="line">    <span class="comment">// ä½¿ç”¨çº¿æ€§æ¢æµ‹æ³•å‘åæŸ¥æ‰¾å…ƒç´ ï¼Œç¢°åˆ° entry ä¸ºç©ºæ—¶åœæ­¢æ¢æµ‹</span></span><br><span class="line">    <span class="keyword">for</span> (ThreadLocal.ThreadLocalMap.<span class="type">Entry</span> <span class="variable">e</span> <span class="operator">=</span> tab[i]; e != <span class="literal">null</span>; e = tab[i = nextIndex(i, len)]) &#123;</span><br><span class="line">        <span class="comment">// è·å–å½“å‰å…ƒç´  key</span></span><br><span class="line">        ThreadLocal&lt;?&gt; k = e.get();</span><br><span class="line">        <span class="comment">// ThreadLocal å¯¹åº”çš„ key å­˜åœ¨ï¼Œã€ç›´æ¥è¦†ç›–ä¹‹å‰çš„å€¼ã€‘</span></span><br><span class="line">        <span class="keyword">if</span> (k == key) &#123;</span><br><span class="line">            e.value = value;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ã€è¿™ä¸¤ä¸ªæ¡ä»¶è°å…ˆæˆç«‹ä¸ä¸€å®šï¼Œæ‰€ä»¥ replaceStaleEntry ä¸­è¿˜éœ€è¦åˆ¤æ–­ k == key çš„æƒ…å†µã€‘</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// key ä¸º nullï¼Œä½†æ˜¯å€¼ä¸ä¸º nullï¼Œè¯´æ˜ä¹‹å‰çš„ ThreadLocal å¯¹è±¡å·²ç»è¢«å›æ”¶äº†ï¼Œå½“å‰æ˜¯ã€è¿‡æœŸæ•°æ®ã€‘</span></span><br><span class="line">        <span class="keyword">if</span> (k == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// ã€ç¢°åˆ°ä¸€ä¸ªè¿‡æœŸçš„ slotï¼Œå½“å‰æ•°æ®å¤ç”¨è¯¥æ§½ä½ï¼Œæ›¿æ¢è¿‡æœŸæ•°æ®ã€‘</span></span><br><span class="line">            <span class="comment">// è¿™ä¸ªæ–¹æ³•è¿˜è¿›è¡Œäº†åƒåœ¾æ¸…ç†åŠ¨ä½œï¼Œé˜²æ­¢å†…å­˜æ³„æ¼</span></span><br><span class="line">            replaceStaleEntry(key, value, i);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// é€»è¾‘åˆ°è¿™è¯´æ˜ç¢°åˆ° slot == null çš„ä½ç½®ï¼Œåˆ™åœ¨ç©ºå…ƒç´ çš„ä½ç½®åˆ›å»ºä¸€ä¸ªæ–°çš„ Entry</span></span><br><span class="line">    tab[i] = <span class="keyword">new</span> <span class="title class_">Entry</span>(key, value);</span><br><span class="line">    <span class="comment">// æ•°é‡ + 1</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">sz</span> <span class="operator">=</span> ++size;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ã€åšä¸€æ¬¡å¯å‘å¼æ¸…ç†ã€‘ï¼Œå¦‚æœæ²¡æœ‰æ¸…é™¤ä»»ä½• entry å¹¶ä¸”ã€å½“å‰ä½¿ç”¨é‡è¾¾åˆ°äº†è´Ÿè½½å› å­æ‰€å®šä¹‰ï¼Œé‚£ä¹ˆè¿›è¡Œ rehash</span></span><br><span class="line">    <span class="keyword">if</span> (!cleanSomeSlots(i, sz) &amp;&amp; sz &gt;= threshold)</span><br><span class="line">        <span class="comment">// æ‰©å®¹</span></span><br><span class="line">        rehash();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è·å–ã€ç¯å½¢æ•°ç»„ã€‘çš„ä¸‹ä¸€ä¸ªç´¢å¼•</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">nextIndex</span><span class="params">(<span class="type">int</span> i, <span class="type">int</span> len)</span> &#123;</span><br><span class="line">    <span class="comment">// ç´¢å¼•è¶Šç•Œåä» 0 å¼€å§‹ç»§ç»­è·å–</span></span><br><span class="line">    <span class="keyword">return</span> ((i + <span class="number">1</span> &lt; len) ? i + <span class="number">1</span> : <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åœ¨æŒ‡å®šä½ç½®æ’å…¥æŒ‡å®šçš„æ•°æ®</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">replaceStaleEntry</span><span class="params">(ThreadLocal&lt;?&gt; key, Object value, <span class="type">int</span> staleSlot)</span> &#123;</span><br><span class="line">    <span class="comment">// è·å–æ•£åˆ—è¡¨</span></span><br><span class="line">    Entry[] tab = table;</span><br><span class="line">    <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> tab.length;</span><br><span class="line">    Entry e;</span><br><span class="line"><span class="comment">// æ¢æµ‹å¼æ¸…ç†çš„å¼€å§‹ä¸‹æ ‡ï¼Œé»˜è®¤ä»å½“å‰ staleSlot å¼€å§‹</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">slotToExpunge</span> <span class="operator">=</span> staleSlot;</span><br><span class="line">    <span class="comment">// ä»¥å½“å‰ staleSlot å¼€å§‹ã€å‘å‰è¿­ä»£æŸ¥æ‰¾ã€‘ï¼Œæ‰¾åˆ°ç´¢å¼•é å‰è¿‡æœŸæ•°æ®ï¼Œæ‰¾åˆ°ä»¥åæ›¿æ¢ slotToExpunge å€¼</span></span><br><span class="line">    <span class="comment">// ã€ä¿è¯åœ¨ä¸€ä¸ªåŒºé—´æ®µå†…ï¼Œä»æœ€å‰é¢çš„è¿‡æœŸæ•°æ®å¼€å§‹æ¸…ç†ã€‘</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> prevIndex(staleSlot, len); (e = tab[i]) != <span class="literal">null</span>; i = prevIndex(i, len))</span><br><span class="line">        <span class="keyword">if</span> (e.get() == <span class="literal">null</span>)</span><br><span class="line">            slotToExpunge = i;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä»¥ staleSlot ã€å‘åå»æŸ¥æ‰¾ã€‘ï¼Œç›´åˆ°ç¢°åˆ° null ä¸ºæ­¢ï¼Œè¿˜æ˜¯çº¿æ€§æ¢æµ‹</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> nextIndex(staleSlot, len); (e = tab[i]) != <span class="literal">null</span>; i = nextIndex(i, len)) &#123;</span><br><span class="line">        <span class="comment">// è·å–å½“å‰èŠ‚ç‚¹çš„ key</span></span><br><span class="line">        ThreadLocal&lt;?&gt; k = e.get();</span><br><span class="line"><span class="comment">// æ¡ä»¶æˆç«‹è¯´æ˜æ˜¯ã€æ›¿æ¢é€»è¾‘ã€‘</span></span><br><span class="line">        <span class="keyword">if</span> (k == key) &#123;</span><br><span class="line">            e.value = value;</span><br><span class="line">            <span class="comment">// å› ä¸ºæœ¬æ¥è¦åœ¨ staleSlot ç´¢å¼•å¤„æ’å…¥è¯¥æ•°æ®ï¼Œç°åœ¨æ‰¾åˆ°äº†iç´¢å¼•å¤„çš„keyä¸æ•°æ®ä¸€è‡´</span></span><br><span class="line">            <span class="comment">// ä½†æ˜¯ i ä½ç½®è·ç¦»æ­£ç¡®çš„ä½ç½®æ›´è¿œï¼Œå› ä¸ºæ˜¯å‘åæŸ¥æ‰¾ï¼Œæ‰€ä»¥è¿˜æ˜¯è¦åœ¨ staleSlot ä½ç½®æ’å…¥å½“å‰ entry</span></span><br><span class="line">            <span class="comment">// ç„¶åå°† table[staleSlot] è¿™ä¸ªè¿‡æœŸæ•°æ®æ”¾åˆ°å½“å‰å¾ªç¯åˆ°çš„ table[i] è¿™ä¸ªä½ç½®ï¼Œ</span></span><br><span class="line">            tab[i] = tab[staleSlot];</span><br><span class="line">            tab[staleSlot] = e;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// æ¡ä»¶æˆç«‹è¯´æ˜å‘å‰æŸ¥æ‰¾è¿‡æœŸæ•°æ®å¹¶æœªæ‰¾åˆ°è¿‡æœŸçš„ entryï¼Œä½† staleSlot ä½ç½®å·²ç»ä¸æ˜¯è¿‡æœŸæ•°æ®äº†ï¼Œi ä½ç½®æ‰æ˜¯</span></span><br><span class="line">            <span class="keyword">if</span> (slotToExpunge == staleSlot)</span><br><span class="line">                slotToExpunge = i;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// ã€æ¸…ç†è¿‡æœŸæ•°æ®ï¼ŒexpungeStaleEntry æ¢æµ‹å¼æ¸…ç†ï¼ŒcleanSomeSlots å¯å‘å¼æ¸…ç†ã€‘</span></span><br><span class="line">            cleanSomeSlots(expungeStaleEntry(slotToExpunge), len);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">// æ¡ä»¶æˆç«‹è¯´æ˜å½“å‰éå†çš„ entry æ˜¯ä¸€ä¸ªè¿‡æœŸæ•°æ®ï¼Œå¹¶ä¸”è¯¥ä½ç½®å‰é¢ä¹Ÿæ²¡æœ‰è¿‡æœŸæ•°æ®</span></span><br><span class="line">        <span class="keyword">if</span> (k == <span class="literal">null</span> &amp;&amp; slotToExpunge == staleSlot)</span><br><span class="line">            <span class="comment">// æ¢æµ‹å¼æ¸…ç†è¿‡æœŸæ•°æ®çš„å¼€å§‹ä¸‹æ ‡ä¿®æ”¹ä¸ºå½“å‰å¾ªç¯çš„ indexï¼Œå› ä¸º staleSlot ä¼šæ”¾å…¥è¦æ·»åŠ çš„æ•°æ®</span></span><br><span class="line">            slotToExpunge = i;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// å‘åæŸ¥æ‰¾è¿‡ç¨‹ä¸­å¹¶æœªå‘ç° k == key çš„ entryï¼Œè¯´æ˜å½“å‰æ˜¯ä¸€ä¸ªã€å–ä»£è¿‡æœŸæ•°æ®é€»è¾‘ã€‘</span></span><br><span class="line">    <span class="comment">// åˆ é™¤åŸæœ‰çš„æ•°æ®å¼•ç”¨ï¼Œé˜²æ­¢å†…å­˜æ³„éœ²</span></span><br><span class="line">    tab[staleSlot].value = <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">// staleSlot ä½ç½®æ·»åŠ æ•°æ®ï¼Œã€ä¸Šé¢çš„æ‰€æœ‰é€»è¾‘éƒ½ä¸ä¼šæ›´æ”¹ staleSlot çš„å€¼ã€‘</span></span><br><span class="line">    tab[staleSlot] = <span class="keyword">new</span> <span class="title class_">Entry</span>(key, value);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¡ä»¶æˆç«‹è¯´æ˜é™¤äº† staleSlot ä»¥å¤–ï¼Œè¿˜å‘ç°å…¶å®ƒçš„è¿‡æœŸ slotï¼Œæ‰€ä»¥è¦ã€å¼€å¯æ¸…ç†æ•°æ®çš„é€»è¾‘ã€‘</span></span><br><span class="line">    <span class="keyword">if</span> (slotToExpunge != staleSlot)</span><br><span class="line">        cleanSomeSlots(expungeStaleEntry(slotToExpunge), len);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/JUC-replaceStaleEntry%E6%B5%81%E7%A8%8B.png"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">prevIndex</span><span class="params">(<span class="type">int</span> i, <span class="type">int</span> len)</span> &#123;</span><br><span class="line">    <span class="comment">// å½¢æˆä¸€ä¸ªç¯ç»•å¼çš„è®¿é—®ï¼Œå¤´ç´¢å¼•è¶Šç•Œåç½®ä¸ºå°¾ç´¢å¼•</span></span><br><span class="line">    <span class="keyword">return</span> ((i - <span class="number">1</span> &gt;= <span class="number">0</span>) ? i - <span class="number">1</span> : len - <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>getEntry()ï¼šThreadLocal çš„ get æ–¹æ³•ä»¥å½“å‰çš„ ThreadLocal ä¸º keyï¼Œè°ƒç”¨ getEntry è·å–å¯¹åº”çš„å­˜å‚¨å®ä½“ e</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Entry <span class="title function_">getEntry</span><span class="params">(ThreadLocal&lt;?&gt; key)</span> &#123;</span><br><span class="line">    <span class="comment">// å“ˆå¸Œå¯»å€</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> key.threadLocalHashCode &amp; (table.length - <span class="number">1</span>);</span><br><span class="line">    <span class="comment">// è®¿é—®æ•£åˆ—è¡¨ä¸­æŒ‡å®šæŒ‡å®šä½ç½®çš„ slot </span></span><br><span class="line">    <span class="type">Entry</span> <span class="variable">e</span> <span class="operator">=</span> table[i];</span><br><span class="line">    <span class="comment">// æ¡ä»¶æˆç«‹ï¼Œè¯´æ˜ slot æœ‰å€¼å¹¶ä¸” key å°±æ˜¯è¦å¯»æ‰¾çš„ keyï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">    <span class="keyword">if</span> (e != <span class="literal">null</span> &amp;&amp; e.get() == key)</span><br><span class="line">        <span class="keyword">return</span> e;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="comment">// è¿›è¡Œçº¿æ€§æ¢æµ‹</span></span><br><span class="line">        <span class="keyword">return</span> getEntryAfterMiss(key, i, e);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// çº¿æ€§æ¢æµ‹å¯»å€</span></span><br><span class="line"><span class="keyword">private</span> Entry <span class="title function_">getEntryAfterMiss</span><span class="params">(ThreadLocal&lt;?&gt; key, <span class="type">int</span> i, Entry e)</span> &#123;</span><br><span class="line">    <span class="comment">// è·å–æ•£åˆ—è¡¨</span></span><br><span class="line">    Entry[] tab = table;</span><br><span class="line">    <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> tab.length;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¼€å§‹éå†ï¼Œç¢°åˆ° slot == null çš„æƒ…å†µï¼Œæœç´¢ç»“æŸ</span></span><br><span class="line">    <span class="keyword">while</span> (e != <span class="literal">null</span>) &#123;</span><br><span class="line"><span class="comment">// è·å–å½“å‰ slot ä¸­ entry å¯¹è±¡çš„ key</span></span><br><span class="line">        ThreadLocal&lt;?&gt; k = e.get();</span><br><span class="line">        <span class="comment">// æ¡ä»¶æˆç«‹è¯´æ˜æ‰¾åˆ°äº†ï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">        <span class="keyword">if</span> (k == key)</span><br><span class="line">            <span class="keyword">return</span> e;</span><br><span class="line">        <span class="keyword">if</span> (k == <span class="literal">null</span>)</span><br><span class="line">             <span class="comment">// è¿‡æœŸæ•°æ®ï¼Œã€æ¢æµ‹å¼è¿‡æœŸæ•°æ®å›æ”¶ã€‘</span></span><br><span class="line">            expungeStaleEntry(i);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="comment">// æ›´æ–° index ç»§ç»­å‘åèµ°</span></span><br><span class="line">            i = nextIndex(i, len);</span><br><span class="line">        <span class="comment">// è·å–ä¸‹ä¸€ä¸ªæ§½ä½ä¸­çš„ entry</span></span><br><span class="line">        e = tab[i];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è¯´æ˜å½“å‰åŒºæ®µæ²¡æœ‰æ‰¾åˆ°ç›¸åº”æ•°æ®</span></span><br><span class="line">    <span class="comment">// ã€å› ä¸ºå­˜æ”¾æ•°æ®æ˜¯çº¿æ€§çš„å‘åå¯»æ‰¾æ§½ä½ï¼Œéƒ½æ˜¯ç´§æŒ¨ç€çš„ï¼Œä¸å¯èƒ½è¶Šè¿‡ä¸€ä¸ª ç©ºæ§½ä½ åœ¨åé¢æ”¾ã€‘ï¼Œå¯ä»¥å‡å°‘éå†çš„æ¬¡æ•°</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>rehash()ï¼šè§¦å‘ä¸€æ¬¡å…¨é‡æ¸…ç†ï¼Œå¦‚æœæ•°ç»„é•¿åº¦å¤§äºç­‰äºé•¿åº¦çš„ <code>2/3 * 3/4 = 1/2</code>ï¼Œåˆ™è¿›è¡Œ resize</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">rehash</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// æ¸…æ¥šå½“å‰æ•£åˆ—è¡¨å†…çš„ã€æ‰€æœ‰ã€‘è¿‡æœŸçš„æ•°æ®</span></span><br><span class="line">    expungeStaleEntries();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// threshold = len * 2 / 3ï¼Œå°±æ˜¯ 2/3 * (1 - 1/4)</span></span><br><span class="line">    <span class="keyword">if</span> (size &gt;= threshold - threshold / <span class="number">4</span>)</span><br><span class="line">        resize();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">expungeStaleEntries</span><span class="params">()</span> &#123;</span><br><span class="line">    Entry[] tab = table;</span><br><span class="line">    <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> tab.length;</span><br><span class="line">    <span class="comment">// ã€éå†æ‰€æœ‰çš„æ§½ä½ï¼Œæ¸…ç†è¿‡æœŸæ•°æ®ã€‘</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; len; j++) &#123;</span><br><span class="line">        <span class="type">Entry</span> <span class="variable">e</span> <span class="operator">=</span> tab[j];</span><br><span class="line">        <span class="keyword">if</span> (e != <span class="literal">null</span> &amp;&amp; e.get() == <span class="literal">null</span>)</span><br><span class="line">            expungeStaleEntry(j);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Entry <strong>æ•°ç»„ä¸ºæ‰©å®¹ä¸ºåŸæ¥çš„ 2 å€</strong> ï¼Œé‡æ–°è®¡ç®— key çš„æ•£åˆ—å€¼ï¼Œå¦‚æœé‡åˆ° key ä¸º null çš„æƒ…å†µï¼Œä¼šå°†å…¶ value ä¹Ÿç½®ä¸º nullï¼Œå¸®åŠ© GC</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">resize</span><span class="params">()</span> &#123;</span><br><span class="line">    Entry[] oldTab = table;</span><br><span class="line">    <span class="type">int</span> <span class="variable">oldLen</span> <span class="operator">=</span> oldTab.length;</span><br><span class="line">    <span class="comment">// æ–°æ•°ç»„çš„é•¿åº¦æ˜¯è€æ•°ç»„çš„äºŒå€</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">newLen</span> <span class="operator">=</span> oldLen * <span class="number">2</span>;</span><br><span class="line">    Entry[] newTab = <span class="keyword">new</span> <span class="title class_">Entry</span>[newLen];</span><br><span class="line">    <span class="comment">// ç»Ÿè®¡æ–°tableä¸­çš„entryæ•°é‡</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"><span class="comment">// éå†è€è¡¨ï¼Œè¿›è¡Œã€æ•°æ®è¿ç§»ã€‘</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; oldLen; ++j) &#123;</span><br><span class="line">        <span class="comment">// è®¿é—®è€è¡¨çš„æŒ‡å®šä½ç½®çš„ entry</span></span><br><span class="line">        <span class="type">Entry</span> <span class="variable">e</span> <span class="operator">=</span> oldTab[j];</span><br><span class="line">        <span class="comment">// æ¡ä»¶æˆç«‹è¯´æ˜è€è¡¨ä¸­è¯¥ä½ç½®æœ‰æ•°æ®ï¼Œå¯èƒ½æ˜¯è¿‡æœŸæ•°æ®ä¹Ÿå¯èƒ½ä¸æ˜¯</span></span><br><span class="line">        <span class="keyword">if</span> (e != <span class="literal">null</span>) &#123;</span><br><span class="line">            ThreadLocal&lt;?&gt; k = e.get();</span><br><span class="line">            <span class="comment">// è¿‡æœŸæ•°æ®</span></span><br><span class="line">            <span class="keyword">if</span> (k == <span class="literal">null</span>) &#123;</span><br><span class="line">                e.value = <span class="literal">null</span>; <span class="comment">// Help the GC</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// éè¿‡æœŸæ•°æ®ï¼Œåœ¨æ–°è¡¨ä¸­è¿›è¡Œå“ˆå¸Œå¯»å€</span></span><br><span class="line">                <span class="type">int</span> <span class="variable">h</span> <span class="operator">=</span> k.threadLocalHashCode &amp; (newLen - <span class="number">1</span>);</span><br><span class="line">                <span class="comment">// ã€çº¿ç¨‹æ¢æµ‹ã€‘</span></span><br><span class="line">                <span class="keyword">while</span> (newTab[h] != <span class="literal">null</span>)</span><br><span class="line">                    h = nextIndex(h, newLen);</span><br><span class="line">                <span class="comment">// å°†æ•°æ®å­˜æ”¾åˆ°æ–°è¡¨åˆé€‚çš„ slot ä¸­</span></span><br><span class="line">                newTab[h] = e;</span><br><span class="line">                count++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// è®¾ç½®ä¸‹ä¸€æ¬¡è§¦å‘æ‰©å®¹çš„æŒ‡æ ‡ï¼šthreshold = len * 2 / 3;</span></span><br><span class="line">    setThreshold(newLen);</span><br><span class="line">    size = count;</span><br><span class="line">    <span class="comment">// å°†æ‰©å®¹åçš„æ–°è¡¨èµ‹å€¼ç»™ threadLocalMap å†…éƒ¨æ•£åˆ—è¡¨æ•°ç»„å¼•ç”¨</span></span><br><span class="line">    table = newTab;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>remove()ï¼šåˆ é™¤ Entry</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">remove</span><span class="params">(ThreadLocal&lt;?&gt; key)</span> &#123;</span><br><span class="line">    Entry[] tab = table;</span><br><span class="line">    <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> tab.length;</span><br><span class="line">    <span class="comment">// å“ˆå¸Œå¯»å€</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> key.threadLocalHashCode &amp; (len-<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">Entry</span> <span class="variable">e</span> <span class="operator">=</span> tab[i]; e != <span class="literal">null</span>; e = tab[i = nextIndex(i, len)]) &#123;</span><br><span class="line">        <span class="comment">// æ‰¾åˆ°äº†å¯¹åº”çš„ key</span></span><br><span class="line">        <span class="keyword">if</span> (e.get() == key) &#123;</span><br><span class="line">            <span class="comment">// è®¾ç½® key ä¸º null</span></span><br><span class="line">            e.clear();</span><br><span class="line">            <span class="comment">// æ¢æµ‹å¼æ¸…ç†</span></span><br><span class="line">            expungeStaleEntry(i);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><hr><h5 id="æ¸…ç†æ–¹æ³•"><a href="#æ¸…ç†æ–¹æ³•" class="headerlink" title="æ¸…ç†æ–¹æ³•"></a>æ¸…ç†æ–¹æ³•</h5><ul><li><p>æ¢æµ‹å¼æ¸…ç†ï¼šæ²¿ç€å¼€å§‹ä½ç½®å‘åæ¢æµ‹æ¸…ç†è¿‡æœŸæ•°æ®ï¼Œæ²¿é€”ä¸­ç¢°åˆ°æœªè¿‡æœŸæ•°æ®åˆ™å°†æ­¤æ•°æ® rehash åœ¨ table æ•°ç»„ä¸­çš„å®šä½ï¼Œé‡å®šä½åçš„å…ƒç´ ç†è®ºä¸Šæ›´æ¥è¿‘ <code>i = entry.key &amp; (table.length - 1)</code>ï¼Œè®©<strong>æ•°æ®çš„æ’åˆ—æ›´ç´§å‡‘</strong>ï¼Œä¼šä¼˜åŒ–æ•´ä¸ªæ•£åˆ—è¡¨æŸ¥è¯¢æ€§èƒ½</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// table[staleSlot] æ˜¯ä¸€ä¸ªè¿‡æœŸæ•°æ®ï¼Œä»¥è¿™ä¸ªä½ç½®å¼€å§‹ç»§ç»­å‘åæŸ¥æ‰¾è¿‡æœŸæ•°æ®</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">int</span> <span class="title function_">expungeStaleEntry</span><span class="params">(<span class="type">int</span> staleSlot)</span> &#123;</span><br><span class="line">    <span class="comment">// è·å–æ•£åˆ—è¡¨å’Œæ•°ç»„é•¿åº¦</span></span><br><span class="line">    Entry[] tab = table;</span><br><span class="line">    <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> tab.length;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// help gcï¼Œå…ˆæŠŠå½“å‰è¿‡æœŸçš„ entry ç½®ç©ºï¼Œåœ¨å–æ¶ˆå¯¹ entry çš„å¼•ç”¨</span></span><br><span class="line">    tab[staleSlot].value = <span class="literal">null</span>;</span><br><span class="line">    tab[staleSlot] = <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">// æ•°é‡-1</span></span><br><span class="line">    size--;</span><br><span class="line"></span><br><span class="line">    Entry e;</span><br><span class="line">    <span class="type">int</span> i;</span><br><span class="line">    <span class="comment">// ä» staleSlot å¼€å§‹å‘åéå†ï¼Œç›´åˆ°ç¢°åˆ° slot == null ç»“æŸï¼Œã€åŒºé—´å†…æ¸…ç†è¿‡æœŸæ•°æ®ã€‘</span></span><br><span class="line">    <span class="keyword">for</span> (i = nextIndex(staleSlot, len); (e = tab[i]) != <span class="literal">null</span>; i = nextIndex(i, len)) &#123;</span><br><span class="line">        ThreadLocal&lt;?&gt; k = e.get();</span><br><span class="line">        <span class="comment">// å½“å‰ entry æ˜¯è¿‡æœŸæ•°æ®</span></span><br><span class="line">        <span class="keyword">if</span> (k == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// help gc</span></span><br><span class="line">            e.value = <span class="literal">null</span>;</span><br><span class="line">            tab[i] = <span class="literal">null</span>;</span><br><span class="line">            size--;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// å½“å‰ entry ä¸æ˜¯è¿‡æœŸæ•°æ®çš„é€»è¾‘ï¼Œã€rehashã€‘</span></span><br><span class="line">            <span class="comment">// é‡æ–°è®¡ç®—å½“å‰ entry å¯¹åº”çš„ index</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">h</span> <span class="operator">=</span> k.threadLocalHashCode &amp; (len - <span class="number">1</span>);</span><br><span class="line">            <span class="comment">// æ¡ä»¶æˆç«‹è¯´æ˜å½“å‰ entry å­˜å‚¨æ—¶å‘ç”Ÿè¿‡ hash å†²çªï¼Œå‘ååç§»è¿‡äº†</span></span><br><span class="line">            <span class="keyword">if</span> (h != i) &#123;</span><br><span class="line">                <span class="comment">// å½“å‰ä½ç½®ç½®ç©º</span></span><br><span class="line">                tab[i] = <span class="literal">null</span>;</span><br><span class="line">                <span class="comment">// ä»¥æ­£ç¡®ä½ç½® h å¼€å§‹ï¼Œå‘åæŸ¥æ‰¾ç¬¬ä¸€ä¸ªå¯ä»¥å­˜æ”¾ entry çš„ä½ç½®</span></span><br><span class="line">                <span class="keyword">while</span> (tab[h] != <span class="literal">null</span>)</span><br><span class="line">                    h = nextIndex(h, len);</span><br><span class="line">                <span class="comment">// å°†å½“å‰å…ƒç´ æ”¾å…¥åˆ°ã€è·ç¦»æ­£ç¡®ä½ç½®æ›´è¿‘çš„ä½ç½®ï¼Œæœ‰å¯èƒ½å°±æ˜¯æ­£ç¡®ä½ç½®ã€‘</span></span><br><span class="line">                tab[h] = e;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è¿”å› slot = null çš„æ§½ä½ç´¢å¼•ï¼Œå›¾ä¾‹æ˜¯ 7ï¼Œè¿™ä¸ªç´¢å¼•ä»£è¡¨ã€ç´¢å¼•å‰é¢çš„åŒºé—´å·²ç»æ¸…ç†å®Œæˆåƒåœ¾äº†ã€‘</span></span><br><span class="line">    <span class="keyword">return</span> i;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/JUC-ThreadLocalæ¢æµ‹å¼æ¸…ç†1.png" style="zoom:67%;" /><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/JUC-ThreadLocalæ¢æµ‹å¼æ¸…ç†2.png" style="zoom:67%;" /></li><li><p>å¯å‘å¼æ¸…ç†ï¼šå‘åå¾ªç¯æ‰«æè¿‡æœŸæ•°æ®ï¼Œå‘ç°è¿‡æœŸæ•°æ®è°ƒç”¨æ¢æµ‹å¼æ¸…ç†æ–¹æ³•ï¼Œå¦‚æœè¿ç»­å‡ æ¬¡çš„å¾ªç¯éƒ½æ²¡æœ‰å‘ç°è¿‡æœŸæ•°æ®ï¼Œå°±åœæ­¢æ‰«æ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//  i è¡¨ç¤ºå¯å‘å¼æ¸…ç†å·¥ä½œå¼€å§‹ä½ç½®ï¼Œä¸€èˆ¬æ˜¯ç©º slotï¼Œn ä¸€èˆ¬ä¼ é€’çš„æ˜¯ table.length </span></span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">cleanSomeSlots</span><span class="params">(<span class="type">int</span> i, <span class="type">int</span> n)</span> &#123;</span><br><span class="line">    <span class="comment">// è¡¨ç¤ºå¯å‘å¼æ¸…ç†å·¥ä½œæ˜¯å¦æ¸…é™¤äº†è¿‡æœŸæ•°æ®</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">removed</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">// è·å–å½“å‰ map çš„æ•£åˆ—è¡¨å¼•ç”¨</span></span><br><span class="line">    Entry[] tab = table;</span><br><span class="line">    <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> tab.length;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">// è·å–ä¸‹ä¸€ä¸ªç´¢å¼•ï¼Œå› ä¸ºæ¢æµ‹å¼è¿”å›çš„ slot ä¸º null</span></span><br><span class="line">        i = nextIndex(i, len);</span><br><span class="line">        <span class="type">Entry</span> <span class="variable">e</span> <span class="operator">=</span> tab[i];</span><br><span class="line">        <span class="comment">// æ¡ä»¶æˆç«‹è¯´æ˜æ˜¯è¿‡æœŸçš„æ•°æ®ï¼Œkey è¢« gc äº†</span></span><br><span class="line">        <span class="keyword">if</span> (e != <span class="literal">null</span> &amp;&amp; e.get() == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// ã€å‘ç°è¿‡æœŸæ•°æ®é‡ç½® n ä¸ºæ•°ç»„çš„é•¿åº¦ã€‘</span></span><br><span class="line">            n = len;</span><br><span class="line">            <span class="comment">// è¡¨ç¤ºæ¸…ç†è¿‡è¿‡æœŸæ•°æ®</span></span><br><span class="line">            removed = <span class="literal">true</span>;</span><br><span class="line">            <span class="comment">// ä»¥å½“å‰è¿‡æœŸçš„ slot ä¸ºå¼€å§‹èŠ‚ç‚¹ åšä¸€æ¬¡æ¢æµ‹å¼æ¸…ç†å·¥ä½œ</span></span><br><span class="line">            i = expungeStaleEntry(i);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å‡è®¾ table é•¿åº¦ä¸º 16</span></span><br><span class="line">        <span class="comment">// 16 &gt;&gt;&gt; 1 ==&gt; 8ï¼Œ8 &gt;&gt;&gt; 1 ==&gt; 4ï¼Œ4 &gt;&gt;&gt; 1 ==&gt; 2ï¼Œ2 &gt;&gt;&gt; 1 ==&gt; 1ï¼Œ1 &gt;&gt;&gt; 1 ==&gt; 0</span></span><br><span class="line">        <span class="comment">// è¿ç»­ç»è¿‡è¿™ä¹ˆå¤šæ¬¡å¾ªç¯ã€æ²¡æœ‰æ‰«æåˆ°è¿‡æœŸæ•°æ®ã€‘ï¼Œå°±åœæ­¢å¾ªç¯ï¼Œæ‰«æåˆ°ç©º slot ä¸ç®—ï¼Œå› ä¸ºä¸æ˜¯è¿‡æœŸæ•°æ®</span></span><br><span class="line">    &#125; <span class="keyword">while</span> ((n &gt;&gt;&gt;= <span class="number">1</span>) != <span class="number">0</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è¿”å›æ¸…é™¤æ ‡è®°</span></span><br><span class="line">    <span class="keyword">return</span> removed;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p>å‚è€ƒè§†é¢‘ï¼š<a href="https://space.bilibili.com/457326371/">https://space.bilibili.com/457326371/</a></p><hr><h4 id="å†…å­˜æ³„æ¼"><a href="#å†…å­˜æ³„æ¼" class="headerlink" title="å†…å­˜æ³„æ¼"></a>å†…å­˜æ³„æ¼</h4><p>Memory leakï¼šå†…å­˜æ³„æ¼æ˜¯æŒ‡ç¨‹åºä¸­åŠ¨æ€åˆ†é…çš„å †å†…å­˜ç”±äºæŸç§åŸå› æœªé‡Šæ”¾æˆ–æ— æ³•é‡Šæ”¾ï¼Œé€ æˆç³»ç»Ÿå†…å­˜çš„æµªè´¹ï¼Œå¯¼è‡´ç¨‹åºè¿è¡Œé€Ÿåº¦å‡æ…¢ç”šè‡³ç³»ç»Ÿå´©æºƒç­‰ä¸¥é‡åæœï¼Œå†…å­˜æ³„æ¼çš„å †ç§¯ç»ˆå°†å¯¼è‡´å†…å­˜æº¢å‡º</p><ul><li><p>å¦‚æœ key ä½¿ç”¨å¼ºå¼•ç”¨ï¼šä½¿ç”¨å®Œ ThreadLocal ï¼ŒthreadLocal Ref è¢«å›æ”¶ï¼Œä½†æ˜¯ threadLocalMap çš„ Entry å¼ºå¼•ç”¨äº† threadLocalï¼Œé€ æˆ threadLocal æ— æ³•è¢«å›æ”¶ï¼Œæ— æ³•å®Œå…¨é¿å…å†…å­˜æ³„æ¼</p><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/JUC-ThreadLocalå†…å­˜æ³„æ¼å¼ºå¼•ç”¨.png" style="zoom:67%;" /></li><li><p>å¦‚æœ key ä½¿ç”¨å¼±å¼•ç”¨ï¼šä½¿ç”¨å®Œ ThreadLocal ï¼ŒthreadLocal Ref è¢«å›æ”¶ï¼ŒThreadLocalMap åªæŒæœ‰ ThreadLocal çš„å¼±å¼•ç”¨ï¼Œæ‰€ä»¥threadlocal ä¹Ÿå¯ä»¥è¢«å›æ”¶ï¼Œæ­¤æ—¶ Entry ä¸­çš„ key &#x3D; nullã€‚ä½†æ²¡æœ‰æ‰‹åŠ¨åˆ é™¤è¿™ä¸ª Entry æˆ–è€… CurrentThread ä¾ç„¶è¿è¡Œï¼Œä¾ç„¶å­˜åœ¨å¼ºå¼•ç”¨é“¾ï¼Œvalue ä¸ä¼šè¢«å›æ”¶ï¼Œè€Œè¿™å— value æ°¸è¿œä¸ä¼šè¢«è®¿é—®åˆ°ï¼Œä¹Ÿä¼šå¯¼è‡´ value å†…å­˜æ³„æ¼</p><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/JUC-ThreadLocalå†…å­˜æ³„æ¼å¼±å¼•ç”¨.png" style="zoom:67%;" /></li><li><p>ä¸¤ä¸ªä¸»è¦åŸå› ï¼š</p><ul><li>æ²¡æœ‰æ‰‹åŠ¨åˆ é™¤è¿™ä¸ª Entry</li><li>CurrentThread ä¾ç„¶è¿è¡Œ</li></ul></li></ul><p>æ ¹æœ¬åŸå› ï¼šThreadLocalMap æ˜¯ Threadçš„ä¸€ä¸ªå±æ€§ï¼Œ<strong>ç”Ÿå‘½å‘¨æœŸè·Ÿ Thread ä¸€æ ·é•¿</strong>ï¼Œå¦‚æœæ²¡æœ‰æ‰‹åŠ¨åˆ é™¤å¯¹åº” Entry å°±ä¼šå¯¼è‡´å†…å­˜æ³„æ¼</p><p>è§£å†³æ–¹æ³•ï¼šä½¿ç”¨å®Œ ThreadLocal ä¸­å­˜å‚¨çš„å†…å®¹åå°†å®ƒ remove æ‰å°±å¯ä»¥</p><p>ThreadLocal å†…éƒ¨è§£å†³æ–¹æ³•ï¼šåœ¨ ThreadLocalMap ä¸­çš„ set&#x2F;getEntry æ–¹æ³•ä¸­ï¼Œé€šè¿‡çº¿æ€§æ¢æµ‹æ³•å¯¹ key è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚æœ key ä¸º nullï¼ˆThreadLocal ä¸º nullï¼‰ä¼šå¯¹ Entry è¿›è¡Œåƒåœ¾å›æ”¶ã€‚æ‰€ä»¥<strong>ä½¿ç”¨å¼±å¼•ç”¨æ¯”å¼ºå¼•ç”¨å¤šä¸€å±‚ä¿éšœ</strong>ï¼Œå°±ç®—ä¸è°ƒç”¨ removeï¼Œä¹Ÿæœ‰æœºä¼šè¿›è¡Œ GC</p><hr><h4 id="å˜é‡ä¼ é€’"><a href="#å˜é‡ä¼ é€’" class="headerlink" title="å˜é‡ä¼ é€’"></a>å˜é‡ä¼ é€’</h4><h5 id="åŸºæœ¬ä½¿ç”¨-2"><a href="#åŸºæœ¬ä½¿ç”¨-2" class="headerlink" title="åŸºæœ¬ä½¿ç”¨"></a>åŸºæœ¬ä½¿ç”¨</h5><p>çˆ¶å­çº¿ç¨‹ï¼šåˆ›å»ºå­çº¿ç¨‹çš„çº¿ç¨‹æ˜¯çˆ¶çº¿ç¨‹ï¼Œæ¯”å¦‚å®ä¾‹ä¸­çš„ main çº¿ç¨‹å°±æ˜¯çˆ¶çº¿ç¨‹</p><p>ThreadLocal ä¸­å­˜å‚¨çš„æ˜¯çº¿ç¨‹çš„å±€éƒ¨å˜é‡ï¼Œå¦‚æœæƒ³<strong>å®ç°çº¿ç¨‹é—´å±€éƒ¨å˜é‡ä¼ é€’</strong>å¯ä»¥ä½¿ç”¨ InheritableThreadLocal ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    ThreadLocal&lt;String&gt; threadLocal = <span class="keyword">new</span> <span class="title class_">InheritableThreadLocal</span>&lt;&gt;();</span><br><span class="line">    threadLocal.set(<span class="string">&quot;çˆ¶çº¿ç¨‹è®¾ç½®çš„å€¼&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; System.out.println(<span class="string">&quot;å­çº¿ç¨‹è¾“å‡ºï¼š&quot;</span> + threadLocal.get())).start();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// å­çº¿ç¨‹è¾“å‡ºï¼šçˆ¶çº¿ç¨‹è®¾ç½®çš„å€¼</span></span><br></pre></td></tr></table></figure><hr><h5 id="å®ç°åŸç†-1"><a href="#å®ç°åŸç†-1" class="headerlink" title="å®ç°åŸç†"></a>å®ç°åŸç†</h5><p>InheritableThreadLocal æºç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InheritableThreadLocal</span>&lt;T&gt; <span class="keyword">extends</span> <span class="title class_">ThreadLocal</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">protected</span> T <span class="title function_">childValue</span><span class="params">(T parentValue)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> parentValue;</span><br><span class="line">    &#125;</span><br><span class="line">    ThreadLocalMap <span class="title function_">getMap</span><span class="params">(Thread t)</span> &#123;</span><br><span class="line">       <span class="keyword">return</span> t.inheritableThreadLocals;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">createMap</span><span class="params">(Thread t, T firstValue)</span> &#123;</span><br><span class="line">        t.inheritableThreadLocals = <span class="keyword">new</span> <span class="title class_">ThreadLocalMap</span>(<span class="built_in">this</span>, firstValue);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®ç°çˆ¶å­çº¿ç¨‹é—´çš„å±€éƒ¨å˜é‡å…±äº«éœ€è¦è¿½æº¯åˆ° Thread å¯¹è±¡çš„æ„é€ æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(ThreadGroup g, Runnable target, String name, <span class="type">long</span> stackSize, AccessControlContext acc,</span></span><br><span class="line"><span class="params">                  // è¯¥å‚æ•°é»˜è®¤æ˜¯ <span class="literal">true</span></span></span><br><span class="line"><span class="params">                  <span class="type">boolean</span> inheritThreadLocals)</span> &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">    <span class="type">Thread</span> <span class="variable">parent</span> <span class="operator">=</span> currentThread();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ¤æ–­çˆ¶çº¿ç¨‹ï¼ˆåˆ›å»ºå­çº¿ç¨‹çš„çº¿ç¨‹ï¼‰çš„ inheritableThreadLocals å±æ€§ä¸ä¸º null</span></span><br><span class="line">    <span class="keyword">if</span> (inheritThreadLocals &amp;&amp; parent.inheritableThreadLocals != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// å¤åˆ¶çˆ¶çº¿ç¨‹çš„ inheritableThreadLocals å±æ€§ï¼Œå®ç°çˆ¶å­çº¿ç¨‹å±€éƒ¨å˜é‡å…±äº«</span></span><br><span class="line">        <span class="built_in">this</span>.inheritableThreadLocals = ThreadLocal.createInheritedMap(parent.inheritableThreadLocals); </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ..</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ã€æœ¬è´¨ä¸Šè¿˜æ˜¯åˆ›å»º ThreadLocalMapï¼Œåªæ˜¯æŠŠçˆ¶ç±»ä¸­çš„å¯ç»§æ‰¿æ•°æ®è®¾ç½®è¿›å»äº†ã€‘</span></span><br><span class="line"><span class="keyword">static</span> ThreadLocalMap <span class="title function_">createInheritedMap</span><span class="params">(ThreadLocalMap parentMap)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ThreadLocalMap</span>(parentMap);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="title function_">ThreadLocalMap</span><span class="params">(ThreadLocalMap parentMap)</span> &#123;</span><br><span class="line">    <span class="comment">// è·å–çˆ¶çº¿ç¨‹çš„å“ˆå¸Œè¡¨</span></span><br><span class="line">    Entry[] parentTable = parentMap.table;</span><br><span class="line">    <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> parentTable.length;</span><br><span class="line">    setThreshold(len);</span><br><span class="line">    table = <span class="keyword">new</span> <span class="title class_">Entry</span>[len];</span><br><span class="line"><span class="comment">// ã€é€ä¸ªå¤åˆ¶çˆ¶çº¿ç¨‹ ThreadLocalMap ä¸­çš„æ•°æ®ã€‘</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; len; j++) &#123;</span><br><span class="line">        <span class="type">Entry</span> <span class="variable">e</span> <span class="operator">=</span> parentTable[j];</span><br><span class="line">        <span class="keyword">if</span> (e != <span class="literal">null</span>) &#123;</span><br><span class="line">            ThreadLocal&lt;Object&gt; key = (ThreadLocal&lt;Object&gt;) e.get();</span><br><span class="line">            <span class="keyword">if</span> (key != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// è°ƒç”¨çš„æ˜¯ InheritableThreadLocal#childValue(T parentValue)</span></span><br><span class="line">                <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> key.childValue(e.value);</span><br><span class="line">                <span class="type">Entry</span> <span class="variable">c</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Entry</span>(key, value);</span><br><span class="line">                <span class="type">int</span> <span class="variable">h</span> <span class="operator">=</span> key.threadLocalHashCode &amp; (len - <span class="number">1</span>);</span><br><span class="line">                <span class="comment">// çº¿æ€§æ¢æµ‹</span></span><br><span class="line">                <span class="keyword">while</span> (table[h] != <span class="literal">null</span>)</span><br><span class="line">                    h = nextIndex(h, len);</span><br><span class="line">                table[h] = c;</span><br><span class="line">                size++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://blog.csdn.net/feichitianxia/article/details/110495764">https://blog.csdn.net/feichitianxia/article/details/110495764</a></p><hr><h2 id="çº¿ç¨‹æ± "><a href="#çº¿ç¨‹æ± " class="headerlink" title="çº¿ç¨‹æ± "></a>çº¿ç¨‹æ± </h2><h3 id="åŸºæœ¬æ¦‚è¿°"><a href="#åŸºæœ¬æ¦‚è¿°" class="headerlink" title="åŸºæœ¬æ¦‚è¿°"></a>åŸºæœ¬æ¦‚è¿°</h3><p>çº¿ç¨‹æ± ï¼šä¸€ä¸ªå®¹çº³å¤šä¸ªçº¿ç¨‹çš„å®¹å™¨ï¼Œå®¹å™¨ä¸­çš„çº¿ç¨‹å¯ä»¥é‡å¤ä½¿ç”¨ï¼Œçœå»äº†é¢‘ç¹åˆ›å»ºå’Œé”€æ¯çº¿ç¨‹å¯¹è±¡çš„æ“ä½œ</p><p>çº¿ç¨‹æ± ä½œç”¨ï¼š</p><ol><li>é™ä½èµ„æºæ¶ˆè€—ï¼Œå‡å°‘äº†åˆ›å»ºå’Œé”€æ¯çº¿ç¨‹çš„æ¬¡æ•°ï¼Œæ¯ä¸ªå·¥ä½œçº¿ç¨‹éƒ½å¯ä»¥è¢«é‡å¤åˆ©ç”¨ï¼Œå¯æ‰§è¡Œå¤šä¸ªä»»åŠ¡</li><li>æé«˜å“åº”é€Ÿåº¦ï¼Œå½“ä»»åŠ¡åˆ°è¾¾æ—¶ï¼Œå¦‚æœæœ‰çº¿ç¨‹å¯ä»¥ç›´æ¥ç”¨ï¼Œä¸ä¼šå‡ºç°ç³»ç»Ÿåƒµæ­»</li><li>æé«˜çº¿ç¨‹çš„å¯ç®¡ç†æ€§ï¼Œå¦‚æœæ— é™åˆ¶çš„åˆ›å»ºçº¿ç¨‹ï¼Œä¸ä»…ä¼šæ¶ˆè€—ç³»ç»Ÿèµ„æºï¼Œè¿˜ä¼šé™ä½ç³»ç»Ÿçš„ç¨³å®šæ€§ï¼Œä½¿ç”¨çº¿ç¨‹æ± å¯ä»¥è¿›è¡Œç»Ÿä¸€çš„åˆ†é…ï¼Œè°ƒä¼˜å’Œç›‘æ§</li></ol><p>çº¿ç¨‹æ± çš„æ ¸å¿ƒæ€æƒ³ï¼š<strong>çº¿ç¨‹å¤ç”¨</strong>ï¼ŒåŒä¸€ä¸ªçº¿ç¨‹å¯ä»¥è¢«é‡å¤ä½¿ç”¨ï¼Œæ¥å¤„ç†å¤šä¸ªä»»åŠ¡</p><p>æ± åŒ–æŠ€æœ¯ (Pool) ï¼šä¸€ç§ç¼–ç¨‹æŠ€å·§ï¼Œæ ¸å¿ƒæ€æƒ³æ˜¯èµ„æºå¤ç”¨ï¼Œåœ¨è¯·æ±‚é‡å¤§æ—¶èƒ½ä¼˜åŒ–åº”ç”¨æ€§èƒ½ï¼Œé™ä½ç³»ç»Ÿé¢‘ç¹å»ºè¿çš„èµ„æºå¼€é”€</p><hr><h3 id="é˜»å¡é˜Ÿåˆ—-1"><a href="#é˜»å¡é˜Ÿåˆ—-1" class="headerlink" title="é˜»å¡é˜Ÿåˆ—"></a>é˜»å¡é˜Ÿåˆ—</h3><h4 id="åŸºæœ¬ä»‹ç»-1"><a href="#åŸºæœ¬ä»‹ç»-1" class="headerlink" title="åŸºæœ¬ä»‹ç»"></a>åŸºæœ¬ä»‹ç»</h4><p>æœ‰ç•Œé˜Ÿåˆ—å’Œæ— ç•Œé˜Ÿåˆ—ï¼š</p><ul><li><p>æœ‰ç•Œé˜Ÿåˆ—ï¼šæœ‰å›ºå®šå¤§å°çš„é˜Ÿåˆ—ï¼Œæ¯”å¦‚è®¾å®šäº†å›ºå®šå¤§å°çš„ LinkedBlockingQueueï¼Œåˆæˆ–è€…å¤§å°ä¸º 0</p></li><li><p>æ— ç•Œé˜Ÿåˆ—ï¼šæ²¡æœ‰è®¾ç½®å›ºå®šå¤§å°çš„é˜Ÿåˆ—ï¼Œè¿™äº›é˜Ÿåˆ—å¯ä»¥ç›´æ¥å…¥é˜Ÿï¼Œç›´åˆ°æº¢å‡ºï¼ˆè¶…è¿‡ Integer.MAX_VALUEï¼‰ï¼Œæ‰€ä»¥ç›¸å½“äºæ— ç•Œ</p></li></ul><p>java.util.concurrent.BlockingQueue æ¥å£æœ‰ä»¥ä¸‹é˜»å¡é˜Ÿåˆ—çš„å®ç°ï¼š<strong>FIFO é˜Ÿåˆ—</strong> </p><ul><li>ArrayBlockQueueï¼šç”±æ•°ç»„ç»“æ„ç»„æˆçš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ—</li><li>LinkedBlockingQueueï¼šç”±é“¾è¡¨ç»“æ„ç»„æˆçš„æ— ç•Œï¼ˆé»˜è®¤å¤§å° Integer.MAX_VALUEï¼‰çš„é˜»å¡é˜Ÿåˆ—</li><li>PriorityBlockQueueï¼šæ”¯æŒä¼˜å…ˆçº§æ’åºçš„æ— ç•Œé˜»å¡é˜Ÿåˆ—</li><li>DelayedWorkQueueï¼šä½¿ç”¨ä¼˜å…ˆçº§é˜Ÿåˆ—å®ç°çš„å»¶è¿Ÿæ— ç•Œé˜»å¡é˜Ÿåˆ—</li><li>SynchronousQueueï¼šä¸å­˜å‚¨å…ƒç´ çš„é˜»å¡é˜Ÿåˆ—ï¼Œæ¯ä¸€ä¸ªç”Ÿäº§çº¿ç¨‹ä¼šé˜»å¡åˆ°æœ‰ä¸€ä¸ª put çš„çº¿ç¨‹æ”¾å…¥å…ƒç´ ä¸ºæ­¢</li><li>LinkedTransferQueueï¼šç”±é“¾è¡¨ç»“æ„ç»„æˆçš„æ— ç•Œé˜»å¡é˜Ÿåˆ—</li><li>LinkedBlockingDequeï¼šç”±é“¾è¡¨ç»“æ„ç»„æˆçš„<strong>åŒå‘</strong>é˜»å¡é˜Ÿåˆ—</li></ul><p>ä¸æ™®é€šé˜Ÿåˆ—ï¼ˆLinkedListã€ArrayListç­‰ï¼‰çš„ä¸åŒç‚¹åœ¨äºé˜»å¡é˜Ÿåˆ—ä¸­é˜»å¡æ·»åŠ å’Œé˜»å¡åˆ é™¤æ–¹æ³•ï¼Œä»¥åŠçº¿ç¨‹å®‰å…¨ï¼š</p><ul><li>é˜»å¡æ·»åŠ  put()ï¼šå½“é˜»å¡é˜Ÿåˆ—å…ƒç´ å·²æ»¡æ—¶ï¼Œæ·»åŠ é˜Ÿåˆ—å…ƒç´ çš„çº¿ç¨‹ä¼šè¢«é˜»å¡ï¼Œç›´åˆ°é˜Ÿåˆ—å…ƒç´ ä¸æ»¡æ—¶æ‰é‡æ–°å”¤é†’çº¿ç¨‹æ‰§è¡Œ</li><li>é˜»å¡åˆ é™¤ take()ï¼šåœ¨é˜Ÿåˆ—å…ƒç´ ä¸ºç©ºæ—¶ï¼Œåˆ é™¤é˜Ÿåˆ—å…ƒç´ çš„çº¿ç¨‹å°†è¢«é˜»å¡ï¼Œç›´åˆ°é˜Ÿåˆ—ä¸ä¸ºç©ºå†æ‰§è¡Œåˆ é™¤æ“ä½œï¼ˆä¸€èˆ¬ä¼šè¿”å›è¢«åˆ é™¤çš„å…ƒç´ )</li></ul><hr><h4 id="æ ¸å¿ƒæ–¹æ³•"><a href="#æ ¸å¿ƒæ–¹æ³•" class="headerlink" title="æ ¸å¿ƒæ–¹æ³•"></a>æ ¸å¿ƒæ–¹æ³•</h4><table><thead><tr><th>æ–¹æ³•ç±»å‹</th><th>æŠ›å‡ºå¼‚å¸¸</th><th>ç‰¹æ®Šå€¼</th><th>é˜»å¡</th><th>è¶…æ—¶</th></tr></thead><tbody><tr><td>æ’å…¥ï¼ˆå°¾ï¼‰</td><td>add(e)</td><td>offer(e)</td><td>put(e)</td><td>offer(e,time,unit)</td></tr><tr><td>ç§»é™¤ï¼ˆå¤´ï¼‰</td><td>remove()</td><td>poll()</td><td>take()</td><td>poll(time,unit)</td></tr><tr><td>æ£€æŸ¥ï¼ˆé˜Ÿé¦–å…ƒç´ ï¼‰</td><td>element()</td><td>peek()</td><td>ä¸å¯ç”¨</td><td>ä¸å¯ç”¨</td></tr></tbody></table><ul><li>æŠ›å‡ºå¼‚å¸¸ç»„ï¼š<ul><li>å½“é˜»å¡é˜Ÿåˆ—æ»¡æ—¶ï¼šåœ¨å¾€é˜Ÿåˆ—ä¸­ add æ’å…¥å…ƒç´ ä¼šæŠ›å‡º IIIegalStateException: Queue full</li><li>å½“é˜»å¡é˜Ÿåˆ—ç©ºæ—¶ï¼šå†å¾€é˜Ÿåˆ—ä¸­ remove ç§»é™¤å…ƒç´ ï¼Œä¼šæŠ›å‡º NoSuchException</li></ul></li><li>ç‰¹æ®Šå€¼ç»„ï¼š<ul><li>æ’å…¥æ–¹æ³•ï¼šæˆåŠŸ trueï¼Œå¤±è´¥ false</li><li>ç§»é™¤æ–¹æ³•ï¼šæˆåŠŸè¿”å›å‡ºé˜Ÿåˆ—å…ƒç´ ï¼Œé˜Ÿåˆ—æ²¡æœ‰å°±è¿”å› null</li></ul></li><li>é˜»å¡ç»„ï¼š<ul><li>å½“é˜»å¡é˜Ÿåˆ—æ»¡æ—¶ï¼Œç”Ÿäº§è€…ç»§ç»­å¾€é˜Ÿåˆ—é‡Œ put å…ƒç´ ï¼Œé˜Ÿåˆ—ä¼šä¸€ç›´é˜»å¡ç”Ÿäº§çº¿ç¨‹ç›´åˆ°é˜Ÿåˆ—æœ‰ç©ºé—´ put æ•°æ®æˆ–å“åº”ä¸­æ–­é€€å‡º</li><li>å½“é˜»å¡é˜Ÿåˆ—ç©ºæ—¶ï¼Œæ¶ˆè´¹è€…çº¿ç¨‹è¯•å›¾ä»é˜Ÿåˆ—é‡Œ take å…ƒç´ ï¼Œé˜Ÿåˆ—ä¼šä¸€ç›´é˜»å¡æ¶ˆè´¹è€…çº¿ç¨‹ç›´åˆ°é˜Ÿåˆ—ä¸­æœ‰å¯ç”¨å…ƒç´ </li></ul></li><li>è¶…æ—¶é€€å‡ºï¼šå½“é˜»å¡é˜Ÿåˆ—æ»¡æ—¶ï¼Œé˜Ÿé‡Œä¼šé˜»å¡ç”Ÿäº§è€…çº¿ç¨‹ä¸€å®šæ—¶é—´ï¼Œè¶…è¿‡é™æ—¶åç”Ÿäº§è€…çº¿ç¨‹ä¼šé€€å‡º</li></ul><hr><h4 id="é“¾è¡¨é˜Ÿåˆ—"><a href="#é“¾è¡¨é˜Ÿåˆ—" class="headerlink" title="é“¾è¡¨é˜Ÿåˆ—"></a>é“¾è¡¨é˜Ÿåˆ—</h4><h5 id="å…¥é˜Ÿå‡ºé˜Ÿ"><a href="#å…¥é˜Ÿå‡ºé˜Ÿ" class="headerlink" title="å…¥é˜Ÿå‡ºé˜Ÿ"></a>å…¥é˜Ÿå‡ºé˜Ÿ</h5><p>LinkedBlockingQueue æºç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LinkedBlockingQueue</span>&lt;E&gt; <span class="keyword">extends</span> <span class="title class_">AbstractQueue</span>&lt;E&gt;</span><br><span class="line"><span class="keyword">implements</span> <span class="title class_">BlockingQueue</span>&lt;E&gt;, java.io.Serializable &#123;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Node</span>&lt;E&gt; &#123;</span><br><span class="line">        E item;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">        * ä¸‹åˆ—ä¸‰ç§æƒ…å†µä¹‹ä¸€</span></span><br><span class="line"><span class="comment">        * - çœŸæ­£çš„åç»§èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment">        * - è‡ªå·±, å‘ç”Ÿåœ¨å‡ºé˜Ÿæ—¶</span></span><br><span class="line"><span class="comment">        * - null, è¡¨ç¤ºæ˜¯æ²¡æœ‰åç»§èŠ‚ç‚¹, æ˜¯å°¾èŠ‚ç‚¹äº†</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">        Node&lt;E&gt; next;</span><br><span class="line"></span><br><span class="line">        Node(E x) &#123; item = x; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¥é˜Ÿï¼š<strong>å°¾æ’æ³•</strong></p><ul><li><p>åˆå§‹åŒ–é“¾è¡¨ <code>last = head = new Node&lt;E&gt;(null)</code>ï¼Œ<strong>Dummy èŠ‚ç‚¹ç”¨æ¥å ä½</strong>ï¼Œitem ä¸º null</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">LinkedBlockingQueue</span><span class="params">(<span class="type">int</span> capacity)</span> &#123;</span><br><span class="line">    <span class="comment">// é»˜è®¤æ˜¯ Integer.MAX_VALUE</span></span><br><span class="line">    <span class="keyword">if</span> (capacity &lt;= <span class="number">0</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>();</span><br><span class="line">    <span class="built_in">this</span>.capacity = capacity;</span><br><span class="line">    last = head = <span class="keyword">new</span> <span class="title class_">Node</span>&lt;E&gt;(<span class="literal">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>å½“ä¸€ä¸ªèŠ‚ç‚¹å…¥é˜Ÿï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">enqueue</span><span class="params">(Node&lt;E&gt; node)</span> &#123;</span><br><span class="line">    <span class="comment">// ä»å³å‘å·¦è®¡ç®—</span></span><br><span class="line">    last = last.next = node;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/JUC-LinkedBlockingQueue%E5%85%A5%E9%98%9F%E6%B5%81%E7%A8%8B.png"></p></li><li><p>å†æ¥ä¸€ä¸ªèŠ‚ç‚¹å…¥é˜Ÿ <code>last = last.next = node</code></p></li></ul><p>å‡ºé˜Ÿï¼š<strong>å‡ºé˜Ÿå¤´èŠ‚ç‚¹</strong>ï¼ŒFIFO</p><ul><li><p>å‡ºé˜Ÿæºç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> E <span class="title function_">dequeue</span><span class="params">()</span> &#123;</span><br><span class="line">    Node&lt;E&gt; h = head;</span><br><span class="line">    <span class="comment">// è·å–ä¸´å¤´èŠ‚ç‚¹</span></span><br><span class="line">    Node&lt;E&gt; first = h.next;</span><br><span class="line">    <span class="comment">// è‡ªå·±æŒ‡å‘è‡ªå·±ï¼Œhelp GC</span></span><br><span class="line">    h.next = h;</span><br><span class="line">    head = first;</span><br><span class="line">    <span class="comment">// å‡ºé˜Ÿçš„å…ƒç´ </span></span><br><span class="line">    <span class="type">E</span> <span class="variable">x</span> <span class="operator">=</span> first.item;</span><br><span class="line">    <span class="comment">// ã€å½“å‰èŠ‚ç‚¹ç½®ä¸º Dummy èŠ‚ç‚¹ã€‘</span></span><br><span class="line">    first.item = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">return</span> x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p><code>h = head</code> â†’ <code>first = h.next</code> </p><p><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/JUC-LinkedBlockingQueue%E5%87%BA%E9%98%9F%E6%B5%81%E7%A8%8B1.png"></p></li><li><p><code>h.next = h</code> â†’ <code>head = first</code></p><p><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/JUC-LinkedBlockingQueue%E5%87%BA%E9%98%9F%E6%B5%81%E7%A8%8B2.png"></p><ul><li><code>first.item = null</code>ï¼šå½“å‰èŠ‚ç‚¹ç½®ä¸º Dummy èŠ‚ç‚¹</li></ul></li></ul><hr><h5 id="åŠ é”åˆ†æ"><a href="#åŠ é”åˆ†æ" class="headerlink" title="åŠ é”åˆ†æ"></a>åŠ é”åˆ†æ</h5><p>ç”¨äº†ä¸¤æŠŠé”å’Œ dummy èŠ‚ç‚¹ï¼š</p><ul><li>ç”¨ä¸€æŠŠé”ï¼ŒåŒä¸€æ—¶åˆ»ï¼Œæœ€å¤šåªå…è®¸æœ‰ä¸€ä¸ªçº¿ç¨‹ï¼ˆç”Ÿäº§è€…æˆ–æ¶ˆè´¹è€…ï¼ŒäºŒé€‰ä¸€ï¼‰æ‰§è¡Œ</li><li>ç”¨ä¸¤æŠŠé”ï¼ŒåŒä¸€æ—¶åˆ»ï¼Œå¯ä»¥å…è®¸ä¸¤ä¸ªçº¿ç¨‹åŒæ—¶ï¼ˆä¸€ä¸ªç”Ÿäº§è€…ä¸ä¸€ä¸ªæ¶ˆè´¹è€…ï¼‰æ‰§è¡Œ<ul><li>æ¶ˆè´¹è€…ä¸æ¶ˆè´¹è€…çº¿ç¨‹ä»ç„¶ä¸²è¡Œ</li><li>ç”Ÿäº§è€…ä¸ç”Ÿäº§è€…çº¿ç¨‹ä»ç„¶ä¸²è¡Œ</li></ul></li></ul><p>çº¿ç¨‹å®‰å…¨åˆ†æï¼š</p><ul><li><p>å½“èŠ‚ç‚¹æ€»æ•°å¤§äº 2 æ—¶ï¼ˆåŒ…æ‹¬ dummy èŠ‚ç‚¹ï¼‰ï¼Œ<strong>putLock ä¿è¯çš„æ˜¯ last èŠ‚ç‚¹çš„çº¿ç¨‹å®‰å…¨ï¼ŒtakeLock ä¿è¯çš„æ˜¯ head èŠ‚ç‚¹çš„çº¿ç¨‹å®‰å…¨</strong>ï¼Œä¸¤æŠŠé”ä¿è¯äº†å…¥é˜Ÿå’Œå‡ºé˜Ÿæ²¡æœ‰ç«äº‰</p></li><li><p>å½“èŠ‚ç‚¹æ€»æ•°ç­‰äº 2 æ—¶ï¼ˆå³ä¸€ä¸ª dummy èŠ‚ç‚¹ï¼Œä¸€ä¸ªæ­£å¸¸èŠ‚ç‚¹ï¼‰è¿™æ—¶å€™ï¼Œä»ç„¶æ˜¯ä¸¤æŠŠé”é”ä¸¤ä¸ªå¯¹è±¡ï¼Œä¸ä¼šç«äº‰</p></li><li><p>å½“èŠ‚ç‚¹æ€»æ•°ç­‰äº 1 æ—¶ï¼ˆå°±ä¸€ä¸ª dummy èŠ‚ç‚¹ï¼‰è¿™æ—¶ take çº¿ç¨‹ä¼šè¢« notEmpty æ¡ä»¶é˜»å¡ï¼Œæœ‰ç«äº‰ï¼Œä¼šé˜»å¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç”¨äº put(é˜»å¡) offer(éé˜»å¡)</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">putLock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Condition</span> <span class="variable">notFull</span> <span class="operator">=</span> putLock.newCondition();<span class="comment">// é˜»å¡ç­‰å¾…ä¸æ»¡ï¼Œè¯´æ˜å·²ç»æ»¡äº†</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// ç”¨äº take(é˜»å¡) poll(éé˜»å¡)</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">takeLock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Condition</span> <span class="variable">notEmpty</span> <span class="operator">=</span> takeLock.newCondition();<span class="comment">// é˜»å¡ç­‰å¾…ä¸ç©ºï¼Œè¯´æ˜å·²ç»æ˜¯ç©ºçš„</span></span><br></pre></td></tr></table></figure></li></ul><p>å…¥é˜Ÿå‡ºé˜Ÿï¼š</p><ul><li><p>put æ“ä½œï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">put</span><span class="params">(E e)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="comment">// ç©ºæŒ‡é’ˆå¼‚å¸¸</span></span><br><span class="line">    <span class="keyword">if</span> (e == <span class="literal">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">    <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">    <span class="comment">// æŠŠå¾…æ·»åŠ çš„å…ƒç´ å°è£…ä¸º node èŠ‚ç‚¹</span></span><br><span class="line">    Node&lt;E&gt; node = <span class="keyword">new</span> <span class="title class_">Node</span>&lt;E&gt;(e);</span><br><span class="line">    <span class="comment">// è·å–å…¨å±€ç”Ÿäº§é”</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">putLock</span> <span class="operator">=</span> <span class="built_in">this</span>.putLock;</span><br><span class="line">    <span class="comment">// count ç”¨æ¥ç»´æŠ¤å…ƒç´ è®¡æ•°</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">AtomicInteger</span> <span class="variable">count</span> <span class="operator">=</span> <span class="built_in">this</span>.count;</span><br><span class="line">    <span class="comment">// è·å–å¯æ‰“æ–­é”ï¼Œä¼šæŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">    putLock.lockInterruptibly();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// é˜Ÿåˆ—æ»¡äº†ç­‰å¾…</span></span><br><span class="line">        <span class="keyword">while</span> (count.get() == capacity) &#123;</span><br><span class="line">            <span class="comment">// ã€ç­‰å¾…é˜Ÿåˆ—ä¸æ»¡æ—¶ï¼Œå°±å¯ä»¥ç”Ÿäº§æ•°æ®ã€‘ï¼Œçº¿ç¨‹å¤„äº Waiting</span></span><br><span class="line">            notFull.await();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æœ‰ç©ºä½, å…¥é˜Ÿä¸”è®¡æ•°åŠ ä¸€ï¼Œå°¾æ’æ³•</span></span><br><span class="line">        enqueue(node);</span><br><span class="line">        <span class="comment">// è¿”å›è‡ªå¢å‰çš„æ•°å­—</span></span><br><span class="line">        c = count.getAndIncrement();</span><br><span class="line">        <span class="comment">// put å®Œé˜Ÿåˆ—è¿˜æœ‰ç©ºä½, å”¤é†’å…¶ä»–ç”Ÿäº§ put çº¿ç¨‹ï¼Œå”¤é†’ä¸€ä¸ªå‡å°‘ç«äº‰</span></span><br><span class="line">        <span class="keyword">if</span> (c + <span class="number">1</span> &lt; capacity)</span><br><span class="line">            notFull.signal();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// è§£é”</span></span><br><span class="line">        putLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// cè‡ªå¢å‰æ˜¯0ï¼Œè¯´æ˜ç”Ÿäº§äº†ä¸€ä¸ªå…ƒç´ ï¼Œå”¤é†’ä¸€ä¸ª take çº¿ç¨‹</span></span><br><span class="line">    <span class="keyword">if</span> (c == <span class="number">0</span>)</span><br><span class="line">        signalNotEmpty();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">signalNotEmpty</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">takeLock</span> <span class="operator">=</span> <span class="built_in">this</span>.takeLock;</span><br><span class="line">    takeLock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// è°ƒç”¨ notEmpty.signal()ï¼Œè€Œä¸æ˜¯ notEmpty.signalAll() æ˜¯ä¸ºäº†å‡å°‘ç«äº‰ï¼Œå› ä¸ºåªå‰©ä¸‹ä¸€ä¸ªå…ƒç´ </span></span><br><span class="line">        notEmpty.signal();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        takeLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>take æ“ä½œï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> E <span class="title function_">take</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    E x;</span><br><span class="line">    <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">    <span class="comment">// å…ƒç´ ä¸ªæ•°</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">AtomicInteger</span> <span class="variable">count</span> <span class="operator">=</span> <span class="built_in">this</span>.count;</span><br><span class="line">    <span class="comment">// è·å–å…¨å±€æ¶ˆè´¹é”</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">takeLock</span> <span class="operator">=</span> <span class="built_in">this</span>.takeLock;</span><br><span class="line">    <span class="comment">// å¯æ‰“æ–­é”</span></span><br><span class="line">    takeLock.lockInterruptibly();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// æ²¡æœ‰å…ƒç´ å¯ä»¥å‡ºé˜Ÿ</span></span><br><span class="line">        <span class="keyword">while</span> (count.get() == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// ã€é˜»å¡ç­‰å¾…é˜Ÿåˆ—ä¸ç©ºï¼Œå°±å¯ä»¥æ¶ˆè´¹æ•°æ®ã€‘ï¼Œçº¿ç¨‹å¤„äº Waiting</span></span><br><span class="line">            notEmpty.await();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å‡ºé˜Ÿï¼Œè®¡æ•°å‡ä¸€ï¼ŒFIFOï¼Œå‡ºé˜Ÿå¤´èŠ‚ç‚¹</span></span><br><span class="line">        x = dequeue();</span><br><span class="line">        <span class="comment">// è¿”å›è‡ªå‡å‰çš„æ•°å­—</span></span><br><span class="line">        c = count.getAndDecrement();</span><br><span class="line">        <span class="comment">// é˜Ÿåˆ—è¿˜æœ‰å…ƒç´ </span></span><br><span class="line">        <span class="keyword">if</span> (c &gt; <span class="number">1</span>)</span><br><span class="line">            <span class="comment">// å”¤é†’ä¸€ä¸ªæ¶ˆè´¹takeçº¿ç¨‹</span></span><br><span class="line">            notEmpty.signal();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        takeLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// c æ˜¯æ¶ˆè´¹å‰çš„æ•°æ®ï¼Œæ¶ˆè´¹å‰æ»¡äº†ï¼Œæ¶ˆè´¹ä¸€ä¸ªåè¿˜å‰©ä¸€ä¸ªç©ºä½ï¼Œå”¤é†’ç”Ÿäº§çº¿ç¨‹</span></span><br><span class="line">    <span class="keyword">if</span> (c == capacity)</span><br><span class="line">        <span class="comment">// è°ƒç”¨çš„æ˜¯ notFull.signal() è€Œä¸æ˜¯ notFull.signalAll() æ˜¯ä¸ºäº†å‡å°‘ç«äº‰</span></span><br><span class="line">        signalNotFull();</span><br><span class="line">    <span class="keyword">return</span> x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><hr><h5 id="æ€§èƒ½æ¯”è¾ƒ"><a href="#æ€§èƒ½æ¯”è¾ƒ" class="headerlink" title="æ€§èƒ½æ¯”è¾ƒ"></a>æ€§èƒ½æ¯”è¾ƒ</h5><p>ä¸»è¦åˆ—ä¸¾ LinkedBlockingQueue ä¸ ArrayBlockingQueue çš„æ€§èƒ½æ¯”è¾ƒï¼š</p><ul><li>Linked æ”¯æŒæœ‰ç•Œï¼ŒArray å¼ºåˆ¶æœ‰ç•Œ</li><li>Linked å®ç°æ˜¯é“¾è¡¨ï¼ŒArray å®ç°æ˜¯æ•°ç»„</li><li>Linked æ˜¯æ‡’æƒ°çš„ï¼Œè€Œ Array éœ€è¦æå‰åˆå§‹åŒ– Node æ•°ç»„</li><li>Linked æ¯æ¬¡å…¥é˜Ÿä¼šç”Ÿæˆæ–° Nodeï¼Œè€Œ Array çš„ Node æ˜¯æå‰åˆ›å»ºå¥½çš„</li><li>Linked ä¸¤æŠŠé”ï¼ŒArray ä¸€æŠŠé”</li></ul><hr><h4 id="åŒæ­¥é˜Ÿåˆ—"><a href="#åŒæ­¥é˜Ÿåˆ—" class="headerlink" title="åŒæ­¥é˜Ÿåˆ—"></a>åŒæ­¥é˜Ÿåˆ—</h4><h5 id="æˆå‘˜å±æ€§-1"><a href="#æˆå‘˜å±æ€§-1" class="headerlink" title="æˆå‘˜å±æ€§"></a>æˆå‘˜å±æ€§</h5><p>SynchronousQueue æ˜¯ä¸€ä¸ªä¸å­˜å‚¨å…ƒç´ çš„ BlockingQueueï¼Œ<strong>æ¯ä¸€ä¸ªç”Ÿäº§è€…å¿…é¡»é˜»å¡åŒ¹é…åˆ°ä¸€ä¸ªæ¶ˆè´¹è€…</strong></p><p>æˆå‘˜å˜é‡ï¼š</p><ul><li><p>è¿è¡Œå½“å‰ç¨‹åºçš„å¹³å°æ‹¥æœ‰ CPU çš„æ•°é‡ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">NCPUS</span> <span class="operator">=</span> Runtime.getRuntime().availableProcessors()</span><br></pre></td></tr></table></figure></li><li><p>æŒ‡å®šè¶…æ—¶æ—¶é—´åï¼Œå½“å‰çº¿ç¨‹æœ€å¤§è‡ªæ—‹æ¬¡æ•°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åªæœ‰ä¸€ä¸ª CPU æ—¶è‡ªæ—‹æ¬¡æ•°ä¸º 0ï¼Œæ‰€æœ‰ç¨‹åºéƒ½æ˜¯ä¸²è¡Œæ‰§è¡Œï¼Œå¤šæ ¸ CPU æ—¶è‡ªæ—‹ 32 æ¬¡æ˜¯ä¸€ä¸ªç»éªŒå€¼</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">maxTimedSpins</span> <span class="operator">=</span> (NCPUS &lt; <span class="number">2</span>) ? <span class="number">0</span> : <span class="number">32</span>;</span><br></pre></td></tr></table></figure><p>è‡ªæ—‹çš„åŸå› ï¼šçº¿ç¨‹æŒ‚èµ·å”¤é†’éœ€è¦è¿›è¡Œä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œæ¶‰åŠåˆ°ç”¨æˆ·æ€å’Œå†…æ ¸æ€çš„è½¬å˜ï¼Œæ˜¯éå¸¸æ¶ˆè€—èµ„æºçš„ã€‚è‡ªæ—‹æœŸé—´çº¿ç¨‹ä¼šä¸€ç›´æ£€æŸ¥è‡ªå·±çš„çŠ¶æ€æ˜¯å¦è¢«åŒ¹é…åˆ°ï¼Œå¦‚æœè‡ªæ—‹æœŸé—´è¢«åŒ¹é…åˆ°ï¼Œé‚£ä¹ˆç›´æ¥å°±è¿”å›äº†ï¼Œå¦‚æœè‡ªæ—‹æ¬¡æ•°è¾¾åˆ°æŸä¸ªæŒ‡æ ‡åï¼Œè¿˜æ˜¯ä¼šå°†å½“å‰çº¿ç¨‹æŒ‚èµ·</p></li><li><p>æœªæŒ‡å®šè¶…æ—¶æ—¶é—´ï¼Œå½“å‰çº¿ç¨‹æœ€å¤§è‡ªæ—‹æ¬¡æ•°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">maxUntimedSpins</span> <span class="operator">=</span> maxTimedSpins * <span class="number">16</span>;<span class="comment">// maxTimedSpins çš„ 16 å€</span></span><br></pre></td></tr></table></figure></li><li><p>æŒ‡å®šè¶…æ—¶é™åˆ¶çš„é˜ˆå€¼ï¼Œå°äºè¯¥å€¼çš„çº¿ç¨‹ä¸ä¼šè¢«æŒ‚èµ·ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">spinForTimeoutThreshold</span> <span class="operator">=</span> <span class="number">1000L</span>;<span class="comment">// çº³ç§’</span></span><br></pre></td></tr></table></figure><p>è¶…æ—¶æ—¶é—´è®¾ç½®çš„å°äºè¯¥å€¼ï¼Œå°±ä¼šè¢«ç¦æ­¢æŒ‚èµ·ï¼Œé˜»å¡å†å”¤é†’çš„æˆæœ¬å¤ªé«˜ï¼Œä¸å¦‚é€‰æ‹©è‡ªæ—‹ç©ºè½¬</p></li><li><p>è½¬æ¢å™¨ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> Transferer&lt;E&gt; transferer;</span><br><span class="line"><span class="keyword">abstract</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Transferer</span>&lt;E&gt; &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * å‚æ•°ä¸€ï¼šå¯ä»¥ä¸º nullï¼Œnull æ—¶è¡¨ç¤ºè¿™ä¸ªè¯·æ±‚æ˜¯ä¸€ä¸ª REQUEST ç±»å‹çš„è¯·æ±‚ï¼Œåä¹‹æ˜¯ä¸€ä¸ª DATA ç±»å‹çš„è¯·æ±‚</span></span><br><span class="line"><span class="comment">    * å‚æ•°äºŒï¼šå¦‚æœä¸º true è¡¨ç¤ºæŒ‡å®šäº†è¶…æ—¶æ—¶é—´ï¼Œå¦‚æœä¸º false è¡¨ç¤ºä¸æ”¯æŒè¶…æ—¶ï¼Œä¼šä¸€ç›´é˜»å¡åˆ°åŒ¹é…æˆ–è€…è¢«æ‰“æ–­</span></span><br><span class="line"><span class="comment">    * å‚æ•°ä¸‰ï¼šè¶…æ—¶æ—¶é—´é™åˆ¶ï¼Œå•ä½æ˜¯çº³ç§’</span></span><br><span class="line"><span class="comment">    </span></span><br><span class="line"><span class="comment">    * è¿”å›å€¼ï¼šè¿”å›å€¼å¦‚æœä¸ä¸º null è¡¨ç¤ºåŒ¹é…æˆåŠŸï¼ŒDATA ç±»å‹çš„è¯·æ±‚è¿”å›å½“å‰çº¿ç¨‹ put çš„æ•°æ®</span></span><br><span class="line"><span class="comment">    *      å¦‚æœè¿”å› nullï¼Œè¡¨ç¤ºè¯·æ±‚è¶…æ—¶æˆ–è¢«ä¸­æ–­</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    <span class="keyword">abstract</span> E <span class="title function_">transfer</span><span class="params">(E e, <span class="type">boolean</span> timed, <span class="type">long</span> nanos)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>æ„é€ æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">SynchronousQueue</span><span class="params">(<span class="type">boolean</span> fair)</span> &#123;</span><br><span class="line">    <span class="comment">// fair é»˜è®¤ false</span></span><br><span class="line">    <span class="comment">// éå…¬å¹³æ¨¡å¼å®ç°çš„æ•°æ®ç»“æ„æ˜¯æ ˆï¼Œå…¬å¹³æ¨¡å¼çš„æ•°æ®ç»“æ„æ˜¯é˜Ÿåˆ—</span></span><br><span class="line">    transferer = fair ? <span class="keyword">new</span> <span class="title class_">TransferQueue</span>&lt;E&gt;() : <span class="keyword">new</span> <span class="title class_">TransferStack</span>&lt;E&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>æˆå‘˜æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">offer</span><span class="params">(E e)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (e == <span class="literal">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">    <span class="keyword">return</span> transferer.transfer(e, <span class="literal">true</span>, <span class="number">0</span>) != <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> E <span class="title function_">poll</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> transferer.transfer(<span class="literal">null</span>, <span class="literal">true</span>, <span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><hr><h5 id="éå…¬å®ç°"><a href="#éå…¬å®ç°" class="headerlink" title="éå…¬å®ç°"></a>éå…¬å®ç°</h5><p>TransferStack æ˜¯éå…¬å¹³çš„åŒæ­¥é˜Ÿåˆ—ï¼Œå› ä¸ºæ‰€æœ‰çš„è¯·æ±‚éƒ½è¢«å‹å…¥æ ˆä¸­ï¼Œæ ˆé¡¶çš„å…ƒç´ ä¼šæœ€å…ˆå¾—åˆ°åŒ¹é…ï¼Œé€ æˆæ ˆåº•çš„ç­‰å¾…çº¿ç¨‹é¥¥é¥¿</p><p>TransferStack ç±»æˆå‘˜å˜é‡ï¼š</p><ul><li><p>è¯·æ±‚ç±»å‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¡¨ç¤º Node ç±»å‹ä¸ºè¯·æ±‚ç±»å‹</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">REQUEST</span>    <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"><span class="comment">// è¡¨ç¤º Nodeç±» å‹ä¸ºæ•°æ®ç±»å‹</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">DATA</span>       <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="comment">// è¡¨ç¤º Node ç±»å‹ä¸ºåŒ¹é…ä¸­ç±»å‹</span></span><br><span class="line"><span class="comment">// å‡è®¾æ ˆé¡¶å…ƒç´ ä¸º REQUEST-NODEï¼Œå½“å‰è¯·æ±‚ç±»å‹ä¸º DATAï¼Œå…¥æ ˆä¼šä¿®æ”¹ç±»å‹ä¸º FULFILLING ã€æ ˆé¡¶ &amp; æ ˆé¡¶ä¹‹ä¸‹çš„ä¸€ä¸ªnodeã€‘</span></span><br><span class="line"><span class="comment">// å‡è®¾æ ˆé¡¶å…ƒç´ ä¸º DATA-NODEï¼Œå½“å‰è¯·æ±‚ç±»å‹ä¸º REQUESTï¼Œå…¥æ ˆä¼šä¿®æ”¹ç±»å‹ä¸º FULFILLING ã€æ ˆé¡¶ &amp; æ ˆé¡¶ä¹‹ä¸‹çš„ä¸€ä¸ªnodeã€‘</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">FULFILLING</span> <span class="operator">=</span> <span class="number">2</span>;</span><br></pre></td></tr></table></figure></li><li><p>æ ˆé¡¶å…ƒç´ ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">volatile</span> SNode head;</span><br></pre></td></tr></table></figure></li></ul><p>å†…éƒ¨ç±» SNodeï¼š</p><ul><li><p>æˆå‘˜å˜é‡ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">SNode</span> &#123;</span><br><span class="line">    <span class="comment">// æŒ‡å‘ä¸‹ä¸€ä¸ªæ ˆå¸§</span></span><br><span class="line">    <span class="keyword">volatile</span> SNode next; </span><br><span class="line">    <span class="comment">// ä¸å½“å‰ node åŒ¹é…çš„èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">volatile</span> SNode match;</span><br><span class="line">    <span class="comment">// å‡è®¾å½“å‰nodeå¯¹åº”çš„çº¿ç¨‹è‡ªæ—‹æœŸé—´æœªè¢«åŒ¹é…æˆåŠŸï¼Œé‚£ä¹ˆnodeå¯¹åº”çš„çº¿ç¨‹éœ€è¦æŒ‚èµ·ï¼Œ</span></span><br><span class="line">    <span class="comment">// æŒ‚èµ·å‰ waiter ä¿å­˜å¯¹åº”çš„çº¿ç¨‹å¼•ç”¨ï¼Œæ–¹ä¾¿åŒ¹é…æˆåŠŸåï¼Œè¢«å”¤é†’ã€‚</span></span><br><span class="line">    <span class="keyword">volatile</span> Thread waiter;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ•°æ®åŸŸï¼Œä¸ä¸ºç©ºè¡¨ç¤ºå½“å‰ Node å¯¹åº”çš„è¯·æ±‚ç±»å‹ä¸º DATA ç±»å‹ï¼Œåä¹‹åˆ™è¡¨ç¤º Node ä¸º REQUEST ç±»å‹</span></span><br><span class="line">    Object item; </span><br><span class="line">    <span class="comment">// è¡¨ç¤ºå½“å‰Nodeçš„æ¨¡å¼ ã€DATA/REQUEST/FULFILLINGã€‘</span></span><br><span class="line">    <span class="type">int</span> mode;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>æ„é€ æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SNode(Object item) &#123;</span><br><span class="line">    <span class="built_in">this</span>.item = item;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>è®¾ç½®æ–¹æ³•ï¼šè®¾ç½® Node å¯¹è±¡çš„ next å­—æ®µï¼Œæ­¤å¤„<strong>å¯¹ CAS è¿›è¡Œäº†ä¼˜åŒ–</strong>ï¼Œæå‡äº† CAS çš„æ•ˆç‡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">boolean</span> <span class="title function_">casNext</span><span class="params">(SNode cmp, SNode val)</span> &#123;</span><br><span class="line">    <span class="comment">//ã€ä¼˜åŒ–ï¼šcmp == nextã€‘ï¼Œå¯ä»¥æå‡ä¸€éƒ¨åˆ†æ€§èƒ½ã€‚ cmp == next ä¸ç›¸ç­‰ï¼Œå°±æ²¡å¿…è¦èµ° casæŒ‡ä»¤ã€‚</span></span><br><span class="line">    <span class="keyword">return</span> cmp == next &amp;&amp; UNSAFE.compareAndSwapObject(<span class="built_in">this</span>, nextOffset, cmp, val);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>åŒ¹é…æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">boolean</span> <span class="title function_">tryMatch</span><span class="params">(SNode s)</span> &#123;</span><br><span class="line">    <span class="comment">// å½“å‰ node å°šæœªä¸ä»»ä½•èŠ‚ç‚¹å‘ç”Ÿè¿‡åŒ¹é…ï¼ŒCAS è®¾ç½® match å­—æ®µä¸º s èŠ‚ç‚¹ï¼Œè¡¨ç¤ºå½“å‰ node å·²ç»è¢«åŒ¹é…</span></span><br><span class="line">    <span class="keyword">if</span> (match == <span class="literal">null</span> &amp;&amp; UNSAFE.compareAndSwapObject(<span class="built_in">this</span>, matchOffset, <span class="literal">null</span>, s)) &#123;</span><br><span class="line">        <span class="comment">// å½“å‰ node å¦‚æœè‡ªæ—‹ç»“æŸï¼Œä¼š park é˜»å¡ï¼Œé˜»å¡å‰å°† node å¯¹åº”çš„ Thread ä¿ç•™åˆ° waiter å­—æ®µ</span></span><br><span class="line">        <span class="comment">// è·å–å½“å‰ node å¯¹åº”çš„é˜»å¡çº¿ç¨‹</span></span><br><span class="line">        <span class="type">Thread</span> <span class="variable">w</span> <span class="operator">=</span> waiter;</span><br><span class="line">        <span class="comment">// æ¡ä»¶æˆç«‹è¯´æ˜ node å¯¹åº”çš„ Thread æ­£åœ¨é˜»å¡</span></span><br><span class="line">        <span class="keyword">if</span> (w != <span class="literal">null</span>) &#123;</span><br><span class="line">            waiter = <span class="literal">null</span>;</span><br><span class="line">            <span class="comment">// ä½¿ç”¨ unpark æ–¹å¼å”¤é†’çº¿ç¨‹</span></span><br><span class="line">            LockSupport.unpark(w);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// åŒ¹é…æˆåŠŸè¿”å› true</span></span><br><span class="line">    <span class="keyword">return</span> match == s;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>å–æ¶ˆæ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å–æ¶ˆèŠ‚ç‚¹çš„æ–¹æ³•</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">tryCancel</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// match å­—æ®µæŒ‡å‘è‡ªå·±ï¼Œè¡¨ç¤ºè¿™ä¸ª node æ˜¯å–æ¶ˆçŠ¶æ€ï¼Œå–æ¶ˆçŠ¶æ€çš„ nodeï¼Œæœ€ç»ˆä¼šè¢«å¼ºåˆ¶ç§»é™¤å‡ºæ ˆ</span></span><br><span class="line">    UNSAFE.compareAndSwapObject(<span class="built_in">this</span>, matchOffset, <span class="literal">null</span>, <span class="built_in">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">boolean</span> <span class="title function_">isCancelled</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> match == <span class="built_in">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p>TransferStack ç±»æˆå‘˜æ–¹æ³•ï¼š</p><ul><li><p>snode()ï¼šå¡«å……èŠ‚ç‚¹æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> SNode <span class="title function_">snode</span><span class="params">(SNode s, Object e, SNode next, <span class="type">int</span> mode)</span> &#123;</span><br><span class="line">    <span class="comment">// å¼•ç”¨æŒ‡å‘ç©ºæ—¶ï¼Œsnode æ–¹æ³•ä¼šåˆ›å»ºä¸€ä¸ª SNode å¯¹è±¡ </span></span><br><span class="line">    <span class="keyword">if</span> (s == <span class="literal">null</span>) s = <span class="keyword">new</span> <span class="title class_">SNode</span>(e);</span><br><span class="line">    <span class="comment">// å¡«å……æ•°æ®</span></span><br><span class="line">    s.mode = mode;</span><br><span class="line">    s.next = next;</span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>transfer()ï¼šæ ¸å¿ƒæ–¹æ³•ï¼Œè¯·æ±‚åŒ¹é…å‡ºæ ˆï¼Œä¸åŒ¹é…é˜»å¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">E <span class="title function_">transfer</span><span class="params">(E e, <span class="type">boolean</span> timed, <span class="type">long</span> nanos)</span> &#123;</span><br><span class="line"><span class="comment">// åŒ…è£…å½“å‰çº¿ç¨‹çš„ node</span></span><br><span class="line">    <span class="type">SNode</span> <span class="variable">s</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">// æ ¹æ®å…ƒç´ åˆ¤æ–­å½“å‰çš„è¯·æ±‚ç±»å‹</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">mode</span> <span class="operator">=</span> (e == <span class="literal">null</span>) ? REQUEST : DATA;</span><br><span class="line"><span class="comment">// è‡ªæ—‹</span></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="comment">// è·å–æ ˆé¡¶æŒ‡é’ˆ</span></span><br><span class="line">        <span class="type">SNode</span> <span class="variable">h</span> <span class="operator">=</span> head;</span><br><span class="line">       <span class="comment">// ã€CASE1ã€‘ï¼šå½“å‰æ ˆä¸ºç©ºæˆ–è€…æ ˆé¡¶ node æ¨¡å¼ä¸å½“å‰è¯·æ±‚æ¨¡å¼ä¸€è‡´æ— æ³•åŒ¹é…ï¼Œåšå…¥æ ˆæ“ä½œ</span></span><br><span class="line">        <span class="keyword">if</span> (h == <span class="literal">null</span> || h.mode == mode) &#123;</span><br><span class="line">            <span class="comment">// å½“å‰è¯·æ±‚æ˜¯æ”¯æŒè¶…æ—¶çš„ï¼Œä½†æ˜¯ nanos &lt;= 0 è¯´æ˜è¿™ä¸ªè¯·æ±‚ä¸æ”¯æŒ â€œé˜»å¡ç­‰å¾…â€</span></span><br><span class="line">            <span class="keyword">if</span> (timed &amp;&amp; nanos &lt;= <span class="number">0</span>) &#123; </span><br><span class="line">                <span class="comment">// æ ˆé¡¶å…ƒç´ æ˜¯å–æ¶ˆçŠ¶æ€</span></span><br><span class="line">                <span class="keyword">if</span> (h != <span class="literal">null</span> &amp;&amp; h.isCancelled())</span><br><span class="line">                    <span class="comment">// æ ˆé¡¶å‡ºæ ˆï¼Œè®¾ç½®æ–°çš„æ ˆé¡¶</span></span><br><span class="line">                    casHead(h, h.next);</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    <span class="comment">// è¡¨ç¤ºã€åŒ¹é…å¤±è´¥ã€‘</span></span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="comment">// å…¥æ ˆ</span></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (casHead(h, s = snode(s, e, h, mode))) &#123;</span><br><span class="line">                <span class="comment">// ç­‰å¾…è¢«åŒ¹é…çš„é€»è¾‘ï¼Œæ­£å¸¸æƒ…å†µè¿”å›åŒ¹é…çš„èŠ‚ç‚¹ï¼›å–æ¶ˆæƒ…å†µè¿”å›å½“å‰èŠ‚ç‚¹ï¼Œå°±æ˜¯ s</span></span><br><span class="line">                <span class="type">SNode</span> <span class="variable">m</span> <span class="operator">=</span> awaitFulfill(s, timed, nanos);</span><br><span class="line">                <span class="comment">// è¯´æ˜å½“å‰ node æ˜¯ã€å–æ¶ˆçŠ¶æ€ã€‘</span></span><br><span class="line">                <span class="keyword">if</span> (m == s) &#123; </span><br><span class="line">                    <span class="comment">// å°†å–æ¶ˆèŠ‚ç‚¹å‡ºæ ˆ</span></span><br><span class="line">                    clean(s);</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// æ‰§è¡Œåˆ°è¿™è¯´æ˜ã€åŒ¹é…æˆåŠŸã€‘äº†</span></span><br><span class="line">                <span class="comment">// æ ˆé¡¶æœ‰èŠ‚ç‚¹å¹¶ä¸” åŒ¹é…èŠ‚ç‚¹è¿˜æœªå‡ºæ ˆï¼Œéœ€è¦ååŠ©å‡ºæ ˆ</span></span><br><span class="line">                <span class="keyword">if</span> ((h = head) != <span class="literal">null</span> &amp;&amp; h.next == s)</span><br><span class="line">                    casHead(h, s.next);</span><br><span class="line">                <span class="comment">// å½“å‰ node æ¨¡å¼ä¸º REQUEST ç±»å‹ï¼Œè¿”å›åŒ¹é…èŠ‚ç‚¹çš„ m.item æ•°æ®åŸŸ</span></span><br><span class="line">                <span class="comment">// å½“å‰ node æ¨¡å¼ä¸º DATA ç±»å‹ï¼šè¿”å› node.item æ•°æ®åŸŸï¼Œå½“å‰è¯·æ±‚æäº¤çš„æ•°æ® e</span></span><br><span class="line">                <span class="keyword">return</span> (E) ((mode == REQUEST) ? m.item : s.item);</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="comment">// ã€CASE2ã€‘ï¼šé€»è¾‘åˆ°è¿™è¯´æ˜è¯·æ±‚æ¨¡å¼ä¸ä¸€è‡´ï¼Œå¦‚æœæ ˆé¡¶ä¸æ˜¯ FULFILLING è¯´æ˜æ²¡è¢«å…¶ä»–èŠ‚ç‚¹åŒ¹é…ï¼Œã€å½“å‰å¯ä»¥åŒ¹é…ã€‘</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!isFulfilling(h.mode)) &#123;</span><br><span class="line">            <span class="comment">// å¤´èŠ‚ç‚¹æ˜¯å–æ¶ˆèŠ‚ç‚¹ï¼Œmatch æŒ‡å‘è‡ªå·±ï¼ŒååŠ©å‡ºæ ˆ</span></span><br><span class="line">            <span class="keyword">if</span> (h.isCancelled())</span><br><span class="line">                casHead(h, h.next);</span><br><span class="line">            <span class="comment">// å…¥æ ˆå½“å‰è¯·æ±‚çš„èŠ‚ç‚¹</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (casHead(h, s=snode(s, e, h, FULFILLING|mode))) &#123;</span><br><span class="line">                <span class="keyword">for</span> (;;) &#123; </span><br><span class="line">                    <span class="comment">// m æ˜¯ s çš„åŒ¹é…çš„èŠ‚ç‚¹</span></span><br><span class="line">                    <span class="type">SNode</span> <span class="variable">m</span> <span class="operator">=</span> s.next;</span><br><span class="line">                    <span class="comment">// m èŠ‚ç‚¹åœ¨ awaitFulfill æ–¹æ³•ä¸­è¢«ä¸­æ–­ï¼Œclean äº†è‡ªå·±</span></span><br><span class="line">                    <span class="keyword">if</span> (m == <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="comment">// æ¸…ç©ºæ ˆ</span></span><br><span class="line">                        casHead(s, <span class="literal">null</span>);</span><br><span class="line">                        s = <span class="literal">null</span>;</span><br><span class="line">                        <span class="comment">// è¿”å›åˆ°å¤–å±‚è‡ªæ—‹ä¸­</span></span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// è·å–åŒ¹é…èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">                    <span class="type">SNode</span> <span class="variable">mn</span> <span class="operator">=</span> m.next;</span><br><span class="line">                    <span class="comment">// å°è¯•åŒ¹é…ï¼Œã€åŒ¹é…æˆåŠŸã€‘ï¼Œåˆ™å°† fulfilling å’Œ m ä¸€èµ·å‡ºæ ˆï¼Œå¹¶ä¸”å”¤é†’è¢«åŒ¹é…çš„èŠ‚ç‚¹çš„çº¿ç¨‹</span></span><br><span class="line">                    <span class="keyword">if</span> (m.tryMatch(s)) &#123;</span><br><span class="line">                        casHead(s, mn);</span><br><span class="line">                        <span class="keyword">return</span> (E) ((mode == REQUEST) ? m.item : s.item);</span><br><span class="line">                    &#125; <span class="keyword">else</span></span><br><span class="line">                        <span class="comment">// åŒ¹é…å¤±è´¥ï¼Œå‡ºæ ˆ m</span></span><br><span class="line">                        s.casNext(m, mn);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="comment">// ã€CASE3ã€‘ï¼šæ ˆé¡¶æ¨¡å¼ä¸º FULFILLING æ¨¡å¼ï¼Œè¡¨ç¤ºã€æ ˆé¡¶å’Œæ ˆé¡¶ä¸‹é¢çš„èŠ‚ç‚¹æ­£åœ¨å‘ç”ŸåŒ¹é…ã€‘ï¼Œå½“å‰è¯·æ±‚éœ€è¦åšååŠ©å·¥ä½œ</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// h è¡¨ç¤ºçš„æ˜¯ fulfilling èŠ‚ç‚¹ï¼Œm è¡¨ç¤º fulfilling åŒ¹é…çš„èŠ‚ç‚¹</span></span><br><span class="line">            <span class="type">SNode</span> <span class="variable">m</span> <span class="operator">=</span> h.next;</span><br><span class="line">            <span class="keyword">if</span> (m == <span class="literal">null</span>)</span><br><span class="line">                <span class="comment">// æ¸…ç©ºæ ˆ</span></span><br><span class="line">                casHead(h, <span class="literal">null</span>);</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="type">SNode</span> <span class="variable">mn</span> <span class="operator">=</span> m.next;</span><br><span class="line">                <span class="comment">// m å’Œ h åŒ¹é…ï¼Œå”¤é†’ m ä¸­çš„çº¿ç¨‹</span></span><br><span class="line">                <span class="keyword">if</span> (m.tryMatch(h))</span><br><span class="line">                    casHead(h, mn);</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    h.casNext(m, mn);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>awaitFulfill()ï¼šé˜»å¡å½“å‰çº¿ç¨‹ç­‰å¾…è¢«åŒ¹é…ï¼Œè¿”å›åŒ¹é…çš„èŠ‚ç‚¹ï¼Œæˆ–è€…è¢«å–æ¶ˆçš„èŠ‚ç‚¹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">SNode <span class="title function_">awaitFulfill</span><span class="params">(SNode s, <span class="type">boolean</span> timed, <span class="type">long</span> nanos)</span> &#123;</span><br><span class="line">    <span class="comment">// ç­‰å¾…çš„æˆªæ­¢æ—¶é—´</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">long</span> <span class="variable">deadline</span> <span class="operator">=</span> timed ? System.nanoTime() + nanos : <span class="number">0L</span>;</span><br><span class="line">    <span class="comment">// å½“å‰çº¿ç¨‹</span></span><br><span class="line">    <span class="type">Thread</span> <span class="variable">w</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">    <span class="comment">// è¡¨ç¤ºå½“å‰è¯·æ±‚çº¿ç¨‹åœ¨ä¸‹é¢çš„ for(;;) è‡ªæ—‹æ£€æŸ¥çš„æ¬¡æ•°</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">spins</span> <span class="operator">=</span> (shouldSpin(s) ? (timed ? maxTimedSpins : maxUntimedSpins) : <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// è‡ªæ—‹æ£€æŸ¥é€»è¾‘ï¼šæ˜¯å¦åŒ¹é…ã€æ˜¯å¦è¶…æ—¶ã€æ˜¯å¦è¢«ä¸­æ–­</span></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="comment">// å½“å‰çº¿ç¨‹æ”¶åˆ°ä¸­æ–­ä¿¡å·ï¼Œéœ€è¦è®¾ç½® node çŠ¶æ€ä¸ºå–æ¶ˆçŠ¶æ€</span></span><br><span class="line">        <span class="keyword">if</span> (w.isInterrupted())</span><br><span class="line">            s.tryCancel();</span><br><span class="line">        <span class="comment">// è·å–ä¸å½“å‰ s åŒ¹é…çš„èŠ‚ç‚¹</span></span><br><span class="line">        <span class="type">SNode</span> <span class="variable">m</span> <span class="operator">=</span> s.match;</span><br><span class="line">        <span class="keyword">if</span> (m != <span class="literal">null</span>)</span><br><span class="line">            <span class="comment">// å¯èƒ½æ˜¯æ­£å¸¸çš„åŒ¹é…çš„ï¼Œä¹Ÿå¯èƒ½æ˜¯å–æ¶ˆçš„</span></span><br><span class="line">            <span class="keyword">return</span> m;</span><br><span class="line">        <span class="comment">// æ‰§è¡Œäº†è¶…æ—¶é™åˆ¶å°±åˆ¤æ–­æ˜¯å¦è¶…æ—¶</span></span><br><span class="line">        <span class="keyword">if</span> (timed) &#123;</span><br><span class="line">            nanos = deadline - System.nanoTime();</span><br><span class="line">            <span class="comment">// ã€è¶…æ—¶äº†ï¼Œå–æ¶ˆèŠ‚ç‚¹ã€‘</span></span><br><span class="line">            <span class="keyword">if</span> (nanos &lt;= <span class="number">0L</span>) &#123;</span><br><span class="line">                s.tryCancel();</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// è¯´æ˜å½“å‰çº¿ç¨‹è¿˜å¯ä»¥è¿›è¡Œè‡ªæ—‹æ£€æŸ¥</span></span><br><span class="line">        <span class="keyword">if</span> (spins &gt; <span class="number">0</span>)</span><br><span class="line">            <span class="comment">// è‡ªæ—‹ä¸€æ¬¡ é€’å‡ 1</span></span><br><span class="line">            spins = shouldSpin(s) ? (spins - <span class="number">1</span>) : <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// è¯´æ˜æ²¡æœ‰è‡ªæ—‹æ¬¡æ•°äº†</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (s.waiter == <span class="literal">null</span>)</span><br><span class="line">            <span class="comment">//ã€æŠŠå½“å‰ node å¯¹åº”çš„ Thread ä¿å­˜åˆ° node.waiter å­—æ®µä¸­ï¼Œè¦é˜»å¡äº†ã€‘</span></span><br><span class="line">            s.waiter = w;</span><br><span class="line">        <span class="comment">// æ²¡æœ‰è¶…æ—¶é™åˆ¶ç›´æ¥é˜»å¡</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (!timed)</span><br><span class="line">            LockSupport.park(<span class="built_in">this</span>);</span><br><span class="line">        <span class="comment">// nanos &gt; 1000 çº³ç§’çš„æƒ…å†µä¸‹ï¼Œæ‰å…è®¸æŒ‚èµ·å½“å‰çº¿ç¨‹</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (nanos &gt; spinForTimeoutThreshold)</span><br><span class="line">            LockSupport.parkNanos(<span class="built_in">this</span>, nanos);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">boolean</span> <span class="title function_">shouldSpin</span><span class="params">(SNode s)</span> &#123;</span><br><span class="line">    <span class="comment">// è·å–æ ˆé¡¶</span></span><br><span class="line">    <span class="type">SNode</span> <span class="variable">h</span> <span class="operator">=</span> head;</span><br><span class="line">    <span class="comment">// æ¡ä»¶ä¸€æˆç«‹è¯´æ˜å½“å‰ s å°±æ˜¯æ ˆé¡¶ï¼Œå…è®¸è‡ªæ—‹æ£€æŸ¥</span></span><br><span class="line">    <span class="comment">// æ¡ä»¶äºŒæˆç«‹è¯´æ˜å½“å‰ s èŠ‚ç‚¹è‡ªæ—‹æ£€æŸ¥æœŸé—´ï¼Œåˆæ¥äº†ä¸€ä¸ªä¸å½“å‰ s èŠ‚ç‚¹åŒ¹é…çš„è¯·æ±‚ï¼ŒåŒåŒå‡ºæ ˆåæ¡ä»¶ä¼šæˆç«‹</span></span><br><span class="line">    <span class="comment">// æ¡ä»¶ä¸‰æˆç«‹å‰æå½“å‰ s ä¸æ˜¯æ ˆé¡¶å…ƒç´ ï¼Œå¹¶ä¸”å½“å‰æ ˆé¡¶æ­£åœ¨åŒ¹é…ä¸­ï¼Œè¿™ç§çŠ¶æ€æ ˆé¡¶ä¸‹é¢çš„å…ƒç´ ï¼Œéƒ½å…è®¸è‡ªæ—‹æ£€æŸ¥</span></span><br><span class="line">    <span class="keyword">return</span> (h == s || h == <span class="literal">null</span> || isFulfilling(h.mode));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>clear()ï¼šæŒ‡å®šèŠ‚ç‚¹å‡ºæ ˆ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">clean</span><span class="params">(SNode s)</span> &#123;</span><br><span class="line">    <span class="comment">// æ¸…ç©ºæ•°æ®åŸŸå’Œå…³è”çº¿ç¨‹</span></span><br><span class="line">    s.item = <span class="literal">null</span>;</span><br><span class="line">    s.waiter = <span class="literal">null</span>;</span><br><span class="line">    </span><br><span class="line"><span class="comment">// è·å–å–æ¶ˆèŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">    <span class="type">SNode</span> <span class="variable">past</span> <span class="operator">=</span> s.next;</span><br><span class="line">    <span class="comment">// åˆ¤æ–­åç»§èŠ‚ç‚¹æ˜¯ä¸æ˜¯å–æ¶ˆèŠ‚ç‚¹ï¼Œæ˜¯å°±æ›´æ–° past</span></span><br><span class="line">    <span class="keyword">if</span> (past != <span class="literal">null</span> &amp;&amp; past.isCancelled())</span><br><span class="line">        past = past.next;</span><br><span class="line"></span><br><span class="line">    SNode p;</span><br><span class="line">    <span class="comment">// ä»æ ˆé¡¶å¼€å§‹å‘ä¸‹æ£€æŸ¥ï¼Œã€å°†æ ˆé¡¶å¼€å§‹å‘ä¸‹çš„ å–æ¶ˆçŠ¶æ€ çš„èŠ‚ç‚¹å…¨éƒ¨æ¸…ç†å‡ºå»ã€‘ï¼Œç›´åˆ°ç¢°åˆ° past æˆ–è€…ä¸æ˜¯å–æ¶ˆçŠ¶æ€ä¸ºæ­¢</span></span><br><span class="line">    <span class="keyword">while</span> ((p = head) != <span class="literal">null</span> &amp;&amp; p != past &amp;&amp; p.isCancelled())</span><br><span class="line">        <span class="comment">// ä¿®æ”¹çš„æ˜¯å†…å­˜åœ°å€å¯¹åº”çš„å€¼ï¼Œp æŒ‡å‘è¯¥å†…å­˜åœ°å€æ‰€ä»¥æ•°æ®ä¸€ç›´åœ¨å˜åŒ–</span></span><br><span class="line">        casHead(p, p.next);</span><br><span class="line"><span class="comment">// è¯´æ˜ä¸­é—´é‡åˆ°äº†ä¸æ˜¯å–æ¶ˆçŠ¶æ€çš„èŠ‚ç‚¹ï¼Œç»§ç»­è¿­ä»£ä¸‹å»</span></span><br><span class="line">    <span class="keyword">while</span> (p != <span class="literal">null</span> &amp;&amp; p != past) &#123;</span><br><span class="line">        <span class="type">SNode</span> <span class="variable">n</span> <span class="operator">=</span> p.next;</span><br><span class="line">        <span class="keyword">if</span> (n != <span class="literal">null</span> &amp;&amp; n.isCancelled())</span><br><span class="line">            p.casNext(n, n.next);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            p = n;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><hr><h5 id="å…¬å¹³å®ç°"><a href="#å…¬å¹³å®ç°" class="headerlink" title="å…¬å¹³å®ç°"></a>å…¬å¹³å®ç°</h5><p>TransferQueue æ˜¯å…¬å¹³çš„åŒæ­¥é˜Ÿåˆ—ï¼Œé‡‡ç”¨ FIFO çš„é˜Ÿåˆ—å®ç°ï¼Œè¯·æ±‚èŠ‚ç‚¹ä¸é˜Ÿå°¾æ¨¡å¼ä¸åŒï¼Œéœ€è¦ä¸é˜Ÿå¤´å‘ç”ŸåŒ¹é…</p><p>TransferQueue ç±»æˆå‘˜å˜é‡ï¼š</p><ul><li><p>æŒ‡å‘é˜Ÿåˆ—çš„ dummy èŠ‚ç‚¹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">transient</span> <span class="keyword">volatile</span> QNode head;</span><br></pre></td></tr></table></figure></li><li><p>æŒ‡å‘é˜Ÿåˆ—çš„å°¾èŠ‚ç‚¹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">transient</span> <span class="keyword">volatile</span> QNode tail;</span><br></pre></td></tr></table></figure></li><li><p>è¢«æ¸…ç†èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">transient</span> <span class="keyword">volatile</span> QNode cleanMe;</span><br></pre></td></tr></table></figure><p>å…¥é˜Ÿæ“ä½œæ˜¯ä¸¤æ­¥å®Œæˆçš„ï¼Œç¬¬ä¸€æ­¥æ˜¯ t.next &#x3D; newNodeï¼Œç¬¬äºŒæ­¥æ˜¯ tail &#x3D; newNodeï¼Œæ‰€ä»¥é˜Ÿå°¾èŠ‚ç‚¹å‡ºé˜Ÿï¼Œæ˜¯ä¸€ç§éå¸¸ç‰¹æ®Šçš„æƒ…å†µ</p></li></ul><p>TransferQueue å†…éƒ¨ç±»ï¼š</p><ul><li><p>QNodeï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">QNode</span> &#123;</span><br><span class="line">    <span class="comment">// æŒ‡å‘å½“å‰èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">volatile</span> QNode next;</span><br><span class="line">    <span class="comment">// æ•°æ®åŸŸï¼ŒNode ä»£è¡¨çš„æ˜¯ DATA ç±»å‹ item è¡¨ç¤ºæ•°æ®ï¼Œå¦åˆ™ Node ä»£è¡¨çš„ REQUEST ç±»å‹ï¼Œitem == null</span></span><br><span class="line">    <span class="keyword">volatile</span> Object item;</span><br><span class="line">    <span class="comment">// å‡è®¾å½“å‰ node å¯¹åº”çš„çº¿ç¨‹è‡ªæ—‹æœŸé—´æœªè¢«åŒ¹é…æˆåŠŸï¼Œé‚£ä¹ˆ node å¯¹åº”çš„çº¿ç¨‹éœ€è¦æŒ‚èµ·ï¼Œ</span></span><br><span class="line">    <span class="comment">// æŒ‚èµ·å‰ waiter ä¿å­˜å¯¹åº”çš„çº¿ç¨‹å¼•ç”¨ï¼Œæ–¹ä¾¿åŒ¹é…æˆåŠŸåè¢«å”¤é†’ã€‚</span></span><br><span class="line">    <span class="keyword">volatile</span> Thread waiter;</span><br><span class="line">    <span class="comment">// true å½“å‰ Node æ˜¯ä¸€ä¸ª DATA ç±»å‹ï¼Œfalse è¡¨ç¤ºå½“å‰ Node æ˜¯ä¸€ä¸ª REQUEST ç±»å‹</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> isData;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ„å»ºæ–¹æ³•</span></span><br><span class="line">    QNode(Object item, <span class="type">boolean</span> isData) &#123;</span><br><span class="line">        <span class="built_in">this</span>.item = item;</span><br><span class="line">        <span class="built_in">this</span>.isData = isData;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°è¯•å–æ¶ˆå½“å‰ nodeï¼Œå–æ¶ˆçŠ¶æ€çš„ node çš„ item åŸŸæŒ‡å‘è‡ªå·±</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">tryCancel</span><span class="params">(Object cmp)</span> &#123;</span><br><span class="line">        UNSAFE.compareAndSwapObject(<span class="built_in">this</span>, itemOffset, cmp, <span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ¤æ–­å½“å‰ node æ˜¯å¦ä¸ºå–æ¶ˆçŠ¶æ€</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isCancelled</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> item == <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ¤æ–­å½“å‰èŠ‚ç‚¹æ˜¯å¦ â€œä¸åœ¨â€ é˜Ÿåˆ—å†…ï¼Œå½“ next æŒ‡å‘è‡ªå·±æ—¶ï¼Œè¯´æ˜èŠ‚ç‚¹å·²ç»å‡ºé˜Ÿã€‚</span></span><br><span class="line">    <span class="type">boolean</span> <span class="title function_">isOffList</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> next == <span class="built_in">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p>TransferQueue ç±»æˆå‘˜æ–¹æ³•ï¼š</p><ul><li><p>è®¾ç½®å¤´å°¾èŠ‚ç‚¹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">advanceHead</span><span class="params">(QNode h, QNode nh)</span> &#123;</span><br><span class="line">    <span class="comment">// è®¾ç½®å¤´æŒ‡é’ˆæŒ‡å‘æ–°çš„èŠ‚ç‚¹ï¼Œ</span></span><br><span class="line">    <span class="keyword">if</span> (h == head &amp;&amp; UNSAFE.compareAndSwapObject(<span class="built_in">this</span>, headOffset, h, nh))</span><br><span class="line">        <span class="comment">// è€çš„å¤´èŠ‚ç‚¹å‡ºé˜Ÿ</span></span><br><span class="line">        h.next = h;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">void</span> <span class="title function_">advanceTail</span><span class="params">(QNode t, QNode nt)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (tail == t)</span><br><span class="line">        <span class="comment">// æ›´æ–°é˜Ÿå°¾èŠ‚ç‚¹ä¸ºæ–°çš„é˜Ÿå°¾</span></span><br><span class="line">        UNSAFE.compareAndSwapObject(<span class="built_in">this</span>, tailOffset, t, nt);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>transfer()ï¼šæ ¸å¿ƒæ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">E <span class="title function_">transfer</span><span class="params">(E e, <span class="type">boolean</span> timed, <span class="type">long</span> nanos)</span> &#123;</span><br><span class="line">    <span class="comment">// s æŒ‡å‘å½“å‰è¯·æ±‚å¯¹åº”çš„ node</span></span><br><span class="line">    <span class="type">QNode</span> <span class="variable">s</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">// æ˜¯å¦æ˜¯ DATA ç±»å‹çš„è¯·æ±‚</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">isData</span> <span class="operator">=</span> (e != <span class="literal">null</span>);</span><br><span class="line"><span class="comment">// è‡ªæ—‹</span></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="type">QNode</span> <span class="variable">t</span> <span class="operator">=</span> tail;</span><br><span class="line">        <span class="type">QNode</span> <span class="variable">h</span> <span class="operator">=</span> head;</span><br><span class="line">        <span class="keyword">if</span> (t == <span class="literal">null</span> || h == <span class="literal">null</span>)</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line"><span class="comment">// head å’Œ tail åŒæ—¶æŒ‡å‘ dummy èŠ‚ç‚¹ï¼Œè¯´æ˜æ˜¯ç©ºé˜Ÿåˆ—</span></span><br><span class="line">        <span class="comment">// é˜Ÿå°¾èŠ‚ç‚¹ä¸å½“å‰è¯·æ±‚ç±»å‹æ˜¯ä¸€è‡´çš„æƒ…å†µï¼Œè¯´æ˜é˜»å¡é˜Ÿåˆ—ä¸­éƒ½æ— æ³•åŒ¹é…ï¼Œ</span></span><br><span class="line">        <span class="keyword">if</span> (h == t || t.isData == isData) &#123;</span><br><span class="line">            <span class="comment">// è·å–é˜Ÿå°¾ t çš„ next èŠ‚ç‚¹</span></span><br><span class="line">            <span class="type">QNode</span> <span class="variable">tn</span> <span class="operator">=</span> t.next;</span><br><span class="line">            <span class="comment">// å¤šçº¿ç¨‹ç¯å¢ƒä¸­å…¶ä»–çº¿ç¨‹å¯èƒ½ä¿®æ”¹å°¾èŠ‚ç‚¹</span></span><br><span class="line">            <span class="keyword">if</span> (t != tail)</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            <span class="comment">// å·²ç»æœ‰çº¿ç¨‹å…¥é˜Ÿäº†ï¼Œæ›´æ–° tail</span></span><br><span class="line">            <span class="keyword">if</span> (tn != <span class="literal">null</span>) &#123;</span><br><span class="line">                advanceTail(t, tn);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å…è®¸è¶…æ—¶ï¼Œè¶…æ—¶æ—¶é—´å°äº 0ï¼Œè¿™ç§æ–¹æ³•ä¸æ”¯æŒé˜»å¡ç­‰å¾…</span></span><br><span class="line">            <span class="keyword">if</span> (timed &amp;&amp; nanos &lt;= <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="comment">// åˆ›å»º node çš„é€»è¾‘</span></span><br><span class="line">            <span class="keyword">if</span> (s == <span class="literal">null</span>)</span><br><span class="line">                s = <span class="keyword">new</span> <span class="title class_">QNode</span>(e, isData);</span><br><span class="line">            <span class="comment">// å°† node æ·»åŠ åˆ°é˜Ÿå°¾</span></span><br><span class="line">            <span class="keyword">if</span> (!t.casNext(<span class="literal">null</span>, s))</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line"><span class="comment">// æ›´æ–°é˜Ÿå°¾æŒ‡é’ˆ</span></span><br><span class="line">            advanceTail(t, s);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// å½“å‰èŠ‚ç‚¹ ç­‰å¾…åŒ¹é…....</span></span><br><span class="line">            <span class="type">Object</span> <span class="variable">x</span> <span class="operator">=</span> awaitFulfill(s, e, timed, nanos);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// è¯´æ˜ã€å½“å‰ node çŠ¶æ€ä¸º å–æ¶ˆçŠ¶æ€ã€‘ï¼Œéœ€è¦åšå‡ºé˜Ÿé€»è¾‘</span></span><br><span class="line">            <span class="keyword">if</span> (x == s) &#123;</span><br><span class="line">                clean(t, s);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line"><span class="comment">// è¯´æ˜å½“å‰ node ä»ç„¶åœ¨é˜Ÿåˆ—å†…ï¼ŒåŒ¹é…æˆåŠŸï¼Œéœ€è¦åšå‡ºé˜Ÿé€»è¾‘</span></span><br><span class="line">            <span class="keyword">if</span> (!s.isOffList()) &#123;</span><br><span class="line">                <span class="comment">// t æ˜¯å½“å‰ s èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹ï¼Œåˆ¤æ–­ t æ˜¯ä¸æ˜¯å¤´èŠ‚ç‚¹ï¼Œæ˜¯å°±æ›´æ–° dummy èŠ‚ç‚¹ä¸º s èŠ‚ç‚¹</span></span><br><span class="line">                advanceHead(t, s);</span><br><span class="line">                <span class="comment">// s èŠ‚ç‚¹å·²ç»å‡ºé˜Ÿï¼Œæ‰€ä»¥éœ€è¦æŠŠå®ƒçš„ item åŸŸè®¾ç½®ä¸ºå®ƒè‡ªå·±ï¼Œè¡¨ç¤ºå®ƒæ˜¯ä¸ªå–æ¶ˆçŠ¶æ€</span></span><br><span class="line">                <span class="keyword">if</span> (x != <span class="literal">null</span>)</span><br><span class="line">                    s.item = s;</span><br><span class="line">                s.waiter = <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> (x != <span class="literal">null</span>) ? (E)x : e;</span><br><span class="line"><span class="comment">// é˜Ÿå°¾èŠ‚ç‚¹ä¸å½“å‰è¯·æ±‚èŠ‚ç‚¹ã€äº’è¡¥åŒ¹é…ã€‘</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// h.next èŠ‚ç‚¹ï¼Œã€è¯·æ±‚èŠ‚ç‚¹ä¸é˜Ÿå°¾æ¨¡å¼ä¸åŒï¼Œéœ€è¦ä¸é˜Ÿå¤´å‘ç”ŸåŒ¹é…ã€‘ï¼ŒTransferQueue æ˜¯ä¸€ä¸ªã€å…¬å¹³æ¨¡å¼ã€‘</span></span><br><span class="line">            <span class="type">QNode</span> <span class="variable">m</span> <span class="operator">=</span> h.next;</span><br><span class="line">            <span class="comment">// å¹¶å‘å¯¼è‡´å…¶ä»–çº¿ç¨‹ä¿®æ”¹äº†é˜Ÿå°¾èŠ‚ç‚¹ï¼Œæˆ–è€…å·²ç»æŠŠ head.next åŒ¹é…èµ°äº†</span></span><br><span class="line">            <span class="keyword">if</span> (t != tail || m == <span class="literal">null</span> || h != head)</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line"><span class="comment">// è·å–åŒ¹é…èŠ‚ç‚¹çš„æ•°æ®åŸŸä¿å­˜åˆ° x</span></span><br><span class="line">            <span class="type">Object</span> <span class="variable">x</span> <span class="operator">=</span> m.item;</span><br><span class="line">            <span class="comment">// åˆ¤æ–­æ˜¯å¦åŒ¹é…æˆåŠŸ</span></span><br><span class="line">            <span class="keyword">if</span> (isData == (x != <span class="literal">null</span>) ||</span><br><span class="line">                x == m ||</span><br><span class="line">                !m.casItem(x, e)) &#123;</span><br><span class="line">                advanceHead(h, m);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line"><span class="comment">// ã€åŒ¹é…å®Œæˆã€‘ï¼Œå°†å¤´èŠ‚ç‚¹å‡ºé˜Ÿï¼Œè®©è¿™ä¸ªæ–°çš„å¤´ç»“ç‚¹æˆä¸º dummy èŠ‚ç‚¹</span></span><br><span class="line">            advanceHead(h, m);</span><br><span class="line">            <span class="comment">// å”¤é†’è¯¥åŒ¹é…èŠ‚ç‚¹çš„çº¿ç¨‹</span></span><br><span class="line">            LockSupport.unpark(m.waiter);</span><br><span class="line">            <span class="keyword">return</span> (x != <span class="literal">null</span>) ? (E)x : e;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>awaitFulfill()ï¼šé˜»å¡å½“å‰çº¿ç¨‹ç­‰å¾…è¢«åŒ¹é…</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">Object <span class="title function_">awaitFulfill</span><span class="params">(QNode s, E e, <span class="type">boolean</span> timed, <span class="type">long</span> nanos)</span> &#123;</span><br><span class="line">    <span class="comment">// è¡¨ç¤ºç­‰å¾…æˆªæ­¢æ—¶é—´</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">long</span> <span class="variable">deadline</span> <span class="operator">=</span> timed ? System.nanoTime() + nanos : <span class="number">0L</span>;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">w</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">    <span class="comment">// è‡ªé€‰æ£€æŸ¥çš„æ¬¡æ•°</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">spins</span> <span class="operator">=</span> ((head.next == s) ? (timed ? maxTimedSpins : maxUntimedSpins) : <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="comment">// è¢«æ‰“æ–­å°±å–æ¶ˆèŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">if</span> (w.isInterrupted())</span><br><span class="line">            s.tryCancel(e);</span><br><span class="line">        <span class="comment">// è·å–å½“å‰ Node æ•°æ®åŸŸ</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">x</span> <span class="operator">=</span> s.item;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å½“å‰è¯·æ±‚ä¸º DATA æ¨¡å¼æ—¶ï¼še è¯·æ±‚å¸¦æ¥çš„æ•°æ®</span></span><br><span class="line">        <span class="comment">// s.item ä¿®æ”¹ä¸º thisï¼Œè¯´æ˜å½“å‰ QNode å¯¹åº”çš„çº¿ç¨‹ å–æ¶ˆçŠ¶æ€</span></span><br><span class="line">        <span class="comment">// s.item ä¿®æ”¹ä¸º null è¡¨ç¤ºå·²ç»æœ‰åŒ¹é…èŠ‚ç‚¹äº†ï¼Œå¹¶ä¸”åŒ¹é…èŠ‚ç‚¹æ‹¿èµ°äº† item æ•°æ®</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// å½“å‰è¯·æ±‚ä¸º REQUEST æ¨¡å¼æ—¶ï¼še == null</span></span><br><span class="line">        <span class="comment">// s.item ä¿®æ”¹ä¸º thisï¼Œè¯´æ˜å½“å‰ QNode å¯¹åº”çš„çº¿ç¨‹ å–æ¶ˆçŠ¶æ€</span></span><br><span class="line">        <span class="comment">// s.item != null ä¸” item != this  è¡¨ç¤ºå½“å‰ REQUEST ç±»å‹çš„ Node å·²ç»åŒ¹é…åˆ° DATA äº† </span></span><br><span class="line">        <span class="keyword">if</span> (x != e)</span><br><span class="line">            <span class="keyword">return</span> x;</span><br><span class="line">        <span class="comment">// è¶…æ—¶æ£€æŸ¥</span></span><br><span class="line">        <span class="keyword">if</span> (timed) &#123;</span><br><span class="line">            nanos = deadline - System.nanoTime();</span><br><span class="line">            <span class="keyword">if</span> (nanos &lt;= <span class="number">0L</span>) &#123;</span><br><span class="line">                s.tryCancel(e);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// è‡ªæ—‹æ¬¡æ•°å‡ä¸€</span></span><br><span class="line">        <span class="keyword">if</span> (spins &gt; <span class="number">0</span>)</span><br><span class="line">            --spins;</span><br><span class="line">        <span class="comment">// æ²¡æœ‰è‡ªæ—‹æ¬¡æ•°äº†ï¼ŒæŠŠå½“å‰çº¿ç¨‹å°è£…è¿›å» waiter</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (s.waiter == <span class="literal">null</span>)</span><br><span class="line">            s.waiter = w;</span><br><span class="line">        <span class="comment">// é˜»å¡</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (!timed)</span><br><span class="line">            LockSupport.park(<span class="built_in">this</span>);</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (nanos &gt; spinForTimeoutThreshold)</span><br><span class="line">            LockSupport.parkNanos(<span class="built_in">this</span>, nanos);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><hr><h3 id="æ“ä½œPool"><a href="#æ“ä½œPool" class="headerlink" title="æ“ä½œPool"></a>æ“ä½œPool</h3><h4 id="åˆ›å»ºæ–¹å¼"><a href="#åˆ›å»ºæ–¹å¼" class="headerlink" title="åˆ›å»ºæ–¹å¼"></a>åˆ›å»ºæ–¹å¼</h4><h5 id="Executor"><a href="#Executor" class="headerlink" title="Executor"></a>Executor</h5><p>å­˜æ”¾çº¿ç¨‹çš„å®¹å™¨ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> HashSet&lt;Worker&gt; workers = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;Worker&gt;();</span><br></pre></td></tr></table></figure><p>æ„é€ æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ThreadPoolExecutor</span><span class="params">(<span class="type">int</span> corePoolSize,</span></span><br><span class="line"><span class="params">                          <span class="type">int</span> maximumPoolSize,</span></span><br><span class="line"><span class="params">                          <span class="type">long</span> keepAliveTime,</span></span><br><span class="line"><span class="params">                          TimeUnit unit,</span></span><br><span class="line"><span class="params">                          BlockingQueue&lt;Runnable&gt; workQueue,</span></span><br><span class="line"><span class="params">                          ThreadFactory threadFactory,</span></span><br><span class="line"><span class="params">                          RejectedExecutionHandler handler)</span></span><br></pre></td></tr></table></figure><p>å‚æ•°ä»‹ç»ï¼š</p><ul><li><p>corePoolSizeï¼šæ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œå®šä¹‰äº†æœ€å°å¯ä»¥åŒæ—¶è¿è¡Œçš„çº¿ç¨‹æ•°é‡</p></li><li><p>maximumPoolSizeï¼šæœ€å¤§çº¿ç¨‹æ•°ï¼Œå½“é˜Ÿåˆ—ä¸­å­˜æ”¾çš„ä»»åŠ¡è¾¾åˆ°é˜Ÿåˆ—å®¹é‡æ—¶ï¼Œå½“å‰å¯ä»¥åŒæ—¶è¿è¡Œçš„æ•°é‡å˜ä¸ºæœ€å¤§çº¿ç¨‹æ•°ï¼Œåˆ›å»ºçº¿ç¨‹å¹¶ç«‹å³æ‰§è¡Œæœ€æ–°çš„ä»»åŠ¡ï¼Œä¸æ ¸å¿ƒçº¿ç¨‹æ•°ä¹‹é—´çš„å·®å€¼åˆå«æ•‘æ€¥çº¿ç¨‹æ•°</p></li><li><p>keepAliveTimeï¼šæ•‘æ€¥çº¿ç¨‹æœ€å¤§å­˜æ´»æ—¶é—´ï¼Œå½“çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°é‡å¤§äº <code>corePoolSize</code> çš„æ—¶å€™ï¼Œå¦‚æœè¿™æ—¶æ²¡æœ‰æ–°çš„ä»»åŠ¡æäº¤ï¼Œæ ¸å¿ƒçº¿ç¨‹å¤–çš„çº¿ç¨‹ä¸ä¼šç«‹å³é”€æ¯ï¼Œè€Œæ˜¯ä¼šç­‰åˆ° <code>keepAliveTime</code> æ—¶é—´è¶…è¿‡é”€æ¯</p></li><li><p>unitï¼š<code>keepAliveTime</code> å‚æ•°çš„æ—¶é—´å•ä½</p></li><li><p>workQueueï¼šé˜»å¡é˜Ÿåˆ—ï¼Œå­˜æ”¾è¢«æäº¤ä½†å°šæœªè¢«æ‰§è¡Œçš„ä»»åŠ¡</p></li><li><p>threadFactoryï¼šçº¿ç¨‹å·¥å‚ï¼Œåˆ›å»ºæ–°çº¿ç¨‹æ—¶ç”¨åˆ°ï¼Œå¯ä»¥ä¸ºçº¿ç¨‹åˆ›å»ºæ—¶èµ·åå­—</p></li><li><p>handlerï¼šæ‹’ç»ç­–ç•¥ï¼Œçº¿ç¨‹åˆ°è¾¾æœ€å¤§çº¿ç¨‹æ•°ä»æœ‰æ–°ä»»åŠ¡æ—¶ä¼šæ‰§è¡Œæ‹’ç»ç­–ç•¥</p><p>RejectedExecutionHandler ä¸‹æœ‰ 4 ä¸ªå®ç°ç±»ï¼š</p><ul><li>AbortPolicyï¼šè®©è°ƒç”¨è€…æŠ›å‡º RejectedExecutionException å¼‚å¸¸ï¼Œ<strong>é»˜è®¤ç­–ç•¥</strong></li><li>CallerRunsPolicyï¼šè®©è°ƒç”¨è€…è¿è¡Œçš„è°ƒèŠ‚æœºåˆ¶ï¼Œå°†æŸäº›ä»»åŠ¡å›é€€åˆ°è°ƒç”¨è€…ï¼Œä»è€Œé™ä½æ–°ä»»åŠ¡çš„æµé‡</li><li>DiscardPolicyï¼šç›´æ¥ä¸¢å¼ƒä»»åŠ¡ï¼Œä¸äºˆä»»ä½•å¤„ç†ä¹Ÿä¸æŠ›å‡ºå¼‚å¸¸</li><li>DiscardOldestPolicyï¼šæ”¾å¼ƒé˜Ÿåˆ—ä¸­æœ€æ—©çš„ä»»åŠ¡ï¼ŒæŠŠå½“å‰ä»»åŠ¡åŠ å…¥é˜Ÿåˆ—ä¸­å°è¯•å†æ¬¡æäº¤å½“å‰ä»»åŠ¡</li></ul><p>è¡¥å……ï¼šå…¶ä»–æ¡†æ¶æ‹’ç»ç­–ç•¥</p><ul><li>Dubboï¼šåœ¨æŠ›å‡º RejectedExecutionException å¼‚å¸¸å‰è®°å½•æ—¥å¿—ï¼Œå¹¶ dump çº¿ç¨‹æ ˆä¿¡æ¯ï¼Œæ–¹ä¾¿å®šä½é—®é¢˜</li><li>Nettyï¼šåˆ›å»ºä¸€ä¸ªæ–°çº¿ç¨‹æ¥æ‰§è¡Œä»»åŠ¡</li><li>ActiveMQï¼šå¸¦è¶…æ—¶ç­‰å¾…ï¼ˆ60sï¼‰å°è¯•æ”¾å…¥é˜Ÿåˆ—</li><li>PinPointï¼šå®ƒä½¿ç”¨äº†ä¸€ä¸ªæ‹’ç»ç­–ç•¥é“¾ï¼Œä¼šé€ä¸€å°è¯•ç­–ç•¥é“¾ä¸­æ¯ç§æ‹’ç»ç­–ç•¥</li></ul></li></ul><p>å·¥ä½œåŸç†ï¼š</p><p><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/JUC-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86.png"></p><ol><li><p>åˆ›å»ºçº¿ç¨‹æ± ï¼Œè¿™æ—¶æ²¡æœ‰åˆ›å»ºçº¿ç¨‹ï¼ˆ<strong>æ‡’æƒ°</strong>ï¼‰ï¼Œç­‰å¾…æäº¤è¿‡æ¥çš„ä»»åŠ¡è¯·æ±‚ï¼Œè°ƒç”¨ execute æ–¹æ³•æ‰ä¼šåˆ›å»ºçº¿ç¨‹</p></li><li><p>å½“è°ƒç”¨ execute() æ–¹æ³•æ·»åŠ ä¸€ä¸ªè¯·æ±‚ä»»åŠ¡æ—¶ï¼Œçº¿ç¨‹æ± ä¼šåšå¦‚ä¸‹åˆ¤æ–­ï¼š</p><ul><li>å¦‚æœæ­£åœ¨è¿è¡Œçš„çº¿ç¨‹æ•°é‡å°äº corePoolSizeï¼Œé‚£ä¹ˆé©¬ä¸Šåˆ›å»ºçº¿ç¨‹è¿è¡Œè¿™ä¸ªä»»åŠ¡</li><li>å¦‚æœæ­£åœ¨è¿è¡Œçš„çº¿ç¨‹æ•°é‡å¤§äºæˆ–ç­‰äº corePoolSizeï¼Œé‚£ä¹ˆå°†è¿™ä¸ªä»»åŠ¡æ”¾å…¥é˜Ÿåˆ—</li><li>å¦‚æœè¿™æ—¶é˜Ÿåˆ—æ»¡äº†ä¸”æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹æ•°é‡è¿˜å°äº maximumPoolSizeï¼Œé‚£ä¹ˆä¼šåˆ›å»ºéæ ¸å¿ƒçº¿ç¨‹<strong>ç«‹åˆ»è¿è¡Œè¿™ä¸ªä»»åŠ¡</strong>ï¼Œå¯¹äºé˜»å¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ä¸å…¬å¹³ã€‚è¿™æ˜¯å› ä¸ºåˆ›å»ºæ¯ä¸ª Workerï¼ˆçº¿ç¨‹ï¼‰å¯¹è±¡ä¼šç»‘å®šä¸€ä¸ªåˆå§‹ä»»åŠ¡ï¼Œå¯åŠ¨ Worker æ—¶ä¼šä¼˜å…ˆæ‰§è¡Œ</li><li>å¦‚æœé˜Ÿåˆ—æ»¡äº†ä¸”æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹æ•°é‡å¤§äºæˆ–ç­‰äº maximumPoolSizeï¼Œé‚£ä¹ˆçº¿ç¨‹æ± ä¼šå¯åŠ¨é¥±å’Œ<strong>æ‹’ç»ç­–ç•¥</strong>æ¥æ‰§è¡Œ</li></ul></li><li><p>å½“ä¸€ä¸ªçº¿ç¨‹å®Œæˆä»»åŠ¡æ—¶ï¼Œä¼šä»é˜Ÿåˆ—ä¸­å–ä¸‹ä¸€ä¸ªä»»åŠ¡æ¥æ‰§è¡Œ</p></li><li><p>å½“ä¸€ä¸ªçº¿ç¨‹ç©ºé—²è¶…è¿‡ä¸€å®šçš„æ—¶é—´ï¼ˆkeepAliveTimeï¼‰æ—¶ï¼Œçº¿ç¨‹æ± ä¼šåˆ¤æ–­ï¼šå¦‚æœå½“å‰è¿è¡Œçš„çº¿ç¨‹æ•°å¤§äº corePoolSizeï¼Œé‚£ä¹ˆè¿™ä¸ªçº¿ç¨‹å°±è¢«åœæ‰ï¼Œæ‰€ä»¥çº¿ç¨‹æ± çš„æ‰€æœ‰ä»»åŠ¡å®Œæˆåæœ€ç»ˆä¼šæ”¶ç¼©åˆ° corePoolSize å¤§å°</p></li></ol><p>å›¾ç‰‡æ¥æºï¼š<a href="https://space.bilibili.com/457326371/">https://space.bilibili.com/457326371/</a></p><hr><h5 id="Executors"><a href="#Executors" class="headerlink" title="Executors"></a>Executors</h5><p>Executors æä¾›äº†å››ç§çº¿ç¨‹æ± çš„åˆ›å»ºï¼šnewCachedThreadPoolã€newFixedThreadPoolã€newSingleThreadExecutorã€newScheduledThreadPool</p><ul><li><p>newFixedThreadPoolï¼šåˆ›å»ºä¸€ä¸ªæ‹¥æœ‰ n ä¸ªçº¿ç¨‹çš„çº¿ç¨‹æ± </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title function_">newFixedThreadPool</span><span class="params">(<span class="type">int</span> nThreads)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(nThreads, nThreads, <span class="number">0L</span>, TimeUnit.MILLISECONDS,</span><br><span class="line">                                  <span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;Runnable&gt;());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>æ ¸å¿ƒçº¿ç¨‹æ•° &#x3D;&#x3D; æœ€å¤§çº¿ç¨‹æ•°ï¼ˆæ²¡æœ‰æ•‘æ€¥çº¿ç¨‹è¢«åˆ›å»ºï¼‰ï¼Œå› æ­¤ä¹Ÿæ— éœ€è¶…æ—¶æ—¶é—´</li><li>LinkedBlockingQueue æ˜¯ä¸€ä¸ªå•å‘é“¾è¡¨å®ç°çš„é˜»å¡é˜Ÿåˆ—ï¼Œé»˜è®¤å¤§å°ä¸º <code>Integer.MAX_VALUE</code>ï¼Œä¹Ÿå°±æ˜¯æ— ç•Œé˜Ÿåˆ—ï¼Œå¯ä»¥æ”¾ä»»æ„æ•°é‡çš„ä»»åŠ¡ï¼Œåœ¨ä»»åŠ¡æ¯”è¾ƒå¤šçš„æ—¶å€™ä¼šå¯¼è‡´ OOMï¼ˆå†…å­˜æº¢å‡ºï¼‰</li><li>é€‚ç”¨äºä»»åŠ¡é‡å·²çŸ¥ï¼Œç›¸å¯¹è€—æ—¶çš„é•¿æœŸä»»åŠ¡</li></ul></li><li><p>newCachedThreadPoolï¼šåˆ›å»ºä¸€ä¸ªå¯æ‰©å®¹çš„çº¿ç¨‹æ± </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title function_">newCachedThreadPool</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(<span class="number">0</span>, Integer.MAX_VALUE, <span class="number">60L</span>, TimeUnit.SECONDS,</span><br><span class="line">                                  <span class="keyword">new</span> <span class="title class_">SynchronousQueue</span>&lt;Runnable&gt;());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>æ ¸å¿ƒçº¿ç¨‹æ•°æ˜¯ 0ï¼Œ æœ€å¤§çº¿ç¨‹æ•°æ˜¯ 29 ä¸ª 1ï¼Œå…¨éƒ¨éƒ½æ˜¯æ•‘æ€¥çº¿ç¨‹ï¼ˆ60s åå¯ä»¥å›æ”¶ï¼‰ï¼Œå¯èƒ½ä¼šåˆ›å»ºå¤§é‡çº¿ç¨‹ï¼Œä»è€Œå¯¼è‡´ <strong>OOM</strong></p></li><li><p>SynchronousQueue ä½œä¸ºé˜»å¡é˜Ÿåˆ—ï¼Œæ²¡æœ‰å®¹é‡ï¼Œå¯¹äºæ¯ä¸€ä¸ª take çš„çº¿ç¨‹ä¼šé˜»å¡ç›´åˆ°æœ‰ä¸€ä¸ª put çš„çº¿ç¨‹æ”¾å…¥å…ƒç´ ä¸ºæ­¢ï¼ˆç±»ä¼¼ä¸€æ‰‹äº¤é’±ã€ä¸€æ‰‹äº¤è´§ï¼‰</p></li><li><p>é€‚åˆä»»åŠ¡æ•°æ¯”è¾ƒå¯†é›†ï¼Œä½†æ¯ä¸ªä»»åŠ¡æ‰§è¡Œæ—¶é—´è¾ƒçŸ­çš„æƒ…å†µ</p></li></ul></li><li><p>newSingleThreadExecutorï¼šåˆ›å»ºä¸€ä¸ªåªæœ‰ 1 ä¸ªçº¿ç¨‹çš„å•çº¿ç¨‹æ± </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title function_">newSingleThreadExecutor</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">FinalizableDelegatedExecutorService</span></span><br><span class="line">        (<span class="keyword">new</span> <span class="title class_">ThreadPoolExecutor</span>(<span class="number">1</span>, <span class="number">1</span>,<span class="number">0L</span>, TimeUnit.MILLISECONDS,</span><br><span class="line">                                <span class="keyword">new</span> <span class="title class_">LinkedBlockingQueue</span>&lt;Runnable&gt;()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>ä¿è¯æ‰€æœ‰ä»»åŠ¡æŒ‰ç…§<strong>æŒ‡å®šé¡ºåºæ‰§è¡Œ</strong>ï¼Œçº¿ç¨‹æ•°å›ºå®šä¸º 1ï¼Œä»»åŠ¡æ•°å¤šäº 1 æ—¶ä¼šæ”¾å…¥æ— ç•Œé˜Ÿåˆ—æ’é˜Ÿï¼Œä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œè¿™å”¯ä¸€çš„çº¿ç¨‹ä¹Ÿä¸ä¼šè¢«é‡Šæ”¾</li></ul></li></ul><p>å¯¹æ¯”ï¼š</p><ul><li><p>åˆ›å»ºä¸€ä¸ªå•çº¿ç¨‹ä¸²è¡Œæ‰§è¡Œä»»åŠ¡ï¼Œå¦‚æœä»»åŠ¡æ‰§è¡Œå¤±è´¥è€Œç»ˆæ­¢é‚£ä¹ˆæ²¡æœ‰ä»»ä½•è¡¥æ•‘æªæ–½ï¼Œçº¿ç¨‹æ± ä¼šæ–°å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œä¿è¯æ± çš„æ­£å¸¸å·¥ä½œ</p></li><li><p>Executors.newSingleThreadExecutor() çº¿ç¨‹ä¸ªæ•°å§‹ç»ˆä¸º 1ï¼Œä¸èƒ½ä¿®æ”¹ã€‚FinalizableDelegatedExecutorService åº”ç”¨çš„æ˜¯è£…é¥°å™¨æ¨¡å¼ï¼Œåªå¯¹å¤–æš´éœ²äº† ExecutorService æ¥å£ï¼Œå› æ­¤ä¸èƒ½è°ƒç”¨ ThreadPoolExecutor ä¸­ç‰¹æœ‰çš„æ–¹æ³•</p><p>åŸå› ï¼šçˆ¶ç±»ä¸èƒ½ç›´æ¥è°ƒç”¨å­ç±»ä¸­çš„æ–¹æ³•ï¼Œéœ€è¦åå°„æˆ–è€…åˆ›å»ºå¯¹è±¡çš„æ–¹å¼ï¼Œå¯ä»¥è°ƒç”¨å­ç±»é™æ€æ–¹æ³•</p></li><li><p>Executors.newFixedThreadPool(1) åˆå§‹æ—¶ä¸º 1ï¼Œå¯ä»¥ä¿®æ”¹ã€‚å¯¹å¤–æš´éœ²çš„æ˜¯ ThreadPoolExecutor å¯¹è±¡ï¼Œå¯ä»¥å¼ºè½¬åè°ƒç”¨ setCorePoolSize ç­‰æ–¹æ³•è¿›è¡Œä¿®æ”¹</p></li></ul><p><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/JUC-newSingleThreadExecutor.png"></p><hr><h5 id="å¼€å‘è¦æ±‚"><a href="#å¼€å‘è¦æ±‚" class="headerlink" title="å¼€å‘è¦æ±‚"></a>å¼€å‘è¦æ±‚</h5><p>é˜¿é‡Œå·´å·´ Java å¼€å‘æ‰‹å†Œè¦æ±‚ï¼š</p><ul><li><p><strong>çº¿ç¨‹èµ„æºå¿…é¡»é€šè¿‡çº¿ç¨‹æ± æä¾›ï¼Œä¸å…è®¸åœ¨åº”ç”¨ä¸­è‡ªè¡Œæ˜¾å¼åˆ›å»ºçº¿ç¨‹</strong></p><ul><li>ä½¿ç”¨çº¿ç¨‹æ± çš„å¥½å¤„æ˜¯å‡å°‘åœ¨åˆ›å»ºå’Œé”€æ¯çº¿ç¨‹ä¸Šæ‰€æ¶ˆè€—çš„æ—¶é—´ä»¥åŠç³»ç»Ÿèµ„æºçš„å¼€é”€ï¼Œè§£å†³èµ„æºä¸è¶³çš„é—®é¢˜</li><li>å¦‚æœä¸ä½¿ç”¨çº¿ç¨‹æ± ï¼Œæœ‰å¯èƒ½é€ æˆç³»ç»Ÿåˆ›å»ºå¤§é‡åŒç±»çº¿ç¨‹è€Œå¯¼è‡´æ¶ˆè€—å®Œå†…å­˜æˆ–è€…è¿‡åº¦åˆ‡æ¢çš„é—®é¢˜</li></ul></li><li><p>çº¿ç¨‹æ± ä¸å…è®¸ä½¿ç”¨ Executors å»åˆ›å»ºï¼Œè€Œæ˜¯é€šè¿‡ ThreadPoolExecutor çš„æ–¹å¼ï¼Œè¿™æ ·çš„å¤„ç†æ–¹å¼æ›´åŠ æ˜ç¡®çº¿ç¨‹æ± çš„è¿è¡Œè§„åˆ™ï¼Œè§„é¿èµ„æºè€—å°½çš„é£é™©</p><p>Executors è¿”å›çš„çº¿ç¨‹æ± å¯¹è±¡å¼Šç«¯å¦‚ä¸‹ï¼š</p><ul><li>FixedThreadPool å’Œ SingleThreadPoolï¼šè¯·æ±‚é˜Ÿåˆ—é•¿åº¦ä¸º Integer.MAX_VALUEï¼Œå¯èƒ½ä¼šå †ç§¯å¤§é‡çš„è¯·æ±‚ï¼Œä»è€Œå¯¼è‡´ OOM</li><li>CacheThreadPool å’Œ ScheduledThreadPoolï¼šå…è®¸åˆ›å»ºçº¿ç¨‹æ•°é‡ä¸º Integer.MAX_VALUEï¼Œå¯èƒ½ä¼šåˆ›å»ºå¤§é‡çš„çº¿ç¨‹ï¼Œå¯¼è‡´ OOM</li></ul></li></ul><p>åˆ›å»ºå¤šå¤§å®¹é‡çš„çº¿ç¨‹æ± åˆé€‚ï¼Ÿ</p><ul><li><p>ä¸€èˆ¬æ¥è¯´æ± ä¸­<strong>æ€»çº¿ç¨‹æ•°æ˜¯æ ¸å¿ƒæ± çº¿ç¨‹æ•°é‡ä¸¤å€</strong>ï¼Œç¡®ä¿å½“æ ¸å¿ƒæ± æœ‰çº¿ç¨‹åœæ­¢æ—¶ï¼Œæ ¸å¿ƒæ± å¤–æœ‰çº¿ç¨‹è¿›å…¥æ ¸å¿ƒæ± </p></li><li><p>è¿‡å°ä¼šå¯¼è‡´ç¨‹åºä¸èƒ½å……åˆ†åœ°åˆ©ç”¨ç³»ç»Ÿèµ„æºã€å®¹æ˜“å¯¼è‡´é¥¥é¥¿</p></li><li><p>è¿‡å¤§ä¼šå¯¼è‡´æ›´å¤šçš„çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå ç”¨æ›´å¤šå†…å­˜</p><p>ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼šå½“å‰ä»»åŠ¡åœ¨æ‰§è¡Œå®Œ CPU æ—¶é—´ç‰‡åˆ‡æ¢åˆ°å¦ä¸€ä¸ªä»»åŠ¡ä¹‹å‰ä¼šå…ˆä¿å­˜è‡ªå·±çš„çŠ¶æ€ï¼Œä»¥ä¾¿ä¸‹æ¬¡å†åˆ‡æ¢å›è¿™ä¸ªä»»åŠ¡æ—¶ï¼Œå¯ä»¥å†åŠ è½½è¿™ä¸ªä»»åŠ¡çš„çŠ¶æ€ï¼Œä»»åŠ¡ä»ä¿å­˜åˆ°å†åŠ è½½çš„è¿‡ç¨‹å°±æ˜¯ä¸€æ¬¡ä¸Šä¸‹æ–‡åˆ‡æ¢</p></li></ul><p>æ ¸å¿ƒçº¿ç¨‹æ•°å¸¸ç”¨å…¬å¼ï¼š</p><ul><li><p><strong>CPU å¯†é›†å‹ä»»åŠ¡ (N+1)ï¼š</strong> è¿™ç§ä»»åŠ¡æ¶ˆè€—çš„æ˜¯ CPU èµ„æºï¼Œå¯ä»¥å°†æ ¸å¿ƒçº¿ç¨‹æ•°è®¾ç½®ä¸º N (CPU æ ¸å¿ƒæ•°) + 1ï¼Œæ¯” CPU æ ¸å¿ƒæ•°å¤šå‡ºæ¥çš„ä¸€ä¸ªçº¿ç¨‹æ˜¯ä¸ºäº†é˜²æ­¢çº¿ç¨‹å‘ç”Ÿç¼ºé¡µä¸­æ–­ï¼Œæˆ–è€…å…¶å®ƒåŸå› å¯¼è‡´çš„ä»»åŠ¡æš‚åœè€Œå¸¦æ¥çš„å½±å“ã€‚ä¸€æ—¦ä»»åŠ¡æš‚åœï¼ŒCPU æŸä¸ªæ ¸å¿ƒå°±ä¼šå¤„äºç©ºé—²çŠ¶æ€ï¼Œè€Œåœ¨è¿™ç§æƒ…å†µä¸‹å¤šå‡ºæ¥çš„ä¸€ä¸ªçº¿ç¨‹å°±å¯ä»¥å……åˆ†åˆ©ç”¨ CPU çš„ç©ºé—²æ—¶é—´</p><p>CPU å¯†é›†å‹ç®€å•ç†è§£å°±æ˜¯åˆ©ç”¨ CPU è®¡ç®—èƒ½åŠ›çš„ä»»åŠ¡æ¯”å¦‚åœ¨å†…å­˜ä¸­å¯¹å¤§é‡æ•°æ®è¿›è¡Œåˆ†æ</p></li><li><p><strong>I&#x2F;O å¯†é›†å‹ä»»åŠ¡ï¼š</strong> è¿™ç§ç³»ç»Ÿ CPU å¤„äºé˜»å¡çŠ¶æ€ï¼Œç”¨å¤§éƒ¨åˆ†çš„æ—¶é—´æ¥å¤„ç† I&#x2F;O äº¤äº’ï¼Œè€Œçº¿ç¨‹åœ¨å¤„ç† I&#x2F;O çš„æ—¶é—´æ®µå†…ä¸ä¼šå ç”¨ CPU æ¥å¤„ç†ï¼Œè¿™æ—¶å°±å¯ä»¥å°† CPU äº¤å‡ºç»™å…¶å®ƒçº¿ç¨‹ä½¿ç”¨ï¼Œå› æ­¤åœ¨ I&#x2F;O å¯†é›†å‹ä»»åŠ¡çš„åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å¤šé…ç½®ä¸€äº›çº¿ç¨‹ï¼Œå…·ä½“çš„è®¡ç®—æ–¹æ³•æ˜¯ 2N æˆ– CPU æ ¸æ•°&#x2F; (1-é˜»å¡ç³»æ•°)ï¼Œé˜»å¡ç³»æ•°åœ¨ 0.8~0.9 ä¹‹é—´</p><p>IO å¯†é›†å‹å°±æ˜¯æ¶‰åŠåˆ°ç½‘ç»œè¯»å–ï¼Œæ–‡ä»¶è¯»å–æ­¤ç±»ä»»åŠ¡ ï¼Œç‰¹ç‚¹æ˜¯ CPU è®¡ç®—è€—è´¹æ—¶é—´ç›¸æ¯”äºç­‰å¾… IO æ“ä½œå®Œæˆçš„æ—¶é—´æ¥è¯´å¾ˆå°‘ï¼Œå¤§éƒ¨åˆ†æ—¶é—´éƒ½èŠ±åœ¨äº†ç­‰å¾… IO æ“ä½œå®Œæˆä¸Š</p></li></ul><hr><h4 id="æäº¤æ–¹æ³•"><a href="#æäº¤æ–¹æ³•" class="headerlink" title="æäº¤æ–¹æ³•"></a>æäº¤æ–¹æ³•</h4><p>ExecutorService ç±» APIï¼š</p><table><thead><tr><th>æ–¹æ³•</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>void execute(Runnable command)</td><td>æ‰§è¡Œä»»åŠ¡ï¼ˆExecutor ç±» APIï¼‰</td></tr><tr><td>Future&lt;?&gt; submit(Runnable task)</td><td>æäº¤ä»»åŠ¡ task()</td></tr><tr><td>Future submit(Callable<T> task)</td><td>æäº¤ä»»åŠ¡ taskï¼Œç”¨è¿”å›å€¼ Future è·å¾—ä»»åŠ¡æ‰§è¡Œç»“æœ</td></tr><tr><td>List&lt;Future<T>&gt; invokeAll(Collection&lt;? extends Callable<T>&gt; tasks)</td><td>æäº¤ tasks ä¸­æ‰€æœ‰ä»»åŠ¡</td></tr><tr><td>List&lt;Future<T>&gt; invokeAll(Collection&lt;? extends Callable<T>&gt; tasks, long timeout, TimeUnit unit)</td><td>æäº¤ tasks ä¸­æ‰€æœ‰ä»»åŠ¡ï¼Œè¶…æ—¶æ—¶é—´é’ˆå¯¹æ‰€æœ‰taskï¼Œè¶…æ—¶ä¼šå–æ¶ˆæ²¡æœ‰æ‰§è¡Œå®Œçš„ä»»åŠ¡ï¼Œå¹¶æŠ›å‡ºè¶…æ—¶å¼‚å¸¸</td></tr><tr><td>T invokeAny(Collection&lt;? extends Callable<T>&gt; tasks)</td><td>æäº¤ tasks ä¸­æ‰€æœ‰ä»»åŠ¡ï¼Œå“ªä¸ªä»»åŠ¡å…ˆæˆåŠŸæ‰§è¡Œå®Œæ¯•ï¼Œè¿”å›æ­¤ä»»åŠ¡æ‰§è¡Œç»“æœï¼Œå…¶å®ƒä»»åŠ¡å–æ¶ˆ</td></tr></tbody></table><p>execute å’Œ submit éƒ½å±äºçº¿ç¨‹æ± çš„æ–¹æ³•ï¼Œå¯¹æ¯”ï¼š</p><ul><li><p>execute åªèƒ½æ‰§è¡Œ Runnable ç±»å‹çš„ä»»åŠ¡ï¼Œæ²¡æœ‰è¿”å›å€¼ï¼› submit æ—¢èƒ½æäº¤ Runnable ç±»å‹ä»»åŠ¡ä¹Ÿèƒ½æäº¤ Callable ç±»å‹ä»»åŠ¡ï¼Œåº•å±‚æ˜¯<strong>å°è£…æˆ FutureTaskï¼Œç„¶åè°ƒç”¨ execute æ‰§è¡Œ</strong></p></li><li><p>execute ä¼šç›´æ¥æŠ›å‡ºä»»åŠ¡æ‰§è¡Œæ—¶çš„å¼‚å¸¸ï¼Œsubmit ä¼šåæ‰å¼‚å¸¸ï¼Œå¯é€šè¿‡ Future çš„ get æ–¹æ³•å°†ä»»åŠ¡æ‰§è¡Œæ—¶çš„å¼‚å¸¸é‡æ–°æŠ›å‡º</p></li></ul><hr><h4 id="å…³é—­æ–¹æ³•"><a href="#å…³é—­æ–¹æ³•" class="headerlink" title="å…³é—­æ–¹æ³•"></a>å…³é—­æ–¹æ³•</h4><p>ExecutorService ç±» APIï¼š</p><table><thead><tr><th>æ–¹æ³•</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>void shutdown()</td><td>çº¿ç¨‹æ± çŠ¶æ€å˜ä¸º SHUTDOWNï¼Œç­‰å¾…ä»»åŠ¡æ‰§è¡Œå®Œåå…³é—­çº¿ç¨‹æ± ï¼Œä¸ä¼šæ¥æ”¶æ–°ä»»åŠ¡ï¼Œä½†å·²æäº¤ä»»åŠ¡ä¼šæ‰§è¡Œå®Œï¼Œè€Œä¸”ä¹Ÿå¯ä»¥æ·»åŠ çº¿ç¨‹ï¼ˆä¸ç»‘å®šä»»åŠ¡ï¼‰</td></tr><tr><td>List<Runnable> shutdownNow()</td><td>çº¿ç¨‹æ± çŠ¶æ€å˜ä¸º STOPï¼Œç”¨ interrupt ä¸­æ–­æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡ï¼Œç›´æ¥å…³é—­çº¿ç¨‹æ± ï¼Œä¸ä¼šæ¥æ”¶æ–°ä»»åŠ¡ï¼Œä¼šå°†é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡è¿”å›</td></tr><tr><td>boolean isShutdown()</td><td>ä¸åœ¨ RUNNING çŠ¶æ€çš„çº¿ç¨‹æ± ï¼Œæ­¤æ‰§è¡Œè€…å·²è¢«å…³é—­ï¼Œæ–¹æ³•è¿”å› true</td></tr><tr><td>boolean isTerminated()</td><td>çº¿ç¨‹æ± çŠ¶æ€æ˜¯å¦æ˜¯ TERMINATEDï¼Œå¦‚æœæ‰€æœ‰ä»»åŠ¡åœ¨å…³é—­åå®Œæˆï¼Œè¿”å› true</td></tr><tr><td>boolean awaitTermination(long timeout, TimeUnit unit)</td><td>è°ƒç”¨ shutdown åï¼Œç”±äºè°ƒç”¨çº¿ç¨‹ä¸ä¼šç­‰å¾…æ‰€æœ‰ä»»åŠ¡è¿è¡Œç»“æŸï¼Œå¦‚æœå®ƒæƒ³åœ¨çº¿ç¨‹æ±  TERMINATED ååšäº›äº‹æƒ…ï¼Œå¯ä»¥åˆ©ç”¨æ­¤æ–¹æ³•ç­‰å¾…</td></tr></tbody></table><hr><h4 id="å¤„ç†å¼‚å¸¸"><a href="#å¤„ç†å¼‚å¸¸" class="headerlink" title="å¤„ç†å¼‚å¸¸"></a>å¤„ç†å¼‚å¸¸</h4><p>execute ä¼šç›´æ¥æŠ›å‡ºä»»åŠ¡æ‰§è¡Œæ—¶çš„å¼‚å¸¸ï¼Œsubmit ä¼šåæ‰å¼‚å¸¸ï¼Œæœ‰ä¸¤ç§å¤„ç†æ–¹æ³•</p><p>æ–¹æ³• 1ï¼šä¸»åŠ¨æ‰å¼‚å¸¸</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ExecutorService</span> <span class="variable">executorService</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">1</span>);</span><br><span class="line">pool.submit(() -&gt; &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;task1&quot;</span>);</span><br><span class="line">        <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span> / <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>æ–¹æ³• 2ï¼šä½¿ç”¨ Future å¯¹è±¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ExecutorService</span> <span class="variable">executorService</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">1</span>);</span><br><span class="line">Future&lt;?&gt; future = pool.submit(() -&gt; &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;task1&quot;</span>);</span><br><span class="line">    <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span> / <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;);</span><br><span class="line">System.out.println(future.get());</span><br></pre></td></tr></table></figure><hr><h3 id="å·¥ä½œåŸç†"><a href="#å·¥ä½œåŸç†" class="headerlink" title="å·¥ä½œåŸç†"></a>å·¥ä½œåŸç†</h3><h4 id="çŠ¶æ€ä¿¡æ¯"><a href="#çŠ¶æ€ä¿¡æ¯" class="headerlink" title="çŠ¶æ€ä¿¡æ¯"></a>çŠ¶æ€ä¿¡æ¯</h4><p>ThreadPoolExecutor ä½¿ç”¨ int çš„<strong>é«˜ 3 ä½æ¥è¡¨ç¤ºçº¿ç¨‹æ± çŠ¶æ€ï¼Œä½ 29 ä½è¡¨ç¤ºçº¿ç¨‹æ•°é‡</strong>ã€‚è¿™äº›ä¿¡æ¯å­˜å‚¨åœ¨ä¸€ä¸ªåŸå­å˜é‡ ctl ä¸­ï¼Œç›®çš„æ˜¯å°†çº¿ç¨‹æ± çŠ¶æ€ä¸çº¿ç¨‹ä¸ªæ•°åˆäºŒä¸ºä¸€ï¼Œè¿™æ ·å°±å¯ä»¥ç”¨ä¸€æ¬¡ CAS åŸå­æ“ä½œè¿›è¡Œèµ‹å€¼</p><ul><li><p>çŠ¶æ€è¡¨ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é«˜3ä½ï¼šè¡¨ç¤ºå½“å‰çº¿ç¨‹æ± è¿è¡ŒçŠ¶æ€ï¼Œé™¤å»é«˜3ä½ä¹‹åçš„ä½ä½ï¼šè¡¨ç¤ºå½“å‰çº¿ç¨‹æ± ä¸­æ‰€æ‹¥æœ‰çš„çº¿ç¨‹æ•°é‡</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">AtomicInteger</span> <span class="variable">ctl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicInteger</span>(ctlOf(RUNNING, <span class="number">0</span>));</span><br><span class="line"><span class="comment">// è¡¨ç¤ºåœ¨ ctl ä¸­ï¼Œä½ COUNT_BITS ä½ï¼Œæ˜¯ç”¨äºå­˜æ”¾å½“å‰çº¿ç¨‹æ•°é‡çš„ä½</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">COUNT_BITS</span> <span class="operator">=</span> Integer.SIZE - <span class="number">3</span>;</span><br><span class="line"><span class="comment">// ä½ COUNT_BITS ä½æ‰€èƒ½è¡¨è¾¾çš„æœ€å¤§æ•°å€¼ï¼Œ000 11111111111111111111 =&gt; 5äº¿å¤š</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">CAPACITY</span>   <span class="operator">=</span> (<span class="number">1</span> &lt;&lt; COUNT_BITS) - <span class="number">1</span>;</span><br></pre></td></tr></table></figure><p><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/JUC-%E7%BA%BF%E7%A8%8B%E6%B1%A0%E7%8A%B6%E6%80%81%E8%BD%AC%E6%8D%A2%E5%9B%BE.png"></p></li><li><p>å››ç§çŠ¶æ€ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 111 000000000000000000ï¼Œè½¬æ¢æˆæ•´æ•°åå…¶å®å°±æ˜¯ä¸€ä¸ªã€è´Ÿæ•°ã€‘</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">RUNNING</span>    <span class="operator">=</span> -<span class="number">1</span> &lt;&lt; COUNT_BITS;</span><br><span class="line"><span class="comment">// 000 000000000000000000</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">SHUTDOWN</span>   <span class="operator">=</span>  <span class="number">0</span> &lt;&lt; COUNT_BITS;</span><br><span class="line"><span class="comment">// 001 000000000000000000</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">STOP</span>       <span class="operator">=</span>  <span class="number">1</span> &lt;&lt; COUNT_BITS;</span><br><span class="line"><span class="comment">// 010 000000000000000000</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">TIDYING</span>    <span class="operator">=</span>  <span class="number">2</span> &lt;&lt; COUNT_BITS;</span><br><span class="line"><span class="comment">// 011 000000000000000000</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">TERMINATED</span> <span class="operator">=</span>  <span class="number">3</span> &lt;&lt; COUNT_BITS;</span><br></pre></td></tr></table></figure><table><thead><tr><th>çŠ¶æ€</th><th>é«˜3ä½</th><th>æ¥æ”¶æ–°ä»»åŠ¡</th><th>å¤„ç†é˜»å¡ä»»åŠ¡é˜Ÿåˆ—</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>RUNNING</td><td>111</td><td>Y</td><td>Y</td><td></td></tr><tr><td>SHUTDOWN</td><td>000</td><td>N</td><td>Y</td><td>ä¸æ¥æ”¶æ–°ä»»åŠ¡ï¼Œä½†å¤„ç†é˜»å¡é˜Ÿåˆ—å‰©ä½™ä»»åŠ¡</td></tr><tr><td>STOP</td><td>001</td><td>N</td><td>N</td><td>ä¸­æ–­æ­£åœ¨æ‰§è¡Œçš„ä»»åŠ¡ï¼Œå¹¶æŠ›å¼ƒé˜»å¡é˜Ÿåˆ—ä»»åŠ¡</td></tr><tr><td>TIDYING</td><td>010</td><td>-</td><td>-</td><td>ä»»åŠ¡å…¨æ‰§è¡Œå®Œæ¯•ï¼Œæ´»åŠ¨çº¿ç¨‹ä¸º 0 å³å°†è¿›å…¥ç»ˆç»“</td></tr><tr><td>TERMINATED</td><td>011</td><td>-</td><td>-</td><td>ç»ˆæ­¢çŠ¶æ€</td></tr></tbody></table></li><li><p>è·å–å½“å‰çº¿ç¨‹æ± è¿è¡ŒçŠ¶æ€ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ~CAPACITY = ~000 11111111111111111111 = 111 000000000000000000000ï¼ˆå–åï¼‰</span></span><br><span class="line"><span class="comment">// c == ctl = 111 000000000000000000111</span></span><br><span class="line"><span class="comment">// 111 000000000000000000111</span></span><br><span class="line"><span class="comment">// 111 000000000000000000000</span></span><br><span class="line"><span class="comment">// 111 000000000000000000000è·å–åˆ°äº†è¿è¡ŒçŠ¶æ€</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">runStateOf</span><span class="params">(<span class="type">int</span> c)</span>     &#123; <span class="keyword">return</span> c &amp; ~CAPACITY; &#125;</span><br></pre></td></tr></table></figure></li><li><p>è·å–å½“å‰çº¿ç¨‹æ± çº¿ç¨‹æ•°é‡ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//        c = 111 000000000000000000111</span></span><br><span class="line"><span class="comment">// CAPACITY = 000 111111111111111111111</span></span><br><span class="line"><span class="comment">//            000 000000000000000000111 =&gt; 7</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">workerCountOf</span><span class="params">(<span class="type">int</span> c)</span>  &#123; <span class="keyword">return</span> c &amp; CAPACITY; &#125;</span><br></pre></td></tr></table></figure></li><li><p>é‡ç½®å½“å‰çº¿ç¨‹æ± çŠ¶æ€ ctlï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// rs è¡¨ç¤ºçº¿ç¨‹æ± çŠ¶æ€ï¼Œwc è¡¨ç¤ºå½“å‰çº¿ç¨‹æ± ä¸­ workerï¼ˆçº¿ç¨‹ï¼‰æ•°é‡ï¼Œç›¸ä¸ä»¥åå°±æ˜¯åˆå¹¶åçš„çŠ¶æ€</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">ctlOf</span><span class="params">(<span class="type">int</span> rs, <span class="type">int</span> wc)</span> &#123; <span class="keyword">return</span> rs | wc; &#125;</span><br></pre></td></tr></table></figure></li><li><p>æ¯”è¾ƒå½“å‰çº¿ç¨‹æ±  ctl æ‰€è¡¨ç¤ºçš„çŠ¶æ€ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ¯”è¾ƒå½“å‰çº¿ç¨‹æ±  ctl æ‰€è¡¨ç¤ºçš„çŠ¶æ€ï¼Œæ˜¯å¦å°äºæŸä¸ªçŠ¶æ€ s</span></span><br><span class="line"><span class="comment">// çŠ¶æ€å¯¹æ¯”ï¼šRUNNING &lt; SHUTDOWN &lt; STOP &lt; TIDYING &lt; TERMINATED</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">runStateLessThan</span><span class="params">(<span class="type">int</span> c, <span class="type">int</span> s)</span> &#123; <span class="keyword">return</span> c &lt; s; &#125;</span><br><span class="line"><span class="comment">// æ¯”è¾ƒå½“å‰çº¿ç¨‹æ±  ctl æ‰€è¡¨ç¤ºçš„çŠ¶æ€ï¼Œæ˜¯å¦å¤§äºç­‰äºæŸä¸ªçŠ¶æ€s</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">runStateAtLeast</span><span class="params">(<span class="type">int</span> c, <span class="type">int</span> s)</span> &#123; <span class="keyword">return</span> c &gt;= s; &#125;</span><br><span class="line"><span class="comment">// å°äº SHUTDOWN çš„ä¸€å®šæ˜¯ RUNNINGï¼ŒSHUTDOWN == 0</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isRunning</span><span class="params">(<span class="type">int</span> c)</span> &#123; <span class="keyword">return</span> c &lt; SHUTDOWN; &#125;</span><br></pre></td></tr></table></figure></li><li><p>è®¾ç½®çº¿ç¨‹æ±  ctlï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä½¿ç”¨ CAS æ–¹å¼ è®© ctl å€¼ +1 ï¼ŒæˆåŠŸè¿”å› true, å¤±è´¥è¿”å› false</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">compareAndIncrementWorkerCount</span><span class="params">(<span class="type">int</span> expect)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> ctl.compareAndSet(expect, expect + <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ä½¿ç”¨ CAS æ–¹å¼ è®© ctl å€¼ -1 ï¼ŒæˆåŠŸè¿”å› true, å¤±è´¥è¿”å› false</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">compareAndDecrementWorkerCount</span><span class="params">(<span class="type">int</span> expect)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> ctl.compareAndSet(expect, expect - <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// å°† ctl å€¼å‡ä¸€ï¼Œdo while å¾ªç¯ä¼šä¸€ç›´é‡è¯•ï¼Œç›´åˆ°æˆåŠŸä¸ºæ­¢</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">decrementWorkerCount</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">do</span> &#123;&#125; <span class="keyword">while</span> (!compareAndDecrementWorkerCount(ctl.get()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><hr><h4 id="æˆå‘˜å±æ€§-2"><a href="#æˆå‘˜å±æ€§-2" class="headerlink" title="æˆå‘˜å±æ€§"></a>æˆå‘˜å±æ€§</h4><p>æˆå‘˜å˜é‡</p><ul><li><p><strong>çº¿ç¨‹æ± ä¸­å­˜æ”¾ Worker çš„å®¹å™¨</strong>ï¼šçº¿ç¨‹æ± æ²¡æœ‰åˆå§‹åŒ–ï¼Œç›´æ¥å¾€æ± ä¸­åŠ çº¿ç¨‹å³å¯</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> HashSet&lt;Worker&gt; workers = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;Worker&gt;();</span><br></pre></td></tr></table></figure></li><li><p>çº¿ç¨‹å…¨å±€é”ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¢åŠ å‡å°‘ worker æˆ–è€…æ—¶ä¿®æ”¹çº¿ç¨‹æ± è¿è¡ŒçŠ¶æ€éœ€è¦æŒæœ‰ mainLock</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">mainLock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br></pre></td></tr></table></figure></li><li><p>å¯é‡å…¥é”çš„æ¡ä»¶å˜é‡ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å½“å¤–éƒ¨çº¿ç¨‹è°ƒç”¨ awaitTermination() æ–¹æ³•æ—¶ï¼Œä¼šç­‰å¾…å½“å‰çº¿ç¨‹æ± çŠ¶æ€ä¸º Termination ä¸ºæ­¢</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Condition</span> <span class="variable">termination</span> <span class="operator">=</span> mainLock.newCondition()</span><br></pre></td></tr></table></figure></li><li><p>çº¿ç¨‹æ± ç›¸å…³å‚æ•°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">int</span> corePoolSize;<span class="comment">// æ ¸å¿ƒçº¿ç¨‹æ•°é‡</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">int</span> maximumPoolSize;<span class="comment">// çº¿ç¨‹æ± æœ€å¤§çº¿ç¨‹æ•°é‡</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">long</span> keepAliveTime;<span class="comment">// ç©ºé—²çº¿ç¨‹å­˜æ´»æ—¶é—´</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> ThreadFactory threadFactory;<span class="comment">// åˆ›å»ºçº¿ç¨‹æ—¶ä½¿ç”¨çš„çº¿ç¨‹å·¥å‚ï¼Œé»˜è®¤æ˜¯ DefaultThreadFactory</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> BlockingQueue&lt;Runnable&gt; workQueue;<span class="comment">// ã€è¶…è¿‡æ ¸å¿ƒçº¿ç¨‹æäº¤ä»»åŠ¡å°±æ”¾å…¥ é˜»å¡é˜Ÿåˆ—ã€‘</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> RejectedExecutionHandler handler;<span class="comment">// æ‹’ç»ç­–ç•¥ï¼ŒjucåŒ…æä¾›äº†4ä¸­æ–¹å¼</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">RejectedExecutionHandler</span> <span class="variable">defaultHandler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AbortPolicy</span>();<span class="comment">// é»˜è®¤ç­–ç•¥</span></span><br></pre></td></tr></table></figure></li><li><p>è®°å½•çº¿ç¨‹æ± ç›¸å…³å±æ€§çš„æ•°å€¼ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">int</span> largestPoolSize;<span class="comment">// è®°å½•çº¿ç¨‹æ± ç”Ÿå‘½å‘¨æœŸå†…çº¿ç¨‹æ•°æœ€å¤§å€¼</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">long</span> completedTaskCount;<span class="comment">// è®°å½•çº¿ç¨‹æ± æ‰€å®Œæˆä»»åŠ¡æ€»æ•°ï¼Œå½“æŸä¸ª worker é€€å‡ºæ—¶å°†å®Œæˆçš„ä»»åŠ¡ç´¯åŠ åˆ°è¯¥å±æ€§</span></span><br></pre></td></tr></table></figure></li><li><p>æ§åˆ¶<strong>æ ¸å¿ƒçº¿ç¨‹æ•°é‡å†…çš„çº¿ç¨‹æ˜¯å¦å¯ä»¥è¢«å›æ”¶</strong>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// falseï¼ˆé»˜è®¤ï¼‰ä»£è¡¨ä¸å¯ä»¥ï¼Œä¸º true æ—¶æ ¸å¿ƒçº¿ç¨‹ç©ºé—²è¶…è¿‡ keepAliveTime ä¹Ÿä¼šè¢«å›æ”¶</span></span><br><span class="line"><span class="comment">// allowCoreThreadTimeOut(boolean value) æ–¹æ³•å¯ä»¥è®¾ç½®è¯¥å€¼</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">boolean</span> allowCoreThreadTimeOut;</span><br></pre></td></tr></table></figure></li></ul><p>å†…éƒ¨ç±»ï¼š</p><ul><li><p>Worker ç±»ï¼š<strong>æ¯ä¸ª Worker å¯¹è±¡ä¼šç»‘å®šä¸€ä¸ªåˆå§‹ä»»åŠ¡</strong>ï¼Œå¯åŠ¨ Worker æ—¶ä¼˜å…ˆæ‰§è¡Œï¼Œè¿™ä¹Ÿæ˜¯é€ æˆçº¿ç¨‹æ± ä¸å…¬å¹³çš„åŸå› ã€‚Worker ç»§æ‰¿è‡ª AQSï¼Œæœ¬èº«å…·æœ‰é”çš„ç‰¹æ€§ï¼Œé‡‡ç”¨ç‹¬å é”æ¨¡å¼ï¼Œstate &#x3D; 0 è¡¨ç¤ºæœªè¢«å ç”¨ï¼Œ&gt; 0 è¡¨ç¤ºè¢«å ç”¨ï¼Œ&lt; 0 è¡¨ç¤ºåˆå§‹çŠ¶æ€ä¸èƒ½è¢«æŠ¢é”</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Worker</span> <span class="keyword">extends</span> <span class="title class_">AbstractQueuedSynchronizer</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line"><span class="keyword">final</span> Thread thread;<span class="comment">// worker å†…éƒ¨å°è£…çš„å·¥ä½œçº¿ç¨‹</span></span><br><span class="line">    Runnable firstTask;<span class="comment">// worker ç¬¬ä¸€ä¸ªæ‰§è¡Œçš„ä»»åŠ¡ï¼Œæ™®é€šçš„ Runnable å®ç°ç±»æˆ–è€…æ˜¯ FutureTask</span></span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">long</span> completedTasks;<span class="comment">// è®°å½•å½“å‰ worker æ‰€å®Œæˆä»»åŠ¡æ•°é‡</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ„é€ æ–¹æ³•</span></span><br><span class="line">    Worker(Runnable firstTask) &#123;</span><br><span class="line">        <span class="comment">// è®¾ç½®AQSç‹¬å æ¨¡å¼ä¸ºåˆå§‹åŒ–ä¸­çŠ¶æ€ï¼Œè¿™ä¸ªçŠ¶æ€ä¸èƒ½è¢«æŠ¢å é”</span></span><br><span class="line">       setState(-<span class="number">1</span>);</span><br><span class="line">        <span class="comment">// firstTaskä¸ä¸ºç©ºæ—¶ï¼Œå½“workerå¯åŠ¨åï¼Œå†…éƒ¨çº¿ç¨‹ä¼šä¼˜å…ˆæ‰§è¡ŒfirstTaskï¼Œæ‰§è¡Œå®Œåä¼šåˆ°queueä¸­å»è·å–ä¸‹ä¸ªä»»åŠ¡</span></span><br><span class="line">        <span class="built_in">this</span>.firstTask = firstTask;</span><br><span class="line">        <span class="comment">// ä½¿ç”¨çº¿ç¨‹å·¥å‚åˆ›å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œå¹¶ä¸”ã€å°†å½“å‰workeræŒ‡å®šä¸ºRunnableã€‘ï¼Œæ‰€ä»¥threadå¯åŠ¨æ—¶ä¼šè°ƒç”¨ worker.run()</span></span><br><span class="line">        <span class="built_in">this</span>.thread = getThreadFactory().newThread(<span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ã€ä¸å¯é‡å…¥é”ã€‘</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">tryAcquire</span><span class="params">(<span class="type">int</span> unused)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, <span class="number">1</span>)) &#123;</span><br><span class="line">            setExclusiveOwnerThread(Thread.currentThread());</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Thread <span class="title function_">newThread</span><span class="params">(Runnable r)</span> &#123;</span><br><span class="line">    <span class="comment">// å°†å½“å‰ worker æŒ‡å®šä¸º thread çš„æ‰§è¡Œæ–¹æ³•ï¼Œçº¿ç¨‹è°ƒç”¨ start ä¼šè°ƒç”¨ r.run()</span></span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(group, r, namePrefix + threadNumber.getAndIncrement(), <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (t.isDaemon())</span><br><span class="line">        t.setDaemon(<span class="literal">false</span>);</span><br><span class="line">    <span class="keyword">if</span> (t.getPriority() != Thread.NORM_PRIORITY)</span><br><span class="line">        t.setPriority(Thread.NORM_PRIORITY);</span><br><span class="line">    <span class="keyword">return</span> t;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>æ‹’ç»ç­–ç•¥ç›¸å…³çš„å†…éƒ¨ç±»</p></li></ul><hr><h4 id="æˆå‘˜æ–¹æ³•-2"><a href="#æˆå‘˜æ–¹æ³•-2" class="headerlink" title="æˆå‘˜æ–¹æ³•"></a>æˆå‘˜æ–¹æ³•</h4><h5 id="æäº¤æ–¹æ³•-1"><a href="#æäº¤æ–¹æ³•-1" class="headerlink" title="æäº¤æ–¹æ³•"></a>æäº¤æ–¹æ³•</h5><ul><li><p>AbstractExecutorService#submit()ï¼šæäº¤ä»»åŠ¡ï¼Œ<strong>æŠŠ Runnable æˆ– Callable ä»»åŠ¡å°è£…æˆ FutureTask æ‰§è¡Œ</strong>ï¼Œå¯ä»¥é€šè¿‡æ–¹æ³•è¿”å›çš„ä»»åŠ¡å¯¹è±¡ï¼Œè°ƒç”¨ get é˜»å¡è·å–ä»»åŠ¡æ‰§è¡Œçš„ç»“æœæˆ–è€…å¼‚å¸¸ï¼Œæºç åˆ†æåœ¨ç¬”è®°çš„ Future éƒ¨åˆ†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Future&lt;?&gt; submit(Runnable task) &#123;</span><br><span class="line">    <span class="comment">// ç©ºæŒ‡é’ˆå¼‚å¸¸</span></span><br><span class="line">    <span class="keyword">if</span> (task == <span class="literal">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">    <span class="comment">// æŠŠ Runnable å°è£…æˆæœªæ¥ä»»åŠ¡å¯¹è±¡ï¼Œæ‰§è¡Œç»“æœå°±æ˜¯ nullï¼Œä¹Ÿå¯ä»¥é€šè¿‡å‚æ•°æŒ‡å®š FutureTask#get è¿”å›æ•°æ®</span></span><br><span class="line">    RunnableFuture&lt;Void&gt; ftask = newTaskFor(task, <span class="literal">null</span>);</span><br><span class="line">    <span class="comment">// æ‰§è¡Œæ–¹æ³•</span></span><br><span class="line">    execute(ftask);</span><br><span class="line">    <span class="keyword">return</span> ftask;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; Future&lt;T&gt; <span class="title function_">submit</span><span class="params">(Callable&lt;T&gt; task)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (task == <span class="literal">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">    <span class="comment">// æŠŠ Callable å°è£…æˆæœªæ¥ä»»åŠ¡å¯¹è±¡</span></span><br><span class="line">    RunnableFuture&lt;T&gt; ftask = newTaskFor(task);</span><br><span class="line">    <span class="comment">// æ‰§è¡Œæ–¹æ³•</span></span><br><span class="line">    execute(ftask);</span><br><span class="line">    <span class="comment">// è¿”å›æœªæ¥ä»»åŠ¡å¯¹è±¡ï¼Œç”¨æ¥è·å–è¿”å›å€¼</span></span><br><span class="line">    <span class="keyword">return</span> ftask;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> &lt;T&gt; RunnableFuture&lt;T&gt; <span class="title function_">newTaskFor</span><span class="params">(Runnable runnable, T value)</span> &#123;</span><br><span class="line">    <span class="comment">// Runnable å°è£…æˆ FutureTaskï¼Œã€æŒ‡å®šè¿”å›å€¼ã€‘</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">FutureTask</span>&lt;T&gt;(runnable, value);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">protected</span> &lt;T&gt; RunnableFuture&lt;T&gt; <span class="title function_">newTaskFor</span><span class="params">(Callable&lt;T&gt; callable)</span> &#123;</span><br><span class="line">    <span class="comment">// Callable ç›´æ¥å°è£…æˆ FutureTask</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">FutureTask</span>&lt;T&gt;(callable);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>execute()ï¼šæ‰§è¡Œä»»åŠ¡ï¼Œ<strong>ä½†æ˜¯æ²¡æœ‰è¿”å›å€¼ï¼Œæ²¡åŠæ³•è·å–ä»»åŠ¡æ‰§è¡Œç»“æœ</strong>ï¼Œå‡ºç°å¼‚å¸¸ä¼šç›´æ¥æŠ›å‡ºä»»åŠ¡æ‰§è¡Œæ—¶çš„å¼‚å¸¸ã€‚æ ¹æ®çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°ï¼Œé€‰æ‹©æ·»åŠ ä»»åŠ¡æ—¶çš„å¤„ç†æ–¹å¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// command å¯ä»¥æ˜¯æ™®é€šçš„ Runnable å®ç°ç±»ï¼Œä¹Ÿå¯ä»¥æ˜¯ FutureTaskï¼Œä¸èƒ½æ˜¯ Callable</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Runnable command)</span> &#123;</span><br><span class="line">    <span class="comment">// éç©ºåˆ¤æ–­</span></span><br><span class="line">    <span class="keyword">if</span> (command == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">  <span class="comment">// è·å– ctl æœ€æ–°å€¼èµ‹å€¼ç»™ cï¼Œctl é«˜ 3 ä½è¡¨ç¤ºçº¿ç¨‹æ± çŠ¶æ€ï¼Œä½ä½è¡¨ç¤ºå½“å‰çº¿ç¨‹æ± çº¿ç¨‹æ•°é‡ã€‚</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> ctl.get();</span><br><span class="line">    <span class="comment">// ã€1ã€‘å½“å‰çº¿ç¨‹æ•°é‡å°äºæ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œæ­¤æ¬¡æäº¤ä»»åŠ¡ç›´æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„ workerï¼Œçº¿ç¨‹æ± ä¸­å¤šäº†ä¸€ä¸ªæ–°çš„çº¿ç¨‹</span></span><br><span class="line">    <span class="keyword">if</span> (workerCountOf(c) &lt; corePoolSize) &#123;</span><br><span class="line">        <span class="comment">// addWorker ä¸ºåˆ›å»ºçº¿ç¨‹çš„è¿‡ç¨‹ï¼Œä¼šåˆ›å»º worker å¯¹è±¡å¹¶ä¸”å°† command ä½œä¸º firstTaskï¼Œä¼˜å…ˆæ‰§è¡Œ</span></span><br><span class="line">        <span class="keyword">if</span> (addWorker(command, <span class="literal">true</span>))</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ‰§è¡Œåˆ°è¿™æ¡è¯­å¥ï¼Œè¯´æ˜ addWorker ä¸€å®šæ˜¯å¤±è´¥çš„ï¼Œå­˜åœ¨å¹¶å‘ç°è±¡æˆ–è€…çº¿ç¨‹æ± çŠ¶æ€è¢«æ”¹å˜ï¼Œé‡æ–°è·å–çŠ¶æ€</span></span><br><span class="line">        <span class="comment">// SHUTDOWN çŠ¶æ€ä¸‹ä¹Ÿæœ‰å¯èƒ½åˆ›å»ºæˆåŠŸï¼Œå‰æ firstTask == null è€Œä¸”å½“å‰ queue ä¸ä¸ºç©ºï¼ˆç‰¹æ®Šæƒ…å†µï¼‰</span></span><br><span class="line">        c = ctl.get();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ã€2ã€‘æ‰§è¡Œåˆ°è¿™è¯´æ˜å½“å‰çº¿ç¨‹æ•°é‡å·²ç»è¾¾åˆ°æ ¸å¿ƒçº¿ç¨‹æ•°é‡ æˆ–è€… addWorker å¤±è´¥</span></span><br><span class="line">    <span class="comment">// åˆ¤æ–­å½“å‰çº¿ç¨‹æ± æ˜¯å¦å¤„äºrunningçŠ¶æ€ï¼Œæˆç«‹å°±å°è¯•å°† task æ”¾å…¥åˆ° workQueue ä¸­</span></span><br><span class="line">    <span class="keyword">if</span> (isRunning(c) &amp;&amp; workQueue.offer(command)) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">recheck</span> <span class="operator">=</span> ctl.get();</span><br><span class="line">        <span class="comment">// æ¡ä»¶ä¸€æˆç«‹è¯´æ˜çº¿ç¨‹æ± çŠ¶æ€è¢«å¤–éƒ¨çº¿ç¨‹ç»™ä¿®æ”¹äº†ï¼Œå¯èƒ½æ˜¯æ‰§è¡Œäº† shutdown() æ–¹æ³•ï¼Œè¯¥çŠ¶æ€ä¸èƒ½æ¥æ”¶æ–°æäº¤çš„ä»»åŠ¡</span></span><br><span class="line">        <span class="comment">// æ‰€ä»¥è¦æŠŠåˆšæäº¤çš„ä»»åŠ¡åˆ é™¤ï¼Œåˆ é™¤æˆåŠŸè¯´æ˜æäº¤ä¹‹åçº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹è¿˜æœªæ¶ˆè´¹ï¼ˆå¤„ç†ï¼‰è¯¥ä»»åŠ¡</span></span><br><span class="line">        <span class="keyword">if</span> (!isRunning(recheck) &amp;&amp; remove(command))</span><br><span class="line">            <span class="comment">// ä»»åŠ¡å‡ºé˜ŸæˆåŠŸï¼Œèµ°æ‹’ç»ç­–ç•¥</span></span><br><span class="line">            reject(command);</span><br><span class="line">        <span class="comment">// æ‰§è¡Œåˆ°è¿™è¯´æ˜çº¿ç¨‹æ± æ˜¯ running çŠ¶æ€ï¼Œè·å–çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°é‡ï¼Œåˆ¤æ–­æ˜¯å¦æ˜¯ 0</span></span><br><span class="line">        <span class="comment">// ã€æ‹…ä¿æœºåˆ¶ã€‘ï¼Œä¿è¯çº¿ç¨‹æ± åœ¨ running çŠ¶æ€ä¸‹ï¼Œæœ€èµ·ç å¾—æœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨å·¥ä½œ</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (workerCountOf(recheck) == <span class="number">0</span>)</span><br><span class="line">            addWorker(<span class="literal">null</span>, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ã€3ã€‘offerå¤±è´¥è¯´æ˜queueæ»¡äº†</span></span><br><span class="line">    <span class="comment">// å¦‚æœçº¿ç¨‹æ•°é‡å°šæœªè¾¾åˆ° maximumPoolSizeï¼Œä¼šåˆ›å»ºéæ ¸å¿ƒ worker çº¿ç¨‹ç›´æ¥æ‰§è¡Œ commandï¼Œã€è¿™ä¹Ÿæ˜¯ä¸å…¬å¹³çš„åŸå› ã€‘</span></span><br><span class="line">    <span class="comment">// å¦‚æœå½“å‰çº¿ç¨‹æ•°é‡è¾¾åˆ° maximumPoolSizï¼Œè¿™é‡Œ addWorker ä¹Ÿä¼šå¤±è´¥ï¼Œèµ°æ‹’ç»ç­–ç•¥</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!addWorker(command, <span class="literal">false</span>))</span><br><span class="line">        reject(command);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><hr><h5 id="æ·»åŠ çº¿ç¨‹"><a href="#æ·»åŠ çº¿ç¨‹" class="headerlink" title="æ·»åŠ çº¿ç¨‹"></a>æ·»åŠ çº¿ç¨‹</h5><ul><li><p>prestartAllCoreThreads()ï¼š<strong>æå‰é¢„çƒ­</strong>ï¼Œåˆ›å»ºæ‰€æœ‰çš„æ ¸å¿ƒçº¿ç¨‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">prestartAllCoreThreads</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (addWorker(<span class="literal">null</span>, <span class="literal">true</span>))</span><br><span class="line">        ++n;</span><br><span class="line">    <span class="keyword">return</span> n;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>addWorker()ï¼š<strong>æ·»åŠ çº¿ç¨‹åˆ°çº¿ç¨‹æ± </strong>ï¼Œè¿”å› true è¡¨ç¤ºåˆ›å»º Worker æˆåŠŸï¼Œä¸”çº¿ç¨‹å¯åŠ¨ã€‚é¦–å…ˆåˆ¤æ–­çº¿ç¨‹æ± æ˜¯å¦å…è®¸æ·»åŠ çº¿ç¨‹ï¼Œå…è®¸å°±è®©çº¿ç¨‹æ•°é‡ + 1ï¼Œç„¶åå»åˆ›å»º Worker åŠ å…¥çº¿ç¨‹æ± </p><p>æ³¨æ„ï¼šSHUTDOWN çŠ¶æ€ä¹Ÿèƒ½æ·»åŠ çº¿ç¨‹ï¼Œä½†æ˜¯è¦æ±‚æ–°åŠ çš„ Woker æ²¡æœ‰ firstTaskï¼Œè€Œä¸”å½“å‰ queue ä¸ä¸ºç©ºï¼Œæ‰€ä»¥åˆ›å»ºä¸€ä¸ªçº¿ç¨‹æ¥å¸®åŠ©çº¿ç¨‹æ± æ‰§è¡Œé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// core == true è¡¨ç¤ºé‡‡ç”¨æ ¸å¿ƒçº¿ç¨‹æ•°é‡é™åˆ¶ï¼Œfalse è¡¨ç¤ºé‡‡ç”¨ maximumPoolSize</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">addWorker</span><span class="params">(Runnable firstTask, <span class="type">boolean</span> core)</span> &#123;</span><br><span class="line">    <span class="comment">// è‡ªæ—‹ã€åˆ¤æ–­å½“å‰çº¿ç¨‹æ± çŠ¶æ€æ˜¯å¦å…è®¸åˆ›å»ºçº¿ç¨‹ã€‘ï¼Œå…è®¸å°±è®¾ç½®çº¿ç¨‹æ•°é‡ + 1</span></span><br><span class="line">    retry:</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="comment">// è·å– ctl çš„å€¼</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> ctl.get();</span><br><span class="line">        <span class="comment">// è·å–å½“å‰çº¿ç¨‹æ± è¿è¡ŒçŠ¶æ€</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">rs</span> <span class="operator">=</span> runStateOf(c);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// åˆ¤æ–­å½“å‰çº¿ç¨‹æ± çŠ¶æ€ã€æ˜¯å¦å…è®¸æ·»åŠ çº¿ç¨‹ã€‘</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å½“å‰çº¿ç¨‹æ± æ˜¯ SHUTDOWN çŠ¶æ€ï¼Œä½†æ˜¯é˜Ÿåˆ—é‡Œé¢è¿˜æœ‰ä»»åŠ¡å°šæœªå¤„ç†å®Œï¼Œéœ€è¦å¤„ç†å®Œ queue ä¸­çš„ä»»åŠ¡</span></span><br><span class="line">        <span class="comment">// ã€ä¸å…è®¸å†æäº¤æ–°çš„ taskï¼Œæ‰€ä»¥ firstTask ä¸ºç©ºï¼Œä½†æ˜¯å¯ä»¥ç»§ç»­æ·»åŠ  workerã€‘</span></span><br><span class="line">        <span class="keyword">if</span> (rs &gt;= SHUTDOWN &amp;&amp; !(rs == SHUTDOWN &amp;&amp; firstTask == <span class="literal">null</span> &amp;&amp; !workQueue.isEmpty()))</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="comment">// è·å–çº¿ç¨‹æ± ä¸­çº¿ç¨‹æ•°é‡</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">wc</span> <span class="operator">=</span> workerCountOf(c);</span><br><span class="line">            <span class="comment">// æ¡ä»¶ä¸€ä¸€èˆ¬ä¸æˆç«‹ï¼ŒCAPACITYæ˜¯5äº¿å¤šï¼Œæ ¹æ® core åˆ¤æ–­ä½¿ç”¨å“ªä¸ªå¤§å°é™åˆ¶çº¿ç¨‹æ•°é‡ï¼Œè¶…è¿‡äº†è¿”å› false</span></span><br><span class="line">            <span class="keyword">if</span> (wc &gt;= CAPACITY || wc &gt;= (core ? corePoolSize : maximumPoolSize))</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            <span class="comment">// è®°å½•çº¿ç¨‹æ•°é‡å·²ç»åŠ  1ï¼Œç±»æ¯”äºç”³è¯·åˆ°äº†ä¸€å—ä»¤ç‰Œï¼Œæ¡ä»¶å¤±è´¥è¯´æ˜å…¶ä»–çº¿ç¨‹ä¿®æ”¹äº†æ•°é‡</span></span><br><span class="line">            <span class="keyword">if</span> (compareAndIncrementWorkerCount(c))</span><br><span class="line">                <span class="comment">// ç”³è¯·æˆåŠŸï¼Œè·³å‡ºäº† retry è¿™ä¸ª for è‡ªæ—‹</span></span><br><span class="line">                <span class="keyword">break</span> retry;</span><br><span class="line">            <span class="comment">// CAS å¤±è´¥ï¼Œæ²¡æœ‰æˆåŠŸçš„ç”³è¯·åˆ°ä»¤ç‰Œ</span></span><br><span class="line">            c = ctl.get();</span><br><span class="line">            <span class="comment">// åˆ¤æ–­å½“å‰çº¿ç¨‹æ± çŠ¶æ€æ˜¯å¦å‘ç”Ÿè¿‡å˜åŒ–ï¼Œè¢«å…¶ä»–çº¿ç¨‹ä¿®æ”¹äº†ï¼Œå¯èƒ½å…¶ä»–çº¿ç¨‹è°ƒç”¨äº† shutdown() æ–¹æ³•</span></span><br><span class="line">            <span class="keyword">if</span> (runStateOf(c) != rs)</span><br><span class="line">                <span class="comment">// è¿”å›å¤–å±‚å¾ªç¯æ£€æŸ¥æ˜¯å¦èƒ½åˆ›å»ºçº¿ç¨‹ï¼Œåœ¨ if è¯­å¥ä¸­è¿”å› false</span></span><br><span class="line">                <span class="keyword">continue</span> retry;</span><br><span class="line">           </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//ã€ä»¤ç‰Œç”³è¯·æˆåŠŸï¼Œå¼€å§‹åˆ›å»ºçº¿ç¨‹ã€‘</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">// è¿è¡Œæ ‡è®°ï¼Œè¡¨ç¤ºåˆ›å»ºçš„ worker æ˜¯å¦å·²ç»å¯åŠ¨ï¼Œfalseæœªå¯åŠ¨  trueå¯åŠ¨</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">workerStarted</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">// æ·»åŠ æ ‡è®°ï¼Œè¡¨ç¤ºåˆ›å»ºçš„ worker æ˜¯å¦æ·»åŠ åˆ°æ± å­ä¸­äº†ï¼Œé»˜è®¤falseæœªæ·»åŠ ï¼Œtrueæ˜¯æ·»åŠ ã€‚</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">workerAdded</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="type">Worker</span> <span class="variable">w</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// ã€åˆ›å»º Workerï¼Œåº•å±‚é€šè¿‡çº¿ç¨‹å·¥å‚ newThread æ–¹æ³•åˆ›å»ºæ‰§è¡Œçº¿ç¨‹ï¼ŒæŒ‡å®šäº†é¦–å…ˆæ‰§è¡Œçš„ä»»åŠ¡ã€‘</span></span><br><span class="line">        w = <span class="keyword">new</span> <span class="title class_">Worker</span>(firstTask);</span><br><span class="line">        <span class="comment">// å°†æ–°åˆ›å»ºçš„ worker èŠ‚ç‚¹ä¸­çš„çº¿ç¨‹èµ‹å€¼ç»™ t</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> w.thread;</span><br><span class="line">        <span class="comment">// è¿™é‡Œçš„åˆ¤æ–­ä¸ºäº†é˜²æ­¢ ç¨‹åºå‘˜è‡ªå®šä¹‰çš„ ThreadFactory å®ç°ç±»æœ‰ bugï¼Œåˆ›é€ ä¸å‡ºçº¿ç¨‹</span></span><br><span class="line">        <span class="keyword">if</span> (t != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">mainLock</span> <span class="operator">=</span> <span class="built_in">this</span>.mainLock;</span><br><span class="line">            <span class="comment">// åŠ äº’æ–¥é”ï¼Œè¦æ·»åŠ  worker äº†</span></span><br><span class="line">            mainLock.lock();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// è·å–æœ€æ–°çº¿ç¨‹æ± è¿è¡ŒçŠ¶æ€ä¿å­˜åˆ° rs</span></span><br><span class="line">                <span class="type">int</span> <span class="variable">rs</span> <span class="operator">=</span> runStateOf(ctl.get());</span><br><span class="line"><span class="comment">// åˆ¤æ–­çº¿ç¨‹æ± æ˜¯å¦ä¸ºRUNNINGçŠ¶æ€ï¼Œä¸æ˜¯å†ã€åˆ¤æ–­å½“å‰æ˜¯å¦ä¸ºSHUTDOWNçŠ¶æ€ä¸”firstTaskä¸ºç©ºï¼Œç‰¹æ®Šæƒ…å†µã€‘</span></span><br><span class="line">                <span class="keyword">if</span> (rs &lt; SHUTDOWN || (rs == SHUTDOWN &amp;&amp; firstTask == <span class="literal">null</span>)) &#123;</span><br><span class="line">                    <span class="comment">// å½“çº¿ç¨‹startåï¼Œçº¿ç¨‹isAliveä¼šè¿”å›trueï¼Œè¿™é‡Œè¿˜æ²¡å¼€å§‹å¯åŠ¨çº¿ç¨‹ï¼Œå¦‚æœè¢«å¯åŠ¨äº†å°±éœ€è¦æŠ¥é”™</span></span><br><span class="line">                    <span class="keyword">if</span> (t.isAlive())</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalThreadStateException</span>();</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">//ã€å°†æ–°å»ºçš„ Worker æ·»åŠ åˆ°çº¿ç¨‹æ± ä¸­ã€‘</span></span><br><span class="line">                    workers.add(w);</span><br><span class="line">                    <span class="type">int</span> <span class="variable">s</span> <span class="operator">=</span> workers.size();</span><br><span class="line"><span class="comment">// å½“å‰æ± ä¸­çš„çº¿ç¨‹æ•°é‡æ˜¯ä¸€ä¸ªæ–°é«˜ï¼Œæ›´æ–° largestPoolSize</span></span><br><span class="line">                    <span class="keyword">if</span> (s &gt; largestPoolSize)</span><br><span class="line">                        largestPoolSize = s;</span><br><span class="line">                    <span class="comment">// æ·»åŠ æ ‡è®°ç½®ä¸º true</span></span><br><span class="line">                    workerAdded = <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="comment">// è§£é”å•Š</span></span><br><span class="line">                mainLock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// æ·»åŠ æˆåŠŸå°±ã€å¯åŠ¨çº¿ç¨‹æ‰§è¡Œä»»åŠ¡ã€‘</span></span><br><span class="line">            <span class="keyword">if</span> (workerAdded) &#123;</span><br><span class="line">                <span class="comment">// Thread ç±»ä¸­æŒæœ‰ Runnable ä»»åŠ¡å¯¹è±¡ï¼Œè°ƒç”¨çš„æ˜¯ Runnable çš„ run ï¼Œä¹Ÿå°±æ˜¯ FutureTask</span></span><br><span class="line">                t.start();</span><br><span class="line">                <span class="comment">// è¿è¡Œæ ‡è®°ç½®ä¸º true</span></span><br><span class="line">                workerStarted = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœå¯åŠ¨çº¿ç¨‹å¤±è´¥ï¼Œåšæ¸…ç†å·¥ä½œ</span></span><br><span class="line">        <span class="keyword">if</span> (! workerStarted)</span><br><span class="line">            addWorkerFailed(w);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è¿”å›æ–°åˆ›å»ºçš„çº¿ç¨‹æ˜¯å¦å¯åŠ¨</span></span><br><span class="line">    <span class="keyword">return</span> workerStarted;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>addWorkerFailed()ï¼šæ¸…ç†ä»»åŠ¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">addWorkerFailed</span><span class="params">(Worker w)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">mainLock</span> <span class="operator">=</span> <span class="built_in">this</span>.mainLock;</span><br><span class="line">    <span class="comment">// æŒæœ‰çº¿ç¨‹æ± å…¨å±€é”ï¼Œå› ä¸ºæ“ä½œçš„æ˜¯çº¿ç¨‹æ± ç›¸å…³çš„ä¸œè¥¿</span></span><br><span class="line">    mainLock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//æ¡ä»¶æˆç«‹éœ€è¦å°† worker åœ¨ workers ä¸­æ¸…ç†å‡ºå»ã€‚</span></span><br><span class="line">        <span class="keyword">if</span> (w != <span class="literal">null</span>)</span><br><span class="line">            workers.remove(w);</span><br><span class="line">        <span class="comment">// å°†çº¿ç¨‹æ± è®¡æ•° -1ï¼Œç›¸å½“äºå½’è¿˜ä»¤ç‰Œã€‚</span></span><br><span class="line">        decrementWorkerCount();</span><br><span class="line">        <span class="comment">// å°è¯•åœæ­¢çº¿ç¨‹æ± </span></span><br><span class="line">        tryTerminate();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">//é‡Šæ”¾çº¿ç¨‹æ± å…¨å±€é”ã€‚</span></span><br><span class="line">        mainLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><hr><h5 id="è¿è¡Œæ–¹æ³•"><a href="#è¿è¡Œæ–¹æ³•" class="headerlink" title="è¿è¡Œæ–¹æ³•"></a>è¿è¡Œæ–¹æ³•</h5><ul><li><p>Worker#runï¼šWorker å®ç°äº† Runnable æ¥å£ï¼Œå½“çº¿ç¨‹å¯åŠ¨æ—¶ï¼Œä¼šè°ƒç”¨ Worker çš„ run() æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// ThreadPoolExecutor#runWorker()</span></span><br><span class="line">    runWorker(<span class="built_in">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>runWorker()ï¼šçº¿ç¨‹å¯åŠ¨å°±è¦<strong>æ‰§è¡Œä»»åŠ¡</strong>ï¼Œä¼šä¸€ç›´ while å¾ªç¯è·å–ä»»åŠ¡å¹¶æ‰§è¡Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">runWorker</span><span class="params">(Worker w)</span> &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">wt</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">    <span class="comment">// è·å– worker çš„ firstTask</span></span><br><span class="line">    <span class="type">Runnable</span> <span class="variable">task</span> <span class="operator">=</span> w.firstTask;</span><br><span class="line">    <span class="comment">// å¼•ç”¨ç½®ç©ºï¼Œã€é˜²æ­¢å¤ç”¨è¯¥çº¿ç¨‹æ—¶é‡å¤æ‰§è¡Œè¯¥ä»»åŠ¡ã€‘</span></span><br><span class="line">    w.firstTask = <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">// åˆå§‹åŒ– worker æ—¶è®¾ç½® state = -1ï¼Œè¡¨ç¤ºä¸å…è®¸æŠ¢å é”</span></span><br><span class="line">    <span class="comment">// è¿™é‡Œéœ€è¦è®¾ç½® state = 0 å’Œ exclusiveOwnerThread = nullï¼Œå¼€å§‹ç‹¬å æ¨¡å¼æŠ¢é”</span></span><br><span class="line">    w.unlock();</span><br><span class="line">    <span class="comment">// true è¡¨ç¤ºå‘ç”Ÿå¼‚å¸¸é€€å‡ºï¼Œfalse è¡¨ç¤ºæ­£å¸¸é€€å‡ºã€‚</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">completedAbruptly</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// firstTask ä¸æ˜¯ null å°±ç›´æ¥è¿è¡Œï¼Œå¦åˆ™å» queue ä¸­è·å–ä»»åŠ¡</span></span><br><span class="line">        <span class="comment">// ã€getTask å¦‚æœæ˜¯é˜»å¡è·å–ä»»åŠ¡ï¼Œä¼šä¸€ç›´é˜»å¡åœ¨takeæ–¹æ³•ï¼Œç›´åˆ°è·å–ä»»åŠ¡ï¼Œä¸ä¼šèµ°è¿”å›nullçš„é€»è¾‘ã€‘</span></span><br><span class="line">        <span class="keyword">while</span> (task != <span class="literal">null</span> || (task = getTask()) != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// worker åŠ é”ï¼Œshutdown æ—¶ä¼šåˆ¤æ–­å½“å‰ worker çŠ¶æ€ï¼Œã€æ ¹æ®ç‹¬å é”çŠ¶æ€åˆ¤æ–­æ˜¯å¦ç©ºé—²ã€‘</span></span><br><span class="line">            w.lock();</span><br><span class="line">            </span><br><span class="line"><span class="comment">// è¯´æ˜çº¿ç¨‹æ± çŠ¶æ€å¤§äº STOPï¼Œç›®å‰å¤„äº STOP/TIDYING/TERMINATIONï¼Œæ­¤æ—¶ç»™çº¿ç¨‹ä¸€ä¸ªä¸­æ–­ä¿¡å·</span></span><br><span class="line">            <span class="keyword">if</span> ((runStateAtLeast(ctl.get(), STOP) ||</span><br><span class="line">                 <span class="comment">// è¯´æ˜çº¿ç¨‹å¤„äº RUNNING æˆ–è€… SHUTDOWN çŠ¶æ€ï¼Œæ¸…é™¤æ‰“æ–­æ ‡è®°</span></span><br><span class="line">                 (Thread.interrupted() &amp;&amp; runStateAtLeast(ctl.get(), STOP))) &amp;&amp; !wt.isInterrupted())</span><br><span class="line">                <span class="comment">// ä¸­æ–­çº¿ç¨‹ï¼Œè®¾ç½®çº¿ç¨‹çš„ä¸­æ–­æ ‡å¿—ä½ä¸º true</span></span><br><span class="line">                wt.interrupt();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// é’©å­æ–¹æ³•ï¼Œã€ä»»åŠ¡æ‰§è¡Œçš„å‰ç½®å¤„ç†ã€‘</span></span><br><span class="line">                beforeExecute(wt, task);</span><br><span class="line">                <span class="type">Throwable</span> <span class="variable">thrown</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// ã€æ‰§è¡Œä»»åŠ¡ã€‘</span></span><br><span class="line">                    task.run();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception x) &#123;</span><br><span class="line">                 <span class="comment">//.....</span></span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="comment">// é’©å­æ–¹æ³•ï¼Œã€ä»»åŠ¡æ‰§è¡Œçš„åç½®å¤„ç†ã€‘</span></span><br><span class="line">                    afterExecute(task, thrown);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                task = <span class="literal">null</span>;<span class="comment">// å°†å±€éƒ¨å˜é‡taskç½®ä¸ºnullï¼Œä»£è¡¨ä»»åŠ¡æ‰§è¡Œå®Œæˆ</span></span><br><span class="line">                w.completedTasks++;<span class="comment">// æ›´æ–°workerå®Œæˆä»»åŠ¡æ•°é‡</span></span><br><span class="line">                w.unlock();<span class="comment">// è§£é”</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// getTask()æ–¹æ³•è¿”å›nullæ—¶ä¼šèµ°åˆ°è¿™é‡Œï¼Œè¡¨ç¤ºqueueä¸ºç©ºå¹¶ä¸”çº¿ç¨‹ç©ºé—²è¶…è¿‡ä¿æ´»æ—¶é—´ï¼Œã€å½“å‰çº¿ç¨‹æ‰§è¡Œé€€å‡ºé€»è¾‘ã€‘</span></span><br><span class="line">        completedAbruptly = <span class="literal">false</span>;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// æ­£å¸¸é€€å‡º completedAbruptly = false</span></span><br><span class="line">       <span class="comment">// å¼‚å¸¸é€€å‡º completedAbruptly = trueï¼Œã€ä» task.run() å†…éƒ¨æŠ›å‡ºå¼‚å¸¸ã€‘æ—¶ï¼Œè·³åˆ°è¿™ä¸€è¡Œ</span></span><br><span class="line">        processWorkerExit(w, completedAbruptly);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>unlock()ï¼šé‡ç½®é”</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">()</span> &#123; release(<span class="number">1</span>); &#125;</span><br><span class="line"><span class="comment">// å¤–éƒ¨ä¸ä¼šç›´æ¥è°ƒç”¨è¿™ä¸ªæ–¹æ³• è¿™ä¸ªæ–¹æ³•æ˜¯ AQS å†…è°ƒç”¨çš„ï¼Œå¤–éƒ¨è°ƒç”¨ unlock æ—¶è§¦å‘æ­¤æ–¹æ³•</span></span><br><span class="line"><span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">tryRelease</span><span class="params">(<span class="type">int</span> unused)</span> &#123;</span><br><span class="line">    setExclusiveOwnerThread(<span class="literal">null</span>);<span class="comment">// è®¾ç½®æŒæœ‰è€…ä¸º null</span></span><br><span class="line">    setState(<span class="number">0</span>);<span class="comment">// è®¾ç½® state = 0</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>getTask()ï¼šè·å–ä»»åŠ¡ï¼Œçº¿ç¨‹ç©ºé—²æ—¶é—´è¶…è¿‡ keepAliveTime å°±ä¼šè¢«å›æ”¶ï¼Œåˆ¤æ–­çš„ä¾æ®æ˜¯<strong>å½“å‰çº¿ç¨‹é˜»å¡è·å–ä»»åŠ¡è¶…è¿‡ä¿æ´»æ—¶é—´</strong>ï¼Œæ–¹æ³•è¿”å› null å°±ä»£è¡¨å½“å‰çº¿ç¨‹è¦è¢«å›æ”¶äº†ï¼Œè¿”å›åˆ° runWorker æ‰§è¡Œçº¿ç¨‹é€€å‡ºé€»è¾‘ã€‚çº¿ç¨‹æ± å…·æœ‰æ‹…ä¿æœºåˆ¶ï¼Œå¯¹äº RUNNING çŠ¶æ€ä¸‹çš„è¶…æ—¶å›æ”¶ï¼Œè¦ä¿è¯çº¿ç¨‹æ± ä¸­æœ€å°‘æœ‰ä¸€ä¸ªçº¿ç¨‹è¿è¡Œï¼Œæˆ–è€…ä»»åŠ¡é˜»å¡é˜Ÿåˆ—å·²ç»æ˜¯ç©º</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Runnable <span class="title function_">getTask</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// è¶…æ—¶æ ‡è®°ï¼Œè¡¨ç¤ºå½“å‰çº¿ç¨‹è·å–ä»»åŠ¡æ˜¯å¦è¶…æ—¶ï¼Œtrue è¡¨ç¤ºå·²è¶…æ—¶</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">timedOut</span> <span class="operator">=</span> <span class="literal">false</span>; </span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> ctl.get();</span><br><span class="line">        <span class="comment">// è·å–çº¿ç¨‹æ± å½“å‰è¿è¡ŒçŠ¶æ€</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">rs</span> <span class="operator">=</span> runStateOf(c);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ã€tryTerminateã€‘æ‰“æ–­çº¿ç¨‹åæ‰§è¡Œåˆ°è¿™ï¼Œæ­¤æ—¶çº¿ç¨‹æ± çŠ¶æ€ä¸ºSTOPæˆ–è€…çº¿ç¨‹æ± çŠ¶æ€ä¸ºSHUTDOWNå¹¶ä¸”é˜Ÿåˆ—å·²ç»æ˜¯ç©º</span></span><br><span class="line">        <span class="comment">// æ‰€ä»¥ä¸‹é¢çš„ if æ¡ä»¶ä¸€å®šæ˜¯æˆç«‹çš„ï¼Œå¯ä»¥ç›´æ¥è¿”å› nullï¼Œçº¿ç¨‹å°±åº”è¯¥é€€å‡ºäº†</span></span><br><span class="line">        <span class="keyword">if</span> (rs &gt;= SHUTDOWN &amp;&amp; (rs &gt;= STOP || workQueue.isEmpty())) &#123;</span><br><span class="line">            <span class="comment">// ä½¿ç”¨ CAS è‡ªæ—‹çš„æ–¹å¼è®© ctl å€¼ -1</span></span><br><span class="line">            decrementWorkerCount();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line"><span class="comment">// è·å–çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°é‡</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">wc</span> <span class="operator">=</span> workerCountOf(c);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// çº¿ç¨‹æ²¡æœ‰æ˜ç¡®çš„åŒºåˆ†è°æ˜¯æ ¸å¿ƒæˆ–è€…éæ ¸å¿ƒçº¿ç¨‹ï¼Œæ˜¯æ ¹æ®å½“å‰æ± ä¸­çš„çº¿ç¨‹æ•°é‡åˆ¤æ–­</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// timed = false è¡¨ç¤ºå½“å‰è¿™ä¸ªçº¿ç¨‹ è·å–taskæ—¶ä¸æ”¯æŒè¶…æ—¶æœºåˆ¶çš„ï¼Œå½“å‰çº¿ç¨‹ä¼šä½¿ç”¨ queue.take() é˜»å¡è·å–</span></span><br><span class="line">        <span class="comment">// timed = true è¡¨ç¤ºå½“å‰è¿™ä¸ªçº¿ç¨‹ è·å–taskæ—¶æ”¯æŒè¶…æ—¶æœºåˆ¶ï¼Œä½¿ç”¨ queue.poll(xxx,xxx) è¶…æ—¶è·å–</span></span><br><span class="line">        <span class="comment">// æ¡ä»¶ä¸€ä»£è¡¨å…è®¸å›æ”¶æ ¸å¿ƒçº¿ç¨‹ï¼Œé‚£å°±æ— æ‰€è°“äº†ï¼Œå…¨éƒ¨çº¿ç¨‹éƒ½æ‰§è¡Œè¶…æ—¶å›æ”¶</span></span><br><span class="line">        <span class="comment">// æ¡ä»¶äºŒæˆç«‹è¯´æ˜çº¿ç¨‹æ•°é‡å¤§äºæ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œå½“å‰çº¿ç¨‹è®¤ä¸ºæ˜¯éæ ¸å¿ƒçº¿ç¨‹ï¼Œæœ‰ä¿æ´»æ—¶é—´ï¼Œå»è¶…æ—¶è·å–ä»»åŠ¡</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">timed</span> <span class="operator">=</span> allowCoreThreadTimeOut || wc &gt; corePoolSize;</span><br><span class="line">        </span><br><span class="line"><span class="comment">// å¦‚æœçº¿ç¨‹æ•°é‡æ˜¯å¦è¶…è¿‡æœ€å¤§çº¿ç¨‹æ•°ï¼Œç›´æ¥å›æ”¶</span></span><br><span class="line">        <span class="comment">// å¦‚æœå½“å‰çº¿ç¨‹ã€å…è®¸è¶…æ—¶å›æ”¶å¹¶ä¸”å·²ç»è¶…æ—¶äº†ã€‘ï¼Œå°±åº”è¯¥è¢«å›æ”¶äº†ï¼Œç”±äºã€æ‹…ä¿æœºåˆ¶ã€‘è¿˜è¦åšåˆ¤æ–­ï¼š</span></span><br><span class="line">        <span class="comment">//   wc &gt; 1 è¯´æ˜çº¿ç¨‹æ± è¿˜ç”¨å…¶ä»–çº¿ç¨‹ï¼Œå½“å‰çº¿ç¨‹å¯ä»¥ç›´æ¥å›æ”¶</span></span><br><span class="line">        <span class="comment">//    workQueue.isEmpty() å‰ç½®æ¡ä»¶æ˜¯ wc = 1ï¼Œã€å¦‚æœå½“å‰ä»»åŠ¡é˜Ÿåˆ—ä¹Ÿæ˜¯ç©ºäº†ï¼Œæœ€åä¸€ä¸ªçº¿ç¨‹å°±å¯ä»¥é€€å‡ºã€‘</span></span><br><span class="line">        <span class="keyword">if</span> ((wc &gt; maximumPoolSize || (timed &amp;&amp; timedOut)) &amp;&amp; (wc &gt; <span class="number">1</span> || workQueue.isEmpty())) &#123;</span><br><span class="line">            <span class="comment">// ä½¿ç”¨ CAS æœºåˆ¶å°† ctl å€¼ -1 ,å‡ 1 æˆåŠŸçš„çº¿ç¨‹ï¼Œè¿”å› nullï¼Œä»£è¡¨å¯ä»¥é€€å‡º</span></span><br><span class="line">            <span class="keyword">if</span> (compareAndDecrementWorkerCount(c))</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// æ ¹æ®å½“å‰çº¿ç¨‹æ˜¯å¦éœ€è¦è¶…æ—¶å›æ”¶ï¼Œã€é€‰æ‹©ä»é˜Ÿåˆ—è·å–ä»»åŠ¡çš„æ–¹æ³•ã€‘æ˜¯è¶…æ—¶è·å–æˆ–è€…é˜»å¡è·å–</span></span><br><span class="line">            <span class="type">Runnable</span> <span class="variable">r</span> <span class="operator">=</span> timed ?</span><br><span class="line">                workQueue.poll(keepAliveTime, TimeUnit.NANOSECONDS) : workQueue.take();</span><br><span class="line">            <span class="comment">// è·å–åˆ°ä»»åŠ¡è¿”å›ä»»åŠ¡ï¼Œã€é˜»å¡è·å–ä¼šé˜»å¡åˆ°è·å–ä»»åŠ¡ä¸ºæ­¢ã€‘ï¼Œä¸ä¼šè¿”å› null</span></span><br><span class="line">            <span class="keyword">if</span> (r != <span class="literal">null</span>)</span><br><span class="line">                <span class="keyword">return</span> r;</span><br><span class="line">            <span class="comment">// è·å–ä»»åŠ¡ä¸º null è¯´æ˜è¶…æ—¶äº†ï¼Œå°†è¶…æ—¶æ ‡è®°è®¾ç½®ä¸º trueï¼Œä¸‹æ¬¡è‡ªæ—‹æ—¶è¿” null</span></span><br><span class="line">            timedOut = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException retry) &#123;</span><br><span class="line">            <span class="comment">// é˜»å¡çº¿ç¨‹è¢«æ‰“æ–­åè¶…æ—¶æ ‡è®°ç½®ä¸º falseï¼Œã€è¯´æ˜è¢«æ‰“æ–­ä¸ç®—è¶…æ—¶ã€‘ï¼Œè¦ç»§ç»­è·å–ï¼Œç›´åˆ°è¶…æ—¶æˆ–è€…è·å–åˆ°ä»»åŠ¡</span></span><br><span class="line">            <span class="comment">// å¦‚æœçº¿ç¨‹æ±  SHUTDOWN çŠ¶æ€ä¸‹çš„æ‰“æ–­ï¼Œä¼šåœ¨å¾ªç¯è·å–ä»»åŠ¡å‰åˆ¤æ–­ï¼Œè¿”å› null</span></span><br><span class="line">            timedOut = <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>processWorkerExit()ï¼š<strong>çº¿ç¨‹é€€å‡ºçº¿ç¨‹æ± </strong>ï¼Œä¹Ÿæœ‰æ‹…ä¿æœºåˆ¶ï¼Œä¿è¯é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡è¢«æ‰§è¡Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ­£å¸¸é€€å‡º completedAbruptly = falseï¼Œå¼‚å¸¸é€€å‡ºä¸º true</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">processWorkerExit</span><span class="params">(Worker w, <span class="type">boolean</span> completedAbruptly)</span> &#123;</span><br><span class="line">    <span class="comment">// æ¡ä»¶æˆç«‹ä»£è¡¨å½“å‰ worker æ˜¯å‘ç”Ÿå¼‚å¸¸é€€å‡ºçš„ï¼Œtask ä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­å‘ä¸ŠæŠ›å‡ºå¼‚å¸¸äº†</span></span><br><span class="line">    <span class="keyword">if</span> (completedAbruptly) </span><br><span class="line">        <span class="comment">// ä»å¼‚å¸¸æ—¶åˆ°è¿™é‡Œ ctl ä¸€ç›´æ²¡æœ‰ -1ï¼Œéœ€è¦åœ¨è¿™é‡Œ -1</span></span><br><span class="line">        decrementWorkerCount();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">mainLock</span> <span class="operator">=</span> <span class="built_in">this</span>.mainLock;</span><br><span class="line">    <span class="comment">// åŠ é”</span></span><br><span class="line">    mainLock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// å°†å½“å‰ worker å®Œæˆçš„ task æ•°é‡ï¼Œæ±‡æ€»åˆ°çº¿ç¨‹æ± çš„ completedTaskCount</span></span><br><span class="line">        completedTaskCount += w.completedTasks;</span><br><span class="line"><span class="comment">// å°† worker ä»çº¿ç¨‹æ± ä¸­ç§»é™¤</span></span><br><span class="line">        workers.remove(w);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        mainLock.unlock();<span class="comment">// è§£é”</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// å°è¯•åœæ­¢çº¿ç¨‹æ± ï¼Œå”¤é†’ä¸‹ä¸€ä¸ªçº¿ç¨‹</span></span><br><span class="line">    tryTerminate();</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> ctl.get();</span><br><span class="line">    <span class="comment">// çº¿ç¨‹æ± ä¸æ˜¯åœæ­¢çŠ¶æ€å°±åº”è¯¥æœ‰çº¿ç¨‹è¿è¡Œã€æ‹…ä¿æœºåˆ¶ã€‘</span></span><br><span class="line">    <span class="keyword">if</span> (runStateLessThan(c, STOP)) &#123;</span><br><span class="line">        <span class="comment">// æ­£å¸¸é€€å‡ºçš„é€»è¾‘ï¼Œæ˜¯å¯¹ç©ºé—²çº¿ç¨‹å›æ”¶ï¼Œä¸æ˜¯æ‰§è¡Œå‡ºé”™</span></span><br><span class="line">        <span class="keyword">if</span> (!completedAbruptly) &#123;</span><br><span class="line">            <span class="comment">// æ ¹æ®æ˜¯å¦å›æ”¶æ ¸å¿ƒçº¿ç¨‹ç¡®å®šã€çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°é‡æœ€å°å€¼ã€‘</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">min</span> <span class="operator">=</span> allowCoreThreadTimeOut ? <span class="number">0</span> : corePoolSize;</span><br><span class="line">            <span class="comment">// æœ€å°å€¼ä¸º 0ï¼Œä½†æ˜¯çº¿ç¨‹é˜Ÿåˆ—ä¸ä¸ºç©ºï¼Œéœ€è¦ä¸€ä¸ªçº¿ç¨‹æ¥å®Œæˆä»»åŠ¡æ‹…ä¿æœºåˆ¶</span></span><br><span class="line">            <span class="keyword">if</span> (min == <span class="number">0</span> &amp;&amp; !workQueue.isEmpty())</span><br><span class="line">                min = <span class="number">1</span>;</span><br><span class="line">            <span class="comment">// çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°é‡å¤§äºæœ€å°å€¼å¯ä»¥ç›´æ¥è¿”å›</span></span><br><span class="line">            <span class="keyword">if</span> (workerCountOf(c) &gt;= min)</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æ‰§è¡Œ task æ—¶å‘ç”Ÿå¼‚å¸¸ï¼Œæœ‰ä¸ªçº¿ç¨‹å› ä¸ºå¼‚å¸¸ç»ˆæ­¢äº†ï¼Œéœ€è¦æ·»åŠ </span></span><br><span class="line">        <span class="comment">// æˆ–è€…çº¿ç¨‹æ± ä¸­çš„æ•°é‡å°äºæœ€å°å€¼ï¼Œè¿™é‡Œè¦åˆ›å»ºä¸€ä¸ªæ–° worker åŠ è¿›çº¿ç¨‹æ± </span></span><br><span class="line">        addWorker(<span class="literal">null</span>, <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><hr><h5 id="åœæ­¢æ–¹æ³•"><a href="#åœæ­¢æ–¹æ³•" class="headerlink" title="åœæ­¢æ–¹æ³•"></a>åœæ­¢æ–¹æ³•</h5><ul><li><p>shutdown()ï¼šåœæ­¢çº¿ç¨‹æ± </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">shutdown</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">mainLock</span> <span class="operator">=</span> <span class="built_in">this</span>.mainLock;</span><br><span class="line">    <span class="comment">// è·å–çº¿ç¨‹æ± å…¨å±€é”</span></span><br><span class="line">    mainLock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        checkShutdownAccess();</span><br><span class="line">        <span class="comment">// è®¾ç½®çº¿ç¨‹æ± çŠ¶æ€ä¸º SHUTDOWNï¼Œå¦‚æœçº¿ç¨‹æ± çŠ¶æ€å¤§äº SHUTDOWNï¼Œå°±ä¸ä¼šè®¾ç½®ç›´æ¥è¿”å›</span></span><br><span class="line">        advanceRunState(SHUTDOWN);</span><br><span class="line">        <span class="comment">// ä¸­æ–­ç©ºé—²çº¿ç¨‹</span></span><br><span class="line">        interruptIdleWorkers();</span><br><span class="line">        <span class="comment">// ç©ºæ–¹æ³•ï¼Œå­ç±»å¯ä»¥æ‰©å±•</span></span><br><span class="line">        onShutdown(); </span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// é‡Šæ”¾çº¿ç¨‹æ± å…¨å±€é”</span></span><br><span class="line">        mainLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">    tryTerminate();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>interruptIdleWorkers()ï¼šshutdown æ–¹æ³•ä¼š<strong>ä¸­æ–­æ‰€æœ‰ç©ºé—²çº¿ç¨‹</strong>ï¼Œæ ¹æ®æ˜¯å¦å¯ä»¥è·å– AQS ç‹¬å é”åˆ¤æ–­æ˜¯å¦å¤„äºå·¥ä½œçŠ¶æ€ã€‚çº¿ç¨‹ä¹‹æ‰€ä»¥ç©ºé—²æ˜¯å› ä¸ºé˜»å¡é˜Ÿåˆ—æ²¡æœ‰ä»»åŠ¡ï¼Œä¸ä¼šä¸­æ–­æ­£åœ¨è¿è¡Œçš„çº¿ç¨‹ï¼Œæ‰€ä»¥ shutdown æ–¹æ³•ä¼šè®©æ‰€æœ‰çš„ä»»åŠ¡æ‰§è¡Œå®Œæ¯•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// onlyOne == true è¯´æ˜åªä¸­æ–­ä¸€ä¸ªçº¿ç¨‹ ï¼Œfalse åˆ™ä¸­æ–­æ‰€æœ‰çº¿ç¨‹</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">interruptIdleWorkers</span><span class="params">(<span class="type">boolean</span> onlyOne)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">mainLock</span> <span class="operator">=</span> <span class="built_in">this</span>.mainLock;</span><br><span class="line">    / /æŒæœ‰å…¨å±€é”</span><br><span class="line">    mainLock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// éå†æ‰€æœ‰ worker</span></span><br><span class="line">        <span class="keyword">for</span> (Worker w : workers) &#123;</span><br><span class="line">            <span class="comment">// è·å–å½“å‰ worker çš„çº¿ç¨‹</span></span><br><span class="line">            <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> w.thread;</span><br><span class="line">            <span class="comment">// æ¡ä»¶ä¸€æˆç«‹ï¼šè¯´æ˜å½“å‰è¿­ä»£çš„è¿™ä¸ªçº¿ç¨‹å°šæœªä¸­æ–­</span></span><br><span class="line">            <span class="comment">// æ¡ä»¶äºŒæˆç«‹ï¼šè¯´æ˜ã€å½“å‰workerå¤„äºç©ºé—²çŠ¶æ€ã€‘ï¼Œé˜»å¡åœ¨pollæˆ–è€…takeï¼Œå› ä¸ºworkeræ‰§è¡Œtaskæ—¶æ˜¯è¦åŠ é”çš„</span></span><br><span class="line">            <span class="comment">//           æ¯ä¸ªworkeræœ‰ä¸€ä¸ªç‹¬å é”ï¼Œw.tryLock()å°è¯•åŠ é”ï¼ŒåŠ é”æˆåŠŸè¿”å› true</span></span><br><span class="line">            <span class="keyword">if</span> (!t.isInterrupted() &amp;&amp; w.tryLock()) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// ä¸­æ–­çº¿ç¨‹ï¼Œå¤„äº queue é˜»å¡çš„çº¿ç¨‹ä¼šè¢«å”¤é†’ï¼Œè¿›å…¥ä¸‹ä¸€æ¬¡è‡ªæ—‹ï¼Œè¿”å› nullï¼Œæ‰§è¡Œé€€å‡ºç›¸é€»è¾‘</span></span><br><span class="line">                    t.interrupt();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (SecurityException ignore) &#123;</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="comment">// é‡Šæ”¾workerçš„ç‹¬å é”</span></span><br><span class="line">                    w.unlock();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// falseï¼Œä»£è¡¨ä¸­æ–­æ‰€æœ‰çš„çº¿ç¨‹</span></span><br><span class="line">            <span class="keyword">if</span> (onlyOne)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// é‡Šæ”¾å…¨å±€é”</span></span><br><span class="line">        mainLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>shutdownNow()ï¼šç›´æ¥å…³é—­çº¿ç¨‹æ± ï¼Œä¸ä¼šç­‰å¾…ä»»åŠ¡æ‰§è¡Œå®Œæˆ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> List&lt;Runnable&gt; <span class="title function_">shutdownNow</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// è¿”å›å€¼å¼•ç”¨</span></span><br><span class="line">    List&lt;Runnable&gt; tasks;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">mainLock</span> <span class="operator">=</span> <span class="built_in">this</span>.mainLock;</span><br><span class="line">    <span class="comment">// è·å–çº¿ç¨‹æ± å…¨å±€é”</span></span><br><span class="line">    mainLock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        checkShutdownAccess();</span><br><span class="line">        <span class="comment">// è®¾ç½®çº¿ç¨‹æ± çŠ¶æ€ä¸ºSTOP</span></span><br><span class="line">        advanceRunState(STOP);</span><br><span class="line">        <span class="comment">// ä¸­æ–­çº¿ç¨‹æ± ä¸­ã€æ‰€æœ‰çº¿ç¨‹ã€‘</span></span><br><span class="line">        interruptWorkers();</span><br><span class="line">        <span class="comment">// ä»é˜»å¡é˜Ÿåˆ—ä¸­å¯¼å‡ºæœªå¤„ç†çš„task</span></span><br><span class="line">        tasks = drainQueue();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        mainLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    tryTerminate();</span><br><span class="line">    <span class="comment">// è¿”å›å½“å‰ä»»åŠ¡é˜Ÿåˆ—ä¸­ æœªå¤„ç†çš„ä»»åŠ¡ã€‚</span></span><br><span class="line">    <span class="keyword">return</span> tasks;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>tryTerminate()ï¼šè®¾ç½®ä¸º TERMINATED çŠ¶æ€ if either (SHUTDOWN and pool and queue empty) or (STOP and pool empty)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">tryTerminate</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="comment">// è·å– ctl çš„å€¼</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> ctl.get();</span><br><span class="line">        <span class="comment">// çº¿ç¨‹æ± æ­£å¸¸ï¼Œæˆ–è€…æœ‰å…¶ä»–çº¿ç¨‹æ‰§è¡Œäº†çŠ¶æ€è½¬æ¢çš„æ–¹æ³•ï¼Œå½“å‰çº¿ç¨‹ç›´æ¥è¿”å›</span></span><br><span class="line">        <span class="keyword">if</span> (isRunning(c) || runStateAtLeast(c, TIDYING) ||</span><br><span class="line">            <span class="comment">// çº¿ç¨‹æ± æ˜¯ SHUTDOWN å¹¶ä¸”ä»»åŠ¡é˜Ÿåˆ—ä¸æ˜¯ç©ºï¼Œéœ€è¦å»å¤„ç†é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡</span></span><br><span class="line">            (runStateOf(c) == SHUTDOWN &amp;&amp; ! workQueue.isEmpty()))</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ‰§è¡Œåˆ°è¿™é‡Œè¯´æ˜çº¿ç¨‹æ± çŠ¶æ€ä¸º STOP æˆ–è€…çº¿ç¨‹æ± çŠ¶æ€ä¸º SHUTDOWN å¹¶ä¸”é˜Ÿåˆ—å·²ç»æ˜¯ç©º</span></span><br><span class="line">        <span class="comment">// åˆ¤æ–­çº¿ç¨‹æ± ä¸­çº¿ç¨‹çš„æ•°é‡</span></span><br><span class="line">        <span class="keyword">if</span> (workerCountOf(c) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// ã€ä¸­æ–­ä¸€ä¸ªç©ºé—²çº¿ç¨‹ã€‘ï¼Œåœ¨ queue.take() | queue.poll() é˜»å¡ç©ºé—²</span></span><br><span class="line">            <span class="comment">// å”¤é†’åçš„çº¿ç¨‹ä¼šåœ¨getTask()æ–¹æ³•è¿”å›nullï¼Œ</span></span><br><span class="line">            <span class="comment">// æ‰§è¡Œ processWorkerExit é€€å‡ºé€»è¾‘æ—¶ä¼šå†æ¬¡è°ƒç”¨ tryTerminate() å”¤é†’ä¸‹ä¸€ä¸ªç©ºé—²çº¿ç¨‹</span></span><br><span class="line">            interruptIdleWorkers(ONLY_ONE);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">// æ± ä¸­çš„çº¿ç¨‹æ•°é‡ä¸º 0 æ¥åˆ°è¿™é‡Œ</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">mainLock</span> <span class="operator">=</span> <span class="built_in">this</span>.mainLock;</span><br><span class="line">        <span class="comment">// åŠ å…¨å±€é”</span></span><br><span class="line">        mainLock.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// è®¾ç½®çº¿ç¨‹æ± çŠ¶æ€ä¸º TIDYING çŠ¶æ€ï¼Œçº¿ç¨‹æ•°é‡ä¸º 0</span></span><br><span class="line">            <span class="keyword">if</span> (ctl.compareAndSet(c, ctlOf(TIDYING, <span class="number">0</span>))) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// ç»“æŸçº¿ç¨‹æ± </span></span><br><span class="line">                    terminated();</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="comment">// è®¾ç½®çº¿ç¨‹æ± çŠ¶æ€ä¸ºTERMINATEDçŠ¶æ€ã€‚</span></span><br><span class="line">                    ctl.set(ctlOf(TERMINATED, <span class="number">0</span>));</span><br><span class="line">                    <span class="comment">// ã€å”¤é†’æ‰€æœ‰è°ƒç”¨ awaitTermination() æ–¹æ³•çš„çº¿ç¨‹ã€‘</span></span><br><span class="line">                    termination.signalAll();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line"><span class="comment">// é‡Šæ”¾çº¿ç¨‹æ± å…¨å±€é”</span></span><br><span class="line">            mainLock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><hr><h4 id="Future"><a href="#Future" class="headerlink" title="Future"></a>Future</h4><h5 id="çº¿ç¨‹ä½¿ç”¨"><a href="#çº¿ç¨‹ä½¿ç”¨" class="headerlink" title="çº¿ç¨‹ä½¿ç”¨"></a>çº¿ç¨‹ä½¿ç”¨</h5><p>FutureTask æœªæ¥ä»»åŠ¡å¯¹è±¡ï¼Œç»§æ‰¿ Runnableã€Future æ¥å£ï¼Œç”¨äºåŒ…è£… Callable å¯¹è±¡ï¼Œå®ç°ä»»åŠ¡çš„æäº¤</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ExecutionException, InterruptedException &#123;</span><br><span class="line">    FutureTask&lt;String&gt; task = <span class="keyword">new</span> <span class="title class_">FutureTask</span>&lt;&gt;(<span class="keyword">new</span> <span class="title class_">Callable</span>&lt;String&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;Hello World&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(task).start();<span class="comment">//å¯åŠ¨çº¿ç¨‹</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">msg</span> <span class="operator">=</span> task.get();<span class="comment">//è·å–è¿”å›ä»»åŠ¡æ•°æ®</span></span><br><span class="line">    System.out.println(msg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ„é€ æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">FutureTask</span><span class="params">(Callable&lt;V&gt; callable)</span>&#123;</span><br><span class="line"><span class="built_in">this</span>.callable = callable;<span class="comment">// å±æ€§æ³¨å…¥</span></span><br><span class="line">    <span class="built_in">this</span>.state = NEW; <span class="comment">// ä»»åŠ¡çŠ¶æ€è®¾ç½®ä¸º new</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">FutureTask</span><span class="params">(Runnable runnable, V result)</span> &#123;</span><br><span class="line">    <span class="comment">// é€‚é…å™¨æ¨¡å¼</span></span><br><span class="line">    <span class="built_in">this</span>.callable = Executors.callable(runnable, result);</span><br><span class="line">    <span class="built_in">this</span>.state = NEW;       </span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; Callable&lt;T&gt; <span class="title function_">callable</span><span class="params">(Runnable task, T result)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (task == <span class="literal">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">    <span class="comment">// ä½¿ç”¨è£…é¥°è€…æ¨¡å¼å°† runnable è½¬æ¢æˆ callable æ¥å£ï¼Œå¤–éƒ¨çº¿ç¨‹é€šè¿‡ get è·å–</span></span><br><span class="line">    <span class="comment">// å½“å‰ä»»åŠ¡æ‰§è¡Œç»“æœæ—¶ï¼Œç»“æœå¯èƒ½ä¸º null ä¹Ÿå¯èƒ½ä¸ºä¼ è¿›æ¥çš„å€¼ï¼Œã€ä¼ è¿›æ¥ä»€ä¹ˆè¿”å›ä»€ä¹ˆã€‘</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">RunnableAdapter</span>&lt;T&gt;(task, result);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">RunnableAdapter</span>&lt;T&gt; <span class="keyword">implements</span> <span class="title class_">Callable</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">final</span> Runnable task;</span><br><span class="line">    <span class="keyword">final</span> T result;</span><br><span class="line">    <span class="comment">// æ„é€ æ–¹æ³•</span></span><br><span class="line">    RunnableAdapter(Runnable task, T result) &#123;</span><br><span class="line">        <span class="built_in">this</span>.task = task;</span><br><span class="line">        <span class="built_in">this</span>.result = result;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> T <span class="title function_">call</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// å®åˆ™è°ƒç”¨ Runnable#run æ–¹æ³•</span></span><br><span class="line">        task.run();</span><br><span class="line">        <span class="comment">// è¿”å›å€¼ä¸ºæ„é€  FutureTask å¯¹è±¡æ—¶ä¼ å…¥çš„è¿”å›å€¼æˆ–è€…æ˜¯ null</span></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h5 id="æˆå‘˜å±æ€§-3"><a href="#æˆå‘˜å±æ€§-3" class="headerlink" title="æˆå‘˜å±æ€§"></a>æˆå‘˜å±æ€§</h5><p>FutureTask ç±»çš„æˆå‘˜å±æ€§ï¼š</p><ul><li><p>ä»»åŠ¡çŠ¶æ€ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¡¨ç¤ºå½“å‰taskçŠ¶æ€</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">int</span> state;</span><br><span class="line"><span class="comment">// å½“å‰ä»»åŠ¡å°šæœªæ‰§è¡Œ</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">NEW</span>          <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"><span class="comment">// å½“å‰ä»»åŠ¡æ­£åœ¨ç»“æŸï¼Œå°šæœªå®Œå…¨ç»“æŸï¼Œä¸€ç§ä¸´ç•ŒçŠ¶æ€</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">COMPLETING</span>   <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="comment">// å½“å‰ä»»åŠ¡æ­£å¸¸ç»“æŸ</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">NORMAL</span>       <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line"><span class="comment">// å½“å‰ä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿäº†å¼‚å¸¸ï¼Œå†…éƒ¨å°è£…çš„ callable.run() å‘ä¸ŠæŠ›å‡ºå¼‚å¸¸äº†</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">EXCEPTIONAL</span>  <span class="operator">=</span> <span class="number">3</span>;</span><br><span class="line"><span class="comment">// å½“å‰ä»»åŠ¡è¢«å–æ¶ˆ</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">CANCELLED</span>    <span class="operator">=</span> <span class="number">4</span>;</span><br><span class="line"><span class="comment">// å½“å‰ä»»åŠ¡ä¸­æ–­ä¸­</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">INTERRUPTING</span> <span class="operator">=</span> <span class="number">5</span>;</span><br><span class="line"><span class="comment">// å½“å‰ä»»åŠ¡å·²ä¸­æ–­</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">INTERRUPTED</span>  <span class="operator">=</span> <span class="number">6</span>;</span><br></pre></td></tr></table></figure></li><li><p>ä»»åŠ¡å¯¹è±¡ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Callable&lt;V&gt; callable;<span class="comment">// Runnable ä½¿ç”¨è£…é¥°è€…æ¨¡å¼ä¼ªè£…æˆ Callable</span></span><br></pre></td></tr></table></figure></li><li><p><strong>å­˜å‚¨ä»»åŠ¡æ‰§è¡Œçš„ç»“æœ</strong>ï¼Œè¿™æ˜¯ run æ–¹æ³•è¿”å›å€¼æ˜¯ void ä¹Ÿå¯ä»¥è·å–åˆ°æ‰§è¡Œç»“æœçš„åŸå› ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ­£å¸¸æƒ…å†µä¸‹ï¼šä»»åŠ¡æ­£å¸¸æ‰§è¡Œç»“æŸï¼Œoutcome ä¿å­˜æ‰§è¡Œç»“æœï¼Œcallable è¿”å›å€¼</span></span><br><span class="line"><span class="comment">// éæ­£å¸¸æƒ…å†µï¼šcallable å‘ä¸ŠæŠ›å‡ºå¼‚å¸¸ï¼Œoutcome ä¿å­˜å¼‚å¸¸</span></span><br><span class="line"><span class="keyword">private</span> Object outcome; </span><br></pre></td></tr></table></figure></li><li><p>æ‰§è¡Œå½“å‰ä»»åŠ¡çš„çº¿ç¨‹å¯¹è±¡ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> Thread runner;<span class="comment">// å½“å‰ä»»åŠ¡è¢«çº¿ç¨‹æ‰§è¡ŒæœŸé—´ï¼Œä¿å­˜å½“å‰æ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹å¯¹è±¡å¼•ç”¨</span></span><br></pre></td></tr></table></figure></li><li><p><strong>çº¿ç¨‹é˜»å¡é˜Ÿåˆ—çš„å¤´èŠ‚ç‚¹</strong>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¼šæœ‰å¾ˆå¤šçº¿ç¨‹å» get å½“å‰ä»»åŠ¡çš„ç»“æœï¼Œè¿™é‡Œä½¿ç”¨äº†ä¸€ç§æ•°æ®ç»“æ„å¤´æ’å¤´å–ï¼ˆç±»ä¼¼æ ˆï¼‰çš„ä¸€ä¸ªé˜Ÿåˆ—æ¥ä¿å­˜æ‰€æœ‰çš„ get çº¿ç¨‹</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> WaitNode waiters;</span><br></pre></td></tr></table></figure></li><li><p>å†…éƒ¨ç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">WaitNode</span> &#123;</span><br><span class="line">    <span class="comment">// å•å‘é“¾è¡¨</span></span><br><span class="line">    <span class="keyword">volatile</span> Thread thread;</span><br><span class="line">    <span class="keyword">volatile</span> WaitNode next;</span><br><span class="line">    WaitNode() &#123; thread = Thread.currentThread(); &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><hr><h5 id="æˆå‘˜æ–¹æ³•-3"><a href="#æˆå‘˜æ–¹æ³•-3" class="headerlink" title="æˆå‘˜æ–¹æ³•"></a>æˆå‘˜æ–¹æ³•</h5><p>FutureTask ç±»çš„æˆå‘˜æ–¹æ³•ï¼š</p><ul><li><p><strong>FutureTask#run</strong>ï¼šä»»åŠ¡æ‰§è¡Œå…¥å£</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">//æ¡ä»¶ä¸€ï¼šæˆç«‹è¯´æ˜å½“å‰ task å·²ç»è¢«æ‰§è¡Œè¿‡äº†æˆ–è€…è¢« cancel äº†ï¼Œé NEW çŠ¶æ€çš„ä»»åŠ¡ï¼Œçº¿ç¨‹å°±ä¸éœ€è¦å¤„ç†äº†</span></span><br><span class="line">    <span class="comment">//æ¡ä»¶äºŒï¼šçº¿ç¨‹æ˜¯ NEW çŠ¶æ€ï¼Œå°è¯•è®¾ç½®å½“å‰ä»»åŠ¡å¯¹è±¡çš„çº¿ç¨‹æ˜¯å½“å‰çº¿ç¨‹ï¼Œè®¾ç½®å¤±è´¥è¯´æ˜å…¶ä»–çº¿ç¨‹æŠ¢å äº†è¯¥ä»»åŠ¡ï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">    <span class="keyword">if</span> (state != NEW ||</span><br><span class="line">        !UNSAFE.compareAndSwapObject(<span class="built_in">this</span>, runnerOffset, <span class="literal">null</span>, Thread.currentThread()))</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// æ‰§è¡Œåˆ°è¿™é‡Œï¼Œå½“å‰ task ä¸€å®šæ˜¯ NEW çŠ¶æ€ï¼Œè€Œä¸”ã€å½“å‰çº¿ç¨‹ä¹ŸæŠ¢å  task æˆåŠŸã€‘</span></span><br><span class="line">        Callable&lt;V&gt; c = callable;</span><br><span class="line">        <span class="comment">// åˆ¤æ–­ä»»åŠ¡æ˜¯å¦ä¸ºç©ºï¼Œé˜²æ­¢ç©ºæŒ‡é’ˆå¼‚å¸¸ï¼›åˆ¤æ–­ state çŠ¶æ€ï¼Œé˜²æ­¢å¤–éƒ¨çº¿ç¨‹åœ¨æ­¤æœŸé—´ cancel æ‰å½“å‰ä»»åŠ¡</span></span><br><span class="line">        <span class="comment">// ã€å› ä¸º task çš„æ‰§è¡Œè€…å·²ç»è®¾ç½®ä¸ºå½“å‰çº¿ç¨‹ï¼Œæ‰€ä»¥è¿™é‡Œæ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‘</span></span><br><span class="line">        <span class="keyword">if</span> (c != <span class="literal">null</span> &amp;&amp; state == NEW) &#123;</span><br><span class="line">            V result;</span><br><span class="line">            <span class="comment">// true è¡¨ç¤º callable.run ä»£ç å—æ‰§è¡ŒæˆåŠŸ æœªæŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">            <span class="comment">// false è¡¨ç¤º callable.run ä»£ç å—æ‰§è¡Œå¤±è´¥ æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">            <span class="type">boolean</span> ran;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line"><span class="comment">// ã€è°ƒç”¨è‡ªå®šä¹‰çš„æ–¹æ³•ï¼Œæ‰§è¡Œç»“æœèµ‹å€¼ç»™ resultã€‘</span></span><br><span class="line">                result = c.call();</span><br><span class="line">                <span class="comment">// æ²¡æœ‰å‡ºç°å¼‚å¸¸</span></span><br><span class="line">                ran = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">                <span class="comment">// å‡ºç°å¼‚å¸¸ï¼Œè¿”å›å€¼ç½®ç©ºï¼Œran ç½®ä¸º false</span></span><br><span class="line">                result = <span class="literal">null</span>;</span><br><span class="line">                ran = <span class="literal">false</span>;</span><br><span class="line">                <span class="comment">// è®¾ç½®è¿”å›çš„å¼‚å¸¸</span></span><br><span class="line">                setException(ex);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// ä»£ç å—æ‰§è¡Œæ­£å¸¸</span></span><br><span class="line">            <span class="keyword">if</span> (ran)</span><br><span class="line">                <span class="comment">// è®¾ç½®è¿”å›çš„ç»“æœ</span></span><br><span class="line">                set(result);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// ä»»åŠ¡æ‰§è¡Œå®Œæˆï¼Œå–æ¶ˆçº¿ç¨‹çš„å¼•ç”¨ï¼Œhelp GC</span></span><br><span class="line">        runner = <span class="literal">null</span>;</span><br><span class="line">        <span class="type">int</span> <span class="variable">s</span> <span class="operator">=</span> state;</span><br><span class="line">        <span class="comment">// åˆ¤æ–­ä»»åŠ¡æ˜¯ä¸æ˜¯è¢«ä¸­æ–­</span></span><br><span class="line">        <span class="keyword">if</span> (s &gt;= INTERRUPTING)</span><br><span class="line">            <span class="comment">// æ‰§è¡Œä¸­æ–­å¤„ç†æ–¹æ³•</span></span><br><span class="line">            handlePossibleCancellationInterrupt(s);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>FutureTask#setï¼šè®¾ç½®æ­£å¸¸è¿”å›å€¼ï¼Œé¦–å…ˆå°†ä»»åŠ¡çŠ¶æ€è®¾ç½®ä¸º COMPLETING çŠ¶æ€ä»£è¡¨å®Œæˆä¸­ï¼Œé€»è¾‘æ‰§è¡Œå®Œè®¾ç½®ä¸º NORMAL çŠ¶æ€ä»£è¡¨ä»»åŠ¡æ­£å¸¸æ‰§è¡Œå®Œæˆï¼Œæœ€åå”¤é†’ get() é˜»å¡çº¿ç¨‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">set</span><span class="params">(V v)</span> &#123;</span><br><span class="line">    <span class="comment">// CAS æ–¹å¼è®¾ç½®å½“å‰ä»»åŠ¡çŠ¶æ€ä¸ºå®Œæˆä¸­ï¼Œè®¾ç½®å¤±è´¥è¯´æ˜å…¶ä»–çº¿ç¨‹å–æ¶ˆäº†è¯¥ä»»åŠ¡</span></span><br><span class="line">    <span class="keyword">if</span> (UNSAFE.compareAndSwapInt(<span class="built_in">this</span>, stateOffset, NEW, COMPLETING)) &#123;</span><br><span class="line">        <span class="comment">// ã€å°†ç»“æœèµ‹å€¼ç»™ outcomeã€‘</span></span><br><span class="line">        outcome = v;</span><br><span class="line">        <span class="comment">// å°†å½“å‰ä»»åŠ¡çŠ¶æ€ä¿®æ”¹ä¸º NORMAL æ­£å¸¸ç»“æŸçŠ¶æ€ã€‚</span></span><br><span class="line">        UNSAFE.putOrderedInt(<span class="built_in">this</span>, stateOffset, NORMAL);</span><br><span class="line">        finishCompletion();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>FutureTask#setExceptionï¼šè®¾ç½®å¼‚å¸¸è¿”å›å€¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">setException</span><span class="params">(Throwable t)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (UNSAFE.compareAndSwapInt(<span class="built_in">this</span>, stateOffset, NEW, COMPLETING)) &#123;</span><br><span class="line">        <span class="comment">// èµ‹å€¼ç»™è¿”å›ç»“æœï¼Œç”¨æ¥å‘ä¸Šå±‚æŠ›å‡ºæ¥çš„å¼‚å¸¸</span></span><br><span class="line">        outcome = t;</span><br><span class="line">        <span class="comment">// å°†å½“å‰ä»»åŠ¡çš„çŠ¶æ€ ä¿®æ”¹ä¸º EXCEPTIONAL</span></span><br><span class="line">        UNSAFE.putOrderedInt(<span class="built_in">this</span>, stateOffset, EXCEPTIONAL);</span><br><span class="line">        finishCompletion();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>FutureTask#finishCompletionï¼š<strong>å”¤é†’ get() é˜»å¡çº¿ç¨‹</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">finishCompletion</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// éå†æ‰€æœ‰çš„ç­‰å¾…çš„èŠ‚ç‚¹ï¼Œq æŒ‡å‘å¤´èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">for</span> (WaitNode q; (q = waiters) != <span class="literal">null</span>;) &#123;</span><br><span class="line">        <span class="comment">// ä½¿ç”¨casè®¾ç½® waiters ä¸º nullï¼Œé˜²æ­¢å¤–éƒ¨çº¿ç¨‹ä½¿ç”¨cancelå–æ¶ˆå½“å‰ä»»åŠ¡ï¼Œè§¦å‘finishCompletionæ–¹æ³•é‡å¤æ‰§è¡Œ</span></span><br><span class="line">        <span class="keyword">if</span> (UNSAFE.compareAndSwapObject(<span class="built_in">this</span>, waitersOffset, q, <span class="literal">null</span>)) &#123;</span><br><span class="line">            <span class="comment">// è‡ªæ—‹</span></span><br><span class="line">            <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">                <span class="comment">// è·å–å½“å‰ WaitNode èŠ‚ç‚¹å°è£…çš„ thread</span></span><br><span class="line">                <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> q.thread;</span><br><span class="line">                <span class="comment">// å½“å‰çº¿ç¨‹ä¸ä¸º nullï¼Œå”¤é†’å½“å‰ get() ç­‰å¾…è·å–æ•°æ®çš„çº¿ç¨‹</span></span><br><span class="line">                <span class="keyword">if</span> (t != <span class="literal">null</span>) &#123;</span><br><span class="line">                    q.thread = <span class="literal">null</span>;</span><br><span class="line">                    LockSupport.unpark(t);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// è·å–å½“å‰èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">                <span class="type">WaitNode</span> <span class="variable">next</span> <span class="operator">=</span> q.next;</span><br><span class="line">                <span class="comment">// å½“å‰èŠ‚ç‚¹æ˜¯æœ€åä¸€ä¸ªèŠ‚ç‚¹äº†</span></span><br><span class="line">                <span class="keyword">if</span> (next == <span class="literal">null</span>)</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="comment">// æ–­å¼€é“¾è¡¨</span></span><br><span class="line">                q.next = <span class="literal">null</span>; <span class="comment">// help gc</span></span><br><span class="line">                q = next;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    done();</span><br><span class="line">    callable = <span class="literal">null</span>;<span class="comment">// help GC</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>FutureTask#handlePossibleCancellationInterruptï¼šä»»åŠ¡ä¸­æ–­å¤„ç†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">handlePossibleCancellationInterrupt</span><span class="params">(<span class="type">int</span> s)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (s == INTERRUPTING)</span><br><span class="line">        <span class="comment">// ä¸­æ–­çŠ¶æ€ä¸­</span></span><br><span class="line">        <span class="keyword">while</span> (state == INTERRUPTING)</span><br><span class="line">            <span class="comment">// ç­‰å¾…ä¸­æ–­å®Œæˆ</span></span><br><span class="line">            Thread.yield();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p><strong>FutureTask#get</strong>ï¼šè·å–ä»»åŠ¡æ‰§è¡Œçš„è¿”å›å€¼ï¼Œæ‰§è¡Œ run å’Œ get çš„ä¸æ˜¯åŒä¸€ä¸ªçº¿ç¨‹ï¼Œä¸€èˆ¬æœ‰å¤šä¸ªçº¿ç¨‹ getï¼Œåªæœ‰ä¸€ä¸ªçº¿ç¨‹ run</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> V <span class="title function_">get</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException, ExecutionException &#123;</span><br><span class="line">    <span class="comment">// è·å–å½“å‰ä»»åŠ¡çŠ¶æ€</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">s</span> <span class="operator">=</span> state;</span><br><span class="line">    <span class="comment">// æ¡ä»¶æˆç«‹è¯´æ˜ä»»åŠ¡è¿˜æ²¡æ‰§è¡Œå®Œæˆ</span></span><br><span class="line">    <span class="keyword">if</span> (s &lt;= COMPLETING)</span><br><span class="line">        <span class="comment">// è¿”å› task å½“å‰çŠ¶æ€ï¼Œå¯èƒ½å½“å‰çº¿ç¨‹åœ¨é‡Œé¢å·²ç»ç¡äº†ä¸€ä¼š</span></span><br><span class="line">        s = awaitDone(<span class="literal">false</span>, <span class="number">0L</span>);</span><br><span class="line">    <span class="keyword">return</span> report(s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>FutureTask#awaitDoneï¼š<strong>get çº¿ç¨‹å°è£…æˆ WaitNode å¯¹è±¡è¿›å…¥é˜»å¡é˜Ÿåˆ—é˜»å¡ç­‰å¾…</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">int</span> <span class="title function_">awaitDone</span><span class="params">(<span class="type">boolean</span> timed, <span class="type">long</span> nanos)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="comment">// 0 ä¸å¸¦è¶…æ—¶</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">long</span> <span class="variable">deadline</span> <span class="operator">=</span> timed ? System.nanoTime() + nanos : <span class="number">0L</span>;</span><br><span class="line">    <span class="comment">// å¼•ç”¨å½“å‰çº¿ç¨‹ï¼Œå°è£…æˆ WaitNode å¯¹è±¡</span></span><br><span class="line">    <span class="type">WaitNode</span> <span class="variable">q</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">// è¡¨ç¤ºå½“å‰çº¿ç¨‹ waitNode å¯¹è±¡ï¼Œæ˜¯å¦è¿›å…¥é˜»å¡é˜Ÿåˆ—</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">queued</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">// ã€ä¸‰æ¬¡è‡ªæ—‹å¼€å§‹ä¼‘çœ ã€‘</span></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="comment">// åˆ¤æ–­å½“å‰ get() çº¿ç¨‹æ˜¯å¦è¢«æ‰“æ–­ï¼Œæ‰“æ–­è¿”å› trueï¼Œæ¸…é™¤æ‰“æ–­æ ‡è®°</span></span><br><span class="line">        <span class="keyword">if</span> (Thread.interrupted()) &#123;</span><br><span class="line">            <span class="comment">// å½“å‰çº¿ç¨‹å¯¹åº”çš„ç­‰å¾… node å‡ºé˜Ÿï¼Œ</span></span><br><span class="line">            removeWaiter(q);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InterruptedException</span>();</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">// è·å–ä»»åŠ¡çŠ¶æ€</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">s</span> <span class="operator">=</span> state;</span><br><span class="line">        <span class="comment">// æ¡ä»¶æˆç«‹è¯´æ˜å½“å‰ä»»åŠ¡æ‰§è¡Œå®Œæˆå·²ç»æœ‰ç»“æœäº†</span></span><br><span class="line">        <span class="keyword">if</span> (s &gt; COMPLETING) &#123;</span><br><span class="line">            <span class="comment">// æ¡ä»¶æˆç«‹è¯´æ˜å·²ç»ä¸ºå½“å‰çº¿ç¨‹åˆ›å»ºäº† WaitNodeï¼Œç½®ç©º help GC</span></span><br><span class="line">            <span class="keyword">if</span> (q != <span class="literal">null</span>)</span><br><span class="line">                q.thread = <span class="literal">null</span>;</span><br><span class="line">            <span class="comment">// è¿”å›å½“å‰çš„çŠ¶æ€</span></span><br><span class="line">            <span class="keyword">return</span> s;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æ¡ä»¶æˆç«‹è¯´æ˜å½“å‰ä»»åŠ¡æ¥è¿‘å®ŒæˆçŠ¶æ€ï¼Œè¿™é‡Œè®©å½“å‰çº¿ç¨‹é‡Šæ”¾ä¸€ä¸‹ cpu ï¼Œç­‰å¾…è¿›è¡Œä¸‹ä¸€æ¬¡æŠ¢å  cpu</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (s == COMPLETING) </span><br><span class="line">            Thread.yield();</span><br><span class="line">        <span class="comment">// ã€ç¬¬ä¸€æ¬¡è‡ªæ—‹ã€‘ï¼Œå½“å‰çº¿ç¨‹è¿˜æœªåˆ›å»º WaitNode å¯¹è±¡ï¼Œæ­¤æ—¶ä¸ºå½“å‰çº¿ç¨‹åˆ›å»º WaitNodeå¯¹è±¡</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (q == <span class="literal">null</span>)</span><br><span class="line">            q = <span class="keyword">new</span> <span class="title class_">WaitNode</span>();</span><br><span class="line">        <span class="comment">// ã€ç¬¬äºŒæ¬¡è‡ªæ—‹ã€‘ï¼Œå½“å‰çº¿ç¨‹å·²ç»åˆ›å»º WaitNode å¯¹è±¡äº†ï¼Œä½†æ˜¯nodeå¯¹è±¡è¿˜æœªå…¥é˜Ÿ</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (!queued)</span><br><span class="line">            <span class="comment">// waiters æŒ‡å‘é˜Ÿé¦–ï¼Œè®©å½“å‰ WaitNode æˆä¸ºæ–°çš„é˜Ÿé¦–ï¼Œã€å¤´æ’æ³•ã€‘ï¼Œå¤±è´¥è¯´æ˜å…¶ä»–çº¿ç¨‹ä¿®æ”¹äº†æ–°çš„é˜Ÿé¦–</span></span><br><span class="line">            queued = UNSAFE.compareAndSwapObject(<span class="built_in">this</span>, waitersOffset, q.next = waiters, q);</span><br><span class="line">        <span class="comment">// ã€ç¬¬ä¸‰æ¬¡è‡ªæ—‹ã€‘ï¼Œä¼šåˆ°è¿™é‡Œï¼Œæˆ–è€… else å†…</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (timed) &#123;</span><br><span class="line">            nanos = deadline - System.nanoTime();</span><br><span class="line">            <span class="keyword">if</span> (nanos &lt;= <span class="number">0L</span>) &#123;</span><br><span class="line">                removeWaiter(q);</span><br><span class="line">                <span class="keyword">return</span> state;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// é˜»å¡æŒ‡å®šçš„æ—¶é—´</span></span><br><span class="line">            LockSupport.parkNanos(<span class="built_in">this</span>, nanos);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æ¡ä»¶æˆç«‹ï¼šè¯´æ˜éœ€è¦é˜»å¡</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="comment">// ã€å½“å‰ get æ“ä½œçš„çº¿ç¨‹è¢« park é˜»å¡ã€‘ï¼Œé™¤éæœ‰å…¶å®ƒçº¿ç¨‹å°†å”¤é†’æˆ–è€…å°†å½“å‰çº¿ç¨‹ä¸­æ–­</span></span><br><span class="line">            LockSupport.park(<span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>FutureTask#reportï¼šå°è£…è¿è¡Œç»“æœï¼Œå¯ä»¥è·å– run() æ–¹æ³•ä¸­è®¾ç½®çš„æˆå‘˜å˜é‡ outcomeï¼Œ<strong>è¿™æ˜¯ run æ–¹æ³•çš„è¿”å›å€¼æ˜¯ void ä¹Ÿå¯ä»¥è·å–åˆ°ä»»åŠ¡æ‰§è¡Œçš„ç»“æœçš„åŸå› </strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> V <span class="title function_">report</span><span class="params">(<span class="type">int</span> s)</span> <span class="keyword">throws</span> ExecutionException &#123;</span><br><span class="line">    <span class="comment">// è·å–æ‰§è¡Œç»“æœï¼Œæ˜¯åœ¨ä¸€ä¸ª futuretask å¯¹è±¡ä¸­çš„å±æ€§ï¼Œå¯ä»¥ç›´æ¥è·å–</span></span><br><span class="line">    <span class="type">Object</span> <span class="variable">x</span> <span class="operator">=</span> outcome;</span><br><span class="line">    <span class="comment">// å½“å‰ä»»åŠ¡çŠ¶æ€æ­£å¸¸ç»“æŸ</span></span><br><span class="line">    <span class="keyword">if</span> (s == NORMAL)</span><br><span class="line">        <span class="keyword">return</span> (V)x;<span class="comment">// ç›´æ¥è¿”å› callable çš„é€»è¾‘ç»“æœ</span></span><br><span class="line">    <span class="comment">// å½“å‰ä»»åŠ¡è¢«å–æ¶ˆæˆ–è€…ä¸­æ–­</span></span><br><span class="line">    <span class="keyword">if</span> (s &gt;= CANCELLED)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">CancellationException</span>();<span class="comment">// æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">    <span class="comment">// æ‰§è¡Œåˆ°è¿™é‡Œè¯´æ˜è‡ªå®šä¹‰çš„ callable ä¸­çš„æ–¹æ³•æœ‰å¼‚å¸¸ï¼Œä½¿ç”¨ outcome ä¸Šå±‚æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">ExecutionException</span>((Throwable)x);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>FutureTask#cancelï¼šä»»åŠ¡å–æ¶ˆï¼Œæ‰“æ–­æ­£åœ¨æ‰§è¡Œè¯¥ä»»åŠ¡çš„çº¿ç¨‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">cancel</span><span class="params">(<span class="type">boolean</span> mayInterruptIfRunning)</span> &#123;</span><br><span class="line">    <span class="comment">// æ¡ä»¶ä¸€ï¼šè¡¨ç¤ºå½“å‰ä»»åŠ¡å¤„äºè¿è¡Œä¸­æˆ–è€…å¤„äºçº¿ç¨‹æ± ä»»åŠ¡é˜Ÿåˆ—ä¸­</span></span><br><span class="line">    <span class="comment">// æ¡ä»¶äºŒï¼šè¡¨ç¤ºä¿®æ”¹çŠ¶æ€ï¼ŒæˆåŠŸå¯ä»¥å»æ‰§è¡Œä¸‹é¢é€»è¾‘ï¼Œå¦åˆ™è¿”å› false è¡¨ç¤º cancel å¤±è´¥</span></span><br><span class="line">    <span class="keyword">if</span> (!(state == NEW &amp;&amp;</span><br><span class="line">          UNSAFE.compareAndSwapInt(<span class="built_in">this</span>, stateOffset, NEW,</span><br><span class="line">                                   mayInterruptIfRunning ? INTERRUPTING : CANCELLED)))</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœä»»åŠ¡å·²ç»è¢«æ‰§è¡Œï¼Œæ˜¯å¦å…è®¸æ‰“æ–­</span></span><br><span class="line">        <span class="keyword">if</span> (mayInterruptIfRunning) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// è·å–æ‰§è¡Œå½“å‰ FutureTask çš„çº¿ç¨‹</span></span><br><span class="line">                <span class="type">Thread</span> <span class="variable">t</span> <span class="operator">=</span> runner;</span><br><span class="line">                <span class="keyword">if</span> (t != <span class="literal">null</span>)</span><br><span class="line">                    <span class="comment">// æ‰“æ–­æ‰§è¡Œçš„çº¿ç¨‹</span></span><br><span class="line">                    t.interrupt();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="comment">// è®¾ç½®ä»»åŠ¡çŠ¶æ€ä¸ºã€ä¸­æ–­å®Œæˆã€‘</span></span><br><span class="line">                UNSAFE.putOrderedInt(<span class="built_in">this</span>, stateOffset, INTERRUPTED);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// å”¤é†’æ‰€æœ‰ get() é˜»å¡çš„çº¿ç¨‹</span></span><br><span class="line">        finishCompletion();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><hr><h3 id="ä»»åŠ¡è°ƒåº¦"><a href="#ä»»åŠ¡è°ƒåº¦" class="headerlink" title="ä»»åŠ¡è°ƒåº¦"></a>ä»»åŠ¡è°ƒåº¦</h3><h4 id="Timer"><a href="#Timer" class="headerlink" title="Timer"></a>Timer</h4><p>Timer å®ç°å®šæ—¶åŠŸèƒ½ï¼ŒTimer çš„ä¼˜ç‚¹åœ¨äºç®€å•æ˜“ç”¨ï¼Œä½†ç”±äºæ‰€æœ‰ä»»åŠ¡éƒ½æ˜¯ç”±åŒä¸€ä¸ªçº¿ç¨‹æ¥è°ƒåº¦ï¼Œå› æ­¤æ‰€æœ‰ä»»åŠ¡éƒ½æ˜¯ä¸²è¡Œæ‰§è¡Œçš„ï¼ŒåŒä¸€æ—¶é—´åªèƒ½æœ‰ä¸€ä¸ªä»»åŠ¡åœ¨æ‰§è¡Œï¼Œå‰ä¸€ä¸ªä»»åŠ¡çš„å»¶è¿Ÿæˆ–å¼‚å¸¸éƒ½å°†ä¼šå½±å“åˆ°ä¹‹åçš„ä»»åŠ¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">method1</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Timer</span> <span class="variable">timer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Timer</span>();</span><br><span class="line">    <span class="type">TimerTask</span> <span class="variable">task1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TimerTask</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;task 1&quot;</span>);</span><br><span class="line">            <span class="comment">//int i = 1 / 0;//ä»»åŠ¡ä¸€çš„å‡ºé”™ä¼šå¯¼è‡´ä»»åŠ¡äºŒæ— æ³•æ‰§è¡Œ</span></span><br><span class="line">            Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="type">TimerTask</span> <span class="variable">task2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TimerTask</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;task 2&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// ä½¿ç”¨ timer æ·»åŠ ä¸¤ä¸ªä»»åŠ¡ï¼Œå¸Œæœ›å®ƒä»¬éƒ½åœ¨ 1s åæ‰§è¡Œ</span></span><br><span class="line"><span class="comment">// ä½†ç”±äº timer å†…åªæœ‰ä¸€ä¸ªçº¿ç¨‹æ¥é¡ºåºæ‰§è¡Œé˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼Œå› æ­¤ä»»åŠ¡1çš„å»¶æ—¶ï¼Œå½±å“äº†ä»»åŠ¡2çš„æ‰§è¡Œ</span></span><br><span class="line">    timer.schedule(task1, <span class="number">1000</span>);<span class="comment">//17:45:56 c.ThreadPool [Timer-0] - task 1</span></span><br><span class="line">    timer.schedule(task2, <span class="number">1000</span>);<span class="comment">//17:45:58 c.ThreadPool [Timer-0] - task 2</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h4 id="Scheduled"><a href="#Scheduled" class="headerlink" title="Scheduled"></a>Scheduled</h4><p>ä»»åŠ¡è°ƒåº¦çº¿ç¨‹æ±  ScheduledThreadPoolExecutor ç»§æ‰¿ ThreadPoolExecutorï¼š</p><ul><li>ä½¿ç”¨å†…éƒ¨ç±» ScheduledFutureTask å°è£…ä»»åŠ¡</li><li>ä½¿ç”¨å†…éƒ¨ç±» DelayedWorkQueue ä½œä¸ºçº¿ç¨‹æ± é˜Ÿåˆ—</li><li>é‡å†™ onShutdown æ–¹æ³•å»å¤„ç† shutdown åçš„ä»»åŠ¡</li><li>æä¾› decorateTask æ–¹æ³•ä½œä¸º ScheduledFutureTask çš„ä¿®é¥°æ–¹æ³•ï¼Œä»¥ä¾¿å¼€å‘è€…è¿›è¡Œæ‰©å±•</li></ul><p>æ„é€ æ–¹æ³•ï¼š<code>Executors.newScheduledThreadPool(int corePoolSize)</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ScheduledThreadPoolExecutor</span><span class="params">(<span class="type">int</span> corePoolSize)</span> &#123;</span><br><span class="line">    <span class="comment">// æœ€å¤§çº¿ç¨‹æ•°å›ºå®šä¸º Integer.MAX_VALUEï¼Œä¿æ´»æ—¶é—´ keepAliveTime å›ºå®šä¸º 0</span></span><br><span class="line">    <span class="built_in">super</span>(corePoolSize, Integer.MAX_VALUE, <span class="number">0</span>, NANOSECONDS,</span><br><span class="line">          <span class="comment">// é˜»å¡é˜Ÿåˆ—æ˜¯ DelayedWorkQueue</span></span><br><span class="line">          <span class="keyword">new</span> <span class="title class_">DelayedWorkQueue</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¸¸ç”¨ APIï¼š</p><ul><li><code>ScheduledFuture&lt;?&gt; schedule(Runnable/Callable&lt;V&gt;, long delay, TimeUnit u)</code>ï¼šå»¶è¿Ÿæ‰§è¡Œä»»åŠ¡</li><li><code>ScheduledFuture&lt;?&gt; scheduleAtFixedRate(Runnable/Callable&lt;V&gt;, long initialDelay, long period, TimeUnit unit)</code>ï¼šå®šæ—¶æ‰§è¡Œå‘¨æœŸä»»åŠ¡ï¼Œä¸è€ƒè™‘æ‰§è¡Œçš„è€—æ—¶ï¼Œå‚æ•°ä¸ºåˆå§‹å»¶è¿Ÿæ—¶é—´ã€é—´éš”æ—¶é—´ã€å•ä½</li><li><code>ScheduledFuture&lt;?&gt; scheduleWithFixedDelay(Runnable/Callable&lt;V&gt;, long initialDelay, long delay, TimeUnit unit)</code>ï¼šå®šæ—¶æ‰§è¡Œå‘¨æœŸä»»åŠ¡ï¼Œè€ƒè™‘æ‰§è¡Œçš„è€—æ—¶ï¼Œå‚æ•°ä¸ºåˆå§‹å»¶è¿Ÿæ—¶é—´ã€é—´éš”æ—¶é—´ã€å•ä½</li></ul><p>åŸºæœ¬ä½¿ç”¨ï¼š</p><ul><li><p>å»¶è¿Ÿä»»åŠ¡ï¼Œä½†æ˜¯å‡ºç°å¼‚å¸¸å¹¶ä¸ä¼šåœ¨æ§åˆ¶å°æ‰“å°ï¼Œä¹Ÿä¸ä¼šå½±å“å…¶ä»–çº¿ç¨‹çš„æ‰§è¡Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;</span><br><span class="line">    <span class="comment">// çº¿ç¨‹æ± å¤§å°ä¸º1æ—¶ä¹Ÿæ˜¯ä¸²è¡Œæ‰§è¡Œ</span></span><br><span class="line">    <span class="type">ScheduledExecutorService</span> <span class="variable">executor</span> <span class="operator">=</span> Executors.newScheduledThreadPool(<span class="number">2</span>);</span><br><span class="line">    <span class="comment">// æ·»åŠ ä¸¤ä¸ªä»»åŠ¡ï¼Œéƒ½åœ¨ 1s ååŒæ—¶æ‰§è¡Œ</span></span><br><span class="line">    executor.schedule(() -&gt; &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;ä»»åŠ¡1ï¼Œæ‰§è¡Œæ—¶é—´ï¼š&quot;</span> + <span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">        <span class="comment">//int i = 1 / 0;</span></span><br><span class="line">    <span class="keyword">try</span> &#123; Thread.sleep(<span class="number">2000</span>); &#125; <span class="keyword">catch</span> (InterruptedException e) &#123; &#125;</span><br><span class="line">    &#125;, <span class="number">1000</span>, TimeUnit.MILLISECONDS);</span><br><span class="line">    </span><br><span class="line">    executor.schedule(() -&gt; &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;ä»»åŠ¡2ï¼Œæ‰§è¡Œæ—¶é—´ï¼š&quot;</span> + <span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">    &#125;, <span class="number">1000</span>, TimeUnit.MILLISECONDS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>å®šæ—¶ä»»åŠ¡ scheduleAtFixedRateï¼š<strong>ä¸€æ¬¡ä»»åŠ¡çš„å¯åŠ¨åˆ°ä¸‹ä¸€æ¬¡ä»»åŠ¡çš„å¯åŠ¨</strong>ä¹‹é—´åªè¦å¤§äºç­‰äºé—´éš”æ—¶é—´ï¼ŒæŠ¢å åˆ° CPU å°±ä¼šç«‹å³æ‰§è¡Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">ScheduledExecutorService</span> <span class="variable">pool</span> <span class="operator">=</span> Executors.newScheduledThreadPool(<span class="number">1</span>);</span><br><span class="line">    System.out.println(<span class="string">&quot;start...&quot;</span> + <span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">    </span><br><span class="line">    pool.scheduleAtFixedRate(() -&gt; &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;running...&quot;</span> + <span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">        Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">    &#125;, <span class="number">1</span>, <span class="number">1</span>, TimeUnit.SECONDS);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*start...Sat Apr 24 18:08:12 CST 2021</span></span><br><span class="line"><span class="comment">running...Sat Apr 24 18:08:13 CST 2021</span></span><br><span class="line"><span class="comment">running...Sat Apr 24 18:08:15 CST 2021</span></span><br><span class="line"><span class="comment">running...Sat Apr 24 18:08:17 CST 2021</span></span><br></pre></td></tr></table></figure></li><li><p>å®šæ—¶ä»»åŠ¡ scheduleWithFixedDelayï¼š<strong>ä¸€æ¬¡ä»»åŠ¡çš„ç»“æŸåˆ°ä¸‹ä¸€æ¬¡ä»»åŠ¡çš„å¯åŠ¨ä¹‹é—´</strong>ç­‰äºé—´éš”æ—¶é—´ï¼ŒæŠ¢å åˆ° CPU å°±ä¼šç«‹å³æ‰§è¡Œï¼Œè¿™ä¸ªæ–¹æ³•æ‰æ˜¯çœŸæ­£çš„è®¾ç½®ä¸¤ä¸ªä»»åŠ¡ä¹‹é—´çš„é—´éš”</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;</span><br><span class="line">    <span class="type">ScheduledExecutorService</span> <span class="variable">pool</span> <span class="operator">=</span> Executors.newScheduledThreadPool(<span class="number">3</span>);</span><br><span class="line">    System.out.println(<span class="string">&quot;start...&quot;</span> + <span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">    </span><br><span class="line">    pool.scheduleWithFixedDelay(() -&gt; &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;running...&quot;</span> + <span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">        Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">    &#125;, <span class="number">1</span>, <span class="number">1</span>, TimeUnit.SECONDS);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*start...Sat Apr 24 18:11:41 CST 2021</span></span><br><span class="line"><span class="comment">running...Sat Apr 24 18:11:42 CST 2021</span></span><br><span class="line"><span class="comment">running...Sat Apr 24 18:11:45 CST 2021</span></span><br><span class="line"><span class="comment">running...Sat Apr 24 18:11:48 CST 2021</span></span><br></pre></td></tr></table></figure></li></ul><hr><h4 id="æˆå‘˜å±æ€§-4"><a href="#æˆå‘˜å±æ€§-4" class="headerlink" title="æˆå‘˜å±æ€§"></a>æˆå‘˜å±æ€§</h4><h5 id="æˆå‘˜å˜é‡-1"><a href="#æˆå‘˜å˜é‡-1" class="headerlink" title="æˆå‘˜å˜é‡"></a>æˆå‘˜å˜é‡</h5><ul><li><p>shutdown åæ˜¯å¦ç»§ç»­æ‰§è¡Œå‘¨æœŸä»»åŠ¡ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">boolean</span> continueExistingPeriodicTasksAfterShutdown;</span><br></pre></td></tr></table></figure></li><li><p>shutdown åæ˜¯å¦ç»§ç»­æ‰§è¡Œå»¶è¿Ÿä»»åŠ¡ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">boolean</span> <span class="variable">executeExistingDelayedTasksAfterShutdown</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br></pre></td></tr></table></figure></li><li><p>å–æ¶ˆæ–¹æ³•æ˜¯å¦å°†è¯¥ä»»åŠ¡ä»é˜Ÿåˆ—ä¸­ç§»é™¤ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é»˜è®¤ falseï¼Œä¸ç§»é™¤ï¼Œç­‰åˆ°çº¿ç¨‹æ‹¿åˆ°ä»»åŠ¡ä¹‹åæŠ›å¼ƒ</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">boolean</span> <span class="variable">removeOnCancel</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br></pre></td></tr></table></figure></li><li><p>ä»»åŠ¡çš„åºåˆ—å·ï¼Œå¯ä»¥ç”¨æ¥æ¯”è¾ƒä¼˜å…ˆçº§ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">AtomicLong</span> <span class="variable">sequencer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicLong</span>();</span><br></pre></td></tr></table></figure></li></ul><hr><h5 id="å»¶è¿Ÿä»»åŠ¡"><a href="#å»¶è¿Ÿä»»åŠ¡" class="headerlink" title="å»¶è¿Ÿä»»åŠ¡"></a>å»¶è¿Ÿä»»åŠ¡</h5><p>ScheduledFutureTask ç»§æ‰¿ FutureTaskï¼Œå®ç° RunnableScheduledFuture æ¥å£ï¼Œå…·æœ‰å»¶è¿Ÿæ‰§è¡Œçš„ç‰¹ç‚¹ï¼Œè¦†ç›– FutureTask çš„ run æ–¹æ³•æ¥å®ç°å¯¹<strong>å»¶æ—¶æ‰§è¡Œã€å‘¨æœŸæ‰§è¡Œ</strong>çš„æ”¯æŒã€‚å¯¹äºå»¶æ—¶ä»»åŠ¡è°ƒç”¨ FutureTask#runï¼Œè€Œå¯¹äºå‘¨æœŸæ€§ä»»åŠ¡åˆ™è°ƒç”¨ FutureTask#runAndReset å¹¶ä¸”åœ¨æˆåŠŸä¹‹åæ ¹æ® fixed-delay&#x2F;fixed-rate æ¨¡å¼æ¥è®¾ç½®ä¸‹æ¬¡æ‰§è¡Œæ—¶é—´å¹¶é‡æ–°å°†ä»»åŠ¡å¡åˆ°å·¥ä½œé˜Ÿåˆ—</p><p>åœ¨è°ƒåº¦çº¿ç¨‹æ± ä¸­æ— è®ºæ˜¯ runnable è¿˜æ˜¯ callableï¼Œæ— è®ºæ˜¯å¦éœ€è¦å»¶è¿Ÿå’Œå®šæ—¶ï¼Œæ‰€æœ‰çš„ä»»åŠ¡éƒ½ä¼šè¢«å°è£…æˆ ScheduledFutureTask</p><p>æˆå‘˜å˜é‡ï¼š</p><ul><li><p>ä»»åŠ¡åºåˆ—å·ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">long</span> sequenceNumber;</span><br></pre></td></tr></table></figure></li><li><p>æ‰§è¡Œæ—¶é—´ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">long</span> time;<span class="comment">// ä»»åŠ¡å¯ä»¥è¢«æ‰§è¡Œçš„æ—¶é—´ï¼Œäº¤ä»˜æ—¶é—´ï¼Œä»¥çº³ç§’è¡¨ç¤º</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">long</span> period;<span class="comment">// 0 è¡¨ç¤ºéå‘¨æœŸä»»åŠ¡ï¼Œæ­£æ•°è¡¨ç¤º fixed-rate æ¨¡å¼çš„å‘¨æœŸï¼Œè´Ÿæ•°è¡¨ç¤º fixed-delay æ¨¡å¼</span></span><br></pre></td></tr></table></figure><p>fixed-rateï¼šä¸¤æ¬¡å¼€å§‹å¯åŠ¨çš„é—´éš”ï¼Œfixed-delayï¼šä¸€æ¬¡æ‰§è¡Œç»“æŸåˆ°ä¸‹ä¸€æ¬¡å¼€å§‹å¯åŠ¨</p></li><li><p>å®é™…çš„ä»»åŠ¡å¯¹è±¡ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">RunnableScheduledFuture&lt;V&gt; outerTask = <span class="built_in">this</span>;</span><br></pre></td></tr></table></figure></li><li><p>ä»»åŠ¡åœ¨é˜Ÿåˆ—æ•°ç»„ä¸­çš„ç´¢å¼•ä¸‹æ ‡ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// DelayedWorkQueue åº•å±‚ä½¿ç”¨çš„æ•°æ®ç»“æ„æ˜¯æœ€å°å †ï¼Œè®°å½•å½“å‰ä»»åŠ¡åœ¨å †ä¸­çš„ç´¢å¼•ï¼Œ-1 ä»£è¡¨åˆ é™¤</span></span><br><span class="line"><span class="type">int</span> heapIndex;</span><br></pre></td></tr></table></figure></li></ul><p>æˆå‘˜æ–¹æ³•ï¼š</p><ul><li><p>æ„é€ æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ScheduledFutureTask(Runnable r, V result, <span class="type">long</span> ns, <span class="type">long</span> period) &#123;</span><br><span class="line">    <span class="built_in">super</span>(r, result);</span><br><span class="line">    <span class="comment">// ä»»åŠ¡çš„è§¦å‘æ—¶é—´</span></span><br><span class="line">    <span class="built_in">this</span>.time = ns;</span><br><span class="line">    <span class="comment">// ä»»åŠ¡çš„å‘¨æœŸï¼Œå¤šé•¿æ—¶é—´æ‰§è¡Œä¸€æ¬¡</span></span><br><span class="line">    <span class="built_in">this</span>.period = period;</span><br><span class="line">    <span class="comment">// ä»»åŠ¡çš„åºå·</span></span><br><span class="line">    <span class="built_in">this</span>.sequenceNumber = sequencer.getAndIncrement();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>compareTo()ï¼šScheduledFutureTask æ ¹æ®æ‰§è¡Œæ—¶é—´ time æ­£åºæ’åˆ—ï¼Œå¦‚æœæ‰§è¡Œæ—¶é—´ç›¸åŒï¼Œåœ¨æŒ‰ç…§åºåˆ—å· sequenceNumber æ­£åºæ’åˆ—ï¼Œä»»åŠ¡éœ€è¦æ”¾å…¥ DelayedWorkQueueï¼Œå»¶è¿Ÿé˜Ÿåˆ—ä¸­ä½¿ç”¨è¯¥æ–¹æ³•æŒ‰ç…§ä»å°åˆ°å¤§è¿›è¡Œæ’åº</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">compareTo</span><span class="params">(Delayed other)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (other == <span class="built_in">this</span>) <span class="comment">// compare zero if same object</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (other <span class="keyword">instanceof</span> ScheduledFutureTask) &#123;</span><br><span class="line">        <span class="comment">// ç±»å‹å¼ºè½¬</span></span><br><span class="line">        ScheduledFutureTask&lt;?&gt; x = (ScheduledFutureTask&lt;?&gt;)other;</span><br><span class="line">        <span class="comment">// æ¯”è¾ƒè€… - è¢«æ¯”è¾ƒè€…çš„æ‰§è¡Œæ—¶é—´</span></span><br><span class="line">        <span class="type">long</span> <span class="variable">diff</span> <span class="operator">=</span> time - x.time;</span><br><span class="line">        <span class="comment">// æ¯”è¾ƒè€…å…ˆæ‰§è¡Œ</span></span><br><span class="line">        <span class="keyword">if</span> (diff &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">        <span class="comment">// è¢«æ¯”è¾ƒè€…å…ˆæ‰§è¡Œ</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (diff &gt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        <span class="comment">// æ¯”è¾ƒè€…çš„åºåˆ—å·å°</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (sequenceNumber &lt; x.sequenceNumber)</span><br><span class="line">            <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ä¸æ˜¯ ScheduledFutureTask ç±»å‹æ—¶ï¼Œæ ¹æ®å»¶è¿Ÿæ—¶é—´æ’åº</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">diff</span> <span class="operator">=</span> getDelay(NANOSECONDS) - other.getDelay(NANOSECONDS);</span><br><span class="line">    <span class="keyword">return</span> (diff &lt; <span class="number">0</span>) ? -<span class="number">1</span> : (diff &gt; <span class="number">0</span>) ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>run()ï¼šæ‰§è¡Œä»»åŠ¡ï¼Œéå‘¨æœŸä»»åŠ¡ç›´æ¥å®Œæˆç›´æ¥ç»“æŸï¼Œ<strong>å‘¨æœŸä»»åŠ¡æ‰§è¡Œå®Œåä¼šè®¾ç½®ä¸‹ä¸€æ¬¡çš„æ‰§è¡Œæ—¶é—´ï¼Œé‡æ–°æ”¾å…¥çº¿ç¨‹æ± çš„é˜»å¡é˜Ÿåˆ—</strong>ï¼Œå¦‚æœçº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹æ•°é‡å°‘äºæ ¸å¿ƒçº¿ç¨‹ï¼Œå°±ä¼šæ·»åŠ  Worker å¼€å¯æ–°çº¿ç¨‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// æ˜¯å¦å‘¨æœŸæ€§ï¼Œå°±æ˜¯åˆ¤æ–­ period æ˜¯å¦ä¸º 0</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">periodic</span> <span class="operator">=</span> isPeriodic();</span><br><span class="line">    <span class="comment">// æ ¹æ®æ˜¯å¦æ˜¯å‘¨æœŸä»»åŠ¡æ£€æŸ¥å½“å‰çŠ¶æ€èƒ½å¦æ‰§è¡Œä»»åŠ¡ï¼Œä¸èƒ½æ‰§è¡Œå°±å–æ¶ˆä»»åŠ¡</span></span><br><span class="line">    <span class="keyword">if</span> (!canRunInCurrentRunState(periodic))</span><br><span class="line">        cancel(<span class="literal">false</span>);</span><br><span class="line">    <span class="comment">// éå‘¨æœŸä»»åŠ¡ï¼Œç›´æ¥è°ƒç”¨ FutureTask#run æ‰§è¡Œ</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!periodic)</span><br><span class="line">        ScheduledFutureTask.<span class="built_in">super</span>.run();</span><br><span class="line">    <span class="comment">// å‘¨æœŸä»»åŠ¡çš„æ‰§è¡Œï¼Œè¿”å› true è¡¨ç¤ºæ‰§è¡ŒæˆåŠŸ</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (ScheduledFutureTask.<span class="built_in">super</span>.runAndReset()) &#123;</span><br><span class="line">        <span class="comment">// è®¾ç½®å‘¨æœŸä»»åŠ¡çš„ä¸‹ä¸€æ¬¡æ‰§è¡Œæ—¶é—´</span></span><br><span class="line">        setNextRunTime();</span><br><span class="line">        <span class="comment">// ä»»åŠ¡çš„ä¸‹ä¸€æ¬¡æ‰§è¡Œå®‰æ’ï¼Œå¦‚æœå½“å‰çº¿ç¨‹æ± çŠ¶æ€å¯ä»¥æ‰§è¡Œå‘¨æœŸä»»åŠ¡ï¼ŒåŠ å…¥é˜Ÿåˆ—ï¼Œå¹¶å¼€å¯æ–°çº¿ç¨‹</span></span><br><span class="line">        reExecutePeriodic(outerTask);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‘¨æœŸä»»åŠ¡æ­£å¸¸å®Œæˆå<strong>ä»»åŠ¡çš„çŠ¶æ€ä¸ä¼šå˜åŒ–</strong>ï¼Œä¾æ—§æ˜¯ NEWï¼Œä¸ä¼šè®¾ç½® outcome å±æ€§ã€‚ä½†æ˜¯å¦‚æœæœ¬æ¬¡ä»»åŠ¡æ‰§è¡Œå‡ºç°å¼‚å¸¸ï¼Œä¼šè¿›å…¥ setException æ–¹æ³•å°†ä»»åŠ¡çŠ¶æ€ç½®ä¸ºå¼‚å¸¸ï¼ŒæŠŠå¼‚å¸¸ä¿å­˜åœ¨ outcome ä¸­ï¼Œæ–¹æ³•è¿”å› falseï¼Œåç»­çš„è¯¥ä»»åŠ¡å°†ä¸ä¼šå†å‘¨æœŸçš„æ‰§è¡Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">runAndReset</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// ä»»åŠ¡ä¸æ˜¯æ–°å»ºçš„çŠ¶æ€äº†ï¼Œæˆ–è€…è¢«åˆ«çš„çº¿ç¨‹æ‰§è¡Œäº†ï¼Œç›´æ¥è¿”å› false</span></span><br><span class="line">    <span class="keyword">if</span> (state != NEW ||</span><br><span class="line">        !UNSAFE.compareAndSwapObject(<span class="built_in">this</span>, runnerOffset, <span class="literal">null</span>, Thread.currentThread()))</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">ran</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="type">int</span> <span class="variable">s</span> <span class="operator">=</span> state;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Callable&lt;V&gt; c = callable;</span><br><span class="line">        <span class="keyword">if</span> (c != <span class="literal">null</span> &amp;&amp; s == NEW) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// æ‰§è¡Œæ–¹æ³•ï¼Œæ²¡æœ‰è¿”å›å€¼</span></span><br><span class="line">                c.call();</span><br><span class="line">                ran = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">                <span class="comment">// å‡ºç°å¼‚å¸¸ï¼ŒæŠŠä»»åŠ¡è®¾ç½®ä¸ºå¼‚å¸¸çŠ¶æ€ï¼Œå”¤é†’æ‰€æœ‰çš„ get é˜»å¡çº¿ç¨‹</span></span><br><span class="line">                setException(ex);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line"><span class="comment">// æ‰§è¡Œå®ŒæˆæŠŠæ‰§è¡Œçº¿ç¨‹å¼•ç”¨ç½®ä¸º null</span></span><br><span class="line">        runner = <span class="literal">null</span>;</span><br><span class="line">        s = state;</span><br><span class="line">        <span class="comment">// å¦‚æœçº¿ç¨‹è¢«ä¸­æ–­è¿›è¡Œä¸­æ–­å¤„ç†</span></span><br><span class="line">        <span class="keyword">if</span> (s &gt;= INTERRUPTING)</span><br><span class="line">            handlePossibleCancellationInterrupt(s);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¦‚æœæ­£å¸¸æ‰§è¡Œï¼Œè¿”å› trueï¼Œå¹¶ä¸”ä»»åŠ¡çŠ¶æ€æ²¡æœ‰è¢«å–æ¶ˆ</span></span><br><span class="line">    <span class="keyword">return</span> ran &amp;&amp; s == NEW;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä»»åŠ¡ä¸‹ä¸€æ¬¡çš„è§¦å‘æ—¶é—´</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">setNextRunTime</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">long</span> <span class="variable">p</span> <span class="operator">=</span> period;</span><br><span class="line">    <span class="keyword">if</span> (p &gt; <span class="number">0</span>)</span><br><span class="line">        <span class="comment">// fixed-rate æ¨¡å¼ï¼Œã€æ—¶é—´è®¾ç½®ä¸ºä¸Šä¸€æ¬¡æ‰§è¡Œä»»åŠ¡çš„æ—¶é—´ + pã€‘ï¼Œä¸¤æ¬¡ä»»åŠ¡æ‰§è¡Œçš„æ—¶é—´å·®</span></span><br><span class="line">        time += p;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="comment">// fixed-delay æ¨¡å¼ï¼Œä¸‹ä¸€æ¬¡æ‰§è¡Œæ—¶é—´æ˜¯ã€å½“å‰è¿™æ¬¡ä»»åŠ¡ç»“æŸçš„æ—¶é—´ï¼ˆå°±æ˜¯ç°åœ¨ï¼‰ + delay å€¼ã€‘</span></span><br><span class="line">        time = triggerTime(-p);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>reExecutePeriodic()<strong>ï¼šå‡†å¤‡ä»»åŠ¡çš„ä¸‹ä¸€æ¬¡æ‰§è¡Œï¼Œé‡æ–°æ”¾å…¥é˜»å¡ä»»åŠ¡é˜Ÿåˆ—</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ScheduledThreadPoolExecutor#reExecutePeriodic</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">reExecutePeriodic</span><span class="params">(RunnableScheduledFuture&lt;?&gt; task)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (canRunInCurrentRunState(<span class="literal">true</span>)) &#123;</span><br><span class="line">        <span class="comment">// ã€æ”¾å…¥ä»»åŠ¡é˜Ÿåˆ—ã€‘</span></span><br><span class="line">        <span class="built_in">super</span>.getQueue().add(task);</span><br><span class="line">        <span class="comment">// å¦‚æœæäº¤å®Œä»»åŠ¡ä¹‹åï¼Œçº¿ç¨‹æ± çŠ¶æ€å˜ä¸ºäº† shutdown çŠ¶æ€ï¼Œéœ€è¦å†æ¬¡æ£€æŸ¥æ˜¯å¦å¯ä»¥æ‰§è¡Œï¼Œ</span></span><br><span class="line">        <span class="comment">// å¦‚æœä¸èƒ½æ‰§è¡Œä¸”ä»»åŠ¡è¿˜åœ¨é˜Ÿåˆ—ä¸­æœªè¢«å–èµ°ï¼Œåˆ™å–æ¶ˆä»»åŠ¡</span></span><br><span class="line">        <span class="keyword">if</span> (!canRunInCurrentRunState(<span class="literal">true</span>) &amp;&amp; remove(task))</span><br><span class="line">            task.cancel(<span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="comment">// å½“å‰çº¿ç¨‹æ± çŠ¶æ€å¯ä»¥æ‰§è¡Œå‘¨æœŸä»»åŠ¡ï¼ŒåŠ å…¥é˜Ÿåˆ—ï¼Œå¹¶ã€æ ¹æ®çº¿ç¨‹æ•°é‡æ˜¯å¦å¤§äºæ ¸å¿ƒçº¿ç¨‹æ•°ç¡®å®šæ˜¯å¦å¼€å¯æ–°çº¿ç¨‹ã€‘</span></span><br><span class="line">            ensurePrestart();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>cancel()ï¼šå–æ¶ˆä»»åŠ¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">cancel</span><span class="params">(<span class="type">boolean</span> mayInterruptIfRunning)</span> &#123;</span><br><span class="line">    <span class="comment">// è°ƒç”¨çˆ¶ç±» FutureTask#cancel æ¥å–æ¶ˆä»»åŠ¡</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">cancelled</span> <span class="operator">=</span> <span class="built_in">super</span>.cancel(mayInterruptIfRunning);</span><br><span class="line">    <span class="comment">// removeOnCancel ç”¨äºæ§åˆ¶ä»»åŠ¡å–æ¶ˆåæ˜¯å¦åº”è¯¥ä»é˜»å¡é˜Ÿåˆ—ä¸­ç§»é™¤</span></span><br><span class="line">    <span class="keyword">if</span> (cancelled &amp;&amp; removeOnCancel &amp;&amp; heapIndex &gt;= <span class="number">0</span>)</span><br><span class="line">        <span class="comment">// ä»ç­‰å¾…é˜Ÿåˆ—ä¸­åˆ é™¤è¯¥ä»»åŠ¡ï¼Œå¹¶è°ƒç”¨ tryTerminate() åˆ¤æ–­æ˜¯å¦éœ€è¦åœæ­¢çº¿ç¨‹æ± </span></span><br><span class="line">        remove(<span class="built_in">this</span>);</span><br><span class="line">    <span class="keyword">return</span> cancelled;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><hr><h5 id="å»¶è¿Ÿé˜Ÿåˆ—"><a href="#å»¶è¿Ÿé˜Ÿåˆ—" class="headerlink" title="å»¶è¿Ÿé˜Ÿåˆ—"></a>å»¶è¿Ÿé˜Ÿåˆ—</h5><p>DelayedWorkQueue æ˜¯æ”¯æŒå»¶æ—¶è·å–å…ƒç´ çš„é˜»å¡é˜Ÿåˆ—ï¼Œå†…éƒ¨é‡‡ç”¨ä¼˜å…ˆé˜Ÿåˆ— PriorityQueueï¼ˆå°æ ¹å †ã€æ»¡äºŒå‰æ ‘ï¼‰å­˜å‚¨å…ƒç´ </p><p>å…¶ä»–é˜»å¡é˜Ÿåˆ—å­˜å‚¨èŠ‚ç‚¹çš„æ•°æ®ç»“æ„å¤§éƒ½æ˜¯é“¾è¡¨ï¼Œ<strong>å»¶è¿Ÿé˜Ÿåˆ—æ˜¯æ•°ç»„</strong>ï¼Œæ‰€ä»¥å»¶è¿Ÿé˜Ÿåˆ—å‡ºé˜Ÿå¤´å…ƒç´ åéœ€è¦<strong>è®©å…¶ä»–å…ƒç´ ï¼ˆå°¾ï¼‰æ›¿æ¢åˆ°å¤´èŠ‚ç‚¹</strong>ï¼Œé˜²æ­¢ç©ºæŒ‡é’ˆå¼‚å¸¸</p><p>æˆå‘˜å˜é‡ï¼š</p><ul><li><p>å®¹é‡ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">INITIAL_CAPACITY</span> <span class="operator">=</span> <span class="number">16</span>;<span class="comment">// åˆå§‹å®¹é‡</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> <span class="number">0</span>;<span class="comment">// èŠ‚ç‚¹æ•°é‡</span></span><br><span class="line"><span class="keyword">private</span> RunnableScheduledFuture&lt;?&gt;[] queue = </span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">RunnableScheduledFuture</span>&lt;?&gt;[INITIAL_CAPACITY];<span class="comment">// å­˜æ”¾èŠ‚ç‚¹</span></span><br></pre></td></tr></table></figure></li><li><p>é”ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();<span class="comment">// æ§åˆ¶å¹¶å‘</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Condition</span> <span class="variable">available</span> <span class="operator">=</span> lock.newCondition();<span class="comment">// æ¡ä»¶é˜Ÿåˆ—</span></span><br></pre></td></tr></table></figure></li><li><p>é˜»å¡ç­‰å¾…å¤´èŠ‚ç‚¹çš„çº¿ç¨‹ï¼šçº¿ç¨‹æ± å†…çš„æŸä¸ªçº¿ç¨‹å» take() è·å–ä»»åŠ¡æ—¶ï¼Œå¦‚æœå»¶è¿Ÿé˜Ÿåˆ—é¡¶å±‚èŠ‚ç‚¹ä¸ä¸º nullï¼ˆé˜Ÿåˆ—å†…æœ‰ä»»åŠ¡ï¼‰ï¼Œä½†æ˜¯èŠ‚ç‚¹ä»»åŠ¡è¿˜ä¸åˆ°è§¦å‘æ—¶é—´ï¼Œçº¿ç¨‹å°±å»æ£€æŸ¥<strong>é˜Ÿåˆ—çš„ leaderå­—æ®µ</strong>æ˜¯å¦è¢«å ç”¨</p><ul><li>å¦‚æœæœªè¢«å ç”¨ï¼Œåˆ™å½“å‰çº¿ç¨‹å ç”¨è¯¥å­—æ®µï¼Œç„¶åå½“å‰çº¿ç¨‹åˆ° available æ¡ä»¶é˜Ÿåˆ—æŒ‡å®šè¶…æ—¶æ—¶é—´ <code>å †é¡¶ä»»åŠ¡.time - now()</code> æŒ‚èµ·</li><li>å¦‚æœè¢«å ç”¨ï¼Œå½“å‰çº¿ç¨‹ç›´æ¥åˆ° available æ¡ä»¶é˜Ÿåˆ—ä¸æŒ‡å®šè¶…æ—¶æ—¶é—´çš„æŒ‚èµ·</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// leader åœ¨ available æ¡ä»¶é˜Ÿåˆ—å†…æ˜¯é¦–å…ƒç´ ï¼Œå®ƒè¶…æ—¶ä¹‹åä¼šé†’è¿‡æ¥ï¼Œç„¶åå†æ¬¡å°†å †é¡¶å…ƒç´ è·å–èµ°ï¼Œè·å–èµ°ä¹‹åï¼Œtake()ç»“æŸä¹‹å‰ï¼Œä¼šè°ƒç”¨æ˜¯ available.signal() å”¤é†’ä¸‹ä¸€ä¸ªæ¡ä»¶é˜Ÿåˆ—å†…çš„ç­‰å¾…è€…ï¼Œç„¶åé‡Šæ”¾ lockï¼Œä¸‹ä¸€ä¸ªç­‰å¾…è€…è¢«å”¤é†’åå»åˆ° AQS é˜Ÿåˆ—ï¼Œåš acquireQueue(node) é€»è¾‘</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">Thread</span> <span class="variable">leader</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br></pre></td></tr></table></figure></li></ul><p>æˆå‘˜æ–¹æ³•</p><ul><li><p>offer()ï¼šæ’å…¥èŠ‚ç‚¹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">offer</span><span class="params">(Runnable x)</span> &#123;</span><br><span class="line">    <span class="comment">// åˆ¤ç©º</span></span><br><span class="line">    <span class="keyword">if</span> (x == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">    RunnableScheduledFuture&lt;?&gt; e = (RunnableScheduledFuture&lt;?&gt;)x;</span><br><span class="line">    <span class="comment">// é˜Ÿåˆ—é”ï¼Œå¢åŠ åˆ é™¤æ•°æ®æ—¶éƒ½è¦åŠ é”</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="built_in">this</span>.lock;</span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> size;</span><br><span class="line">        <span class="comment">// é˜Ÿåˆ—æ•°é‡å¤§äºå­˜æ”¾èŠ‚ç‚¹çš„æ•°ç»„é•¿åº¦ï¼Œéœ€è¦æ‰©å®¹</span></span><br><span class="line">        <span class="keyword">if</span> (i &gt;= queue.length)</span><br><span class="line">            <span class="comment">// æ‰©å®¹ä¸ºåŸæ¥é•¿åº¦çš„ 1.5 å€</span></span><br><span class="line">            grow();</span><br><span class="line">        size = i + <span class="number">1</span>;</span><br><span class="line">        <span class="comment">// å½“å‰æ˜¯ç¬¬ä¸€ä¸ªè¦æ’å…¥çš„èŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">if</span> (i == <span class="number">0</span>) &#123;</span><br><span class="line">            queue[<span class="number">0</span>] = e;</span><br><span class="line">            <span class="comment">// ä¿®æ”¹ ScheduledFutureTask çš„ heapIndex å±æ€§ï¼Œè¡¨ç¤ºè¯¥å¯¹è±¡åœ¨é˜Ÿåˆ—é‡Œçš„ä¸‹æ ‡</span></span><br><span class="line">            setIndex(e, <span class="number">0</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// å‘ä¸Šè°ƒæ•´å…ƒç´ çš„ä½ç½®ï¼Œå¹¶æ›´æ–° heapIndex </span></span><br><span class="line">            siftUp(i, e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æƒ…å†µ1ï¼šå½“å‰ä»»åŠ¡æ˜¯ç¬¬ä¸€ä¸ªåŠ å…¥åˆ° queue å†…çš„ä»»åŠ¡ï¼Œæ‰€ä»¥åœ¨å½“å‰ä»»åŠ¡åŠ å…¥åˆ° queue ä¹‹å‰ï¼Œtake() çº¿ç¨‹ä¼šç›´æ¥</span></span><br><span class="line">        <span class="comment">//åˆ° available é˜Ÿåˆ—ä¸è®¾ç½®è¶…æ—¶çš„æŒ‚èµ·ï¼Œå¹¶ä¸ä¼šå»å ç”¨ leader å­—æ®µï¼Œè¿™æ—¶éœ€ä¼šå”¤é†’ä¸€ä¸ªçº¿ç¨‹ è®©å®ƒå»æ¶ˆè´¹</span></span><br><span class="line">       <span class="comment">// æƒ…å†µ2ï¼šå½“å‰ä»»åŠ¡ã€ä¼˜å…ˆçº§æœ€é«˜ã€‘ï¼ŒåŸå †é¡¶ä»»åŠ¡å¯èƒ½è¿˜æœªåˆ°è§¦å‘æ—¶é—´ï¼Œleader çº¿ç¨‹è®¾ç½®è¶…æ—¶çš„åœ¨ available æŒ‚èµ·</span></span><br><span class="line">        <span class="comment">//åŸå…ˆçš„ leader ç­‰å¾…çš„æ˜¯åŸå…ˆçš„å¤´èŠ‚ç‚¹ï¼Œæ‰€ä»¥ leader å·²ç»æ— æ•ˆï¼Œéœ€è¦å°† leader çº¿ç¨‹å”¤é†’ï¼Œ</span></span><br><span class="line">        <span class="comment">//å”¤é†’ä¹‹åå®ƒä¼šæ£€æŸ¥å †é¡¶ï¼Œå¦‚æœå †é¡¶ä»»åŠ¡å¯ä»¥è¢«æ¶ˆè´¹ï¼Œåˆ™ç›´æ¥è·å–èµ°ï¼Œå¦åˆ™ç»§ç»­æˆä¸º leader ç­‰å¾…æ–°å †é¡¶ä»»åŠ¡</span></span><br><span class="line">        <span class="keyword">if</span> (queue[<span class="number">0</span>] == e) &#123;</span><br><span class="line">            <span class="comment">// å°† leader è®¾ç½®ä¸º null</span></span><br><span class="line">            leader = <span class="literal">null</span>;</span><br><span class="line">            <span class="comment">// ç›´æ¥éšä¾¿å”¤é†’ç­‰å¾…å¤´ç»“ç‚¹çš„é˜»å¡çº¿ç¨‹</span></span><br><span class="line">            available.signal();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ’å…¥æ–°èŠ‚ç‚¹åå¯¹å †è¿›è¡Œè°ƒæ•´ï¼Œè¿›è¡ŒèŠ‚ç‚¹ä¸Šç§»ï¼Œä¿æŒå…¶ç‰¹æ€§ã€èŠ‚ç‚¹çš„å€¼å°äºå­èŠ‚ç‚¹çš„å€¼ã€‘ï¼Œå°é¡¶å †</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">siftUp</span><span class="params">(<span class="type">int</span> k, RunnableScheduledFuture&lt;?&gt; key)</span> &#123;</span><br><span class="line">    <span class="keyword">while</span> (k &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// çˆ¶èŠ‚ç‚¹ï¼Œå°±æ˜¯å †æ’åº</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">parent</span> <span class="operator">=</span> (k - <span class="number">1</span>) &gt;&gt;&gt; <span class="number">1</span>;</span><br><span class="line">        RunnableScheduledFuture&lt;?&gt; e = queue[parent];</span><br><span class="line">        <span class="comment">// key å’Œçˆ¶èŠ‚ç‚¹æ¯”ï¼Œå¦‚æœå¤§äºçˆ¶èŠ‚ç‚¹å¯ä»¥ç›´æ¥è¿”å›ï¼Œå¦åˆ™å°±ç»§ç»­ä¸Šæµ®</span></span><br><span class="line">        <span class="keyword">if</span> (key.compareTo(e) &gt;= <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        queue[k] = e;</span><br><span class="line">        setIndex(e, k);</span><br><span class="line">        k = parent;</span><br><span class="line">    &#125;</span><br><span class="line">    queue[k] = key;</span><br><span class="line">    setIndex(key, k);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>poll()ï¼šéé˜»å¡è·å–å¤´ç»“ç‚¹ï¼Œ<strong>è·å–æ‰§è¡Œæ—¶é—´æœ€è¿‘å¹¶ä¸”å¯ä»¥æ‰§è¡Œçš„</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// éé˜»å¡è·å–</span></span><br><span class="line"><span class="keyword">public</span> RunnableScheduledFuture&lt;?&gt; poll() &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="built_in">this</span>.lock;</span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// è·å–é˜Ÿå¤´èŠ‚ç‚¹ï¼Œå› ä¸ºæ˜¯å°é¡¶å †</span></span><br><span class="line">        RunnableScheduledFuture&lt;?&gt; first = queue[<span class="number">0</span>];</span><br><span class="line">        <span class="comment">// å¤´ç»“ç‚¹ä¸ºç©ºæˆ–è€…çš„å»¶è¿Ÿæ—¶é—´æ²¡åˆ°è¿”å› null</span></span><br><span class="line">        <span class="keyword">if</span> (first == <span class="literal">null</span> || first.getDelay(NANOSECONDS) &gt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="comment">// å¤´ç»“ç‚¹è¾¾åˆ°å»¶è¿Ÿæ—¶é—´ï¼Œã€å°¾èŠ‚ç‚¹æˆä¸ºæ›¿ä»£èŠ‚ç‚¹ä¸‹ç§»è°ƒæ•´å †ç»“æ„ã€‘ï¼Œè¿”å›å¤´ç»“ç‚¹</span></span><br><span class="line">            <span class="keyword">return</span> finishPoll(first);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> RunnableScheduledFuture&lt;?&gt; finishPoll(RunnableScheduledFuture&lt;?&gt; f) &#123;</span><br><span class="line">    <span class="comment">// è·å–å°¾ç´¢å¼•</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">s</span> <span class="operator">=</span> --size;</span><br><span class="line">    <span class="comment">// è·å–å°¾èŠ‚ç‚¹</span></span><br><span class="line">    RunnableScheduledFuture&lt;?&gt; x = queue[s];</span><br><span class="line">    <span class="comment">// å°†å †ç»“æ„æœ€åä¸€ä¸ªèŠ‚ç‚¹å ç”¨çš„ slot è®¾ç½®ä¸º nullï¼Œå› ä¸ºè¯¥èŠ‚ç‚¹è¦å°è¯•å‡çº§æˆå †é¡¶ï¼Œä¼šæ ¹æ®ç‰¹æ€§ä¸‹è°ƒ</span></span><br><span class="line">    queue[s] = <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">// s == 0 è¯´æ˜ å½“å‰å †ç»“æ„åªæœ‰å †é¡¶ä¸€ä¸ªèŠ‚ç‚¹ï¼Œæ­¤æ—¶ä¸éœ€è¦åšä»»ä½•çš„äº‹æƒ…</span></span><br><span class="line">    <span class="keyword">if</span> (s != <span class="number">0</span>)</span><br><span class="line">        <span class="comment">// ä»ç´¢å¼•å¤„ 0 å¼€å§‹å‘ä¸‹è°ƒæ•´</span></span><br><span class="line">        siftDown(<span class="number">0</span>, x);</span><br><span class="line">    <span class="comment">// å‡ºé˜Ÿçš„å…ƒç´ ç´¢å¼•è®¾ç½®ä¸º -1</span></span><br><span class="line">    setIndex(f, -<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> f;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>take()ï¼šé˜»å¡è·å–å¤´èŠ‚ç‚¹ï¼Œè¯»å–å½“å‰å †ä¸­æœ€å°çš„ä¹Ÿå°±æ˜¯è§¦å‘æ—¶é—´æœ€è¿‘çš„ä»»åŠ¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> RunnableScheduledFuture&lt;?&gt; take() <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="built_in">this</span>.lock;</span><br><span class="line">    <span class="comment">// ä¿è¯çº¿ç¨‹å®‰å…¨</span></span><br><span class="line">    lock.lockInterruptibly();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="comment">// å¤´èŠ‚ç‚¹</span></span><br><span class="line">            RunnableScheduledFuture&lt;?&gt; first = queue[<span class="number">0</span>];</span><br><span class="line">            <span class="keyword">if</span> (first == <span class="literal">null</span>)</span><br><span class="line">                <span class="comment">// ç­‰å¾…é˜Ÿåˆ—ä¸ç©ºï¼Œç›´è‡³æœ‰ä»»åŠ¡é€šè¿‡ offer å…¥é˜Ÿå¹¶å”¤é†’</span></span><br><span class="line">                available.await();</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// è·å–å¤´èŠ‚ç‚¹çš„å»¶è¿Ÿæ—¶é—´æ˜¯å¦åˆ°æ—¶</span></span><br><span class="line">                <span class="type">long</span> <span class="variable">delay</span> <span class="operator">=</span> first.getDelay(NANOSECONDS);</span><br><span class="line">                <span class="keyword">if</span> (delay &lt;= <span class="number">0</span>)</span><br><span class="line">                    <span class="comment">// åˆ°è¾¾è§¦å‘æ—¶é—´ï¼Œè·å–å¤´èŠ‚ç‚¹å¹¶è°ƒæ•´å †ï¼Œé‡æ–°é€‰æ‹©å»¶è¿Ÿæ—¶é—´æœ€å°çš„èŠ‚ç‚¹æ”¾å…¥å¤´éƒ¨</span></span><br><span class="line">                    <span class="keyword">return</span> finishPoll(first);</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// é€»è¾‘åˆ°è¿™è¯´æ˜å¤´èŠ‚ç‚¹çš„å»¶è¿Ÿæ—¶é—´è¿˜æ²¡åˆ°</span></span><br><span class="line">                first = <span class="literal">null</span>;</span><br><span class="line">                <span class="comment">// è¯´æ˜æœ‰ leader çº¿ç¨‹åœ¨ç­‰å¾…è·å–å¤´èŠ‚ç‚¹ï¼Œå½“å‰çº¿ç¨‹ç›´æ¥å»é˜»å¡ç­‰å¾…</span></span><br><span class="line">                <span class="keyword">if</span> (leader != <span class="literal">null</span>)</span><br><span class="line">                    available.await();</span><br><span class="line">                <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// æ²¡æœ‰ leader çº¿ç¨‹ï¼Œã€å½“å‰çº¿ç¨‹ä½œä¸ºleaderçº¿ç¨‹ï¼Œå¹¶è®¾ç½®å¤´ç»“ç‚¹çš„å»¶è¿Ÿæ—¶é—´ä½œä¸ºé˜»å¡æ—¶é—´ã€‘</span></span><br><span class="line">                    <span class="type">Thread</span> <span class="variable">thisThread</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">                    leader = thisThread;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="comment">// åœ¨æ¡ä»¶é˜Ÿåˆ— available ä½¿ç”¨å¸¦è¶…æ—¶çš„æŒ‚èµ·ï¼ˆå †é¡¶ä»»åŠ¡.time - now() çº³ç§’å€¼..ï¼‰</span></span><br><span class="line">                        available.awaitNanos(delay);</span><br><span class="line">                        <span class="comment">// åˆ°è¾¾é˜»å¡æ—¶é—´æ—¶ï¼Œå½“å‰çº¿ç¨‹ä¼šä»è¿™é‡Œé†’æ¥æ¥</span></span><br><span class="line">                    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                        <span class="comment">// tå †é¡¶æ›´æ–°ï¼Œleader ç½®ä¸º nullï¼Œoffer æ–¹æ³•é‡Šæ”¾é”åï¼Œ</span></span><br><span class="line">                        <span class="comment">// æœ‰å…¶å®ƒçº¿ç¨‹é€šè¿‡ take/poll æ‹¿åˆ°é”,è¯»åˆ° leader == nullï¼Œç„¶åå°†è‡ªèº«æ›´æ–°ä¸ºleaderã€‚</span></span><br><span class="line">                        <span class="keyword">if</span> (leader == thisThread)</span><br><span class="line">                            <span class="comment">// leader ç½®ä¸º null ç”¨ä»¥æ¥ä¸‹æ¥åˆ¤æ–­æ˜¯å¦éœ€è¦å”¤é†’åç»§çº¿ç¨‹</span></span><br><span class="line">                            leader = <span class="literal">null</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// æ²¡æœ‰ leader çº¿ç¨‹ï¼Œå¤´ç»“ç‚¹ä¸ä¸º nullï¼Œå”¤é†’é˜»å¡è·å–å¤´èŠ‚ç‚¹çš„çº¿ç¨‹ï¼Œ</span></span><br><span class="line">        <span class="comment">// ã€å¦‚æœæ²¡æœ‰è¿™ä¸€æ­¥ï¼Œå°±ä¼šå‡ºç°æœ‰äº†éœ€è¦æ‰§è¡Œçš„ä»»åŠ¡ï¼Œä½†æ˜¯æ²¡æœ‰çº¿ç¨‹å»æ‰§è¡Œã€‘</span></span><br><span class="line">        <span class="keyword">if</span> (leader == <span class="literal">null</span> &amp;&amp; queue[<span class="number">0</span>] != <span class="literal">null</span>)</span><br><span class="line">            available.signal();</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>remove()ï¼šåˆ é™¤èŠ‚ç‚¹ï¼Œå †ç§»é™¤ä¸€ä¸ªå…ƒç´ çš„æ—¶é—´å¤æ‚åº¦æ˜¯ O(log n)ï¼Œ<strong>å»¶è¿Ÿä»»åŠ¡ç»´æŠ¤äº† heapIndex</strong>ï¼Œç›´æ¥è®¿é—®çš„æ—¶é—´å¤æ‚åº¦æ˜¯ O(1)ï¼Œä»è€Œå¯ä»¥æ›´å¿«çš„ç§»é™¤å…ƒç´ ï¼Œä»»åŠ¡åœ¨é˜Ÿåˆ—ä¸­è¢«å–æ¶ˆåä¼šè¿›å…¥è¯¥é€»è¾‘</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">remove</span><span class="params">(Object x)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="built_in">this</span>.lock;</span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// æŸ¥æ‰¾å¯¹è±¡åœ¨é˜Ÿåˆ—æ•°ç»„ä¸­çš„ä¸‹æ ‡</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> indexOf(x);</span><br><span class="line">        <span class="comment">// èŠ‚ç‚¹ä¸å­˜åœ¨ï¼Œè¿”å› false</span></span><br><span class="line">        <span class="keyword">if</span> (i &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"><span class="comment">// ä¿®æ”¹å…ƒç´ çš„ heapIndexï¼Œ-1 ä»£è¡¨åˆ é™¤</span></span><br><span class="line">        setIndex(queue[i], -<span class="number">1</span>);</span><br><span class="line">        <span class="comment">// å°¾ç´¢å¼•æ˜¯é•¿åº¦-1</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">s</span> <span class="operator">=</span> --size;</span><br><span class="line">        <span class="comment">// å°¾èŠ‚ç‚¹ä½œä¸ºæ›¿ä»£èŠ‚ç‚¹</span></span><br><span class="line">        RunnableScheduledFuture&lt;?&gt; replacement = queue[s];</span><br><span class="line">        queue[s] = <span class="literal">null</span>;</span><br><span class="line">        <span class="comment">// s == i è¯´æ˜å¤´èŠ‚ç‚¹å°±æ˜¯å°¾èŠ‚ç‚¹ï¼Œé˜Ÿåˆ—ç©ºäº†</span></span><br><span class="line">        <span class="keyword">if</span> (s != i) &#123;</span><br><span class="line">            <span class="comment">// å‘ä¸‹è°ƒæ•´</span></span><br><span class="line">            siftDown(i, replacement);</span><br><span class="line">            <span class="comment">// è¯´æ˜æ²¡å‘ç”Ÿè°ƒæ•´</span></span><br><span class="line">            <span class="keyword">if</span> (queue[i] == replacement)</span><br><span class="line">                <span class="comment">// ä¸Šç§»å’Œä¸‹ç§»ä¸å¯èƒ½åŒæ—¶å‘ç”Ÿï¼Œæ›¿ä»£èŠ‚ç‚¹å¤§äºå­èŠ‚ç‚¹æ—¶ä¸‹ç§»ï¼Œå¦åˆ™ä¸Šç§»</span></span><br><span class="line">                siftUp(i, replacement);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><hr><h4 id="æˆå‘˜æ–¹æ³•-4"><a href="#æˆå‘˜æ–¹æ³•-4" class="headerlink" title="æˆå‘˜æ–¹æ³•"></a>æˆå‘˜æ–¹æ³•</h4><h5 id="æäº¤ä»»åŠ¡"><a href="#æäº¤ä»»åŠ¡" class="headerlink" title="æäº¤ä»»åŠ¡"></a>æäº¤ä»»åŠ¡</h5><ul><li><p>schedule()ï¼šå»¶è¿Ÿæ‰§è¡Œæ–¹æ³•ï¼Œå¹¶æŒ‡å®šæ‰§è¡Œçš„æ—¶é—´ï¼Œé»˜è®¤æ˜¯å½“å‰æ—¶é—´</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">execute</span><span class="params">(Runnable command)</span> &#123;</span><br><span class="line">    <span class="comment">// ä»¥é›¶å»¶æ—¶ä»»åŠ¡çš„å½¢å¼å®ç°</span></span><br><span class="line">    schedule(command, <span class="number">0</span>, NANOSECONDS);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> ScheduledFuture&lt;?&gt; schedule(Runnable command, <span class="type">long</span> delay, TimeUnit unit) &#123;</span><br><span class="line">    <span class="comment">// åˆ¤ç©º</span></span><br><span class="line">    <span class="keyword">if</span> (command == <span class="literal">null</span> || unit == <span class="literal">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">    <span class="comment">// æ²¡æœ‰åšä»»ä½•æ“ä½œï¼Œç›´æ¥å°† task è¿”å›ï¼Œè¯¥æ–¹æ³•ä¸»è¦ç›®çš„æ˜¯ç”¨äºå­ç±»æ‰©å±•ï¼Œå¹¶ä¸”ã€æ ¹æ®å»¶è¿Ÿæ—¶é—´è®¾ç½®ä»»åŠ¡è§¦å‘çš„æ—¶é—´ç‚¹ã€‘</span></span><br><span class="line">    RunnableScheduledFuture&lt;?&gt; t = decorateTask(command, <span class="keyword">new</span> <span class="title class_">ScheduledFutureTask</span>&lt;Void&gt;(</span><br><span class="line">        command, <span class="literal">null</span>, triggerTime(delay, unit)));</span><br><span class="line">    <span class="comment">// å»¶è¿Ÿæ‰§è¡Œ</span></span><br><span class="line">    delayedExecute(t);</span><br><span class="line">    <span class="keyword">return</span> t;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¿”å›ã€å½“å‰æ—¶é—´ + å»¶è¿Ÿæ—¶é—´ã€‘ï¼Œå°±æ˜¯è§¦å‘å½“å‰ä»»åŠ¡æ‰§è¡Œçš„æ—¶é—´</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">long</span> <span class="title function_">triggerTime</span><span class="params">(<span class="type">long</span> delay, TimeUnit unit)</span> &#123;</span><br><span class="line">    <span class="comment">// è®¾ç½®è§¦å‘çš„æ—¶é—´</span></span><br><span class="line">    <span class="keyword">return</span> triggerTime(unit.toNanos((delay &lt; <span class="number">0</span>) ? <span class="number">0</span> : delay));</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">long</span> <span class="title function_">triggerTime</span><span class="params">(<span class="type">long</span> delay)</span> &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœ delay &lt; Long.Max_VALUE/2ï¼Œåˆ™ä¸‹æ¬¡æ‰§è¡Œæ—¶é—´ä¸ºå½“å‰æ—¶é—´ +delay</span></span><br><span class="line">    <span class="comment">// å¦åˆ™ä¸ºäº†é¿å…é˜Ÿåˆ—ä¸­å‡ºç°ç”±äºæº¢å‡ºå¯¼è‡´çš„æ’åºç´Šä¹±,éœ€è¦è°ƒç”¨overflowFreeæ¥ä¿®æ­£ä¸€ä¸‹delay</span></span><br><span class="line">    <span class="keyword">return</span> now() + ((delay &lt; (Long.MAX_VALUE &gt;&gt; <span class="number">1</span>)) ? delay : overflowFree(delay));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>overflowFree çš„åŸå› ï¼šå¦‚æœæŸä¸ªä»»åŠ¡çš„ delay ä¸ºè´Ÿæ•°ï¼Œè¯´æ˜å½“å‰å¯ä»¥æ‰§è¡Œï¼ˆå…¶å®æ—©è¯¥æ‰§è¡Œäº†ï¼‰ã€‚é˜»å¡é˜Ÿåˆ—ä¸­ç»´æŠ¤ä»»åŠ¡é¡ºåºæ˜¯åŸºäº compareTo æ¯”è¾ƒçš„ï¼Œæ¯”è¾ƒä¸¤ä¸ªä»»åŠ¡çš„é¡ºåºä¼šç”¨ time ç›¸å‡ã€‚é‚£ä¹ˆå¯èƒ½å‡ºç°ä¸€ä¸ª delay ä¸ºæ­£æ•°å‡å»å¦ä¸€ä¸ªä¸ºè´Ÿæ•°çš„ delayï¼Œç»“æœä¸Šæº¢ä¸ºè´Ÿæ•°ï¼Œåˆ™ä¼šå¯¼è‡´ compareTo äº§ç”Ÿé”™è¯¯çš„ç»“æœ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">long</span> <span class="title function_">overflowFree</span><span class="params">(<span class="type">long</span> delay)</span> &#123;</span><br><span class="line">    <span class="type">Delayed</span> <span class="variable">head</span> <span class="operator">=</span> (Delayed) <span class="built_in">super</span>.getQueue().peek();</span><br><span class="line">    <span class="keyword">if</span> (head != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">headDelay</span> <span class="operator">=</span> head.getDelay(NANOSECONDS);</span><br><span class="line">        <span class="comment">// åˆ¤æ–­ä¸€ä¸‹é˜Ÿé¦–çš„delayæ˜¯ä¸æ˜¯è´Ÿæ•°ï¼Œå¦‚æœæ˜¯æ­£æ•°å°±ä¸ç”¨ç®¡ï¼Œæ€ä¹ˆå‡éƒ½ä¸ä¼šæº¢å‡º</span></span><br><span class="line">        <span class="comment">// å¦åˆ™æ‹¿å½“å‰ delay å‡å»é˜Ÿé¦–çš„ delay æ¥æ¯”è¾ƒçœ‹ï¼Œå¦‚æœä¸å‡ºç°ä¸Šæº¢ï¼Œæ’åºä¸ä¼šä¹±</span></span><br><span class="line"><span class="comment">// ä¸ç„¶å°±æŠŠå½“å‰ delay å€¼ç»™è°ƒæ•´ä¸º Long.MAX_VALUE + é˜Ÿé¦– delay</span></span><br><span class="line">        <span class="keyword">if</span> (headDelay &lt; <span class="number">0</span> &amp;&amp; (delay - headDelay &lt; <span class="number">0</span>))</span><br><span class="line">            delay = Long.MAX_VALUE + headDelay;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> delay;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>scheduleAtFixedRate()ï¼šå®šæ—¶æ‰§è¡Œï¼Œä¸€æ¬¡ä»»åŠ¡çš„å¯åŠ¨åˆ°ä¸‹ä¸€æ¬¡ä»»åŠ¡çš„å¯åŠ¨çš„é—´éš”</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> ScheduledFuture&lt;?&gt; scheduleAtFixedRate(Runnable command, <span class="type">long</span> initialDelay, <span class="type">long</span> period,</span><br><span class="line">                                              TimeUnit unit) &#123;</span><br><span class="line">    <span class="keyword">if</span> (command == <span class="literal">null</span> || unit == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">    <span class="keyword">if</span> (period &lt;= <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>();</span><br><span class="line">    <span class="comment">// ä»»åŠ¡å°è£…ï¼Œã€æŒ‡å®šåˆå§‹çš„å»¶è¿Ÿæ—¶é—´å’Œå‘¨æœŸæ—¶é—´ã€‘</span></span><br><span class="line">    ScheduledFutureTask&lt;Void&gt; sft =<span class="keyword">new</span> <span class="title class_">ScheduledFutureTask</span>&lt;Void&gt;(command, <span class="literal">null</span>,</span><br><span class="line">                                      triggerTime(initialDelay, unit), unit.toNanos(period));</span><br><span class="line">    <span class="comment">// é»˜è®¤è¿”å›æœ¬èº«</span></span><br><span class="line">    RunnableScheduledFuture&lt;Void&gt; t = decorateTask(command, sft);</span><br><span class="line">    sft.outerTask = t;</span><br><span class="line">    <span class="comment">// å¼€å§‹æ‰§è¡Œè¿™ä¸ªä»»åŠ¡</span></span><br><span class="line">    delayedExecute(t);</span><br><span class="line">    <span class="keyword">return</span> t;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>scheduleWithFixedDelay()ï¼šå®šæ—¶æ‰§è¡Œï¼Œä¸€æ¬¡ä»»åŠ¡çš„ç»“æŸåˆ°ä¸‹ä¸€æ¬¡ä»»åŠ¡çš„å¯åŠ¨çš„é—´éš”</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> ScheduledFuture&lt;?&gt; scheduleWithFixedDelay(Runnable command, <span class="type">long</span> initialDelay, <span class="type">long</span> delay,</span><br><span class="line">                                                 TimeUnit unit) &#123;</span><br><span class="line">    <span class="keyword">if</span> (command == <span class="literal">null</span> || unit == <span class="literal">null</span>) </span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">    <span class="keyword">if</span> (delay &lt;= <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>();</span><br><span class="line">    <span class="comment">// ä»»åŠ¡å°è£…ï¼Œã€æŒ‡å®šåˆå§‹çš„å»¶è¿Ÿæ—¶é—´å’Œå‘¨æœŸæ—¶é—´ã€‘ï¼Œå‘¨æœŸæ—¶é—´ä¸º - è¡¨ç¤ºæ˜¯ fixed-delay æ¨¡å¼</span></span><br><span class="line">    ScheduledFutureTask&lt;Void&gt; sft = <span class="keyword">new</span> <span class="title class_">ScheduledFutureTask</span>&lt;Void&gt;(command, <span class="literal">null</span>,</span><br><span class="line">                                      triggerTime(initialDelay, unit), unit.toNanos(-delay));</span><br><span class="line">    RunnableScheduledFuture&lt;Void&gt; t = decorateTask(command, sft);</span><br><span class="line">    sft.outerTask = t;</span><br><span class="line">    delayedExecute(t);</span><br><span class="line">    <span class="keyword">return</span> t;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><hr><h5 id="è¿è¡Œä»»åŠ¡"><a href="#è¿è¡Œä»»åŠ¡" class="headerlink" title="è¿è¡Œä»»åŠ¡"></a>è¿è¡Œä»»åŠ¡</h5><ul><li><p>delayedExecute()ï¼š<strong>æ ¡éªŒçº¿ç¨‹æ± çŠ¶æ€</strong>ï¼Œå»¶è¿Ÿæˆ–å‘¨æœŸæ€§ä»»åŠ¡çš„ä¸»è¦æ‰§è¡Œæ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">delayedExecute</span><span class="params">(RunnableScheduledFuture&lt;?&gt; task)</span> &#123;</span><br><span class="line">    <span class="comment">// çº¿ç¨‹æ± æ˜¯ SHUTDOWN çŠ¶æ€ï¼Œéœ€è¦æ‰§è¡Œæ‹’ç»ç­–ç•¥</span></span><br><span class="line">    <span class="keyword">if</span> (isShutdown())</span><br><span class="line">        reject(task);</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// æŠŠå½“å‰ä»»åŠ¡æ”¾å…¥é˜»å¡é˜Ÿåˆ—ï¼Œå› ä¸ºéœ€è¦ã€è·å–æ‰§è¡Œæ—¶é—´æœ€è¿‘çš„ã€‘ï¼Œå½“å‰ä»»åŠ¡éœ€è¦æ¯”è¾ƒ</span></span><br><span class="line">        <span class="built_in">super</span>.getQueue().add(task);</span><br><span class="line">        <span class="comment">// çº¿ç¨‹æ± çŠ¶æ€ä¸º SHUTDOWN å¹¶ä¸”ä¸å…è®¸æ‰§è¡Œä»»åŠ¡äº†ï¼Œå°±ä»é˜Ÿåˆ—åˆ é™¤è¯¥ä»»åŠ¡ï¼Œå¹¶è®¾ç½®ä»»åŠ¡çš„çŠ¶æ€ä¸ºå–æ¶ˆçŠ¶æ€</span></span><br><span class="line">        <span class="keyword">if</span> (isShutdown() &amp;&amp; !canRunInCurrentRunState(task.isPeriodic()) &amp;&amp; remove(task))</span><br><span class="line">            task.cancel(<span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="comment">// å¯ä»¥æ‰§è¡Œ</span></span><br><span class="line">            ensurePrestart();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>ensurePrestart()ï¼š<strong>å¼€å¯çº¿ç¨‹æ‰§è¡Œä»»åŠ¡</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ThreadPoolExecutor#ensurePrestart</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">ensurePrestart</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">wc</span> <span class="operator">=</span> workerCountOf(ctl.get());</span><br><span class="line">    <span class="comment">// workeræ•°ç›®å°äºcorePoolSizeï¼Œåˆ™æ·»åŠ ä¸€ä¸ªworkerã€‚</span></span><br><span class="line">    <span class="keyword">if</span> (wc &lt; corePoolSize)</span><br><span class="line">        <span class="comment">// ç¬¬äºŒä¸ªå‚æ•° true è¡¨ç¤ºé‡‡ç”¨æ ¸å¿ƒçº¿ç¨‹æ•°é‡é™åˆ¶ï¼Œfalse è¡¨ç¤ºé‡‡ç”¨ maximumPoolSize</span></span><br><span class="line">        addWorker(<span class="literal">null</span>, <span class="literal">true</span>);</span><br><span class="line">    <span class="comment">// corePoolSize = 0çš„æƒ…å†µï¼Œè‡³å°‘å¼€å¯ä¸€ä¸ªçº¿ç¨‹ï¼Œã€æ‹…ä¿æœºåˆ¶ã€‘</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (wc == <span class="number">0</span>)</span><br><span class="line">        addWorker(<span class="literal">null</span>, <span class="literal">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>canRunInCurrentRunState()ï¼šä»»åŠ¡è¿è¡Œæ—¶éƒ½ä¼šè¢«è°ƒç”¨ä»¥æ ¡éªŒå½“å‰çŠ¶æ€æ˜¯å¦å¯ä»¥è¿è¡Œä»»åŠ¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">boolean</span> <span class="title function_">canRunInCurrentRunState</span><span class="params">(<span class="type">boolean</span> periodic)</span> &#123;</span><br><span class="line">    <span class="comment">// æ ¹æ®æ˜¯å¦æ˜¯å‘¨æœŸä»»åŠ¡åˆ¤æ–­ï¼Œåœ¨çº¿ç¨‹æ±  shutdown åæ˜¯å¦ç»§ç»­æ‰§è¡Œè¯¥ä»»åŠ¡ï¼Œé»˜è®¤éå‘¨æœŸä»»åŠ¡æ˜¯ç»§ç»­æ‰§è¡Œçš„</span></span><br><span class="line">    <span class="keyword">return</span> isRunningOrShutdown(periodic ? continueExistingPeriodicTasksAfterShutdown :</span><br><span class="line">                               executeExistingDelayedTasksAfterShutdown);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>onShutdown()ï¼šåˆ é™¤å¹¶å–æ¶ˆå·¥ä½œé˜Ÿåˆ—ä¸­çš„ä¸éœ€è¦å†æ‰§è¡Œçš„ä»»åŠ¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">onShutdown</span><span class="params">()</span> &#123;</span><br><span class="line">    BlockingQueue&lt;Runnable&gt; q = <span class="built_in">super</span>.getQueue();</span><br><span class="line">    <span class="comment">// shutdown åæ˜¯å¦ä»ç„¶æ‰§è¡Œå»¶æ—¶ä»»åŠ¡</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">keepDelayed</span> <span class="operator">=</span> getExecuteExistingDelayedTasksAfterShutdownPolicy();</span><br><span class="line">    <span class="comment">// shutdown åæ˜¯å¦ä»ç„¶æ‰§è¡Œå‘¨æœŸä»»åŠ¡</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">keepPeriodic</span> <span class="operator">=</span> getContinueExistingPeriodicTasksAfterShutdownPolicy();</span><br><span class="line">    <span class="comment">// å¦‚æœä¸¤è€…çš†ä¸å¯ï¼Œåˆ™å¯¹é˜Ÿåˆ—ä¸­ã€æ‰€æœ‰ä»»åŠ¡ã€‘è°ƒç”¨ cancel å–æ¶ˆå¹¶æ¸…ç©ºé˜Ÿåˆ—</span></span><br><span class="line">    <span class="keyword">if</span> (!keepDelayed &amp;&amp; !keepPeriodic) &#123;</span><br><span class="line">        <span class="keyword">for</span> (Object e : q.toArray())</span><br><span class="line">            <span class="keyword">if</span> (e <span class="keyword">instanceof</span> RunnableScheduledFuture&lt;?&gt;)</span><br><span class="line">                ((RunnableScheduledFuture&lt;?&gt;) e).cancel(<span class="literal">false</span>);</span><br><span class="line">        q.clear();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (Object e : q.toArray()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (e <span class="keyword">instanceof</span> RunnableScheduledFuture) &#123;</span><br><span class="line">                RunnableScheduledFuture&lt;?&gt; t = (RunnableScheduledFuture&lt;?&gt;)e;</span><br><span class="line">                <span class="comment">// ä¸éœ€è¦æ‰§è¡Œçš„ä»»åŠ¡åˆ é™¤å¹¶å–æ¶ˆï¼Œå·²ç»å–æ¶ˆçš„ä»»åŠ¡ä¹Ÿéœ€è¦ä»é˜Ÿåˆ—ä¸­åˆ é™¤</span></span><br><span class="line">                <span class="keyword">if</span> ((t.isPeriodic() ? !keepPeriodic : !keepDelayed) ||</span><br><span class="line">                    t.isCancelled()) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (q.remove(t))</span><br><span class="line">                        t.cancel(<span class="literal">false</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å› ä¸ºä»»åŠ¡è¢«ä»é˜Ÿåˆ—ä¸­æ¸…ç†æ‰ï¼Œæ‰€ä»¥éœ€è¦è°ƒç”¨ tryTerminate å°è¯•ã€æ”¹å˜çº¿ç¨‹æ± çš„çŠ¶æ€ã€‘</span></span><br><span class="line">    tryTerminate();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><hr><h3 id="ForkJoin"><a href="#ForkJoin" class="headerlink" title="ForkJoin"></a>ForkJoin</h3><p>Fork&#x2F;Joinï¼šçº¿ç¨‹æ± çš„å®ç°ï¼Œä½“ç°æ˜¯åˆ†æ²»æ€æƒ³ï¼Œé€‚ç”¨äºèƒ½å¤Ÿè¿›è¡Œä»»åŠ¡æ‹†åˆ†çš„ CPU å¯†é›†å‹è¿ç®—ï¼Œç”¨äº<strong>å¹¶è¡Œè®¡ç®—</strong></p><p>ä»»åŠ¡æ‹†åˆ†ï¼šå°†ä¸€ä¸ªå¤§ä»»åŠ¡æ‹†åˆ†ä¸ºç®—æ³•ä¸Šç›¸åŒçš„å°ä»»åŠ¡ï¼Œç›´è‡³ä¸èƒ½æ‹†åˆ†å¯ä»¥ç›´æ¥æ±‚è§£ã€‚è·Ÿé€’å½’ç›¸å…³çš„ä¸€äº›è®¡ç®—ï¼Œå¦‚å½’å¹¶æ’åºã€æ–æ³¢é‚£å¥‘æ•°åˆ—éƒ½å¯ä»¥ç”¨åˆ†æ²»æ€æƒ³è¿›è¡Œæ±‚è§£</p><ul><li><p>Fork&#x2F;Join åœ¨<strong>åˆ†æ²»çš„åŸºç¡€ä¸ŠåŠ å…¥äº†å¤šçº¿ç¨‹</strong>ï¼ŒæŠŠæ¯ä¸ªä»»åŠ¡çš„åˆ†è§£å’Œåˆå¹¶äº¤ç»™ä¸åŒçš„çº¿ç¨‹æ¥å®Œæˆï¼Œæå‡äº†è¿ç®—æ•ˆç‡</p></li><li><p>ForkJoin ä½¿ç”¨ ForkJoinPool æ¥å¯åŠ¨ï¼Œæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„çº¿ç¨‹æ± ï¼Œé»˜è®¤ä¼šåˆ›å»ºä¸ CPU æ ¸å¿ƒæ•°å¤§å°ç›¸åŒçš„çº¿ç¨‹æ± </p></li><li><p>ä»»åŠ¡æœ‰è¿”å›å€¼ç»§æ‰¿ RecursiveTaskï¼Œæ²¡æœ‰è¿”å›å€¼ç»§æ‰¿ RecursiveAction</p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">ForkJoinPool</span> <span class="variable">pool</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ForkJoinPool</span>(<span class="number">4</span>);</span><br><span class="line">    System.out.println(pool.invoke(<span class="keyword">new</span> <span class="title class_">MyTask</span>(<span class="number">5</span>)));</span><br><span class="line">    <span class="comment">//æ‹†åˆ†  5 + MyTask(4) --&gt; 4 + MyTask(3) --&gt;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1~ n ä¹‹é—´æ•´æ•°çš„å’Œ</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyTask</span> <span class="keyword">extends</span> <span class="title class_">RecursiveTask</span>&lt;Integer&gt; &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> n;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyTask</span><span class="params">(<span class="type">int</span> n)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.n = n;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;MyTask&#123;&quot;</span> + <span class="string">&quot;n=&quot;</span> + n + <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Integer <span class="title function_">compute</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœ n å·²ç»ä¸º 1ï¼Œå¯ä»¥æ±‚å¾—ç»“æœäº†</span></span><br><span class="line">        <span class="keyword">if</span> (n == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> n;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å°†ä»»åŠ¡è¿›è¡Œæ‹†åˆ†(fork)</span></span><br><span class="line">        <span class="type">MyTask</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyTask</span>(n - <span class="number">1</span>);</span><br><span class="line">        t1.fork();</span><br><span class="line">        <span class="comment">// åˆå¹¶(join)ç»“æœ</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> n + t1.join();</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»§ç»­æ‹†åˆ†ä¼˜åŒ–ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">AddTask</span> <span class="keyword">extends</span> <span class="title class_">RecursiveTask</span>&lt;Integer&gt; &#123;</span><br><span class="line">    <span class="type">int</span> begin;</span><br><span class="line">    <span class="type">int</span> end;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">AddTask</span><span class="params">(<span class="type">int</span> begin, <span class="type">int</span> end)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.begin = begin;</span><br><span class="line">        <span class="built_in">this</span>.end = end;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&#123;&quot;</span> + begin + <span class="string">&quot;,&quot;</span> + end + <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> Integer <span class="title function_">compute</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 5, 5</span></span><br><span class="line">        <span class="keyword">if</span> (begin == end) &#123;</span><br><span class="line">            <span class="keyword">return</span> begin;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 4, 5  é˜²æ­¢å¤šä½™çš„æ‹†åˆ†  æé«˜æ•ˆç‡</span></span><br><span class="line">        <span class="keyword">if</span> (end - begin == <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> end + begin;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 1 5</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">mid</span> <span class="operator">=</span> (end + begin) / <span class="number">2</span>; <span class="comment">// 3</span></span><br><span class="line">        <span class="type">AddTask</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AddTask</span>(begin, mid); <span class="comment">// 1,3</span></span><br><span class="line">        t1.fork();</span><br><span class="line">        <span class="type">AddTask</span> <span class="variable">t2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AddTask</span>(mid + <span class="number">1</span>, end); <span class="comment">// 4,5</span></span><br><span class="line">        t2.fork();</span><br><span class="line">        <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> t1.join() + t2.join();</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ForkJoinPool å®ç°äº†<strong>å·¥ä½œçªƒå–ç®—æ³•</strong>æ¥æé«˜ CPU çš„åˆ©ç”¨ç‡ï¼š</p><ul><li>æ¯ä¸ªçº¿ç¨‹éƒ½ç»´æŠ¤äº†ä¸€ä¸ª<strong>åŒç«¯é˜Ÿåˆ—</strong>ï¼Œç”¨æ¥å­˜å‚¨éœ€è¦æ‰§è¡Œçš„ä»»åŠ¡</li><li>å·¥ä½œçªƒå–ç®—æ³•å…è®¸ç©ºé—²çš„çº¿ç¨‹ä»å…¶å®ƒçº¿ç¨‹çš„åŒç«¯é˜Ÿåˆ—ä¸­çªƒå–ä¸€ä¸ªä»»åŠ¡æ¥æ‰§è¡Œ</li><li>çªƒå–çš„å¿…é¡»æ˜¯<strong>æœ€æ™šçš„ä»»åŠ¡</strong>ï¼Œé¿å…å’Œé˜Ÿåˆ—æ‰€å±çº¿ç¨‹å‘ç”Ÿç«äº‰ï¼Œä½†æ˜¯é˜Ÿåˆ—ä¸­åªæœ‰ä¸€ä¸ªä»»åŠ¡æ—¶è¿˜æ˜¯ä¼šå‘ç”Ÿç«äº‰</li></ul><hr><h3 id="äº«å…ƒæ¨¡å¼"><a href="#äº«å…ƒæ¨¡å¼" class="headerlink" title="äº«å…ƒæ¨¡å¼"></a>äº«å…ƒæ¨¡å¼</h3><p>äº«å…ƒæ¨¡å¼ï¼ˆFlyweight patternï¼‰ï¼š ç”¨äºå‡å°‘åˆ›å»ºå¯¹è±¡çš„æ•°é‡ï¼Œä»¥å‡å°‘å†…å­˜å ç”¨å’Œæé«˜æ€§èƒ½ï¼Œè¿™ç§ç±»å‹çš„è®¾è®¡æ¨¡å¼å±äºç»“æ„å‹æ¨¡å¼ï¼Œå®ƒæä¾›äº†å‡å°‘å¯¹è±¡æ•°é‡ä»è€Œæ”¹å–„åº”ç”¨æ‰€éœ€çš„å¯¹è±¡ç»“æ„çš„æ–¹å¼</p><p>å¼‚æ­¥æ¨¡å¼ï¼šè®©æœ‰é™çš„å·¥ä½œçº¿ç¨‹ï¼ˆWorker Threadï¼‰æ¥è½®æµå¼‚æ­¥å¤„ç†æ— é™å¤šçš„ä»»åŠ¡ï¼Œä¹Ÿå¯å°†å…¶å½’ç±»ä¸ºåˆ†å·¥æ¨¡å¼ï¼Œå…¸å‹å®ç°å°±æ˜¯çº¿ç¨‹æ± </p><p>å·¥ä½œæœºåˆ¶ï¼šäº«å…ƒæ¨¡å¼å°è¯•é‡ç”¨ç°æœ‰çš„åŒç±»å¯¹è±¡ï¼Œå¦‚æœæœªæ‰¾åˆ°åŒ¹é…çš„å¯¹è±¡ï¼Œåˆ™åˆ›å»ºæ–°å¯¹è±¡</p><p>è‡ªå®šä¹‰è¿æ¥æ± ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">Pool</span> <span class="variable">pool</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Pool</span>(<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="type">Connection</span> <span class="variable">con</span> <span class="operator">=</span> pool.borrow();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="keyword">new</span> <span class="title class_">Random</span>().nextInt(<span class="number">1000</span>));</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            pool.free(con);</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Pool</span> &#123;</span><br><span class="line">    <span class="comment">//è¿æ¥æ± çš„å¤§å°</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> poolSize;</span><br><span class="line">    <span class="comment">//è¿æ¥å¯¹è±¡çš„æ•°ç»„</span></span><br><span class="line">    <span class="keyword">private</span> Connection[] connections;</span><br><span class="line">    <span class="comment">//è¿æ¥çŠ¶æ€æ•°ç»„ 0è¡¨ç¤ºç©ºé—²  1è¡¨ç¤ºç¹å¿™</span></span><br><span class="line">    <span class="keyword">private</span> AtomicIntegerArray states;  <span class="comment">//int[] -&gt; AtomicIntegerArray</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ„é€ æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Pool</span><span class="params">(<span class="type">int</span> poolSize)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.poolSize = poolSize;</span><br><span class="line">        <span class="built_in">this</span>.connections = <span class="keyword">new</span> <span class="title class_">Connection</span>[poolSize];</span><br><span class="line">        <span class="built_in">this</span>.states = <span class="keyword">new</span> <span class="title class_">AtomicIntegerArray</span>(<span class="keyword">new</span> <span class="title class_">int</span>[poolSize]);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; poolSize; i++) &#123;</span><br><span class="line">            connections[i] = <span class="keyword">new</span> <span class="title class_">MockConnection</span>(<span class="string">&quot;è¿æ¥&quot;</span> + (i + <span class="number">1</span>));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ä½¿ç”¨è¿æ¥</span></span><br><span class="line">    <span class="keyword">public</span> Connection <span class="title function_">borrow</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; poolSize; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (states.get(i) == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (states.compareAndSet(i, <span class="number">0</span>, <span class="number">1</span>)) &#123;</span><br><span class="line">                        System.out.println(Thread.currentThread().getName() + <span class="string">&quot; borrow &quot;</span> +  connections[i]);</span><br><span class="line">                        <span class="keyword">return</span> connections[i];</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//å¦‚æœæ²¡æœ‰ç©ºé—²è¿æ¥ï¼Œå½“å‰çº¿ç¨‹ç­‰å¾…</span></span><br><span class="line">            <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    System.out.println(Thread.currentThread().getName() + <span class="string">&quot; wait...&quot;</span>);</span><br><span class="line">                    <span class="built_in">this</span>.wait();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//å½’è¿˜è¿æ¥</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">free</span><span class="params">(Connection con)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; poolSize; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (connections[i] == con) &#123;<span class="comment">//åˆ¤æ–­æ˜¯å¦æ˜¯åŒä¸€ä¸ªå¯¹è±¡</span></span><br><span class="line">                states.set(i, <span class="number">0</span>);<span class="comment">//ä¸ç”¨casçš„åŸå› æ˜¯åªä¼šæœ‰ä¸€ä¸ªçº¿ç¨‹ä½¿ç”¨è¯¥è¿æ¥</span></span><br><span class="line">                <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">                    System.out.println(Thread.currentThread().getName() + <span class="string">&quot; free &quot;</span> + con);</span><br><span class="line">                    <span class="built_in">this</span>.notifyAll();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MockConnection</span> <span class="keyword">implements</span> <span class="title class_">Connection</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="comment">//.....</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h2 id="åŒæ­¥å™¨"><a href="#åŒæ­¥å™¨" class="headerlink" title="åŒæ­¥å™¨"></a>åŒæ­¥å™¨</h2><h3 id="AQS"><a href="#AQS" class="headerlink" title="AQS"></a>AQS</h3><h4 id="æ ¸å¿ƒæ€æƒ³"><a href="#æ ¸å¿ƒæ€æƒ³" class="headerlink" title="æ ¸å¿ƒæ€æƒ³"></a>æ ¸å¿ƒæ€æƒ³</h4><p>AQSï¼šAbstractQueuedSynchronizerï¼Œæ˜¯é˜»å¡å¼é”å’Œç›¸å…³çš„åŒæ­¥å™¨å·¥å…·çš„æ¡†æ¶ï¼Œè®¸å¤šåŒæ­¥ç±»å®ç°éƒ½ä¾èµ–äºè¯¥åŒæ­¥å™¨</p><p>AQS ç”¨çŠ¶æ€å±æ€§æ¥è¡¨ç¤ºèµ„æºçš„çŠ¶æ€ï¼ˆåˆ†<strong>ç‹¬å æ¨¡å¼å’Œå…±äº«æ¨¡å¼</strong>ï¼‰ï¼Œå­ç±»éœ€è¦å®šä¹‰å¦‚ä½•ç»´æŠ¤è¿™ä¸ªçŠ¶æ€ï¼Œæ§åˆ¶å¦‚ä½•è·å–é”å’Œé‡Šæ”¾é”</p><ul><li>ç‹¬å æ¨¡å¼æ˜¯åªæœ‰ä¸€ä¸ªçº¿ç¨‹èƒ½å¤Ÿè®¿é—®èµ„æºï¼Œå¦‚ ReentrantLock</li><li>å…±äº«æ¨¡å¼å…è®¸å¤šä¸ªçº¿ç¨‹è®¿é—®èµ„æºï¼Œå¦‚ Semaphoreï¼ŒReentrantReadWriteLock æ˜¯ç»„åˆå¼</li></ul><p>AQS æ ¸å¿ƒæ€æƒ³ï¼š</p><ul><li><p>å¦‚æœè¢«è¯·æ±‚çš„å…±äº«èµ„æºç©ºé—²ï¼Œåˆ™å°†å½“å‰è¯·æ±‚èµ„æºçš„çº¿ç¨‹è®¾ç½®ä¸ºæœ‰æ•ˆçš„å·¥ä½œçº¿ç¨‹ï¼Œå¹¶å°†å…±äº«èµ„æºè®¾ç½®é”å®šçŠ¶æ€</p></li><li><p>è¯·æ±‚çš„å…±äº«èµ„æºè¢«å ç”¨ï¼ŒAQS ç”¨é˜Ÿåˆ—å®ç°çº¿ç¨‹é˜»å¡ç­‰å¾…ä»¥åŠè¢«å”¤é†’æ—¶é”åˆ†é…çš„æœºåˆ¶ï¼Œå°†æš‚æ—¶è·å–ä¸åˆ°é”çš„çº¿ç¨‹åŠ å…¥åˆ°é˜Ÿåˆ—ä¸­</p><p>CLH æ˜¯ä¸€ç§åŸºäºå•å‘é“¾è¡¨çš„<strong>é«˜æ€§èƒ½ã€å…¬å¹³çš„è‡ªæ—‹é”</strong>ï¼ŒAQS æ˜¯å°†æ¯æ¡è¯·æ±‚å…±äº«èµ„æºçš„çº¿ç¨‹å°è£…æˆä¸€ä¸ª CLH é”é˜Ÿåˆ—çš„ä¸€ä¸ªç»“ç‚¹ï¼ˆNodeï¼‰æ¥å®ç°é”çš„åˆ†é…</p><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/JUC-AQSåŸç†å›¾.png" style="zoom: 80%;" /></li></ul><hr><h4 id="è®¾è®¡åŸç†"><a href="#è®¾è®¡åŸç†" class="headerlink" title="è®¾è®¡åŸç†"></a>è®¾è®¡åŸç†</h4><p>è®¾è®¡åŸç†ï¼š</p><ul><li><p>è·å–é”ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span>(state çŠ¶æ€ä¸å…è®¸è·å–) &#123;<span class="comment">// tryAcquire(arg)</span></span><br><span class="line">    <span class="keyword">if</span>(é˜Ÿåˆ—ä¸­è¿˜æ²¡æœ‰æ­¤çº¿ç¨‹) &#123;</span><br><span class="line">        å…¥é˜Ÿå¹¶é˜»å¡ park</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">å½“å‰çº¿ç¨‹å‡ºé˜Ÿ</span><br></pre></td></tr></table></figure></li><li><p>é‡Šæ”¾é”ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(state çŠ¶æ€å…è®¸äº†) &#123;<span class="comment">// tryRelease(arg)</span></span><br><span class="line">æ¢å¤é˜»å¡çš„çº¿ç¨‹(s) unpark</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p>AbstractQueuedSynchronizer ä¸­ state è®¾è®¡ï¼š</p><ul><li><p>state ä½¿ç”¨äº† 32bit int æ¥ç»´æŠ¤åŒæ­¥çŠ¶æ€ï¼Œç‹¬å æ¨¡å¼ 0 è¡¨ç¤ºæœªåŠ é”çŠ¶æ€ï¼Œå¤§äº 0 è¡¨ç¤ºå·²ç»åŠ é”çŠ¶æ€</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="type">int</span> state;</span><br></pre></td></tr></table></figure></li><li><p>state <strong>ä½¿ç”¨ volatile ä¿®é¥°é…åˆ cas</strong> ä¿è¯å…¶ä¿®æ”¹æ—¶çš„åŸå­æ€§</p></li><li><p>state è¡¨ç¤º<strong>çº¿ç¨‹é‡å…¥çš„æ¬¡æ•°ï¼ˆç‹¬å æ¨¡å¼ï¼‰æˆ–è€…å‰©ä½™è®¸å¯æ•°ï¼ˆå…±äº«æ¨¡å¼ï¼‰</strong></p></li><li><p>state APIï¼š</p><ul><li><code>protected final int getState()</code>ï¼šè·å– state çŠ¶æ€</li><li><code>protected final void setState(int newState)</code>ï¼šè®¾ç½® state çŠ¶æ€</li><li><code>protected final boolean compareAndSetState(int expect,int update)</code>ï¼š<strong>CAS</strong> å®‰å…¨è®¾ç½® state</li></ul></li></ul><p>å°è£…çº¿ç¨‹çš„ Node èŠ‚ç‚¹ä¸­ waitstate è®¾è®¡ï¼š</p><ul><li><p>ä½¿ç”¨ <strong>volatile ä¿®é¥°é…åˆ CAS</strong> ä¿è¯å…¶ä¿®æ”¹æ—¶çš„åŸå­æ€§</p></li><li><p>è¡¨ç¤º Node èŠ‚ç‚¹çš„çŠ¶æ€ï¼Œæœ‰ä»¥ä¸‹å‡ ç§çŠ¶æ€ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é»˜è®¤ä¸º 0</span></span><br><span class="line"><span class="keyword">volatile</span> <span class="type">int</span> waitStatus;</span><br><span class="line"><span class="comment">// ç”±äºè¶…æ—¶æˆ–ä¸­æ–­ï¼Œæ­¤èŠ‚ç‚¹è¢«å–æ¶ˆï¼Œä¸ä¼šå†æ”¹å˜çŠ¶æ€</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">CANCELLED</span> <span class="operator">=</span>  <span class="number">1</span>;</span><br><span class="line"><span class="comment">// æ­¤èŠ‚ç‚¹åé¢çš„èŠ‚ç‚¹å·²ï¼ˆæˆ–å³å°†ï¼‰è¢«é˜»æ­¢ï¼ˆé€šè¿‡parkï¼‰ï¼Œã€å½“å‰èŠ‚ç‚¹åœ¨é‡Šæ”¾æˆ–å–æ¶ˆæ—¶å¿…é¡»å”¤é†’åé¢çš„èŠ‚ç‚¹ã€‘</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">SIGNAL</span>    <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line"><span class="comment">// æ­¤èŠ‚ç‚¹å½“å‰åœ¨æ¡ä»¶é˜Ÿåˆ—ä¸­</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">CONDITION</span> <span class="operator">=</span> -<span class="number">2</span>;</span><br><span class="line"><span class="comment">// å°†releaseSharedä¼ æ’­åˆ°å…¶ä»–èŠ‚ç‚¹</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">PROPAGATE</span> <span class="operator">=</span> -<span class="number">3</span>;</span><br></pre></td></tr></table></figure></li></ul><p>é˜»å¡æ¢å¤è®¾è®¡ï¼š</p><ul><li>ä½¿ç”¨ park &amp; unpark æ¥å®ç°çº¿ç¨‹çš„æš‚åœå’Œæ¢å¤ï¼Œå› ä¸ºå‘½ä»¤çš„å…ˆåé¡ºåºä¸å½±å“ç»“æœ</li><li>park &amp; unpark æ˜¯é’ˆå¯¹çº¿ç¨‹çš„ï¼Œè€Œä¸æ˜¯é’ˆå¯¹åŒæ­¥å™¨çš„ï¼Œå› æ­¤æ§åˆ¶ç²’åº¦æ›´ä¸ºç²¾ç»†</li><li>park çº¿ç¨‹å¯ä»¥é€šè¿‡ interrupt æ‰“æ–­</li></ul><p>é˜Ÿåˆ—è®¾è®¡ï¼š</p><ul><li><p>ä½¿ç”¨äº† FIFO å…ˆå…¥å…ˆå‡ºé˜Ÿåˆ—ï¼Œå¹¶ä¸æ”¯æŒä¼˜å…ˆçº§é˜Ÿåˆ—ï¼Œ<strong>åŒæ­¥é˜Ÿåˆ—æ˜¯åŒå‘é“¾è¡¨ï¼Œä¾¿äºå‡ºé˜Ÿå…¥é˜Ÿ</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¤´ç»“ç‚¹ï¼ŒæŒ‡å‘å“‘å…ƒèŠ‚ç‚¹</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> Node head;</span><br><span class="line"><span class="comment">// é˜»å¡é˜Ÿåˆ—çš„å°¾èŠ‚ç‚¹ï¼Œé˜»å¡é˜Ÿåˆ—ä¸åŒ…å«å¤´ç»“ç‚¹ï¼Œä» head.next â†’ tail è®¤ä¸ºæ˜¯é˜»å¡é˜Ÿåˆ—</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> Node tail;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Node</span> &#123;</span><br><span class="line">    <span class="comment">// æšä¸¾ï¼šå…±äº«æ¨¡å¼</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Node</span> <span class="variable">SHARED</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Node</span>();</span><br><span class="line">    <span class="comment">// æšä¸¾ï¼šç‹¬å æ¨¡å¼</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Node</span> <span class="variable">EXCLUSIVE</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">// node éœ€è¦æ„å»ºæˆ FIFO é˜Ÿåˆ—ï¼Œprev æŒ‡å‘å‰ç»§èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">volatile</span> Node prev;</span><br><span class="line">    <span class="comment">// next æŒ‡å‘åç»§èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">volatile</span> Node next;</span><br><span class="line">    <span class="comment">// å½“å‰ node å°è£…çš„çº¿ç¨‹</span></span><br><span class="line">    <span class="keyword">volatile</span> Thread thread;</span><br><span class="line">    <span class="comment">// æ¡ä»¶é˜Ÿåˆ—æ˜¯å•å‘é“¾è¡¨ï¼Œåªæœ‰åç»§æŒ‡é’ˆï¼Œæ¡ä»¶é˜Ÿåˆ—ä½¿ç”¨è¯¥å±æ€§</span></span><br><span class="line">    Node nextWaiter;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/JUC-AQS%E9%98%9F%E5%88%97%E8%AE%BE%E8%AE%A1.png"></p></li><li><p>æ¡ä»¶å˜é‡æ¥å®ç°ç­‰å¾…ã€å”¤é†’æœºåˆ¶ï¼Œæ”¯æŒå¤šä¸ªæ¡ä»¶å˜é‡ï¼Œç±»ä¼¼äº Monitor çš„ WaitSetï¼Œ<strong>æ¡ä»¶é˜Ÿåˆ—æ˜¯å•å‘é“¾è¡¨</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConditionObject</span> <span class="keyword">implements</span> <span class="title class_">Condition</span>, java.io.Serializable &#123;</span><br><span class="line">    <span class="comment">// æŒ‡å‘æ¡ä»¶é˜Ÿåˆ—çš„ç¬¬ä¸€ä¸ª node èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> Node firstWaiter;</span><br><span class="line">    <span class="comment">// æŒ‡å‘æ¡ä»¶é˜Ÿåˆ—çš„æœ€åä¸€ä¸ª node èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> Node lastWaiter;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><hr><h4 id="æ¨¡æ¿å¯¹è±¡"><a href="#æ¨¡æ¿å¯¹è±¡" class="headerlink" title="æ¨¡æ¿å¯¹è±¡"></a>æ¨¡æ¿å¯¹è±¡</h4><p>åŒæ­¥å™¨çš„è®¾è®¡æ˜¯åŸºäºæ¨¡æ¿æ–¹æ³•æ¨¡å¼ï¼Œè¯¥æ¨¡å¼æ˜¯åŸºäºç»§æ‰¿çš„ï¼Œä¸»è¦æ˜¯ä¸ºäº†åœ¨ä¸æ”¹å˜æ¨¡æ¿ç»“æ„çš„å‰æä¸‹åœ¨å­ç±»ä¸­é‡æ–°å®šä¹‰æ¨¡æ¿ä¸­çš„å†…å®¹ä»¥å®ç°å¤ç”¨ä»£ç </p><ul><li>ä½¿ç”¨è€…ç»§æ‰¿ <code>AbstractQueuedSynchronizer</code> å¹¶é‡å†™æŒ‡å®šçš„æ–¹æ³•</li><li>å°† AQS ç»„åˆåœ¨è‡ªå®šä¹‰åŒæ­¥ç»„ä»¶çš„å®ç°ä¸­ï¼Œå¹¶è°ƒç”¨å…¶æ¨¡æ¿æ–¹æ³•ï¼Œè¿™äº›æ¨¡æ¿æ–¹æ³•ä¼šè°ƒç”¨ä½¿ç”¨è€…é‡å†™çš„æ–¹æ³•</li></ul><p>AQS ä½¿ç”¨äº†æ¨¡æ¿æ–¹æ³•æ¨¡å¼ï¼Œè‡ªå®šä¹‰åŒæ­¥å™¨æ—¶éœ€è¦é‡å†™ä¸‹é¢å‡ ä¸ª AQS æä¾›çš„æ¨¡æ¿æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">isHeldExclusively()<span class="comment">//è¯¥çº¿ç¨‹æ˜¯å¦æ­£åœ¨ç‹¬å èµ„æºã€‚åªæœ‰ç”¨åˆ°conditionæ‰éœ€è¦å»å®ç°å®ƒ</span></span><br><span class="line">tryAcquire(<span class="type">int</span>)<span class="comment">//ç‹¬å æ–¹å¼ã€‚å°è¯•è·å–èµ„æºï¼ŒæˆåŠŸåˆ™è¿”å›trueï¼Œå¤±è´¥åˆ™è¿”å›false</span></span><br><span class="line">tryRelease(<span class="type">int</span>)<span class="comment">//ç‹¬å æ–¹å¼ã€‚å°è¯•é‡Šæ”¾èµ„æºï¼ŒæˆåŠŸåˆ™è¿”å›trueï¼Œå¤±è´¥åˆ™è¿”å›false</span></span><br><span class="line">tryAcquireShared(<span class="type">int</span>)<span class="comment">//å…±äº«æ–¹å¼ã€‚å°è¯•è·å–èµ„æºã€‚è´Ÿæ•°è¡¨ç¤ºå¤±è´¥ï¼›0è¡¨ç¤ºæˆåŠŸä½†æ²¡æœ‰å‰©ä½™å¯ç”¨èµ„æºï¼›æ­£æ•°è¡¨ç¤ºæˆåŠŸä¸”æœ‰å‰©ä½™èµ„æº</span></span><br><span class="line">tryReleaseShared(<span class="type">int</span>)<span class="comment">//å…±äº«æ–¹å¼ã€‚å°è¯•é‡Šæ”¾èµ„æºï¼ŒæˆåŠŸåˆ™è¿”å›trueï¼Œå¤±è´¥åˆ™è¿”å›false</span></span><br></pre></td></tr></table></figure><ul><li>é»˜è®¤æƒ…å†µä¸‹ï¼Œæ¯ä¸ªæ–¹æ³•éƒ½æŠ›å‡º <code>UnsupportedOperationException</code></li><li>è¿™äº›æ–¹æ³•çš„å®ç°å¿…é¡»æ˜¯å†…éƒ¨çº¿ç¨‹å®‰å…¨çš„</li><li>AQS ç±»ä¸­çš„å…¶ä»–æ–¹æ³•éƒ½æ˜¯ final ï¼Œæ‰€ä»¥æ— æ³•è¢«å…¶ä»–ç±»ä½¿ç”¨ï¼Œåªæœ‰è¿™å‡ ä¸ªæ–¹æ³•å¯ä»¥è¢«å…¶ä»–ç±»ä½¿ç”¨</li></ul><hr><h4 id="è‡ªå®šä¹‰"><a href="#è‡ªå®šä¹‰" class="headerlink" title="è‡ªå®šä¹‰"></a>è‡ªå®šä¹‰</h4><p>è‡ªå®šä¹‰ä¸€ä¸ªä¸å¯é‡å…¥é”ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyLock</span> <span class="keyword">implements</span> <span class="title class_">Lock</span> &#123;</span><br><span class="line">    <span class="comment">//ç‹¬å é” ä¸å¯é‡å…¥</span></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">MySync</span> <span class="keyword">extends</span> <span class="title class_">AbstractQueuedSynchronizer</span> &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">tryAcquire</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, <span class="number">1</span>)) &#123;</span><br><span class="line">                <span class="comment">// åŠ ä¸Šé” è®¾ç½® owner ä¸ºå½“å‰çº¿ç¨‹</span></span><br><span class="line">                setExclusiveOwnerThread(Thread.currentThread());</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span>   <span class="comment">//è§£é”</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">tryRelease</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">            setExclusiveOwnerThread(<span class="literal">null</span>);</span><br><span class="line">            setState(<span class="number">0</span>);<span class="comment">//volatile ä¿®é¥°çš„å˜é‡æ”¾åœ¨åé¢ï¼Œé˜²æ­¢æŒ‡ä»¤é‡æ’</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="meta">@Override</span>   <span class="comment">//æ˜¯å¦æŒæœ‰ç‹¬å é”</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">isHeldExclusively</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> getState() == <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">public</span> Condition <span class="title function_">newCondition</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ConditionObject</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">MySync</span> <span class="variable">sync</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MySync</span>();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span>   <span class="comment">//åŠ é”ï¼ˆä¸æˆåŠŸè¿›å…¥ç­‰å¾…é˜Ÿåˆ—ç­‰å¾…ï¼‰</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span> &#123;</span><br><span class="line">        sync.acquire(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span>   <span class="comment">//åŠ é” å¯æ‰“æ–­</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">lockInterruptibly</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        sync.acquireInterruptibly(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span>   <span class="comment">//å°è¯•åŠ é”ï¼Œå°è¯•ä¸€æ¬¡</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> sync.tryAcquire(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span>   <span class="comment">//å°è¯•åŠ é”ï¼Œå¸¦è¶…æ—¶</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">(<span class="type">long</span> time, TimeUnit unit)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="keyword">return</span> sync.tryAcquireNanos(<span class="number">1</span>, unit.toNanos(time));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span>   <span class="comment">//è§£é”</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">()</span> &#123;</span><br><span class="line">        sync.release(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span>   <span class="comment">//æ¡ä»¶å˜é‡</span></span><br><span class="line">    <span class="keyword">public</span> Condition <span class="title function_">newCondition</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> sync.newCondition();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h3 id="Re-Lock"><a href="#Re-Lock" class="headerlink" title="Re-Lock"></a>Re-Lock</h3><h4 id="é”å¯¹æ¯”"><a href="#é”å¯¹æ¯”" class="headerlink" title="é”å¯¹æ¯”"></a>é”å¯¹æ¯”</h4><p>ReentrantLock ç›¸å¯¹äº synchronized å…·å¤‡å¦‚ä¸‹ç‰¹ç‚¹ï¼š</p><ol><li>é”çš„å®ç°ï¼šsynchronized æ˜¯ JVM å®ç°çš„ï¼Œè€Œ ReentrantLock æ˜¯ JDK å®ç°çš„</li><li>æ€§èƒ½ï¼šæ–°ç‰ˆæœ¬ Java å¯¹ synchronized è¿›è¡Œäº†å¾ˆå¤šä¼˜åŒ–ï¼Œsynchronized ä¸ ReentrantLock å¤§è‡´ç›¸åŒ</li><li>ä½¿ç”¨ï¼šReentrantLock éœ€è¦æ‰‹åŠ¨è§£é”ï¼Œsynchronized æ‰§è¡Œå®Œä»£ç å—è‡ªåŠ¨è§£é”</li><li><strong>å¯ä¸­æ–­</strong>ï¼šReentrantLock å¯ä¸­æ–­ï¼Œè€Œ synchronized ä¸è¡Œ</li><li><strong>å…¬å¹³é”</strong>ï¼šå…¬å¹³é”æ˜¯æŒ‡å¤šä¸ªçº¿ç¨‹åœ¨ç­‰å¾…åŒä¸€ä¸ªé”æ—¶ï¼Œå¿…é¡»æŒ‰ç…§ç”³è¯·é”çš„æ—¶é—´é¡ºåºæ¥ä¾æ¬¡è·å¾—é”<ul><li>ReentrantLock å¯ä»¥è®¾ç½®å…¬å¹³é”ï¼Œsynchronized ä¸­çš„é”æ˜¯éå…¬å¹³çš„</li><li>ä¸å…¬å¹³é”çš„å«ä¹‰æ˜¯é˜»å¡é˜Ÿåˆ—å†…å…¬å¹³ï¼Œé˜Ÿåˆ—å¤–éå…¬å¹³</li></ul></li><li>é”è¶…æ—¶ï¼šå°è¯•è·å–é”ï¼Œè¶…æ—¶è·å–ä¸åˆ°ç›´æ¥æ”¾å¼ƒï¼Œä¸è¿›å…¥é˜»å¡é˜Ÿåˆ—<ul><li>ReentrantLock å¯ä»¥è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œsynchronized ä¼šä¸€ç›´ç­‰å¾…</li></ul></li><li>é”ç»‘å®šå¤šä¸ªæ¡ä»¶ï¼šä¸€ä¸ª ReentrantLock å¯ä»¥åŒæ—¶ç»‘å®šå¤šä¸ª Condition å¯¹è±¡ï¼Œæ›´ç»†ç²’åº¦çš„å”¤é†’çº¿ç¨‹</li><li>ä¸¤è€…éƒ½æ˜¯å¯é‡å…¥é”</li></ol><hr><h4 id="ä½¿ç”¨é”-1"><a href="#ä½¿ç”¨é”-1" class="headerlink" title="ä½¿ç”¨é”"></a>ä½¿ç”¨é”</h4><p>æ„é€ æ–¹æ³•ï¼š<code>ReentrantLock lock = new ReentrantLock();</code></p><p>ReentrantLock ç±» APIï¼š</p><ul><li><p><code>public void lock()</code>ï¼šè·å¾—é”</p><ul><li><p>å¦‚æœé”æ²¡æœ‰è¢«å¦ä¸€ä¸ªçº¿ç¨‹å ç”¨ï¼Œåˆ™å°†é”å®šè®¡æ•°è®¾ç½®ä¸º 1</p></li><li><p>å¦‚æœå½“å‰çº¿ç¨‹å·²ç»ä¿æŒé”å®šï¼Œåˆ™ä¿æŒè®¡æ•°å¢åŠ  1 </p></li><li><p>å¦‚æœé”è¢«å¦ä¸€ä¸ªçº¿ç¨‹ä¿æŒï¼Œåˆ™å½“å‰çº¿ç¨‹è¢«ç¦ç”¨çº¿ç¨‹è°ƒåº¦ï¼Œå¹¶ä¸”åœ¨é”å®šå·²è¢«è·å–ä¹‹å‰å¤„äºä¼‘çœ çŠ¶æ€</p></li></ul></li><li><p><code>public void unlock()</code>ï¼šå°è¯•é‡Šæ”¾é”</p><ul><li>å¦‚æœå½“å‰çº¿ç¨‹æ˜¯è¯¥é”çš„æŒæœ‰è€…ï¼Œåˆ™ä¿æŒè®¡æ•°é€’å‡</li><li>å¦‚æœä¿æŒè®¡æ•°ç°åœ¨ä¸ºé›¶ï¼Œåˆ™é”å®šè¢«é‡Šæ”¾</li><li>å¦‚æœå½“å‰çº¿ç¨‹ä¸æ˜¯è¯¥é”çš„æŒæœ‰è€…ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸</li></ul></li></ul><p>åŸºæœ¬è¯­æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è·å–é”</span></span><br><span class="line">reentrantLock.lock();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// ä¸´ç•ŒåŒº</span></span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line"><span class="comment">// é‡Šæ”¾é”</span></span><br><span class="line">reentrantLock.unlock();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h4 id="å…¬å¹³é”"><a href="#å…¬å¹³é”" class="headerlink" title="å…¬å¹³é”"></a>å…¬å¹³é”</h4><h5 id="åŸºæœ¬ä½¿ç”¨-3"><a href="#åŸºæœ¬ä½¿ç”¨-3" class="headerlink" title="åŸºæœ¬ä½¿ç”¨"></a>åŸºæœ¬ä½¿ç”¨</h5><p>æ„é€ æ–¹æ³•ï¼š<code>ReentrantLock lock = new ReentrantLock(true)</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ReentrantLock</span><span class="params">(<span class="type">boolean</span> fair)</span> &#123;</span><br><span class="line">    sync = fair ? <span class="keyword">new</span> <span class="title class_">FairSync</span>() : <span class="keyword">new</span> <span class="title class_">NonfairSync</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ReentrantLock é»˜è®¤æ˜¯ä¸å…¬å¹³çš„ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ReentrantLock</span><span class="params">()</span> &#123;</span><br><span class="line">    sync = <span class="keyword">new</span> <span class="title class_">NonfairSync</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯´æ˜ï¼šå…¬å¹³é”ä¸€èˆ¬æ²¡æœ‰å¿…è¦ï¼Œä¼šé™ä½å¹¶å‘åº¦</p><hr><h5 id="éå…¬åŸç†"><a href="#éå…¬åŸç†" class="headerlink" title="éå…¬åŸç†"></a>éå…¬åŸç†</h5><h6 id="åŠ é”"><a href="#åŠ é”" class="headerlink" title="åŠ é”"></a>åŠ é”</h6><p>NonfairSync ç»§æ‰¿è‡ª AQS</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span> &#123;</span><br><span class="line">    sync.lock();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>æ²¡æœ‰ç«äº‰ï¼šExclusiveOwnerThread å±äº Thread-0ï¼Œstate è®¾ç½®ä¸º 1</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ReentrantLock.NonfairSync#lock</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// ç”¨ cas å°è¯•ï¼ˆä»…å°è¯•ä¸€æ¬¡ï¼‰å°† state ä» 0 æ”¹ä¸º 1, å¦‚æœæˆåŠŸè¡¨ç¤ºã€è·å¾—äº†ç‹¬å é”ã€‘</span></span><br><span class="line">    <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, <span class="number">1</span>))</span><br><span class="line">        <span class="comment">// è®¾ç½®å½“å‰çº¿ç¨‹ä¸ºç‹¬å çº¿ç¨‹</span></span><br><span class="line">        setExclusiveOwnerThread(Thread.currentThread());</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        acquire(<span class="number">1</span>);<span class="comment">//å¤±è´¥è¿›å…¥</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>ç¬¬ä¸€ä¸ªç«äº‰å‡ºç°ï¼šThread-1 æ‰§è¡Œï¼ŒCAS å°è¯•å°† state ç”± 0 æ”¹ä¸º 1ï¼Œç»“æœå¤±è´¥ï¼ˆç¬¬ä¸€æ¬¡ï¼‰ï¼Œè¿›å…¥ acquire é€»è¾‘</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AbstractQueuedSynchronizer#acquire</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">acquire</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">    <span class="comment">// tryAcquire å°è¯•è·å–é”å¤±è´¥æ—¶, ä¼šè°ƒç”¨ addWaiter å°†å½“å‰çº¿ç¨‹å°è£…æˆnodeå…¥é˜Ÿï¼ŒacquireQueued é˜»å¡å½“å‰çº¿ç¨‹ï¼Œ</span></span><br><span class="line">    <span class="comment">// acquireQueued è¿”å› true è¡¨ç¤ºæŒ‚èµ·è¿‡ç¨‹ä¸­çº¿ç¨‹è¢«ä¸­æ–­å”¤é†’è¿‡ï¼Œfalse è¡¨ç¤ºæœªè¢«ä¸­æ–­è¿‡</span></span><br><span class="line">    <span class="keyword">if</span> (!tryAcquire(arg) &amp;&amp; acquireQueued(addWaiter(Node.EXCLUSIVE), arg))</span><br><span class="line">        <span class="comment">// å¦‚æœçº¿ç¨‹è¢«ä¸­æ–­äº†é€»è¾‘æ¥åˆ°è¿™ï¼Œå®Œæˆä¸€æ¬¡çœŸæ­£çš„æ‰“æ–­æ•ˆæœ</span></span><br><span class="line">        selfInterrupt();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/JUC-ReentrantLock-éå…¬å¹³é”1.png" style="zoom:80%;" /><ul><li><p>è¿›å…¥ tryAcquire å°è¯•è·å–é”é€»è¾‘ï¼Œè¿™æ—¶ state å·²ç»æ˜¯1ï¼Œç»“æœä»ç„¶å¤±è´¥ï¼ˆç¬¬äºŒæ¬¡ï¼‰ï¼ŒåŠ é”æˆåŠŸæœ‰ä¸¤ç§æƒ…å†µï¼š</p><ul><li>å½“å‰ AQS å¤„äºæ— é”çŠ¶æ€</li><li>åŠ é”çº¿ç¨‹å°±æ˜¯å½“å‰çº¿ç¨‹ï¼Œè¯´æ˜å‘ç”Ÿäº†é”é‡å…¥</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ReentrantLock.NonfairSync#tryAcquire</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">tryAcquire</span><span class="params">(<span class="type">int</span> acquires)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> nonfairTryAcquire(acquires);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// æŠ¢å æˆåŠŸè¿”å› trueï¼ŒæŠ¢å å¤±è´¥è¿”å› false</span></span><br><span class="line"><span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">nonfairTryAcquire</span><span class="params">(<span class="type">int</span> acquires)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">Thread</span> <span class="variable">current</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">    <span class="comment">// state å€¼</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> getState();</span><br><span class="line">    <span class="comment">// æ¡ä»¶æˆç«‹è¯´æ˜å½“å‰å¤„äºã€æ— é”çŠ¶æ€ã€‘</span></span><br><span class="line">    <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">//å¦‚æœè¿˜æ²¡æœ‰è·å¾—é”ï¼Œå°è¯•ç”¨casè·å¾—ï¼Œè¿™é‡Œä½“ç°éå…¬å¹³æ€§: ä¸å»æ£€æŸ¥ AQS é˜Ÿåˆ—æ˜¯å¦æœ‰é˜»å¡çº¿ç¨‹ç›´æ¥è·å–é”        </span></span><br><span class="line">    <span class="keyword">if</span> (compareAndSetState(<span class="number">0</span>, acquires)) &#123;</span><br><span class="line">            <span class="comment">// è·å–é”æˆåŠŸè®¾ç½®å½“å‰çº¿ç¨‹ä¸ºç‹¬å é”çº¿ç¨‹ã€‚</span></span><br><span class="line">            setExclusiveOwnerThread(current);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">         &#125;    </span><br><span class="line">&#125;    </span><br><span class="line">   <span class="comment">// å¦‚æœå·²ç»æœ‰çº¿ç¨‹è·å¾—äº†é”, ç‹¬å é”çº¿ç¨‹è¿˜æ˜¯å½“å‰çº¿ç¨‹, è¡¨ç¤ºã€å‘ç”Ÿäº†é”é‡å…¥ã€‘</span></span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (current == getExclusiveOwnerThread()) &#123;</span><br><span class="line">        <span class="comment">// æ›´æ–°é”é‡å…¥çš„å€¼</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">nextc</span> <span class="operator">=</span> c + acquires;</span><br><span class="line">        <span class="comment">// è¶Šç•Œåˆ¤æ–­ï¼Œå½“é‡å…¥çš„æ·±åº¦å¾ˆæ·±æ—¶ï¼Œä¼šå¯¼è‡´ nextc &lt; 0ï¼Œintå€¼è¾¾åˆ°æœ€å¤§ä¹‹åå† + 1 å˜è´Ÿæ•°</span></span><br><span class="line">        <span class="keyword">if</span> (nextc &lt; <span class="number">0</span>) <span class="comment">// overflow</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;Maximum lock count exceeded&quot;</span>);</span><br><span class="line">        <span class="comment">// æ›´æ–° state çš„å€¼ï¼Œè¿™é‡Œä¸ä½¿ç”¨ cas æ˜¯å› ä¸ºå½“å‰çº¿ç¨‹æ­£åœ¨æŒæœ‰é”ï¼Œæ‰€ä»¥è¿™é‡Œçš„æ“ä½œç›¸å½“äºåœ¨ä¸€ä¸ªç®¡ç¨‹å†…</span></span><br><span class="line">        setState(nextc);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è·å–å¤±è´¥</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>æ¥ä¸‹æ¥è¿›å…¥ addWaiter é€»è¾‘ï¼Œæ„é€  Node é˜Ÿåˆ—ï¼ˆä¸æ˜¯é˜»å¡é˜Ÿåˆ—ï¼‰ï¼Œå‰ç½®æ¡ä»¶æ˜¯å½“å‰çº¿ç¨‹è·å–é”å¤±è´¥ï¼Œè¯´æ˜æœ‰çº¿ç¨‹å ç”¨äº†é”</p><ul><li>å›¾ä¸­é»„è‰²ä¸‰è§’è¡¨ç¤ºè¯¥ Node çš„ waitStatus çŠ¶æ€ï¼Œå…¶ä¸­ 0 ä¸ºé»˜è®¤<strong>æ­£å¸¸çŠ¶æ€</strong></li><li>Node çš„åˆ›å»ºæ˜¯æ‡’æƒ°çš„ï¼Œå…¶ä¸­ç¬¬ä¸€ä¸ª Node ç§°ä¸º <strong>Dummyï¼ˆå“‘å…ƒï¼‰æˆ–å“¨å…µ</strong>ï¼Œç”¨æ¥å ä½ï¼Œå¹¶ä¸å…³è”çº¿ç¨‹</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AbstractQueuedSynchronizer#addWaiterï¼Œè¿”å›å½“å‰çº¿ç¨‹çš„ node èŠ‚ç‚¹</span></span><br><span class="line"><span class="keyword">private</span> Node <span class="title function_">addWaiter</span><span class="params">(Node mode)</span> &#123;</span><br><span class="line">    <span class="comment">// å°†å½“å‰çº¿ç¨‹å…³è”åˆ°ä¸€ä¸ª Node å¯¹è±¡ä¸Š, æ¨¡å¼ä¸ºç‹¬å æ¨¡å¼   </span></span><br><span class="line">    <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Node</span>(Thread.currentThread(), mode);</span><br><span class="line">    <span class="type">Node</span> <span class="variable">pred</span> <span class="operator">=</span> tail;</span><br><span class="line">    <span class="comment">// å¿«é€Ÿå…¥é˜Ÿï¼Œå¦‚æœ tail ä¸ä¸º nullï¼Œè¯´æ˜å­˜åœ¨é˜Ÿåˆ—</span></span><br><span class="line">    <span class="keyword">if</span> (pred != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// å°†å½“å‰èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹æŒ‡å‘ å°¾èŠ‚ç‚¹</span></span><br><span class="line">        node.prev = pred;</span><br><span class="line">        <span class="comment">// é€šè¿‡ cas å°† Node å¯¹è±¡åŠ å…¥ AQS é˜Ÿåˆ—ï¼Œæˆä¸ºå°¾èŠ‚ç‚¹ï¼Œã€å°¾æ’æ³•ã€‘</span></span><br><span class="line">        <span class="keyword">if</span> (compareAndSetTail(pred, node)) &#123;</span><br><span class="line">            pred.next = node;<span class="comment">// åŒå‘é“¾è¡¨</span></span><br><span class="line">            <span class="keyword">return</span> node;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// åˆå§‹æ—¶é˜Ÿåˆ—ä¸ºç©ºï¼Œæˆ–è€… CAS å¤±è´¥è¿›å…¥è¿™é‡Œ</span></span><br><span class="line">    enq(node);</span><br><span class="line">    <span class="keyword">return</span> node;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AbstractQueuedSynchronizer#enq</span></span><br><span class="line"><span class="keyword">private</span> Node <span class="title function_">enq</span><span class="params">(<span class="keyword">final</span> Node node)</span> &#123;</span><br><span class="line">    <span class="comment">// è‡ªæ—‹å…¥é˜Ÿï¼Œå¿…é¡»å…¥é˜ŸæˆåŠŸæ‰ç»“æŸå¾ªç¯</span></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="type">Node</span> <span class="variable">t</span> <span class="operator">=</span> tail;</span><br><span class="line">        <span class="comment">// è¯´æ˜å½“å‰é”è¢«å ç”¨ï¼Œä¸”å½“å‰çº¿ç¨‹å¯èƒ½æ˜¯ã€ç¬¬ä¸€ä¸ªè·å–é”å¤±è´¥ã€‘çš„çº¿ç¨‹ï¼Œã€è¿˜æ²¡æœ‰å»ºç«‹é˜Ÿåˆ—ã€‘</span></span><br><span class="line">        <span class="keyword">if</span> (t == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// è®¾ç½®ä¸€ä¸ªã€å“‘å…ƒèŠ‚ç‚¹ã€‘ï¼Œå¤´å°¾æŒ‡é’ˆéƒ½æŒ‡å‘è¯¥èŠ‚ç‚¹</span></span><br><span class="line">            <span class="keyword">if</span> (compareAndSetHead(<span class="keyword">new</span> <span class="title class_">Node</span>()))</span><br><span class="line">                tail = head;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// è‡ªæ—‹åˆ°è¿™ï¼Œæ™®é€šå…¥é˜Ÿæ–¹å¼ï¼Œé¦–å…ˆèµ‹å€¼å°¾èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹ã€å°¾æ’æ³•ã€‘</span></span><br><span class="line">            node.prev = t;</span><br><span class="line">            <span class="comment">// ã€åœ¨è®¾ç½®å®Œå°¾èŠ‚ç‚¹åï¼Œæ‰æ›´æ–°çš„åŸå§‹å°¾èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹ï¼Œæ‰€ä»¥æ­¤æ—¶ä»å‰å¾€åéå†ä¼šä¸¢å¤±å°¾èŠ‚ç‚¹ã€‘</span></span><br><span class="line">            <span class="keyword">if</span> (compareAndSetTail(t, node)) &#123;</span><br><span class="line">                <span class="comment">//ã€æ­¤æ—¶ t.next  = nullï¼Œå¹¶ä¸”è¿™é‡Œå·²ç» CAS ç»“æŸï¼Œçº¿ç¨‹å¹¶ä¸æ˜¯å®‰å…¨çš„ã€‘</span></span><br><span class="line">                t.next = node;</span><br><span class="line">                <span class="keyword">return</span> t;<span class="comment">// è¿”å›å½“å‰ node çš„å‰é©±èŠ‚ç‚¹</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/JUC-ReentrantLock-éå…¬å¹³é”2.png" style="zoom:80%;" /></li><li><p>çº¿ç¨‹èŠ‚ç‚¹åŠ å…¥é˜Ÿåˆ—æˆåŠŸï¼Œè¿›å…¥ AbstractQueuedSynchronizer#acquireQueued é€»è¾‘é˜»å¡çº¿ç¨‹</p><ul><li><p>acquireQueued ä¼šåœ¨ä¸€ä¸ªè‡ªæ—‹ä¸­ä¸æ–­å°è¯•è·å¾—é”ï¼Œå¤±è´¥åè¿›å…¥ park é˜»å¡</p></li><li><p>å¦‚æœå½“å‰çº¿ç¨‹æ˜¯åœ¨ head èŠ‚ç‚¹åï¼Œä¼šå†æ¬¡ tryAcquire å°è¯•è·å–é”ï¼Œstate ä»ä¸º 1 åˆ™å¤±è´¥ï¼ˆç¬¬ä¸‰æ¬¡ï¼‰</p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">acquireQueued</span><span class="params">(<span class="keyword">final</span> Node node, <span class="type">int</span> arg)</span> &#123;</span><br><span class="line">    <span class="comment">// true è¡¨ç¤ºå½“å‰çº¿ç¨‹æŠ¢å é”å¤±è´¥ï¼Œfalse è¡¨ç¤ºæˆåŠŸ</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">failed</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// ä¸­æ–­æ ‡è®°ï¼Œè¡¨ç¤ºå½“å‰çº¿ç¨‹æ˜¯å¦è¢«ä¸­æ–­</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">interrupted</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="comment">// è·å¾—å½“å‰çº¿ç¨‹èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">Node</span> <span class="variable">p</span> <span class="operator">=</span> node.predecessor();</span><br><span class="line">            <span class="comment">// å‰é©±èŠ‚ç‚¹æ˜¯ head, FIFO é˜Ÿåˆ—çš„ç‰¹æ€§è¡¨ç¤ºè½®åˆ°å½“å‰çº¿ç¨‹å¯ä»¥å»è·å–é”</span></span><br><span class="line">            <span class="keyword">if</span> (p == head &amp;&amp; tryAcquire(arg)) &#123;</span><br><span class="line">                <span class="comment">// è·å–æˆåŠŸ, è®¾ç½®å½“å‰çº¿ç¨‹è‡ªå·±çš„ node ä¸º head</span></span><br><span class="line">                setHead(node);</span><br><span class="line">                p.next = <span class="literal">null</span>; <span class="comment">// help GC</span></span><br><span class="line">                <span class="comment">// è¡¨ç¤ºæŠ¢å é”æˆåŠŸ</span></span><br><span class="line">                failed = <span class="literal">false</span>;</span><br><span class="line">                <span class="comment">// è¿”å›å½“å‰çº¿ç¨‹æ˜¯å¦è¢«ä¸­æ–­</span></span><br><span class="line">                <span class="keyword">return</span> interrupted;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// åˆ¤æ–­æ˜¯å¦åº”å½“ parkï¼Œè¿”å› false åéœ€è¦æ–°ä¸€è½®çš„å¾ªç¯ï¼Œè¿”å› true è¿›å…¥æ¡ä»¶äºŒé˜»å¡çº¿ç¨‹</span></span><br><span class="line">            <span class="keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp; parkAndCheckInterrupt())</span><br><span class="line">                <span class="comment">// æ¡ä»¶äºŒè¿”å›ç»“æœæ˜¯å½“å‰çº¿ç¨‹æ˜¯å¦è¢«æ‰“æ–­ï¼Œæ²¡æœ‰è¢«æ‰“æ–­è¿”å› false ä¸è¿›å…¥è¿™é‡Œçš„é€»è¾‘</span></span><br><span class="line">                <span class="comment">// ã€å°±ç®—è¢«æ‰“æ–­äº†ï¼Œä¹Ÿä¼šç»§ç»­å¾ªç¯ï¼Œå¹¶ä¸ä¼šè¿”å›ã€‘</span></span><br><span class="line">                interrupted = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// ã€å¯æ‰“æ–­æ¨¡å¼ä¸‹æ‰ä¼šè¿›å…¥è¯¥é€»è¾‘ã€‘</span></span><br><span class="line">        <span class="keyword">if</span> (failed)</span><br><span class="line">            cancelAcquire(node);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>è¿›å…¥ shouldParkAfterFailedAcquire é€»è¾‘ï¼Œ<strong>å°†å‰é©± node çš„ waitStatus æ”¹ä¸º -1</strong>ï¼Œè¿”å› falseï¼›waitStatus ä¸º -1 çš„èŠ‚ç‚¹ç”¨æ¥å”¤é†’ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">shouldParkAfterFailedAcquire</span><span class="params">(Node pred, Node node)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">ws</span> <span class="operator">=</span> pred.waitStatus;</span><br><span class="line">    <span class="comment">// è¡¨ç¤ºå‰ç½®èŠ‚ç‚¹æ˜¯ä¸ªå¯ä»¥å”¤é†’å½“å‰èŠ‚ç‚¹çš„èŠ‚ç‚¹ï¼Œè¿”å› true</span></span><br><span class="line">    <span class="keyword">if</span> (ws == Node.SIGNAL)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="comment">// å‰ç½®èŠ‚ç‚¹çš„çŠ¶æ€å¤„äºå–æ¶ˆçŠ¶æ€ï¼Œéœ€è¦ã€åˆ é™¤å‰é¢æ‰€æœ‰å–æ¶ˆçš„èŠ‚ç‚¹ã€‘, è¿”å›åˆ°å¤–å±‚å¾ªç¯é‡è¯•</span></span><br><span class="line">    <span class="keyword">if</span> (ws &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            node.prev = pred = pred.prev;</span><br><span class="line">        &#125; <span class="keyword">while</span> (pred.waitStatus &gt; <span class="number">0</span>);</span><br><span class="line">        <span class="comment">// è·å–åˆ°éå–æ¶ˆçš„èŠ‚ç‚¹ï¼Œè¿æ¥ä¸Šå½“å‰èŠ‚ç‚¹</span></span><br><span class="line">        pred.next = node;</span><br><span class="line">    <span class="comment">// é»˜è®¤æƒ…å†µä¸‹ node çš„ waitStatus æ˜¯ 0ï¼Œè¿›å…¥è¿™é‡Œçš„é€»è¾‘</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// ã€è®¾ç½®ä¸Šä¸€ä¸ªèŠ‚ç‚¹çŠ¶æ€ä¸º Node.SIGNALã€‘ï¼Œè¿”å›å¤–å±‚å¾ªç¯é‡è¯•</span></span><br><span class="line">        compareAndSetWaitStatus(pred, ws, Node.SIGNAL);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è¿”å›ä¸åº”è¯¥ parkï¼Œå†æ¬¡å°è¯•ä¸€æ¬¡</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>shouldParkAfterFailedAcquire æ‰§è¡Œå®Œæ¯•å›åˆ° acquireQueued ï¼Œå†æ¬¡ tryAcquire å°è¯•è·å–é”ï¼Œè¿™æ—¶ state ä»ä¸º 1 è·å–å¤±è´¥ï¼ˆç¬¬å››æ¬¡ï¼‰</li><li>å½“å†æ¬¡è¿›å…¥ shouldParkAfterFailedAcquire æ—¶ï¼Œè¿™æ—¶å…¶å‰é©± node çš„ waitStatus å·²ç»æ˜¯ -1 äº†ï¼Œè¿”å› true</li><li>è¿›å…¥ parkAndCheckInterruptï¼Œ Thread-1 parkï¼ˆç°è‰²è¡¨ç¤ºï¼‰</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">parkAndCheckInterrupt</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// é˜»å¡å½“å‰çº¿ç¨‹ï¼Œå¦‚æœæ‰“æ–­æ ‡è®°å·²ç»æ˜¯ true, åˆ™ park ä¼šå¤±æ•ˆ</span></span><br><span class="line">    LockSupport.park(<span class="built_in">this</span>);</span><br><span class="line">    <span class="comment">// åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦è¢«æ‰“æ–­ï¼Œæ¸…é™¤æ‰“æ–­æ ‡è®°</span></span><br><span class="line">    <span class="keyword">return</span> Thread.interrupted();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>å†æœ‰å¤šä¸ªçº¿ç¨‹ç»å†ç«äº‰å¤±è´¥åï¼š</p><p><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/JUC-ReentrantLock-%E9%9D%9E%E5%85%AC%E5%B9%B3%E9%94%813.png"></p></li></ul><hr><h6 id="è§£é”"><a href="#è§£é”" class="headerlink" title="è§£é”"></a>è§£é”</h6><p>ReentrantLock#unlockï¼šé‡Šæ”¾é”</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">()</span> &#123;</span><br><span class="line">    sync.release(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Thread-0 é‡Šæ”¾é”ï¼Œè¿›å…¥ release æµç¨‹</p><ul><li><p>è¿›å…¥ tryReleaseï¼Œè®¾ç½® exclusiveOwnerThread ä¸º nullï¼Œstate &#x3D; 0</p></li><li><p>å½“å‰é˜Ÿåˆ—ä¸ä¸º nullï¼Œå¹¶ä¸” head çš„ waitStatus &#x3D; -1ï¼Œè¿›å…¥ unparkSuccessor</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AbstractQueuedSynchronizer#release</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">release</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">    <span class="comment">// å°è¯•é‡Šæ”¾é”ï¼ŒtryRelease è¿”å› true è¡¨ç¤ºå½“å‰çº¿ç¨‹å·²ç»ã€å®Œå…¨é‡Šæ”¾é”ï¼Œé‡å…¥çš„é‡Šæ”¾äº†ã€‘</span></span><br><span class="line">    <span class="keyword">if</span> (tryRelease(arg)) &#123;</span><br><span class="line">        <span class="comment">// é˜Ÿåˆ—å¤´èŠ‚ç‚¹</span></span><br><span class="line">        <span class="type">Node</span> <span class="variable">h</span> <span class="operator">=</span> head;</span><br><span class="line">        <span class="comment">// å¤´èŠ‚ç‚¹ä»€ä¹ˆæ—¶å€™æ˜¯ç©ºï¼Ÿæ²¡æœ‰å‘ç”Ÿé”ç«äº‰ï¼Œæ²¡æœ‰ç«äº‰çº¿ç¨‹åˆ›å»ºå“‘å…ƒèŠ‚ç‚¹</span></span><br><span class="line">        <span class="comment">// æ¡ä»¶æˆç«‹è¯´æ˜é˜»å¡é˜Ÿåˆ—æœ‰ç­‰å¾…çº¿ç¨‹ï¼Œéœ€è¦å”¤é†’ head èŠ‚ç‚¹åé¢çš„çº¿ç¨‹</span></span><br><span class="line">        <span class="keyword">if</span> (h != <span class="literal">null</span> &amp;&amp; h.waitStatus != <span class="number">0</span>)</span><br><span class="line">            unparkSuccessor(h);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ReentrantLock.Sync#tryRelease</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">tryRelease</span><span class="params">(<span class="type">int</span> releases)</span> &#123;</span><br><span class="line">    <span class="comment">// å‡å»é‡Šæ”¾çš„å€¼ï¼Œå¯èƒ½é‡å…¥</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> getState() - releases;</span><br><span class="line">    <span class="comment">// å¦‚æœå½“å‰çº¿ç¨‹ä¸æ˜¯æŒæœ‰é”çš„çº¿ç¨‹ç›´æ¥æŠ¥é”™</span></span><br><span class="line">    <span class="keyword">if</span> (Thread.currentThread() != getExclusiveOwnerThread())</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalMonitorStateException</span>();</span><br><span class="line">    <span class="comment">// æ˜¯å¦å·²ç»å®Œå…¨é‡Šæ”¾é”</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">free</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">// æ”¯æŒé”é‡å…¥, åªæœ‰ state å‡ä¸º 0, æ‰å®Œå…¨é‡Šæ”¾é”æˆåŠŸ</span></span><br><span class="line">    <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">        free = <span class="literal">true</span>;</span><br><span class="line">        setExclusiveOwnerThread(<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å½“å‰çº¿ç¨‹å°±æ˜¯æŒæœ‰é”çº¿ç¨‹ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥æ›´æ–°é”ï¼Œä¸éœ€è¦ä½¿ç”¨ CAS</span></span><br><span class="line">    setState(c);</span><br><span class="line">    <span class="keyword">return</span> free;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>è¿›å…¥ AbstractQueuedSynchronizer#unparkSuccessor æ–¹æ³•ï¼Œå”¤é†’å½“å‰èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹</p><ul><li>æ‰¾åˆ°é˜Ÿåˆ—ä¸­è·ç¦» head æœ€è¿‘çš„ä¸€ä¸ªæ²¡å–æ¶ˆçš„ Nodeï¼Œunpark æ¢å¤å…¶è¿è¡Œï¼Œæœ¬ä¾‹ä¸­å³ä¸º Thread-1</li><li>å›åˆ° Thread-1 çš„ acquireQueued æµç¨‹</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">unparkSuccessor</span><span class="params">(Node node)</span> &#123;</span><br><span class="line">    <span class="comment">// å½“å‰èŠ‚ç‚¹çš„çŠ¶æ€</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">ws</span> <span class="operator">=</span> node.waitStatus;    </span><br><span class="line">    <span class="keyword">if</span> (ws &lt; <span class="number">0</span>)        </span><br><span class="line">        <span class="comment">// ã€å°è¯•é‡ç½®çŠ¶æ€ä¸º 0ã€‘ï¼Œå› ä¸ºå½“å‰èŠ‚ç‚¹è¦å®Œæˆå¯¹åç»­èŠ‚ç‚¹çš„å”¤é†’ä»»åŠ¡äº†ï¼Œä¸éœ€è¦ -1 äº†</span></span><br><span class="line">        compareAndSetWaitStatus(node, ws, <span class="number">0</span>);    </span><br><span class="line">    <span class="comment">// æ‰¾åˆ°éœ€è¦ unpark çš„èŠ‚ç‚¹ï¼Œå½“å‰èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ª    </span></span><br><span class="line">    <span class="type">Node</span> <span class="variable">s</span> <span class="operator">=</span> node.next;    </span><br><span class="line">    <span class="comment">// å·²å–æ¶ˆçš„èŠ‚ç‚¹ä¸èƒ½å”¤é†’ï¼Œéœ€è¦æ‰¾åˆ°è·ç¦»å¤´èŠ‚ç‚¹æœ€è¿‘çš„éå–æ¶ˆçš„èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">if</span> (s == <span class="literal">null</span> || s.waitStatus &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        s = <span class="literal">null</span>;</span><br><span class="line">        <span class="comment">// AQS é˜Ÿåˆ—ã€ä»åè‡³å‰ã€‘æ‰¾éœ€è¦ unpark çš„èŠ‚ç‚¹ï¼Œç›´åˆ° t == å½“å‰çš„ node ä¸ºæ­¢ï¼Œæ‰¾ä¸åˆ°å°±ä¸å”¤é†’äº†</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">Node</span> <span class="variable">t</span> <span class="operator">=</span> tail; t != <span class="literal">null</span> &amp;&amp; t != node; t = t.prev)</span><br><span class="line">            <span class="comment">// è¯´æ˜å½“å‰çº¿ç¨‹çŠ¶æ€éœ€è¦è¢«å”¤é†’</span></span><br><span class="line">            <span class="keyword">if</span> (t.waitStatus &lt;= <span class="number">0</span>)</span><br><span class="line">                <span class="comment">// ç½®æ¢å¼•ç”¨</span></span><br><span class="line">                s = t;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ã€æ‰¾åˆ°åˆé€‚çš„å¯ä»¥è¢«å”¤é†’çš„ nodeï¼Œåˆ™å”¤é†’çº¿ç¨‹ã€‘</span></span><br><span class="line">    <span class="keyword">if</span> (s != <span class="literal">null</span>)</span><br><span class="line">        LockSupport.unpark(s.thread);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ä»åå‘å‰çš„å”¤é†’çš„åŸå› </strong>ï¼šenq æ–¹æ³•ä¸­ï¼ŒèŠ‚ç‚¹æ˜¯å°¾æ’æ³•ï¼Œé¦–å…ˆèµ‹å€¼çš„æ˜¯å°¾èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹ï¼Œæ­¤æ—¶å‰é©±èŠ‚ç‚¹çš„ next å¹¶æ²¡æœ‰æŒ‡å‘å°¾èŠ‚ç‚¹ï¼Œä»å‰éå†ä¼šä¸¢å¤±å°¾èŠ‚ç‚¹</p></li><li><p>å”¤é†’çš„çº¿ç¨‹ä¼šä» park ä½ç½®å¼€å§‹æ‰§è¡Œï¼Œå¦‚æœåŠ é”æˆåŠŸï¼ˆæ²¡æœ‰ç«äº‰ï¼‰ï¼Œä¼šè®¾ç½®</p><ul><li>exclusiveOwnerThread ä¸º Thread-1ï¼Œstate &#x3D; 1</li><li>head æŒ‡å‘åˆšåˆš Thread-1 æ‰€åœ¨çš„ Nodeï¼Œè¯¥ Node ä¼šæ¸…ç©º Thread</li><li>åŸæœ¬çš„ head å› ä¸ºä»é“¾è¡¨æ–­å¼€ï¼Œè€Œå¯è¢«åƒåœ¾å›æ”¶ï¼ˆå›¾ä¸­æœ‰é”™è¯¯ï¼ŒåŸæ¥çš„å¤´èŠ‚ç‚¹çš„ waitStatus è¢«æ”¹ä¸º 0 äº†ï¼‰</li></ul><p><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/JUC-ReentrantLock-%E9%9D%9E%E5%85%AC%E5%B9%B3%E9%94%814.png"></p></li><li><p>å¦‚æœè¿™æ—¶æœ‰å…¶å®ƒçº¿ç¨‹æ¥ç«äº‰<strong>ï¼ˆéå…¬å¹³ï¼‰</strong>ï¼Œä¾‹å¦‚è¿™æ—¶æœ‰ Thread-4 æ¥äº†å¹¶æŠ¢å äº†é”</p><ul><li>Thread-4 è¢«è®¾ç½®ä¸º exclusiveOwnerThreadï¼Œstate &#x3D; 1</li><li>Thread-1 å†æ¬¡è¿›å…¥ acquireQueued æµç¨‹ï¼Œè·å–é”å¤±è´¥ï¼Œé‡æ–°è¿›å…¥ park é˜»å¡</li></ul><p><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/JUC-ReentrantLock-%E9%9D%9E%E5%85%AC%E5%B9%B3%E9%94%815.png"></p></li></ul><hr><h5 id="å…¬å¹³åŸç†"><a href="#å…¬å¹³åŸç†" class="headerlink" title="å…¬å¹³åŸç†"></a>å…¬å¹³åŸç†</h5><p>ä¸éå…¬å¹³é”ä¸»è¦åŒºåˆ«åœ¨äº tryAcquire æ–¹æ³•ï¼šå…ˆæ£€æŸ¥ AQS é˜Ÿåˆ—ä¸­æ˜¯å¦æœ‰å‰é©±èŠ‚ç‚¹ï¼Œæ²¡æœ‰æ‰å» CAS ç«äº‰</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">FairSync</span> <span class="keyword">extends</span> <span class="title class_">Sync</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> -<span class="number">3000897897090466540L</span>;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span> &#123;</span><br><span class="line">        acquire(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">tryAcquire</span><span class="params">(<span class="type">int</span> acquires)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Thread</span> <span class="variable">current</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">        <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> getState();</span><br><span class="line">        <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// å…ˆæ£€æŸ¥ AQS é˜Ÿåˆ—ä¸­æ˜¯å¦æœ‰å‰é©±èŠ‚ç‚¹, æ²¡æœ‰(false)æ‰å»ç«äº‰</span></span><br><span class="line">            <span class="keyword">if</span> (!hasQueuedPredecessors() &amp;&amp;</span><br><span class="line">                compareAndSetState(<span class="number">0</span>, acquires)) &#123;</span><br><span class="line">                setExclusiveOwnerThread(current);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// é”é‡å…¥</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">hasQueuedPredecessors</span><span class="params">()</span> &#123;    </span><br><span class="line">    <span class="type">Node</span> <span class="variable">t</span> <span class="operator">=</span> tail;</span><br><span class="line">    <span class="type">Node</span> <span class="variable">h</span> <span class="operator">=</span> head;</span><br><span class="line">    Node s;    </span><br><span class="line">    <span class="comment">// å¤´å°¾æŒ‡å‘ä¸€ä¸ªèŠ‚ç‚¹ï¼Œé“¾è¡¨ä¸ºç©ºï¼Œè¿”å›false</span></span><br><span class="line">    <span class="keyword">return</span> h != t &amp;&amp;</span><br><span class="line">        <span class="comment">// å¤´å°¾ä¹‹é—´æœ‰èŠ‚ç‚¹ï¼Œåˆ¤æ–­å¤´èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªæ˜¯ä¸æ˜¯ç©º</span></span><br><span class="line">        <span class="comment">// ä¸æ˜¯ç©ºè¿›å…¥æœ€åçš„åˆ¤æ–­ï¼Œç¬¬äºŒä¸ªèŠ‚ç‚¹çš„çº¿ç¨‹æ˜¯å¦æ˜¯æœ¬çº¿ç¨‹ï¼Œä¸æ˜¯è¿”å› trueï¼Œè¡¨ç¤ºå½“å‰èŠ‚ç‚¹æœ‰å‰é©±èŠ‚ç‚¹</span></span><br><span class="line">        ((s = h.next) == <span class="literal">null</span> || s.thread != Thread.currentThread());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h4 id="å¯é‡å…¥"><a href="#å¯é‡å…¥" class="headerlink" title="å¯é‡å…¥"></a>å¯é‡å…¥</h4><p>å¯é‡å…¥æ˜¯æŒ‡åŒä¸€ä¸ªçº¿ç¨‹å¦‚æœé¦–æ¬¡è·å¾—äº†è¿™æŠŠé”ï¼Œé‚£ä¹ˆå®ƒæ˜¯è¿™æŠŠé”çš„æ‹¥æœ‰è€…ï¼Œå› æ­¤æœ‰æƒåˆ©å†æ¬¡è·å–è¿™æŠŠé”ï¼Œå¦‚æœä¸å¯é‡å…¥é”ï¼Œé‚£ä¹ˆç¬¬äºŒæ¬¡è·å¾—é”æ—¶ï¼Œè‡ªå·±ä¹Ÿä¼šè¢«é”æŒ¡ä½ï¼Œç›´æ¥é€ æˆæ­»é”</p><p>æºç è§£æå‚è€ƒï¼š<code>nonfairTryAcquire(int acquires)) </code> å’Œ <code>tryRelease(int releases)</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="type">ReentrantLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    method1();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">method1</span><span class="params">()</span> &#123;</span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">&quot; execute method1&quot;</span>);</span><br><span class="line">        method2();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">method2</span><span class="params">()</span> &#123;</span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">&quot; execute method2&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ Lock æ–¹æ³•åŠ ä¸¤æŠŠé”ä¼šæ˜¯ä»€ä¹ˆæƒ…å†µå‘¢ï¼Ÿ</p><ul><li>åŠ é”ä¸¤æ¬¡è§£é”ä¸¤æ¬¡ï¼šæ­£å¸¸æ‰§è¡Œ</li><li>åŠ é”ä¸¤æ¬¡è§£é”ä¸€æ¬¡ï¼šç¨‹åºç›´æ¥å¡æ­»ï¼Œçº¿ç¨‹ä¸èƒ½å‡ºæ¥ï¼Œä¹Ÿå°±è¯´æ˜<strong>ç”³è¯·å‡ æŠŠé”ï¼Œæœ€åéœ€è¦è§£é™¤å‡ æŠŠé”</strong></li><li>åŠ é”ä¸€æ¬¡è§£é”ä¸¤æ¬¡ï¼šè¿è¡Œç¨‹åºä¼šç›´æ¥æŠ¥é”™</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">getLock</span><span class="params">()</span> &#123;</span><br><span class="line">    lock.lock();</span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        System.out.println(Thread.currentThread().getName() + <span class="string">&quot;\t get Lock&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">        <span class="comment">//lock.unlock();</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h4 id="å¯æ‰“æ–­"><a href="#å¯æ‰“æ–­" class="headerlink" title="å¯æ‰“æ–­"></a>å¯æ‰“æ–­</h4><h5 id="åŸºæœ¬ä½¿ç”¨-4"><a href="#åŸºæœ¬ä½¿ç”¨-4" class="headerlink" title="åŸºæœ¬ä½¿ç”¨"></a>åŸºæœ¬ä½¿ç”¨</h5><p><code>public void lockInterruptibly()</code>ï¼šè·å¾—å¯æ‰“æ–­çš„é”</p><ul><li>å¦‚æœæ²¡æœ‰ç«äº‰æ­¤æ–¹æ³•å°±ä¼šè·å– lock å¯¹è±¡é”</li><li>å¦‚æœæœ‰ç«äº‰å°±è¿›å…¥é˜»å¡é˜Ÿåˆ—ï¼Œå¯ä»¥è¢«å…¶ä»–çº¿ç¨‹ç”¨ interrupt æ‰“æ–­</li></ul><p>æ³¨æ„ï¼šå¦‚æœæ˜¯ä¸å¯ä¸­æ–­æ¨¡å¼ï¼Œé‚£ä¹ˆå³ä½¿ä½¿ç”¨äº† interrupt ä¹Ÿä¸ä¼šè®©ç­‰å¾…çŠ¶æ€ä¸­çš„çº¿ç¨‹ä¸­æ–­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;    </span><br><span class="line">    <span class="type">ReentrantLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();    </span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;        </span><br><span class="line">        <span class="keyword">try</span> &#123;            </span><br><span class="line">            System.out.println(<span class="string">&quot;å°è¯•è·å–é”&quot;</span>);            </span><br><span class="line">            lock.lockInterruptibly();        </span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;            </span><br><span class="line">            System.out.println(<span class="string">&quot;æ²¡æœ‰è·å–åˆ°é”ï¼Œè¢«æ‰“æ–­ï¼Œç›´æ¥è¿”å›&quot;</span>);            </span><br><span class="line">            <span class="keyword">return</span>;        </span><br><span class="line">        &#125;        </span><br><span class="line">        <span class="keyword">try</span> &#123;            </span><br><span class="line">            System.out.println(<span class="string">&quot;è·å–åˆ°é”&quot;</span>);        </span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;            </span><br><span class="line">            lock.unlock();        </span><br><span class="line">        &#125;    </span><br><span class="line">    &#125;, <span class="string">&quot;t1&quot;</span>);    </span><br><span class="line">    lock.lock();    </span><br><span class="line">    t1.start();    </span><br><span class="line">    Thread.sleep(<span class="number">2000</span>);    </span><br><span class="line">    System.out.println(<span class="string">&quot;ä¸»çº¿ç¨‹è¿›è¡Œæ‰“æ–­é”&quot;</span>);    </span><br><span class="line">    t1.interrupt();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h5 id="å®ç°åŸç†-2"><a href="#å®ç°åŸç†-2" class="headerlink" title="å®ç°åŸç†"></a>å®ç°åŸç†</h5><ul><li><p>ä¸å¯æ‰“æ–­æ¨¡å¼ï¼šå³ä½¿å®ƒè¢«æ‰“æ–­ï¼Œä»ä¼šé©»ç•™åœ¨ AQS é˜»å¡é˜Ÿåˆ—ä¸­ï¼Œä¸€ç›´è¦<strong>ç­‰åˆ°è·å¾—é”åæ‰èƒ½å¾—çŸ¥è‡ªå·±è¢«æ‰“æ–­</strong>äº†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">acquire</span><span class="params">(<span class="type">int</span> arg)</span> &#123;    </span><br><span class="line">    <span class="keyword">if</span> (!tryAcquire(arg) &amp;&amp; acquireQueued(addWaiter(Node.EXCLUSIVE), arg))<span class="comment">//é˜»å¡ç­‰å¾…        </span></span><br><span class="line">        <span class="comment">// å¦‚æœacquireQueuedè¿”å›trueï¼Œæ‰“æ–­çŠ¶æ€ interrupted = true        </span></span><br><span class="line">        selfInterrupt();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">selfInterrupt</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// çŸ¥é“è‡ªå·±è¢«æ‰“æ–­äº†ï¼Œéœ€è¦é‡æ–°äº§ç”Ÿä¸€æ¬¡ä¸­æ–­å®Œæˆä¸­æ–­æ•ˆæœ</span></span><br><span class="line">    Thread.currentThread().interrupt();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">acquireQueued</span><span class="params">(<span class="keyword">final</span> Node node, <span class="type">int</span> arg)</span> &#123;    </span><br><span class="line">    <span class="keyword">try</span> &#123;        </span><br><span class="line">        <span class="type">boolean</span> <span class="variable">interrupted</span> <span class="operator">=</span> <span class="literal">false</span>;        </span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;            </span><br><span class="line">            <span class="keyword">final</span> <span class="type">Node</span> <span class="variable">p</span> <span class="operator">=</span> node.predecessor();            </span><br><span class="line">            <span class="keyword">if</span> (p == head &amp;&amp; tryAcquire(arg)) &#123;                </span><br><span class="line">                setHead(node);                </span><br><span class="line">                p.next = <span class="literal">null</span>; <span class="comment">// help GC                </span></span><br><span class="line">                failed = <span class="literal">false</span>;                </span><br><span class="line">                <span class="comment">// è¿˜æ˜¯éœ€è¦è·å¾—é”å, æ‰èƒ½è¿”å›æ‰“æ–­çŠ¶æ€</span></span><br><span class="line">                <span class="keyword">return</span> interrupted;            </span><br><span class="line">            &#125;            </span><br><span class="line">            <span class="keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp; parkAndCheckInterrupt())&#123;</span><br><span class="line">                <span class="comment">// æ¡ä»¶äºŒä¸­åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦è¢«æ‰“æ–­ï¼Œè¢«æ‰“æ–­è¿”å›trueï¼Œè®¾ç½®ä¸­æ–­æ ‡è®°ä¸º trueï¼Œã€è·å–é”åè¿”å›ã€‘</span></span><br><span class="line">                interrupted = <span class="literal">true</span>;  </span><br><span class="line">            &#125;                  </span><br><span class="line">        &#125; </span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (failed)</span><br><span class="line">            cancelAcquire(node);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">parkAndCheckInterrupt</span><span class="params">()</span> &#123;    </span><br><span class="line">     <span class="comment">// é˜»å¡å½“å‰çº¿ç¨‹ï¼Œå¦‚æœæ‰“æ–­æ ‡è®°å·²ç»æ˜¯ true, åˆ™ park ä¼šå¤±æ•ˆ</span></span><br><span class="line">     LockSupport.park(<span class="built_in">this</span>);    </span><br><span class="line">     <span class="comment">// åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦è¢«æ‰“æ–­ï¼Œæ¸…é™¤æ‰“æ–­æ ‡è®°ï¼Œè¢«æ‰“æ–­è¿”å›true</span></span><br><span class="line">     <span class="keyword">return</span> Thread.interrupted();</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></li><li><p>å¯æ‰“æ–­æ¨¡å¼ï¼šAbstractQueuedSynchronizer#acquireInterruptiblyï¼Œ<strong>è¢«æ‰“æ–­åä¼šç›´æ¥æŠ›å‡ºå¼‚å¸¸</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">lockInterruptibly</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;    </span><br><span class="line">    sync.acquireInterruptibly(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">acquireInterruptibly</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">    <span class="comment">// è¢«å…¶ä»–çº¿ç¨‹æ‰“æ–­äº†ç›´æ¥è¿”å› false</span></span><br><span class="line">    <span class="keyword">if</span> (Thread.interrupted())</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InterruptedException</span>();</span><br><span class="line">    <span class="keyword">if</span> (!tryAcquire(arg))</span><br><span class="line">        <span class="comment">// æ²¡è·å–åˆ°é”ï¼Œè¿›å…¥è¿™é‡Œ</span></span><br><span class="line">        doAcquireInterruptibly(arg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doAcquireInterruptibly</span><span class="params">(<span class="type">int</span> arg)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="comment">// è¿”å›å°è£…å½“å‰çº¿ç¨‹çš„èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> addWaiter(Node.EXCLUSIVE);</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">failed</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="comment">//...</span></span><br><span class="line">            <span class="keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp; parkAndCheckInterrupt())</span><br><span class="line">                <span class="comment">// ã€åœ¨ park è¿‡ç¨‹ä¸­å¦‚æœè¢« interrupt ä¼šæŠ›å‡ºå¼‚å¸¸ã€‘, è€Œä¸ä¼šå†æ¬¡è¿›å…¥å¾ªç¯è·å–é”åæ‰å®Œæˆæ‰“æ–­æ•ˆæœ</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InterruptedException</span>();</span><br><span class="line">        &#125;    </span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// æŠ›å‡ºå¼‚å¸¸å‰ä¼šè¿›å…¥è¿™é‡Œ</span></span><br><span class="line">        <span class="keyword">if</span> (failed)</span><br><span class="line">            <span class="comment">// å–æ¶ˆå½“å‰çº¿ç¨‹çš„èŠ‚ç‚¹</span></span><br><span class="line">            cancelAcquire(node);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å–æ¶ˆèŠ‚ç‚¹å‡ºé˜Ÿçš„é€»è¾‘</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">cancelAcquire</span><span class="params">(Node node)</span> &#123;</span><br><span class="line">    <span class="comment">// åˆ¤ç©º</span></span><br><span class="line">    <span class="keyword">if</span> (node == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"><span class="comment">// æŠŠå½“å‰èŠ‚ç‚¹å°è£…çš„ Thread ç½®ä¸ºç©º</span></span><br><span class="line">    node.thread = <span class="literal">null</span>;</span><br><span class="line"><span class="comment">// è·å–å½“å‰å–æ¶ˆçš„ node çš„å‰é©±èŠ‚ç‚¹</span></span><br><span class="line">    <span class="type">Node</span> <span class="variable">pred</span> <span class="operator">=</span> node.prev;</span><br><span class="line">    <span class="comment">// å‰é©±èŠ‚ç‚¹ä¹Ÿè¢«å–æ¶ˆäº†ï¼Œå¾ªç¯æ‰¾åˆ°å‰é¢æœ€è¿‘çš„æ²¡è¢«å–æ¶ˆçš„èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">while</span> (pred.waitStatus &gt; <span class="number">0</span>)</span><br><span class="line">        node.prev = pred = pred.prev;</span><br><span class="line">    </span><br><span class="line"><span class="comment">// è·å–å‰é©±èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹ï¼Œå¯èƒ½æ˜¯å½“å‰ nodeï¼Œä¹Ÿå¯èƒ½æ˜¯ waitStatus &gt; 0 çš„èŠ‚ç‚¹</span></span><br><span class="line">    <span class="type">Node</span> <span class="variable">predNext</span> <span class="operator">=</span> pred.next;</span><br><span class="line">    </span><br><span class="line"><span class="comment">// æŠŠå½“å‰èŠ‚ç‚¹çš„çŠ¶æ€è®¾ç½®ä¸º ã€å–æ¶ˆçŠ¶æ€ 1ã€‘</span></span><br><span class="line">    node.waitStatus = Node.CANCELLED;</span><br><span class="line">    </span><br><span class="line"><span class="comment">// æ¡ä»¶æˆç«‹è¯´æ˜å½“å‰èŠ‚ç‚¹æ˜¯å°¾èŠ‚ç‚¹ï¼ŒæŠŠå½“å‰èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹è®¾ç½®ä¸ºå°¾èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">if</span> (node == tail &amp;&amp; compareAndSetTail(node, pred)) &#123;</span><br><span class="line">        <span class="comment">// æŠŠå‰é©±èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹ç½®ç©ºï¼Œè¿™é‡Œç›´æ¥æŠŠæ‰€æœ‰çš„å–æ¶ˆèŠ‚ç‚¹å‡ºé˜Ÿ</span></span><br><span class="line">        compareAndSetNext(pred, predNext, <span class="literal">null</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// è¯´æ˜å½“å‰èŠ‚ç‚¹ä¸æ˜¯ tail èŠ‚ç‚¹</span></span><br><span class="line">        <span class="type">int</span> ws;</span><br><span class="line">        <span class="comment">// æ¡ä»¶ä¸€æˆç«‹è¯´æ˜å½“å‰èŠ‚ç‚¹ä¸æ˜¯ head.next èŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">if</span> (pred != head &amp;&amp;</span><br><span class="line">            <span class="comment">// åˆ¤æ–­å‰é©±èŠ‚ç‚¹çš„çŠ¶æ€æ˜¯ä¸æ˜¯ -1ï¼Œä¸æˆç«‹è¯´æ˜å‰é©±çŠ¶æ€å¯èƒ½æ˜¯ 0 æˆ–è€…åˆšè¢«å…¶ä»–çº¿ç¨‹å–æ¶ˆæ’é˜Ÿäº†</span></span><br><span class="line">            ((ws = pred.waitStatus) == Node.SIGNAL ||</span><br><span class="line">             <span class="comment">// å¦‚æœçŠ¶æ€ä¸æ˜¯ -1ï¼Œè®¾ç½®å‰é©±èŠ‚ç‚¹çš„çŠ¶æ€ä¸º -1</span></span><br><span class="line">             (ws &lt;= <span class="number">0</span> &amp;&amp; compareAndSetWaitStatus(pred, ws, Node.SIGNAL))) &amp;&amp;</span><br><span class="line">            <span class="comment">// å‰é©±èŠ‚ç‚¹çš„çº¿ç¨‹ä¸ä¸ºnull</span></span><br><span class="line">            pred.thread != <span class="literal">null</span>) &#123;</span><br><span class="line">            </span><br><span class="line">            <span class="type">Node</span> <span class="variable">next</span> <span class="operator">=</span> node.next;</span><br><span class="line">            <span class="comment">// å½“å‰èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹æ˜¯æ­£å¸¸èŠ‚ç‚¹</span></span><br><span class="line">            <span class="keyword">if</span> (next != <span class="literal">null</span> &amp;&amp; next.waitStatus &lt;= <span class="number">0</span>)</span><br><span class="line">                <span class="comment">// æŠŠ å‰é©±èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹ è®¾ç½®ä¸º å½“å‰èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹ï¼Œã€ä»é˜Ÿåˆ—ä¸­åˆ é™¤äº†å½“å‰èŠ‚ç‚¹ã€‘</span></span><br><span class="line">                compareAndSetNext(pred, predNext, next);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// å½“å‰èŠ‚ç‚¹æ˜¯ head.next èŠ‚ç‚¹ï¼Œå”¤é†’å½“å‰èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹</span></span><br><span class="line">            unparkSuccessor(node);</span><br><span class="line">        &#125;</span><br><span class="line">        node.next = node; <span class="comment">// help GC</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><hr><h4 id="é”è¶…æ—¶"><a href="#é”è¶…æ—¶" class="headerlink" title="é”è¶…æ—¶"></a>é”è¶…æ—¶</h4><h5 id="åŸºæœ¬ä½¿ç”¨-5"><a href="#åŸºæœ¬ä½¿ç”¨-5" class="headerlink" title="åŸºæœ¬ä½¿ç”¨"></a>åŸºæœ¬ä½¿ç”¨</h5><p><code>public boolean tryLock()</code>ï¼šå°è¯•è·å–é”ï¼Œè·å–åˆ°è¿”å› trueï¼Œè·å–ä¸åˆ°ç›´æ¥æ”¾å¼ƒï¼Œä¸è¿›å…¥é˜»å¡é˜Ÿåˆ—</p><p><code>public boolean tryLock(long timeout, TimeUnit unit)</code>ï¼šåœ¨ç»™å®šæ—¶é—´å†…è·å–é”ï¼Œè·å–ä¸åˆ°å°±é€€å‡º</p><p>æ³¨æ„ï¼štryLock æœŸé—´ä¹Ÿå¯ä»¥è¢«æ‰“æ–­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">ReentrantLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">t1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!lock.tryLock(<span class="number">2</span>, TimeUnit.SECONDS)) &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;è·å–ä¸åˆ°é”&quot;</span>);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;è¢«æ‰“æ–­ï¼Œè·å–ä¸åˆ°é”&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            log.debug(<span class="string">&quot;è·å–åˆ°é”&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, <span class="string">&quot;t1&quot;</span>);</span><br><span class="line">    lock.lock();</span><br><span class="line">    System.out.println(<span class="string">&quot;ä¸»çº¿ç¨‹è·å–åˆ°é”&quot;</span>);</span><br><span class="line">    t1.start();</span><br><span class="line">    </span><br><span class="line">    Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;ä¸»çº¿ç¨‹é‡Šæ”¾äº†é”&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h5 id="å®ç°åŸç†-3"><a href="#å®ç°åŸç†-3" class="headerlink" title="å®ç°åŸç†"></a>å®ç°åŸç†</h5><ul><li><p>æˆå‘˜å˜é‡ï¼šæŒ‡å®šè¶…æ—¶é™åˆ¶çš„é˜ˆå€¼ï¼Œå°äºè¯¥å€¼çš„çº¿ç¨‹ä¸ä¼šè¢«æŒ‚èµ·</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">spinForTimeoutThreshold</span> <span class="operator">=</span> <span class="number">1000L</span>;</span><br></pre></td></tr></table></figure><p>è¶…æ—¶æ—¶é—´è®¾ç½®çš„å°äºè¯¥å€¼ï¼Œå°±ä¼šè¢«ç¦æ­¢æŒ‚èµ·ï¼Œå› ä¸ºé˜»å¡åœ¨å”¤é†’çš„æˆæœ¬å¤ªé«˜ï¼Œä¸å¦‚é€‰æ‹©è‡ªæ—‹ç©ºè½¬</p></li><li><p>tryLock()</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">tryLock</span><span class="params">()</span> &#123;   </span><br><span class="line">    <span class="comment">// åªå°è¯•ä¸€æ¬¡</span></span><br><span class="line">    <span class="keyword">return</span> sync.nonfairTryAcquire(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>tryLock(long timeout, TimeUnit unit)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">tryAcquireNanos</span><span class="params">(<span class="type">int</span> arg, <span class="type">long</span> nanosTimeout)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (Thread.interrupted())        </span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InterruptedException</span>();    </span><br><span class="line">    <span class="comment">// tryAcquire å°è¯•ä¸€æ¬¡</span></span><br><span class="line">    <span class="keyword">return</span> tryAcquire(arg) || doAcquireNanos(arg, nanosTimeout);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">tryAcquire</span><span class="params">(<span class="type">int</span> acquires)</span> &#123;    </span><br><span class="line">    <span class="keyword">return</span> nonfairTryAcquire(acquires);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">doAcquireNanos</span><span class="params">(<span class="type">int</span> arg, <span class="type">long</span> nanosTimeout)</span> &#123;    </span><br><span class="line">    <span class="keyword">if</span> (nanosTimeout &lt;= <span class="number">0L</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">// è·å–æœ€åæœŸé™çš„æ—¶é—´æˆ³</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">long</span> <span class="variable">deadline</span> <span class="operator">=</span> System.nanoTime() + nanosTimeout;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="comment">//...</span></span><br><span class="line">            <span class="comment">// è®¡ç®—è¿˜éœ€ç­‰å¾…çš„æ—¶é—´</span></span><br><span class="line">            nanosTimeout = deadline - System.nanoTime();</span><br><span class="line">            <span class="keyword">if</span> (nanosTimeout &lt;= <span class="number">0L</span>)<span class="comment">//æ—¶é—´å·²åˆ°     </span></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp;</span><br><span class="line">                <span class="comment">// å¦‚æœ nanosTimeout å¤§äºè¯¥å€¼ï¼Œæ‰æœ‰é˜»å¡çš„æ„ä¹‰ï¼Œå¦åˆ™ç›´æ¥è‡ªæ—‹ä¼šå¥½ç‚¹</span></span><br><span class="line">                nanosTimeout &gt; spinForTimeoutThreshold)</span><br><span class="line">                LockSupport.parkNanos(<span class="built_in">this</span>, nanosTimeout);</span><br><span class="line">            <span class="comment">// ã€è¢«æ‰“æ–­ä¼šæŠ¥å¼‚å¸¸ã€‘</span></span><br><span class="line">            <span class="keyword">if</span> (Thread.interrupted())</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InterruptedException</span>();</span><br><span class="line">        &#125;    </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><hr><h5 id="å“²å­¦å®¶å°±é¤"><a href="#å“²å­¦å®¶å°±é¤" class="headerlink" title="å“²å­¦å®¶å°±é¤"></a>å“²å­¦å®¶å°±é¤</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">Chopstick</span> <span class="variable">c1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Chopstick</span>(<span class="string">&quot;1&quot;</span>);<span class="comment">//...</span></span><br><span class="line">    <span class="type">Chopstick</span> <span class="variable">c5</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Chopstick</span>(<span class="string">&quot;5&quot;</span>);</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Philosopher</span>(<span class="string">&quot;è‹æ ¼æ‹‰åº•&quot;</span>, c1, c2).start();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Philosopher</span>(<span class="string">&quot;æŸæ‹‰å›¾&quot;</span>, c2, c3).start();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Philosopher</span>(<span class="string">&quot;äºšé‡Œå£«å¤šå¾·&quot;</span>, c3, c4).start();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Philosopher</span>(<span class="string">&quot;èµ«æ‹‰å…‹åˆ©ç‰¹&quot;</span>, c4, c5).start();    </span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Philosopher</span>(<span class="string">&quot;é˜¿åŸºç±³å¾·&quot;</span>, c5, c1).start();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Philosopher</span> <span class="keyword">extends</span> <span class="title class_">Thread</span> &#123;</span><br><span class="line">    Chopstick left;</span><br><span class="line">    Chopstick right;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="comment">// å°è¯•è·å¾—å·¦æ‰‹ç­·å­</span></span><br><span class="line">            <span class="keyword">if</span> (left.tryLock()) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// å°è¯•è·å¾—å³æ‰‹ç­·å­</span></span><br><span class="line">                    <span class="keyword">if</span> (right.tryLock()) &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            System.out.println(<span class="string">&quot;eating...&quot;</span>);</span><br><span class="line">                            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                            right.unlock();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    left.unlock();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Chopstick</span> <span class="keyword">extends</span> <span class="title class_">ReentrantLock</span> &#123;</span><br><span class="line">    String name;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Chopstick</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;ç­·å­&#123;&quot;</span> + name + <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h4 id="æ¡ä»¶å˜é‡"><a href="#æ¡ä»¶å˜é‡" class="headerlink" title="æ¡ä»¶å˜é‡"></a>æ¡ä»¶å˜é‡</h4><h5 id="åŸºæœ¬ä½¿ç”¨-6"><a href="#åŸºæœ¬ä½¿ç”¨-6" class="headerlink" title="åŸºæœ¬ä½¿ç”¨"></a>åŸºæœ¬ä½¿ç”¨</h5><p>synchronized çš„æ¡ä»¶å˜é‡ï¼Œæ˜¯å½“æ¡ä»¶ä¸æ»¡è¶³æ—¶è¿›å…¥ WaitSet ç­‰å¾…ï¼›ReentrantLock çš„æ¡ä»¶å˜é‡æ¯” synchronized å¼ºå¤§ä¹‹å¤„åœ¨äºæ”¯æŒå¤šä¸ªæ¡ä»¶å˜é‡</p><p>ReentrantLock ç±»è·å– Condition å¯¹è±¡ï¼š<code>public Condition newCondition()</code></p><p>Condition ç±» APIï¼š</p><ul><li><code>void await()</code>ï¼šå½“å‰çº¿ç¨‹ä»è¿è¡ŒçŠ¶æ€è¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œé‡Šæ”¾é”</li><li><code>void signal()</code>ï¼šå”¤é†’ä¸€ä¸ªç­‰å¾…åœ¨ Condition ä¸Šçš„çº¿ç¨‹ï¼Œä½†æ˜¯å¿…é¡»è·å¾—ä¸è¯¥ Condition ç›¸å…³çš„é”</li></ul><p>ä½¿ç”¨æµç¨‹ï¼š</p><ul><li><p><strong>await &#x2F; signal å‰éœ€è¦è·å¾—é”</strong></p></li><li><p>await æ‰§è¡Œåï¼Œä¼šé‡Šæ”¾é”è¿›å…¥ ConditionObject ç­‰å¾…</p></li><li><p>await çš„çº¿ç¨‹è¢«å”¤é†’å»é‡æ–°ç«äº‰ lock é”</p></li><li><p><strong>çº¿ç¨‹åœ¨æ¡ä»¶é˜Ÿåˆ—è¢«æ‰“æ–­ä¼šæŠ›å‡ºä¸­æ–­å¼‚å¸¸</strong></p></li><li><p>ç«äº‰ lock é”æˆåŠŸåï¼Œä» await åç»§ç»­æ‰§è¡Œ</p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;    </span><br><span class="line">    <span class="type">ReentrantLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line">    <span class="comment">//åˆ›å»ºä¸€ä¸ªæ–°çš„æ¡ä»¶å˜é‡</span></span><br><span class="line">    <span class="type">Condition</span> <span class="variable">condition1</span> <span class="operator">=</span> lock.newCondition();</span><br><span class="line">    <span class="type">Condition</span> <span class="variable">condition2</span> <span class="operator">=</span> lock.newCondition();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            lock.lock();</span><br><span class="line">            System.out.println(<span class="string">&quot;è¿›å…¥ç­‰å¾…&quot;</span>);</span><br><span class="line">            <span class="comment">//è¿›å…¥ä¼‘æ¯å®¤ç­‰å¾…</span></span><br><span class="line">            condition1.await();</span><br><span class="line">            System.out.println(<span class="string">&quot;è¢«å”¤é†’äº†&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;    </span><br><span class="line">    &#125;).start();</span><br><span class="line">    Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">    <span class="comment">//å«é†’</span></span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;            </span><br><span class="line">            lock.lock();</span><br><span class="line">            <span class="comment">//å”¤é†’</span></span><br><span class="line">            condition2.signal();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            lock.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h5 id="å®ç°åŸç†-4"><a href="#å®ç°åŸç†-4" class="headerlink" title="å®ç°åŸç†"></a>å®ç°åŸç†</h5><h6 id="await"><a href="#await" class="headerlink" title="await"></a>await</h6><p>æ€»ä½“æµç¨‹æ˜¯å°† await çº¿ç¨‹åŒ…è£…æˆ node èŠ‚ç‚¹æ”¾å…¥ ConditionObject çš„æ¡ä»¶é˜Ÿåˆ—ï¼Œå¦‚æœè¢«å”¤é†’å°±å°† node è½¬ç§»åˆ° AQS çš„æ‰§è¡Œé˜»å¡é˜Ÿåˆ—ï¼Œç­‰å¾…è·å–é”ï¼Œ<strong>æ¯ä¸ª Condition å¯¹è±¡éƒ½åŒ…å«ä¸€ä¸ªç­‰å¾…é˜Ÿåˆ—</strong></p><ul><li><p>å¼€å§‹ Thread-0 æŒæœ‰é”ï¼Œè°ƒç”¨ awaitï¼Œçº¿ç¨‹è¿›å…¥ ConditionObject ç­‰å¾…ï¼Œç›´åˆ°è¢«å”¤é†’æˆ–æ‰“æ–­ï¼Œè°ƒç”¨ await æ–¹æ³•çš„çº¿ç¨‹éƒ½æ˜¯æŒé”çŠ¶æ€çš„ï¼Œæ‰€ä»¥è¯´é€»è¾‘é‡Œ<strong>ä¸å­˜åœ¨å¹¶å‘</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">await</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">     <span class="comment">// åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦æ˜¯ä¸­æ–­çŠ¶æ€ï¼Œæ˜¯å°±ç›´æ¥ç»™ä¸ªä¸­æ–­å¼‚å¸¸</span></span><br><span class="line">    <span class="keyword">if</span> (Thread.interrupted())</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InterruptedException</span>();</span><br><span class="line">    <span class="comment">// å°†è°ƒç”¨ await çš„çº¿ç¨‹åŒ…è£…æˆ Nodeï¼Œæ·»åŠ åˆ°æ¡ä»¶é˜Ÿåˆ—å¹¶è¿”å›</span></span><br><span class="line">    <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> addConditionWaiter();</span><br><span class="line">    <span class="comment">// å®Œå…¨é‡Šæ”¾èŠ‚ç‚¹æŒæœ‰çš„é”ï¼Œå› ä¸ºå…¶ä»–çº¿ç¨‹å”¤é†’å½“å‰çº¿ç¨‹çš„å‰ææ˜¯ã€æŒæœ‰é”ã€‘</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">savedState</span> <span class="operator">=</span> fullyRelease(node);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è®¾ç½®æ‰“æ–­æ¨¡å¼ä¸ºæ²¡æœ‰è¢«æ‰“æ–­ï¼ŒçŠ¶æ€ç ä¸º 0</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">interruptMode</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å¦‚æœè¯¥èŠ‚ç‚¹è¿˜æ²¡æœ‰è½¬ç§»è‡³ AQS é˜»å¡é˜Ÿåˆ—, park é˜»å¡ï¼Œç­‰å¾…è¿›å…¥é˜»å¡é˜Ÿåˆ—</span></span><br><span class="line">    <span class="keyword">while</span> (!isOnSyncQueue(node)) &#123;</span><br><span class="line">        LockSupport.park(<span class="built_in">this</span>);</span><br><span class="line">        <span class="comment">// å¦‚æœè¢«æ‰“æ–­ï¼Œé€€å‡ºç­‰å¾…é˜Ÿåˆ—ï¼Œå¯¹åº”çš„ node ã€ä¹Ÿä¼šè¢«è¿ç§»åˆ°é˜»å¡é˜Ÿåˆ—ã€‘å°¾éƒ¨ï¼ŒçŠ¶æ€è®¾ç½®ä¸º 0</span></span><br><span class="line">        <span class="keyword">if</span> ((interruptMode = checkInterruptWhileWaiting(node)) != <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// é€»è¾‘åˆ°è¿™è¯´æ˜å½“å‰çº¿ç¨‹é€€å‡ºç­‰å¾…é˜Ÿåˆ—ï¼Œè¿›å…¥ã€é˜»å¡é˜Ÿåˆ—ã€‘</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å°è¯•æªé”ï¼Œé‡Šæ”¾äº†å¤šå°‘é”å°±ã€é‡æ–°è·å–å¤šå°‘é”ã€‘ï¼Œè·å–é”æˆåŠŸåˆ¤æ–­æ‰“æ–­æ¨¡å¼</span></span><br><span class="line">    <span class="keyword">if</span> (acquireQueued(node, savedState) &amp;&amp; interruptMode != THROW_IE)</span><br><span class="line">        interruptMode = REINTERRUPT;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// node åœ¨æ¡ä»¶é˜Ÿåˆ—æ—¶ å¦‚æœè¢«å¤–éƒ¨çº¿ç¨‹ä¸­æ–­å”¤é†’ï¼Œä¼šåŠ å…¥åˆ°é˜»å¡é˜Ÿåˆ—ï¼Œä½†æ˜¯å¹¶æœªè®¾ nextWaiter = null</span></span><br><span class="line">    <span class="keyword">if</span> (node.nextWaiter != <span class="literal">null</span>)</span><br><span class="line">        <span class="comment">// æ¸…ç†æ¡ä»¶é˜Ÿåˆ—å†…æ‰€æœ‰å·²å–æ¶ˆçš„ Node</span></span><br><span class="line">        unlinkCancelledWaiters();</span><br><span class="line">    <span class="comment">// æ¡ä»¶æˆç«‹è¯´æ˜æŒ‚èµ·æœŸé—´å‘ç”Ÿè¿‡ä¸­æ–­</span></span><br><span class="line">    <span class="keyword">if</span> (interruptMode != <span class="number">0</span>)</span><br><span class="line">        <span class="comment">// åº”ç”¨æ‰“æ–­æ¨¡å¼</span></span><br><span class="line">        reportInterruptAfterWait(interruptMode);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ‰“æ–­æ¨¡å¼ - åœ¨é€€å‡ºç­‰å¾…æ—¶é‡æ–°è®¾ç½®æ‰“æ–­çŠ¶æ€</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">REINTERRUPT</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line"><span class="comment">// æ‰“æ–­æ¨¡å¼ - åœ¨é€€å‡ºç­‰å¾…æ—¶æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">THROW_IE</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br></pre></td></tr></table></figure><p><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/JUC-ReentrantLock-%E6%9D%A1%E4%BB%B6%E5%8F%98%E9%87%8F1.png"></p></li><li><p><strong>åˆ›å»ºæ–°çš„ Node çŠ¶æ€ä¸º -2ï¼ˆNode.CONDITIONï¼‰</strong>ï¼Œå…³è” Thread-0ï¼ŒåŠ å…¥ç­‰å¾…é˜Ÿåˆ—å°¾éƒ¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Node <span class="title function_">addConditionWaiter</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// è·å–å½“å‰æ¡ä»¶é˜Ÿåˆ—çš„å°¾èŠ‚ç‚¹çš„å¼•ç”¨ï¼Œä¿å­˜åˆ°å±€éƒ¨å˜é‡ t ä¸­</span></span><br><span class="line">    <span class="type">Node</span> <span class="variable">t</span> <span class="operator">=</span> lastWaiter;</span><br><span class="line">    <span class="comment">// å½“å‰é˜Ÿåˆ—ä¸­ä¸æ˜¯ç©ºï¼Œå¹¶ä¸”èŠ‚ç‚¹çš„çŠ¶æ€ä¸æ˜¯ CONDITIONï¼ˆ-2ï¼‰ï¼Œè¯´æ˜å½“å‰èŠ‚ç‚¹å‘ç”Ÿäº†ä¸­æ–­</span></span><br><span class="line">    <span class="keyword">if</span> (t != <span class="literal">null</span> &amp;&amp; t.waitStatus != Node.CONDITION) &#123;</span><br><span class="line">        <span class="comment">// æ¸…ç†æ¡ä»¶é˜Ÿåˆ—å†…æ‰€æœ‰å·²å–æ¶ˆçš„ Node</span></span><br><span class="line">        unlinkCancelledWaiters();</span><br><span class="line">        <span class="comment">// æ¸…ç†å®Œæˆé‡æ–°è·å– å°¾èŠ‚ç‚¹ çš„å¼•ç”¨</span></span><br><span class="line">        t = lastWaiter;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// åˆ›å»ºä¸€ä¸ªå…³è”å½“å‰çº¿ç¨‹çš„æ–° node, è®¾ç½®çŠ¶æ€ä¸º CONDITION(-2)ï¼Œæ·»åŠ è‡³é˜Ÿåˆ—å°¾éƒ¨</span></span><br><span class="line">    <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Node</span>(Thread.currentThread(), Node.CONDITION);</span><br><span class="line">    <span class="keyword">if</span> (t == <span class="literal">null</span>)</span><br><span class="line">        firstWaiter = node;<span class="comment">// ç©ºé˜Ÿåˆ—ç›´æ¥æ”¾åœ¨é˜Ÿé¦–ã€ä¸ç”¨CASå› ä¸ºæ‰§è¡Œçº¿ç¨‹æ˜¯æŒé”çº¿ç¨‹ï¼Œå¹¶å‘å®‰å…¨ã€‘</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        t.nextWaiter = node;<span class="comment">// éç©ºé˜Ÿåˆ—é˜Ÿå°¾è¿½åŠ </span></span><br><span class="line">    lastWaiter = node;<span class="comment">// æ›´æ–°é˜Ÿå°¾çš„å¼•ç”¨</span></span><br><span class="line">    <span class="keyword">return</span> node;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ¸…ç†æ¡ä»¶é˜Ÿåˆ—å†…æ‰€æœ‰å·²å–æ¶ˆï¼ˆä¸æ˜¯CONDITIONï¼‰çš„ nodeï¼Œã€é“¾è¡¨åˆ é™¤çš„é€»è¾‘ã€‘</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">unlinkCancelledWaiters</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// ä»å¤´èŠ‚ç‚¹å¼€å§‹éå†ã€FIFOã€‘</span></span><br><span class="line">    <span class="type">Node</span> <span class="variable">t</span> <span class="operator">=</span> firstWaiter;</span><br><span class="line">    <span class="comment">// æŒ‡å‘æ­£å¸¸çš„ CONDITION èŠ‚ç‚¹</span></span><br><span class="line">    <span class="type">Node</span> <span class="variable">trail</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">// ç­‰å¾…é˜Ÿåˆ—ä¸ç©º</span></span><br><span class="line">    <span class="keyword">while</span> (t != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// è·å–å½“å‰èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹</span></span><br><span class="line">        <span class="type">Node</span> <span class="variable">next</span> <span class="operator">=</span> t.nextWaiter;</span><br><span class="line">        <span class="comment">// åˆ¤æ–­ t èŠ‚ç‚¹æ˜¯ä¸æ˜¯ CONDITION èŠ‚ç‚¹ï¼Œæ¡ä»¶é˜Ÿåˆ—å†…ä¸æ˜¯ CONDITION å°±ä¸æ˜¯æ­£å¸¸çš„</span></span><br><span class="line">        <span class="keyword">if</span> (t.waitStatus != Node.CONDITION) &#123; </span><br><span class="line">            <span class="comment">// ä¸æ˜¯æ­£å¸¸èŠ‚ç‚¹ï¼Œéœ€è¦ t ä¸ä¸‹ä¸€ä¸ªèŠ‚ç‚¹æ–­å¼€</span></span><br><span class="line">            t.nextWaiter = <span class="literal">null</span>;</span><br><span class="line">            <span class="comment">// æ¡ä»¶æˆç«‹è¯´æ˜éå†åˆ°çš„èŠ‚ç‚¹è¿˜æœªç¢°åˆ°è¿‡æ­£å¸¸èŠ‚ç‚¹</span></span><br><span class="line">            <span class="keyword">if</span> (trail == <span class="literal">null</span>)</span><br><span class="line">                <span class="comment">// æ›´æ–° firstWaiter æŒ‡é’ˆä¸ºä¸‹ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">                firstWaiter = next;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="comment">// è®©ä¸Šä¸€ä¸ªæ­£å¸¸èŠ‚ç‚¹æŒ‡å‘ å½“å‰å–æ¶ˆèŠ‚ç‚¹çš„ ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œã€åˆ é™¤éæ­£å¸¸çš„èŠ‚ç‚¹ã€‘</span></span><br><span class="line">                trail.nextWaiter = next;</span><br><span class="line">            <span class="comment">// t æ˜¯å°¾èŠ‚ç‚¹äº†ï¼Œæ›´æ–° lastWaiter æŒ‡å‘æœ€åä¸€ä¸ªæ­£å¸¸èŠ‚ç‚¹</span></span><br><span class="line">            <span class="keyword">if</span> (next == <span class="literal">null</span>)</span><br><span class="line">                lastWaiter = trail;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// trail æŒ‡å‘çš„æ˜¯æ­£å¸¸èŠ‚ç‚¹ </span></span><br><span class="line">            trail = t;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æŠŠ t.next èµ‹å€¼ç»™ tï¼Œå¾ªç¯éå†</span></span><br><span class="line">        t = next; </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>æ¥ä¸‹æ¥ Thread-0 è¿›å…¥ AQS çš„ fullyRelease æµç¨‹ï¼Œé‡Šæ”¾åŒæ­¥å™¨ä¸Šçš„é”</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// çº¿ç¨‹å¯èƒ½é‡å…¥ï¼Œéœ€è¦å°† state å…¨éƒ¨é‡Šæ”¾</span></span><br><span class="line"><span class="keyword">final</span> <span class="type">int</span> <span class="title function_">fullyRelease</span><span class="params">(Node node)</span> &#123;</span><br><span class="line">    <span class="comment">// å®Œå…¨é‡Šæ”¾é”æ˜¯å¦æˆåŠŸï¼Œfalse ä»£è¡¨æˆåŠŸ</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">failed</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// è·å–å½“å‰çº¿ç¨‹æ‰€æŒæœ‰çš„ state å€¼æ€»æ•°</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">savedState</span> <span class="operator">=</span> getState();</span><br><span class="line">        <span class="comment">// release -&gt; tryRelease è§£é”é‡å…¥é”</span></span><br><span class="line">        <span class="keyword">if</span> (release(savedState)) &#123;</span><br><span class="line">            <span class="comment">// é‡Šæ”¾æˆåŠŸ</span></span><br><span class="line">            failed = <span class="literal">false</span>;</span><br><span class="line">            <span class="comment">// è¿”å›è§£é”çš„æ·±åº¦</span></span><br><span class="line">            <span class="keyword">return</span> savedState;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// è§£é”å¤±è´¥æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalMonitorStateException</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// æ²¡æœ‰é‡Šæ”¾æˆåŠŸï¼Œå°†å½“å‰ node è®¾ç½®ä¸ºå–æ¶ˆçŠ¶æ€</span></span><br><span class="line">        <span class="keyword">if</span> (failed)</span><br><span class="line">            node.waitStatus = Node.CANCELLED;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>fullyRelease ä¸­ä¼š unpark AQS é˜Ÿåˆ—ä¸­çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ç«äº‰é”ï¼Œå‡è®¾ Thread-1 ç«äº‰æˆåŠŸ</p><p><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/JUC-ReentrantLock-%E6%9D%A1%E4%BB%B6%E5%8F%98%E9%87%8F2.png"></p></li><li><p>Thread-0 è¿›å…¥ isOnSyncQueue é€»è¾‘åˆ¤æ–­èŠ‚ç‚¹<strong>æ˜¯å¦ç§»åŠ¨åˆ°é˜»å¡é˜Ÿåˆ—</strong>ï¼Œæ²¡æœ‰å°± park é˜»å¡ Thread-0</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">isOnSyncQueue</span><span class="params">(Node node)</span> &#123;</span><br><span class="line">    <span class="comment">// node çš„çŠ¶æ€æ˜¯ CONDITIONï¼Œsignal æ–¹æ³•æ˜¯å…ˆä¿®æ”¹çŠ¶æ€å†è¿ç§»ï¼Œæ‰€ä»¥å‰é©±èŠ‚ç‚¹ä¸ºç©ºè¯æ˜è¿˜ã€æ²¡æœ‰å®Œæˆè¿ç§»ã€‘</span></span><br><span class="line">    <span class="keyword">if</span> (node.waitStatus == Node.CONDITION || node.prev == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">// è¯´æ˜å½“å‰èŠ‚ç‚¹å·²ç»æˆåŠŸå…¥é˜Ÿåˆ°é˜»å¡é˜Ÿåˆ—ï¼Œä¸”å½“å‰èŠ‚ç‚¹åé¢å·²ç»æœ‰å…¶å®ƒ nodeï¼Œå› ä¸ºæ¡ä»¶é˜Ÿåˆ—çš„ next æŒ‡é’ˆä¸º null</span></span><br><span class="line">    <span class="keyword">if</span> (node.next != <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"><span class="comment">// è¯´æ˜ã€å¯èƒ½åœ¨é˜»å¡é˜Ÿåˆ—ï¼Œä½†æ˜¯æ˜¯å°¾èŠ‚ç‚¹ã€‘</span></span><br><span class="line">    <span class="comment">// ä»é˜»å¡é˜Ÿåˆ—çš„å°¾èŠ‚ç‚¹å¼€å§‹å‘å‰ã€éå†æŸ¥æ‰¾ nodeã€‘ï¼Œå¦‚æœæŸ¥æ‰¾åˆ°è¿”å› trueï¼ŒæŸ¥æ‰¾ä¸åˆ°è¿”å› false</span></span><br><span class="line">    <span class="keyword">return</span> findNodeFromTail(node);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>await çº¿ç¨‹ park åå¦‚æœè¢« unpark æˆ–è€…è¢«æ‰“æ–­ï¼Œéƒ½ä¼šè¿›å…¥ checkInterruptWhileWaiting åˆ¤æ–­çº¿ç¨‹æ˜¯å¦è¢«æ‰“æ–­ï¼š<strong>åœ¨æ¡ä»¶é˜Ÿåˆ—è¢«æ‰“æ–­çš„çº¿ç¨‹éœ€è¦æŠ›å‡ºå¼‚å¸¸</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">int</span> <span class="title function_">checkInterruptWhileWaiting</span><span class="params">(Node node)</span> &#123;</span><br><span class="line">    <span class="comment">// Thread.interrupted() è¿”å›å½“å‰çº¿ç¨‹ä¸­æ–­æ ‡è®°ä½ï¼Œå¹¶ä¸”é‡ç½®å½“å‰æ ‡è®°ä½ ä¸º false</span></span><br><span class="line">    <span class="comment">// å¦‚æœè¢«ä¸­æ–­äº†ï¼Œæ ¹æ®æ˜¯å¦åœ¨æ¡ä»¶é˜Ÿåˆ—è¢«ä¸­æ–­çš„ï¼Œè®¾ç½®ä¸­æ–­çŠ¶æ€ç </span></span><br><span class="line">    <span class="keyword">return</span> Thread.interrupted() ?(transferAfterCancelledWait(node) ? THROW_IE : REINTERRUPT) : <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¿™ä¸ªæ–¹æ³•åªæœ‰åœ¨çº¿ç¨‹æ˜¯è¢«æ‰“æ–­å”¤é†’æ—¶æ‰ä¼šè°ƒç”¨</span></span><br><span class="line"><span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">transferAfterCancelledWait</span><span class="params">(Node node)</span> &#123;</span><br><span class="line">    <span class="comment">// æ¡ä»¶æˆç«‹è¯´æ˜å½“å‰nodeä¸€å®šæ˜¯åœ¨æ¡ä»¶é˜Ÿåˆ—å†…ï¼Œå› ä¸º signal è¿ç§»èŠ‚ç‚¹åˆ°é˜»å¡é˜Ÿåˆ—æ—¶ï¼Œä¼šå°†èŠ‚ç‚¹çš„çŠ¶æ€ä¿®æ”¹ä¸º 0</span></span><br><span class="line">    <span class="keyword">if</span> (compareAndSetWaitStatus(node, Node.CONDITION, <span class="number">0</span>)) &#123;</span><br><span class="line">        <span class="comment">// æŠŠã€ä¸­æ–­å”¤é†’çš„ node åŠ å…¥åˆ°é˜»å¡é˜Ÿåˆ—ä¸­ã€‘</span></span><br><span class="line">        enq(node);</span><br><span class="line">        <span class="comment">// è¡¨ç¤ºæ˜¯åœ¨æ¡ä»¶é˜Ÿåˆ—å†…è¢«ä¸­æ–­äº†ï¼Œè®¾ç½®ä¸º THROW_IE ä¸º -1</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//æ‰§è¡Œåˆ°è¿™é‡Œçš„æƒ…å†µï¼š</span></span><br><span class="line">    <span class="comment">//1.å½“å‰nodeå·²ç»è¢«å¤–éƒ¨çº¿ç¨‹è°ƒç”¨ signal æ–¹æ³•å°†å…¶è¿ç§»åˆ° é˜»å¡é˜Ÿåˆ— å†…äº†</span></span><br><span class="line">    <span class="comment">//2.å½“å‰nodeæ­£åœ¨è¢«å¤–éƒ¨çº¿ç¨‹è°ƒç”¨ signal æ–¹æ³•å°†å…¶è¿ç§»è‡³ é˜»å¡é˜Ÿåˆ— è¿›è¡Œä¸­çŠ¶æ€</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å¦‚æœå½“å‰çº¿ç¨‹è¿˜æ²¡åˆ°é˜»å¡é˜Ÿåˆ—ï¼Œä¸€ç›´é‡Šæ”¾ CPU</span></span><br><span class="line">    <span class="keyword">while</span> (!isOnSyncQueue(node))</span><br><span class="line">        Thread.yield();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¡¨ç¤ºå½“å‰èŠ‚ç‚¹è¢«ä¸­æ–­å”¤é†’æ—¶ä¸åœ¨æ¡ä»¶é˜Ÿåˆ—äº†ï¼Œè®¾ç½®ä¸º REINTERRUPT ä¸º 1</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>æœ€åå¼€å§‹å¤„ç†ä¸­æ–­çŠ¶æ€ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">reportInterruptAfterWait</span><span class="params">(<span class="type">int</span> interruptMode)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="comment">// æ¡ä»¶æˆç«‹è¯´æ˜ã€åœ¨æ¡ä»¶é˜Ÿåˆ—å†…å‘ç”Ÿè¿‡ä¸­æ–­ï¼Œæ­¤æ—¶ await æ–¹æ³•æŠ›å‡ºä¸­æ–­å¼‚å¸¸ã€‘</span></span><br><span class="line">    <span class="keyword">if</span> (interruptMode == THROW_IE)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InterruptedException</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¡ä»¶æˆç«‹è¯´æ˜ã€åœ¨æ¡ä»¶é˜Ÿåˆ—å¤–å‘ç”Ÿçš„ä¸­æ–­ï¼Œæ­¤æ—¶è®¾ç½®å½“å‰çº¿ç¨‹çš„ä¸­æ–­æ ‡è®°ä½ä¸º trueã€‘</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (interruptMode == REINTERRUPT)</span><br><span class="line">        <span class="comment">// è¿›è¡Œä¸€æ¬¡è‡ªå·±æ‰“æ–­ï¼Œäº§ç”Ÿä¸­æ–­çš„æ•ˆæœ</span></span><br><span class="line">        selfInterrupt();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><hr><h6 id="signal"><a href="#signal" class="headerlink" title="signal"></a>signal</h6><ul><li><p>å‡è®¾ Thread-1 è¦æ¥å”¤é†’ Thread-0ï¼Œè¿›å…¥ ConditionObject çš„ doSignal æµç¨‹ï¼Œ<strong>å–å¾—ç­‰å¾…é˜Ÿåˆ—ä¸­ç¬¬ä¸€ä¸ª Node</strong>ï¼Œå³ Thread-0 æ‰€åœ¨ Nodeï¼Œå¿…é¡»æŒæœ‰é”æ‰èƒ½å”¤é†’, å› æ­¤ doSignal å†…çº¿ç¨‹å®‰å…¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">signal</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// åˆ¤æ–­è°ƒç”¨ signal æ–¹æ³•çš„çº¿ç¨‹æ˜¯å¦æ˜¯ç‹¬å é”æŒæœ‰çº¿ç¨‹</span></span><br><span class="line">    <span class="keyword">if</span> (!isHeldExclusively())</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalMonitorStateException</span>();</span><br><span class="line">    <span class="comment">// è·å–æ¡ä»¶é˜Ÿåˆ—ä¸­ç¬¬ä¸€ä¸ª Node</span></span><br><span class="line">    <span class="type">Node</span> <span class="variable">first</span> <span class="operator">=</span> firstWaiter;</span><br><span class="line">    <span class="comment">// ä¸ä¸ºç©ºå°±å°†ç¬¬è¯¥èŠ‚ç‚¹ã€è¿ç§»åˆ°é˜»å¡é˜Ÿåˆ—ã€‘</span></span><br><span class="line">    <span class="keyword">if</span> (first != <span class="literal">null</span>)</span><br><span class="line">        doSignal(first);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å”¤é†’ - ã€å°†æ²¡å–æ¶ˆçš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹è½¬ç§»è‡³ AQS é˜Ÿåˆ—å°¾éƒ¨ã€‘</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doSignal</span><span class="params">(Node first)</span> &#123;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">// æˆç«‹è¯´æ˜å½“å‰èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹æ˜¯ nullï¼Œå½“å‰èŠ‚ç‚¹æ˜¯å°¾èŠ‚ç‚¹äº†ï¼Œé˜Ÿåˆ—ä¸­åªæœ‰å½“å‰ä¸€ä¸ªèŠ‚ç‚¹äº†</span></span><br><span class="line">        <span class="keyword">if</span> ((firstWaiter = first.nextWaiter) == <span class="literal">null</span>)</span><br><span class="line">            lastWaiter = <span class="literal">null</span>;</span><br><span class="line">        first.nextWaiter = <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">// å°†ç­‰å¾…é˜Ÿåˆ—ä¸­çš„ Node è½¬ç§»è‡³ AQS é˜Ÿåˆ—ï¼Œä¸æˆåŠŸä¸”è¿˜æœ‰èŠ‚ç‚¹åˆ™ç»§ç»­å¾ªç¯</span></span><br><span class="line">    &#125; <span class="keyword">while</span> (!transferForSignal(first) &amp;&amp; (first = firstWaiter) != <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// signalAll() ä¼šè°ƒç”¨è¿™ä¸ªå‡½æ•°ï¼Œå”¤é†’æ‰€æœ‰çš„èŠ‚ç‚¹</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doSignalAll</span><span class="params">(Node first)</span> &#123;</span><br><span class="line">    lastWaiter = firstWaiter = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="type">Node</span> <span class="variable">next</span> <span class="operator">=</span> first.nextWaiter;</span><br><span class="line">        first.nextWaiter = <span class="literal">null</span>;</span><br><span class="line">        transferForSignal(first);</span><br><span class="line">        first = next;</span><br><span class="line">    <span class="comment">// å”¤é†’æ‰€æœ‰çš„èŠ‚ç‚¹ï¼Œéƒ½æ”¾åˆ°é˜»å¡é˜Ÿåˆ—ä¸­</span></span><br><span class="line">    &#125; <span class="keyword">while</span> (first != <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>æ‰§è¡Œ transferForSignalï¼Œ<strong>å…ˆå°†èŠ‚ç‚¹çš„ waitStatus æ”¹ä¸º 0ï¼Œç„¶ååŠ å…¥ AQS é˜»å¡é˜Ÿåˆ—å°¾éƒ¨</strong>ï¼Œå°† Thread-3 çš„ waitStatus æ”¹ä¸º -1</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¦‚æœèŠ‚ç‚¹çŠ¶æ€æ˜¯å–æ¶ˆ, è¿”å› false è¡¨ç¤ºè½¬ç§»å¤±è´¥, å¦åˆ™è½¬ç§»æˆåŠŸ</span></span><br><span class="line"><span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">transferForSignal</span><span class="params">(Node node)</span> &#123;</span><br><span class="line">    <span class="comment">// CAS ä¿®æ”¹å½“å‰èŠ‚ç‚¹çš„çŠ¶æ€ï¼Œä¿®æ”¹ä¸º 0ï¼Œå› ä¸ºå½“å‰èŠ‚ç‚¹é©¬ä¸Šè¦è¿ç§»åˆ°é˜»å¡é˜Ÿåˆ—äº†</span></span><br><span class="line">    <span class="comment">// å¦‚æœçŠ¶æ€å·²ç»ä¸æ˜¯ CONDITION, è¯´æ˜çº¿ç¨‹è¢«å–æ¶ˆï¼ˆawait é‡Šæ”¾å…¨éƒ¨é”å¤±è´¥ï¼‰æˆ–è€…è¢«ä¸­æ–­ï¼ˆå¯æ‰“æ–­ cancelAcquireï¼‰</span></span><br><span class="line">    <span class="keyword">if</span> (!compareAndSetWaitStatus(node, Node.CONDITION, <span class="number">0</span>))</span><br><span class="line">        <span class="comment">// è¿”å›å‡½æ•°è°ƒç”¨å¤„ç»§ç»­å¯»æ‰¾ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ã€å…ˆæ”¹çŠ¶æ€ï¼Œå†è¿›è¡Œè¿ç§»ã€‘</span></span><br><span class="line">    <span class="comment">// å°†å½“å‰ node å…¥é˜»å¡é˜Ÿåˆ—ï¼Œp æ˜¯å½“å‰èŠ‚ç‚¹åœ¨é˜»å¡é˜Ÿåˆ—çš„ã€å‰é©±èŠ‚ç‚¹ã€‘</span></span><br><span class="line">    <span class="type">Node</span> <span class="variable">p</span> <span class="operator">=</span> enq(node);</span><br><span class="line">    <span class="type">int</span> <span class="variable">ws</span> <span class="operator">=</span> p.waitStatus;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å¦‚æœå‰é©±èŠ‚ç‚¹è¢«å–æ¶ˆæˆ–è€…ä¸èƒ½è®¾ç½®çŠ¶æ€ä¸º Node.SIGNALï¼Œå°± unpark å–æ¶ˆå½“å‰èŠ‚ç‚¹çº¿ç¨‹çš„é˜»å¡çŠ¶æ€, </span></span><br><span class="line">    <span class="comment">// è®© thread-0 çº¿ç¨‹ç«äº‰é”ï¼Œé‡æ–°åŒæ­¥çŠ¶æ€</span></span><br><span class="line">    <span class="keyword">if</span> (ws &gt; <span class="number">0</span> || !compareAndSetWaitStatus(p, ws, Node.SIGNAL))</span><br><span class="line">        LockSupport.unpark(node.thread);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/JUC-ReentrantLock-%E6%9D%A1%E4%BB%B6%E5%8F%98%E9%87%8F3.png"></p></li><li><p>Thread-1 é‡Šæ”¾é”ï¼Œè¿›å…¥ unlock æµç¨‹</p></li></ul><hr><h3 id="ReadWrite"><a href="#ReadWrite" class="headerlink" title="ReadWrite"></a>ReadWrite</h3><h4 id="è¯»å†™é”"><a href="#è¯»å†™é”" class="headerlink" title="è¯»å†™é”"></a>è¯»å†™é”</h4><p>ç‹¬å é”ï¼šæŒ‡è¯¥é”ä¸€æ¬¡åªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹æ‰€æŒæœ‰ï¼Œå¯¹ ReentrantLock å’Œ Synchronized è€Œè¨€éƒ½æ˜¯ç‹¬å é”</p><p>å…±äº«é”ï¼šæŒ‡è¯¥é”å¯ä»¥è¢«å¤šä¸ªçº¿ç¨‹é”æŒæœ‰</p><p>ReentrantReadWriteLock å…¶<strong>è¯»é”æ˜¯å…±äº«é”ï¼Œå†™é”æ˜¯ç‹¬å é”</strong></p><p>ä½œç”¨ï¼šå¤šä¸ªçº¿ç¨‹åŒæ—¶è¯»ä¸€ä¸ªèµ„æºç±»æ²¡æœ‰ä»»ä½•é—®é¢˜ï¼Œä¸ºäº†æ»¡è¶³å¹¶å‘é‡ï¼Œè¯»å–å…±äº«èµ„æºåº”è¯¥åŒæ—¶è¿›è¡Œï¼Œä½†æ˜¯å¦‚æœä¸€ä¸ªçº¿ç¨‹æƒ³å»å†™å…±äº«èµ„æºï¼Œå°±ä¸åº”è¯¥å†æœ‰å…¶å®ƒçº¿ç¨‹å¯ä»¥å¯¹è¯¥èµ„æºè¿›è¡Œè¯»æˆ–å†™</p><p>ä½¿ç”¨è§„åˆ™ï¼š</p><ul><li><p>åŠ é”è§£é”æ ¼å¼ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">r.lock();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// ä¸´ç•ŒåŒº</span></span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">r.unlock();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>è¯»-è¯»èƒ½å…±å­˜ã€è¯»-å†™ä¸èƒ½å…±å­˜ã€å†™-å†™ä¸èƒ½å…±å­˜</p></li><li><p>è¯»é”ä¸æ”¯æŒæ¡ä»¶å˜é‡</p></li><li><p><strong>é‡å…¥æ—¶å‡çº§ä¸æ”¯æŒ</strong>ï¼šæŒæœ‰è¯»é”çš„æƒ…å†µä¸‹å»è·å–å†™é”ä¼šå¯¼è‡´è·å–å†™é”æ°¸ä¹…ç­‰å¾…ï¼Œéœ€è¦å…ˆé‡Šæ”¾è¯»ï¼Œå†å»è·å¾—å†™</p></li><li><p><strong>é‡å…¥æ—¶é™çº§æ”¯æŒ</strong>ï¼šæŒæœ‰å†™é”çš„æƒ…å†µä¸‹å»è·å–è¯»é”ï¼Œé€ æˆåªæœ‰å½“å‰çº¿ç¨‹ä¼šæŒæœ‰è¯»é”ï¼Œå› ä¸ºå†™é”ä¼šäº’æ–¥å…¶ä»–çš„é”</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">w.lock();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    r.lock();<span class="comment">// é™çº§ä¸ºè¯»é”, é‡Šæ”¾å†™é”, è¿™æ ·èƒ½å¤Ÿè®©å…¶å®ƒçº¿ç¨‹è¯»å–ç¼“å­˜</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125; <span class="keyword">finally</span>&#123;</span><br><span class="line">    w.unlock();<span class="comment">// è¦åœ¨å†™é”é‡Šæ”¾ä¹‹å‰è·å–è¯»é”</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">finally</span>&#123;</span><br><span class="line">r.unlock();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p>æ„é€ æ–¹æ³•ï¼š</p><ul><li><code>public ReentrantReadWriteLock()</code>ï¼šé»˜è®¤æ„é€ æ–¹æ³•ï¼Œéå…¬å¹³é”</li><li><code>public ReentrantReadWriteLock(boolean fair)</code>ï¼štrue ä¸ºå…¬å¹³é”</li></ul><p>å¸¸ç”¨APIï¼š</p><ul><li><code>public ReentrantReadWriteLock.ReadLock readLock()</code>ï¼šè¿”å›è¯»é”</li><li><code>public ReentrantReadWriteLock.WriteLock writeLock()</code>ï¼šè¿”å›å†™é”</li><li><code>public void lock()</code>ï¼šåŠ é”</li><li><code>public void unlock()</code>ï¼šè§£é”</li><li><code>public boolean tryLock()</code>ï¼šå°è¯•è·å–é”</li></ul><p>è¯»è¯»å¹¶å‘ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">ReentrantReadWriteLock</span> <span class="variable">rw</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantReadWriteLock</span>();</span><br><span class="line">    ReentrantReadWriteLock.<span class="type">ReadLock</span> <span class="variable">r</span> <span class="operator">=</span> rw.readLock();</span><br><span class="line">    ReentrantReadWriteLock.<span class="type">WriteLock</span> <span class="variable">w</span> <span class="operator">=</span> rw.writeLock();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        r.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;Thread 1 running &quot;</span> + <span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            r.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,<span class="string">&quot;t1&quot;</span>).start();</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        r.lock();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">            System.out.println(<span class="string">&quot;Thread 2 running &quot;</span> + <span class="keyword">new</span> <span class="title class_">Date</span>());</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            r.unlock();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,<span class="string">&quot;t2&quot;</span>).start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h4 id="ç¼“å­˜åº”ç”¨"><a href="#ç¼“å­˜åº”ç”¨" class="headerlink" title="ç¼“å­˜åº”ç”¨"></a>ç¼“å­˜åº”ç”¨</h4><p>ç¼“å­˜æ›´æ–°æ—¶ï¼Œæ˜¯å…ˆæ¸…ç¼“å­˜è¿˜æ˜¯å…ˆæ›´æ–°æ•°æ®åº“</p><ul><li><p>å…ˆæ¸…ç¼“å­˜ï¼šå¯èƒ½é€ æˆåˆšæ¸…ç†ç¼“å­˜è¿˜æ²¡æœ‰æ›´æ–°æ•°æ®åº“ï¼Œçº¿ç¨‹ç›´æ¥æŸ¥è¯¢äº†æ•°æ®åº“æ›´æ–°è¿‡æœŸæ•°æ®åˆ°ç¼“å­˜</p></li><li><p>å…ˆæ›´æ–°æ®åº“ï¼šå¯èƒ½é€ æˆåˆšæ›´æ–°æ•°æ®åº“ï¼Œè¿˜æ²¡æ¸…ç©ºç¼“å­˜å°±æœ‰çº¿ç¨‹ä»ç¼“å­˜æ‹¿åˆ°äº†æ—§æ•°æ®</p></li><li><p>è¡¥å……æƒ…å†µï¼šæŸ¥è¯¢çº¿ç¨‹ A æŸ¥è¯¢æ•°æ®æ—¶æ°å¥½ç¼“å­˜æ•°æ®ç”±äºæ—¶é—´åˆ°æœŸå¤±æ•ˆï¼Œæˆ–æ˜¯ç¬¬ä¸€æ¬¡æŸ¥è¯¢</p><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/JUC-ReentrantReadWriteLockç¼“å­˜.png" style="zoom:80%;" /></li></ul><p>å¯ä»¥ä½¿ç”¨è¯»å†™é”è¿›è¡Œæ“ä½œ</p><hr><h4 id="å®ç°åŸç†-5"><a href="#å®ç°åŸç†-5" class="headerlink" title="å®ç°åŸç†"></a>å®ç°åŸç†</h4><h5 id="æˆå‘˜å±æ€§-5"><a href="#æˆå‘˜å±æ€§-5" class="headerlink" title="æˆå‘˜å±æ€§"></a>æˆå‘˜å±æ€§</h5><p>è¯»å†™é”ç”¨çš„æ˜¯åŒä¸€ä¸ª Sycn åŒæ­¥å™¨ï¼Œå› æ­¤ç­‰å¾…é˜Ÿåˆ—ã€state ç­‰ä¹Ÿæ˜¯åŒä¸€ä¸ªï¼ŒåŸç†ä¸ ReentrantLock åŠ é”ç›¸æ¯”æ²¡æœ‰ç‰¹æ®Šä¹‹å¤„ï¼Œä¸åŒæ˜¯<strong>å†™é”çŠ¶æ€å äº† state çš„ä½ 16 ä½ï¼Œè€Œè¯»é”ä½¿ç”¨çš„æ˜¯ state çš„é«˜ 16 ä½</strong></p><ul><li><p>è¯»å†™é”ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ReentrantReadWriteLock.ReadLock readerLock;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ReentrantReadWriteLock.WriteLock writerLock;</span><br></pre></td></tr></table></figure></li><li><p>æ„é€ æ–¹æ³•ï¼šé»˜è®¤æ˜¯éå…¬å¹³é”ï¼Œå¯ä»¥æŒ‡å®šå‚æ•°åˆ›å»ºå…¬å¹³é”</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ReentrantReadWriteLock</span><span class="params">(<span class="type">boolean</span> fair)</span> &#123;</span><br><span class="line">    <span class="comment">// true ä¸ºå…¬å¹³é”</span></span><br><span class="line">    sync = fair ? <span class="keyword">new</span> <span class="title class_">FairSync</span>() : <span class="keyword">new</span> <span class="title class_">NonfairSync</span>();</span><br><span class="line">    <span class="comment">// è¿™ä¸¤ä¸ª lock å…±äº«åŒä¸€ä¸ª sync å®ä¾‹ï¼Œéƒ½æ˜¯ç”± ReentrantReadWriteLock çš„ sync æä¾›åŒæ­¥å®ç°</span></span><br><span class="line">    readerLock = <span class="keyword">new</span> <span class="title class_">ReadLock</span>(<span class="built_in">this</span>);</span><br><span class="line">    writerLock = <span class="keyword">new</span> <span class="title class_">WriteLock</span>(<span class="built_in">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p>Sync ç±»çš„å±æ€§ï¼š</p><ul><li><p>ç»Ÿè®¡å˜é‡ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç”¨æ¥ç§»ä½</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">SHARED_SHIFT</span>   <span class="operator">=</span> <span class="number">16</span>;</span><br><span class="line"><span class="comment">// é«˜16ä½çš„1</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">SHARED_UNIT</span>    <span class="operator">=</span> (<span class="number">1</span> &lt;&lt; SHARED_SHIFT);</span><br><span class="line"><span class="comment">// 65535ï¼Œ16ä¸ª1ï¼Œä»£è¡¨å†™é”çš„æœ€å¤§é‡å…¥æ¬¡æ•°</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">MAX_COUNT</span>      <span class="operator">=</span> (<span class="number">1</span> &lt;&lt; SHARED_SHIFT) - <span class="number">1</span>;</span><br><span class="line"><span class="comment">// ä½16ä½æ©ç ï¼š0b 1111 1111 1111 1111ï¼Œç”¨æ¥è·å–å†™é”é‡å…¥çš„æ¬¡æ•°</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">EXCLUSIVE_MASK</span> <span class="operator">=</span> (<span class="number">1</span> &lt;&lt; SHARED_SHIFT) - <span class="number">1</span>;</span><br></pre></td></tr></table></figure></li><li><p>è·å–è¯»å†™é”çš„æ¬¡æ•°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è·å–è¯»å†™é”çš„è¯»é”åˆ†é…çš„æ€»æ¬¡æ•°</span></span><br><span class="line"><span class="keyword">static</span> <span class="type">int</span> <span class="title function_">sharedCount</span><span class="params">(<span class="type">int</span> c)</span>    &#123; <span class="keyword">return</span> c &gt;&gt;&gt; SHARED_SHIFT; &#125;</span><br><span class="line"><span class="comment">// å†™é”ï¼ˆç‹¬å ï¼‰é”çš„é‡å…¥æ¬¡æ•°</span></span><br><span class="line"><span class="keyword">static</span> <span class="type">int</span> <span class="title function_">exclusiveCount</span><span class="params">(<span class="type">int</span> c)</span> &#123; <span class="keyword">return</span> c &amp; EXCLUSIVE_MASK; &#125;</span><br></pre></td></tr></table></figure></li><li><p>å†…éƒ¨ç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è®°å½•è¯»é”çº¿ç¨‹è‡ªå·±çš„æŒæœ‰è¯»é”çš„æ•°é‡ï¼ˆé‡å…¥æ¬¡æ•°ï¼‰ï¼Œå› ä¸º state é«˜16ä½è®°å½•çš„æ˜¯å…¨å±€èŒƒå›´å†…æ‰€æœ‰çš„è¯»çº¿ç¨‹è·å–è¯»é”çš„æ€»é‡</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">HoldCounter</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// Use id, not reference, to avoid garbage retention</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">long</span> <span class="variable">tid</span> <span class="operator">=</span> getThreadId(Thread.currentThread());</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// çº¿ç¨‹å®‰å…¨çš„å­˜æ”¾çº¿ç¨‹å„è‡ªçš„ HoldCounter å¯¹è±¡</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">ThreadLocalHoldCounter</span> <span class="keyword">extends</span> <span class="title class_">ThreadLocal</span>&lt;HoldCounter&gt; &#123;</span><br><span class="line">    <span class="keyword">public</span> HoldCounter <span class="title function_">initialValue</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HoldCounter</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>å†…éƒ¨ç±»å®ä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å½“å‰çº¿ç¨‹æŒæœ‰çš„å¯é‡å…¥è¯»é”çš„æ•°é‡ï¼Œè®¡æ•°ä¸º 0 æ—¶åˆ é™¤</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> ThreadLocalHoldCounter readHolds;</span><br><span class="line"><span class="comment">// è®°å½•æœ€åä¸€ä¸ªè·å–ã€è¯»é”ã€‘çº¿ç¨‹çš„ HoldCounter å¯¹è±¡</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> HoldCounter cachedHoldCounter;</span><br></pre></td></tr></table></figure></li><li><p>é¦–æ¬¡è·å–é”ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç¬¬ä¸€ä¸ªè·å–è¯»é”çš„çº¿ç¨‹</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="type">Thread</span> <span class="variable">firstReader</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"><span class="comment">// è®°å½•è¯¥çº¿ç¨‹æŒæœ‰çš„è¯»é”æ¬¡æ•°ï¼ˆè¯»é”é‡å…¥æ¬¡æ•°ï¼‰</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="type">int</span> firstReaderHoldCount;</span><br></pre></td></tr></table></figure></li><li><p>Sync æ„é€ æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Sync() &#123;</span><br><span class="line">    readHolds = <span class="keyword">new</span> <span class="title class_">ThreadLocalHoldCounter</span>();</span><br><span class="line">    <span class="comment">// ç¡®ä¿å…¶ä»–çº¿ç¨‹çš„æ•°æ®å¯è§æ€§ï¼Œstate æ˜¯ volatile ä¿®é¥°çš„å˜é‡ï¼Œé‡å†™è¯¥å€¼ä¼šå°†çº¿ç¨‹æœ¬åœ°ç¼“å­˜æ•°æ®ã€åŒæ­¥è‡³ä¸»å­˜ã€‘</span></span><br><span class="line">    setState(getState()); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><hr><h5 id="åŠ é”åŸç†"><a href="#åŠ é”åŸç†" class="headerlink" title="åŠ é”åŸç†"></a>åŠ é”åŸç†</h5><ul><li><p>t1 çº¿ç¨‹ï¼šw.lockï¼ˆ<strong>å†™é”</strong>ï¼‰ï¼ŒæˆåŠŸä¸Šé” state &#x3D; 0_1</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// lock()  -&gt; sync.acquire(1);</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span> &#123;</span><br><span class="line">    sync.acquire(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">acquire</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">    <span class="comment">// å°è¯•è·å¾—å†™é”ï¼Œè·å¾—å†™é”å¤±è´¥ï¼Œå°†å½“å‰çº¿ç¨‹å…³è”åˆ°ä¸€ä¸ª Node å¯¹è±¡ä¸Š, æ¨¡å¼ä¸ºç‹¬å æ¨¡å¼ </span></span><br><span class="line">    <span class="keyword">if</span> (!tryAcquire(arg) &amp;&amp; acquireQueued(addWaiter(Node.EXCLUSIVE), arg))</span><br><span class="line">        selfInterrupt();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">tryAcquire</span><span class="params">(<span class="type">int</span> acquires)</span> &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">current</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">    <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> getState();</span><br><span class="line">    <span class="comment">// è·å¾—ä½ 16 ä½, ä»£è¡¨å†™é”çš„ state è®¡æ•°</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">w</span> <span class="operator">=</span> exclusiveCount(c);</span><br><span class="line">    <span class="comment">// è¯´æ˜æœ‰è¯»é”æˆ–è€…å†™é”</span></span><br><span class="line">    <span class="keyword">if</span> (c != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// c != 0 and w == 0 è¡¨ç¤ºæœ‰è¯»é”ï¼Œã€è¯»é”ä¸èƒ½å‡çº§ã€‘ï¼Œç›´æ¥è¿”å› false</span></span><br><span class="line">        <span class="comment">// w != 0 è¯´æ˜æœ‰å†™é”ï¼Œå†™é”çš„æ‹¥æœ‰è€…ä¸æ˜¯è‡ªå·±ï¼Œè·å–å¤±è´¥</span></span><br><span class="line">        <span class="keyword">if</span> (w == <span class="number">0</span> || current != getExclusiveOwnerThread())</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ‰§è¡Œåˆ°è¿™é‡Œåªæœ‰ä¸€ç§æƒ…å†µï¼šã€å†™é”é‡å…¥ã€‘ï¼Œæ‰€ä»¥ä¸‹é¢å‡ è¡Œä»£ç ä¸å­˜åœ¨å¹¶å‘</span></span><br><span class="line">        <span class="keyword">if</span> (w + exclusiveCount(acquires) &gt; MAX_COUNT)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;Maximum lock count exceeded&quot;</span>);</span><br><span class="line">        <span class="comment">// å†™é”é‡å…¥, è·å¾—é”æˆåŠŸï¼Œæ²¡æœ‰å¹¶å‘ï¼Œæ‰€ä»¥ä¸ä½¿ç”¨ CAS</span></span><br><span class="line">        setState(c + acquires);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// c == 0ï¼Œè¯´æ˜æ²¡æœ‰ä»»ä½•é”ï¼Œåˆ¤æ–­å†™é”æ˜¯å¦è¯¥é˜»å¡ï¼Œæ˜¯ false å°±å°è¯•è·å–é”ï¼Œå¤±è´¥è¿”å› false</span></span><br><span class="line">    <span class="keyword">if</span> (writerShouldBlock() || !compareAndSetState(c, c + acquires))</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">// è·å¾—é”æˆåŠŸï¼Œè®¾ç½®é”çš„æŒæœ‰çº¿ç¨‹ä¸ºå½“å‰çº¿ç¨‹</span></span><br><span class="line">    setExclusiveOwnerThread(current);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// éå…¬å¹³é” writerShouldBlock æ€»æ˜¯è¿”å› false, æ— éœ€é˜»å¡</span></span><br><span class="line"><span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">writerShouldBlock</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>; </span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// å…¬å¹³é”ä¼šæ£€æŸ¥ AQS é˜Ÿåˆ—ä¸­æ˜¯å¦æœ‰å‰é©±èŠ‚ç‚¹, æ²¡æœ‰(false)æ‰å»ç«äº‰</span></span><br><span class="line"><span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">writerShouldBlock</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> hasQueuedPredecessors();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>t2 r.lockï¼ˆ<strong>è¯»é”</strong>ï¼‰ï¼Œè¿›å…¥ tryAcquireShared æµç¨‹ï¼š</p><ul><li>è¿”å› -1 è¡¨ç¤ºå¤±è´¥</li><li>å¦‚æœè¿”å› 0 è¡¨ç¤ºæˆåŠŸ</li><li>è¿”å›æ­£æ•°è¡¨ç¤ºè¿˜æœ‰å¤šå°‘åç»§èŠ‚ç‚¹æ”¯æŒå…±äº«æ¨¡å¼ï¼Œè¯»å†™é”è¿”å› 1</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">lock</span><span class="params">()</span> &#123;</span><br><span class="line">    sync.acquireShared(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">acquireShared</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">    <span class="comment">// tryAcquireShared è¿”å›è´Ÿæ•°, è¡¨ç¤ºè·å–è¯»é”å¤±è´¥</span></span><br><span class="line">    <span class="keyword">if</span> (tryAcquireShared(arg) &lt; <span class="number">0</span>)</span><br><span class="line">        doAcquireShared(arg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å°è¯•ä»¥å…±äº«æ¨¡å¼è·å–</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">tryAcquireShared</span><span class="params">(<span class="type">int</span> unused)</span> &#123;</span><br><span class="line">    <span class="type">Thread</span> <span class="variable">current</span> <span class="operator">=</span> Thread.currentThread();</span><br><span class="line">    <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> getState();</span><br><span class="line">    <span class="comment">// exclusiveCount(c) ä»£è¡¨ä½ 16 ä½, å†™é”çš„ stateï¼Œæˆç«‹è¯´æ˜æœ‰çº¿ç¨‹æŒæœ‰å†™é”</span></span><br><span class="line">    <span class="comment">// å†™é”çš„æŒæœ‰è€…ä¸æ˜¯å½“å‰çº¿ç¨‹ï¼Œåˆ™è·å–è¯»é”å¤±è´¥ï¼Œã€å†™é”å…è®¸é™çº§ã€‘</span></span><br><span class="line">    <span class="keyword">if</span> (exclusiveCount(c) != <span class="number">0</span> &amp;&amp; getExclusiveOwnerThread() != current)</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// é«˜ 16 ä½ï¼Œä»£è¡¨è¯»é”çš„ stateï¼Œå…±äº«é”åˆ†é…å‡ºå»çš„æ€»æ¬¡æ•°</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">r</span> <span class="operator">=</span> sharedCount(c);</span><br><span class="line">    <span class="comment">// è¯»é”æ˜¯å¦åº”è¯¥é˜»å¡</span></span><br><span class="line">    <span class="keyword">if</span> (!readerShouldBlock() &amp;&amp;r &lt; MAX_COUNT &amp;&amp;</span><br><span class="line">        compareAndSetState(c, c + SHARED_UNIT)) &#123;<span class="comment">// å°è¯•å¢åŠ è¯»é”è®¡æ•°</span></span><br><span class="line">        <span class="comment">// åŠ é”æˆåŠŸ</span></span><br><span class="line">        <span class="comment">// åŠ é”ä¹‹å‰è¯»é”ä¸º 0ï¼Œè¯´æ˜å½“å‰çº¿ç¨‹æ˜¯ç¬¬ä¸€ä¸ªè¯»é”çº¿ç¨‹</span></span><br><span class="line">        <span class="keyword">if</span> (r == <span class="number">0</span>) &#123;</span><br><span class="line">            firstReader = current;</span><br><span class="line">            firstReaderHoldCount = <span class="number">1</span>;</span><br><span class="line">        <span class="comment">// ç¬¬ä¸€ä¸ªè¯»é”çº¿ç¨‹æ˜¯è‡ªå·±å°±å‘ç”Ÿäº†è¯»é”é‡å…¥</span></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (firstReader == current) &#123;</span><br><span class="line">            firstReaderHoldCount++;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// cachedHoldCounter è®¾ç½®ä¸ºå½“å‰çº¿ç¨‹çš„ holdCounter å¯¹è±¡ï¼Œå³æœ€åä¸€ä¸ªè·å–è¯»é”çš„çº¿ç¨‹</span></span><br><span class="line">            <span class="type">HoldCounter</span> <span class="variable">rh</span> <span class="operator">=</span> cachedHoldCounter;</span><br><span class="line">            <span class="comment">// è¯´æ˜è¿˜æ²¡è®¾ç½® rh</span></span><br><span class="line">            <span class="keyword">if</span> (rh == <span class="literal">null</span> || rh.tid != getThreadId(current))</span><br><span class="line">                <span class="comment">// è·å–å½“å‰çº¿ç¨‹çš„é”é‡å…¥çš„å¯¹è±¡ï¼Œèµ‹å€¼ç»™ cachedHoldCounter</span></span><br><span class="line">                cachedHoldCounter = rh = readHolds.get();</span><br><span class="line">            <span class="comment">// è¿˜æ²¡é‡å…¥</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (rh.count == <span class="number">0</span>)</span><br><span class="line">                readHolds.set(rh);</span><br><span class="line">            <span class="comment">// é‡å…¥ + 1</span></span><br><span class="line">            rh.count++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// è¯»é”åŠ é”æˆåŠŸ</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// é€»è¾‘åˆ°è¿™ åº”è¯¥é˜»å¡ï¼Œæˆ–è€… cas åŠ é”å¤±è´¥</span></span><br><span class="line">    <span class="comment">// ä¼šä¸æ–­å°è¯• for (;;) è·å–è¯»é”, æ‰§è¡Œè¿‡ç¨‹ä¸­æ— é˜»å¡</span></span><br><span class="line">    <span class="keyword">return</span> fullTryAcquireShared(current);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// éå…¬å¹³é” readerShouldBlock åå‘å†™é”ä¸€äº›ï¼Œçœ‹ AQS é˜»å¡é˜Ÿåˆ—ä¸­ç¬¬ä¸€ä¸ªèŠ‚ç‚¹æ˜¯å¦æ˜¯å†™é”ï¼Œæ˜¯åˆ™é˜»å¡ï¼Œåä¹‹ä¸é˜»å¡</span></span><br><span class="line"><span class="comment">// é˜²æ­¢ä¸€ç›´æœ‰è¯»é”çº¿ç¨‹ï¼Œå¯¼è‡´å†™é”çº¿ç¨‹é¥¥é¥¿</span></span><br><span class="line"><span class="comment">// true åˆ™è¯¥é˜»å¡, false åˆ™ä¸é˜»å¡</span></span><br><span class="line"><span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">readerShouldBlock</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> apparentlyFirstQueuedIsExclusive();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">readerShouldBlock</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> hasQueuedPredecessors();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">int</span> <span class="title function_">fullTryAcquireShared</span><span class="params">(Thread current)</span> &#123;</span><br><span class="line">    <span class="comment">// å½“å‰è¯»é”çº¿ç¨‹æŒæœ‰çš„è¯»é”æ¬¡æ•°å¯¹è±¡</span></span><br><span class="line">    <span class="type">HoldCounter</span> <span class="variable">rh</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> getState();</span><br><span class="line">        <span class="comment">// è¯´æ˜æœ‰çº¿ç¨‹æŒæœ‰å†™é”</span></span><br><span class="line">        <span class="keyword">if</span> (exclusiveCount(c) != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// å†™é”ä¸æ˜¯è‡ªå·±åˆ™è·å–é”å¤±è´¥</span></span><br><span class="line">            <span class="keyword">if</span> (getExclusiveOwnerThread() != current)</span><br><span class="line">                <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (readerShouldBlock()) &#123;</span><br><span class="line">            <span class="comment">// æ¡ä»¶æˆç«‹è¯´æ˜å½“å‰çº¿ç¨‹æ˜¯ firstReaderï¼Œå½“å‰é”æ˜¯è¯»å¿™ç¢ŒçŠ¶æ€ï¼Œè€Œä¸”å½“å‰çº¿ç¨‹ä¹Ÿæ˜¯è¯»é”é‡å…¥</span></span><br><span class="line">            <span class="keyword">if</span> (firstReader == current) &#123;</span><br><span class="line">                <span class="comment">// assert firstReaderHoldCount &gt; 0;</span></span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (rh == <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// æœ€åä¸€ä¸ªè¯»é”çš„ HoldCounter</span></span><br><span class="line">                    rh = cachedHoldCounter;</span><br><span class="line">                    <span class="comment">// è¯´æ˜å½“å‰çº¿ç¨‹ä¹Ÿä¸æ˜¯æœ€åä¸€ä¸ªè¯»é”</span></span><br><span class="line">                    <span class="keyword">if</span> (rh == <span class="literal">null</span> || rh.tid != getThreadId(current)) &#123;</span><br><span class="line">                        <span class="comment">// è·å–å½“å‰çº¿ç¨‹çš„ HoldCounter</span></span><br><span class="line">                        rh = readHolds.get();</span><br><span class="line">                        <span class="comment">// æ¡ä»¶æˆç«‹è¯´æ˜ HoldCounter å¯¹è±¡æ˜¯ä¸Šä¸€æ­¥ä»£ç æ–°å»ºçš„</span></span><br><span class="line">                        <span class="comment">// å½“å‰çº¿ç¨‹ä¸æ˜¯é”é‡å…¥ï¼Œåœ¨ readerShouldBlock() è¿”å› true æ—¶éœ€è¦å»æ’é˜Ÿ</span></span><br><span class="line">                        <span class="keyword">if</span> (rh.count == <span class="number">0</span>)</span><br><span class="line">                            <span class="comment">// é˜²æ­¢å†…å­˜æ³„æ¼</span></span><br><span class="line">                            readHolds.remove();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (rh.count == <span class="number">0</span>)</span><br><span class="line">                    <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// è¶Šç•Œåˆ¤æ–­</span></span><br><span class="line">        <span class="keyword">if</span> (sharedCount(c) == MAX_COUNT)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;Maximum lock count exceeded&quot;</span>);</span><br><span class="line">        <span class="comment">// è¯»é”åŠ é”ï¼Œæ¡ä»¶å†…çš„é€»è¾‘ä¸ tryAcquireShared ç›¸åŒ</span></span><br><span class="line">        <span class="keyword">if</span> (compareAndSetState(c, c + SHARED_UNIT)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (sharedCount(c) == <span class="number">0</span>) &#123;</span><br><span class="line">                firstReader = current;</span><br><span class="line">                firstReaderHoldCount = <span class="number">1</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (firstReader == current) &#123;</span><br><span class="line">                firstReaderHoldCount++;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (rh == <span class="literal">null</span>)</span><br><span class="line">                    rh = cachedHoldCounter;</span><br><span class="line">                <span class="keyword">if</span> (rh == <span class="literal">null</span> || rh.tid != getThreadId(current))</span><br><span class="line">                    rh = readHolds.get();</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (rh.count == <span class="number">0</span>)</span><br><span class="line">                    readHolds.set(rh);</span><br><span class="line">                rh.count++;</span><br><span class="line">                cachedHoldCounter = rh; <span class="comment">// cache for release</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>è·å–è¯»é”å¤±è´¥ï¼Œè¿›å…¥ sync.doAcquireShared(1) æµç¨‹å¼€å§‹é˜»å¡ï¼Œé¦–å…ˆä¹Ÿæ˜¯è°ƒç”¨ addWaiter æ·»åŠ èŠ‚ç‚¹ï¼Œä¸åŒä¹‹å¤„åœ¨äºèŠ‚ç‚¹è¢«è®¾ç½®ä¸º Node.SHARED æ¨¡å¼è€Œé Node.EXCLUSIVE æ¨¡å¼ï¼Œæ³¨æ„æ­¤æ—¶ t2 ä»å¤„äºæ´»è·ƒçŠ¶æ€</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doAcquireShared</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">    <span class="comment">// å°†å½“å‰çº¿ç¨‹å…³è”åˆ°ä¸€ä¸ª Node å¯¹è±¡ä¸Š, æ¨¡å¼ä¸ºå…±äº«æ¨¡å¼</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> addWaiter(Node.SHARED);</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">failed</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">interrupted</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="comment">// è·å–å‰é©±èŠ‚ç‚¹</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">Node</span> <span class="variable">p</span> <span class="operator">=</span> node.predecessor();</span><br><span class="line">            <span class="comment">// å¦‚æœå‰é©±èŠ‚ç‚¹å°±å¤´èŠ‚ç‚¹å°±å»å°è¯•è·å–é”</span></span><br><span class="line">            <span class="keyword">if</span> (p == head) &#123;</span><br><span class="line">                <span class="comment">// å†ä¸€æ¬¡å°è¯•è·å–è¯»é”</span></span><br><span class="line">                <span class="type">int</span> <span class="variable">r</span> <span class="operator">=</span> tryAcquireShared(arg);</span><br><span class="line">                <span class="comment">// r &gt;= 0 è¡¨ç¤ºè·å–æˆåŠŸ</span></span><br><span class="line">                <span class="keyword">if</span> (r &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">//ã€è¿™é‡Œä¼šè®¾ç½®è‡ªå·±ä¸ºå¤´èŠ‚ç‚¹ï¼Œå”¤é†’ç›¸è¿çš„ååºçš„å…±äº«èŠ‚ç‚¹ã€‘</span></span><br><span class="line">                    setHeadAndPropagate(node, r);</span><br><span class="line">                    p.next = <span class="literal">null</span>; <span class="comment">// help GC</span></span><br><span class="line">                    <span class="keyword">if</span> (interrupted)</span><br><span class="line">                        selfInterrupt();</span><br><span class="line">                    failed = <span class="literal">false</span>;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// æ˜¯å¦åœ¨è·å–è¯»é”å¤±è´¥æ—¶é˜»å¡       park å½“å‰çº¿ç¨‹</span></span><br><span class="line">            <span class="keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp; parkAndCheckInterrupt())</span><br><span class="line">                interrupted = <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (failed)</span><br><span class="line">            cancelAcquire(node);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœæ²¡æœ‰æˆåŠŸï¼Œåœ¨ doAcquireShared å†… for (;;) å¾ªç¯ä¸€æ¬¡ï¼ŒshouldParkAfterFailedAcquire å†…æŠŠå‰é©±èŠ‚ç‚¹çš„ waitStatus æ”¹ä¸º -1ï¼Œå† for (;;) å¾ªç¯ä¸€æ¬¡å°è¯• tryAcquireSharedï¼Œä¸æˆåŠŸåœ¨ parkAndCheckInterrupt() å¤„ park</p><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/JUC-ReentrantReadWriteLockåŠ é”1.png" style="zoom: 80%;" /></li><li><p>è¿™ç§çŠ¶æ€ä¸‹ï¼Œå‡è®¾åˆæœ‰ t3 r.lockï¼Œt4 w.lockï¼Œè¿™æœŸé—´ t1 ä»ç„¶æŒæœ‰é”ï¼Œå°±å˜æˆäº†ä¸‹é¢çš„æ ·å­</p><p><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/JUC-ReentrantReadWriteLock%E5%8A%A0%E9%94%812.png"></p></li></ul><hr><h5 id="è§£é”åŸç†"><a href="#è§£é”åŸç†" class="headerlink" title="è§£é”åŸç†"></a>è§£é”åŸç†</h5><ul><li><p>t1 w.unlockï¼Œ å†™é”è§£é”</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// é‡Šæ”¾é”</span></span><br><span class="line">    sync.release(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">release</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">    <span class="comment">// å°è¯•é‡Šæ”¾é”</span></span><br><span class="line">    <span class="keyword">if</span> (tryRelease(arg)) &#123;</span><br><span class="line">        <span class="type">Node</span> <span class="variable">h</span> <span class="operator">=</span> head;</span><br><span class="line">        <span class="comment">// å¤´èŠ‚ç‚¹ä¸ä¸ºç©ºå¹¶ä¸”ä¸æ˜¯ç­‰å¾…çŠ¶æ€ä¸æ˜¯ 0ï¼Œå”¤é†’åç»§çš„éå–æ¶ˆèŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">if</span> (h != <span class="literal">null</span> &amp;&amp; h.waitStatus != <span class="number">0</span>)</span><br><span class="line">            unparkSuccessor(h);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">tryRelease</span><span class="params">(<span class="type">int</span> releases)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!isHeldExclusively())</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalMonitorStateException</span>();</span><br><span class="line">    <span class="type">int</span> <span class="variable">nextc</span> <span class="operator">=</span> getState() - releases;</span><br><span class="line">    <span class="comment">// å› ä¸ºå¯é‡å…¥çš„åŸå› , å†™é”è®¡æ•°ä¸º 0, æ‰ç®—é‡Šæ”¾æˆåŠŸ</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">free</span> <span class="operator">=</span> exclusiveCount(nextc) == <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (free)</span><br><span class="line">        setExclusiveOwnerThread(<span class="literal">null</span>);</span><br><span class="line">    setState(nextc);</span><br><span class="line">    <span class="keyword">return</span> free;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>å”¤é†’æµç¨‹ sync.unparkSuccessorï¼Œè¿™æ—¶ t2 åœ¨ doAcquireShared çš„ parkAndCheckInterrupt() å¤„æ¢å¤è¿è¡Œï¼Œç»§ç»­å¾ªç¯ï¼Œæ‰§è¡Œ tryAcquireShared æˆåŠŸåˆ™è®©è¯»é”è®¡æ•°åŠ ä¸€</p></li><li><p>æ¥ä¸‹æ¥ t2 è°ƒç”¨ setHeadAndPropagate(node, 1)ï¼Œå®ƒåŸæœ¬æ‰€åœ¨èŠ‚ç‚¹è¢«ç½®ä¸ºå¤´èŠ‚ç‚¹ï¼›è¿˜ä¼šæ£€æŸ¥ä¸‹ä¸€ä¸ªèŠ‚ç‚¹æ˜¯å¦æ˜¯ sharedï¼Œå¦‚æœæ˜¯åˆ™è°ƒç”¨ doReleaseShared() å°† head çš„çŠ¶æ€ä» -1 æ”¹ä¸º 0 å¹¶å”¤é†’ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œè¿™æ—¶ t3 åœ¨ doAcquireShared å†… parkAndCheckInterrupt() å¤„æ¢å¤è¿è¡Œï¼Œ<strong>å”¤é†’è¿ç»­çš„æ‰€æœ‰çš„å…±äº«èŠ‚ç‚¹</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">setHeadAndPropagate</span><span class="params">(Node node, <span class="type">int</span> propagate)</span> &#123;</span><br><span class="line">    <span class="type">Node</span> <span class="variable">h</span> <span class="operator">=</span> head; </span><br><span class="line">    <span class="comment">// è®¾ç½®è‡ªå·±ä¸º head èŠ‚ç‚¹</span></span><br><span class="line">    setHead(node);</span><br><span class="line">    <span class="comment">// propagate è¡¨ç¤ºæœ‰å…±äº«èµ„æºï¼ˆä¾‹å¦‚å…±äº«è¯»é”æˆ–ä¿¡å·é‡ï¼‰ï¼Œä¸º 0 å°±æ²¡æœ‰èµ„æº</span></span><br><span class="line">    <span class="keyword">if</span> (propagate &gt; <span class="number">0</span> || h == <span class="literal">null</span> || h.waitStatus &lt; <span class="number">0</span> ||</span><br><span class="line">        (h = head) == <span class="literal">null</span> || h.waitStatus &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// è·å–ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">        <span class="type">Node</span> <span class="variable">s</span> <span class="operator">=</span> node.next;</span><br><span class="line">        <span class="comment">// å¦‚æœå½“å‰æ˜¯æœ€åä¸€ä¸ªèŠ‚ç‚¹ï¼Œæˆ–è€…ä¸‹ä¸€ä¸ªèŠ‚ç‚¹æ˜¯ã€ç­‰å¾…å…±äº«è¯»é”çš„èŠ‚ç‚¹ã€‘</span></span><br><span class="line">        <span class="keyword">if</span> (s == <span class="literal">null</span> || s.isShared())</span><br><span class="line">            <span class="comment">// å”¤é†’åç»§èŠ‚ç‚¹</span></span><br><span class="line">            doReleaseShared();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doReleaseShared</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœ head.waitStatus == Node.SIGNAL ==&gt; 0 æˆåŠŸ, ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ unpark</span></span><br><span class="line"><span class="comment">// å¦‚æœ head.waitStatus == 0 ==&gt; Node.PROPAGATE</span></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="type">Node</span> <span class="variable">h</span> <span class="operator">=</span> head;</span><br><span class="line">        <span class="keyword">if</span> (h != <span class="literal">null</span> &amp;&amp; h != tail) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">ws</span> <span class="operator">=</span> h.waitStatus;</span><br><span class="line">            <span class="comment">// SIGNAL å”¤é†’åç»§</span></span><br><span class="line">            <span class="keyword">if</span> (ws == Node.SIGNAL) &#123;</span><br><span class="line">                <span class="comment">// å› ä¸ºè¯»é”å…±äº«ï¼Œå¦‚æœå…¶å®ƒçº¿ç¨‹ä¹Ÿåœ¨é‡Šæ”¾è¯»é”ï¼Œé‚£ä¹ˆéœ€è¦å°† waitStatus å…ˆæ”¹ä¸º 0</span></span><br><span class="line">            <span class="comment">// é˜²æ­¢ unparkSuccessor è¢«å¤šæ¬¡æ‰§è¡Œ</span></span><br><span class="line">                <span class="keyword">if</span> (!compareAndSetWaitStatus(h, Node.SIGNAL, <span class="number">0</span>))</span><br><span class="line">                    <span class="keyword">continue</span>;  </span><br><span class="line">                <span class="comment">// å”¤é†’åç»§èŠ‚ç‚¹</span></span><br><span class="line">                unparkSuccessor(h);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å¦‚æœå·²ç»æ˜¯ 0 äº†ï¼Œæ”¹ä¸º -3ï¼Œç”¨æ¥è§£å†³ä¼ æ’­æ€§</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (ws == <span class="number">0</span> &amp;&amp; !compareAndSetWaitStatus(h, <span class="number">0</span>, Node.PROPAGATE))</span><br><span class="line">                <span class="keyword">continue</span>;                </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æ¡ä»¶ä¸æˆç«‹è¯´æ˜è¢«å”¤é†’çš„èŠ‚ç‚¹éå¸¸ç§¯æï¼Œç›´æ¥å°†è‡ªå·±è®¾ç½®ä¸ºäº†æ–°çš„ headï¼Œ</span></span><br><span class="line">        <span class="comment">// æ­¤æ—¶å”¤é†’å®ƒçš„èŠ‚ç‚¹ï¼ˆå‰é©±ï¼‰æ‰§è¡Œ h == head ä¸æˆç«‹ï¼Œæ‰€ä»¥ä¸ä¼šè·³å‡ºå¾ªç¯ï¼Œä¼šç»§ç»­å”¤é†’æ–°çš„ head èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">if</span> (h == head)                   </span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/JUC-ReentrantReadWriteLockè§£é”1.png" style="zoom: 67%;" /></li><li><p>ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¸æ˜¯ shared äº†ï¼Œå› æ­¤ä¸ä¼šç»§ç»­å”¤é†’ t4 æ‰€åœ¨èŠ‚ç‚¹</p></li><li><p>t2 è¯»é”è§£é”ï¼Œè¿›å…¥ sync.releaseShared(1) ä¸­ï¼Œè°ƒç”¨ tryReleaseShared(1) è®©è®¡æ•°å‡ä¸€ï¼Œä½†è®¡æ•°è¿˜ä¸ä¸ºé›¶ï¼Œt3 åŒæ ·è®©è®¡æ•°å‡ä¸€ï¼Œè®¡æ•°ä¸ºé›¶ï¼Œè¿›å…¥doReleaseShared() å°†å¤´èŠ‚ç‚¹ä» -1 æ”¹ä¸º 0 å¹¶å”¤é†’ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unlock</span><span class="params">()</span> &#123;</span><br><span class="line">    sync.releaseShared(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">releaseShared</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (tryReleaseShared(arg)) &#123;</span><br><span class="line">        doReleaseShared();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">tryReleaseShared</span><span class="params">(<span class="type">int</span> unused)</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> getState();</span><br><span class="line">        <span class="type">int</span> <span class="variable">nextc</span> <span class="operator">=</span> c - SHARED_UNIT;</span><br><span class="line">        <span class="comment">// è¯»é”çš„è®¡æ•°ä¸ä¼šå½±å“å…¶å®ƒè·å–è¯»é”çº¿ç¨‹, ä½†ä¼šå½±å“å…¶å®ƒè·å–å†™é”çº¿ç¨‹ï¼Œè®¡æ•°ä¸º 0 æ‰æ˜¯çœŸæ­£é‡Šæ”¾</span></span><br><span class="line">        <span class="keyword">if</span> (compareAndSetState(c, nextc))</span><br><span class="line">            <span class="comment">// è¿”å›æ˜¯å¦å·²ç»å®Œå…¨é‡Šæ”¾äº† </span></span><br><span class="line">            <span class="keyword">return</span> nextc == <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>t4 åœ¨ acquireQueued ä¸­ parkAndCheckInterrupt å¤„æ¢å¤è¿è¡Œï¼Œå†æ¬¡ for (;;) è¿™æ¬¡è‡ªå·±æ˜¯å¤´èŠ‚ç‚¹çš„ä¸´èŠ‚ç‚¹ï¼Œå¹¶ä¸”æ²¡æœ‰å…¶ä»–èŠ‚ç‚¹ç«äº‰ï¼ŒtryAcquire(1) æˆåŠŸï¼Œä¿®æ”¹å¤´ç»“ç‚¹ï¼Œæµç¨‹ç»“æŸ</p><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/JUC-ReentrantReadWriteLockè§£é”2.png" style="zoom: 67%;" /></li></ul><hr><h4 id="Stamped"><a href="#Stamped" class="headerlink" title="Stamped"></a>Stamped</h4><p>StampedLockï¼šè¯»å†™é”ï¼Œè¯¥ç±»è‡ª JDK 8 åŠ å…¥ï¼Œæ˜¯ä¸ºäº†è¿›ä¸€æ­¥ä¼˜åŒ–è¯»æ€§èƒ½</p><p>ç‰¹ç‚¹ï¼š</p><ul><li><p>åœ¨ä½¿ç”¨è¯»é”ã€å†™é”æ—¶éƒ½å¿…é¡»é…åˆæˆ³ä½¿ç”¨</p></li><li><p>StampedLock ä¸æ”¯æŒæ¡ä»¶å˜é‡</p></li><li><p>StampedLock <strong>ä¸æ”¯æŒé‡å…¥</strong></p></li></ul><p>åŸºæœ¬ç”¨æ³•</p><ul><li><p>åŠ è§£è¯»é”ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="variable">stamp</span> <span class="operator">=</span> lock.readLock();</span><br><span class="line">lock.unlockRead(stamp);<span class="comment">// ç±»ä¼¼äº unparkï¼Œè§£æŒ‡å®šçš„é”</span></span><br></pre></td></tr></table></figure></li><li><p>åŠ è§£å†™é”ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="variable">stamp</span> <span class="operator">=</span> lock.writeLock();</span><br><span class="line">lock.unlockWrite(stamp);</span><br></pre></td></tr></table></figure></li><li><p>ä¹è§‚è¯»ï¼ŒStampedLock æ”¯æŒ <code>tryOptimisticRead()</code> æ–¹æ³•ï¼Œè¯»å–å®Œæ¯•ååšä¸€æ¬¡<strong>æˆ³æ ¡éªŒ</strong>ï¼Œå¦‚æœæ ¡éªŒé€šè¿‡ï¼Œè¡¨ç¤ºè¿™æœŸé—´æ²¡æœ‰å…¶ä»–çº¿ç¨‹çš„å†™æ“ä½œï¼Œæ•°æ®å¯ä»¥å®‰å…¨ä½¿ç”¨ï¼Œå¦‚æœæ ¡éªŒæ²¡é€šè¿‡ï¼Œéœ€è¦é‡æ–°è·å–è¯»é”ï¼Œä¿è¯æ•°æ®ä¸€è‡´æ€§</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="variable">stamp</span> <span class="operator">=</span> lock.tryOptimisticRead();</span><br><span class="line"><span class="comment">// éªŒæˆ³</span></span><br><span class="line"><span class="keyword">if</span>(!lock.validate(stamp))&#123;</span><br><span class="line"><span class="comment">// é”å‡çº§</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p>æä¾›ä¸€ä¸ªæ•°æ®å®¹å™¨ç±»å†…éƒ¨åˆ†åˆ«ä½¿ç”¨è¯»é”ä¿æŠ¤æ•°æ®çš„ read() æ–¹æ³•ï¼Œå†™é”ä¿æŠ¤æ•°æ®çš„ write() æ–¹æ³•ï¼š</p><ul><li>è¯»-è¯»å¯ä»¥ä¼˜åŒ–</li><li>è¯»-å†™ä¼˜åŒ–è¯»ï¼Œè¡¥åŠ è¯»é”</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="type">DataContainerStamped</span> <span class="variable">dataContainer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">DataContainerStamped</span>(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">    dataContainer.read(<span class="number">1000</span>);</span><br><span class="line">    &#125;,<span class="string">&quot;t1&quot;</span>).start();</span><br><span class="line">    Thread.sleep(<span class="number">500</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">        dataContainer.write(<span class="number">1000</span>);</span><br><span class="line">    &#125;,<span class="string">&quot;t2&quot;</span>).start();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DataContainerStamped</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> data;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">StampedLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StampedLock</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">read</span><span class="params">(<span class="type">int</span> readTime)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">stamp</span> <span class="operator">=</span> lock.tryOptimisticRead();</span><br><span class="line">        System.out.println(<span class="keyword">new</span> <span class="title class_">Date</span>() + <span class="string">&quot; optimistic read locking&quot;</span> + stamp);</span><br><span class="line">        Thread.sleep(readTime);</span><br><span class="line">        <span class="comment">// æˆ³æœ‰æ•ˆï¼Œç›´æ¥è¿”å›æ•°æ®</span></span><br><span class="line">        <span class="keyword">if</span> (lock.validate(stamp)) &#123;</span><br><span class="line">            Sout(<span class="keyword">new</span> <span class="title class_">Date</span>() + <span class="string">&quot; optimistic read finish...&quot;</span> + stamp);</span><br><span class="line">            <span class="keyword">return</span> data;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è¯´æ˜å…¶ä»–çº¿ç¨‹æ›´æ”¹äº†æˆ³ï¼Œéœ€è¦é”å‡çº§äº†ï¼Œä»ä¹è§‚è¯»å‡çº§åˆ°è¯»é”</span></span><br><span class="line">        System.out.println(<span class="keyword">new</span> <span class="title class_">Date</span>() + <span class="string">&quot; updating to read lock&quot;</span> + stamp);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            stamp = lock.readLock();</span><br><span class="line">            System.out.println(<span class="keyword">new</span> <span class="title class_">Date</span>() + <span class="string">&quot; read lock&quot;</span> + stamp);</span><br><span class="line">            Thread.sleep(readTime);</span><br><span class="line">            System.out.println(<span class="keyword">new</span> <span class="title class_">Date</span>() + <span class="string">&quot; read finish...&quot;</span> + stamp);</span><br><span class="line">            <span class="keyword">return</span> data;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            System.out.println(<span class="keyword">new</span> <span class="title class_">Date</span>() + <span class="string">&quot; read unlock &quot;</span> +  stamp);</span><br><span class="line">            lock.unlockRead(stamp);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">write</span><span class="params">(<span class="type">int</span> newData)</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">stamp</span> <span class="operator">=</span> lock.writeLock();</span><br><span class="line">        System.out.println(<span class="keyword">new</span> <span class="title class_">Date</span>() + <span class="string">&quot; write lock &quot;</span> + stamp);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">            <span class="built_in">this</span>.data = newData;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            System.out.println(<span class="keyword">new</span> <span class="title class_">Date</span>() + <span class="string">&quot; write unlock &quot;</span> + stamp);</span><br><span class="line">            lock.unlockWrite(stamp);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h3 id="CountDown"><a href="#CountDown" class="headerlink" title="CountDown"></a>CountDown</h3><h4 id="åŸºæœ¬ä½¿ç”¨-7"><a href="#åŸºæœ¬ä½¿ç”¨-7" class="headerlink" title="åŸºæœ¬ä½¿ç”¨"></a>åŸºæœ¬ä½¿ç”¨</h4><p>CountDownLatchï¼šè®¡æ•°å™¨ï¼Œç”¨æ¥è¿›è¡Œçº¿ç¨‹åŒæ­¥åä½œï¼Œ<strong>ç­‰å¾…æ‰€æœ‰çº¿ç¨‹å®Œæˆ</strong></p><p>æ„é€ å™¨ï¼š</p><ul><li><code>public CountDownLatch(int count)</code>ï¼šåˆå§‹åŒ–å”¤é†’éœ€è¦çš„ down å‡ æ­¥</li></ul><p>å¸¸ç”¨APIï¼š</p><ul><li><code>public void await() </code>ï¼šè®©å½“å‰çº¿ç¨‹ç­‰å¾…ï¼Œå¿…é¡» down å®Œåˆå§‹åŒ–çš„æ•°å­—æ‰å¯ä»¥è¢«å”¤é†’ï¼Œå¦åˆ™è¿›å…¥æ— é™ç­‰å¾…</li><li><code>public void countDown()</code>ï¼šè®¡æ•°å™¨è¿›è¡Œå‡ 1ï¼ˆdown 1ï¼‰</li></ul><p>åº”ç”¨ï¼šåŒæ­¥ç­‰å¾…å¤šä¸ª Rest è¿œç¨‹è°ƒç”¨ç»“æŸ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// LOL 10äººè¿›å…¥æ¸¸æˆå€’è®¡æ—¶</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="type">CountDownLatch</span> <span class="variable">latch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CountDownLatch</span>(<span class="number">10</span>);</span><br><span class="line">    <span class="type">ExecutorService</span> <span class="variable">service</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">10</span>);</span><br><span class="line">    String[] all = <span class="keyword">new</span> <span class="title class_">String</span>[<span class="number">10</span>];</span><br><span class="line">    <span class="type">Random</span> <span class="variable">random</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; <span class="number">10</span>; j++) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">finalJ</span> <span class="operator">=</span> j;<span class="comment">//å¸¸é‡</span></span><br><span class="line">        service.submit(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt;= <span class="number">100</span>; i++) &#123;</span><br><span class="line">                Thread.sleep(random.nextInt(<span class="number">100</span>));<span class="comment">//éšæœºä¼‘çœ </span></span><br><span class="line">                all[finalJ] = i + <span class="string">&quot;%&quot;</span>;</span><br><span class="line">                System.out.print(<span class="string">&quot;\r&quot;</span> + Arrays.toString(all));<span class="comment">// \rä»£è¡¨è¦†ç›–</span></span><br><span class="line">            &#125;</span><br><span class="line">            latch.countDown();</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    latch.await();</span><br><span class="line">    System.out.println(<span class="string">&quot;\næ¸¸æˆå¼€å§‹&quot;</span>);</span><br><span class="line">    service.shutdown();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">[100%, 100%, 100%, 100%, 100%, 100%, 100%, 100%, 100%, 100%]</span></span><br><span class="line"><span class="comment">æ¸¸æˆå¼€å§‹</span></span><br></pre></td></tr></table></figure><hr><h4 id="å®ç°åŸç†-6"><a href="#å®ç°åŸç†-6" class="headerlink" title="å®ç°åŸç†"></a>å®ç°åŸç†</h4><p>é˜»å¡ç­‰å¾…ï¼š</p><ul><li><p>çº¿ç¨‹è°ƒç”¨ await() ç­‰å¾…å…¶ä»–çº¿ç¨‹å®Œæˆä»»åŠ¡ï¼šæ”¯æŒæ‰“æ–­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">await</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    sync.acquireSharedInterruptibly(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// AbstractQueuedSynchronizer#acquireSharedInterruptibly</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">acquireSharedInterruptibly</span><span class="params">(<span class="type">int</span> arg)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="comment">// åˆ¤æ–­çº¿ç¨‹æ˜¯å¦è¢«æ‰“æ–­ï¼ŒæŠ›å‡ºæ‰“æ–­å¼‚å¸¸</span></span><br><span class="line">    <span class="keyword">if</span> (Thread.interrupted())</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InterruptedException</span>();</span><br><span class="line">    <span class="comment">// å°è¯•è·å–å…±äº«é”ï¼Œæ¡ä»¶æˆç«‹è¯´æ˜ state &gt; 0ï¼Œæ­¤æ—¶çº¿ç¨‹å…¥é˜Ÿé˜»å¡ç­‰å¾…ï¼Œç­‰å¾…å…¶ä»–çº¿ç¨‹è·å–å…±äº«èµ„æº</span></span><br><span class="line">    <span class="comment">// æ¡ä»¶ä¸æˆç«‹è¯´æ˜ state = 0ï¼Œæ­¤æ—¶ä¸éœ€è¦é˜»å¡çº¿ç¨‹ï¼Œç›´æ¥ç»“æŸå‡½æ•°è°ƒç”¨</span></span><br><span class="line">    <span class="keyword">if</span> (tryAcquireShared(arg) &lt; <span class="number">0</span>)</span><br><span class="line">        doAcquireSharedInterruptibly(arg);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// CountDownLatch.Sync#tryAcquireShared</span></span><br><span class="line"><span class="keyword">protected</span> <span class="type">int</span> <span class="title function_">tryAcquireShared</span><span class="params">(<span class="type">int</span> acquires)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (getState() == <span class="number">0</span>) ? <span class="number">1</span> : -<span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>çº¿ç¨‹è¿›å…¥ AbstractQueuedSynchronizer#doAcquireSharedInterruptibly å‡½æ•°é˜»å¡æŒ‚èµ·ï¼Œç­‰å¾… latch å˜ä¸º 0ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doAcquireSharedInterruptibly</span><span class="params">(<span class="type">int</span> arg)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">    <span class="comment">// å°†è°ƒç”¨latch.await()æ–¹æ³•çš„çº¿ç¨‹ åŒ…è£…æˆ SHARED ç±»å‹çš„ node åŠ å…¥åˆ° AQS çš„é˜»å¡é˜Ÿåˆ—ä¸­</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> addWaiter(Node.SHARED);</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">failed</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="comment">// è·å–å½“å‰èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">Node</span> <span class="variable">p</span> <span class="operator">=</span> node.predecessor();</span><br><span class="line">            <span class="comment">// å‰é©±èŠ‚ç‚¹æ—¶å¤´èŠ‚ç‚¹å°±å¯ä»¥å°è¯•è·å–é”</span></span><br><span class="line">            <span class="keyword">if</span> (p == head) &#123;</span><br><span class="line">                <span class="comment">// å†æ¬¡å°è¯•è·å–é”ï¼Œè·å–æˆåŠŸè¿”å› 1</span></span><br><span class="line">                <span class="type">int</span> <span class="variable">r</span> <span class="operator">=</span> tryAcquireShared(arg);</span><br><span class="line">                <span class="keyword">if</span> (r &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">// è·å–é”æˆåŠŸï¼Œè®¾ç½®å½“å‰èŠ‚ç‚¹ä¸º head èŠ‚ç‚¹ï¼Œå¹¶ä¸”å‘åä¼ æ’­</span></span><br><span class="line">                    setHeadAndPropagate(node, r);</span><br><span class="line">                    p.next = <span class="literal">null</span>; <span class="comment">// help GC</span></span><br><span class="line">                    failed = <span class="literal">false</span>;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// é˜»å¡åœ¨è¿™é‡Œ</span></span><br><span class="line">            <span class="keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp; parkAndCheckInterrupt())</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InterruptedException</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// é˜»å¡çº¿ç¨‹è¢«ä¸­æ–­åæŠ›å‡ºå¼‚å¸¸ï¼Œè¿›å…¥å–æ¶ˆèŠ‚ç‚¹çš„é€»è¾‘</span></span><br><span class="line">        <span class="keyword">if</span> (failed)</span><br><span class="line">            cancelAcquire(node);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>è·å–å…±äº«é”æˆåŠŸï¼Œè¿›å…¥å”¤é†’é˜»å¡é˜Ÿåˆ—ä¸­ä¸å¤´èŠ‚ç‚¹ç›¸è¿çš„ SHARED æ¨¡å¼çš„èŠ‚ç‚¹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">setHeadAndPropagate</span><span class="params">(Node node, <span class="type">int</span> propagate)</span> &#123;</span><br><span class="line">    <span class="type">Node</span> <span class="variable">h</span> <span class="operator">=</span> head;</span><br><span class="line">    <span class="comment">// å°†å½“å‰èŠ‚ç‚¹è®¾ç½®ä¸ºæ–°çš„ head èŠ‚ç‚¹ï¼Œå‰é©±èŠ‚ç‚¹å’ŒæŒæœ‰çº¿ç¨‹ç½®ä¸º null</span></span><br><span class="line">    setHead(node);</span><br><span class="line"><span class="comment">// propagate = 1ï¼Œæ¡ä»¶ä¸€æˆç«‹</span></span><br><span class="line">    <span class="keyword">if</span> (propagate &gt; <span class="number">0</span> || h == <span class="literal">null</span> || h.waitStatus &lt; <span class="number">0</span> || (h = head) == <span class="literal">null</span> || h.waitStatus &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// è·å–å½“å‰èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹</span></span><br><span class="line">        <span class="type">Node</span> <span class="variable">s</span> <span class="operator">=</span> node.next;</span><br><span class="line">        <span class="comment">// å½“å‰èŠ‚ç‚¹æ˜¯å°¾èŠ‚ç‚¹æ—¶ next ä¸º nullï¼Œæˆ–è€…åç»§èŠ‚ç‚¹æ˜¯ SHARED å…±äº«æ¨¡å¼</span></span><br><span class="line">        <span class="keyword">if</span> (s == <span class="literal">null</span> || s.isShared())</span><br><span class="line">            <span class="comment">// å”¤é†’æ‰€æœ‰çš„ç­‰å¾…å…±äº«é”çš„èŠ‚ç‚¹</span></span><br><span class="line">            doReleaseShared();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p>è®¡æ•°å‡ä¸€ï¼š</p><ul><li><p>çº¿ç¨‹è¿›å…¥ countDown() å®Œæˆè®¡æ•°å™¨å‡ä¸€ï¼ˆé‡Šæ”¾é”ï¼‰çš„æ“ä½œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">countDown</span><span class="params">()</span> &#123;</span><br><span class="line">    sync.releaseShared(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">releaseShared</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">    <span class="comment">// å°è¯•é‡Šæ”¾å…±äº«é”</span></span><br><span class="line">    <span class="keyword">if</span> (tryReleaseShared(arg)) &#123;</span><br><span class="line">        <span class="comment">// é‡Šæ”¾é”æˆåŠŸå¼€å§‹å”¤é†’é˜»å¡èŠ‚ç‚¹</span></span><br><span class="line">        doReleaseShared();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>æ›´æ–° state å€¼ï¼Œæ¯è°ƒç”¨ä¸€æ¬¡ï¼Œstate å€¼å‡ä¸€ï¼Œå½“ state -1 æ­£å¥½ä¸º 0 æ—¶ï¼Œè¿”å› true</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="type">boolean</span> <span class="title function_">tryReleaseShared</span><span class="params">(<span class="type">int</span> releases)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> getState();</span><br><span class="line">        <span class="comment">// æ¡ä»¶æˆç«‹è¯´æ˜å‰é¢ã€å·²ç»æœ‰çº¿ç¨‹è§¦å‘å”¤é†’æ“ä½œã€‘äº†ï¼Œè¿™é‡Œè¿”å› false</span></span><br><span class="line">        <span class="keyword">if</span> (c == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="comment">// è®¡æ•°å™¨å‡ä¸€</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">nextc</span> <span class="operator">=</span> c-<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (compareAndSetState(c, nextc))</span><br><span class="line">            <span class="comment">// è®¡æ•°å™¨ä¸º 0 æ—¶è¿”å› true</span></span><br><span class="line">            <span class="keyword">return</span> nextc == <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>state &#x3D; 0 æ—¶ï¼Œå½“å‰çº¿ç¨‹éœ€è¦æ‰§è¡Œ<strong>å”¤é†’é˜»å¡èŠ‚ç‚¹çš„ä»»åŠ¡</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doReleaseShared</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="type">Node</span> <span class="variable">h</span> <span class="operator">=</span> head;</span><br><span class="line">        <span class="comment">// åˆ¤æ–­é˜Ÿåˆ—æ˜¯å¦æ˜¯ç©ºé˜Ÿåˆ—</span></span><br><span class="line">        <span class="keyword">if</span> (h != <span class="literal">null</span> &amp;&amp; h != tail) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">ws</span> <span class="operator">=</span> h.waitStatus;</span><br><span class="line">            <span class="comment">// å¤´èŠ‚ç‚¹çš„çŠ¶æ€ä¸º signalï¼Œè¯´æ˜åç»§èŠ‚ç‚¹æ²¡æœ‰è¢«å”¤é†’è¿‡</span></span><br><span class="line">            <span class="keyword">if</span> (ws == Node.SIGNAL) &#123;</span><br><span class="line">                <span class="comment">// cas è®¾ç½®å¤´èŠ‚ç‚¹çš„çŠ¶æ€ä¸º 0ï¼Œè®¾ç½®å¤±è´¥ç»§ç»­è‡ªæ—‹</span></span><br><span class="line">                <span class="keyword">if</span> (!compareAndSetWaitStatus(h, Node.SIGNAL, <span class="number">0</span>))</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                <span class="comment">// å”¤é†’åç»§èŠ‚ç‚¹</span></span><br><span class="line">                unparkSuccessor(h);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å¦‚æœæœ‰å…¶ä»–çº¿ç¨‹å·²ç»è®¾ç½®äº†å¤´èŠ‚ç‚¹çš„çŠ¶æ€ï¼Œé‡æ–°è®¾ç½®ä¸º PROPAGATE ä¼ æ’­å±æ€§</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (ws == <span class="number">0</span> &amp;&amp; !compareAndSetWaitStatus(h, <span class="number">0</span>, Node.PROPAGATE))</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æ¡ä»¶ä¸æˆç«‹è¯´æ˜è¢«å”¤é†’çš„èŠ‚ç‚¹éå¸¸ç§¯æï¼Œç›´æ¥å°†è‡ªå·±è®¾ç½®ä¸ºäº†æ–°çš„headï¼Œ</span></span><br><span class="line">        <span class="comment">// æ­¤æ—¶å”¤é†’å®ƒçš„èŠ‚ç‚¹ï¼ˆå‰é©±ï¼‰æ‰§è¡Œ h == head ä¸æˆç«‹ï¼Œæ‰€ä»¥ä¸ä¼šè·³å‡ºå¾ªç¯ï¼Œä¼šç»§ç»­å”¤é†’æ–°çš„ head èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">if</span> (h == head)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><hr><h3 id="CyclicBarrier"><a href="#CyclicBarrier" class="headerlink" title="CyclicBarrier"></a>CyclicBarrier</h3><h4 id="åŸºæœ¬ä½¿ç”¨-8"><a href="#åŸºæœ¬ä½¿ç”¨-8" class="headerlink" title="åŸºæœ¬ä½¿ç”¨"></a>åŸºæœ¬ä½¿ç”¨</h4><p>CyclicBarrierï¼šå¾ªç¯å±éšœï¼Œç”¨æ¥è¿›è¡Œçº¿ç¨‹åä½œï¼Œç­‰å¾…çº¿ç¨‹æ»¡è¶³æŸä¸ªè®¡æ•°ï¼Œæ‰èƒ½è§¦å‘è‡ªå·±æ‰§è¡Œ</p><p>å¸¸ç”¨æ–¹æ³•ï¼š</p><ul><li><code>public CyclicBarrier(int parties, Runnable barrierAction)</code>ï¼šç”¨äºåœ¨çº¿ç¨‹åˆ°è¾¾å±éšœ parties æ—¶ï¼Œæ‰§è¡Œ barrierAction<ul><li>partiesï¼šä»£è¡¨å¤šå°‘ä¸ªçº¿ç¨‹åˆ°è¾¾å±éšœå¼€å§‹è§¦å‘çº¿ç¨‹ä»»åŠ¡</li><li>barrierActionï¼šçº¿ç¨‹ä»»åŠ¡</li></ul></li><li><code>public int await()</code>ï¼šçº¿ç¨‹è°ƒç”¨ await æ–¹æ³•é€šçŸ¥ CyclicBarrier æœ¬çº¿ç¨‹å·²ç»åˆ°è¾¾å±éšœ</li></ul><p>ä¸ CountDownLatch çš„åŒºåˆ«ï¼šCyclicBarrier æ˜¯å¯ä»¥é‡ç”¨çš„</p><p>åº”ç”¨ï¼šå¯ä»¥å®ç°å¤šçº¿ç¨‹ä¸­ï¼ŒæŸä¸ªä»»åŠ¡åœ¨ç­‰å¾…å…¶ä»–çº¿ç¨‹æ‰§è¡Œå®Œæ¯•ä»¥åè§¦å‘</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">ExecutorService</span> <span class="variable">service</span> <span class="operator">=</span> Executors.newFixedThreadPool(<span class="number">2</span>);</span><br><span class="line">    <span class="type">CyclicBarrier</span> <span class="variable">barrier</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CyclicBarrier</span>(<span class="number">2</span>, () -&gt; &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;task1 task2 finish...&quot;</span>);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123; <span class="comment">// å¾ªç¯é‡ç”¨</span></span><br><span class="line">        service.submit(() -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;task1 begin...&quot;</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                barrier.await();    <span class="comment">// 2 - 1 = 1</span></span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException | BrokenBarrierException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        service.submit(() -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;task2 begin...&quot;</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">                barrier.await();    <span class="comment">// 1 - 1 = 0</span></span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException | BrokenBarrierException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    service.shutdown();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h4 id="å®ç°åŸç†-7"><a href="#å®ç°åŸç†-7" class="headerlink" title="å®ç°åŸç†"></a>å®ç°åŸç†</h4><h5 id="æˆå‘˜å±æ€§-6"><a href="#æˆå‘˜å±æ€§-6" class="headerlink" title="æˆå‘˜å±æ€§"></a>æˆå‘˜å±æ€§</h5><ul><li><p>å…¨å±€é”ï¼šåˆ©ç”¨å¯é‡å…¥é”å®ç°çš„å·¥å…·ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// barrier å®ç°æ˜¯ä¾èµ–äºConditionæ¡ä»¶é˜Ÿåˆ—ï¼Œcondition æ¡ä»¶é˜Ÿåˆ—å¿…é¡»ä¾èµ–lockæ‰èƒ½ä½¿ç”¨</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br><span class="line"><span class="comment">// çº¿ç¨‹æŒ‚èµ·å®ç°ä½¿ç”¨çš„ condition é˜Ÿåˆ—ï¼Œå½“å‰ä»£æ‰€æœ‰çº¿ç¨‹åˆ°ä½ï¼Œè¿™ä¸ªæ¡ä»¶é˜Ÿåˆ—å†…çš„çº¿ç¨‹æ‰ä¼šè¢«å”¤é†’</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">Condition</span> <span class="variable">trip</span> <span class="operator">=</span> lock.newCondition();</span><br></pre></td></tr></table></figure></li><li><p>çº¿ç¨‹æ•°é‡ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> parties;<span class="comment">// ä»£è¡¨å¤šå°‘ä¸ªçº¿ç¨‹åˆ°è¾¾å±éšœå¼€å§‹è§¦å‘çº¿ç¨‹ä»»åŠ¡</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">int</span> count;<span class="comment">// è¡¨ç¤ºå½“å‰â€œä»£â€è¿˜æœ‰å¤šå°‘ä¸ªçº¿ç¨‹æœªåˆ°ä½ï¼Œåˆå§‹å€¼ä¸º parties</span></span><br></pre></td></tr></table></figure></li><li><p>å½“å‰ä»£ä¸­æœ€åä¸€ä¸ªçº¿ç¨‹åˆ°ä½åè¦æ‰§è¡Œçš„äº‹ä»¶ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Runnable barrierCommand;</span><br></pre></td></tr></table></figure></li><li><p>ä»£ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¡¨ç¤º barrier å¯¹è±¡å½“å‰ ä»£</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">Generation</span> <span class="variable">generation</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Generation</span>();</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Generation</span> &#123;</span><br><span class="line">    <span class="comment">// è¡¨ç¤ºå½“å‰â€œä»£â€æ˜¯å¦è¢«æ‰“ç ´ï¼Œå¦‚æœè¢«æ‰“ç ´å†æ¥åˆ°è¿™ä¸€ä»£çš„çº¿ç¨‹ å°±ä¼šç›´æ¥æŠ›å‡º BrokenException å¼‚å¸¸</span></span><br><span class="line">    <span class="comment">// ä¸”åœ¨è¿™ä¸€ä»£æŒ‚èµ·çš„çº¿ç¨‹éƒ½ä¼šè¢«å”¤é†’ï¼Œç„¶åæŠ›å‡º BrokerException å¼‚å¸¸ã€‚</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">broken</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>æ„é€ æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">CyclicBarrie</span><span class="params">(<span class="type">int</span> parties, Runnable barrierAction)</span> &#123;</span><br><span class="line">    <span class="comment">// å› ä¸ºå°äºç­‰äº 0 çš„ barrier æ²¡æœ‰ä»»ä½•æ„ä¹‰</span></span><br><span class="line">    <span class="keyword">if</span> (parties &lt;= <span class="number">0</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>();</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.parties = parties;</span><br><span class="line">    <span class="built_in">this</span>.count = parties;</span><br><span class="line">    <span class="comment">// å¯ä»¥ä¸º null</span></span><br><span class="line">    <span class="built_in">this</span>.barrierCommand = barrierAction;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/JUC-CyclicBarrierå·¥ä½œåŸç†.png" style="zoom: 80%;" /><hr><h5 id="æˆå‘˜æ–¹æ³•-5"><a href="#æˆå‘˜æ–¹æ³•-5" class="headerlink" title="æˆå‘˜æ–¹æ³•"></a>æˆå‘˜æ–¹æ³•</h5><ul><li><p>await()ï¼šé˜»å¡ç­‰å¾…æ‰€æœ‰çº¿ç¨‹åˆ°ä½</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">await</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException, BrokenBarrierException &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> dowait(<span class="literal">false</span>, <span class="number">0L</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (TimeoutException toe) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(toe); <span class="comment">// cannot happen</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// timedï¼šè¡¨ç¤ºå½“å‰è°ƒç”¨awaitæ–¹æ³•çš„çº¿ç¨‹æ˜¯å¦æŒ‡å®šäº†è¶…æ—¶æ—¶é•¿ï¼Œå¦‚æœ true è¡¨ç¤ºçº¿ç¨‹æ˜¯å“åº”è¶…æ—¶çš„</span></span><br><span class="line"><span class="comment">// nanosï¼šçº¿ç¨‹ç­‰å¾…è¶…æ—¶æ—¶é•¿ï¼Œå•ä½æ˜¯çº³ç§’</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">int</span> <span class="title function_">dowait</span><span class="params">(<span class="type">boolean</span> timed, <span class="type">long</span> nanos)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="built_in">this</span>.lock;</span><br><span class="line">    <span class="comment">// åŠ é”</span></span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// è·å–å½“å‰ä»£</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">Generation</span> <span class="variable">g</span> <span class="operator">=</span> generation;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ã€å¦‚æœå½“å‰ä»£æ˜¯å·²ç»è¢«æ‰“ç ´çŠ¶æ€ï¼Œåˆ™å½“å‰è°ƒç”¨awaitæ–¹æ³•çš„çº¿ç¨‹ï¼Œç›´æ¥æŠ›å‡ºBrokenå¼‚å¸¸ã€‘</span></span><br><span class="line">        <span class="keyword">if</span> (g.broken)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BrokenBarrierException</span>();</span><br><span class="line"><span class="comment">// å¦‚æœå½“å‰çº¿ç¨‹è¢«ä¸­æ–­äº†ï¼Œåˆ™æ‰“ç ´å½“å‰ä»£ï¼Œç„¶åå½“å‰çº¿ç¨‹æŠ›å‡ºä¸­æ–­å¼‚å¸¸</span></span><br><span class="line">        <span class="keyword">if</span> (Thread.interrupted()) &#123;</span><br><span class="line">            <span class="comment">// è®¾ç½®å½“å‰ä»£çš„çŠ¶æ€ä¸º broken çŠ¶æ€ï¼Œå”¤é†’åœ¨ trip æ¡ä»¶é˜Ÿåˆ—å†…çš„çº¿ç¨‹</span></span><br><span class="line">            breakBarrier();</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InterruptedException</span>();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// é€»è¾‘åˆ°è¿™è¯´æ˜ï¼Œå½“å‰çº¿ç¨‹ä¸­æ–­çŠ¶æ€æ˜¯ falseï¼Œ å½“å‰ä»£çš„ broken ä¸º falseï¼ˆæœªæ‰“ç ´çŠ¶æ€ï¼‰</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// å‡è®¾ parties ç»™çš„æ˜¯ 5ï¼Œé‚£ä¹ˆindexå¯¹åº”çš„å€¼ä¸º 4,3,2,1,0</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> --count;</span><br><span class="line">        <span class="comment">// æ¡ä»¶æˆç«‹è¯´æ˜å½“å‰çº¿ç¨‹æ˜¯æœ€åä¸€ä¸ªåˆ°è¾¾ barrier çš„çº¿ç¨‹ï¼Œã€éœ€è¦å¼€å¯æ–°ä»£ï¼Œå”¤é†’é˜»å¡çº¿ç¨‹ã€‘</span></span><br><span class="line">        <span class="keyword">if</span> (index == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// æ …æ ä»»åŠ¡å¯åŠ¨æ ‡è®°</span></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">ranAction</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="type">Runnable</span> <span class="variable">command</span> <span class="operator">=</span> barrierCommand;</span><br><span class="line">                <span class="keyword">if</span> (command != <span class="literal">null</span>)</span><br><span class="line">                    <span class="comment">// å¯åŠ¨è§¦å‘çš„ä»»åŠ¡</span></span><br><span class="line">                    command.run();</span><br><span class="line">                <span class="comment">// run()æœªæŠ›å‡ºå¼‚å¸¸çš„è¯ï¼Œå¯åŠ¨æ ‡è®°è®¾ç½®ä¸º true</span></span><br><span class="line">                ranAction = <span class="literal">true</span>;</span><br><span class="line">                <span class="comment">// å¼€å¯æ–°çš„ä¸€ä»£ï¼Œè¿™é‡Œä¼šã€å”¤é†’æ‰€æœ‰çš„é˜»å¡é˜Ÿåˆ—ã€‘</span></span><br><span class="line">                nextGeneration();</span><br><span class="line">                <span class="comment">// è¿”å› 0 å› ä¸ºå½“å‰çº¿ç¨‹æ˜¯æ­¤ä»£æœ€åä¸€ä¸ªåˆ°è¾¾çš„çº¿ç¨‹ï¼Œindex == 0</span></span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="comment">// å¦‚æœ command.run() æ‰§è¡ŒæŠ›å‡ºå¼‚å¸¸çš„è¯ï¼Œä¼šè¿›å…¥åˆ°è¿™é‡Œ</span></span><br><span class="line">                <span class="keyword">if</span> (!ranAction)</span><br><span class="line">                    breakBarrier();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è‡ªæ—‹ï¼Œä¸€ç›´åˆ°æ¡ä»¶æ»¡è¶³ã€å½“å‰ä»£è¢«æ‰“ç ´ã€çº¿ç¨‹è¢«ä¸­æ–­ï¼Œç­‰å¾…è¶…æ—¶</span></span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// æ ¹æ®æ˜¯å¦éœ€è¦è¶…æ—¶ç­‰å¾…é€‰æ‹©é˜»å¡æ–¹æ³•</span></span><br><span class="line">                <span class="keyword">if</span> (!timed)</span><br><span class="line">                    <span class="comment">// å½“å‰çº¿ç¨‹é‡Šæ”¾æ‰ lockï¼Œã€è¿›å…¥åˆ° trip æ¡ä»¶é˜Ÿåˆ—çš„å°¾éƒ¨æŒ‚èµ·è‡ªå·±ã€‘ï¼Œç­‰å¾…è¢«å”¤é†’</span></span><br><span class="line">                    trip.await();</span><br><span class="line">                <span class="keyword">else</span> <span class="keyword">if</span> (nanos &gt; <span class="number">0L</span>)</span><br><span class="line">                    nanos = trip.awaitNanos(nanos);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException ie) &#123;</span><br><span class="line">                <span class="comment">// è¢«ä¸­æ–­åæ¥åˆ°è¿™é‡Œçš„é€»è¾‘</span></span><br><span class="line">                </span><br><span class="line">                <span class="comment">// å½“å‰ä»£æ²¡æœ‰å˜åŒ–å¹¶ä¸”æ²¡æœ‰è¢«æ‰“ç ´</span></span><br><span class="line">                <span class="keyword">if</span> (g == generation &amp;&amp; !g.broken) &#123;</span><br><span class="line">                    <span class="comment">// æ‰“ç ´å±éšœ</span></span><br><span class="line">                    breakBarrier();</span><br><span class="line">                    <span class="comment">// node èŠ‚ç‚¹åœ¨ã€æ¡ä»¶é˜Ÿåˆ—ã€‘å†…æ”¶åˆ°ä¸­æ–­ä¿¡å·æ—¶ ä¼šæŠ›å‡ºä¸­æ–­å¼‚å¸¸</span></span><br><span class="line">                    <span class="keyword">throw</span> ie;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// ç­‰å¾…è¿‡ç¨‹ä¸­ä»£å˜åŒ–äº†ï¼Œå®Œæˆä¸€æ¬¡è‡ªæˆ‘æ‰“æ–­</span></span><br><span class="line">                    Thread.currentThread().interrupt();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"><span class="comment">// å”¤é†’åçš„çº¿ç¨‹ï¼Œã€åˆ¤æ–­å½“å‰ä»£å·²ç»è¢«æ‰“ç ´ï¼Œçº¿ç¨‹å”¤é†’åä¾æ¬¡æŠ›å‡º BrokenBarrier å¼‚å¸¸ã€‘</span></span><br><span class="line">            <span class="keyword">if</span> (g.broken)</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">BrokenBarrierException</span>();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// å½“å‰çº¿ç¨‹æŒ‚èµ·æœŸé—´ï¼Œæœ€åä¸€ä¸ªçº¿ç¨‹åˆ°ä½äº†ï¼Œç„¶åè§¦å‘äº†å¼€å¯æ–°çš„ä¸€ä»£çš„é€»è¾‘</span></span><br><span class="line">            <span class="keyword">if</span> (g != generation)</span><br><span class="line">                <span class="keyword">return</span> index;</span><br><span class="line"><span class="comment">// å½“å‰çº¿ç¨‹ trip ä¸­ç­‰å¾…è¶…æ—¶ï¼Œç„¶åä¸»åŠ¨è½¬ç§»åˆ°é˜»å¡é˜Ÿåˆ—</span></span><br><span class="line">            <span class="keyword">if</span> (timed &amp;&amp; nanos &lt;= <span class="number">0L</span>) &#123;</span><br><span class="line">                breakBarrier();</span><br><span class="line">                <span class="comment">// æŠ›å‡ºè¶…æ—¶å¼‚å¸¸</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">TimeoutException</span>();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// è§£é”</span></span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>breakBarrier()ï¼šæ‰“ç ´ Barrier å±éšœ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">breakBarrier</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// å°†ä»£ä¸­çš„ broken è®¾ç½®ä¸º trueï¼Œè¡¨ç¤ºè¿™ä¸€ä»£æ˜¯è¢«æ‰“ç ´äº†ï¼Œå†æ¥åˆ°è¿™ä¸€ä»£çš„çº¿ç¨‹ï¼Œç›´æ¥æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">    generation.broken = <span class="literal">true</span>;</span><br><span class="line">    <span class="comment">// é‡ç½® count ä¸º parties</span></span><br><span class="line">    count = parties;</span><br><span class="line">    <span class="comment">// å°†åœ¨tripæ¡ä»¶é˜Ÿåˆ—å†…æŒ‚èµ·çš„çº¿ç¨‹å…¨éƒ¨å”¤é†’ï¼Œå”¤é†’åçš„çº¿ç¨‹ä¼šæ£€æŸ¥å½“å‰æ˜¯å¦æ˜¯æ‰“ç ´çš„ï¼Œç„¶åæŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">    trip.signalAll();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>nextGeneration()ï¼šå¼€å¯æ–°çš„ä¸‹ä¸€ä»£ </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">nextGeneration</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// å°†åœ¨ trip æ¡ä»¶é˜Ÿåˆ—å†…æŒ‚èµ·çš„çº¿ç¨‹å…¨éƒ¨å”¤é†’</span></span><br><span class="line">    trip.signalAll();</span><br><span class="line">    <span class="comment">// é‡ç½® count ä¸º parties</span></span><br><span class="line">    count = parties;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¼€å¯æ–°çš„ä¸€ä»£ï¼Œä½¿ç”¨ä¸€ä¸ªæ–°çš„generationå¯¹è±¡ï¼Œè¡¨ç¤ºæ–°çš„ä¸€ä»£ï¼Œæ–°çš„ä¸€ä»£å’Œä¸Šä¸€ä»£ã€æ²¡æœ‰ä»»ä½•å…³ç³»ã€‘</span></span><br><span class="line">    generation = <span class="keyword">new</span> <span class="title class_">Generation</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p>å‚è€ƒè§†é¢‘ï¼š<a href="https://space.bilibili.com/457326371/">https://space.bilibili.com/457326371/</a></p><hr><h3 id="Semaphore"><a href="#Semaphore" class="headerlink" title="Semaphore"></a>Semaphore</h3><h4 id="åŸºæœ¬ä½¿ç”¨-9"><a href="#åŸºæœ¬ä½¿ç”¨-9" class="headerlink" title="åŸºæœ¬ä½¿ç”¨"></a>åŸºæœ¬ä½¿ç”¨</h4><p>synchronized å¯ä»¥èµ·åˆ°é”çš„ä½œç”¨ï¼Œä½†æŸä¸ªæ—¶é—´æ®µå†…ï¼Œåªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹å…è®¸æ‰§è¡Œ</p><p>Semaphoreï¼ˆä¿¡å·é‡ï¼‰ç”¨æ¥é™åˆ¶èƒ½åŒæ—¶è®¿é—®å…±äº«èµ„æºçš„çº¿ç¨‹ä¸Šé™ï¼Œéé‡å…¥é”</p><p>æ„é€ æ–¹æ³•ï¼š</p><ul><li><code>public Semaphore(int permits)</code>ï¼špermits è¡¨ç¤ºè®¸å¯çº¿ç¨‹çš„æ•°é‡ï¼ˆstateï¼‰</li><li><code>public Semaphore(int permits, boolean fair)</code>ï¼šfair è¡¨ç¤ºå…¬å¹³æ€§ï¼Œå¦‚æœè®¾ä¸º trueï¼Œä¸‹æ¬¡æ‰§è¡Œçš„çº¿ç¨‹ä¼šæ˜¯ç­‰å¾…æœ€ä¹…çš„çº¿ç¨‹</li></ul><p>å¸¸ç”¨APIï¼š</p><ul><li><code>public void acquire()</code>ï¼šè¡¨ç¤ºè·å–è®¸å¯</li><li><code>public void release()</code>ï¼šè¡¨ç¤ºé‡Šæ”¾è®¸å¯ï¼Œacquire() å’Œ release() æ–¹æ³•ä¹‹é—´çš„ä»£ç ä¸ºåŒæ­¥ä»£ç </li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="comment">// 1.åˆ›å»ºSemaphoreå¯¹è±¡</span></span><br><span class="line">    <span class="type">Semaphore</span> <span class="variable">semaphore</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Semaphore</span>(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2. 10ä¸ªçº¿ç¨‹åŒæ—¶è¿è¡Œ</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 3. è·å–è®¸å¯</span></span><br><span class="line">                semaphore.acquire();</span><br><span class="line">                sout(Thread.currentThread().getName() + <span class="string">&quot; running...&quot;</span>);</span><br><span class="line">                Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                sout(Thread.currentThread().getName() + <span class="string">&quot; end...&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="comment">// 4. é‡Šæ”¾è®¸å¯</span></span><br><span class="line">                semaphore.release();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h4 id="å®ç°åŸç†-8"><a href="#å®ç°åŸç†-8" class="headerlink" title="å®ç°åŸç†"></a>å®ç°åŸç†</h4><p>åŠ é”æµç¨‹ï¼š</p><ul><li><p>Semaphore çš„ permitsï¼ˆstateï¼‰ä¸º 3ï¼Œè¿™æ—¶ 5 ä¸ªçº¿ç¨‹æ¥è·å–èµ„æº</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Sync(<span class="type">int</span> permits) &#123;</span><br><span class="line">    setState(permits);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‡è®¾å…¶ä¸­ Thread-1ï¼ŒThread-2ï¼ŒThread-4 CAS ç«äº‰æˆåŠŸï¼Œpermits å˜ä¸º 0ï¼Œè€Œ Thread-0 å’Œ Thread-3 ç«äº‰å¤±è´¥ï¼Œè¿›å…¥ AQS é˜Ÿåˆ—park é˜»å¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// acquire() -&gt; sync.acquireSharedInterruptibly(1)ï¼Œå¯ä¸­æ–­</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">acquireSharedInterruptibly</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (Thread.interrupted())</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InterruptedException</span>();</span><br><span class="line">    <span class="comment">// å°è¯•è·å–é€šè¡Œè¯ï¼Œè·å–æˆåŠŸè¿”å› &gt;= 0çš„å€¼</span></span><br><span class="line">    <span class="keyword">if</span> (tryAcquireShared(arg) &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="comment">// è·å–è®¸å¯è¯å¤±è´¥ï¼Œè¿›å…¥é˜»å¡</span></span><br><span class="line">        doAcquireSharedInterruptibly(arg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// tryAcquireShared() -&gt; nonfairTryAcquireShared()</span></span><br><span class="line"><span class="comment">// éå…¬å¹³ï¼Œå…¬å¹³é”ä¼šåœ¨å¾ªç¯å†… hasQueuedPredecessors()æ–¹æ³•åˆ¤æ–­é˜»å¡é˜Ÿåˆ—æ˜¯å¦æœ‰ä¸´å¤´èŠ‚ç‚¹(ç¬¬äºŒä¸ªèŠ‚ç‚¹)</span></span><br><span class="line"><span class="keyword">final</span> <span class="type">int</span> <span class="title function_">nonfairTryAcquireShared</span><span class="params">(<span class="type">int</span> acquires)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="comment">// è·å– state ï¼Œstate è¿™é‡Œã€è¡¨ç¤ºé€šè¡Œè¯ã€‘</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">available</span> <span class="operator">=</span> getState();</span><br><span class="line">        <span class="comment">// è®¡ç®—å½“å‰çº¿ç¨‹è·å–é€šè¡Œè¯å®Œæˆä¹‹åï¼Œé€šè¡Œè¯è¿˜å‰©ä½™æ•°é‡</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">remaining</span> <span class="operator">=</span> available - acquires;</span><br><span class="line">        <span class="comment">// å¦‚æœè®¸å¯å·²ç»ç”¨å®Œ, è¿”å›è´Ÿæ•°, è¡¨ç¤ºè·å–å¤±è´¥,</span></span><br><span class="line">        <span class="keyword">if</span> (remaining &lt; <span class="number">0</span> ||</span><br><span class="line">            <span class="comment">// è®¸å¯è¯è¶³å¤Ÿåˆ†é…çš„ï¼Œå¦‚æœ cas é‡è¯•æˆåŠŸ, è¿”å›æ­£æ•°, è¡¨ç¤ºè·å–æˆåŠŸ</span></span><br><span class="line">            compareAndSetState(available, remaining))</span><br><span class="line">            <span class="keyword">return</span> remaining;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doAcquireSharedInterruptibly</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">    <span class="comment">// å°†è°ƒç”¨ Semaphore.aquire æ–¹æ³•çš„çº¿ç¨‹ï¼ŒåŒ…è£…æˆ node åŠ å…¥åˆ° AQS çš„é˜»å¡é˜Ÿåˆ—ä¸­</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">Node</span> <span class="variable">node</span> <span class="operator">=</span> addWaiter(Node.SHARED);</span><br><span class="line">    <span class="comment">// è·å–æ ‡è®°</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">failed</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">Node</span> <span class="variable">p</span> <span class="operator">=</span> node.predecessor();</span><br><span class="line">            <span class="comment">// å‰é©±èŠ‚ç‚¹æ˜¯å¤´èŠ‚ç‚¹å¯ä»¥å†æ¬¡è·å–è®¸å¯</span></span><br><span class="line">            <span class="keyword">if</span> (p == head) &#123;</span><br><span class="line">                <span class="comment">// å†æ¬¡å°è¯•è·å–è®¸å¯ï¼Œã€è¿”å›å‰©ä½™çš„è®¸å¯è¯æ•°é‡ã€‘</span></span><br><span class="line">                <span class="type">int</span> <span class="variable">r</span> <span class="operator">=</span> tryAcquireShared(arg);</span><br><span class="line">                <span class="keyword">if</span> (r &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">// æˆåŠŸåæœ¬çº¿ç¨‹å‡ºé˜Ÿï¼ˆAQSï¼‰, æ‰€åœ¨ Nodeè®¾ç½®ä¸º head</span></span><br><span class="line">                    <span class="comment">// r è¡¨ç¤ºã€å¯ç”¨èµ„æºæ•°ã€‘, ä¸º 0 åˆ™ä¸ä¼šç»§ç»­ä¼ æ’­</span></span><br><span class="line">                    setHeadAndPropagate(node, r); </span><br><span class="line">                    p.next = <span class="literal">null</span>; <span class="comment">// help GC</span></span><br><span class="line">                    failed = <span class="literal">false</span>;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// ä¸æˆåŠŸ, è®¾ç½®ä¸Šä¸€ä¸ªèŠ‚ç‚¹ waitStatus = Node.SIGNAL, ä¸‹è½®è¿›å…¥ park é˜»å¡</span></span><br><span class="line">            <span class="keyword">if</span> (shouldParkAfterFailedAcquire(p, node) &amp;&amp; parkAndCheckInterrupt())</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InterruptedException</span>();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// è¢«æ‰“æ–­åè¿›å…¥è¯¥é€»è¾‘</span></span><br><span class="line">        <span class="keyword">if</span> (failed)</span><br><span class="line">            cancelAcquire(node);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">setHeadAndPropagate</span><span class="params">(Node node, <span class="type">int</span> propagate)</span> &#123;    </span><br><span class="line">    <span class="type">Node</span> <span class="variable">h</span> <span class="operator">=</span> head;</span><br><span class="line">    <span class="comment">// è®¾ç½®è‡ªå·±ä¸º head èŠ‚ç‚¹</span></span><br><span class="line">    setHead(node);</span><br><span class="line">    <span class="comment">// propagate è¡¨ç¤ºæœ‰ã€å…±äº«èµ„æºã€‘ï¼ˆä¾‹å¦‚å…±äº«è¯»é”æˆ–ä¿¡å·é‡ï¼‰</span></span><br><span class="line">    <span class="comment">// head waitStatus == Node.SIGNAL æˆ– Node.PROPAGATEï¼ŒdoReleaseShared å‡½æ•°ä¸­è®¾ç½®çš„</span></span><br><span class="line">    <span class="keyword">if</span> (propagate &gt; <span class="number">0</span> || h == <span class="literal">null</span> || h.waitStatus &lt; <span class="number">0</span> ||</span><br><span class="line">        (h = head) == <span class="literal">null</span> || h.waitStatus &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="type">Node</span> <span class="variable">s</span> <span class="operator">=</span> node.next;</span><br><span class="line">        <span class="comment">// å¦‚æœæ˜¯æœ€åä¸€ä¸ªèŠ‚ç‚¹æˆ–è€…æ˜¯ç­‰å¾…å…±äº«è¯»é”çš„èŠ‚ç‚¹ï¼Œåšä¸€æ¬¡å”¤é†’</span></span><br><span class="line">        <span class="keyword">if</span> (s == <span class="literal">null</span> || s.isShared())</span><br><span class="line">            doReleaseShared();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/JUC-Semaphore%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B1.png"></p></li><li><p>è¿™æ—¶ Thread-4 é‡Šæ”¾äº† permitsï¼ŒçŠ¶æ€å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// release() -&gt; releaseShared()</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">releaseShared</span><span class="params">(<span class="type">int</span> arg)</span> &#123;</span><br><span class="line">    <span class="comment">// å°è¯•é‡Šæ”¾é”</span></span><br><span class="line">    <span class="keyword">if</span> (tryReleaseShared(arg)) &#123;</span><br><span class="line">        doReleaseShared();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">tryReleaseShared</span><span class="params">(<span class="type">int</span> releases)</span> &#123;    </span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="comment">// è·å–å½“å‰é”èµ„æºçš„å¯ç”¨è®¸å¯è¯æ•°é‡</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">current</span> <span class="operator">=</span> getState();</span><br><span class="line">        <span class="type">int</span> <span class="variable">next</span> <span class="operator">=</span> current + releases;</span><br><span class="line">        <span class="comment">// ç´¢å¼•è¶Šç•Œåˆ¤æ–­</span></span><br><span class="line">        <span class="keyword">if</span> (next &lt; current)            </span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;Maximum permit count exceeded&quot;</span>);        </span><br><span class="line">        <span class="comment">// é‡Šæ”¾é”</span></span><br><span class="line">        <span class="keyword">if</span> (compareAndSetState(current, next))            </span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;    </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doReleaseShared</span><span class="params">()</span> &#123;    </span><br><span class="line">    <span class="comment">// PROPAGATE è¯¦è§£    </span></span><br><span class="line">    <span class="comment">// å¦‚æœ head.waitStatus == Node.SIGNAL ==&gt; 0 æˆåŠŸ, ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ unpark</span></span><br><span class="line">    <span class="comment">// å¦‚æœ head.waitStatus == 0 ==&gt; Node.PROPAGATE</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/JUC-Semaphore%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B2.png"></p></li><li><p>æ¥ä¸‹æ¥ Thread-0 ç«äº‰æˆåŠŸï¼Œpermits å†æ¬¡è®¾ç½®ä¸º 0ï¼Œè®¾ç½®è‡ªå·±ä¸º head èŠ‚ç‚¹ï¼Œå¹¶ä¸” unpark æ¥ä¸‹æ¥çš„å…±äº«çŠ¶æ€çš„ Thread-3 èŠ‚ç‚¹ï¼Œä½†ç”±äº permits æ˜¯ 0ï¼Œå› æ­¤ Thread-3 åœ¨å°è¯•ä¸æˆåŠŸåå†æ¬¡è¿›å…¥ park çŠ¶æ€</p></li></ul><hr><h4 id="PROPAGATE"><a href="#PROPAGATE" class="headerlink" title="PROPAGATE"></a>PROPAGATE</h4><p>å‡è®¾å­˜åœ¨æŸæ¬¡å¾ªç¯ä¸­é˜Ÿåˆ—é‡Œæ’é˜Ÿçš„ç»“ç‚¹æƒ…å†µä¸º <code>head(-1) â†’ t1(-1) â†’ t2(0)</code>ï¼Œå­˜åœ¨å°†è¦é‡Šæ”¾ä¿¡å·é‡çš„ T3 å’Œ T4ï¼Œé‡Šæ”¾é¡ºåºä¸ºå…ˆ T3 å T4</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è€ç‰ˆæœ¬ä»£ç </span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">setHeadAndPropagate</span><span class="params">(Node node, <span class="type">int</span> propagate)</span> &#123;    </span><br><span class="line">    setHead(node);    </span><br><span class="line">    <span class="comment">// æœ‰ç©ºé—²èµ„æº    </span></span><br><span class="line">    <span class="keyword">if</span> (propagate &gt; <span class="number">0</span> &amp;&amp; node.waitStatus != <span class="number">0</span>) &#123;    </span><br><span class="line">        <span class="type">Node</span> <span class="variable">s</span> <span class="operator">=</span> node.next;        </span><br><span class="line">        <span class="comment">// ä¸‹ä¸€ä¸ª        </span></span><br><span class="line">        <span class="keyword">if</span> (s == <span class="literal">null</span> || s.isShared())            </span><br><span class="line">            unparkSuccessor(node);        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­£å¸¸æµç¨‹ï¼š</p><ul><li>T3 è°ƒç”¨ releaseShared(1)ï¼Œç›´æ¥è°ƒç”¨äº† unparkSuccessor(head)ï¼Œhead.waitStatus ä» -1 å˜ä¸º 0</li><li>T1 ç”±äº T3 é‡Šæ”¾ä¿¡å·é‡è¢«å”¤é†’ï¼Œç„¶å T4 é‡Šæ”¾ï¼Œå”¤é†’ T2</li></ul><p>BUG æµç¨‹ï¼š</p><ul><li>T3 è°ƒç”¨ releaseShared(1)ï¼Œç›´æ¥è°ƒç”¨äº† unparkSuccessor(head)ï¼Œhead.waitStatus ä» -1 å˜ä¸º 0</li><li>T1 ç”±äº T3 é‡Šæ”¾ä¿¡å·é‡è¢«å”¤é†’ï¼Œè°ƒç”¨ tryAcquireSharedï¼Œè¿”å›å€¼ä¸º 0ï¼ˆè·å–é”æˆåŠŸï¼Œä½†æ²¡æœ‰å‰©ä½™èµ„æºé‡ï¼‰</li><li>T1 è¿˜æ²¡è°ƒç”¨ setHeadAndPropagate æ–¹æ³•ï¼ŒT4 è°ƒç”¨ releaseShared(1)ï¼Œæ­¤æ—¶ head.waitStatus ä¸º 0ï¼ˆæ­¤æ—¶è¯»åˆ°çš„ head å’Œ 1 ä¸­ä¸ºåŒä¸€ä¸ª headï¼‰ï¼Œä¸æ»¡è¶³æ¡ä»¶ï¼Œå› æ­¤ä¸è°ƒç”¨ unparkSuccessor(head)</li><li>T1 è·å–ä¿¡å·é‡æˆåŠŸï¼Œè°ƒç”¨ setHeadAndPropagate(t1.node, 0) æ—¶ï¼Œå› ä¸ºä¸æ»¡è¶³ propagate &gt; 0ï¼ˆå‰©ä½™èµ„æºé‡ &#x3D;&#x3D; 0ï¼‰ï¼Œä»è€Œä¸ä¼šå”¤é†’åç»§ç»“ç‚¹ï¼Œ <strong>T2 çº¿ç¨‹å¾—ä¸åˆ°å”¤é†’</strong></li></ul><p>æ›´æ–°åæµç¨‹ï¼š</p><ul><li><p>T3 è°ƒç”¨ releaseShared(1)ï¼Œç›´æ¥è°ƒç”¨äº† unparkSuccessor(head)ï¼Œhead.waitStatus ä» -1 å˜ä¸º 0</p></li><li><p>T1 ç”±äº T3 é‡Šæ”¾ä¿¡å·é‡è¢«å”¤é†’ï¼Œè°ƒç”¨ tryAcquireSharedï¼Œè¿”å›å€¼ä¸º 0ï¼ˆè·å–é”æˆåŠŸï¼Œä½†æ²¡æœ‰å‰©ä½™èµ„æºé‡ï¼‰</p></li><li><p>T1 è¿˜æ²¡è°ƒç”¨ setHeadAndPropagate æ–¹æ³•ï¼ŒT4 è°ƒç”¨ releaseShared()ï¼Œæ­¤æ—¶ head.waitStatus ä¸º 0ï¼ˆæ­¤æ—¶è¯»åˆ°çš„ head å’Œ 1 ä¸­ä¸ºåŒä¸€ä¸ª headï¼‰ï¼Œè°ƒç”¨ doReleaseShared() å°†ç­‰å¾…çŠ¶æ€ç½®ä¸º <strong>PROPAGATEï¼ˆ-3ï¼‰</strong></p></li><li><p>T1 è·å–ä¿¡å·é‡æˆåŠŸï¼Œè°ƒç”¨ setHeadAndPropagate æ—¶ï¼Œè¯»åˆ° h.waitStatus &lt; 0ï¼Œä»è€Œè°ƒç”¨ doReleaseShared() å”¤é†’ T2</p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">setHeadAndPropagate</span><span class="params">(Node node, <span class="type">int</span> propagate)</span> &#123;    </span><br><span class="line">    <span class="type">Node</span> <span class="variable">h</span> <span class="operator">=</span> head;</span><br><span class="line">    <span class="comment">// è®¾ç½®è‡ªå·±ä¸º head èŠ‚ç‚¹</span></span><br><span class="line">    setHead(node);</span><br><span class="line">    <span class="comment">// propagate è¡¨ç¤ºæœ‰å…±äº«èµ„æºï¼ˆä¾‹å¦‚å…±äº«è¯»é”æˆ–ä¿¡å·é‡ï¼‰</span></span><br><span class="line">    <span class="comment">// head waitStatus == Node.SIGNAL æˆ– Node.PROPAGATE</span></span><br><span class="line">    <span class="keyword">if</span> (propagate &gt; <span class="number">0</span> || h == <span class="literal">null</span> || h.waitStatus &lt; <span class="number">0</span> ||</span><br><span class="line">        (h = head) == <span class="literal">null</span> || h.waitStatus &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="type">Node</span> <span class="variable">s</span> <span class="operator">=</span> node.next;</span><br><span class="line">        <span class="comment">// å¦‚æœæ˜¯æœ€åä¸€ä¸ªèŠ‚ç‚¹æˆ–è€…æ˜¯ç­‰å¾…å…±äº«è¯»é”çš„èŠ‚ç‚¹ï¼Œåšä¸€æ¬¡å”¤é†’</span></span><br><span class="line">        <span class="keyword">if</span> (s == <span class="literal">null</span> || s.isShared())</span><br><span class="line">            doReleaseShared();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å”¤é†’</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">doReleaseShared</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœ head.waitStatus == Node.SIGNAL ==&gt; 0 æˆåŠŸ, ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ unpark</span></span><br><span class="line">    <span class="comment">// å¦‚æœ head.waitStatus == 0 ==&gt; Node.PROPAGATE    </span></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="type">Node</span> <span class="variable">h</span> <span class="operator">=</span> head;</span><br><span class="line">        <span class="keyword">if</span> (h != <span class="literal">null</span> &amp;&amp; h != tail) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">ws</span> <span class="operator">=</span> h.waitStatus;</span><br><span class="line">            <span class="keyword">if</span> (ws == Node.SIGNAL) &#123;</span><br><span class="line">                <span class="comment">// é˜²æ­¢ unparkSuccessor è¢«å¤šæ¬¡æ‰§è¡Œ</span></span><br><span class="line">                <span class="keyword">if</span> (!compareAndSetWaitStatus(h, Node.SIGNAL, <span class="number">0</span>))</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                <span class="comment">// å”¤é†’åç»§èŠ‚ç‚¹</span></span><br><span class="line">                unparkSuccessor(h);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å¦‚æœå·²ç»æ˜¯ 0 äº†ï¼Œæ”¹ä¸º -3ï¼Œç”¨æ¥è§£å†³ä¼ æ’­æ€§</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (ws == <span class="number">0</span> &amp;&amp; !compareAndSetWaitStatus(h, <span class="number">0</span>, Node.PROPAGATE))</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (h == head)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h3 id="Exchanger"><a href="#Exchanger" class="headerlink" title="Exchanger"></a>Exchanger</h3><p>Exchangerï¼šäº¤æ¢å™¨ï¼Œæ˜¯ä¸€ä¸ªç”¨äºçº¿ç¨‹é—´åä½œçš„å·¥å…·ç±»ï¼Œç”¨äºè¿›è¡Œçº¿ç¨‹é—´çš„æ•°æ®äº¤æ¢</p><p>å·¥ä½œæµç¨‹ï¼šä¸¤ä¸ªçº¿ç¨‹é€šè¿‡ exchange æ–¹æ³•äº¤æ¢æ•°æ®ï¼Œå¦‚æœç¬¬ä¸€ä¸ªçº¿ç¨‹å…ˆæ‰§è¡Œ exchange() æ–¹æ³•ï¼Œå®ƒä¼šä¸€ç›´ç­‰å¾…ç¬¬äºŒä¸ªçº¿ç¨‹ä¹Ÿæ‰§è¡Œ exchange æ–¹æ³•ï¼Œå½“ä¸¤ä¸ªçº¿ç¨‹éƒ½åˆ°è¾¾åŒæ­¥ç‚¹æ—¶ï¼Œè¿™ä¸¤ä¸ªçº¿ç¨‹å°±å¯ä»¥äº¤æ¢æ•°æ®</p><p>å¸¸ç”¨æ–¹æ³•ï¼š</p><ul><li><code>public Exchanger()</code>ï¼šåˆ›å»ºä¸€ä¸ªæ–°çš„äº¤æ¢å™¨</li><li><code>public V exchange(V x)</code>ï¼šç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹åˆ°è¾¾æ­¤äº¤æ¢ç‚¹</li><li><code>public V exchange(V x, long timeout, TimeUnit unit)</code>ï¼šç­‰å¾…ä¸€å®šçš„æ—¶é—´</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExchangerDemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// åˆ›å»ºäº¤æ¢å¯¹è±¡ï¼ˆä¿¡ä½¿ï¼‰</span></span><br><span class="line">        Exchanger&lt;String&gt; exchanger = <span class="keyword">new</span> <span class="title class_">Exchanger</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ThreadA</span>(exchanger).start();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ThreadB</span>(exchanger).start();</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ThreadA</span> <span class="keyword">extends</span> <span class="title class_">Thread</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Exchanger&lt;String&gt; <span class="title function_">exchanger</span><span class="params">()</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ThreadA</span><span class="params">(Exchanger&lt;String&gt; exchanger)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.exchanger = exchanger;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            sout(<span class="string">&quot;çº¿ç¨‹Aï¼Œåšå¥½äº†ç¤¼ç‰©Aï¼Œç­‰å¾…çº¿ç¨‹Bé€æ¥çš„ç¤¼ç‰©B&quot;</span>);</span><br><span class="line">            <span class="comment">//å¦‚æœç­‰å¾…äº†5sè¿˜æ²¡æœ‰äº¤æ¢å°±æ­»äº¡ï¼ˆæŠ›å‡ºå¼‚å¸¸ï¼‰ï¼</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> exchanger.exchange(<span class="string">&quot;ç¤¼ç‰©A&quot;</span>,<span class="number">5</span>,TimeUnit.SECONDS);</span><br><span class="line">            sout(<span class="string">&quot;çº¿ç¨‹Aæ”¶åˆ°çº¿ç¨‹Bçš„ç¤¼ç‰©ï¼š&quot;</span> + s);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;çº¿ç¨‹Aç­‰å¾…äº†5sï¼Œæ²¡æœ‰æ”¶åˆ°ç¤¼ç‰©,æœ€ç»ˆå°±æ‰§è¡Œç»“æŸäº†!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ThreadB</span> <span class="keyword">extends</span> <span class="title class_">Thread</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Exchanger&lt;String&gt; exchanger;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ThreadB</span><span class="params">(Exchanger&lt;String&gt; exchanger)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.exchanger = exchanger;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            sout(<span class="string">&quot;çº¿ç¨‹B,åšå¥½äº†ç¤¼ç‰©B,ç­‰å¾…çº¿ç¨‹Aé€æ¥çš„ç¤¼ç‰©A.....&quot;</span>);</span><br><span class="line">            <span class="comment">// å¼€å§‹äº¤æ¢ç¤¼ç‰©ã€‚å‚æ•°æ˜¯é€ç»™å…¶ä»–çº¿ç¨‹çš„ç¤¼ç‰©!</span></span><br><span class="line">            sout(<span class="string">&quot;çº¿ç¨‹Bæ”¶åˆ°çº¿ç¨‹Açš„ç¤¼ç‰©ï¼š&quot;</span> + exchanger.exchange(<span class="string">&quot;ç¤¼ç‰©B&quot;</span>));</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h2 id="å¹¶å‘åŒ…"><a href="#å¹¶å‘åŒ…" class="headerlink" title="å¹¶å‘åŒ…"></a>å¹¶å‘åŒ…</h2><h3 id="ConHashMap"><a href="#ConHashMap" class="headerlink" title="ConHashMap"></a>ConHashMap</h3><h4 id="å¹¶å‘é›†åˆ"><a href="#å¹¶å‘é›†åˆ" class="headerlink" title="å¹¶å‘é›†åˆ"></a>å¹¶å‘é›†åˆ</h4><h5 id="é›†åˆå¯¹æ¯”"><a href="#é›†åˆå¯¹æ¯”" class="headerlink" title="é›†åˆå¯¹æ¯”"></a>é›†åˆå¯¹æ¯”</h5><p>ä¸‰ç§é›†åˆï¼š</p><ul><li>HashMap æ˜¯çº¿ç¨‹ä¸å®‰å…¨çš„ï¼Œæ€§èƒ½å¥½</li><li>Hashtable çº¿ç¨‹å®‰å…¨åŸºäº synchronizedï¼Œç»¼åˆæ€§èƒ½å·®ï¼Œå·²ç»è¢«æ·˜æ±°</li><li>ConcurrentHashMap ä¿è¯äº†çº¿ç¨‹å®‰å…¨ï¼Œç»¼åˆæ€§èƒ½è¾ƒå¥½ï¼Œä¸æ­¢çº¿ç¨‹å®‰å…¨ï¼Œè€Œä¸”æ•ˆç‡é«˜ï¼Œæ€§èƒ½å¥½</li></ul><p>é›†åˆå¯¹æ¯”ï¼š</p><ol><li>Hashtable ç»§æ‰¿ Dictionary ç±»ï¼ŒHashMapã€ConcurrentHashMap ç»§æ‰¿ AbstractMapï¼Œå‡å®ç° Map æ¥å£</li><li>Hashtable åº•å±‚æ˜¯æ•°ç»„ + é“¾è¡¨ï¼ŒJDK8 ä»¥å HashMap å’Œ ConcurrentHashMap åº•å±‚æ˜¯æ•°ç»„ + é“¾è¡¨ + çº¢é»‘æ ‘</li><li>HashMap çº¿ç¨‹éå®‰å…¨ï¼ŒHashtable çº¿ç¨‹å®‰å…¨ï¼ŒHashtable çš„æ–¹æ³•éƒ½åŠ äº† synchronized å…³æ¥ç¡®ä¿çº¿ç¨‹åŒæ­¥</li><li>ConcurrentHashMapã€Hashtable <strong>ä¸å…è®¸ null å€¼</strong>ï¼ŒHashMap å…è®¸ null å€¼</li><li>ConcurrentHashMapã€HashMap çš„åˆå§‹å®¹é‡ä¸º 16ï¼ŒHashtable åˆå§‹å®¹é‡ä¸º11ï¼Œå¡«å……å› å­é»˜è®¤éƒ½æ˜¯ 0.75ï¼Œä¸¤ç§ Map æ‰©å®¹æ˜¯å½“å‰å®¹é‡ç¿»å€ï¼šcapacity * 2ï¼ŒHashtable æ‰©å®¹æ—¶æ˜¯å®¹é‡ç¿»å€ + 1ï¼šcapacity*2 + 1</li></ol><p><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/ConcurrentHashMap%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84.png" alt="ConcurrentHashMapæ•°æ®ç»“æ„"></p><p>å·¥ä½œæ­¥éª¤ï¼š</p><ol><li><p>åˆå§‹åŒ–ï¼Œä½¿ç”¨ cas æ¥ä¿è¯å¹¶å‘å®‰å…¨ï¼Œæ‡’æƒ°åˆå§‹åŒ– table</p></li><li><p>æ ‘åŒ–ï¼Œå½“ table.length &lt; 64 æ—¶ï¼Œå…ˆå°è¯•æ‰©å®¹ï¼Œè¶…è¿‡ 64 æ—¶ï¼Œå¹¶ä¸” bin.length &gt; 8 æ—¶ï¼Œä¼šå°†<strong>é“¾è¡¨æ ‘åŒ–</strong>ï¼Œæ ‘åŒ–è¿‡ç¨‹ä¼šç”¨ synchronized é”ä½é“¾è¡¨å¤´</p><p>è¯´æ˜ï¼šé”ä½æŸä¸ªæ§½ä½çš„å¯¹è±¡å¤´ï¼Œæ˜¯ä¸€ç§å¾ˆå¥½çš„<strong>ç»†ç²’åº¦çš„åŠ é”</strong>æ–¹å¼ï¼Œç±»ä¼¼ MySQL ä¸­çš„è¡Œé”</p></li><li><p>putï¼Œå¦‚æœè¯¥ bin å°šæœªåˆ›å»ºï¼Œåªéœ€è¦ä½¿ç”¨ cas åˆ›å»º binï¼›å¦‚æœå·²ç»æœ‰äº†ï¼Œé”ä½é“¾è¡¨å¤´è¿›è¡Œåç»­ put æ“ä½œï¼Œå…ƒç´ æ·»åŠ è‡³ bin çš„å°¾éƒ¨</p></li><li><p>getï¼Œæ— é”æ“ä½œä»…éœ€è¦ä¿è¯å¯è§æ€§ï¼Œæ‰©å®¹è¿‡ç¨‹ä¸­ get æ“ä½œæ‹¿åˆ°çš„æ˜¯ ForwardingNode ä¼šè®© get æ“ä½œåœ¨æ–° table è¿›è¡Œæœç´¢</p></li><li><p>æ‰©å®¹ï¼Œæ‰©å®¹æ—¶ä»¥ bin ä¸ºå•ä½è¿›è¡Œï¼Œéœ€è¦å¯¹ bin è¿›è¡Œ synchronizedï¼Œä½†è¿™æ—¶å…¶å®ƒç«äº‰çº¿ç¨‹ä¹Ÿä¸æ˜¯æ— äº‹å¯åšï¼Œå®ƒä»¬ä¼šå¸®åŠ©æŠŠå…¶å®ƒ bin è¿›è¡Œæ‰©å®¹</p></li><li><p>sizeï¼Œå…ƒç´ ä¸ªæ•°ä¿å­˜åœ¨ baseCount ä¸­ï¼Œå¹¶å‘æ—¶çš„ä¸ªæ•°å˜åŠ¨ä¿å­˜åœ¨ CounterCell[] å½“ä¸­ï¼Œæœ€åç»Ÿè®¡æ•°é‡æ—¶ç´¯åŠ </p></li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//éœ€æ±‚ï¼šå¤šä¸ªçº¿ç¨‹åŒæ—¶å¾€HashMapå®¹å™¨ä¸­å­˜å…¥æ•°æ®ä¼šå‡ºç°å®‰å…¨é—®é¢˜</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConcurrentHashMapDemo</span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Map&lt;String,String&gt; map = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>();</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>&#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">AddMapDataThread</span>().start();</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">AddMapDataThread</span>().start();</span><br><span class="line">        </span><br><span class="line">        Thread.sleep(<span class="number">1000</span> * <span class="number">5</span>);<span class="comment">//ä¼‘æ¯5ç§’ï¼Œç¡®ä¿ä¸¤ä¸ªçº¿ç¨‹æ‰§è¡Œå®Œæ¯•</span></span><br><span class="line">        System.out.println(<span class="string">&quot;Mapå¤§å°ï¼š&quot;</span> + map.size());<span class="comment">//20ä¸‡</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AddMapDataThread</span> <span class="keyword">extends</span> <span class="title class_">Thread</span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span> ; i &lt; <span class="number">1000000</span> ; i++ )&#123;</span><br><span class="line">            ConcurrentHashMapDemo.map.put(<span class="string">&quot;é”®ï¼š&quot;</span>+i , <span class="string">&quot;å€¼&quot;</span>+i);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h5 id="å¹¶å‘æ­»é“¾"><a href="#å¹¶å‘æ­»é“¾" class="headerlink" title="å¹¶å‘æ­»é“¾"></a>å¹¶å‘æ­»é“¾</h5><p>JDK1.7 çš„ HashMap é‡‡ç”¨çš„å¤´æ’æ³•ï¼ˆæ‹‰é“¾æ³•ï¼‰è¿›è¡ŒèŠ‚ç‚¹çš„æ·»åŠ ï¼ŒHashMap çš„æ‰©å®¹é•¿åº¦ä¸ºåŸæ¥çš„ 2 å€</p><p>resize() ä¸­èŠ‚ç‚¹ï¼ˆEntryï¼‰è½¬ç§»çš„æºä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">transfer</span><span class="params">(Entry[] newTable, <span class="type">boolean</span> rehash)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">newCapacity</span> <span class="operator">=</span> newTable.length;<span class="comment">//å¾—åˆ°æ–°æ•°ç»„çš„é•¿åº¦   </span></span><br><span class="line">    <span class="comment">// éå†æ•´ä¸ªæ•°ç»„å¯¹åº”ä¸‹æ ‡ä¸‹çš„é“¾è¡¨ï¼Œeä»£è¡¨ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">for</span> (Entry&lt;K,V&gt; e : table) &#123;   </span><br><span class="line">        <span class="comment">// å½“e == nullæ—¶ï¼Œåˆ™è¯¥é“¾è¡¨éå†å®Œäº†ï¼Œç»§ç»­éå†ä¸‹ä¸€æ•°ç»„ä¸‹æ ‡çš„é“¾è¡¨ </span></span><br><span class="line">        <span class="keyword">while</span>(<span class="literal">null</span> != e) &#123; </span><br><span class="line">            <span class="comment">// å…ˆæŠŠeèŠ‚ç‚¹çš„ä¸‹ä¸€èŠ‚ç‚¹å­˜èµ·æ¥</span></span><br><span class="line">            Entry&lt;K,V&gt; next = e.next; </span><br><span class="line">            <span class="keyword">if</span> (rehash) &#123;              <span class="comment">//å¾—åˆ°æ–°çš„hashå€¼</span></span><br><span class="line">                e.hash = <span class="literal">null</span> == e.key ? <span class="number">0</span> : hash(e.key);  </span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// åœ¨æ–°æ•°ç»„ä¸‹å¾—åˆ°æ–°çš„æ•°ç»„ä¸‹æ ‡</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> indexFor(e.hash, newCapacity);  </span><br><span class="line">             <span class="comment">// å°†eçš„nextæŒ‡é’ˆæŒ‡å‘æ–°æ•°ç»„ä¸‹æ ‡çš„ä½ç½®</span></span><br><span class="line">            e.next = newTable[i];   </span><br><span class="line">            <span class="comment">// å°†è¯¥æ•°ç»„ä¸‹æ ‡çš„èŠ‚ç‚¹å˜ä¸ºeèŠ‚ç‚¹</span></span><br><span class="line">            newTable[i] = e; </span><br><span class="line">            <span class="comment">// éå†é“¾è¡¨çš„ä¸‹ä¸€èŠ‚ç‚¹</span></span><br><span class="line">            e = next;                                   </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>JDK 8 è™½ç„¶å°†æ‰©å®¹ç®—æ³•åšäº†è°ƒæ•´ï¼Œæ”¹ç”¨äº†å°¾æ’æ³•ï¼Œä½†ä»ä¸æ„å‘³ç€èƒ½å¤Ÿåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹èƒ½å¤Ÿå®‰å…¨æ‰©å®¹ï¼Œè¿˜ä¼šå‡ºç°å…¶å®ƒé—®é¢˜ï¼ˆå¦‚æ‰©å®¹ä¸¢æ•°æ®ï¼‰</p><p>Bç«™è§†é¢‘è§£æï¼š<a href="https://www.bilibili.com/video/BV1n541177Ea">https://www.bilibili.com/video/BV1n541177Ea</a></p><hr><h4 id="æˆå‘˜å±æ€§-7"><a href="#æˆå‘˜å±æ€§-7" class="headerlink" title="æˆå‘˜å±æ€§"></a>æˆå‘˜å±æ€§</h4><h5 id="å˜é‡"><a href="#å˜é‡" class="headerlink" title="å˜é‡"></a>å˜é‡</h5><ul><li><p>å­˜å‚¨æ•°ç»„ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">transient</span> <span class="keyword">volatile</span> Node&lt;K,V&gt;[] table;</span><br></pre></td></tr></table></figure></li><li><p>æ•£åˆ—è¡¨çš„é•¿åº¦ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">MAXIMUM_CAPACITY</span> <span class="operator">=</span> <span class="number">1</span> &lt;&lt; <span class="number">30</span>;<span class="comment">// æœ€å¤§é•¿åº¦</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">DEFAULT_CAPACITY</span> <span class="operator">=</span> <span class="number">16</span>;<span class="comment">// é»˜è®¤é•¿åº¦</span></span><br></pre></td></tr></table></figure></li><li><p>å¹¶å‘çº§åˆ«ï¼ŒJDK7 é—ç•™ä¸‹æ¥ï¼Œ1.8 ä¸­ä¸ä»£è¡¨å¹¶å‘çº§åˆ«ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">DEFAULT_CONCURRENCY_LEVEL</span> <span class="operator">=</span> <span class="number">16</span>;</span><br></pre></td></tr></table></figure></li><li><p>è´Ÿè½½å› å­ï¼ŒJDK1.8 çš„ ConcurrentHashMap ä¸­æ˜¯å›ºå®šå€¼ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">float</span> <span class="variable">LOAD_FACTOR</span> <span class="operator">=</span> <span class="number">0.75f</span>;</span><br></pre></td></tr></table></figure></li><li><p>é˜ˆå€¼ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">TREEIFY_THRESHOLD</span> <span class="operator">=</span> <span class="number">8</span>;<span class="comment">// é“¾è¡¨æ ‘åŒ–çš„é˜ˆå€¼</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">UNTREEIFY_THRESHOLD</span> <span class="operator">=</span> <span class="number">6</span>;<span class="comment">// çº¢é»‘æ ‘è½¬åŒ–ä¸ºé“¾è¡¨çš„é˜ˆå€¼</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">MIN_TREEIFY_CAPACITY</span> <span class="operator">=</span> <span class="number">64</span>;<span class="comment">// å½“æ•°ç»„é•¿åº¦è¾¾åˆ°64ä¸”æŸä¸ªæ¡¶ä½ä¸­çš„é“¾è¡¨é•¿åº¦è¶…è¿‡8ï¼Œæ‰ä¼šçœŸæ­£æ ‘åŒ–</span></span><br></pre></td></tr></table></figure></li><li><p>æ‰©å®¹ç›¸å…³ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">MIN_TRANSFER_STRIDE</span> <span class="operator">=</span> <span class="number">16</span>;<span class="comment">// çº¿ç¨‹è¿ç§»æ•°æ®ã€æœ€å°æ­¥é•¿ã€‘ï¼Œæ§åˆ¶çº¿ç¨‹è¿ç§»ä»»åŠ¡çš„æœ€å°åŒºé—´</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">RESIZE_STAMP_BITS</span> <span class="operator">=</span> <span class="number">16</span>;<span class="comment">// ç”¨æ¥è®¡ç®—æ‰©å®¹æ—¶ç”Ÿæˆçš„ã€æ ‡è¯†æˆ³ã€‘</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">MAX_RESIZERS</span> <span class="operator">=</span> (<span class="number">1</span> &lt;&lt; (<span class="number">32</span> - RESIZE_STAMP_BITS)) - <span class="number">1</span>;<span class="comment">// 65535-1å¹¶å‘æ‰©å®¹æœ€å¤šçº¿ç¨‹æ•°</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">RESIZE_STAMP_SHIFT</span> <span class="operator">=</span> <span class="number">32</span> - RESIZE_STAMP_BITS;<span class="comment">// æ‰©å®¹æ—¶ä½¿ç”¨</span></span><br></pre></td></tr></table></figure></li><li><p>èŠ‚ç‚¹å“ˆå¸Œå€¼ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">MOVED</span>     <span class="operator">=</span> -<span class="number">1</span>; <span class="comment">// è¡¨ç¤ºå½“å‰èŠ‚ç‚¹æ˜¯ FWD èŠ‚ç‚¹</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">TREEBIN</span>   <span class="operator">=</span> -<span class="number">2</span>; <span class="comment">// è¡¨ç¤ºå½“å‰èŠ‚ç‚¹å·²ç»æ ‘åŒ–ï¼Œä¸”å½“å‰èŠ‚ç‚¹ä¸º TreeBin å¯¹è±¡</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">RESERVED</span>  <span class="operator">=</span> -<span class="number">3</span>; <span class="comment">// è¡¨ç¤ºèŠ‚ç‚¹æ—¶ä¸´æ—¶èŠ‚ç‚¹</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">HASH_BITS</span> <span class="operator">=</span> <span class="number">0x7fffffff</span>; <span class="comment">// æ­£å¸¸èŠ‚ç‚¹çš„å“ˆå¸Œå€¼çš„å¯ç”¨çš„ä½æ•°</span></span><br></pre></td></tr></table></figure></li><li><p>æ‰©å®¹è¿‡ç¨‹ï¼švolatile ä¿®é¥°ä¿è¯å¤šçº¿ç¨‹çš„å¯è§æ€§</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ‰©å®¹è¿‡ç¨‹ä¸­ï¼Œä¼šå°†æ‰©å®¹ä¸­çš„æ–° table èµ‹å€¼ç»™ nextTable ä¿æŒå¼•ç”¨ï¼Œæ‰©å®¹ç»“æŸä¹‹åï¼Œè¿™é‡Œä¼šè¢«è®¾ç½®ä¸º null</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> Node&lt;K,V&gt;[] nextTable;</span><br><span class="line"><span class="comment">// è®°å½•æ‰©å®¹è¿›åº¦ï¼Œæ‰€æœ‰çº¿ç¨‹éƒ½è¦ä» 0 - transferIndex ä¸­åˆ†é…åŒºé—´ä»»åŠ¡ï¼Œç®€å•è¯´å°±æ˜¯è€è¡¨è½¬ç§»åˆ°å“ªäº†ï¼Œç´¢å¼•ä»é«˜åˆ°ä½è½¬ç§»</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> <span class="type">int</span> transferIndex;</span><br></pre></td></tr></table></figure></li><li><p>ç´¯åŠ ç»Ÿè®¡ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// LongAdder ä¸­çš„ baseCount æœªå‘ç”Ÿç«äº‰æ—¶æˆ–è€…å½“å‰LongAdderå¤„äºåŠ é”çŠ¶æ€æ—¶ï¼Œå¢é‡ç´¯åˆ°åˆ° baseCount ä¸­</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> <span class="type">long</span> baseCount;</span><br><span class="line"><span class="comment">// LongAdder ä¸­çš„ cellsBuzyï¼Œ0 è¡¨ç¤ºå½“å‰ LongAdder å¯¹è±¡æ— é”çŠ¶æ€ï¼Œ1 è¡¨ç¤ºå½“å‰ LongAdder å¯¹è±¡åŠ é”çŠ¶æ€</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> <span class="type">int</span> cellsBusy;</span><br><span class="line"><span class="comment">// LongAdder ä¸­çš„ cells æ•°ç»„ï¼Œ</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> CounterCell[] counterCells;</span><br></pre></td></tr></table></figure></li><li><p>æ§åˆ¶å˜é‡ï¼š</p><p><strong>sizeCtl</strong> &lt; 0ï¼š</p><ul><li><p>-1 è¡¨ç¤ºå½“å‰ table æ­£åœ¨åˆå§‹åŒ–ï¼ˆæœ‰çº¿ç¨‹åœ¨åˆ›å»º table æ•°ç»„ï¼‰ï¼Œå½“å‰çº¿ç¨‹éœ€è¦è‡ªæ—‹ç­‰å¾…</p></li><li><p>å…¶ä»–è´Ÿæ•°è¡¨ç¤ºå½“å‰ map çš„ table æ•°ç»„æ­£åœ¨è¿›è¡Œæ‰©å®¹ï¼Œé«˜ 16 ä½è¡¨ç¤ºæ‰©å®¹çš„æ ‡è¯†æˆ³ï¼›ä½ 16 ä½è¡¨ç¤º (1 + nThread) å½“å‰å‚ä¸å¹¶å‘æ‰©å®¹çš„çº¿ç¨‹æ•°é‡ + 1</p></li></ul><p>sizeCtl &#x3D; 0ï¼Œè¡¨ç¤ºåˆ›å»º table æ•°ç»„æ—¶ä½¿ç”¨ DEFAULT_CAPACITY ä¸ºæ•°ç»„å¤§å°</p><p>sizeCtl &gt; 0ï¼š</p><ul><li>å¦‚æœ table æœªåˆå§‹åŒ–ï¼Œè¡¨ç¤ºåˆå§‹åŒ–å¤§å°</li><li>å¦‚æœ table å·²ç»åˆå§‹åŒ–ï¼Œè¡¨ç¤ºä¸‹æ¬¡æ‰©å®¹æ—¶çš„è§¦å‘æ¡ä»¶ï¼ˆé˜ˆå€¼ï¼Œå…ƒç´ ä¸ªæ•°ï¼Œä¸æ˜¯æ•°ç»„çš„é•¿åº¦ï¼‰</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> <span class="type">int</span> sizeCtl;<span class="comment">// volatile ä¿æŒå¯è§æ€§</span></span><br></pre></td></tr></table></figure></li></ul><hr><h5 id="å†…éƒ¨ç±»"><a href="#å†…éƒ¨ç±»" class="headerlink" title="å†…éƒ¨ç±»"></a>å†…éƒ¨ç±»</h5><ul><li><p>Node èŠ‚ç‚¹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Node</span>&lt;K,V&gt; <span class="keyword">implements</span> <span class="title class_">Entry</span>&lt;K,V&gt; &#123;</span><br><span class="line">    <span class="comment">// èŠ‚ç‚¹å“ˆå¸Œå€¼</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> hash;</span><br><span class="line">    <span class="keyword">final</span> K key;</span><br><span class="line">    <span class="keyword">volatile</span> V val;</span><br><span class="line">    <span class="comment">// å•å‘é“¾è¡¨</span></span><br><span class="line">    <span class="keyword">volatile</span> Node&lt;K,V&gt; next;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>TreeBin èŠ‚ç‚¹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">TreeBin</span>&lt;K,V&gt; <span class="keyword">extends</span> <span class="title class_">Node</span>&lt;K,V&gt; &#123;</span><br><span class="line">    <span class="comment">// çº¢é»‘æ ‘æ ¹èŠ‚ç‚¹</span></span><br><span class="line">    TreeNode&lt;K,V&gt; root;</span><br><span class="line">    <span class="comment">// é“¾è¡¨çš„å¤´èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">volatile</span> TreeNode&lt;K,V&gt; first;</span><br><span class="line">    <span class="comment">// ç­‰å¾…è€…çº¿ç¨‹</span></span><br><span class="line">    <span class="keyword">volatile</span> Thread waiter;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">int</span> lockState;</span><br><span class="line">    <span class="comment">// å†™é”çŠ¶æ€ å†™é”æ˜¯ç‹¬å çŠ¶æ€ï¼Œä»¥æ•£åˆ—è¡¨æ¥çœ‹ï¼ŒçœŸæ­£è¿›å…¥åˆ° TreeBin ä¸­çš„å†™çº¿ç¨‹åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªçº¿ç¨‹</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">WRITER</span> <span class="operator">=</span> <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// ç­‰å¾…è€…çŠ¶æ€ï¼ˆå†™çº¿ç¨‹åœ¨ç­‰å¾…ï¼‰ï¼Œå½“ TreeBin ä¸­æœ‰è¯»çº¿ç¨‹ç›®å‰æ­£åœ¨è¯»å–æ•°æ®æ—¶ï¼Œå†™çº¿ç¨‹æ— æ³•ä¿®æ”¹æ•°æ®</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">WAITER</span> <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line">    <span class="comment">// è¯»é”çŠ¶æ€æ˜¯å…±äº«ï¼ŒåŒä¸€æ—¶åˆ»å¯ä»¥æœ‰å¤šä¸ªçº¿ç¨‹ åŒæ—¶è¿›å…¥åˆ° TreeBi å¯¹è±¡ä¸­è·å–æ•°æ®ï¼Œæ¯ä¸€ä¸ªçº¿ç¨‹éƒ½ç»™ lockState + 4</span></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">READER</span> <span class="operator">=</span> <span class="number">4</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>TreeNode èŠ‚ç‚¹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">TreeNode</span>&lt;K,V&gt; <span class="keyword">extends</span> <span class="title class_">Node</span>&lt;K,V&gt; &#123;</span><br><span class="line">    TreeNode&lt;K,V&gt; parent;  <span class="comment">// red-black tree links</span></span><br><span class="line">    TreeNode&lt;K,V&gt; left;</span><br><span class="line">    TreeNode&lt;K,V&gt; right;</span><br><span class="line">    TreeNode&lt;K,V&gt; prev;   <span class="comment">//åŒå‘é“¾è¡¨</span></span><br><span class="line">    <span class="type">boolean</span> red;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>ForwardingNode èŠ‚ç‚¹ï¼šè½¬ç§»èŠ‚ç‚¹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">ForwardingNode</span>&lt;K,V&gt; <span class="keyword">extends</span> <span class="title class_">Node</span>&lt;K,V&gt; &#123;</span><br><span class="line">    <span class="comment">// æŒæœ‰æ‰©å®¹åæ–°çš„å“ˆå¸Œè¡¨çš„å¼•ç”¨</span></span><br><span class="line">    <span class="keyword">final</span> Node&lt;K,V&gt;[] nextTable;</span><br><span class="line">    ForwardingNode(Node&lt;K,V&gt;[] tab) &#123;</span><br><span class="line">        <span class="comment">// ForwardingNode èŠ‚ç‚¹çš„ hash å€¼è®¾ä¸º -1</span></span><br><span class="line">        <span class="built_in">super</span>(MOVED, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">        <span class="built_in">this</span>.nextTable = tab;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><hr><h5 id="ä»£ç å—"><a href="#ä»£ç å—" class="headerlink" title="ä»£ç å—"></a>ä»£ç å—</h5><ul><li><p>å˜é‡ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¡¨ç¤ºsizeCtlå±æ€§åœ¨ ConcurrentHashMap ä¸­å†…å­˜åç§»åœ°å€</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> SIZECTL;</span><br><span class="line"><span class="comment">// è¡¨ç¤ºtransferIndexå±æ€§åœ¨ ConcurrentHashMap ä¸­å†…å­˜åç§»åœ°å€</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> TRANSFERINDEX;</span><br><span class="line"><span class="comment">// è¡¨ç¤ºbaseCountå±æ€§åœ¨ ConcurrentHashMap ä¸­å†…å­˜åç§»åœ°å€</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> BASECOUNT;</span><br><span class="line"><span class="comment">// è¡¨ç¤ºcellsBusyå±æ€§åœ¨ ConcurrentHashMap ä¸­å†…å­˜åç§»åœ°å€</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> CELLSBUSY;</span><br><span class="line"><span class="comment">// è¡¨ç¤ºcellValueå±æ€§åœ¨ CounterCell ä¸­å†…å­˜åç§»åœ°å€</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> CELLVALUE;</span><br><span class="line"><span class="comment">// è¡¨ç¤ºæ•°ç»„ç¬¬ä¸€ä¸ªå…ƒç´ çš„åç§»åœ°å€</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> ABASE;</span><br><span class="line"><span class="comment">// ç”¨ä½ç§»è¿ç®—æ›¿ä»£ä¹˜æ³•</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> ASHIFT;</span><br></pre></td></tr></table></figure></li><li><p>èµ‹å€¼æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¡¨ç¤ºæ•°ç»„å•å…ƒæ‰€å ç”¨ç©ºé—´å¤§å°ï¼Œscale è¡¨ç¤º Node[] æ•°ç»„ä¸­æ¯ä¸€ä¸ªå•å…ƒæ‰€å ç”¨ç©ºé—´å¤§å°ï¼Œint æ˜¯ 4 å­—èŠ‚</span></span><br><span class="line"><span class="type">int</span> <span class="variable">scale</span> <span class="operator">=</span> U.arrayIndexScale(ak);</span><br><span class="line"><span class="comment">// åˆ¤æ–­ä¸€ä¸ªæ•°æ˜¯ä¸æ˜¯ 2 çš„ n æ¬¡å¹‚ï¼Œæ¯”å¦‚ 8ï¼š1000 &amp; 0111 = 0000</span></span><br><span class="line"><span class="keyword">if</span> ((scale &amp; (scale - <span class="number">1</span>)) != <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">Error</span>(<span class="string">&quot;data type scale not a power of two&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// numberOfLeadingZeros(n)ï¼šè¿”å›å½“å‰æ•°å€¼è½¬æ¢ä¸ºäºŒè¿›åˆ¶åï¼Œä»é«˜ä½åˆ°ä½ä½å¼€å§‹ç»Ÿè®¡ï¼Œçœ‹æœ‰å¤šå°‘ä¸ª0è¿ç»­åœ¨ä¸€èµ·</span></span><br><span class="line"><span class="comment">// 8 â†’ 1000 numberOfLeadingZeros(8) = 28</span></span><br><span class="line"><span class="comment">// 4 â†’ 100 numberOfLeadingZeros(4) = 29   int å€¼å°±æ˜¯å 4ä¸ªå­—èŠ‚</span></span><br><span class="line">ASHIFT = <span class="number">31</span> - Integer.numberOfLeadingZeros(scale);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ASHIFT = 31 - 29 = 2 ï¼Œint çš„å¤§å°å°±æ˜¯ 2 çš„ 2 æ¬¡æ–¹ï¼Œè·å–æ¬¡æ–¹æ•°</span></span><br><span class="line"><span class="comment">// ABASE + ï¼ˆ5 &lt;&lt; ASHIFTï¼‰ ç”¨ä½ç§»è¿ç®—æ›¿ä»£äº†ä¹˜æ³•ï¼Œè·å– arr[5] çš„å€¼</span></span><br></pre></td></tr></table></figure></li></ul><hr><h4 id="æ„é€ æ–¹æ³•"><a href="#æ„é€ æ–¹æ³•" class="headerlink" title="æ„é€ æ–¹æ³•"></a>æ„é€ æ–¹æ³•</h4><ul><li><p>æ— å‚æ„é€ ï¼Œ æ•£åˆ—è¡¨ç»“æ„å»¶è¿Ÿåˆå§‹åŒ–ï¼Œé»˜è®¤çš„æ•°ç»„å¤§å°æ˜¯ 16ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ConcurrentHashMap</span><span class="params">()</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>æœ‰å‚æ„é€ ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ConcurrentHashMap</span><span class="params">(<span class="type">int</span> initialCapacity)</span> &#123;</span><br><span class="line">    <span class="comment">// æŒ‡å®šå®¹é‡åˆå§‹åŒ–</span></span><br><span class="line">    <span class="keyword">if</span> (initialCapacity &lt; <span class="number">0</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>();</span><br><span class="line">    <span class="type">int</span> <span class="variable">cap</span> <span class="operator">=</span> ((initialCapacity &gt;= (MAXIMUM_CAPACITY &gt;&gt;&gt; <span class="number">1</span>)) ?</span><br><span class="line">               MAXIMUM_CAPACITY :</span><br><span class="line">               <span class="comment">// å‡å¦‚ä¼ å…¥çš„å‚æ•°æ˜¯ 16ï¼Œ16 + 8 + 1 ï¼Œæœ€åå¾—åˆ° 32</span></span><br><span class="line">               <span class="comment">// ä¼ å…¥ 12ï¼Œ 12 + 6 + 1 = 19ï¼Œæœ€åå¾—åˆ° 32ï¼Œå°½å¯èƒ½çš„å¤§ï¼Œä¸ HashMapä¸ä¸€æ ·</span></span><br><span class="line">               tableSizeFor(initialCapacity + (initialCapacity &gt;&gt;&gt; <span class="number">1</span>) + <span class="number">1</span>));</span><br><span class="line">    <span class="comment">// sizeCtl &gt; 0ï¼Œå½“ç›®å‰ table æœªåˆå§‹åŒ–æ—¶ï¼ŒsizeCtl è¡¨ç¤ºåˆå§‹åŒ–å®¹é‡</span></span><br><span class="line">    <span class="built_in">this</span>.sizeCtl = cap;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">tableSizeFor</span><span class="params">(<span class="type">int</span> c)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> c - <span class="number">1</span>;</span><br><span class="line">    n |= n &gt;&gt;&gt; <span class="number">1</span>;</span><br><span class="line">    n |= n &gt;&gt;&gt; <span class="number">2</span>;</span><br><span class="line">    n |= n &gt;&gt;&gt; <span class="number">4</span>;</span><br><span class="line">    n |= n &gt;&gt;&gt; <span class="number">8</span>;</span><br><span class="line">    n |= n &gt;&gt;&gt; <span class="number">16</span>;</span><br><span class="line">    <span class="keyword">return</span> (n &lt; <span class="number">0</span>) ? <span class="number">1</span> : (n &gt;= MAXIMUM_CAPACITY) ? MAXIMUM_CAPACITY : n + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>HashMap éƒ¨åˆ†è¯¦è§£äº†è¯¥å‡½æ•°ï¼Œæ ¸å¿ƒæ€æƒ³å°±æ˜¯<strong>æŠŠæœ€é«˜ä½æ˜¯ 1 çš„ä½ä»¥åŠå³è¾¹çš„ä½å…¨éƒ¨ç½® 1</strong>ï¼Œç»“æœåŠ  1 åå°±æ˜¯ 2 çš„ n æ¬¡å¹‚</p></li><li><p>å¤šä¸ªå‚æ•°æ„é€ æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ConcurrentHashMap</span><span class="params">(<span class="type">int</span> initialCapacity, <span class="type">float</span> loadFactor, <span class="type">int</span> concurrencyLevel)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!(loadFactor &gt; <span class="number">0.0f</span>) || initialCapacity &lt; <span class="number">0</span> || concurrencyLevel &lt;= <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>();</span><br><span class="line">    <span class="comment">// åˆå§‹å®¹é‡å°äºå¹¶å‘çº§åˆ«</span></span><br><span class="line">    <span class="keyword">if</span> (initialCapacity &lt; concurrencyLevel)  </span><br><span class="line">        <span class="comment">// æŠŠå¹¶å‘çº§åˆ«èµ‹å€¼ç»™åˆå§‹å®¹é‡</span></span><br><span class="line">        initialCapacity = concurrencyLevel; </span><br><span class="line"><span class="comment">// loadFactor é»˜è®¤æ˜¯ 0.75</span></span><br><span class="line">    <span class="type">long</span> <span class="variable">size</span> <span class="operator">=</span> (<span class="type">long</span>)(<span class="number">1.0</span> + (<span class="type">long</span>)initialCapacity / loadFactor);</span><br><span class="line">    <span class="type">int</span> <span class="variable">cap</span> <span class="operator">=</span> (size &gt;= (<span class="type">long</span>)MAXIMUM_CAPACITY) ?</span><br><span class="line">        MAXIMUM_CAPACITY : tableSizeFor((<span class="type">int</span>)size);</span><br><span class="line">    <span class="comment">// sizeCtl &gt; 0ï¼Œå½“ç›®å‰ table æœªåˆå§‹åŒ–æ—¶ï¼ŒsizeCtl è¡¨ç¤ºåˆå§‹åŒ–å®¹é‡</span></span><br><span class="line">    <span class="built_in">this</span>.sizeCtl = cap;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>é›†åˆæ„é€ æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ConcurrentHashMap</span><span class="params">(Map&lt;? extends K, ? extends V&gt; m)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.sizeCtl = DEFAULT_CAPACITY;<span class="comment">// é»˜è®¤16</span></span><br><span class="line">    putAll(m);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">putAll</span><span class="params">(Map&lt;? extends K, ? extends V&gt; m)</span> &#123;</span><br><span class="line">    <span class="comment">// å°è¯•è§¦å‘æ‰©å®¹</span></span><br><span class="line">    tryPresize(m.size());</span><br><span class="line">    <span class="keyword">for</span> (Entry&lt;? <span class="keyword">extends</span> <span class="title class_">K</span>, ? <span class="keyword">extends</span> <span class="title class_">V</span>&gt; e : m.entrySet())</span><br><span class="line">        putVal(e.getKey(), e.getValue(), <span class="literal">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">tryPresize</span><span class="params">(<span class="type">int</span> size)</span> &#123;</span><br><span class="line">    <span class="comment">// æ‰©å®¹ä¸ºå¤§äº 2 å€çš„æœ€å°çš„ 2 çš„ n æ¬¡å¹‚</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> (size &gt;= (MAXIMUM_CAPACITY &gt;&gt;&gt; <span class="number">1</span>)) ? MAXIMUM_CAPACITY :</span><br><span class="line">    tableSizeFor(size + (size &gt;&gt;&gt; <span class="number">1</span>) + <span class="number">1</span>);</span><br><span class="line">    <span class="type">int</span> sc;</span><br><span class="line">    <span class="keyword">while</span> ((sc = sizeCtl) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        Node&lt;K,V&gt;[] tab = table; <span class="type">int</span> n;</span><br><span class="line">        <span class="comment">// æ•°ç»„è¿˜æœªåˆå§‹åŒ–ï¼Œã€ä¸€èˆ¬æ˜¯è°ƒç”¨é›†åˆæ„é€ æ–¹æ³•æ‰ä¼šæˆç«‹ï¼Œput åè°ƒç”¨è¯¥æ–¹æ³•éƒ½æ˜¯ä¸æˆç«‹çš„ã€‘</span></span><br><span class="line">        <span class="keyword">if</span> (tab == <span class="literal">null</span> || (n = tab.length) == <span class="number">0</span>) &#123;</span><br><span class="line">            n = (sc &gt; c) ? sc : c;</span><br><span class="line">            <span class="keyword">if</span> (U.compareAndSwapInt(<span class="built_in">this</span>, SIZECTL, sc, -<span class="number">1</span>)) &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (table == tab) &#123;</span><br><span class="line">                        Node&lt;K,V&gt;[] nt = (Node&lt;K,V&gt;[])<span class="keyword">new</span> <span class="title class_">Node</span>&lt;?,?&gt;[n];</span><br><span class="line">                        table = nt;</span><br><span class="line">                        sc = n - (n &gt;&gt;&gt; <span class="number">2</span>);<span class="comment">// æ‰©å®¹é˜ˆå€¼ï¼šn - 1/4 n</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    sizeCtl = sc;<span class="comment">// æ‰©å®¹é˜ˆå€¼èµ‹å€¼ç»™sizeCtl</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æœªè¾¾åˆ°æ‰©å®¹é˜ˆå€¼æˆ–è€…æ•°ç»„é•¿åº¦å·²ç»å¤§äºæœ€å¤§é•¿åº¦</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (c &lt;= sc || n &gt;= MAXIMUM_CAPACITY)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">// ä¸ addCount é€»è¾‘ç›¸åŒ</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (tab == table) &#123;</span><br><span class="line">           </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><hr><h4 id="æˆå‘˜æ–¹æ³•-6"><a href="#æˆå‘˜æ–¹æ³•-6" class="headerlink" title="æˆå‘˜æ–¹æ³•"></a>æˆå‘˜æ–¹æ³•</h4><h5 id="æ•°æ®è®¿å­˜"><a href="#æ•°æ®è®¿å­˜" class="headerlink" title="æ•°æ®è®¿å­˜"></a>æ•°æ®è®¿å­˜</h5><ul><li><p>tabAt()ï¼šè·å–æ•°ç»„æŸä¸ªæ§½ä½çš„<strong>å¤´èŠ‚ç‚¹</strong>ï¼Œç±»ä¼¼äºæ•°ç»„ä¸­çš„ç›´æ¥å¯»å€ arr[i]</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// i æ˜¯æ•°ç»„ç´¢å¼•</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> &lt;K,V&gt; Node&lt;K,V&gt; <span class="title function_">tabAt</span><span class="params">(Node&lt;K,V&gt;[] tab, <span class="type">int</span> i)</span> &#123;</span><br><span class="line">    <span class="comment">// (i &lt;&lt; ASHIFT) + ABASE == ABASE + i * 4 ï¼ˆä¸€ä¸ª int å  4 ä¸ªå­—èŠ‚ï¼‰ï¼Œè¿™å°±ç›¸å½“äºå¯»å€ï¼Œæ›¿ä»£äº†ä¹˜æ³•</span></span><br><span class="line">    <span class="keyword">return</span> (Node&lt;K,V&gt;)U.getObjectVolatile(tab, ((<span class="type">long</span>)i &lt;&lt; ASHIFT) + ABASE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>casTabAt()ï¼šæŒ‡å®šæ•°ç»„ç´¢å¼•ä½ç½®ä¿®æ”¹åŸå€¼ä¸ºæŒ‡å®šçš„å€¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> &lt;K,V&gt; <span class="type">boolean</span> <span class="title function_">casTabAt</span><span class="params">(Node&lt;K,V&gt;[] tab, <span class="type">int</span> i, Node&lt;K,V&gt; c, Node&lt;K,V&gt; v)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> U.compareAndSwapObject(tab, ((<span class="type">long</span>)i &lt;&lt; ASHIFT) + ABASE, c, v);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>setTabAt()ï¼šæŒ‡å®šæ•°ç»„ç´¢å¼•ä½ç½®è®¾ç½®å€¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> &lt;K,V&gt; <span class="keyword">void</span> <span class="title function_">setTabAt</span><span class="params">(Node&lt;K,V&gt;[] tab, <span class="type">int</span> i, Node&lt;K,V&gt; v)</span> &#123;</span><br><span class="line">    U.putObjectVolatile(tab, ((<span class="type">long</span>)i &lt;&lt; ASHIFT) + ABASE, v);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><hr><h5 id="æ·»åŠ æ–¹æ³•"><a href="#æ·»åŠ æ–¹æ³•" class="headerlink" title="æ·»åŠ æ–¹æ³•"></a>æ·»åŠ æ–¹æ³•</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> V <span class="title function_">put</span><span class="params">(K key, V value)</span> &#123;</span><br><span class="line">    <span class="comment">// ç¬¬ä¸‰ä¸ªå‚æ•° onlyIfAbsent ä¸º false è¡¨ç¤ºå“ˆå¸Œè¡¨ä¸­å­˜åœ¨ç›¸åŒçš„ key æ—¶ã€ç”¨å½“å‰æ•°æ®è¦†ç›–æ—§æ•°æ®ã€‘</span></span><br><span class="line">    <span class="keyword">return</span> putVal(key, value, <span class="literal">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>putVal()</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> V <span class="title function_">putVal</span><span class="params">(K key, V value, <span class="type">boolean</span> onlyIfAbsent)</span> &#123;</span><br><span class="line">    <span class="comment">// ã€ConcurrentHashMap ä¸èƒ½å­˜æ”¾ null å€¼ã€‘</span></span><br><span class="line">    <span class="keyword">if</span> (key == <span class="literal">null</span> || value == <span class="literal">null</span>) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">    <span class="comment">// æ‰°åŠ¨è¿ç®—ï¼Œé«˜ä½ä½éƒ½å‚ä¸å¯»å€è¿ç®—</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">hash</span> <span class="operator">=</span> spread(key.hashCode());</span><br><span class="line">    <span class="comment">// è¡¨ç¤ºå½“å‰ k-v å°è£…æˆ node åæ’å…¥åˆ°æŒ‡å®šæ¡¶ä½åï¼Œåœ¨æ¡¶ä½ä¸­çš„æ‰€å±é“¾è¡¨çš„ä¸‹æ ‡ä½ç½®</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">binCount</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// tab å¼•ç”¨å½“å‰ map çš„æ•°ç»„ tableï¼Œå¼€å§‹è‡ªæ—‹</span></span><br><span class="line">    <span class="keyword">for</span> (Node&lt;K,V&gt;[] tab = table;;) &#123;</span><br><span class="line">        <span class="comment">// f è¡¨ç¤ºæ¡¶ä½çš„å¤´èŠ‚ç‚¹ï¼Œn è¡¨ç¤ºå“ˆå¸Œè¡¨æ•°ç»„çš„é•¿åº¦</span></span><br><span class="line">        <span class="comment">// i è¡¨ç¤º key é€šè¿‡å¯»å€è®¡ç®—åå¾—åˆ°çš„æ¡¶ä½ä¸‹æ ‡ï¼Œfh è¡¨ç¤ºæ¡¶ä½å¤´ç»“ç‚¹çš„ hash å€¼</span></span><br><span class="line">        Node&lt;K,V&gt; f; <span class="type">int</span> n, i, fh;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ã€CASE1ã€‘ï¼šè¡¨ç¤ºå½“å‰ map ä¸­çš„ table å°šæœªåˆå§‹åŒ–</span></span><br><span class="line">        <span class="keyword">if</span> (tab == <span class="literal">null</span> || (n = tab.length) == <span class="number">0</span>)</span><br><span class="line">            <span class="comment">//ã€å»¶è¿Ÿåˆå§‹åŒ–ã€‘</span></span><br><span class="line">            tab = initTable();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ã€CASE2ã€‘ï¼ši è¡¨ç¤º key ä½¿ç”¨ã€å¯»å€ç®—æ³•ã€‘å¾—åˆ° key å¯¹åº”æ•°ç»„çš„ä¸‹æ ‡ä½ç½®ï¼ŒtabAt è·å–æŒ‡å®šæ¡¶ä½çš„å¤´ç»“ç‚¹f</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((f = tabAt(tab, i = (n - <span class="number">1</span>) &amp; hash)) == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// å¯¹åº”çš„æ•°ç»„ä¸º null è¯´æ˜æ²¡æœ‰å“ˆå¸Œå†²çªï¼Œç›´æ¥æ–°å»ºèŠ‚ç‚¹æ·»åŠ åˆ°è¡¨ä¸­</span></span><br><span class="line">            <span class="keyword">if</span> (casTabAt(tab, i, <span class="literal">null</span>, <span class="keyword">new</span> <span class="title class_">Node</span>&lt;K,V&gt;(hash, key, value, <span class="literal">null</span>)))</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ã€CASE3ã€‘ï¼šé€»è¾‘è¯´æ˜æ•°ç»„å·²ç»è¢«åˆå§‹åŒ–ï¼Œå¹¶ä¸”å½“å‰ key å¯¹åº”çš„ä½ç½®ä¸ä¸º null</span></span><br><span class="line">        <span class="comment">// æ¡ä»¶æˆç«‹è¡¨ç¤ºå½“å‰æ¡¶ä½çš„å¤´ç»“ç‚¹ä¸º FWD ç»“ç‚¹ï¼Œè¡¨ç¤ºç›®å‰ map æ­£å¤„äºæ‰©å®¹è¿‡ç¨‹ä¸­</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((fh = f.hash) == MOVED)</span><br><span class="line">            <span class="comment">// å½“å‰çº¿ç¨‹ã€éœ€è¦å»å¸®åŠ©å“ˆå¸Œè¡¨å®Œæˆæ‰©å®¹ã€‘</span></span><br><span class="line">            tab = helpTransfer(tab, f);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ã€CASE4ã€‘ï¼šå“ˆå¸Œè¡¨æ²¡æœ‰åœ¨æ‰©å®¹ï¼Œå½“å‰æ¡¶ä½å¯èƒ½æ˜¯é“¾è¡¨ä¹Ÿå¯èƒ½æ˜¯çº¢é»‘æ ‘</span></span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// å½“æ’å…¥ key å­˜åœ¨æ—¶ï¼Œä¼šå°†æ—§å€¼èµ‹å€¼ç»™ oldVal è¿”å›</span></span><br><span class="line">            <span class="type">V</span> <span class="variable">oldVal</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="comment">// ã€é”ä½å½“å‰ key å¯»å€çš„æ¡¶ä½çš„å¤´èŠ‚ç‚¹ã€‘</span></span><br><span class="line">            <span class="keyword">synchronized</span> (f) &#123;</span><br><span class="line">                <span class="comment">// è¿™é‡Œé‡æ–°è·å–ä¸€ä¸‹æ¡¶çš„å¤´èŠ‚ç‚¹æœ‰æ²¡æœ‰è¢«ä¿®æ”¹ï¼Œå› ä¸ºå¯èƒ½è¢«å…¶ä»–çº¿ç¨‹ä¿®æ”¹è¿‡ï¼Œè¿™é‡Œæ˜¯çº¿ç¨‹å®‰å…¨çš„è·å–</span></span><br><span class="line">                <span class="keyword">if</span> (tabAt(tab, i) == f) &#123;</span><br><span class="line">                    <span class="comment">// ã€å¤´èŠ‚ç‚¹çš„å“ˆå¸Œå€¼å¤§äº 0 è¯´æ˜å½“å‰æ¡¶ä½æ˜¯æ™®é€šçš„é“¾è¡¨èŠ‚ç‚¹ã€‘</span></span><br><span class="line">                    <span class="keyword">if</span> (fh &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="comment">// å½“å‰çš„æ’å…¥æ“ä½œæ²¡å‡ºç°é‡å¤çš„ keyï¼Œè¿½åŠ åˆ°é“¾è¡¨çš„æœ«å°¾ï¼ŒbinCountè¡¨ç¤ºé“¾è¡¨é•¿åº¦ -1</span></span><br><span class="line">                        <span class="comment">// æ’å…¥çš„keyä¸é“¾è¡¨ä¸­çš„æŸä¸ªå…ƒç´ çš„ key ä¸€è‡´ï¼Œå˜æˆæ›¿æ¢æ“ä½œï¼ŒbinCount è¡¨ç¤ºç¬¬å‡ ä¸ªèŠ‚ç‚¹å†²çª</span></span><br><span class="line">                        binCount = <span class="number">1</span>;</span><br><span class="line">                        <span class="comment">// è¿­ä»£å¾ªç¯å½“å‰æ¡¶ä½çš„é“¾è¡¨ï¼Œe æ˜¯æ¯æ¬¡å¾ªç¯å¤„ç†èŠ‚ç‚¹ï¼Œe åˆå§‹æ˜¯å¤´èŠ‚ç‚¹</span></span><br><span class="line">                        <span class="keyword">for</span> (Node&lt;K,V&gt; e = f;; ++binCount) &#123;</span><br><span class="line">                            <span class="comment">// å½“å‰å¾ªç¯èŠ‚ç‚¹ key</span></span><br><span class="line">                            K ek;</span><br><span class="line">                            <span class="comment">// key çš„å“ˆå¸Œå€¼ä¸å½“å‰èŠ‚ç‚¹çš„å“ˆå¸Œä¸€è‡´ï¼Œå¹¶ä¸” key çš„å€¼ä¹Ÿç›¸åŒ</span></span><br><span class="line">                            <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">                                ((ek = e.key) == key ||</span><br><span class="line">                                 (ek != <span class="literal">null</span> &amp;&amp; key.equals(ek)))) &#123;</span><br><span class="line">                                <span class="comment">// æŠŠå½“å‰èŠ‚ç‚¹çš„ value èµ‹å€¼ç»™ oldVal</span></span><br><span class="line">                                oldVal = e.val;</span><br><span class="line">                                <span class="comment">// å…è®¸è¦†ç›–</span></span><br><span class="line">                                <span class="keyword">if</span> (!onlyIfAbsent)</span><br><span class="line">                                    <span class="comment">// æ–°æ•°æ®è¦†ç›–æ—§æ•°æ®</span></span><br><span class="line">                                    e.val = value;</span><br><span class="line">                                <span class="comment">// è·³å‡ºå¾ªç¯</span></span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                            Node&lt;K,V&gt; pred = e;</span><br><span class="line">                            <span class="comment">// å¦‚æœä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¸ºç©ºï¼ŒæŠŠæ•°æ®å°è£…æˆèŠ‚ç‚¹æ’å…¥é“¾è¡¨å°¾éƒ¨ï¼Œã€binCount ä»£è¡¨é•¿åº¦ - 1ã€‘</span></span><br><span class="line">                            <span class="keyword">if</span> ((e = e.next) == <span class="literal">null</span>) &#123;</span><br><span class="line">                                pred.next = <span class="keyword">new</span> <span class="title class_">Node</span>&lt;K,V&gt;(hash, key,</span><br><span class="line">                                                          value, <span class="literal">null</span>);</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// å½“å‰æ¡¶ä½å¤´èŠ‚ç‚¹æ˜¯çº¢é»‘æ ‘</span></span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (f <span class="keyword">instanceof</span> TreeBin) &#123;</span><br><span class="line">                        Node&lt;K,V&gt; p;</span><br><span class="line">                        binCount = <span class="number">2</span>;</span><br><span class="line">                        <span class="keyword">if</span> ((p = ((TreeBin&lt;K,V&gt;)f).putTreeVal(hash, key,</span><br><span class="line">                                                              value)) != <span class="literal">null</span>) &#123;</span><br><span class="line">                            oldVal = p.val;</span><br><span class="line">                            <span class="keyword">if</span> (!onlyIfAbsent)</span><br><span class="line">                                p.val = value;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// æ¡ä»¶æˆç«‹è¯´æ˜å½“å‰æ˜¯é“¾è¡¨æˆ–è€…çº¢é»‘æ ‘</span></span><br><span class="line">            <span class="keyword">if</span> (binCount != <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// å¦‚æœ binCount &gt;= 8 è¡¨ç¤ºå¤„ç†çš„æ¡¶ä½ä¸€å®šæ˜¯é“¾è¡¨ï¼Œè¯´æ˜é•¿åº¦æ˜¯ 9</span></span><br><span class="line">                <span class="keyword">if</span> (binCount &gt;= TREEIFY_THRESHOLD)</span><br><span class="line">                    <span class="comment">// æ ‘åŒ–</span></span><br><span class="line">                    treeifyBin(tab, i);</span><br><span class="line">                <span class="keyword">if</span> (oldVal != <span class="literal">null</span>)</span><br><span class="line">                    <span class="keyword">return</span> oldVal;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ç»Ÿè®¡å½“å‰ table ä¸€å…±æœ‰å¤šå°‘æ•°æ®ï¼Œåˆ¤æ–­æ˜¯å¦è¾¾åˆ°æ‰©å®¹é˜ˆå€¼æ ‡å‡†ï¼Œè§¦å‘æ‰©å®¹</span></span><br><span class="line">    <span class="comment">// binCount = 0 è¡¨ç¤ºå½“å‰æ¡¶ä½ä¸º nullï¼Œnode å¯ä»¥ç›´æ¥æ”¾å…¥ï¼Œ2 è¡¨ç¤ºå½“å‰æ¡¶ä½å·²ç»æ˜¯çº¢é»‘æ ‘</span></span><br><span class="line">    addCount(<span class="number">1L</span>, binCount);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>spread()ï¼šæ‰°åŠ¨å‡½æ•°</p><p>å°† hashCode æ— ç¬¦å·å³ç§» 16 ä½ï¼Œé«˜ 16bit å’Œä½ 16bit åšå¼‚æˆ–ï¼Œæœ€åä¸ HASH_BITS ç›¸ä¸å˜æˆæ­£æ•°ï¼Œ<strong>ä¸æ ‘åŒ–èŠ‚ç‚¹å’Œè½¬ç§»èŠ‚ç‚¹åŒºåˆ†</strong>ï¼ŒæŠŠé«˜ä½ä½éƒ½åˆ©ç”¨èµ·æ¥å‡å°‘å“ˆå¸Œå†²çªï¼Œä¿è¯æ•£åˆ—çš„å‡åŒ€æ€§</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">spread</span><span class="params">(<span class="type">int</span> h)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (h ^ (h &gt;&gt;&gt; <span class="number">16</span>)) &amp; HASH_BITS; <span class="comment">// 0111 1111 1111 1111 1111 1111 1111 1111</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>initTable()ï¼šåˆå§‹åŒ–æ•°ç»„ï¼Œå»¶è¿Ÿåˆå§‹åŒ–</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Node&lt;K,V&gt;[] initTable() &#123;</span><br><span class="line">    <span class="comment">// tab å¼•ç”¨ map.tableï¼Œsc å¼•ç”¨ sizeCtl</span></span><br><span class="line">    Node&lt;K,V&gt;[] tab; <span class="type">int</span> sc;</span><br><span class="line">    <span class="comment">// table å°šæœªåˆå§‹åŒ–ï¼Œå¼€å§‹è‡ªæ—‹</span></span><br><span class="line">    <span class="keyword">while</span> ((tab = table) == <span class="literal">null</span> || tab.length == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// sc &lt; 0 è¯´æ˜ table æ­£åœ¨åˆå§‹åŒ–æˆ–è€…æ­£åœ¨æ‰©å®¹ï¼Œå½“å‰çº¿ç¨‹å¯ä»¥é‡Šæ”¾ CPU èµ„æº</span></span><br><span class="line">        <span class="keyword">if</span> ((sc = sizeCtl) &lt; <span class="number">0</span>)</span><br><span class="line">            Thread.yield();</span><br><span class="line">        <span class="comment">// sizeCtl è®¾ç½®ä¸º -1ï¼Œç›¸å½“äºåŠ é”ï¼Œã€è®¾ç½®çš„æ˜¯ SIZECTL ä½ç½®çš„æ•°æ®ã€‘ï¼Œ</span></span><br><span class="line">        <span class="comment">// å› ä¸ºæ˜¯ sizeCtl æ˜¯åŸºæœ¬ç±»å‹ï¼Œä¸æ˜¯å¼•ç”¨ç±»å‹ï¼Œæ‰€ä»¥ sc ä¿å­˜çš„æ˜¯æ•°æ®çš„å‰¯æœ¬</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (U.compareAndSwapInt(<span class="built_in">this</span>, SIZECTL, sc, -<span class="number">1</span>)) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// çº¿ç¨‹å®‰å…¨çš„é€»è¾‘ï¼Œå†è¿›è¡Œä¸€æ¬¡åˆ¤æ–­</span></span><br><span class="line">                <span class="keyword">if</span> ((tab = table) == <span class="literal">null</span> || tab.length == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">// sc &gt; 0 åˆ›å»º table æ—¶ä½¿ç”¨ sc ä¸ºæŒ‡å®šå¤§å°ï¼Œå¦åˆ™ä½¿ç”¨ 16 é»˜è®¤å€¼</span></span><br><span class="line">                    <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> (sc &gt; <span class="number">0</span>) ? sc : DEFAULT_CAPACITY;</span><br><span class="line">                    <span class="comment">// åˆ›å»ºå“ˆå¸Œè¡¨æ•°ç»„</span></span><br><span class="line">                    Node&lt;K,V&gt;[] nt = (Node&lt;K,V&gt;[])<span class="keyword">new</span> <span class="title class_">Node</span>&lt;?,?&gt;[n];</span><br><span class="line">                    table = tab = nt;</span><br><span class="line">                    <span class="comment">// æ‰©å®¹é˜ˆå€¼ï¼Œn &gt;&gt;&gt; 2  =&gt; ç­‰äº 1/4 n ï¼Œn - (1/4)n = 3/4 n =&gt; 0.75 * n</span></span><br><span class="line">                    sc = n - (n &gt;&gt;&gt; <span class="number">2</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="comment">// è§£é”ï¼ŒæŠŠä¸‹ä¸€æ¬¡æ‰©å®¹çš„é˜ˆå€¼èµ‹å€¼ç»™ sizeCtl</span></span><br><span class="line">                sizeCtl = sc;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> tab;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>treeifyBin()ï¼šæ ‘åŒ–æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">treeifyBin</span><span class="params">(Node&lt;K,V&gt;[] tab, <span class="type">int</span> index)</span> &#123;</span><br><span class="line">    Node&lt;K,V&gt; b; <span class="type">int</span> n, sc;</span><br><span class="line">    <span class="keyword">if</span> (tab != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// æ¡ä»¶æˆç«‹ï¼šã€è¯´æ˜å½“å‰ table æ•°ç»„é•¿åº¦æœªè¾¾åˆ° 64ï¼Œæ­¤æ—¶ä¸è¿›è¡Œæ ‘åŒ–æ“ä½œï¼Œè¿›è¡Œæ‰©å®¹æ“ä½œã€‘</span></span><br><span class="line">        <span class="keyword">if</span> ((n = tab.length) &lt; MIN_TREEIFY_CAPACITY)</span><br><span class="line">            <span class="comment">// å½“å‰å®¹é‡çš„ 2 å€</span></span><br><span class="line">            tryPresize(n &lt;&lt; <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// æ¡ä»¶æˆç«‹ï¼šè¯´æ˜å½“å‰æ¡¶ä½æœ‰æ•°æ®ï¼Œä¸”æ˜¯æ™®é€š node æ•°æ®ã€‚</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((b = tabAt(tab, index)) != <span class="literal">null</span> &amp;&amp; b.hash &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// ã€æ ‘åŒ–åŠ é”ã€‘</span></span><br><span class="line">            <span class="keyword">synchronized</span> (b) &#123;</span><br><span class="line">                <span class="comment">// æ¡ä»¶æˆç«‹ï¼šè¡¨ç¤ºåŠ é”æ²¡é—®é¢˜ã€‚</span></span><br><span class="line">                <span class="keyword">if</span> (tabAt(tab, index) == b) &#123;</span><br><span class="line">                    TreeNode&lt;K,V&gt; hd = <span class="literal">null</span>, tl = <span class="literal">null</span>;</span><br><span class="line">                    <span class="keyword">for</span> (Node&lt;K,V&gt; e = b; e != <span class="literal">null</span>; e = e.next) &#123;</span><br><span class="line">                        TreeNode&lt;K,V&gt; p = <span class="keyword">new</span> <span class="title class_">TreeNode</span>&lt;K,V&gt;(e.hash, e.key, e.val,<span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">                        <span class="keyword">if</span> ((p.prev = tl) == <span class="literal">null</span>)</span><br><span class="line">                            hd = p;</span><br><span class="line">                        <span class="keyword">else</span></span><br><span class="line">                            tl.next = p;</span><br><span class="line">                        tl = p;</span><br><span class="line">                    &#125;</span><br><span class="line">                    setTabAt(tab, index, <span class="keyword">new</span> <span class="title class_">TreeBin</span>&lt;K,V&gt;(hd));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>addCount()ï¼šæ·»åŠ è®¡æ•°ï¼Œ<strong>ä»£è¡¨å“ˆå¸Œè¡¨ä¸­çš„æ•°æ®æ€»é‡</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">addCount</span><span class="params">(<span class="type">long</span> x, <span class="type">int</span> check)</span> &#123;</span><br><span class="line">    <span class="comment">// ã€ä¸Šé¢è¿™éƒ¨åˆ†çš„é€»è¾‘å°±æ˜¯ LongAdder çš„ç´¯åŠ é€»è¾‘ã€‘</span></span><br><span class="line">    CounterCell[] as; <span class="type">long</span> b, s;</span><br><span class="line">    <span class="comment">// åˆ¤æ–­ç´¯åŠ æ•°ç»„ cells æ˜¯å¦åˆå§‹åŒ–ï¼Œæ²¡æœ‰å°±å»ç´¯åŠ  base åŸŸï¼Œç´¯åŠ å¤±è´¥è¿›å…¥æ¡ä»¶å†…é€»è¾‘</span></span><br><span class="line">    <span class="keyword">if</span> ((as = counterCells) != <span class="literal">null</span> ||</span><br><span class="line">        !U.compareAndSwapLong(<span class="built_in">this</span>, BASECOUNT, b = baseCount, s = b + x)) &#123;</span><br><span class="line">        CounterCell a; <span class="type">long</span> v; <span class="type">int</span> m;</span><br><span class="line">        <span class="comment">// true æœªç«äº‰ï¼Œfalse å‘ç”Ÿç«äº‰</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">uncontended</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="comment">// åˆ¤æ–­ cells æ˜¯å¦è¢«å…¶ä»–çº¿ç¨‹åˆå§‹åŒ–</span></span><br><span class="line">        <span class="keyword">if</span> (as == <span class="literal">null</span> || (m = as.length - <span class="number">1</span>) &lt; <span class="number">0</span> ||</span><br><span class="line">            <span class="comment">// å‰é¢çš„æ¡ä»¶ä¸º fasle è¯´æ˜ cells è¢«å…¶ä»–çº¿ç¨‹åˆå§‹åŒ–ï¼Œé€šè¿‡ hash å¯»å€å¯¹åº”çš„æ§½ä½</span></span><br><span class="line">            (a = as[ThreadLocalRandom.getProbe() &amp; m]) == <span class="literal">null</span> ||</span><br><span class="line">            <span class="comment">// å°è¯•å»å¯¹åº”çš„æ§½ä½ç´¯åŠ ï¼Œç´¯åŠ å¤±è´¥è¿›å…¥ fullAddCount è¿›è¡Œé‡è¯•æˆ–è€…æ‰©å®¹</span></span><br><span class="line">            !(uncontended = U.compareAndSwapLong(a, CELLVALUE, v = a.value, v + x))) &#123;</span><br><span class="line">            <span class="comment">// ä¸ Striped64#longAccumulate æ–¹æ³•ç›¸åŒ</span></span><br><span class="line">            fullAddCount(x, uncontended);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// è¡¨ç¤ºå½“å‰æ¡¶ä½æ˜¯ nullï¼Œæˆ–è€…ä¸€ä¸ªé“¾è¡¨èŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">if</span> (check &lt;= <span class="number">1</span>)</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">    <span class="comment">// ã€è·å–å½“å‰æ•£åˆ—è¡¨å…ƒç´ ä¸ªæ•°ã€‘ï¼Œè¿™æ˜¯ä¸€ä¸ªæœŸæœ›å€¼</span></span><br><span class="line">        s = sumCount();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è¡¨ç¤ºä¸€å®š ã€æ˜¯ä¸€ä¸ª put æ“ä½œè°ƒç”¨çš„ addCountã€‘</span></span><br><span class="line">    <span class="keyword">if</span> (check &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        Node&lt;K,V&gt;[] tab, nt; <span class="type">int</span> n, sc;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// æ¡ä»¶ä¸€ï¼štrue è¯´æ˜å½“å‰ sizeCtl å¯èƒ½ä¸ºä¸€ä¸ªè´Ÿæ•°è¡¨ç¤ºæ­£åœ¨æ‰©å®¹ä¸­ï¼Œæˆ–è€… sizeCtl æ˜¯ä¸€ä¸ªæ­£æ•°ï¼Œè¡¨ç¤ºæ‰©å®¹é˜ˆå€¼</span></span><br><span class="line">        <span class="comment">//        false è¡¨ç¤ºå“ˆå¸Œè¡¨çš„æ•°æ®çš„æ•°é‡æ²¡è¾¾åˆ°æ‰©å®¹æ¡ä»¶</span></span><br><span class="line">        <span class="comment">// ç„¶ååˆ¤æ–­å½“å‰ table æ•°ç»„æ˜¯å¦åˆå§‹åŒ–äº†ï¼Œå½“å‰ table é•¿åº¦æ˜¯å¦å°äºæœ€å¤§å€¼é™åˆ¶ï¼Œå°±å¯ä»¥è¿›è¡Œæ‰©å®¹</span></span><br><span class="line">        <span class="keyword">while</span> (s &gt;= (<span class="type">long</span>)(sc = sizeCtl) &amp;&amp; (tab = table) != <span class="literal">null</span> &amp;&amp;</span><br><span class="line">               (n = tab.length) &lt; MAXIMUM_CAPACITY) &#123;</span><br><span class="line">            <span class="comment">// 16 -&gt; 32 æ‰©å®¹ æ ‡è¯†ä¸ºï¼š1000 0000 0001 1011ï¼Œã€è´Ÿæ•°ï¼Œæ‰©å®¹æ‰¹æ¬¡å”¯ä¸€æ ‡è¯†æˆ³ã€‘</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">rs</span> <span class="operator">=</span> resizeStamp(n);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">// è¡¨ç¤ºå½“å‰ tableï¼Œã€æ­£åœ¨æ‰©å®¹ã€‘ï¼Œsc é«˜ 16 ä½æ˜¯æ‰©å®¹æ ‡è¯†æˆ³ï¼Œä½ 16 ä½æ˜¯çº¿ç¨‹æ•° + 1</span></span><br><span class="line">            <span class="keyword">if</span> (sc &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// æ¡ä»¶ä¸€ï¼šåˆ¤æ–­æ‰©å®¹æ ‡è¯†æˆ³æ˜¯å¦ä¸€æ ·ï¼Œfasle ä»£è¡¨ä¸€æ ·</span></span><br><span class="line">                <span class="comment">// å‹˜è¯¯ä¸¤ä¸ªæ¡ä»¶ï¼š</span></span><br><span class="line">                <span class="comment">// æ¡ä»¶äºŒæ˜¯ï¼šsc == (rs &lt;&lt; 16 ) + 1ï¼Œtrue ä»£è¡¨æ‰©å®¹å®Œæˆï¼Œå› ä¸ºä½16ä½æ˜¯1ä»£è¡¨æ²¡æœ‰çº¿ç¨‹æ‰©å®¹äº†</span></span><br><span class="line">                <span class="comment">// æ¡ä»¶ä¸‰æ˜¯ï¼šsc == (rs &lt;&lt; 16) + MAX_RESIZERSï¼Œåˆ¤æ–­æ˜¯å¦å·²ç»è¶…è¿‡æœ€å¤§å…è®¸çš„å¹¶å‘æ‰©å®¹çº¿ç¨‹æ•°</span></span><br><span class="line">                <span class="comment">// æ¡ä»¶å››ï¼šåˆ¤æ–­æ–°è¡¨çš„å¼•ç”¨æ˜¯å¦æ˜¯ nullï¼Œä»£è¡¨æ‰©å®¹å®Œæˆ</span></span><br><span class="line">                <span class="comment">// æ¡ä»¶äº”ï¼šã€æ‰©å®¹æ˜¯ä»é«˜ä½åˆ°ä½ä½è½¬ç§»ã€‘ï¼ŒtransferIndex &lt; 0 è¯´æ˜æ²¡æœ‰åŒºé—´éœ€è¦æ‰©å®¹äº†</span></span><br><span class="line">                <span class="keyword">if</span> ((sc &gt;&gt;&gt; RESIZE_STAMP_SHIFT) != rs || sc == rs + <span class="number">1</span> ||</span><br><span class="line">                    sc == rs + MAX_RESIZERS || (nt = nextTable) == <span class="literal">null</span> ||</span><br><span class="line">                    transferIndex &lt;= <span class="number">0</span>)</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                </span><br><span class="line">                <span class="comment">// è®¾ç½®å½“å‰çº¿ç¨‹å‚ä¸åˆ°æ‰©å®¹ä»»åŠ¡ä¸­ï¼Œå°† sc ä½ 16 ä½å€¼åŠ  1ï¼Œè¡¨ç¤ºå¤šä¸€ä¸ªçº¿ç¨‹å‚ä¸æ‰©å®¹</span></span><br><span class="line">                <span class="comment">// è®¾ç½®å¤±è´¥å…¶ä»–çº¿ç¨‹æˆ–è€… transfer å†…éƒ¨ä¿®æ”¹äº† sizeCtl å€¼</span></span><br><span class="line">                <span class="keyword">if</span> (U.compareAndSwapInt(<span class="built_in">this</span>, SIZECTL, sc, sc + <span class="number">1</span>))</span><br><span class="line">                    <span class="comment">//ã€ååŠ©æ‰©å®¹çº¿ç¨‹ã€‘ï¼ŒæŒæœ‰nextTableå‚æ•°</span></span><br><span class="line">                    transfer(tab, nt);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// é€»è¾‘åˆ°è¿™è¯´æ˜å½“å‰çº¿ç¨‹æ˜¯è§¦å‘æ‰©å®¹çš„ç¬¬ä¸€ä¸ªçº¿ç¨‹ï¼Œçº¿ç¨‹æ•°é‡ + 2</span></span><br><span class="line">            <span class="comment">// 1000 0000 0001 1011 0000 0000 0000 0000 +2 =&gt; 1000 0000 0001 1011 0000 0000 0000 0010</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (U.compareAndSwapInt(<span class="built_in">this</span>, SIZECTL, sc,(rs &lt;&lt; RESIZE_STAMP_SHIFT) + <span class="number">2</span>))</span><br><span class="line">                <span class="comment">//ã€è§¦å‘æ‰©å®¹æ¡ä»¶çš„çº¿ç¨‹ã€‘ï¼Œä¸æŒæœ‰ nextTableï¼Œåˆå§‹çº¿ç¨‹ä¼šæ–°å»º nextTable</span></span><br><span class="line">                transfer(tab, <span class="literal">null</span>);</span><br><span class="line">            s = sumCount();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>resizeStamp()ï¼šæ‰©å®¹æ ‡è¯†ç¬¦ï¼Œ<strong>æ¯æ¬¡æ‰©å®¹éƒ½ä¼šäº§ç”Ÿä¸€ä¸ªï¼Œä¸æ˜¯æ¯ä¸ªçº¿ç¨‹éƒ½äº§ç”Ÿ</strong>ï¼Œ16 æ‰©å®¹åˆ° 32 äº§ç”Ÿä¸€ä¸ªï¼Œ32 æ‰©å®¹åˆ° 64 äº§ç”Ÿä¸€ä¸ª</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æ‰©å®¹çš„æ ‡è¯†ç¬¦</span></span><br><span class="line"><span class="comment"> * 16 -&gt; 32 ä»16æ‰©å®¹åˆ°32</span></span><br><span class="line"><span class="comment"> * numberOfLeadingZeros(16) =&gt; 1 0000 =&gt; 32 - 5 = 27 =&gt; 0000 0000 0001 1011</span></span><br><span class="line"><span class="comment"> * (1 &lt;&lt; (RESIZE_STAMP_BITS - 1)) =&gt; 1000 0000 0000 0000 =&gt; 32768</span></span><br><span class="line"><span class="comment"> * ---------------------------------------------------------------</span></span><br><span class="line"><span class="comment"> * 0000 0000 0001 1011</span></span><br><span class="line"><span class="comment"> * 1000 0000 0000 0000</span></span><br><span class="line"><span class="comment"> * 1000 0000 0001 1011</span></span><br><span class="line"><span class="comment"> * æ°¸è¿œæ˜¯è´Ÿæ•°</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">resizeStamp</span><span class="params">(<span class="type">int</span> n)</span> &#123;</span><br><span class="line">    <span class="comment">// æˆ–è¿ç®—</span></span><br><span class="line">    <span class="keyword">return</span> Integer.numberOfLeadingZeros(n) | (<span class="number">1</span> &lt;&lt; (RESIZE_STAMP_BITS - <span class="number">1</span>)); <span class="comment">// (16 -1 = 15)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><hr><h5 id="æ‰©å®¹æ–¹æ³•"><a href="#æ‰©å®¹æ–¹æ³•" class="headerlink" title="æ‰©å®¹æ–¹æ³•"></a>æ‰©å®¹æ–¹æ³•</h5><p>æ‰©å®¹æœºåˆ¶ï¼š</p><ul><li>å½“é“¾è¡¨ä¸­å…ƒç´ ä¸ªæ•°è¶…è¿‡ 8 ä¸ªï¼Œæ•°ç»„çš„å¤§å°è¿˜æœªè¶…è¿‡ 64 æ—¶ï¼Œæ­¤æ—¶è¿›è¡Œæ•°ç»„çš„æ‰©å®¹ï¼Œå¦‚æœè¶…è¿‡åˆ™å°†é“¾è¡¨è½¬åŒ–æˆçº¢é»‘æ ‘</li><li>put æ•°æ®åè°ƒç”¨ addCount() æ–¹æ³•ï¼Œåˆ¤æ–­å½“å‰å“ˆå¸Œè¡¨çš„å®¹é‡è¶…è¿‡é˜ˆå€¼ sizeCtlï¼Œè¶…è¿‡è¿›è¡Œæ‰©å®¹</li><li>å¢åˆ æ”¹çº¿ç¨‹å‘ç°å…¶ä»–çº¿ç¨‹æ­£åœ¨æ‰©å®¹ï¼Œå¸®å…¶æ‰©å®¹</li></ul><p>å¸¸è§æ–¹æ³•ï¼š</p><ul><li><p>transfer()ï¼šæ•°æ®è½¬ç§»åˆ°æ–°è¡¨ä¸­ï¼Œå®Œæˆæ‰©å®¹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">transfer</span><span class="params">(Node&lt;K,V&gt;[] tab, Node&lt;K,V&gt;[] nextTab)</span> &#123;</span><br><span class="line">    <span class="comment">// n è¡¨ç¤ºæ‰©å®¹ä¹‹å‰ table æ•°ç»„çš„é•¿åº¦</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> tab.length, stride;</span><br><span class="line">    <span class="comment">// stride è¡¨ç¤ºåˆ†é…ç»™çº¿ç¨‹ä»»åŠ¡çš„æ­¥é•¿ï¼Œé»˜è®¤å°±æ˜¯ 16 </span></span><br><span class="line">    <span class="keyword">if</span> ((stride = (NCPU &gt; <span class="number">1</span>) ? (n &gt;&gt;&gt; <span class="number">3</span>) / NCPU : n) &lt; MIN_TRANSFER_STRIDE)</span><br><span class="line">        stride = MIN_TRANSFER_STRIDE;</span><br><span class="line">    <span class="comment">// å¦‚æœå½“å‰çº¿ç¨‹ä¸ºè§¦å‘æœ¬æ¬¡æ‰©å®¹çš„çº¿ç¨‹ï¼Œéœ€è¦åšä¸€äº›æ‰©å®¹å‡†å¤‡å·¥ä½œï¼Œã€ååŠ©çº¿ç¨‹ä¸åšè¿™ä¸€æ­¥ã€‘</span></span><br><span class="line">    <span class="keyword">if</span> (nextTab == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// åˆ›å»ºä¸€ä¸ªå®¹é‡æ˜¯ä¹‹å‰ã€äºŒå€çš„ table æ•°ç»„ã€‘</span></span><br><span class="line">            Node&lt;K,V&gt;[] nt = (Node&lt;K,V&gt;[])<span class="keyword">new</span> <span class="title class_">Node</span>&lt;?,?&gt;[n &lt;&lt; <span class="number">1</span>];</span><br><span class="line">            nextTab = nt;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">            sizeCtl = Integer.MAX_VALUE;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æŠŠæ–°è¡¨èµ‹å€¼ç»™å¯¹è±¡å±æ€§ nextTableï¼Œæ–¹ä¾¿å…¶ä»–çº¿ç¨‹è·å–æ–°è¡¨</span></span><br><span class="line">        nextTable = nextTab;</span><br><span class="line">        <span class="comment">// è®°å½•è¿ç§»æ•°æ®æ•´ä½“ä½ç½®çš„ä¸€ä¸ªæ ‡è®°ï¼ŒtransferIndex è®¡æ•°ä»1å¼€å§‹ä¸æ˜¯ 0ï¼Œæ‰€ä»¥è¿™é‡Œæ˜¯é•¿åº¦ï¼Œä¸æ˜¯é•¿åº¦-1</span></span><br><span class="line">        transferIndex = n;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ–°æ•°ç»„çš„é•¿åº¦</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">nextn</span> <span class="operator">=</span> nextTab.length;</span><br><span class="line">    <span class="comment">// å½“æŸä¸ªæ¡¶ä½æ•°æ®å¤„ç†å®Œæ¯•åï¼Œå°†æ­¤æ¡¶ä½è®¾ç½®ä¸º fwd èŠ‚ç‚¹ï¼Œå…¶å®ƒå†™çº¿ç¨‹æˆ–è¯»çº¿ç¨‹çœ‹åˆ°åï¼Œå¯ä»¥ä»ä¸­è·å–åˆ°æ–°è¡¨</span></span><br><span class="line">    ForwardingNode&lt;K,V&gt; fwd = <span class="keyword">new</span> <span class="title class_">ForwardingNode</span>&lt;K,V&gt;(nextTab);</span><br><span class="line">    <span class="comment">// æ¨è¿›æ ‡è®°</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">advance</span> <span class="operator">=</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="comment">// å®Œæˆæ ‡è®°</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">finishing</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// i è¡¨ç¤ºåˆ†é…ç»™å½“å‰çº¿ç¨‹ä»»åŠ¡ï¼Œæ‰§è¡Œåˆ°çš„æ¡¶ä½</span></span><br><span class="line">    <span class="comment">// bound è¡¨ç¤ºåˆ†é…ç»™å½“å‰çº¿ç¨‹ä»»åŠ¡çš„ä¸‹ç•Œé™åˆ¶ï¼Œå› ä¸ºæ˜¯å€’åºè¿ç§»ï¼Œ16 è¿ç§»å®Œ è¿ç§» 15ï¼Œ15å®Œæˆå»è¿ç§»14</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>, bound = <span class="number">0</span>;;) &#123;</span><br><span class="line">        Node&lt;K,V&gt; f; <span class="type">int</span> fh;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ç»™å½“å‰çº¿ç¨‹ã€åˆ†é…ä»»åŠ¡åŒºé—´ã€‘</span></span><br><span class="line">        <span class="keyword">while</span> (advance) &#123;</span><br><span class="line">            <span class="comment">// åˆ†é…ä»»åŠ¡çš„å¼€å§‹ä¸‹æ ‡ï¼Œåˆ†é…ä»»åŠ¡çš„ç»“æŸä¸‹æ ‡</span></span><br><span class="line">            <span class="type">int</span> nextIndex, nextBound;</span><br><span class="line">         </span><br><span class="line">            <span class="comment">// --i è®©å½“å‰çº¿ç¨‹å¤„ç†ä¸‹ä¸€ä¸ªç´¢å¼•ï¼Œtrueè¯´æ˜å½“å‰çš„è¿ç§»ä»»åŠ¡å°šæœªå®Œæˆï¼Œfalseè¯´æ˜çº¿ç¨‹å·²ç»å®Œæˆæˆ–è€…è¿˜æœªåˆ†é…</span></span><br><span class="line">            <span class="keyword">if</span> (--i &gt;= bound || finishing)</span><br><span class="line">                advance = <span class="literal">false</span>;</span><br><span class="line">            <span class="comment">// è¿ç§»çš„å¼€å§‹ä¸‹æ ‡ï¼Œå°äº0è¯´æ˜æ²¡æœ‰åŒºé—´éœ€è¦è¿ç§»äº†ï¼Œè®¾ç½®å½“å‰çº¿ç¨‹çš„ i å˜é‡ä¸º -1 è·³å‡ºå¾ªç¯</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> ((nextIndex = transferIndex) &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                i = -<span class="number">1</span>;</span><br><span class="line">                advance = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// é€»è¾‘åˆ°è¿™è¯´æ˜è¿˜æœ‰åŒºé—´éœ€è¦åˆ†é…ï¼Œç„¶åç»™å½“å‰çº¿ç¨‹åˆ†é…ä»»åŠ¡ï¼Œ</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (U.compareAndSwapInt(<span class="built_in">this</span>, TRANSFERINDEX, nextIndex,</span><br><span class="line">                      <span class="comment">// åˆ¤æ–­åŒºé—´æ˜¯å¦è¿˜å¤Ÿä¸€ä¸ªæ­¥é•¿ï¼Œä¸å¤Ÿå°±å…¨éƒ¨åˆ†é…</span></span><br><span class="line">                      nextBound = (nextIndex &gt; stride ? nextIndex - stride : <span class="number">0</span>))) &#123;</span><br><span class="line">                <span class="comment">// å½“å‰çº¿ç¨‹çš„ç»“æŸä¸‹æ ‡</span></span><br><span class="line">                bound = nextBound;</span><br><span class="line">                <span class="comment">// å½“å‰çº¿ç¨‹çš„å¼€å§‹ä¸‹æ ‡ï¼Œä¸Šä¸€ä¸ªçº¿ç¨‹ç»“æŸçš„ä¸‹æ ‡çš„ä¸‹ä¸€ä¸ªç´¢å¼•å°±æ˜¯è¿™ä¸ªçº¿ç¨‹å¼€å§‹çš„ä¸‹æ ‡</span></span><br><span class="line">                i = nextIndex - <span class="number">1</span>;</span><br><span class="line">                <span class="comment">// ä»»åŠ¡åˆ†é…ç»“æŸï¼Œè·³å‡ºå¾ªç¯æ‰§è¡Œè¿ç§»æ“ä½œ</span></span><br><span class="line">                advance = <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ã€åˆ†é…å®Œæˆï¼Œå¼€å§‹æ•°æ®è¿ç§»æ“ä½œã€‘</span></span><br><span class="line">        <span class="comment">// ã€CASE1ã€‘ï¼ši &lt; 0 æˆç«‹è¡¨ç¤ºå½“å‰çº¿ç¨‹æœªåˆ†é…åˆ°ä»»åŠ¡ï¼Œæˆ–è€…ä»»åŠ¡æ‰§è¡Œå®Œäº†</span></span><br><span class="line">        <span class="keyword">if</span> (i &lt; <span class="number">0</span> || i &gt;= n || i + n &gt;= nextn) &#123;</span><br><span class="line">            <span class="type">int</span> sc;</span><br><span class="line">            <span class="comment">// å¦‚æœè¿ç§»å®Œæˆ</span></span><br><span class="line">            <span class="keyword">if</span> (finishing) &#123;</span><br><span class="line">                nextTable = <span class="literal">null</span>;<span class="comment">// help GC</span></span><br><span class="line">                table = nextTab;<span class="comment">// æ–°è¡¨èµ‹å€¼ç»™å½“å‰å¯¹è±¡</span></span><br><span class="line">                sizeCtl = (n &lt;&lt; <span class="number">1</span>) - (n &gt;&gt;&gt; <span class="number">1</span>);<span class="comment">// æ‰©å®¹é˜ˆå€¼ä¸º 2n - n/2 = 3n/2 = 0.75*(2n)</span></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å½“å‰çº¿ç¨‹å®Œæˆäº†åˆ†é…çš„ä»»åŠ¡åŒºé—´ï¼Œå¯ä»¥é€€å‡ºï¼Œå…ˆæŠŠ sizeCtl èµ‹å€¼ç»™ sc ä¿ç•™</span></span><br><span class="line">            <span class="keyword">if</span> (U.compareAndSwapInt(<span class="built_in">this</span>, SIZECTL, sc = sizeCtl, sc - <span class="number">1</span>)) &#123;</span><br><span class="line">                <span class="comment">// åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯ä¸æ˜¯æœ€åä¸€ä¸ªçº¿ç¨‹ï¼Œä¸æ˜¯çš„è¯ç›´æ¥ returnï¼Œ</span></span><br><span class="line">                <span class="keyword">if</span> ((sc - <span class="number">2</span>) != resizeStamp(n) &lt;&lt; RESIZE_STAMP_SHIFT)</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                <span class="comment">// æ‰€ä»¥æœ€åä¸€ä¸ªçº¿ç¨‹é€€å‡ºçš„æ—¶å€™ï¼ŒsizeCtl çš„ä½ 16 ä½ä¸º 1</span></span><br><span class="line">                finishing = advance = <span class="literal">true</span>;</span><br><span class="line">                <span class="comment">// ã€è¿™é‡Œè¡¨ç¤ºæœ€åä¸€ä¸ªçº¿ç¨‹éœ€è¦é‡æ–°æ£€æŸ¥ä¸€éæ˜¯å¦æœ‰æ¼æ‰çš„åŒºé—´ã€‘</span></span><br><span class="line">                i = n;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ã€CASE2ã€‘ï¼šå½“å‰æ¡¶ä½æœªå­˜æ”¾æ•°æ®ï¼Œåªéœ€è¦å°†æ­¤å¤„è®¾ç½®ä¸º fwd èŠ‚ç‚¹å³å¯ã€‚</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((f = tabAt(tab, i)) == <span class="literal">null</span>)</span><br><span class="line">            advance = casTabAt(tab, i, <span class="literal">null</span>, fwd);</span><br><span class="line">        <span class="comment">// ã€CASE3ã€‘ï¼šè¯´æ˜å½“å‰æ¡¶ä½å·²ç»è¿ç§»è¿‡äº†ï¼Œå½“å‰çº¿ç¨‹ä¸ç”¨å†å¤„ç†äº†ï¼Œç›´æ¥å¤„ç†ä¸‹ä¸€ä¸ªæ¡¶ä½å³å¯</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((fh = f.hash) == MOVED)</span><br><span class="line">            advance = <span class="literal">true</span>; </span><br><span class="line">        <span class="comment">// ã€CASE4ã€‘ï¼šå½“å‰æ¡¶ä½æœ‰æ•°æ®ï¼Œè€Œä¸” node èŠ‚ç‚¹ä¸æ˜¯ fwd èŠ‚ç‚¹ï¼Œè¯´æ˜è¿™äº›æ•°æ®éœ€è¦è¿ç§»</span></span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// ã€é”ä½å¤´èŠ‚ç‚¹ã€‘</span></span><br><span class="line">            <span class="keyword">synchronized</span> (f) &#123;</span><br><span class="line">                <span class="comment">// äºŒæ¬¡æ£€æŸ¥ï¼Œé˜²æ­¢å¤´èŠ‚ç‚¹å·²ç»è¢«ä¿®æ”¹äº†ï¼Œå› ä¸ºè¿™é‡Œæ‰æ˜¯çº¿ç¨‹å®‰å…¨çš„è®¿é—®</span></span><br><span class="line">                <span class="keyword">if</span> (tabAt(tab, i) == f) &#123;</span><br><span class="line">                    <span class="comment">// ã€è¿ç§»æ•°æ®çš„é€»è¾‘ï¼Œå’Œ HashMap ç›¸ä¼¼ã€‘</span></span><br><span class="line">                        </span><br><span class="line">                    <span class="comment">// ln è¡¨ç¤ºä½ä½é“¾è¡¨å¼•ç”¨</span></span><br><span class="line">                    <span class="comment">// hn è¡¨ç¤ºé«˜ä½é“¾è¡¨å¼•ç”¨</span></span><br><span class="line">                    Node&lt;K,V&gt; ln, hn;</span><br><span class="line">                    <span class="comment">// å“ˆå¸Œ &gt; 0 è¡¨ç¤ºå½“å‰æ¡¶ä½æ˜¯é“¾è¡¨æ¡¶ä½</span></span><br><span class="line">                    <span class="keyword">if</span> (fh &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="comment">// å’Œ HashMap çš„å¤„ç†æ–¹å¼ä¸€è‡´ï¼Œä¸è€æ•°ç»„é•¿åº¦ç›¸ä¸ï¼Œ16 æ˜¯ 10000</span></span><br><span class="line">                        <span class="comment">// åˆ¤æ–­å¯¹åº”çš„ 1 çš„ä½ç½®ä¸Šæ˜¯ 0 æˆ– 1 åˆ†æˆé«˜ä½ä½é“¾è¡¨</span></span><br><span class="line">                        <span class="type">int</span> <span class="variable">runBit</span> <span class="operator">=</span> fh &amp; n;</span><br><span class="line">                        Node&lt;K,V&gt; lastRun = f;</span><br><span class="line">                        <span class="comment">// éå†é“¾è¡¨ï¼Œå¯»æ‰¾ã€é€†åºçœ‹ã€‘æœ€é•¿çš„å¯¹åº”ä½ç›¸åŒçš„é“¾è¡¨ï¼Œçœ‹ä¸‹é¢çš„å›¾æ›´å¥½çš„ç†è§£</span></span><br><span class="line">                        <span class="keyword">for</span> (Node&lt;K,V&gt; p = f.next; p != <span class="literal">null</span>; p = p.next) &#123;</span><br><span class="line">                            <span class="comment">// å°†å½“å‰èŠ‚ç‚¹çš„å“ˆå¸Œ ä¸ n</span></span><br><span class="line">                            <span class="type">int</span> <span class="variable">b</span> <span class="operator">=</span> p.hash &amp; n;</span><br><span class="line">                            <span class="comment">// å¦‚æœå½“å‰å€¼ä¸å‰é¢èŠ‚ç‚¹çš„å€¼ å¯¹åº”ä½ ä¸åŒï¼Œåˆ™ä¿®æ”¹ runBitï¼ŒæŠŠ lastRun æŒ‡å‘å½“å‰èŠ‚ç‚¹</span></span><br><span class="line">                            <span class="keyword">if</span> (b != runBit) &#123;</span><br><span class="line">                                runBit = b;</span><br><span class="line">                                lastRun = p;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">// åˆ¤æ–­ç­›é€‰å‡ºçš„é“¾è¡¨æ˜¯ä½ä½çš„è¿˜æ˜¯é«˜ä½çš„</span></span><br><span class="line">                        <span class="keyword">if</span> (runBit == <span class="number">0</span>) &#123;</span><br><span class="line">                            ln = lastRun;<span class="comment">// ln æŒ‡å‘è¯¥é“¾è¡¨</span></span><br><span class="line">                            hn = <span class="literal">null</span>;<span class="comment">// hn ä¸º null</span></span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">// è¯´æ˜ lastRun å¼•ç”¨çš„é“¾è¡¨ä¸ºé«˜ä½é“¾è¡¨ï¼Œå°±è®© hn æŒ‡å‘é«˜ä½é“¾è¡¨å¤´èŠ‚ç‚¹</span></span><br><span class="line">                        <span class="keyword">else</span> &#123;</span><br><span class="line">                            hn = lastRun;</span><br><span class="line">                            ln = <span class="literal">null</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">// ä»å¤´å¼€å§‹éå†æ‰€æœ‰çš„é“¾è¡¨èŠ‚ç‚¹ï¼Œè¿­ä»£åˆ° p == lastRun èŠ‚ç‚¹è·³å‡ºå¾ªç¯</span></span><br><span class="line">                        <span class="keyword">for</span> (Node&lt;K,V&gt; p = f; p != lastRun; p = p.next) &#123;</span><br><span class="line">                            <span class="type">int</span> <span class="variable">ph</span> <span class="operator">=</span> p.hash; <span class="type">K</span> <span class="variable">pk</span> <span class="operator">=</span> p.key; <span class="type">V</span> <span class="variable">pv</span> <span class="operator">=</span> p.val;</span><br><span class="line">                            <span class="keyword">if</span> ((ph &amp; n) == <span class="number">0</span>)</span><br><span class="line">                                <span class="comment">// ã€å¤´æ’æ³•ã€‘ï¼Œä»å³å¾€å·¦çœ‹ï¼Œé¦–å…ˆ ln æŒ‡å‘çš„æ˜¯ä¸Šä¸€ä¸ªèŠ‚ç‚¹ï¼Œ</span></span><br><span class="line">                                <span class="comment">// æ‰€ä»¥è¿™æ¬¡æ–°å»ºçš„èŠ‚ç‚¹çš„ next æŒ‡å‘ä¸Šä¸€ä¸ªèŠ‚ç‚¹ï¼Œç„¶åæ›´æ–° ln çš„å¼•ç”¨</span></span><br><span class="line">                                ln = <span class="keyword">new</span> <span class="title class_">Node</span>&lt;K,V&gt;(ph, pk, pv, ln);</span><br><span class="line">                            <span class="keyword">else</span></span><br><span class="line">                                hn = <span class="keyword">new</span> <span class="title class_">Node</span>&lt;K,V&gt;(ph, pk, pv, hn);</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">// é«˜ä½ä½é“¾è®¾ç½®åˆ°æ–°è¡¨ä¸­çš„æŒ‡å®šä½ç½®</span></span><br><span class="line">                        setTabAt(nextTab, i, ln);</span><br><span class="line">                        setTabAt(nextTab, i + n, hn);</span><br><span class="line">                        <span class="comment">// è€è¡¨ä¸­çš„è¯¥æ¡¶ä½è®¾ç½®ä¸º fwd èŠ‚ç‚¹</span></span><br><span class="line">                        setTabAt(tab, i, fwd);</span><br><span class="line">                        advance = <span class="literal">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// æ¡ä»¶æˆç«‹ï¼šè¡¨ç¤ºå½“å‰æ¡¶ä½æ˜¯ çº¢é»‘æ ‘ç»“ç‚¹</span></span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (f <span class="keyword">instanceof</span> TreeBin) &#123;</span><br><span class="line">                        TreeBin&lt;K,V&gt; t = (TreeBin&lt;K,V&gt;)f;</span><br><span class="line">                        TreeNode&lt;K,V&gt; lo = <span class="literal">null</span>, loTail = <span class="literal">null</span>;</span><br><span class="line">                        TreeNode&lt;K,V&gt; hi = <span class="literal">null</span>, hiTail = <span class="literal">null</span>;</span><br><span class="line">                        <span class="type">int</span> <span class="variable">lc</span> <span class="operator">=</span> <span class="number">0</span>, hc = <span class="number">0</span>;</span><br><span class="line">                        <span class="comment">// è¿­ä»£ TreeBin ä¸­çš„åŒå‘é“¾è¡¨ï¼Œä»å¤´ç»“ç‚¹è‡³å°¾èŠ‚ç‚¹</span></span><br><span class="line">                        <span class="keyword">for</span> (Node&lt;K,V&gt; e = t.first; e != <span class="literal">null</span>; e = e.next) &#123;</span><br><span class="line">                            <span class="comment">// è¿­ä»£çš„å½“å‰å…ƒç´ çš„ hash</span></span><br><span class="line">                            <span class="type">int</span> <span class="variable">h</span> <span class="operator">=</span> e.hash;</span><br><span class="line">                            TreeNode&lt;K,V&gt; p = <span class="keyword">new</span> <span class="title class_">TreeNode</span>&lt;K,V&gt;</span><br><span class="line">                                (h, e.key, e.val, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">                            <span class="comment">// æ¡ä»¶æˆç«‹è¡¨ç¤ºå½“å‰å¾ªç¯èŠ‚ç‚¹å±äºä½ä½é“¾èŠ‚ç‚¹</span></span><br><span class="line">                            <span class="keyword">if</span> ((h &amp; n) == <span class="number">0</span>) &#123;</span><br><span class="line">                                <span class="keyword">if</span> ((p.prev = loTail) == <span class="literal">null</span>)</span><br><span class="line">                                    lo = p;</span><br><span class="line">                                <span class="keyword">else</span></span><br><span class="line">                                    <span class="comment">//ã€å°¾æ’æ³•ã€‘</span></span><br><span class="line">                                    loTail.next = p;</span><br><span class="line">                                <span class="comment">// loTail æŒ‡å‘å°¾èŠ‚ç‚¹</span></span><br><span class="line">                                loTail = p;</span><br><span class="line">                                ++lc;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="keyword">else</span> &#123;</span><br><span class="line">                                <span class="keyword">if</span> ((p.prev = hiTail) == <span class="literal">null</span>)</span><br><span class="line">                                    hi = p;</span><br><span class="line">                                <span class="keyword">else</span></span><br><span class="line">                                    hiTail.next = p;</span><br><span class="line">                                hiTail = p;</span><br><span class="line">                                ++hc;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">// æ‹†æˆçš„é«˜ä½ä½ä½ä¸¤ä¸ªé“¾ï¼Œã€åˆ¤æ–­æ˜¯å¦éœ€è¦éœ€è¦è½¬åŒ–ä¸ºé“¾è¡¨ã€‘ï¼Œåä¹‹ä¿æŒæ ‘åŒ–</span></span><br><span class="line">                        ln = (lc &lt;= UNTREEIFY_THRESHOLD) ? untreeify(lo) :</span><br><span class="line">                        (hc != <span class="number">0</span>) ? <span class="keyword">new</span> <span class="title class_">TreeBin</span>&lt;K,V&gt;(lo) : t;</span><br><span class="line">                        hn = (hc &lt;= UNTREEIFY_THRESHOLD) ? untreeify(hi) :</span><br><span class="line">                        (lc != <span class="number">0</span>) ? <span class="keyword">new</span> <span class="title class_">TreeBin</span>&lt;K,V&gt;(hi) : t;</span><br><span class="line">                        setTabAt(nextTab, i, ln);</span><br><span class="line">                        setTabAt(nextTab, i + n, hn);</span><br><span class="line">                        setTabAt(tab, i, fwd);</span><br><span class="line">                        advance = <span class="literal">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é“¾è¡¨å¤„ç†çš„ LastRun æœºåˆ¶ï¼Œ<strong>å¯ä»¥å‡å°‘èŠ‚ç‚¹çš„åˆ›å»º</strong></p><p><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/JUC-ConcurrentHashMap-LastRun%E6%9C%BA%E5%88%B6.png"></p></li><li><p>helpTransfer()ï¼šå¸®åŠ©æ‰©å®¹æœºåˆ¶</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> Node&lt;K,V&gt;[] helpTransfer(Node&lt;K,V&gt;[] tab, Node&lt;K,V&gt; f) &#123;</span><br><span class="line">    Node&lt;K,V&gt;[] nextTab; <span class="type">int</span> sc;</span><br><span class="line">    <span class="comment">// æ•°ç»„ä¸ä¸ºç©ºï¼ŒèŠ‚ç‚¹æ˜¯è½¬å‘èŠ‚ç‚¹ï¼Œè·å–è½¬å‘èŠ‚ç‚¹æŒ‡å‘çš„æ–°è¡¨å¼€å§‹ååŠ©ä¸»çº¿ç¨‹æ‰©å®¹</span></span><br><span class="line">    <span class="keyword">if</span> (tab != <span class="literal">null</span> &amp;&amp; (f <span class="keyword">instanceof</span> ForwardingNode) &amp;&amp;</span><br><span class="line">        (nextTab = ((ForwardingNode&lt;K,V&gt;)f).nextTable) != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// æ‰©å®¹æ ‡è¯†æˆ³</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">rs</span> <span class="operator">=</span> resizeStamp(tab.length);</span><br><span class="line">        <span class="comment">// åˆ¤æ–­æ•°æ®è¿ç§»æ˜¯å¦å®Œæˆï¼Œè¿ç§»å®Œæˆä¼šæŠŠ æ–°è¡¨èµ‹å€¼ç»™ nextTable å±æ€§</span></span><br><span class="line">        <span class="keyword">while</span> (nextTab == nextTable &amp;&amp; table == tab &amp;&amp; (sc = sizeCtl) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((sc &gt;&gt;&gt; RESIZE_STAMP_SHIFT) != rs || sc == rs + <span class="number">1</span> ||</span><br><span class="line">                sc == rs + MAX_RESIZERS || transferIndex &lt;= <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="comment">// è®¾ç½®æ‰©å®¹çº¿ç¨‹æ•°é‡ + 1</span></span><br><span class="line">            <span class="keyword">if</span> (U.compareAndSwapInt(<span class="built_in">this</span>, SIZECTL, sc, sc + <span class="number">1</span>)) &#123;</span><br><span class="line">                <span class="comment">// ååŠ©æ‰©å®¹</span></span><br><span class="line">                transfer(tab, nextTab);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> nextTab;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> table;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><hr><h5 id="è·å–æ–¹æ³•"><a href="#è·å–æ–¹æ³•" class="headerlink" title="è·å–æ–¹æ³•"></a>è·å–æ–¹æ³•</h5><p>ConcurrentHashMap ä½¿ç”¨ get()  æ–¹æ³•è·å–æŒ‡å®š key çš„æ•°æ®</p><ul><li><p>get()ï¼šè·å–æŒ‡å®šæ•°æ®çš„æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> V <span class="title function_">get</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">    Node&lt;K,V&gt;[] tab; Node&lt;K,V&gt; e, p; <span class="type">int</span> n, eh; K ek;</span><br><span class="line">    <span class="comment">// æ‰°åŠ¨è¿ç®—ï¼Œè·å– key çš„å“ˆå¸Œå€¼</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">h</span> <span class="operator">=</span> spread(key.hashCode());</span><br><span class="line">    <span class="comment">// åˆ¤æ–­å½“å‰å“ˆå¸Œè¡¨çš„æ•°ç»„æ˜¯å¦åˆå§‹åŒ–</span></span><br><span class="line">    <span class="keyword">if</span> ((tab = table) != <span class="literal">null</span> &amp;&amp; (n = tab.length) &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">        <span class="comment">// å¦‚æœ table å·²ç»åˆå§‹åŒ–ï¼Œè¿›è¡Œã€å“ˆå¸Œå¯»å€ã€‘ï¼Œæ˜ å°„åˆ°æ•°ç»„å¯¹åº”ç´¢å¼•å¤„ï¼Œè·å–è¯¥ç´¢å¼•å¤„çš„å¤´èŠ‚ç‚¹</span></span><br><span class="line">        (e = tabAt(tab, (n - <span class="number">1</span>) &amp; h)) != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// å¯¹æ¯”å¤´ç»“ç‚¹ hash ä¸æŸ¥è¯¢ key çš„ hash æ˜¯å¦ä¸€è‡´</span></span><br><span class="line">        <span class="keyword">if</span> ((eh = e.hash) == h) &#123;</span><br><span class="line">            <span class="comment">// è¿›è¡Œå€¼çš„åˆ¤æ–­ï¼Œå¦‚æœæˆåŠŸå°±è¯´æ˜å½“å‰èŠ‚ç‚¹å°±æ˜¯è¦æŸ¥è¯¢çš„èŠ‚ç‚¹ï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">            <span class="keyword">if</span> ((ek = e.key) == key || (ek != <span class="literal">null</span> &amp;&amp; key.equals(ek)))</span><br><span class="line">                <span class="keyword">return</span> e.val;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å½“å‰æ§½ä½çš„ã€å“ˆå¸Œå€¼å°äº0ã€‘è¯´æ˜æ˜¯çº¢é»‘æ ‘èŠ‚ç‚¹æˆ–è€…æ˜¯æ­£åœ¨æ‰©å®¹çš„ fwd èŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (eh &lt; <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> (p = e.find(h, key)) != <span class="literal">null</span> ? p.val : <span class="literal">null</span>;</span><br><span class="line">        <span class="comment">// å½“å‰æ¡¶ä½æ˜¯ã€é“¾è¡¨ã€‘ï¼Œå¾ªç¯éå†æŸ¥æ‰¾</span></span><br><span class="line">        <span class="keyword">while</span> ((e = e.next) != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (e.hash == h &amp;&amp;</span><br><span class="line">                ((ek = e.key) == key || (ek != <span class="literal">null</span> &amp;&amp; key.equals(ek))))</span><br><span class="line">                <span class="keyword">return</span> e.val;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>ForwardingNode#findï¼šè½¬ç§»èŠ‚ç‚¹çš„æŸ¥æ‰¾æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">Node&lt;K,V&gt; <span class="title function_">find</span><span class="params">(<span class="type">int</span> h, Object k)</span> &#123;</span><br><span class="line">    <span class="comment">// è·å–æ–°è¡¨çš„å¼•ç”¨</span></span><br><span class="line">    outer: <span class="keyword">for</span> (Node&lt;K,V&gt;[] tab = nextTable;;)  &#123;</span><br><span class="line">        <span class="comment">// e è¡¨ç¤ºåœ¨æ‰©å®¹è€Œåˆ›å»ºæ–°è¡¨ä½¿ç”¨å¯»å€ç®—æ³•å¾—åˆ°çš„æ¡¶ä½å¤´ç»“ç‚¹ï¼Œn è¡¨ç¤ºä¸ºæ‰©å®¹è€Œåˆ›å»ºçš„æ–°è¡¨çš„é•¿åº¦</span></span><br><span class="line">        Node&lt;K,V&gt; e; <span class="type">int</span> n;</span><br><span class="line"> </span><br><span class="line">        <span class="keyword">if</span> (k == <span class="literal">null</span> || tab == <span class="literal">null</span> || (n = tab.length) == <span class="number">0</span> ||</span><br><span class="line">            <span class="comment">// åœ¨æ–°è¡¨ä¸­é‡æ–°å®šä½ hash å¯¹åº”çš„å¤´ç»“ç‚¹ï¼Œè¡¨ç¤ºåœ¨ oldTable ä¸­å¯¹åº”çš„æ¡¶ä½åœ¨è¿ç§»ä¹‹å‰å°±æ˜¯ null</span></span><br><span class="line">            (e = tabAt(tab, (n - <span class="number">1</span>) &amp; h)) == <span class="literal">null</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="type">int</span> eh; K ek;</span><br><span class="line">            <span class="comment">// ã€å“ˆå¸Œç›¸åŒå€¼ä¹Ÿç›¸åŒã€‘ï¼Œè¡¨ç¤ºæ–°è¡¨å½“å‰å‘½ä¸­æ¡¶ä½ä¸­çš„æ•°æ®ï¼Œå³ä¸ºæŸ¥è¯¢æƒ³è¦æ•°æ®</span></span><br><span class="line">            <span class="keyword">if</span> ((eh = e.hash) == h &amp;&amp; ((ek = e.key) == k || (ek != <span class="literal">null</span> &amp;&amp; k.equals(ek))))</span><br><span class="line">                <span class="keyword">return</span> e;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// eh &lt; 0 è¯´æ˜å½“å‰æ–°è¡¨ä¸­è¯¥ç´¢å¼•çš„å¤´èŠ‚ç‚¹æ˜¯ TreeBin ç±»å‹ï¼Œæˆ–è€…æ˜¯ FWD ç±»å‹</span></span><br><span class="line">            <span class="keyword">if</span> (eh &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// åœ¨å¹¶å‘å¾ˆå¤§çš„æƒ…å†µä¸‹æ–°æ‰©å®¹çš„è¡¨è¿˜æ²¡å®Œæˆå¯èƒ½ã€å†æ¬¡æ‰©å®¹ã€‘ï¼Œåœ¨æ­¤æ–¹æ³•å¤„å†æ¬¡æ‹¿åˆ° FWD ç±»å‹</span></span><br><span class="line">                <span class="keyword">if</span> (e <span class="keyword">instanceof</span> ForwardingNode) &#123;</span><br><span class="line">                    <span class="comment">// ç»§ç»­è·å–æ–°çš„ fwd æŒ‡å‘çš„æ–°æ•°ç»„çš„åœ°å€ï¼Œé€’å½’äº†</span></span><br><span class="line">                    tab = ((ForwardingNode&lt;K,V&gt;)e).nextTable;</span><br><span class="line">                    <span class="keyword">continue</span> outer;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    <span class="comment">// è¯´æ˜æ­¤æ¡¶ä½ä¸º TreeBin èŠ‚ç‚¹ï¼Œä½¿ç”¨TreeBin.find æŸ¥æ‰¾çº¢é»‘æ ‘ä¸­ç›¸åº”èŠ‚ç‚¹ã€‚</span></span><br><span class="line">                    <span class="keyword">return</span> e.find(h, k);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// é€»è¾‘åˆ°è¿™è¯´æ˜å½“å‰æ¡¶ä½æ˜¯é“¾è¡¨ï¼Œå°†å½“å‰å…ƒç´ æŒ‡å‘é“¾è¡¨çš„ä¸‹ä¸€ä¸ªå…ƒç´ ï¼Œåˆ¤æ–­å½“å‰å…ƒç´ çš„ä¸‹ä¸€ä¸ªä½ç½®æ˜¯å¦ä¸ºç©º</span></span><br><span class="line">            <span class="keyword">if</span> ((e = e.next) == <span class="literal">null</span>)</span><br><span class="line">                <span class="comment">// æ¡ä»¶æˆç«‹è¯´æ˜è¿­ä»£åˆ°é“¾è¡¨æœ«å°¾ï¼Œã€æœªæ‰¾åˆ°å¯¹åº”çš„æ•°æ®ï¼Œè¿”å› nullã€‘</span></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><hr><h5 id="åˆ é™¤æ–¹æ³•"><a href="#åˆ é™¤æ–¹æ³•" class="headerlink" title="åˆ é™¤æ–¹æ³•"></a>åˆ é™¤æ–¹æ³•</h5><ul><li><p>remove()ï¼šåˆ é™¤æŒ‡å®šå…ƒç´ </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> V <span class="title function_">remove</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> replaceNode(key, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>replaceNode()ï¼šæ›¿ä»£æŒ‡å®šçš„å…ƒç´ ï¼Œä¼šååŠ©æ‰©å®¹ï¼Œ<strong>å¢åˆ æ”¹ï¼ˆå†™ï¼‰éƒ½ä¼šååŠ©æ‰©å®¹ï¼ŒæŸ¥è¯¢ï¼ˆè¯»ï¼‰æ“ä½œä¸ä¼š</strong>ï¼Œå› ä¸ºè¯»æ“ä½œä¸æ¶‰åŠåŠ é”</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> V <span class="title function_">replaceNode</span><span class="params">(Object key, V value, Object cv)</span> &#123;</span><br><span class="line">    <span class="comment">// è®¡ç®— key æ‰°åŠ¨è¿ç®—åçš„ hash</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">hash</span> <span class="operator">=</span> spread(key.hashCode());</span><br><span class="line">    <span class="comment">// å¼€å§‹è‡ªæ—‹</span></span><br><span class="line">    <span class="keyword">for</span> (Node&lt;K,V&gt;[] tab = table;;) &#123;</span><br><span class="line">        Node&lt;K,V&gt; f; <span class="type">int</span> n, i, fh;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// ã€CASE1ã€‘ï¼štable è¿˜æœªåˆå§‹åŒ–æˆ–è€…å“ˆå¸Œå¯»å€çš„æ•°ç»„ç´¢å¼•å¤„ä¸º nullï¼Œç›´æ¥ç»“æŸè‡ªæ—‹ï¼Œè¿”å› null</span></span><br><span class="line">        <span class="keyword">if</span> (tab == <span class="literal">null</span> || (n = tab.length) == <span class="number">0</span> || (f = tabAt(tab, i = (n - <span class="number">1</span>) &amp; hash)) == <span class="literal">null</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">// ã€CASE2ã€‘ï¼šæ¡ä»¶æˆç«‹è¯´æ˜å½“å‰ table æ­£åœ¨æ‰©å®¹ï¼Œã€å½“å‰æ˜¯ä¸ªå†™æ“ä½œï¼Œæ‰€ä»¥å½“å‰çº¿ç¨‹éœ€è¦ååŠ© table å®Œæˆæ‰©å®¹ã€‘</span></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> ((fh = f.hash) == MOVED)</span><br><span class="line">            tab = helpTransfer(tab, f);</span><br><span class="line">        <span class="comment">// ã€CASE3ã€‘ï¼šå½“å‰æ¡¶ä½å¯èƒ½æ˜¯ é“¾è¡¨ ä¹Ÿå¯èƒ½æ˜¯ çº¢é»‘æ ‘ </span></span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// ä¿ç•™æ›¿æ¢ä¹‹å‰æ•°æ®å¼•ç”¨</span></span><br><span class="line">            <span class="type">V</span> <span class="variable">oldVal</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">            <span class="comment">// æ ¡éªŒæ ‡è®°</span></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">validated</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">            <span class="comment">// ã€åŠ é”å½“å‰æ¡¶ä½å¤´ç»“ç‚¹ã€‘ï¼ŒåŠ é”æˆåŠŸä¹‹åä¼šè¿›å…¥ä»£ç å—</span></span><br><span class="line">            <span class="keyword">synchronized</span> (f) &#123;</span><br><span class="line">                <span class="comment">// åŒé‡æ£€æŸ¥</span></span><br><span class="line">                <span class="keyword">if</span> (tabAt(tab, i) == f) &#123;</span><br><span class="line">                    <span class="comment">// è¯´æ˜å½“å‰èŠ‚ç‚¹æ˜¯é“¾è¡¨èŠ‚ç‚¹</span></span><br><span class="line">                    <span class="keyword">if</span> (fh &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                        validated = <span class="literal">true</span>;</span><br><span class="line">                        <span class="comment">//éå†æ‰€æœ‰çš„èŠ‚ç‚¹</span></span><br><span class="line">                        <span class="keyword">for</span> (Node&lt;K,V&gt; e = f, pred = <span class="literal">null</span>;;) &#123;</span><br><span class="line">                            K ek;</span><br><span class="line">                            <span class="comment">// hash å’Œå€¼éƒ½ç›¸åŒï¼Œå®šä½åˆ°äº†å…·ä½“çš„èŠ‚ç‚¹</span></span><br><span class="line">                            <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">                                ((ek = e.key) == key ||</span><br><span class="line">                                 (ek != <span class="literal">null</span> &amp;&amp; key.equals(ek)))) &#123;</span><br><span class="line">                                <span class="comment">// å½“å‰èŠ‚ç‚¹çš„value</span></span><br><span class="line">                                <span class="type">V</span> <span class="variable">ev</span> <span class="operator">=</span> e.val;</span><br><span class="line">                                <span class="keyword">if</span> (cv == <span class="literal">null</span> || cv == ev ||</span><br><span class="line">                                    (ev != <span class="literal">null</span> &amp;&amp; cv.equals(ev))) &#123;</span><br><span class="line">                                    <span class="comment">// å°†å½“å‰èŠ‚ç‚¹çš„å€¼ èµ‹å€¼ç»™ oldVal åç»­è¿”å›ä¼šç”¨åˆ°</span></span><br><span class="line">                                    oldVal = ev;</span><br><span class="line">                                    <span class="keyword">if</span> (value != <span class="literal">null</span>)<span class="comment">// æ¡ä»¶æˆç«‹è¯´æ˜æ˜¯æ›¿æ¢æ“ä½œ</span></span><br><span class="line">                                        e.val = value;</span><br><span class="line">                                    <span class="keyword">else</span> <span class="keyword">if</span> (pred != <span class="literal">null</span>)<span class="comment">// éå¤´èŠ‚ç‚¹åˆ é™¤æ“ä½œï¼Œæ–­å¼€é“¾è¡¨</span></span><br><span class="line">                                        pred.next = e.next;</span><br><span class="line">                                    <span class="keyword">else</span></span><br><span class="line">                                        <span class="comment">// è¯´æ˜å½“å‰èŠ‚ç‚¹å³ä¸ºå¤´ç»“ç‚¹ï¼Œå°†æ¡¶ä½å¤´èŠ‚ç‚¹è®¾ç½®ä¸ºä»¥å‰å¤´èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">                                        setTabAt(tab, i, e.next);</span><br><span class="line">                                &#125;</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                            pred = e;</span><br><span class="line">                            <span class="keyword">if</span> ((e = e.next) == <span class="literal">null</span>)</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// è¯´æ˜æ˜¯çº¢é»‘æ ‘èŠ‚ç‚¹</span></span><br><span class="line">                    <span class="keyword">else</span> <span class="keyword">if</span> (f <span class="keyword">instanceof</span> TreeBin) &#123;</span><br><span class="line">                        validated = <span class="literal">true</span>;</span><br><span class="line">                        TreeBin&lt;K,V&gt; t = (TreeBin&lt;K,V&gt;)f;</span><br><span class="line">                        TreeNode&lt;K,V&gt; r, p;</span><br><span class="line">                        <span class="keyword">if</span> ((r = t.root) != <span class="literal">null</span> &amp;&amp;</span><br><span class="line">                            (p = r.findTreeNode(hash, key, <span class="literal">null</span>)) != <span class="literal">null</span>) &#123;</span><br><span class="line">                            <span class="type">V</span> <span class="variable">pv</span> <span class="operator">=</span> p.val;</span><br><span class="line">                            <span class="keyword">if</span> (cv == <span class="literal">null</span> || cv == pv ||</span><br><span class="line">                                (pv != <span class="literal">null</span> &amp;&amp; cv.equals(pv))) &#123;</span><br><span class="line">                                oldVal = pv;</span><br><span class="line">                                <span class="comment">// æ¡ä»¶æˆç«‹è¯´æ˜æ›¿æ¢æ“ä½œ</span></span><br><span class="line">                                <span class="keyword">if</span> (value != <span class="literal">null</span>)</span><br><span class="line">                                    p.val = value;</span><br><span class="line">                                <span class="comment">// åˆ é™¤æ“ä½œ</span></span><br><span class="line">                                <span class="keyword">else</span> <span class="keyword">if</span> (t.removeTreeNode(p))</span><br><span class="line">                                    setTabAt(tab, i, untreeify(t.first));</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å…¶ä»–çº¿ç¨‹ä¿®æ”¹è¿‡æ¡¶ä½å¤´ç»“ç‚¹æ—¶ï¼Œå½“å‰çº¿ç¨‹ sync å¤´ç»“ç‚¹é”é”™å¯¹è±¡ï¼Œvalidated ä¸º falseï¼Œä¼šè¿›å…¥ä¸‹æ¬¡ for è‡ªæ—‹</span></span><br><span class="line">            <span class="keyword">if</span> (validated) &#123;</span><br><span class="line">                <span class="keyword">if</span> (oldVal != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// æ›¿æ¢çš„å€¼ä¸º nullï¼Œã€è¯´æ˜å½“å‰æ˜¯ä¸€æ¬¡åˆ é™¤æ“ä½œï¼Œæ›´æ–°å½“å‰å…ƒç´ ä¸ªæ•°è®¡æ•°å™¨ã€‘</span></span><br><span class="line">                    <span class="keyword">if</span> (value == <span class="literal">null</span>)</span><br><span class="line">                        addCount(-<span class="number">1L</span>, -<span class="number">1</span>);</span><br><span class="line">                    <span class="keyword">return</span> oldVal;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p>å‚è€ƒè§†é¢‘ï¼š<a href="https://space.bilibili.com/457326371/">https://space.bilibili.com/457326371/</a></p><hr><h4 id="JDK7åŸç†"><a href="#JDK7åŸç†" class="headerlink" title="JDK7åŸç†"></a>JDK7åŸç†</h4><p>ConcurrentHashMap å¯¹é”ç²’åº¦è¿›è¡Œäº†ä¼˜åŒ–ï¼Œ<strong>åˆ†æ®µé”æŠ€æœ¯</strong>ï¼Œå°†æ•´å¼ è¡¨åˆ†æˆäº†å¤šä¸ªæ•°ç»„ï¼ˆSegmentï¼‰ï¼Œæ¯ä¸ªæ•°ç»„åˆæ˜¯ä¸€ä¸ªç±»ä¼¼ HashMap æ•°ç»„çš„ç»“æ„ã€‚å…è®¸å¤šä¸ªä¿®æ”¹æ“ä½œå¹¶å‘è¿›è¡Œï¼ŒSegment æ˜¯ä¸€ç§å¯é‡å…¥é”ï¼Œç»§æ‰¿ ReentrantLockï¼Œå¹¶å‘æ—¶é”ä½çš„æ˜¯æ¯ä¸ª Segmentï¼Œå…¶ä»– Segment è¿˜æ˜¯å¯ä»¥æ“ä½œçš„ï¼Œè¿™æ ·ä¸åŒ Segment ä¹‹é—´å°±å¯ä»¥å®ç°å¹¶å‘ï¼Œå¤§å¤§æé«˜æ•ˆç‡ã€‚</p><p>åº•å±‚ç»“æ„ï¼š <strong>Segment æ•°ç»„ + HashEntry æ•°ç»„ + é“¾è¡¨</strong>ï¼ˆæ•°ç»„ + é“¾è¡¨æ˜¯ HashMap çš„ç»“æ„ï¼‰</p><ul><li><p>ä¼˜ç‚¹ï¼šå¦‚æœå¤šä¸ªçº¿ç¨‹è®¿é—®ä¸åŒçš„ segmentï¼Œå®é™…æ˜¯æ²¡æœ‰å†²çªçš„ï¼Œè¿™ä¸ JDK8 ä¸­æ˜¯ç±»ä¼¼çš„</p></li><li><p>ç¼ºç‚¹ï¼šSegments æ•°ç»„é»˜è®¤å¤§å°ä¸º16ï¼Œè¿™ä¸ªå®¹é‡åˆå§‹åŒ–æŒ‡å®šåå°±ä¸èƒ½æ”¹å˜äº†ï¼Œå¹¶ä¸”ä¸æ˜¯æ‡’æƒ°åˆå§‹åŒ–</p><p>![](<a href="https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/JUC-ConcurrentHashMap">https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/JUC-ConcurrentHashMap</a> 1.7åº•å±‚ç»“æ„.png)</p></li></ul><hr><h3 id="CopyOnWrite"><a href="#CopyOnWrite" class="headerlink" title="CopyOnWrite"></a>CopyOnWrite</h3><h4 id="åŸç†åˆ†æ-1"><a href="#åŸç†åˆ†æ-1" class="headerlink" title="åŸç†åˆ†æ"></a>åŸç†åˆ†æ</h4><p>CopyOnWriteArrayList é‡‡ç”¨äº†<strong>å†™å…¥æ—¶æ‹·è´</strong>çš„æ€æƒ³ï¼Œå¢åˆ æ”¹æ“ä½œä¼šå°†åº•å±‚æ•°ç»„æ‹·è´ä¸€ä»½ï¼Œåœ¨æ–°æ•°ç»„ä¸Šæ‰§è¡Œæ“ä½œï¼Œä¸å½±å“å…¶å®ƒçº¿ç¨‹çš„<strong>å¹¶å‘è¯»ï¼Œè¯»å†™åˆ†ç¦»</strong></p><p>CopyOnWriteArraySet åº•å±‚å¯¹ CopyOnWriteArrayList è¿›è¡Œäº†åŒ…è£…ï¼Œè£…é¥°å™¨æ¨¡å¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">CopyOnWriteArraySet</span><span class="params">()</span> &#123;</span><br><span class="line">    al = <span class="keyword">new</span> <span class="title class_">CopyOnWriteArrayList</span>&lt;E&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p>å­˜å‚¨ç»“æ„ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> Object[] array;<span class="comment">// volatile ä¿è¯äº†è¯»å†™çº¿ç¨‹ä¹‹é—´çš„å¯è§æ€§</span></span><br></pre></td></tr></table></figure></li><li><p>å…¨å±€é”ï¼šä¿è¯çº¿ç¨‹çš„æ‰§è¡Œå®‰å…¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">transient</span> <span class="type">ReentrantLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br></pre></td></tr></table></figure></li><li><p>æ–°å¢æ•°æ®ï¼šéœ€è¦åŠ é”ï¼Œ<strong>åˆ›å»ºæ–°çš„æ•°ç»„æ“ä½œ</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">add</span><span class="params">(E e)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">ReentrantLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="built_in">this</span>.lock;</span><br><span class="line">    <span class="comment">// åŠ é”ï¼Œä¿è¯çº¿ç¨‹å®‰å…¨</span></span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// è·å–æ—§çš„æ•°ç»„</span></span><br><span class="line">        Object[] elements = getArray();</span><br><span class="line">        <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> elements.length;</span><br><span class="line">        <span class="comment">// ã€æ‹·è´æ–°çš„æ•°ç»„ï¼ˆè¿™é‡Œæ˜¯æ¯”è¾ƒè€—æ—¶çš„æ“ä½œï¼Œä½†ä¸å½±å“å…¶å®ƒè¯»çº¿ç¨‹ï¼‰ã€‘</span></span><br><span class="line">        Object[] newElements = Arrays.copyOf(elements, len + <span class="number">1</span>);</span><br><span class="line">        <span class="comment">// æ·»åŠ æ–°å…ƒç´ </span></span><br><span class="line">        newElements[len] = e;</span><br><span class="line">        <span class="comment">// æ›¿æ¢æ—§çš„æ•°ç»„ï¼Œã€è¿™ä¸ªæ“ä½œä»¥åï¼Œå…¶ä»–çº¿ç¨‹è·å–æ•°ç»„å°±æ˜¯è·å–çš„æ–°æ•°ç»„äº†ã€‘</span></span><br><span class="line">        setArray(newElements);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>è¯»æ“ä½œï¼šä¸åŠ é”ï¼Œ<strong>åœ¨åŸæ•°ç»„ä¸Šæ“ä½œ</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> E <span class="title function_">get</span><span class="params">(<span class="type">int</span> index)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> get(getArray(), index);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> E <span class="title function_">get</span><span class="params">(Object[] a, <span class="type">int</span> index)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (E) a[index];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€‚åˆè¯»å¤šå†™å°‘çš„åº”ç”¨åœºæ™¯</p></li><li><p>è¿­ä»£å™¨ï¼šCopyOnWriteArrayList åœ¨è¿”å›è¿­ä»£å™¨æ—¶ï¼Œ<strong>åˆ›å»ºä¸€ä¸ªå†…éƒ¨æ•°ç»„å½“å‰çš„å¿«ç…§ï¼ˆå¼•ç”¨ï¼‰</strong>ï¼Œå³ä½¿å…¶ä»–çº¿ç¨‹æ›¿æ¢äº†åŸå§‹æ•°ç»„ï¼Œè¿­ä»£å™¨éå†çš„å¿«ç…§ä¾ç„¶å¼•ç”¨çš„æ˜¯åˆ›å»ºå¿«ç…§æ—¶çš„æ•°ç»„ï¼Œæ‰€ä»¥è¿™ç§å®ç°æ–¹å¼ä¹Ÿå­˜åœ¨ä¸€å®šçš„æ•°æ®å»¶è¿Ÿæ€§ï¼Œå¯¹å…¶ä»–çº¿ç¨‹å¹¶è¡Œæ·»åŠ çš„æ•°æ®ä¸å¯è§</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Iterator&lt;E&gt; <span class="title function_">iterator</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// è·å–åˆ°æ•°ç»„å¼•ç”¨ï¼Œæ•´ä¸ªéå†çš„è¿‡ç¨‹è¯¥æ•°ç»„éƒ½ä¸ä¼šå˜ï¼Œä¸€ç›´å¼•ç”¨çš„éƒ½æ˜¯è€æ•°ç»„ï¼Œ</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">COWIterator</span>&lt;E&gt;(getArray(), <span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¿­ä»£å™¨ä¼šåˆ›å»ºä¸€ä¸ªåº•å±‚arrayçš„å¿«ç…§ï¼Œæ•…ä¸»ç±»çš„ä¿®æ”¹ä¸å½±å“è¯¥å¿«ç…§</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">COWIterator</span>&lt;E&gt; <span class="keyword">implements</span> <span class="title class_">ListIterator</span>&lt;E&gt; &#123;</span><br><span class="line">    <span class="comment">// å†…éƒ¨æ•°ç»„å¿«ç…§</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object[] snapshot;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">COWIterator</span><span class="params">(Object[] elements, <span class="type">int</span> initialCursor)</span> &#123;</span><br><span class="line">        cursor = initialCursor;</span><br><span class="line">        <span class="comment">// æ•°ç»„çš„å¼•ç”¨åœ¨è¿­ä»£è¿‡ç¨‹ä¸ä¼šæ”¹å˜</span></span><br><span class="line">        snapshot = elements;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ã€ä¸æ”¯æŒå†™æ“ä½œã€‘ï¼Œå› ä¸ºæ˜¯åœ¨å¿«ç…§ä¸Šæ“ä½œï¼Œæ— æ³•åŒæ­¥å›å»</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">remove</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnsupportedOperationException</span>();</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><hr><h4 id="å¼±ä¸€è‡´æ€§"><a href="#å¼±ä¸€è‡´æ€§" class="headerlink" title="å¼±ä¸€è‡´æ€§"></a>å¼±ä¸€è‡´æ€§</h4><p>æ•°æ®ä¸€è‡´æ€§å°±æ˜¯è¯»åˆ°æœ€æ–°æ›´æ–°çš„æ•°æ®ï¼š</p><ul><li><p>å¼ºä¸€è‡´æ€§ï¼šå½“æ›´æ–°æ“ä½œå®Œæˆä¹‹åï¼Œä»»ä½•å¤šä¸ªåç»­è¿›ç¨‹æˆ–è€…çº¿ç¨‹çš„è®¿é—®éƒ½ä¼šè¿”å›æœ€æ–°çš„æ›´æ–°è¿‡çš„å€¼</p></li><li><p>å¼±ä¸€è‡´æ€§ï¼šç³»ç»Ÿå¹¶ä¸ä¿è¯è¿›ç¨‹æˆ–è€…çº¿ç¨‹çš„è®¿é—®éƒ½ä¼šè¿”å›æœ€æ–°çš„æ›´æ–°è¿‡çš„å€¼ï¼Œä¹Ÿä¸ä¼šæ‰¿è¯ºå¤šä¹…ä¹‹åå¯ä»¥è¯»åˆ°</p></li></ul><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/JUC-CopyOnWriteArrayListå¼±ä¸€è‡´æ€§.png" style="zoom:80%;" /><table><thead><tr><th>æ—¶é—´ç‚¹</th><th>æ“ä½œ</th></tr></thead><tbody><tr><td>1</td><td>Thread-0 getArray()</td></tr><tr><td>2</td><td>Thread-1 getArray()</td></tr><tr><td>3</td><td>Thread-1 setArray(arrayCopy)</td></tr><tr><td>4</td><td>Thread-0 array[index]</td></tr></tbody></table><p>Thread-0 è¯»åˆ°äº†è„æ•°æ®</p><p>ä¸ä¸€å®šå¼±ä¸€è‡´æ€§å°±ä¸å¥½</p><ul><li>æ•°æ®åº“çš„<strong>äº‹åŠ¡éš”ç¦»çº§åˆ«</strong>å°±æ˜¯å¼±ä¸€è‡´æ€§çš„è¡¨ç°</li><li>å¹¶å‘é«˜å’Œä¸€è‡´æ€§æ˜¯çŸ›ç›¾çš„ï¼Œéœ€è¦æƒè¡¡</li></ul><hr><h4 id="å®‰å…¨å¤±è´¥"><a href="#å®‰å…¨å¤±è´¥" class="headerlink" title="å®‰å…¨å¤±è´¥"></a>å®‰å…¨å¤±è´¥</h4><p>åœ¨ java.util åŒ…çš„é›†åˆç±»å°±éƒ½æ˜¯å¿«é€Ÿå¤±è´¥çš„ï¼Œè€Œ java.util.concurrent åŒ…ä¸‹çš„ç±»éƒ½æ˜¯å®‰å…¨å¤±è´¥</p><ul><li><p>å¿«é€Ÿå¤±è´¥ï¼šåœ¨ A çº¿ç¨‹ä½¿ç”¨<strong>è¿­ä»£å™¨</strong>å¯¹é›†åˆè¿›è¡Œéå†çš„è¿‡ç¨‹ä¸­ï¼Œæ­¤æ—¶ B çº¿ç¨‹å¯¹é›†åˆè¿›è¡Œä¿®æ”¹ï¼ˆå¢åˆ æ”¹ï¼‰ï¼Œæˆ–è€… A çº¿ç¨‹åœ¨éå†è¿‡ç¨‹ä¸­å¯¹é›†åˆè¿›è¡Œä¿®æ”¹ï¼Œéƒ½ä¼šå¯¼è‡´ A çº¿ç¨‹æŠ›å‡º ConcurrentModificationException å¼‚å¸¸</p><ul><li>AbstractList ç±»ä¸­çš„æˆå‘˜å˜é‡ modCountï¼Œç”¨æ¥è®°å½• List ç»“æ„å‘ç”Ÿå˜åŒ–çš„æ¬¡æ•°ï¼Œ<strong>ç»“æ„å‘ç”Ÿå˜åŒ–</strong>æ˜¯æŒ‡æ·»åŠ æˆ–è€…åˆ é™¤è‡³å°‘ä¸€ä¸ªå…ƒç´ çš„æ“ä½œï¼Œæˆ–è€…æ˜¯è°ƒæ•´å†…éƒ¨æ•°ç»„çš„å¤§å°ï¼Œä»…ä»…è®¾ç½®å…ƒç´ çš„å€¼ä¸ç®—ç»“æ„å‘ç”Ÿå˜åŒ–</li><li>åœ¨è¿›è¡Œåºåˆ—åŒ–æˆ–è€…è¿­ä»£ç­‰æ“ä½œæ—¶ï¼Œéœ€è¦æ¯”è¾ƒæ“ä½œå‰å modCount æ˜¯å¦æ”¹å˜ï¼Œå¦‚æœæ”¹å˜äº†æŠ›å‡º CME å¼‚å¸¸</li></ul></li><li><p>å®‰å…¨å¤±è´¥ï¼šé‡‡ç”¨å®‰å…¨å¤±è´¥æœºåˆ¶çš„é›†åˆå®¹å™¨ï¼Œåœ¨<strong>è¿­ä»£å™¨</strong>éå†æ—¶ç›´æ¥åœ¨åŸé›†åˆæ•°ç»„å†…å®¹ä¸Šè®¿é—®ï¼Œä½†å…¶ä»–çº¿ç¨‹çš„å¢åˆ æ”¹éƒ½ä¼šæ–°å»ºæ•°ç»„è¿›è¡Œä¿®æ”¹ï¼Œå°±ç®—ä¿®æ”¹äº†é›†åˆåº•å±‚çš„æ•°ç»„å®¹å™¨ï¼Œè¿­ä»£å™¨ä¾ç„¶å¼•ç”¨ç€ä»¥å‰çš„æ•°ç»„ï¼ˆ<strong>å¿«ç…§æ€æƒ³</strong>ï¼‰ï¼Œæ‰€ä»¥ä¸ä¼šå‡ºç°å¼‚å¸¸</p><p>ConcurrentHashMap ä¸ä¼šå‡ºç°å¹¶å‘æ—¶çš„è¿­ä»£å¼‚å¸¸ï¼Œå› ä¸ºåœ¨è¿­ä»£è¿‡ç¨‹ä¸­ CHM çš„è¿­ä»£å™¨å¹¶æ²¡æœ‰åˆ¤æ–­ç»“æ„çš„å˜åŒ–ï¼Œè¿­ä»£å™¨è¿˜å¯ä»¥æ ¹æ®è¿­ä»£çš„èŠ‚ç‚¹çŠ¶æ€å»å¯»æ‰¾å¹¶å‘æ‰©å®¹æ—¶çš„æ–°è¡¨è¿›è¡Œè¿­ä»£</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ConcurrentHashMap</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>();</span><br><span class="line"><span class="comment">// KeyIterator</span></span><br><span class="line"><span class="type">Iterator</span> <span class="variable">iterator</span> <span class="operator">=</span> map.keySet().iterator();</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Traverser(Node&lt;K,V&gt;[] tab, <span class="type">int</span> size, <span class="type">int</span> index, <span class="type">int</span> limit) &#123;</span><br><span class="line">    <span class="comment">// å¼•ç”¨è¿˜æ˜¯åŸæ¥é›†åˆçš„ Node æ•°ç»„ï¼Œæ‰€ä»¥å…¶ä»–çº¿ç¨‹å¯¹æ•°æ®çš„ä¿®æ”¹æ˜¯å¯è§çš„</span></span><br><span class="line">    <span class="built_in">this</span>.tab = tab;</span><br><span class="line">    <span class="built_in">this</span>.baseSize = size;</span><br><span class="line">    <span class="built_in">this</span>.baseIndex = <span class="built_in">this</span>.index = index;</span><br><span class="line">    <span class="built_in">this</span>.baseLimit = limit;</span><br><span class="line">    <span class="built_in">this</span>.next = <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">hasNext</span><span class="params">()</span> &#123; <span class="keyword">return</span> next != <span class="literal">null</span>; &#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> K <span class="title function_">next</span><span class="params">()</span> &#123;</span><br><span class="line">    Node&lt;K,V&gt; p;</span><br><span class="line">    <span class="keyword">if</span> ((p = next) == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NoSuchElementException</span>();</span><br><span class="line">    <span class="type">K</span> <span class="variable">k</span> <span class="operator">=</span> p.key;</span><br><span class="line">    lastReturned = p;</span><br><span class="line">    <span class="comment">// åœ¨æ–¹æ³•ä¸­è¿›è¡Œä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„è·å–ï¼Œä¼šè¿›è¡Œæ§½ä½å¤´èŠ‚ç‚¹çš„çŠ¶æ€åˆ¤æ–­</span></span><br><span class="line">    advance();</span><br><span class="line">    <span class="keyword">return</span> k;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><hr><h3 id="Collections"><a href="#Collections" class="headerlink" title="Collections"></a>Collections</h3><p>Collectionsç±»æ˜¯ç”¨æ¥æ“ä½œé›†åˆçš„å·¥å…·ç±»ï¼Œæä¾›äº†é›†åˆè½¬æ¢æˆçº¿ç¨‹å®‰å…¨çš„æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; Collection&lt;T&gt; <span class="title function_">synchronizedCollection</span><span class="params">(Collection&lt;T&gt; c)</span> &#123;</span><br><span class="line">     <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SynchronizedCollection</span>&lt;&gt;(c);</span><br><span class="line"> &#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;K,V&gt; Map&lt;K,V&gt; <span class="title function_">synchronizedMap</span><span class="params">(Map&lt;K,V&gt; m)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SynchronizedMap</span>&lt;&gt;(m);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æºç ï¼šåº•å±‚ä¹Ÿæ˜¯å¯¹æ–¹æ³•è¿›è¡ŒåŠ é”</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">add</span><span class="params">(E e)</span> &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (mutex) &#123;<span class="keyword">return</span> c.add(e);&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h3 id="SkipListMap"><a href="#SkipListMap" class="headerlink" title="SkipListMap"></a>SkipListMap</h3><h4 id="åº•å±‚ç»“æ„-1"><a href="#åº•å±‚ç»“æ„-1" class="headerlink" title="åº•å±‚ç»“æ„"></a>åº•å±‚ç»“æ„</h4><p>è·³è¡¨ SkipList æ˜¯ä¸€ä¸ª<strong>æœ‰åºçš„é“¾è¡¨</strong>ï¼Œé»˜è®¤å‡åºï¼Œåº•å±‚æ˜¯é“¾è¡¨åŠ å¤šçº§ç´¢å¼•çš„ç»“æ„ã€‚è·³è¡¨å¯ä»¥å¯¹å…ƒç´ è¿›è¡Œå¿«é€ŸæŸ¥è¯¢ï¼Œç±»ä¼¼äºå¹³è¡¡æ ‘ï¼Œæ˜¯ä¸€ç§åˆ©ç”¨ç©ºé—´æ¢æ—¶é—´çš„ç®—æ³•</p><p>å¯¹äºå•é“¾è¡¨ï¼Œå³ä½¿é“¾è¡¨æ˜¯æœ‰åºçš„ï¼Œå¦‚æœæŸ¥æ‰¾æ•°æ®ä¹Ÿåªèƒ½ä»å¤´åˆ°å°¾éå†é“¾è¡¨ï¼Œæ‰€ä»¥é‡‡ç”¨é“¾è¡¨ä¸Šå»ºç´¢å¼•çš„æ–¹å¼æé«˜æ•ˆç‡ï¼Œè·³è¡¨çš„æŸ¥è¯¢æ—¶é—´å¤æ‚åº¦æ˜¯ **O(logn)**ï¼Œç©ºé—´å¤æ‚åº¦ O(n)</p><p>ConcurrentSkipListMap æä¾›äº†ä¸€ç§çº¿ç¨‹å®‰å…¨çš„å¹¶å‘è®¿é—®çš„æ’åºæ˜ å°„è¡¨ï¼Œå†…éƒ¨æ˜¯è·³è¡¨ç»“æ„å®ç°ï¼Œé€šè¿‡ CAS + volatile ä¿è¯çº¿ç¨‹å®‰å…¨</p><p>å¹³è¡¡æ ‘å’Œè·³è¡¨çš„åŒºåˆ«ï¼š</p><ul><li>å¯¹å¹³è¡¡æ ‘çš„æ’å…¥å’Œåˆ é™¤å¾€å¾€å¾ˆå¯èƒ½å¯¼è‡´å¹³è¡¡æ ‘è¿›è¡Œä¸€æ¬¡å…¨å±€çš„è°ƒæ•´ï¼›è€Œå¯¹è·³è¡¨çš„æ’å…¥å’Œåˆ é™¤ï¼Œ<strong>åªéœ€è¦å¯¹æ•´ä¸ªç»“æ„çš„å±€éƒ¨è¿›è¡Œæ“ä½œ</strong></li><li>åœ¨é«˜å¹¶å‘çš„æƒ…å†µä¸‹ï¼Œä¿è¯æ•´ä¸ªå¹³è¡¡æ ‘çš„çº¿ç¨‹å®‰å…¨éœ€è¦ä¸€ä¸ªå…¨å±€é”ï¼›å¯¹äºè·³è¡¨åˆ™åªéœ€è¦éƒ¨åˆ†é”ï¼Œæ‹¥æœ‰æ›´å¥½çš„æ€§èƒ½</li></ul><p><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/JUC-ConcurrentSkipListMap%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84.png"></p><p>BaseHeader å­˜å‚¨æ•°æ®ï¼ŒheadIndex å­˜å‚¨ç´¢å¼•ï¼Œçºµå‘ä¸Š<strong>æ‰€æœ‰ç´¢å¼•éƒ½æŒ‡å‘é“¾è¡¨æœ€ä¸‹é¢çš„èŠ‚ç‚¹</strong></p><hr><h4 id="æˆå‘˜å˜é‡-2"><a href="#æˆå‘˜å˜é‡-2" class="headerlink" title="æˆå‘˜å˜é‡"></a>æˆå‘˜å˜é‡</h4><ul><li><p>æ ‡è¯†ç´¢å¼•å¤´èŠ‚ç‚¹ä½ç½®</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Object</span> <span class="variable">BASE_HEADER</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Object</span>();</span><br></pre></td></tr></table></figure></li><li><p>è·³è¡¨çš„é¡¶å±‚ç´¢å¼•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> HeadIndex&lt;K,V&gt; head;</span><br></pre></td></tr></table></figure></li><li><p>æ¯”è¾ƒå™¨ï¼Œä¸º null åˆ™ä½¿ç”¨è‡ªç„¶æ’åº</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> Comparator&lt;? <span class="built_in">super</span> K&gt; comparator;</span><br></pre></td></tr></table></figure></li><li><p>Node èŠ‚ç‚¹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Node</span>&lt;K, V&gt;&#123;</span><br><span class="line">    <span class="keyword">final</span> K key;  <span class="comment">// key æ˜¯ final çš„, è¯´æ˜èŠ‚ç‚¹ä¸€æ—¦å®šä¸‹æ¥, é™¤äº†åˆ é™¤, ä¸€èˆ¬ä¸ä¼šæ”¹åŠ¨ key</span></span><br><span class="line">    <span class="keyword">volatile</span> Object value; <span class="comment">// å¯¹åº”çš„ value</span></span><br><span class="line">    <span class="keyword">volatile</span> Node&lt;K, V&gt; next; <span class="comment">// ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå•å‘é“¾è¡¨</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>ç´¢å¼•èŠ‚ç‚¹ Indexï¼Œåªæœ‰å‘ä¸‹å’Œå‘å³çš„æŒ‡é’ˆ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Index</span>&lt;K, V&gt;&#123;</span><br><span class="line">    <span class="keyword">final</span> Node&lt;K, V&gt; node; <span class="comment">// ç´¢å¼•æŒ‡å‘çš„èŠ‚ç‚¹ï¼Œæ¯ä¸ªéƒ½ä¼šæŒ‡å‘æ•°æ®èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">final</span> Index&lt;K, V&gt; down; <span class="comment">// ä¸‹è¾¹levelå±‚çš„Indexï¼Œåˆ†å±‚ç´¢å¼•</span></span><br><span class="line">    <span class="keyword">volatile</span> Index&lt;K, V&gt; right; <span class="comment">// å³è¾¹çš„Indexï¼Œå•å‘</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// åœ¨ index æœ¬èº«å’Œ succ ä¹‹é—´æ’å…¥ä¸€ä¸ªæ–°çš„èŠ‚ç‚¹ newSucc</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">link</span><span class="params">(Index&lt;K, V&gt; succ, Index&lt;K, V&gt; newSucc)</span>&#123;</span><br><span class="line">        Node&lt;K, V&gt; n = node;</span><br><span class="line">        newSucc.right = succ;</span><br><span class="line">        <span class="comment">// æŠŠå½“å‰èŠ‚ç‚¹çš„å³æŒ‡é’ˆä» succ æ”¹ä¸º newSucc</span></span><br><span class="line">        <span class="keyword">return</span> n.value != <span class="literal">null</span> &amp;&amp; casRight(succ, newSucc);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ–­å¼€å½“å‰èŠ‚ç‚¹å’Œ succ èŠ‚ç‚¹ï¼Œå°†å½“å‰çš„èŠ‚ç‚¹ index è®¾ç½®å…¶çš„ right ä¸º succ.rightï¼Œå°±æ˜¯æŠŠ succ åˆ é™¤</span></span><br><span class="line">    <span class="keyword">final</span> <span class="type">boolean</span> <span class="title function_">unlink</span><span class="params">(Index&lt;K, V&gt; succ)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> node.value != <span class="literal">null</span> &amp;&amp; casRight(succ, succ.right);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>å¤´ç´¢å¼•èŠ‚ç‚¹ HeadIndex</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">HeadIndex</span>&lt;K,V&gt; <span class="keyword">extends</span> <span class="title class_">Index</span>&lt;K,V&gt; &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">int</span> level;<span class="comment">// è¡¨ç¤ºç´¢å¼•å±‚çº§ï¼Œæ‰€æœ‰çš„ HeadIndex éƒ½æŒ‡å‘åŒä¸€ä¸ª Base_header èŠ‚ç‚¹</span></span><br><span class="line">    HeadIndex(Node&lt;K,V&gt; node, Index&lt;K,V&gt; down, Index&lt;K,V&gt; right, <span class="type">int</span> level) &#123;</span><br><span class="line">        <span class="built_in">super</span>(node, down, right);</span><br><span class="line">        <span class="built_in">this</span>.level = level;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><hr><h4 id="æˆå‘˜æ–¹æ³•-7"><a href="#æˆå‘˜æ–¹æ³•-7" class="headerlink" title="æˆå‘˜æ–¹æ³•"></a>æˆå‘˜æ–¹æ³•</h4><h5 id="å…¶ä»–æ–¹æ³•"><a href="#å…¶ä»–æ–¹æ³•" class="headerlink" title="å…¶ä»–æ–¹æ³•"></a>å…¶ä»–æ–¹æ³•</h5><ul><li><p>æ„é€ æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ConcurrentSkipListMap</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.comparator = <span class="literal">null</span>;<span class="comment">// comparator ä¸º nullï¼Œä½¿ç”¨ key çš„è‡ªç„¶åºï¼Œå¦‚å­—å…¸åº</span></span><br><span class="line">    initialize();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">initialize</span><span class="params">()</span> &#123;</span><br><span class="line">    keySet = <span class="literal">null</span>;</span><br><span class="line">    entrySet = <span class="literal">null</span>;</span><br><span class="line">    values = <span class="literal">null</span>;</span><br><span class="line">    descendingMap = <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–ç´¢å¼•å¤´èŠ‚ç‚¹ï¼ŒNode çš„ key ä¸º nullï¼Œvalue ä¸º BASE_HEADER å¯¹è±¡ï¼Œä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¸º null</span></span><br><span class="line">    <span class="comment">// head çš„åˆ†å±‚ç´¢å¼• down ä¸º nullï¼Œé“¾è¡¨çš„åç»­ç´¢å¼• right ä¸º nullï¼Œå±‚çº§ level ä¸ºç¬¬ 1 å±‚</span></span><br><span class="line">    head = <span class="keyword">new</span> <span class="title class_">HeadIndex</span>&lt;K,V&gt;(<span class="keyword">new</span> <span class="title class_">Node</span>&lt;K,V&gt;(<span class="literal">null</span>, BASE_HEADER, <span class="literal">null</span>), <span class="literal">null</span>, <span class="literal">null</span>, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>cprï¼šæ’åº</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//ã€€x æ˜¯æ¯”è¾ƒè€…ï¼Œy æ˜¯è¢«æ¯”è¾ƒè€…ï¼Œæ¯”è¾ƒè€…å¤§äºè¢«æ¯”è¾ƒè€… è¿”å›æ­£æ•°ï¼Œå°äºè¿”å›è´Ÿæ•°ï¼Œç›¸ç­‰è¿”å› 0</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">cpr</span><span class="params">(Comparator c, Object x, Object y)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (c != <span class="literal">null</span>) ? c.compare(x, y) : ((Comparable)x).compareTo(y);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><hr><h5 id="æ·»åŠ æ–¹æ³•-1"><a href="#æ·»åŠ æ–¹æ³•-1" class="headerlink" title="æ·»åŠ æ–¹æ³•"></a>æ·»åŠ æ–¹æ³•</h5><ul><li><p>findPredecessor()ï¼šå¯»æ‰¾å‰ç½®èŠ‚ç‚¹</p><p>ä»æœ€ä¸Šå±‚çš„å¤´ç´¢å¼•å¼€å§‹å‘å³æŸ¥æ‰¾ï¼ˆé“¾è¡¨çš„åç»­ç´¢å¼•ï¼‰ï¼Œå¦‚æœåç»­ç´¢å¼•çš„èŠ‚ç‚¹çš„ key å¤§äºè¦æŸ¥æ‰¾çš„ keyï¼Œåˆ™å¤´ç´¢å¼•ç§»åˆ°ä¸‹å±‚é“¾è¡¨ï¼Œåœ¨ä¸‹å±‚é“¾è¡¨æŸ¥æ‰¾ï¼Œä»¥æ­¤åå¤ï¼Œä¸€ç›´æŸ¥æ‰¾åˆ°æ²¡æœ‰ä¸‹å±‚çš„åˆ†å±‚ç´¢å¼•ä¸ºæ­¢ï¼Œè¿”å›è¯¥ç´¢å¼•çš„èŠ‚ç‚¹ã€‚å¦‚æœåç»­ç´¢å¼•çš„èŠ‚ç‚¹çš„ key å°äºè¦æŸ¥æ‰¾çš„ keyï¼Œåˆ™åœ¨è¯¥å±‚é“¾è¡¨ä¸­å‘åæŸ¥æ‰¾ã€‚ç”±äºæŸ¥æ‰¾çš„ key å¯èƒ½æ°¸è¿œå¤§äºç´¢å¼•èŠ‚ç‚¹çš„ keyï¼Œæ‰€ä»¥åªèƒ½æ‰¾åˆ°ç›®æ ‡çš„å‰ç½®ç´¢å¼•èŠ‚ç‚¹ã€‚å¦‚æœé‡åˆ°ç©ºå€¼ç´¢å¼•çš„å­˜åœ¨ï¼Œé€šè¿‡ CAS æ¥æ–­å¼€ç´¢å¼•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Node&lt;K,V&gt; <span class="title function_">findPredecessor</span><span class="params">(Object key, Comparator&lt;? <span class="built_in">super</span> K&gt; cmp)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (key == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>(); <span class="comment">// don&#x27;t postpone errors</span></span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="comment">// 1.åˆå§‹æ•°æ® q æ˜¯ headï¼Œr æ˜¯æœ€é¡¶å±‚ h çš„å³ Index èŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">for</span> (Index&lt;K,V&gt; q = head, r = q.right, d;;) &#123;</span><br><span class="line">            <span class="comment">// 2.å³ç´¢å¼•èŠ‚ç‚¹ä¸ä¸ºç©ºï¼Œåˆ™è¿›è¡Œå‘ä¸‹æŸ¥æ‰¾</span></span><br><span class="line">            <span class="keyword">if</span> (r != <span class="literal">null</span>) &#123;</span><br><span class="line">                Node&lt;K,V&gt; n = r.node;</span><br><span class="line">                <span class="type">K</span> <span class="variable">k</span> <span class="operator">=</span> n.key;</span><br><span class="line">                <span class="comment">// 3.n.value ä¸º null è¯´æ˜èŠ‚ç‚¹ n æ­£åœ¨åˆ é™¤çš„è¿‡ç¨‹ä¸­ï¼Œæ­¤æ—¶ã€å½“å‰çº¿ç¨‹å¸®å…¶åˆ é™¤ç´¢å¼•ã€‘</span></span><br><span class="line">                <span class="keyword">if</span> (n.value == <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// åœ¨ index å±‚ç›´æ¥åˆ é™¤ r ç´¢å¼•èŠ‚ç‚¹</span></span><br><span class="line">                    <span class="keyword">if</span> (!q.unlink(r))</span><br><span class="line">                        <span class="comment">// åˆ é™¤å¤±è´¥é‡æ–°ä» head èŠ‚ç‚¹å¼€å§‹æŸ¥æ‰¾ï¼Œbreak ä¸€ä¸ª for åˆ°æ­¥éª¤ 1ï¼Œåˆä»åˆå§‹å€¼å¼€å§‹</span></span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment">// åˆ é™¤èŠ‚ç‚¹ r æˆåŠŸï¼Œè·å–æ–°çš„ r èŠ‚ç‚¹,</span></span><br><span class="line">                    r = q.right;</span><br><span class="line">                    <span class="comment">// å›åˆ°æ­¥éª¤ 2ï¼Œè¿˜æ˜¯ä»è¿™å±‚ç´¢å¼•å¼€å§‹å‘å³éå†</span></span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 4.è‹¥å‚æ•° key &gt; r.node.keyï¼Œåˆ™ç»§ç»­å‘å³éå†, continue åˆ°æ­¥éª¤ 2 å¤„è·å–å³èŠ‚ç‚¹</span></span><br><span class="line">                <span class="comment">//   è‹¥å‚æ•° key &lt; r.node.keyï¼Œè¯´æ˜éœ€è¦è¿›å…¥ä¸‹å±‚ç´¢å¼•ï¼Œåˆ°æ­¥éª¤ 5</span></span><br><span class="line">                <span class="keyword">if</span> (cpr(cmp, key, k) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    q = r;</span><br><span class="line">                    r = r.right;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 5.å…ˆè®© d æŒ‡å‘ q çš„ä¸‹ä¸€å±‚ï¼Œåˆ¤æ–­æ˜¯å¦æ˜¯ nullï¼Œæ˜¯åˆ™è¯´æ˜å·²ç»åˆ°äº†æ•°æ®å±‚ï¼Œä¹Ÿå°±æ˜¯ç¬¬ä¸€å±‚</span></span><br><span class="line">            <span class="keyword">if</span> ((d = q.down) == <span class="literal">null</span>) </span><br><span class="line">                <span class="keyword">return</span> q.node;</span><br><span class="line">            <span class="comment">// 6.æœªåˆ°æ•°æ®å±‚, è¿›è¡Œé‡æ–°èµ‹å€¼å‘ä¸‹æ‰«æ</span></span><br><span class="line">            q = d;<span class="comment">// q æŒ‡å‘ d</span></span><br><span class="line">            r = d.right;<span class="comment">// r æŒ‡å‘ q çš„åç»­ç´¢å¼•èŠ‚ç‚¹ï¼Œæ­¤æ—¶(q.key &lt; key &lt; r.key)</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/JUC-ConcurrentSkipListMap-Put%E6%B5%81%E7%A8%8B.png"></p></li><li><p>put()ï¼šæ·»åŠ æ•°æ®</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> V <span class="title function_">put</span><span class="params">(K key, V value)</span> &#123;</span><br><span class="line">    <span class="comment">// éç©ºåˆ¤æ–­ï¼Œvalueä¸èƒ½ä¸ºç©º</span></span><br><span class="line">    <span class="keyword">if</span> (value == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">    <span class="keyword">return</span> doPut(key, value, <span class="literal">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> V <span class="title function_">doPut</span><span class="params">(K key, V value, <span class="type">boolean</span> onlyIfAbsent)</span> &#123;</span><br><span class="line">    Node&lt;K,V&gt; z;</span><br><span class="line">    <span class="comment">// éç©ºåˆ¤æ–­ï¼Œkey ä¸èƒ½ä¸ºç©º</span></span><br><span class="line">    <span class="keyword">if</span> (key == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">    Comparator&lt;? <span class="built_in">super</span> K&gt; cmp = comparator;</span><br><span class="line">    <span class="comment">// outer å¾ªç¯ï¼Œã€æŠŠå¾…æ’å…¥æ•°æ®æ’å…¥åˆ°æ•°æ®å±‚çš„åˆé€‚çš„ä½ç½®ï¼Œå¹¶åœ¨æ‰«æè¿‡ç¨‹ä¸­å¤„ç†å·²åˆ é™¤(value = null)çš„æ•°æ®ã€‘</span></span><br><span class="line">    outer: <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="comment">//0.for (;;)</span></span><br><span class="line">        <span class="comment">//1.å°† key å¯¹åº”çš„å‰ç»§èŠ‚ç‚¹æ‰¾åˆ°, b ä¸ºå‰ç»§èŠ‚ç‚¹ï¼Œæ˜¯æ•°æ®å±‚çš„, n æ˜¯å‰ç»§èŠ‚ç‚¹çš„ next, </span></span><br><span class="line"><span class="comment">//  è‹¥æ²¡å‘ç”Ÿæ¡ä»¶ç«äº‰ï¼Œæœ€ç»ˆ key åœ¨ b ä¸ n ä¹‹é—´ (æ‰¾åˆ°çš„ b åœ¨ base_level ä¸Š)</span></span><br><span class="line">        <span class="keyword">for</span> (Node&lt;K,V&gt; b = findPredecessor(key, cmp), n = b.next;;) &#123;</span><br><span class="line">            <span class="comment">// 2.n ä¸ä¸º null è¯´æ˜ b ä¸æ˜¯é“¾è¡¨çš„æœ€åä¸€ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">            <span class="keyword">if</span> (n != <span class="literal">null</span>) &#123;</span><br><span class="line">                Object v; <span class="type">int</span> c;</span><br><span class="line">                <span class="comment">// 3.è·å– n çš„å³èŠ‚ç‚¹</span></span><br><span class="line">                Node&lt;K,V&gt; f = n.next;</span><br><span class="line">                <span class="comment">// 4.æ¡ä»¶ç«äº‰ï¼Œå¹¶å‘ä¸‹å…¶ä»–çº¿ç¨‹åœ¨ b ä¹‹åæ’å…¥èŠ‚ç‚¹æˆ–ç›´æ¥åˆ é™¤èŠ‚ç‚¹ n, break åˆ°æ­¥éª¤ 0</span></span><br><span class="line">                <span class="keyword">if</span> (n != b.next)              </span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="comment">//  è‹¥èŠ‚ç‚¹ n å·²ç»åˆ é™¤, åˆ™è°ƒç”¨ helpDelete è¿›è¡Œã€å¸®åŠ©åˆ é™¤èŠ‚ç‚¹ã€‘</span></span><br><span class="line">                <span class="keyword">if</span> ((v = n.value) == <span class="literal">null</span>) &#123;</span><br><span class="line">                    n.helpDelete(b, f);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 5.èŠ‚ç‚¹ b è¢«åˆ é™¤ä¸­ï¼Œåˆ™ break åˆ°æ­¥éª¤ 0,</span></span><br><span class="line"><span class="comment">//  ã€è°ƒç”¨findPredecessorå¸®åŠ©åˆ é™¤indexå±‚çš„æ•°æ®, nodeå±‚çš„æ•°æ®ä¼šé€šè¿‡helpDeleteæ–¹æ³•è¿›è¡Œåˆ é™¤ã€‘</span></span><br><span class="line">                <span class="keyword">if</span> (b.value == <span class="literal">null</span> || v == n) </span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="comment">// 6.è‹¥ key &gt; n.keyï¼Œåˆ™è¿›è¡Œå‘åæ‰«æ</span></span><br><span class="line">                <span class="comment">//   è‹¥ key &lt; n.keyï¼Œåˆ™è¯æ˜ key åº”è¯¥å­˜å‚¨åœ¨ b å’Œ n ä¹‹é—´</span></span><br><span class="line">                <span class="keyword">if</span> ((c = cpr(cmp, key, n.key)) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    b = n;</span><br><span class="line">                    n = f;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 7.key çš„å€¼å’Œ n.key ç›¸ç­‰ï¼Œåˆ™å¯ä»¥ç›´æ¥è¦†ç›–èµ‹å€¼</span></span><br><span class="line">                <span class="keyword">if</span> (c == <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">// onlyIfAbsent é»˜è®¤ falseï¼Œ</span></span><br><span class="line">                    <span class="keyword">if</span> (onlyIfAbsent || n.casValue(v, value)) &#123;</span><br><span class="line">                        <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span> <span class="type">V</span> <span class="variable">vv</span> <span class="operator">=</span> (V)v;</span><br><span class="line">                        <span class="comment">// è¿”å›è¢«è¦†ç›–çš„å€¼</span></span><br><span class="line">                        <span class="keyword">return</span> vv;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// caså¤±è´¥ï¼Œbreak ä¸€å±‚å¾ªç¯ï¼Œè¿”å› 0 é‡è¯•</span></span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// else c &lt; 0; fall through</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 8.æ­¤æ—¶çš„æƒ…å†µ b.key &lt; key &lt; n.keyï¼Œå¯¹åº”æµç¨‹å›¾1ä¸­çš„7ï¼Œåˆ›å»ºzèŠ‚ç‚¹æŒ‡å‘n</span></span><br><span class="line">            z = <span class="keyword">new</span> <span class="title class_">Node</span>&lt;K,V&gt;(key, value, n);</span><br><span class="line">            <span class="comment">// 9.å°è¯•æŠŠ b.next ä» n è®¾ç½®æˆ z</span></span><br><span class="line">            <span class="keyword">if</span> (!b.casNext(n, z))</span><br><span class="line">                <span class="comment">// caså¤±è´¥ï¼Œè¿”å›åˆ°æ­¥éª¤0ï¼Œé‡è¯•</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="comment">// 10.break outer å, ä¸Šé¢çš„ for å¾ªç¯ä¸ä¼šå†æ‰§è¡Œ, è€Œåæ‰§è¡Œä¸‹é¢çš„ä»£ç </span></span><br><span class="line">            <span class="keyword">break</span> outer;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// ã€ä»¥ä¸Šæ’å…¥èŠ‚ç‚¹å·²ç»å®Œæˆï¼Œå‰©ä¸‹çš„ä»»åŠ¡è¦æ ¹æ®éšæœºæ•°çš„å€¼æ¥è¡¨ç¤ºæ˜¯å¦å‘ä¸Šå¢åŠ å±‚æ•°ä¸ä¸Šå±‚ç´¢å¼•ã€‘</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// éšæœºæ•°</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">rnd</span> <span class="operator">=</span> ThreadLocalRandom.nextSecondarySeed();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å¦‚æœéšæœºæ•°çš„äºŒè¿›åˆ¶ä¸ 10000000000000000000000000000001 è¿›è¡Œä¸è¿ç®—ä¸º 0</span></span><br><span class="line">    <span class="comment">// å³éšæœºæ•°çš„äºŒè¿›åˆ¶æœ€é«˜ä½ä¸æœ€æœ«å°¾å¿…é¡»ä¸º 0ï¼Œå…¶ä»–ä½æ— æ‰€è°“ï¼Œå°±è¿›å…¥è¯¥å¾ªç¯</span></span><br><span class="line">    <span class="comment">// å¦‚æœéšæœºæ•°çš„äºŒè¿›åˆ¶æœ€é«˜ä½ä¸æœ€æœ«ä½ä¸ä¸º 0ï¼Œä¸å¢åŠ æ–°èŠ‚ç‚¹çš„å±‚æ•°</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 11.åˆ¤æ–­æ˜¯å¦éœ€è¦æ·»åŠ  levelï¼Œ32 ä½</span></span><br><span class="line">    <span class="keyword">if</span> ((rnd &amp; <span class="number">0x80000001</span>) == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// ç´¢å¼•å±‚ levelï¼Œä» 1 å¼€å§‹ï¼Œå°±æ˜¯æœ€åº•å±‚</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">level</span> <span class="operator">=</span> <span class="number">1</span>, max;</span><br><span class="line">        <span class="comment">// 12.åˆ¤æ–­æœ€ä½ä½å‰é¢æœ‰å‡ ä¸ª 1ï¼Œæœ‰å‡ ä¸ªleveå°±åŠ å‡ ï¼š0..0 0001 1110ï¼Œè¿™æ˜¯4ä¸ªï¼Œåˆ™1+4=5</span></span><br><span class="line">        <span class="comment">//    ã€æœ€å¤§æœ‰30ä¸ªå°±æ˜¯ 1 + 30 = 31</span></span><br><span class="line">        <span class="keyword">while</span> (((rnd &gt;&gt;&gt;= <span class="number">1</span>) &amp; <span class="number">1</span>) != <span class="number">0</span>)</span><br><span class="line">            ++level;</span><br><span class="line">        <span class="comment">// æœ€ç»ˆä¼šæŒ‡å‘ z èŠ‚ç‚¹ï¼Œå°±æ˜¯æ·»åŠ çš„èŠ‚ç‚¹ </span></span><br><span class="line">        Index&lt;K,V&gt; idx = <span class="literal">null</span>;</span><br><span class="line">        <span class="comment">// æŒ‡å‘å¤´ç´¢å¼•èŠ‚ç‚¹</span></span><br><span class="line">        HeadIndex&lt;K,V&gt; h = head;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 13.åˆ¤æ–­levelæ˜¯å¦æ¯”å½“å‰æœ€é«˜ç´¢å¼•å°ï¼Œå›¾ä¸­ max ä¸º 3</span></span><br><span class="line">        <span class="keyword">if</span> (level &lt;= (max = h.level)) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= level; ++i)</span><br><span class="line">                <span class="comment">// æ ¹æ®å±‚æ•°levelä¸æ–­åˆ›å»ºæ–°å¢èŠ‚ç‚¹çš„ä¸Šå±‚ç´¢å¼•ï¼Œç´¢å¼•çš„åç»§ç´¢å¼•ç•™ç©º</span></span><br><span class="line">                <span class="comment">// ç¬¬ä¸€æ¬¡idxä¸ºnullï¼Œä¹Ÿå°±æ˜¯ä¸‹å±‚ç´¢å¼•ä¸ºç©ºï¼Œç¬¬äºŒæ¬¡æŠŠä¸Šæ¬¡çš„ç´¢å¼•ä½œä¸ºä¸‹å±‚ç´¢å¼•ï¼Œã€ç±»ä¼¼å¤´æ’æ³•ã€‘</span></span><br><span class="line">                idx = <span class="keyword">new</span> <span class="title class_">Index</span>&lt;K,V&gt;(z, idx, <span class="literal">null</span>);</span><br><span class="line">            <span class="comment">// å¾ªç¯ä»¥åçš„ç´¢å¼•ç»“æ„</span></span><br><span class="line">            <span class="comment">// index-3â† idx</span></span><br><span class="line">            <span class="comment">//   â†“</span></span><br><span class="line">            <span class="comment">// index-2</span></span><br><span class="line">            <span class="comment">//   â†“</span></span><br><span class="line">            <span class="comment">// index-1</span></span><br><span class="line">            <span class="comment">//   â†“</span></span><br><span class="line">            <span class="comment">//  z-node</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 14.è‹¥ level &gt; maxï¼Œåˆ™ã€åªå¢åŠ ä¸€å±‚ index ç´¢å¼•å±‚ã€‘ï¼Œ3 + 1 = 4</span></span><br><span class="line">        <span class="keyword">else</span> &#123; </span><br><span class="line">            level = max + <span class="number">1</span>;</span><br><span class="line">            <span class="comment">//åˆ›å»ºä¸€ä¸ª index æ•°ç»„ï¼Œé•¿åº¦æ˜¯ level+1ï¼Œå‡è®¾ level æ˜¯ 4ï¼Œåˆ›å»ºçš„æ•°ç»„é•¿åº¦ä¸º 5</span></span><br><span class="line">            Index&lt;K,V&gt;[] idxs = (Index&lt;K,V&gt;[])<span class="keyword">new</span> <span class="title class_">Index</span>&lt;?,?&gt;[level+<span class="number">1</span>];</span><br><span class="line">            <span class="comment">// index[0]çš„æ•°ç»„ slot å¹¶æ²¡æœ‰ä½¿ç”¨ï¼Œåªä½¿ç”¨ [1,level] è¿™äº›æ•°ç»„çš„ slot</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">1</span>; i &lt;= level; ++i)</span><br><span class="line">                idxs[i] = idx = <span class="keyword">new</span> <span class="title class_">Index</span>&lt;K,V&gt;(z, idx, <span class="literal">null</span>);</span><br><span class="line">              <span class="comment">// index-4   â† idx</span></span><br><span class="line">                    <span class="comment">//   â†“</span></span><br><span class="line">                  <span class="comment">// ......</span></span><br><span class="line">                    <span class="comment">//   â†“</span></span><br><span class="line">                    <span class="comment">// index-1</span></span><br><span class="line">                    <span class="comment">//   â†“</span></span><br><span class="line">                    <span class="comment">//  z-node</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">                h = head;</span><br><span class="line">                <span class="comment">// è·å–å¤´ç´¢å¼•çš„å±‚æ•°ï¼Œ3</span></span><br><span class="line">                <span class="type">int</span> <span class="variable">oldLevel</span> <span class="operator">=</span> h.level;</span><br><span class="line">                <span class="comment">// å¦‚æœ level &lt;= oldLevelï¼Œè¯´æ˜å…¶ä»–çº¿ç¨‹è¿›è¡Œäº† index å±‚å¢åŠ æ“ä½œï¼Œé€€å‡ºå¾ªç¯</span></span><br><span class="line">                <span class="keyword">if</span> (level &lt;= oldLevel)</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="comment">// å®šä¹‰ä¸€ä¸ªæ–°çš„å¤´ç´¢å¼•èŠ‚ç‚¹</span></span><br><span class="line">                HeadIndex&lt;K,V&gt; newh = h;</span><br><span class="line">                <span class="comment">// è·å–å¤´ç´¢å¼•çš„èŠ‚ç‚¹ï¼Œå°±æ˜¯ BASE_HEADER</span></span><br><span class="line">                Node&lt;K,V&gt; oldbase = h.node;</span><br><span class="line">                <span class="comment">// å‡çº§ baseHeader ç´¢å¼•ï¼Œå‡é«˜ä¸€çº§ï¼Œå¹¶å‘ä¸‹å¯èƒ½å‡é«˜å¤šçº§</span></span><br><span class="line">                <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> oldLevel + <span class="number">1</span>; j &lt;= level; ++j)</span><br><span class="line">                    <span class="comment">// å‚æ•°1ï¼šåº•å±‚nodeï¼Œå‚æ•°äºŒï¼šdownï¼Œä¸ºä»¥å‰çš„å¤´èŠ‚ç‚¹ï¼Œå‚æ•°ä¸‰ï¼šrightï¼Œæ–°å»º</span></span><br><span class="line">                    newh = <span class="keyword">new</span> <span class="title class_">HeadIndex</span>&lt;K,V&gt;(oldbase, newh, idxs[j], j);</span><br><span class="line">                <span class="comment">// æ‰§è¡Œå®Œforå¾ªç¯ä¹‹åï¼ŒbaseHeader ç´¢å¼•é•¿è¿™ä¸ªæ ·å­ï¼Œè¿™é‡Œåªå‡é«˜ä¸€çº§</span></span><br><span class="line">                <span class="comment">// index-4             â†’             index-4â† idx</span></span><br><span class="line">                <span class="comment">//   â†“                                  â†“</span></span><br><span class="line">                <span class="comment">// index-3                           index-3     </span></span><br><span class="line">                <span class="comment">//   â†“                                  â†“</span></span><br><span class="line">                <span class="comment">// index-2                           index-2</span></span><br><span class="line">                <span class="comment">//   â†“                                  â†“</span></span><br><span class="line">                <span class="comment">// index-1                           index-1</span></span><br><span class="line">                <span class="comment">//   â†“                                  â†“</span></span><br><span class="line">                <span class="comment">// baseHeader    â†’    ....      â†’     z-node</span></span><br><span class="line">                </span><br><span class="line">                <span class="comment">// cas æˆåŠŸåï¼Œhead å­—æ®µæŒ‡å‘æœ€æ–°çš„ headIndexï¼ŒbaseHeader çš„ index-4</span></span><br><span class="line">                <span class="keyword">if</span> (casHead(h, newh)) &#123;</span><br><span class="line">                    <span class="comment">// h æŒ‡å‘æœ€æ–°çš„ index-4 èŠ‚ç‚¹</span></span><br><span class="line">                    h = newh;</span><br><span class="line">                    <span class="comment">// è®© idx æŒ‡å‘ z-node çš„ index-3 èŠ‚ç‚¹ï¼Œ</span></span><br><span class="line"><span class="comment">// å› ä¸ºä» index-3 - index-1 çš„è¿™äº› z-node ç´¢å¼•èŠ‚ç‚¹ éƒ½æ²¡æœ‰æ’å…¥åˆ°ç´¢å¼•é“¾è¡¨</span></span><br><span class="line">                    idx = idxs[level = oldLevel];</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 15.ã€æŠŠæ–°åŠ çš„ç´¢å¼•æ’å…¥ç´¢å¼•é“¾è¡¨ä¸­ã€‘ï¼Œæœ‰ä¸Šè¿°ä¸¤ç§æƒ…å†µï¼Œä¸€ç§ç´¢å¼•é«˜åº¦ä¸å˜ï¼Œå¦ä¸€ç§æ˜¯é«˜åº¦åŠ  1</span></span><br><span class="line">        <span class="comment">// è¦æ’å…¥çš„æ˜¯ç¬¬å‡ å±‚çš„ç´¢å¼•</span></span><br><span class="line">        splice: <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">insertionLevel</span> <span class="operator">=</span> level;;) &#123;</span><br><span class="line">            <span class="comment">// è·å–å¤´ç´¢å¼•çš„å±‚æ•°ï¼Œæƒ…å†µ 1 æ˜¯ 3ï¼Œæƒ…å†µ 2 æ˜¯ 4</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> h.level;</span><br><span class="line">            <span class="comment">// ã€éå† insertionLevel å±‚çš„ç´¢å¼•ï¼Œæ‰¾åˆ°åˆé€‚çš„æ’å…¥ä½ç½®ã€‘</span></span><br><span class="line">            <span class="keyword">for</span> (Index&lt;K,V&gt; q = h, r = q.right, t = idx;;) &#123;</span><br><span class="line">                <span class="comment">// å¦‚æœå¤´ç´¢å¼•ä¸º null æˆ–è€…æ–°å¢èŠ‚ç‚¹ç´¢å¼•ä¸º nullï¼Œé€€å‡ºæ’å…¥ç´¢å¼•çš„æ€»å¾ªç¯</span></span><br><span class="line">                <span class="keyword">if</span> (q == <span class="literal">null</span> || t == <span class="literal">null</span>)</span><br><span class="line">                    <span class="comment">// æ­¤å¤„è¡¨ç¤ºæœ‰å…¶ä»–çº¿ç¨‹åˆ é™¤äº†å¤´ç´¢å¼•æˆ–è€…æ–°å¢èŠ‚ç‚¹çš„ç´¢å¼•</span></span><br><span class="line">                    <span class="keyword">break</span> splice;</span><br><span class="line">                <span class="comment">// å¤´ç´¢å¼•çš„é“¾è¡¨åç»­ç´¢å¼•å­˜åœ¨ï¼Œå¦‚æœæ˜¯æ–°å±‚åˆ™ä¸ºæ–°èŠ‚ç‚¹ç´¢å¼•ï¼Œå¦‚æœæ˜¯è€å±‚åˆ™ä¸ºåŸç´¢å¼•</span></span><br><span class="line">                <span class="keyword">if</span> (r != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// è·å–rçš„èŠ‚ç‚¹</span></span><br><span class="line">                    Node&lt;K,V&gt; n = r.node;</span><br><span class="line">                    <span class="comment">// æ’å…¥çš„keyå’Œn.keyçš„æ¯”è¾ƒå€¼</span></span><br><span class="line">                    <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> cpr(cmp, key, n.key);</span><br><span class="line">                    <span class="comment">// ã€åˆ é™¤ç©ºå€¼ç´¢å¼•ã€‘</span></span><br><span class="line">                    <span class="keyword">if</span> (n.value == <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (!q.unlink(r))</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        r = q.right;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// key &gt; r.node.keyï¼Œå‘å³æ‰«æ</span></span><br><span class="line">                    <span class="keyword">if</span> (c &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                        q = r;</span><br><span class="line">                        r = r.right;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// æ‰§è¡Œåˆ°è¿™é‡Œï¼Œè¯´æ˜ key &lt; r.node.keyï¼Œåˆ¤æ–­æ˜¯å¦æ˜¯ç¬¬ j å±‚æ’å…¥æ–°å¢èŠ‚ç‚¹çš„å‰ç½®ç´¢å¼•</span></span><br><span class="line">                <span class="keyword">if</span> (j == insertionLevel) &#123;</span><br><span class="line">                    <span class="comment">// ã€å°†æ–°ç´¢å¼•èŠ‚ç‚¹ t æ’å…¥ q r ä¹‹é—´ã€‘</span></span><br><span class="line">                    <span class="keyword">if</span> (!q.link(r, t))</span><br><span class="line">                        <span class="keyword">break</span>; </span><br><span class="line">                    <span class="comment">// å¦‚æœæ–°å¢èŠ‚ç‚¹çš„å€¼ä¸º nullï¼Œè¡¨ç¤ºè¯¥èŠ‚ç‚¹å·²ç»è¢«å…¶ä»–çº¿ç¨‹åˆ é™¤</span></span><br><span class="line">                    <span class="keyword">if</span> (t.node.value == <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="comment">// æ‰¾åˆ°è¯¥èŠ‚ç‚¹</span></span><br><span class="line">                        findNode(key);</span><br><span class="line">                        <span class="keyword">break</span> splice;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// æ’å…¥å±‚é€å±‚è‡ªå‡ï¼Œå½“ä¸ºæœ€åº•å±‚æ—¶é€€å‡ºå¾ªç¯</span></span><br><span class="line">                    <span class="keyword">if</span> (--insertionLevel == <span class="number">0</span>)</span><br><span class="line">                        <span class="keyword">break</span> splice;</span><br><span class="line">                &#125;</span><br><span class="line"><span class="comment">// å…¶ä»–èŠ‚ç‚¹éšç€æ’å…¥èŠ‚ç‚¹çš„å±‚æ•°ä¸‹ç§»è€Œä¸‹ç§»</span></span><br><span class="line">                <span class="keyword">if</span> (--j &gt;= insertionLevel &amp;&amp; j &lt; level)</span><br><span class="line">                    t = t.down;</span><br><span class="line">                q = q.down;</span><br><span class="line">                r = q.right;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>findNode()</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Node&lt;K,V&gt; <span class="title function_">findNode</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">    <span class="comment">// åŸç†ä¸doGetç›¸åŒï¼Œæ— éæ˜¯ findNode è¿”å›èŠ‚ç‚¹ï¼ŒdoGet è¿”å› value</span></span><br><span class="line">    <span class="keyword">if</span> ((c = cpr(cmp, key, n.key)) == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> n;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><hr><h5 id="è·å–æ–¹æ³•-1"><a href="#è·å–æ–¹æ³•-1" class="headerlink" title="è·å–æ–¹æ³•"></a>è·å–æ–¹æ³•</h5><ul><li><p>get(key)ï¼šè·å–å¯¹åº”çš„æ•°æ®</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> V <span class="title function_">get</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> doGet(key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>doGet()ï¼šæ‰«æè¿‡ç¨‹ä¼šå¯¹å·² value &#x3D; null çš„å…ƒç´ è¿›è¡Œåˆ é™¤å¤„ç†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> V <span class="title function_">doGet</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (key == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">    Comparator&lt;? <span class="built_in">super</span> K&gt; cmp = comparator;</span><br><span class="line">    outer: <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="comment">// 1.æ‰¾åˆ°æœ€åº•å±‚èŠ‚ç‚¹çš„å‰ç½®èŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">for</span> (Node&lt;K,V&gt; b = findPredecessor(key, cmp), n = b.next;;) &#123;</span><br><span class="line">            Object v; <span class="type">int</span> c;</span><br><span class="line">            <span class="comment">// 2.ã€å¦‚æœè¯¥å‰ç½®èŠ‚ç‚¹çš„é“¾è¡¨åç»­èŠ‚ç‚¹ä¸º nullï¼Œè¯´æ˜ä¸å­˜åœ¨è¯¥èŠ‚ç‚¹ã€‘</span></span><br><span class="line">            <span class="keyword">if</span> (n == <span class="literal">null</span>)</span><br><span class="line">                <span class="keyword">break</span> outer;</span><br><span class="line">            <span class="comment">// b â†’ n â†’ f</span></span><br><span class="line">            Node&lt;K,V&gt; f = n.next;</span><br><span class="line">            <span class="comment">// 3.å¦‚æœnä¸ä¸ºå‰ç½®èŠ‚ç‚¹çš„åç»­èŠ‚ç‚¹ï¼Œè¡¨ç¤ºå·²ç»æœ‰å…¶ä»–çº¿ç¨‹åˆ é™¤äº†è¯¥èŠ‚ç‚¹</span></span><br><span class="line">            <span class="keyword">if</span> (n != b.next) </span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="comment">// 4.å¦‚æœåç»­èŠ‚ç‚¹çš„å€¼ä¸ºnullï¼Œã€éœ€è¦å¸®åŠ©åˆ é™¤è¯¥èŠ‚ç‚¹ã€‘</span></span><br><span class="line">            <span class="keyword">if</span> ((v = n.value) == <span class="literal">null</span>) &#123;</span><br><span class="line">                n.helpDelete(b, f);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 5.å¦‚æœå‰ç½®èŠ‚ç‚¹å·²è¢«å…¶ä»–çº¿ç¨‹åˆ é™¤ï¼Œé‡æ–°å¾ªç¯</span></span><br><span class="line">            <span class="keyword">if</span> (b.value == <span class="literal">null</span> || v == n)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">             <span class="comment">// 6.å¦‚æœè¦è·å–çš„keyä¸åç»­èŠ‚ç‚¹çš„keyç›¸ç­‰ï¼Œè¿”å›èŠ‚ç‚¹çš„value</span></span><br><span class="line">            <span class="keyword">if</span> ((c = cpr(cmp, key, n.key)) == <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span> <span class="type">V</span> <span class="variable">vv</span> <span class="operator">=</span> (V)v;</span><br><span class="line">                <span class="keyword">return</span> vv;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 7.key &lt; n.keyï¼Œå› ä½ key &gt; b.keyï¼Œb å’Œ n ç›¸è¿ï¼Œè¯´æ˜ä¸å­˜åœ¨è¯¥èŠ‚ç‚¹æˆ–è€…è¢«å…¶ä»–çº¿ç¨‹åˆ é™¤äº†</span></span><br><span class="line">            <span class="keyword">if</span> (c &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">break</span> outer;</span><br><span class="line">            b = n;</span><br><span class="line">            n = f;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><hr><h5 id="åˆ é™¤æ–¹æ³•-1"><a href="#åˆ é™¤æ–¹æ³•-1" class="headerlink" title="åˆ é™¤æ–¹æ³•"></a>åˆ é™¤æ–¹æ³•</h5><ul><li><p>remove()</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> V <span class="title function_">remove</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> doRemove(key, <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">final</span> V <span class="title function_">doRemove</span><span class="params">(Object key, Object value)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (key == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">    Comparator&lt;? <span class="built_in">super</span> K&gt; cmp = comparator;</span><br><span class="line">    outer: <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="comment">// 1.æ‰¾åˆ°æœ€åº•å±‚ç›®æ ‡èŠ‚ç‚¹çš„å‰ç½®èŠ‚ç‚¹ï¼Œb.key &lt; key</span></span><br><span class="line">        <span class="keyword">for</span> (Node&lt;K,V&gt; b = findPredecessor(key, cmp), n = b.next;;) &#123;</span><br><span class="line">            Object v; <span class="type">int</span> c;</span><br><span class="line">            <span class="comment">// 2.å¦‚æœè¯¥å‰ç½®èŠ‚ç‚¹çš„é“¾è¡¨åç»­èŠ‚ç‚¹ä¸º nullï¼Œé€€å‡ºå¾ªç¯ï¼Œè¯´æ˜ä¸å­˜åœ¨è¿™ä¸ªå…ƒç´ </span></span><br><span class="line">            <span class="keyword">if</span> (n == <span class="literal">null</span>)</span><br><span class="line">                <span class="keyword">break</span> outer;</span><br><span class="line">            <span class="comment">// b â†’ n â†’ f</span></span><br><span class="line">            Node&lt;K,V&gt; f = n.next;</span><br><span class="line">            <span class="keyword">if</span> (n != b.next)                    <span class="comment">// inconsistent read</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">if</span> ((v = n.value) == <span class="literal">null</span>) &#123;        <span class="comment">// n is deleted</span></span><br><span class="line">                n.helpDelete(b, f);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (b.value == <span class="literal">null</span> || v == n)      <span class="comment">// b is deleted</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="comment">//3.key &lt; n.keyï¼Œè¯´æ˜è¢«å…¶ä»–çº¿ç¨‹åˆ é™¤äº†ï¼Œæˆ–è€…ä¸å­˜åœ¨è¯¥èŠ‚ç‚¹</span></span><br><span class="line">            <span class="keyword">if</span> ((c = cpr(cmp, key, n.key)) &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">break</span> outer;</span><br><span class="line">            <span class="comment">//4.key &gt; n.keyï¼Œç»§ç»­å‘åæ‰«æ</span></span><br><span class="line">            <span class="keyword">if</span> (c &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                b = n;</span><br><span class="line">                n = f;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//5.åˆ°è¿™é‡Œæ˜¯ key = n.keyï¼Œvalue ä¸ä¸ºç©ºçš„æƒ…å†µä¸‹åˆ¤æ–­ value å’Œ n.value æ˜¯å¦ç›¸ç­‰</span></span><br><span class="line">            <span class="keyword">if</span> (value != <span class="literal">null</span> &amp;&amp; !value.equals(v))</span><br><span class="line">                <span class="keyword">break</span> outer;</span><br><span class="line">            <span class="comment">//6.ã€æŠŠ n èŠ‚ç‚¹çš„ value ç½®ç©ºã€‘</span></span><br><span class="line">            <span class="keyword">if</span> (!n.casValue(v, <span class="literal">null</span>))</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="comment">//7.ã€ç»™ n æ·»åŠ ä¸€ä¸ªåˆ é™¤æ ‡å¿— markã€‘ï¼Œmark.next = fï¼Œç„¶åæŠŠ b.next è®¾ç½®ä¸º fï¼ŒæˆåŠŸånå‡ºé˜Ÿ</span></span><br><span class="line">            <span class="keyword">if</span> (!n.appendMarker(f) || !b.casNext(n, f))</span><br><span class="line">                <span class="comment">// å¯¹ key å¯¹åº”çš„ index è¿›è¡Œåˆ é™¤ï¼Œè°ƒç”¨äº† findPredecessor æ–¹æ³•</span></span><br><span class="line">                findNode(key);</span><br><span class="line">            <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// è¿›è¡Œæ“ä½œå¤±è´¥åé€šè¿‡ findPredecessor ä¸­è¿›è¡Œ index çš„åˆ é™¤</span></span><br><span class="line">                findPredecessor(key, cmp);</span><br><span class="line">                <span class="keyword">if</span> (head.right == <span class="literal">null</span>)</span><br><span class="line">                    <span class="comment">// è¿›è¡ŒheadIndex å¯¹åº”çš„index å±‚çš„åˆ é™¤</span></span><br><span class="line">                    tryReduceLevel();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span> <span class="type">V</span> <span class="variable">vv</span> <span class="operator">=</span> (V)v;</span><br><span class="line">            <span class="keyword">return</span> vv;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»è¿‡ findPredecessor() ä¸­çš„ unlink() åç´¢å¼•å·²ç»è¢«åˆ é™¤</p><p><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/JUC-ConcurrentSkipListMap-remove%E6%B5%81%E7%A8%8B.png"></p></li><li><p>appendMarker()ï¼šæ·»åŠ åˆ é™¤æ ‡è®°èŠ‚ç‚¹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">boolean</span> <span class="title function_">appendMarker</span><span class="params">(Node&lt;K,V&gt; f)</span> &#123;</span><br><span class="line">    <span class="comment">// é€šè¿‡ CAS è®© n.next æŒ‡å‘ä¸€ä¸ª key ä¸º nullï¼Œvalue ä¸º thisï¼Œnext ä¸º f çš„æ ‡è®°èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">return</span> casNext(f, <span class="keyword">new</span> <span class="title class_">Node</span>&lt;K,V&gt;(f));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>helpDelete()ï¼šå°†æ·»åŠ äº†åˆ é™¤æ ‡è®°çš„èŠ‚ç‚¹æ¸…é™¤ï¼Œå‚æ•°æ˜¯è¯¥èŠ‚ç‚¹çš„å‰é©±å’Œåç»§èŠ‚ç‚¹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">helpDelete</span><span class="params">(Node&lt;K,V&gt; b, Node&lt;K,V&gt; f)</span> &#123;</span><br><span class="line">    <span class="comment">// this èŠ‚ç‚¹çš„åç»­èŠ‚ç‚¹ä¸º fï¼Œä¸”æœ¬èº«ä¸º b çš„åç»­èŠ‚ç‚¹ï¼Œä¸€èˆ¬éƒ½æ˜¯æ­£ç¡®çš„ï¼Œé™¤éè¢«åˆ«çš„çº¿ç¨‹åˆ é™¤</span></span><br><span class="line">    <span class="keyword">if</span> (f == next &amp;&amp; <span class="built_in">this</span> == b.next) &#123;</span><br><span class="line">        <span class="comment">// å¦‚æœ n è¿˜è¿˜æ²¡æœ‰è¢«æ ‡è®°</span></span><br><span class="line">        <span class="keyword">if</span> (f == <span class="literal">null</span> || f.value != f) </span><br><span class="line">            casNext(f, <span class="keyword">new</span> <span class="title class_">Node</span>&lt;K,V&gt;(f));</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="comment">// é€šè¿‡ CASï¼Œå°† b çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ n å˜æˆ f.nextï¼Œå³æˆä¸ºå›¾ä¸­çš„æ ·å¼</span></span><br><span class="line">            b.casNext(<span class="built_in">this</span>, f.next);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>tryReduceLevel()ï¼šåˆ é™¤ç´¢å¼•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">tryReduceLevel</span><span class="params">()</span> &#123;</span><br><span class="line">    HeadIndex&lt;K,V&gt; h = head;</span><br><span class="line">    HeadIndex&lt;K,V&gt; d;</span><br><span class="line">    HeadIndex&lt;K,V&gt; e;</span><br><span class="line">    <span class="keyword">if</span> (h.level &gt; <span class="number">3</span> &amp;&amp;</span><br><span class="line">        (d = (HeadIndex&lt;K,V&gt;)h.down) != <span class="literal">null</span> &amp;&amp;</span><br><span class="line">        (e = (HeadIndex&lt;K,V&gt;)d.down) != <span class="literal">null</span> &amp;&amp;</span><br><span class="line">        e.right == <span class="literal">null</span> &amp;&amp;</span><br><span class="line">        d.right == <span class="literal">null</span> &amp;&amp;</span><br><span class="line">        h.right == <span class="literal">null</span> &amp;&amp;</span><br><span class="line">        <span class="comment">// è®¾ç½®å¤´ç´¢å¼•</span></span><br><span class="line">        casHead(h, d) &amp;&amp; </span><br><span class="line">        <span class="comment">// é‡æ–°æ£€æŸ¥</span></span><br><span class="line">        h.right != <span class="literal">null</span>) </span><br><span class="line">        <span class="comment">// é‡æ–°æ£€æŸ¥è¿”å›trueï¼Œè¯´æ˜å…¶ä»–çº¿ç¨‹å¢åŠ äº†ç´¢å¼•å±‚çº§ï¼ŒæŠŠç´¢å¼•å¤´èŠ‚ç‚¹è®¾ç½®å›æ¥</span></span><br><span class="line">        casHead(d, h);   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://my.oschina.net/u/3768341/blog/3135659">https://my.oschina.net/u/3768341/blog/3135659</a></p><p>å‚è€ƒè§†é¢‘ï¼š<a href="https://www.bilibili.com/video/BV1Er4y1P7k1">https://www.bilibili.com/video/BV1Er4y1P7k1</a></p><hr><h3 id="NoBlocking"><a href="#NoBlocking" class="headerlink" title="NoBlocking"></a>NoBlocking</h3><h4 id="éé˜»å¡é˜Ÿåˆ—"><a href="#éé˜»å¡é˜Ÿåˆ—" class="headerlink" title="éé˜»å¡é˜Ÿåˆ—"></a>éé˜»å¡é˜Ÿåˆ—</h4><p>å¹¶å‘ç¼–ç¨‹ä¸­ï¼Œéœ€è¦ç”¨åˆ°å®‰å…¨çš„é˜Ÿåˆ—ï¼Œå®ç°å®‰å…¨é˜Ÿåˆ—å¯ä»¥ä½¿ç”¨ 2 ç§æ–¹å¼ï¼š</p><ul><li>åŠ é”ï¼Œè¿™ç§å®ç°æ–¹å¼æ˜¯é˜»å¡é˜Ÿåˆ—</li><li>ä½¿ç”¨å¾ªç¯ CAS ç®—æ³•å®ç°ï¼Œè¿™ç§æ–¹å¼æ˜¯éé˜»å¡é˜Ÿåˆ—</li></ul><p>ConcurrentLinkedQueue æ˜¯ä¸€ä¸ªåŸºäºé“¾æ¥èŠ‚ç‚¹çš„æ— ç•Œçº¿ç¨‹å®‰å…¨é˜Ÿåˆ—ï¼Œé‡‡ç”¨å…ˆè¿›å…ˆå‡ºçš„è§„åˆ™å¯¹èŠ‚ç‚¹è¿›è¡Œæ’åºï¼Œå½“æ·»åŠ ä¸€ä¸ªå…ƒç´ æ—¶ï¼Œä¼šæ·»åŠ åˆ°é˜Ÿåˆ—çš„å°¾éƒ¨ï¼Œå½“è·å–ä¸€ä¸ªå…ƒç´ æ—¶ï¼Œä¼šè¿”å›é˜Ÿåˆ—å¤´éƒ¨çš„å…ƒç´ </p><p>è¡¥å……ï¼šConcurrentLinkedDeque æ˜¯åŒå‘é“¾è¡¨ç»“æ„çš„æ— ç•Œå¹¶å‘é˜Ÿåˆ—</p><p>ConcurrentLinkedQueue ä½¿ç”¨çº¦å®šï¼š</p><ol><li>ä¸å…è®¸ null å…¥åˆ—</li><li>é˜Ÿåˆ—ä¸­æ‰€æœ‰æœªåˆ é™¤çš„èŠ‚ç‚¹çš„ item éƒ½ä¸èƒ½ä¸º null ä¸”éƒ½èƒ½ä» head èŠ‚ç‚¹éå†åˆ°</li><li>åˆ é™¤èŠ‚ç‚¹æ˜¯å°† item è®¾ç½®ä¸º nullï¼Œé˜Ÿåˆ—è¿­ä»£æ—¶è·³è¿‡ item ä¸º null èŠ‚ç‚¹</li><li>head èŠ‚ç‚¹è·Ÿ tail ä¸ä¸€å®šæŒ‡å‘å¤´èŠ‚ç‚¹æˆ–å°¾èŠ‚ç‚¹ï¼Œå¯èƒ½<strong>å­˜åœ¨æ»åæ€§</strong></li></ol><p>ConcurrentLinkedQueue ç”± head èŠ‚ç‚¹å’Œ tail èŠ‚ç‚¹ç»„æˆï¼Œæ¯ä¸ªèŠ‚ç‚¹ç”±èŠ‚ç‚¹å…ƒç´ å’ŒæŒ‡å‘ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„å¼•ç”¨ç»„æˆï¼Œç»„æˆä¸€å¼ é“¾è¡¨ç»“æ„çš„é˜Ÿåˆ—</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> Node&lt;E&gt; head;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> Node&lt;E&gt; tail;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Node</span>&lt;E&gt; &#123;</span><br><span class="line">    <span class="keyword">volatile</span> E item;</span><br><span class="line">    <span class="keyword">volatile</span> Node&lt;E&gt; next;</span><br><span class="line">    <span class="comment">//.....</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><hr><h4 id="æ„é€ æ–¹æ³•-1"><a href="#æ„é€ æ–¹æ³•-1" class="headerlink" title="æ„é€ æ–¹æ³•"></a>æ„é€ æ–¹æ³•</h4><ul><li><p>æ— å‚æ„é€ æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ConcurrentLinkedQueue</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// é»˜è®¤æƒ…å†µä¸‹ head èŠ‚ç‚¹å­˜å‚¨çš„å…ƒç´ ä¸ºç©ºï¼Œdummy èŠ‚ç‚¹ï¼Œtail èŠ‚ç‚¹ç­‰äº head èŠ‚ç‚¹</span></span><br><span class="line">    head = tail = <span class="keyword">new</span> <span class="title class_">Node</span>&lt;E&gt;(<span class="literal">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>æœ‰å‚æ„é€ æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ConcurrentLinkedQueue</span><span class="params">(Collection&lt;? extends E&gt; c)</span> &#123;</span><br><span class="line">    Node&lt;E&gt; h = <span class="literal">null</span>, t = <span class="literal">null</span>;</span><br><span class="line">    <span class="comment">// éå†èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">for</span> (E e : c) &#123;</span><br><span class="line">        checkNotNull(e);</span><br><span class="line">        Node&lt;E&gt; newNode = <span class="keyword">new</span> <span class="title class_">Node</span>&lt;E&gt;(e);</span><br><span class="line">        <span class="keyword">if</span> (h == <span class="literal">null</span>)</span><br><span class="line">            h = t = newNode;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// å•å‘é“¾è¡¨</span></span><br><span class="line">            t.lazySetNext(newNode);</span><br><span class="line">            t = newNode;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (h == <span class="literal">null</span>)</span><br><span class="line">        h = t = <span class="keyword">new</span> <span class="title class_">Node</span>&lt;E&gt;(<span class="literal">null</span>);</span><br><span class="line">    head = h;</span><br><span class="line">    tail = t;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><hr><h4 id="å…¥é˜Ÿæ–¹æ³•"><a href="#å…¥é˜Ÿæ–¹æ³•" class="headerlink" title="å…¥é˜Ÿæ–¹æ³•"></a>å…¥é˜Ÿæ–¹æ³•</h4><p>ä¸ä¼ ç»Ÿçš„é“¾è¡¨ä¸åŒï¼Œå•çº¿ç¨‹å…¥é˜Ÿçš„å·¥ä½œæµç¨‹ï¼š</p><ul><li>å°†å…¥é˜ŸèŠ‚ç‚¹è®¾ç½®æˆå½“å‰é˜Ÿåˆ—å°¾èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹</li><li>æ›´æ–° tail èŠ‚ç‚¹ï¼Œå¦‚æœ tail èŠ‚ç‚¹çš„ next èŠ‚ç‚¹ä¸ä¸ºç©ºï¼Œåˆ™å°†å…¥é˜ŸèŠ‚ç‚¹è®¾ç½®æˆ tail èŠ‚ç‚¹ï¼›å¦‚æœ tail èŠ‚ç‚¹çš„ next èŠ‚ç‚¹ä¸ºç©ºï¼Œåˆ™å°†å…¥é˜ŸèŠ‚ç‚¹è®¾ç½®æˆ tail çš„ next èŠ‚ç‚¹ï¼Œæ‰€ä»¥ tail èŠ‚ç‚¹ä¸æ€»æ˜¯å°¾èŠ‚ç‚¹ï¼Œ<strong>å­˜åœ¨æ»åæ€§</strong></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">offer</span><span class="params">(E e)</span> &#123;</span><br><span class="line">    checkNotNull(e);</span><br><span class="line">    <span class="comment">// åˆ›å»ºå…¥é˜ŸèŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">final</span> Node&lt;E&gt; newNode = <span class="keyword">new</span> <span class="title class_">Node</span>&lt;E&gt;(e);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¾ªç¯ CAS ç›´åˆ°å…¥é˜ŸæˆåŠŸ</span></span><br><span class="line">    <span class="keyword">for</span> (Node&lt;E&gt; t = tail, p = t;;) &#123;</span><br><span class="line">        <span class="comment">// p ç”¨æ¥è¡¨ç¤ºé˜Ÿåˆ—çš„å°¾èŠ‚ç‚¹ï¼Œåˆå§‹æƒ…å†µä¸‹ç­‰äº tail èŠ‚ç‚¹ï¼Œq æ˜¯ p çš„ next èŠ‚ç‚¹</span></span><br><span class="line">        Node&lt;E&gt; q = p.next;</span><br><span class="line">        <span class="comment">// æ¡ä»¶æˆç«‹è¯´æ˜ p æ˜¯å°¾èŠ‚ç‚¹</span></span><br><span class="line">        <span class="keyword">if</span> (q == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="comment">// p æ˜¯å°¾èŠ‚ç‚¹ï¼Œè®¾ç½® p èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¸ºæ–°èŠ‚ç‚¹</span></span><br><span class="line">            <span class="comment">// è®¾ç½®æˆåŠŸåˆ™ casNext è¿”å› trueï¼Œå¦åˆ™è¿”å› falseï¼Œè¯´æ˜æœ‰å…¶ä»–çº¿ç¨‹æ›´æ–°è¿‡å°¾èŠ‚ç‚¹ï¼Œç»§ç»­å¯»æ‰¾å°¾èŠ‚ç‚¹ï¼Œç»§ç»­ CAS</span></span><br><span class="line">            <span class="keyword">if</span> (p.casNext(<span class="literal">null</span>, newNode)) &#123;</span><br><span class="line">                <span class="comment">// é¦–æ¬¡æ·»åŠ æ—¶ï¼Œp ç­‰äº tï¼Œä¸è¿›è¡Œå°¾èŠ‚ç‚¹æ›´æ–°ï¼Œæ‰€ä»¥å°¾èŠ‚ç‚¹å­˜åœ¨æ»åæ€§</span></span><br><span class="line">                <span class="keyword">if</span> (p != t)</span><br><span class="line">                    <span class="comment">// å°† tail è®¾ç½®æˆæ–°å…¥é˜Ÿçš„èŠ‚ç‚¹ï¼Œè®¾ç½®å¤±è´¥è¡¨ç¤ºå…¶ä»–çº¿ç¨‹æ›´æ–°äº† tail èŠ‚ç‚¹</span></span><br><span class="line">                    casTail(t, newNode); </span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (p == q)</span><br><span class="line">            <span class="comment">// å½“ tail ä¸æŒ‡å‘æœ€åèŠ‚ç‚¹æ—¶ï¼Œå¦‚æœæ‰§è¡Œå‡ºåˆ—æ“ä½œï¼Œå¯èƒ½å°† tail ä¹Ÿç§»é™¤ï¼Œtail ä¸åœ¨é“¾è¡¨ä¸­ </span></span><br><span class="line">        <span class="comment">// æ­¤æ—¶éœ€è¦å¯¹ tail èŠ‚ç‚¹è¿›è¡Œå¤ä½ï¼Œå¤ä½åˆ° head èŠ‚ç‚¹</span></span><br><span class="line">            p = (t != (t = tail)) ? t : head;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="comment">// æ¨åŠ¨ tail å°¾èŠ‚ç‚¹å¾€é˜Ÿå°¾ç§»åŠ¨</span></span><br><span class="line">            p = (p != t &amp;&amp; t != (t = tail)) ? t : q;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å›¾è§£å…¥é˜Ÿï¼š</p><p><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/JUC-ConcurrentLinkedQueue%E5%85%A5%E9%98%9F%E6%93%8D%E4%BD%9C1.png"></p><p><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/JUC-ConcurrentLinkedQueue%E5%85%A5%E9%98%9F%E6%93%8D%E4%BD%9C2.png"></p><p><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/JUC-ConcurrentLinkedQueue%E5%85%A5%E9%98%9F%E6%93%8D%E4%BD%9C3.png"></p><p>å½“ tail èŠ‚ç‚¹å’Œå°¾èŠ‚ç‚¹çš„è·ç¦»<strong>å¤§äºç­‰äº 1</strong> æ—¶ï¼ˆæ¯å…¥é˜Ÿä¸¤æ¬¡ï¼‰æ›´æ–° tailï¼Œå¯ä»¥å‡å°‘ CAS æ›´æ–° tail èŠ‚ç‚¹çš„æ¬¡æ•°ï¼Œæé«˜å…¥é˜Ÿæ•ˆç‡</p><p>çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼š</p><ul><li>çº¿ç¨‹ 1 çº¿ç¨‹ 2 åŒæ—¶å…¥é˜Ÿï¼Œæ— è®ºä»å“ªä¸ªä½ç½®å¼€å§‹å¹¶å‘å…¥é˜Ÿï¼Œéƒ½å¯ä»¥å¾ªç¯ CASï¼Œç›´åˆ°å…¥é˜ŸæˆåŠŸï¼Œçº¿ç¨‹å®‰å…¨</li><li>çº¿ç¨‹ 1 éå†ï¼Œçº¿ç¨‹ 2 å…¥é˜Ÿï¼Œæ‰€ä»¥é€ æˆ ConcurrentLinkedQueue çš„ size æ˜¯å˜åŒ–ï¼Œéœ€è¦åŠ é”ä¿è¯å®‰å…¨</li><li>çº¿ç¨‹ 1 çº¿ç¨‹ 2 åŒæ—¶å‡ºåˆ—ï¼Œçº¿ç¨‹ä¹Ÿæ˜¯å®‰å…¨çš„</li></ul><hr><h4 id="å‡ºé˜Ÿæ–¹æ³•"><a href="#å‡ºé˜Ÿæ–¹æ³•" class="headerlink" title="å‡ºé˜Ÿæ–¹æ³•"></a>å‡ºé˜Ÿæ–¹æ³•</h4><p>å‡ºé˜Ÿåˆ—çš„å°±æ˜¯ä»é˜Ÿåˆ—é‡Œè¿”å›ä¸€ä¸ªèŠ‚ç‚¹å…ƒç´ ï¼Œå¹¶æ¸…ç©ºè¯¥èŠ‚ç‚¹å¯¹å…ƒç´ çš„å¼•ç”¨ï¼Œå¹¶ä¸æ˜¯æ¯æ¬¡å‡ºé˜Ÿéƒ½æ›´æ–° head èŠ‚ç‚¹</p><ul><li>å½“ head èŠ‚ç‚¹é‡Œæœ‰å…ƒç´ æ—¶ï¼Œç›´æ¥å¼¹å‡º head èŠ‚ç‚¹é‡Œçš„å…ƒç´ ï¼Œè€Œä¸ä¼šæ›´æ–° head èŠ‚ç‚¹</li><li>å½“ head èŠ‚ç‚¹é‡Œæ²¡æœ‰å…ƒç´ æ—¶ï¼Œå‡ºé˜Ÿæ“ä½œæ‰ä¼šæ›´æ–° head èŠ‚ç‚¹</li></ul><p><strong>æ‰¹å¤„ç†æ–¹å¼</strong>å¯ä»¥å‡å°‘ä½¿ç”¨ CAS æ›´æ–° head èŠ‚ç‚¹çš„æ¶ˆè€—ï¼Œä»è€Œæé«˜å‡ºé˜Ÿæ•ˆç‡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> E <span class="title function_">poll</span><span class="params">()</span> &#123;</span><br><span class="line">    restartFromHead:</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="comment">// p èŠ‚ç‚¹è¡¨ç¤ºé¦–èŠ‚ç‚¹ï¼Œå³éœ€è¦å‡ºé˜Ÿçš„èŠ‚ç‚¹ï¼ŒFIFO</span></span><br><span class="line">        <span class="keyword">for</span> (Node&lt;E&gt; h = head, p = h, q;;) &#123;</span><br><span class="line">            <span class="type">E</span> <span class="variable">item</span> <span class="operator">=</span> p.item;</span><br><span class="line"><span class="comment">// å¦‚æœ p èŠ‚ç‚¹çš„å…ƒç´ ä¸ä¸º nullï¼Œåˆ™é€šè¿‡ CAS æ¥è®¾ç½® p èŠ‚ç‚¹å¼•ç”¨å…ƒç´ ä¸º nullï¼ŒæˆåŠŸè¿”å› item</span></span><br><span class="line">            <span class="keyword">if</span> (item != <span class="literal">null</span> &amp;&amp; p.casItem(item, <span class="literal">null</span>)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (p != h)</span><br><span class="line">                   <span class="comment">// å¯¹ head è¿›è¡Œç§»åŠ¨</span></span><br><span class="line">                    updateHead(h, ((q = p.next) != <span class="literal">null</span>) ? q : p);</span><br><span class="line">                <span class="keyword">return</span> item;</span><br><span class="line">            &#125;</span><br><span class="line">           <span class="comment">// é€»è¾‘åˆ°è¿™è¯´æ˜å¤´èŠ‚ç‚¹çš„å…ƒç´ ä¸ºç©ºæˆ–å¤´èŠ‚ç‚¹å‘ç”Ÿäº†å˜åŒ–ï¼Œå¤´èŠ‚ç‚¹è¢«å¦å¤–ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†</span></span><br><span class="line">            <span class="comment">// é‚£ä¹ˆè·å– p èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¦‚æœ p èŠ‚ç‚¹çš„ä¸‹ä¸€èŠ‚ç‚¹ä¹Ÿä¸º nullï¼Œåˆ™è¡¨æ˜é˜Ÿåˆ—å·²ç»ç©ºäº†</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> ((q = p.next) == <span class="literal">null</span>) &#123;</span><br><span class="line">                updateHead(h, p);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">      <span class="comment">// ç¬¬ä¸€è½®æ“ä½œå¤±è´¥ï¼Œä¸‹ä¸€è½®ç»§ç»­ï¼Œè°ƒå›åˆ°å¾ªç¯å‰</span></span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (p == q)</span><br><span class="line">                <span class="keyword">continue</span> restartFromHead;</span><br><span class="line">            <span class="comment">// å¦‚æœä¸‹ä¸€ä¸ªå…ƒç´ ä¸ä¸ºç©ºï¼Œåˆ™å°†å¤´èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹è®¾ç½®æˆå¤´èŠ‚ç‚¹</span></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                p = q;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">updateHead</span><span class="params">(Node&lt;E&gt; h, Node&lt;E&gt; p)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (h != p &amp;&amp; casHead(h, p))</span><br><span class="line">        <span class="comment">// å°†æ—§ç»“ç‚¹ h çš„ next åŸŸæŒ‡å‘ä¸º hï¼Œhelp gc</span></span><br><span class="line">        h.lazySetNext(h);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨æ›´æ–°å®Œ head ä¹‹åï¼Œä¼šå°†æ—§çš„å¤´ç»“ç‚¹ h çš„ next åŸŸæŒ‡å‘ä¸º hï¼Œå›¾ä¸­æ‰€ç¤ºçš„è™šçº¿ä¹Ÿå°±è¡¨ç¤ºè¿™ä¸ªèŠ‚ç‚¹çš„è‡ªå¼•ç”¨ï¼Œè¢«ç§»åŠ¨çš„èŠ‚ç‚¹ï¼ˆitem ä¸º null çš„èŠ‚ç‚¹ï¼‰ä¼šè¢« GC å›æ”¶</p><p><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/JUC-ConcurrentLinkedQueue%E5%87%BA%E9%98%9F%E6%93%8D%E4%BD%9C1.png"></p><p><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/JUC-ConcurrentLinkedQueue%E5%87%BA%E9%98%9F%E6%93%8D%E4%BD%9C2.png"></p><p><img src="https://seazean.oss-cn-beijing.aliyuncs.com/img/Java/JUC-ConcurrentLinkedQueue%E5%87%BA%E9%98%9F%E6%93%8D%E4%BD%9C3.png"></p><p>å¦‚æœè¿™æ—¶ï¼Œæœ‰ä¸€ä¸ªçº¿ç¨‹æ¥æ·»åŠ å…ƒç´ ï¼Œé€šè¿‡ tail è·å–çš„ next èŠ‚ç‚¹åˆ™ä»ç„¶æ˜¯å®ƒæœ¬èº«ï¼Œè¿™å°±å‡ºç°äº†p &#x3D;&#x3D; q çš„æƒ…å†µï¼Œå‡ºç°è¯¥ç§æƒ…å†µä¹‹åï¼Œåˆ™ä¼šè§¦å‘æ‰§è¡Œ head çš„æ›´æ–°ï¼Œå°† p èŠ‚ç‚¹é‡æ–°æŒ‡å‘ä¸º head</p><p>å‚è€ƒæ–‡ç« ï¼š<a href="https://www.jianshu.com/p/231caf90f30b">https://www.jianshu.com/p/231caf90f30b</a></p><hr><h4 id="æˆå‘˜æ–¹æ³•-8"><a href="#æˆå‘˜æ–¹æ³•-8" class="headerlink" title="æˆå‘˜æ–¹æ³•"></a>æˆå‘˜æ–¹æ³•</h4><ul><li><p>peek()ï¼šä¼šæ”¹å˜ head æŒ‡å‘ï¼Œæ‰§è¡Œ peek() æ–¹æ³•å head ä¼šæŒ‡å‘ç¬¬ä¸€ä¸ªå…·æœ‰éç©ºå…ƒç´ çš„èŠ‚ç‚¹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è·å–é“¾è¡¨çš„é¦–éƒ¨å…ƒç´ ï¼Œåªè¯»å–è€Œä¸ç§»é™¤</span></span><br><span class="line"><span class="keyword">public</span> E <span class="title function_">peek</span><span class="params">()</span> &#123;</span><br><span class="line">    restartFromHead:</span><br><span class="line">    <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">        <span class="keyword">for</span> (Node&lt;E&gt; h = head, p = h, q;;) &#123;</span><br><span class="line">            <span class="type">E</span> <span class="variable">item</span> <span class="operator">=</span> p.item;</span><br><span class="line">            <span class="keyword">if</span> (item != <span class="literal">null</span> || (q = p.next) == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// æ›´æ”¹hçš„ä½ç½®ä¸ºéç©ºå…ƒç´ èŠ‚ç‚¹</span></span><br><span class="line">                updateHead(h, p);</span><br><span class="line">                <span class="keyword">return</span> item;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span> (p == q)</span><br><span class="line">                <span class="keyword">continue</span> restartFromHead;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                p = q;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>size()ï¼šç”¨æ¥è·å–å½“å‰é˜Ÿåˆ—çš„å…ƒç´ ä¸ªæ•°ï¼Œå› ä¸ºæ•´ä¸ªè¿‡ç¨‹éƒ½æ²¡æœ‰åŠ é”ï¼Œåœ¨å¹¶å‘ç¯å¢ƒä¸­ä»è°ƒç”¨ size æ–¹æ³•åˆ°è¿”å›ç»“æœæœŸé—´æœ‰å¯èƒ½å¢åˆ å…ƒç´ ï¼Œå¯¼è‡´ç»Ÿè®¡çš„å…ƒç´ ä¸ªæ•°ä¸ç²¾ç¡®</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">size</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// first() è·å–ç¬¬ä¸€ä¸ªå…·æœ‰éç©ºå…ƒç´ çš„èŠ‚ç‚¹ï¼Œè‹¥ä¸å­˜åœ¨ï¼Œè¿”å› null</span></span><br><span class="line">    <span class="comment">// succ(p) æ–¹æ³•è·å– p çš„åç»§èŠ‚ç‚¹ï¼Œè‹¥ p == p.nextï¼Œåˆ™è¿”å› head</span></span><br><span class="line">    <span class="comment">// ç±»ä¼¼éå†é“¾è¡¨</span></span><br><span class="line">    <span class="keyword">for</span> (Node&lt;E&gt; p = first(); p != <span class="literal">null</span>; p = succ(p))</span><br><span class="line">        <span class="keyword">if</span> (p.item != <span class="literal">null</span>)</span><br><span class="line">            <span class="comment">// æœ€å¤§è¿”å›Integer.MAX_VALUE</span></span><br><span class="line">            <span class="keyword">if</span> (++count == Integer.MAX_VALUE)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">return</span> count;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>remove()ï¼šç§»é™¤å…ƒç´ </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">remove</span><span class="params">(Object o)</span> &#123;</span><br><span class="line">    <span class="comment">// åˆ é™¤çš„å…ƒç´ ä¸èƒ½ä¸ºnull</span></span><br><span class="line">    <span class="keyword">if</span> (o != <span class="literal">null</span>) &#123;</span><br><span class="line">        Node&lt;E&gt; next, pred = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">for</span> (Node&lt;E&gt; p = first(); p != <span class="literal">null</span>; pred = p, p = next) &#123;</span><br><span class="line">            <span class="type">boolean</span> <span class="variable">removed</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">            <span class="type">E</span> <span class="variable">item</span> <span class="operator">=</span> p.item;</span><br><span class="line">            <span class="comment">// èŠ‚ç‚¹å…ƒç´ ä¸ä¸ºnull</span></span><br><span class="line">            <span class="keyword">if</span> (item != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// è‹¥ä¸åŒ¹é…ï¼Œåˆ™è·å–nextèŠ‚ç‚¹ç»§ç»­åŒ¹é…</span></span><br><span class="line">                <span class="keyword">if</span> (!o.equals(item)) &#123;</span><br><span class="line">                    next = succ(p);</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// è‹¥åŒ¹é…ï¼Œåˆ™é€šè¿‡ CAS æ“ä½œå°†å¯¹åº”èŠ‚ç‚¹å…ƒç´ ç½®ä¸º null</span></span><br><span class="line">                removed = p.casItem(item, <span class="literal">null</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// è·å–åˆ é™¤èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹</span></span><br><span class="line">            next = succ(p);</span><br><span class="line">            <span class="comment">// å°†è¢«åˆ é™¤çš„èŠ‚ç‚¹ç§»é™¤é˜Ÿåˆ—</span></span><br><span class="line">            <span class="keyword">if</span> (pred != <span class="literal">null</span> &amp;&amp; next != <span class="literal">null</span>) <span class="comment">// unlink</span></span><br><span class="line">                pred.casNext(p, next);</span><br><span class="line">            <span class="keyword">if</span> (removed)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul>]]></content>
      
      
      <categories>
          
          <category> JUC </category>
          
          <category> å¹¶å‘ç¼–ç¨‹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JUC </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>00_MysqlåŸºç¡€ç¯‡</title>
      <link href="/2023/03/04/00-Mysql%E5%9F%BA%E7%A1%80%E7%AF%87/"/>
      <url>/2023/03/04/00-Mysql%E5%9F%BA%E7%A1%80%E7%AF%87/</url>
      
        <content type="html"><![CDATA[<h1 id="å¯¼å…¥è¡¨çš„é—®é¢˜"><a href="#å¯¼å…¥è¡¨çš„é—®é¢˜" class="headerlink" title="å¯¼å…¥è¡¨çš„é—®é¢˜"></a>å¯¼å…¥è¡¨çš„é—®é¢˜</h1><p><strong>å¯¼å…¥æ•°æ®æ—¶å¤–é”®çº¦æŸé—®é¢˜</strong></p><p>æ•°æ®å¯¼å…¥æŒ‡ä»¤ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source d:\xxx.sql</span><br></pre></td></tr></table></figure><p>é€šè¿‡FOREIGN_KEY_CHECKSè§£å†³ï¼Œç”¨æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">set FOREIGN_KEY_CHECKS=0;  #åœ¨å¯¼å…¥å‰è®¾ç½®ä¸ºä¸æ£€æŸ¥å¤–é”®çº¦æŸ</span><br><span class="line">set FOREIGN_KEY_CHECKS=1;  #åœ¨å¯¼å…¥åæ¢å¤æ£€æŸ¥å¤–é”®çº¦æŸ</span><br></pre></td></tr></table></figure><h1 id="ç¬¬ä¸‰ç« -æœ€åŸºæœ¬çš„SELECTè¯­å¥"><a href="#ç¬¬ä¸‰ç« -æœ€åŸºæœ¬çš„SELECTè¯­å¥" class="headerlink" title="ç¬¬ä¸‰ç« _æœ€åŸºæœ¬çš„SELECTè¯­å¥"></a>ç¬¬ä¸‰ç« _æœ€åŸºæœ¬çš„SELECTè¯­å¥</h1><h2 id="1-SQLè¯­è¨€çš„è§„åˆ™å’Œè§„èŒƒ"><a href="#1-SQLè¯­è¨€çš„è§„åˆ™å’Œè§„èŒƒ" class="headerlink" title="1. SQLè¯­è¨€çš„è§„åˆ™å’Œè§„èŒƒ"></a>1. SQLè¯­è¨€çš„è§„åˆ™å’Œè§„èŒƒ</h2><h3 id="1-åŸºæœ¬è§„åˆ™"><a href="#1-åŸºæœ¬è§„åˆ™" class="headerlink" title="1) åŸºæœ¬è§„åˆ™"></a>1) åŸºæœ¬è§„åˆ™</h3><ul><li>SQL å¯ä»¥å†™åœ¨ä¸€è¡Œæˆ–è€…å¤šè¡Œã€‚ä¸ºäº†æé«˜å¯è¯»æ€§ï¼Œå„å­å¥åˆ†è¡Œå†™ï¼Œå¿…è¦æ—¶ä½¿ç”¨ç¼©è¿› </li><li>æ¯æ¡å‘½ä»¤ä»¥ ; æˆ– \g æˆ– \G ç»“æŸ </li><li>å…³é”®å­—ä¸èƒ½è¢«ç¼©å†™ä¹Ÿä¸èƒ½åˆ†è¡Œ </li><li>å…³äºæ ‡ç‚¹ç¬¦å· <ul><li>å¿…é¡»ä¿è¯æ‰€æœ‰çš„()ã€å•å¼•å·ã€åŒå¼•å·æ˜¯æˆå¯¹ç»“æŸçš„ </li><li>å¿…é¡»ä½¿ç”¨è‹±æ–‡çŠ¶æ€ä¸‹çš„åŠè§’è¾“å…¥æ–¹å¼ </li><li>å­—ç¬¦ä¸²å‹å’Œæ—¥æœŸæ—¶é—´ç±»å‹çš„æ•°æ®å¯ä»¥ä½¿ç”¨å•å¼•å·ï¼ˆâ€™ â€˜ï¼‰è¡¨ç¤º </li><li>åˆ—çš„åˆ«åï¼Œå°½é‡ä½¿ç”¨åŒå¼•å·ï¼ˆâ€ â€œï¼‰ï¼Œè€Œä¸”ä¸å»ºè®®çœç•¥as</li></ul></li></ul><h3 id="2-SQLå¤§å°å†™è§„èŒƒï¼ˆå»ºè®®éµå®ˆï¼‰"><a href="#2-SQLå¤§å°å†™è§„èŒƒï¼ˆå»ºè®®éµå®ˆï¼‰" class="headerlink" title="2) SQLå¤§å°å†™è§„èŒƒï¼ˆå»ºè®®éµå®ˆï¼‰"></a>2) SQLå¤§å°å†™è§„èŒƒï¼ˆå»ºè®®éµå®ˆï¼‰</h3><ul><li>MySQL åœ¨ Windows ç¯å¢ƒä¸‹æ˜¯å¤§å°å†™ä¸æ•æ„Ÿçš„ </li><li>MySQL åœ¨ Linux ç¯å¢ƒä¸‹æ˜¯å¤§å°å†™æ•æ„Ÿçš„ <ul><li>æ•°æ®åº“åã€è¡¨åã€è¡¨çš„åˆ«åã€å˜é‡åæ˜¯ä¸¥æ ¼åŒºåˆ†å¤§å°å†™çš„ </li><li>å…³é”®å­—ã€å‡½æ•°åã€åˆ—å(æˆ–å­—æ®µå)ã€åˆ—çš„åˆ«å(å­—æ®µçš„åˆ«å) æ˜¯å¿½ç•¥å¤§å°å†™çš„ã€‚</li></ul></li><li>æ¨èé‡‡ç”¨ç»Ÿä¸€çš„ä¹¦å†™è§„èŒƒï¼š <ul><li>æ•°æ®åº“åã€è¡¨åã€è¡¨åˆ«åã€å­—æ®µåã€å­—æ®µåˆ«åç­‰éƒ½å°å†™ </li><li>SQL å…³é”®å­—ã€å‡½æ•°åã€ç»‘å®šå˜é‡ç­‰éƒ½å¤§å†™</li></ul></li></ul><h3 id="3-æ³¨é‡Š"><a href="#3-æ³¨é‡Š" class="headerlink" title="3) æ³¨é‡Š"></a>3) æ³¨é‡Š</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">å•è¡Œæ³¨é‡Šï¼š#æ³¨é‡Šæ–‡å­—(MySQLç‰¹æœ‰çš„æ–¹å¼)</span><br><span class="line">å•è¡Œæ³¨é‡Šï¼š-- æ³¨é‡Šæ–‡å­—(--åé¢å¿…é¡»åŒ…å«ä¸€ä¸ªç©ºæ ¼ã€‚)</span><br><span class="line">å¤šè¡Œæ³¨é‡Šï¼š/* æ³¨é‡Šæ–‡å­— */</span><br></pre></td></tr></table></figure><h3 id="4-å‘½åè§„åˆ™"><a href="#4-å‘½åè§„åˆ™" class="headerlink" title="4) å‘½åè§„åˆ™"></a>4) å‘½åè§„åˆ™</h3><ul><li>æ•°æ®åº“ã€è¡¨åä¸å¾—è¶…è¿‡30ä¸ªå­—ç¬¦ï¼Œå˜é‡åé™åˆ¶ä¸º29ä¸ª </li><li>å¿…é¡»åªèƒ½åŒ…å« Aâ€“Z, aâ€“z, 0â€“9, _å…±63ä¸ªå­—ç¬¦ </li><li>æ•°æ®åº“åã€è¡¨åã€å­—æ®µåç­‰å¯¹è±¡åä¸­é—´ä¸è¦åŒ…å«ç©ºæ ¼ åŒä¸€ä¸ªMySQLè½¯ä»¶ä¸­ï¼Œæ•°æ®åº“ä¸èƒ½åŒåï¼›åŒä¸€ä¸ªåº“ä¸­ï¼Œè¡¨ä¸èƒ½é‡åï¼›</li><li>åŒä¸€ä¸ªè¡¨ä¸­ï¼Œå­—æ®µä¸èƒ½é‡å å¿…é¡»ä¿è¯ä½ çš„å­—æ®µæ²¡æœ‰å’Œä¿ç•™å­—ã€æ•°æ®åº“ç³»ç»Ÿæˆ–å¸¸ç”¨æ–¹æ³•å†²çªã€‚å¦‚æœåšæŒä½¿ç”¨ï¼Œè¯·åœ¨SQLè¯­å¥ä¸­ä½¿ ç”¨&#96;ï¼ˆç€é‡å·ï¼‰å¼•èµ·æ¥ </li><li>ä¿æŒå­—æ®µåå’Œç±»å‹çš„ä¸€è‡´æ€§ï¼Œåœ¨å‘½åå­—æ®µå¹¶ä¸ºå…¶æŒ‡å®šæ•°æ®ç±»å‹çš„æ—¶å€™ä¸€å®šè¦ä¿è¯ä¸€è‡´æ€§ã€‚å‡å¦‚æ•°æ® ç±»å‹åœ¨ä¸€ä¸ªè¡¨é‡Œæ˜¯æ•´æ•°ï¼Œé‚£åœ¨å¦ä¸€ä¸ªè¡¨é‡Œå¯å°±åˆ«å˜æˆå­—ç¬¦å‹äº†</li></ul><h2 id="2-åŸºæœ¬çš„SELECTè¯­å¥"><a href="#2-åŸºæœ¬çš„SELECTè¯­å¥" class="headerlink" title="2. åŸºæœ¬çš„SELECTè¯­å¥"></a>2. åŸºæœ¬çš„SELECTè¯­å¥</h2><h3 id="1-SELECT-â€¦-FROM"><a href="#1-SELECT-â€¦-FROM" class="headerlink" title="1) SELECT â€¦ FROM"></a>1) SELECT â€¦ FROM</h3><ul><li>è¯­æ³•</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT æ ‡è¯†é€‰æ‹©å“ªäº›åˆ—</span><br><span class="line">FROM æ ‡è¯†ä»å“ªä¸ªè¡¨ä¸­é€‰æ‹©</span><br></pre></td></tr></table></figure><ul><li>é€‰æ‹©å…¨éƒ¨åˆ—</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT *</span><br><span class="line">FROM departments;</span><br></pre></td></tr></table></figure><ul><li>é€‰æ‹©ç‰¹å®šçš„åˆ—ï¼š</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT department_id, location_id</span><br><span class="line">FROM departments;</span><br></pre></td></tr></table></figure><h3 id="2-åˆ—çš„åˆ«å"><a href="#2-åˆ—çš„åˆ«å" class="headerlink" title="2) åˆ—çš„åˆ«å"></a>2) åˆ—çš„åˆ«å</h3><ul><li>é‡å‘½åä¸€ä¸ªåˆ— </li><li>ä¾¿äºè®¡ç®— </li><li>ç´§è·Ÿåˆ—åï¼Œä¹Ÿå¯ä»¥åœ¨åˆ—åå’Œåˆ«åä¹‹é—´åŠ å…¥å…³é”®å­—ASï¼Œåˆ«åä½¿ç”¨åŒå¼•å·ï¼Œä»¥ä¾¿åœ¨åˆ«åä¸­åŒ…å«ç©ºæ ¼æˆ–ç‰¹ æ®Šçš„å­—ç¬¦å¹¶åŒºåˆ†å¤§å°å†™ã€‚ </li><li>AS å¯ä»¥çœç•¥ </li><li>å»ºè®®åˆ«åç®€çŸ­ï¼Œè§åçŸ¥æ„ </li><li>ä¸¾ä¾‹ï¼š</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT last_name AS name, commission_pct comm</span><br><span class="line">FROM employees;</span><br></pre></td></tr></table></figure><h3 id="3-å»é™¤é‡å¤è¡Œ"><a href="#3-å»é™¤é‡å¤è¡Œ" class="headerlink" title="3) å»é™¤é‡å¤è¡Œ"></a>3) å»é™¤é‡å¤è¡Œ</h3><p>DISTINCTå…³é”®å­—</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT DISTINCT department_id FROM employees;</span><br></pre></td></tr></table></figure><h3 id="4-ç©ºå€¼å‚ä¸è¿ç®—"><a href="#4-ç©ºå€¼å‚ä¸è¿ç®—" class="headerlink" title="4) ç©ºå€¼å‚ä¸è¿ç®—"></a>4) ç©ºå€¼å‚ä¸è¿ç®—</h3><p>ç©ºå€¼ï¼šnull ( ä¸ç­‰åŒäº0, â€™ â€˜, â€™nullâ€˜ )</p><p>å®é™…é—®é¢˜çš„è§£å†³æ–¹æ¡ˆï¼šå¼•å…¥IFNULL</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT employee_id, salary &quot;æœˆå·¥èµ„&quot;, salary * (1 + IFNULL(commission_pct, 0)) * 12 &quot;å¹´å·¥èµ„&quot; FROM employees;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä½ ä¸€å®šè¦æ³¨æ„ï¼Œåœ¨ MySQL é‡Œé¢ï¼Œ ç©ºå€¼ä¸ç­‰äºç©ºå­—ç¬¦ä¸²ã€‚ä¸€ä¸ªç©ºå­—ç¬¦ä¸²çš„é•¿åº¦æ˜¯ 0ï¼Œè€Œä¸€ä¸ªç©ºå€¼çš„é•¿ åº¦æ˜¯ç©ºã€‚è€Œä¸”ï¼Œåœ¨ MySQL é‡Œé¢ï¼Œç©ºå€¼æ˜¯å ç”¨ç©ºé—´çš„ã€‚</p><h3 id="5-ç€é‡å·-96-96"><a href="#5-ç€é‡å·-96-96" class="headerlink" title="5) ç€é‡å· &#96;&#96;"></a>5) ç€é‡å· &#96;&#96;</h3><p>å¿…é¡»ä¿è¯ä½ çš„å­—æ®µæ²¡æœ‰å’Œä¿ç•™å­—ã€æ•°æ®åº“ç³»ç»Ÿæˆ–å¸¸è§æ–¹æ³•å†²çªã€‚</p><p>å¦‚æœåšæŒä½¿ç”¨ï¼Œåœ¨SQLè¯­å¥ä¸­ä½¿ç”¨ ` ` å¼•èµ·æ¥ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM `order`;</span><br></pre></td></tr></table></figure><h3 id="6-æŸ¥è¯¢å¸¸æ•°"><a href="#6-æŸ¥è¯¢å¸¸æ•°" class="headerlink" title="6) æŸ¥è¯¢å¸¸æ•°"></a>6) æŸ¥è¯¢å¸¸æ•°</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT &#x27;å°å¼ ç§‘æŠ€&#x27; as &quot;å…¬å¸å&quot;, employee_id, last_name FROM employees;</span><br></pre></td></tr></table></figure><h2 id="3-æ˜¾ç¤ºè¡¨ç»“æ„"><a href="#3-æ˜¾ç¤ºè¡¨ç»“æ„" class="headerlink" title="3. æ˜¾ç¤ºè¡¨ç»“æ„"></a>3. æ˜¾ç¤ºè¡¨ç»“æ„</h2><p>æ˜¾ç¤ºè¡¨ä¸­å­—æ®µçš„è¯¦ç»†ä¿¡æ¯</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">DESCRIBE employees;</span><br><span class="line">æˆ–</span><br><span class="line">DESC employees;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; desc employees;</span><br><span class="line">+----------------+-------------+------+-----+---------+-------+</span><br><span class="line">| Field | Type | Null | Key | Default | Extra |</span><br><span class="line">+----------------+-------------+------+-----+---------+-------+</span><br><span class="line">| employee_id | int(6) | NO | PRI | 0 | |</span><br><span class="line">| first_name | varchar(20) | YES | | NULL | |</span><br><span class="line">| last_name | varchar(25) | NO | | NULL | |</span><br><span class="line">| email | varchar(25) | NO | UNI | NULL | |</span><br><span class="line">| phone_number | varchar(20) | YES | | NULL | |</span><br><span class="line">| hire_date | date | NO | | NULL | |</span><br><span class="line">| job_id | varchar(10) | NO | MUL | NULL | |</span><br><span class="line">| salary | double(8,2) | YES | | NULL | |</span><br><span class="line">| commission_pct | double(2,2) | YES | | NULL | |</span><br><span class="line">| manager_id | int(6) | YES | MUL | NULL | |</span><br><span class="line">| department_id | int(4) | YES | MUL | NULL | |</span><br><span class="line">+----------------+-------------+------+-----+---------+-------+</span><br><span class="line">11 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ï¼Œå„ä¸ªå­—æ®µçš„å«ä¹‰åˆ†åˆ«è§£é‡Šå¦‚ä¸‹ï¼š </p><ul><li>Fieldï¼šè¡¨ç¤ºå­—æ®µåç§°ã€‚ </li><li>Typeï¼šè¡¨ç¤ºå­—æ®µç±»å‹ï¼Œè¿™é‡Œ barcodeã€goodsname æ˜¯æ–‡æœ¬å‹çš„ï¼Œprice æ˜¯æ•´æ•°ç±»å‹çš„ã€‚ </li><li>Nullï¼šè¡¨ç¤ºè¯¥åˆ—æ˜¯å¦å¯ä»¥å­˜å‚¨NULLå€¼ã€‚ </li><li>Keyï¼šè¡¨ç¤ºè¯¥åˆ—æ˜¯å¦å·²ç¼–åˆ¶ç´¢å¼•ã€‚</li><li>PRIè¡¨ç¤ºè¯¥åˆ—æ˜¯è¡¨ä¸»é”®çš„ä¸€éƒ¨åˆ†ï¼›</li><li>UNIè¡¨ç¤ºè¯¥åˆ—æ˜¯UNIQUEç´¢å¼•çš„ä¸€ éƒ¨åˆ†ï¼›</li><li>MULè¡¨ç¤ºåœ¨åˆ—ä¸­æŸä¸ªç»™å®šå€¼å…è®¸å‡ºç°å¤šæ¬¡ã€‚ </li><li>Defaultï¼šè¡¨ç¤ºè¯¥åˆ—æ˜¯å¦æœ‰é»˜è®¤å€¼ï¼Œå¦‚æœæœ‰ï¼Œé‚£ä¹ˆå€¼æ˜¯å¤šå°‘ã€‚ </li><li>Extraï¼šè¡¨ç¤ºå¯ä»¥è·å–çš„ä¸ç»™å®šåˆ—æœ‰å…³çš„é™„åŠ ä¿¡æ¯ï¼Œä¾‹å¦‚AUTO_INCREMENTç­‰ã€‚</li></ul><h2 id="4-è¿‡æ»¤æ•°æ®"><a href="#4-è¿‡æ»¤æ•°æ®" class="headerlink" title="4. è¿‡æ»¤æ•°æ®"></a>4. è¿‡æ»¤æ•°æ®</h2><ul><li>è¯­æ³•ï¼š</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SELECT å­—æ®µ1,å­—æ®µ2</span><br><span class="line">FROM è¡¨å</span><br><span class="line">WHERE è¿‡æ»¤æ¡ä»¶</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨WHERE å­å¥ï¼Œå°†ä¸æ»¡è¶³æ¡ä»¶çš„è¡Œè¿‡æ»¤æ‰ã€‚WHEREå­å¥ç´§éš FROMå­å¥ã€‚</p><ul><li>ä¸¾ä¾‹ï¼š</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SELECT employee_id, last_name, job_id, department_id</span><br><span class="line">FROM employees</span><br><span class="line">WHERE department_id = 90;</span><br></pre></td></tr></table></figure><h1 id="ç¬¬å››ç« -è¿ç®—ç¬¦"><a href="#ç¬¬å››ç« -è¿ç®—ç¬¦" class="headerlink" title="ç¬¬å››ç« _è¿ç®—ç¬¦"></a>ç¬¬å››ç« _è¿ç®—ç¬¦</h1><p><strong>DUAL</strong> ä¼ªè¡¨</p><h2 id="1-ç®—æœ¯è¿ç®—ç¬¦"><a href="#1-ç®—æœ¯è¿ç®—ç¬¦" class="headerlink" title="1. ç®—æœ¯è¿ç®—ç¬¦"></a>1. ç®—æœ¯è¿ç®—ç¬¦</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT 100 + 0, 100 + 50 * 30, 100 - 35.5 FROM DUAL;</span><br></pre></td></tr></table></figure><blockquote><ul><li>ä¸€ä¸ªæ•´æ•°ç±»å‹çš„å€¼å¯¹æ•´æ•°è¿›è¡ŒåŠ æ³•å’Œå‡æ³•æ“ä½œï¼Œç»“æœè¿˜æ˜¯ä¸€ä¸ªæ•´æ•°ï¼›</li><li>ä¸€ä¸ªæ•´æ•°ç±»å‹çš„å€¼å¯¹æµ®ç‚¹æ•°è¿›è¡ŒåŠ æ³•å’Œå‡æ³•æ“ä½œï¼Œç»“æœæ˜¯ä¸€ä¸ªæµ®ç‚¹æ•°ï¼›</li><li>åœ¨Javaä¸­ï¼Œ + çš„å·¦å³ä¸¤è¾¹å¦‚æœæœ‰å­—ç¬¦ä¸²ï¼Œé‚£ä¹ˆè¡¨ç¤ºå­—ç¬¦ä¸²çš„æ‹¼æ¥ã€‚ä½†æ˜¯åœ¨MySQLä¸­ + åªè¡¨ç¤ºæ•°å€¼ç›¸åŠ ã€‚å¦‚æœé‡åˆ°éæ•°å€¼ç±»å‹ï¼Œå…ˆå°è¯•è½¬æˆæ•°å€¼ï¼Œå¦‚æœè½¬å¤±è´¥ï¼Œå°±æŒ‰0è®¡ç®—ã€‚ï¼ˆæ³¨ï¼šMySQL ä¸­å­—ç¬¦ä¸²æ‹¼æ¥è¦ä½¿ç”¨å­—ç¬¦ä¸²å‡½æ•°CONCAT()å®ç°ï¼‰</li><li>åœ¨æ•°å­¦è¿ç®—ä¸­ï¼Œ0ä¸èƒ½ç”¨ä½œé™¤æ•°ï¼Œåœ¨MySQLä¸­ï¼Œä¸€ä¸ªæ•°é™¤ä»¥0ä¸ºNULLã€‚</li></ul></blockquote><h2 id="2-æ¯”è¾ƒè¿ç®—ç¬¦"><a href="#2-æ¯”è¾ƒè¿ç®—ç¬¦" class="headerlink" title="2. æ¯”è¾ƒè¿ç®—ç¬¦"></a>2. æ¯”è¾ƒè¿ç®—ç¬¦</h2><h3 id="1-ç­‰å·è¿ç®—ç¬¦"><a href="#1-ç­‰å·è¿ç®—ç¬¦" class="headerlink" title="1) ç­‰å·è¿ç®—ç¬¦"></a>1) ç­‰å·è¿ç®—ç¬¦</h3><p>æ¯”è¾ƒè¿ç®—ç¬¦ç”¨æ¥å¯¹è¡¨è¾¾å¼å·¦è¾¹çš„æ“ä½œæ•°å’Œå³è¾¹çš„æ“ä½œæ•°è¿›è¡Œæ¯”è¾ƒï¼Œæ¯”è¾ƒçš„ç»“æœä¸ºçœŸåˆ™è¿”å›1ï¼Œæ¯”è¾ƒçš„ç»“æœ ä¸ºå‡åˆ™è¿”å›0ï¼Œå…¶ä»–æƒ…å†µåˆ™è¿”å›NULLã€‚ </p><p>æ¯”è¾ƒè¿ç®—ç¬¦ç»å¸¸è¢«ç”¨æ¥ä½œä¸ºSELECTæŸ¥è¯¢è¯­å¥çš„æ¡ä»¶æ¥ä½¿ç”¨ï¼Œè¿”å›ç¬¦åˆæ¡ä»¶çš„ç»“æœè®°å½•ã€‚</p><p>å¦‚æœç­‰å·ä¸¤è¾¹çš„å€¼ã€å­—ç¬¦ä¸²æˆ–è¡¨è¾¾å¼ä¸­æœ‰ä¸€ä¸ªä¸ºNULLï¼Œåˆ™æ¯”è¾ƒç»“æœä¸ºNULLã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT 1 = 1, 1 = &#x27;1&#x27;, 1 = 0, &#x27;a&#x27; = &#x27;a&#x27;, (5 + 3) = (2 + 6), &#x27;&#x27; = NULL , NULL = NULL;</span><br><span class="line">+-------+---------+-------+-----------+-------------------+-----------+-------------+</span><br><span class="line">| 1 = 1 | 1 = &#x27;1&#x27; | 1 = 0 | &#x27;a&#x27; = &#x27;a&#x27; | (5 + 3) = (2 + 6) | &#x27;&#x27; = NULL | NULL = NULL |</span><br><span class="line">+-------+---------+-------+-----------+-------------------+-----------+-------------+</span><br><span class="line">|   1   |    1    |   0   |     1     |          1        |    NULL   |     NULL    |</span><br><span class="line">+-------+---------+-------+-----------+-------------------+-----------+-------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT 1 = 2, 0 = &#x27;abc&#x27;, 1 = &#x27;abc&#x27; FROM DUAL;</span><br><span class="line">+-------+-----------+-----------+</span><br><span class="line">| 1 = 2 | 0 = &#x27;abc&#x27; | 1 = &#x27;abc&#x27; |</span><br><span class="line">+-------+-----------+-----------+</span><br><span class="line">|   0   |     1     |     0     |</span><br><span class="line">+-------+-----------+-----------+</span><br><span class="line">1 row in set, 2 warnings (0.00 sec)</span><br></pre></td></tr></table></figure><blockquote><ul><li>å¦‚æœç­‰å·ä¸¤è¾¹çš„å€¼ã€å­—ç¬¦ä¸²æˆ–è¡¨è¾¾å¼éƒ½ä¸ºå­—ç¬¦ä¸²ï¼Œåˆ™MySQLä¼šæŒ‰ç…§å­—ç¬¦ä¸²è¿›è¡Œæ¯”è¾ƒï¼Œå…¶æ¯”è¾ƒçš„ æ˜¯æ¯ä¸ªå­—ç¬¦ä¸²ä¸­å­—ç¬¦çš„ANSIç¼–ç æ˜¯å¦ç›¸ç­‰ã€‚ </li><li>å¦‚æœç­‰å·ä¸¤è¾¹çš„å€¼éƒ½æ˜¯æ•´æ•°ï¼Œåˆ™MySQLä¼šæŒ‰ç…§æ•´æ•°æ¥æ¯”è¾ƒä¸¤ä¸ªå€¼çš„å¤§å°ã€‚ </li><li>å¦‚æœç­‰å·ä¸¤è¾¹çš„å€¼ä¸€ä¸ªæ˜¯æ•´æ•°ï¼Œå¦ä¸€ä¸ªæ˜¯å­—ç¬¦ä¸²ï¼Œåˆ™MySQLä¼šå°†å­—ç¬¦ä¸²è½¬åŒ–ä¸ºæ•°å­—è¿›è¡Œæ¯”è¾ƒã€‚ </li><li>å¦‚æœç­‰å·ä¸¤è¾¹çš„å€¼ã€å­—ç¬¦ä¸²æˆ–è¡¨è¾¾å¼ä¸­æœ‰ä¸€ä¸ªä¸ºNULLï¼Œåˆ™æ¯”è¾ƒç»“æœä¸ºNULLã€‚</li></ul></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ysql&gt; SELECT 1 &lt;=&gt; &#x27;1&#x27;, 1 &lt;=&gt; 0, &#x27;a&#x27; &lt;=&gt; &#x27;a&#x27;, (5 + 3) &lt;=&gt; (2 + 6), &#x27;&#x27; &lt;=&gt; NULL,NULL &lt;=&gt; NULL FROM dual;</span><br><span class="line">+-----------+---------+-------------+---------------------+-------------+---------------+</span><br><span class="line">| 1 &lt;=&gt; &#x27;1&#x27; | 1 &lt;=&gt; 0 | &#x27;a&#x27; &lt;=&gt; &#x27;a&#x27; | (5 + 3) &lt;=&gt; (2 + 6) | &#x27;&#x27; &lt;=&gt; NULL | NULL &lt;=&gt; NULL |</span><br><span class="line">+-----------+---------+-------------+---------------------+-------------+---------------+</span><br><span class="line">|     1     |    0    |      1      |           1         |      0      |       1       |</span><br><span class="line">+-----------+---------+-------------+---------------------+-------------+---------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œä½¿ç”¨å®‰å…¨ç­‰äºè¿ç®—ç¬¦æ—¶ï¼Œä¸¤è¾¹çš„æ“ä½œæ•°çš„å€¼éƒ½ä¸ºNULLæ—¶ï¼Œè¿”å›çš„ç»“æœä¸º1è€Œä¸æ˜¯NULLï¼Œå…¶ä»–è¿”å›ç»“æœä¸ç­‰äºè¿ç®—ç¬¦ç›¸åŒã€‚</p><h3 id="2-ä¸ç­‰äºè¿ç®—ç¬¦"><a href="#2-ä¸ç­‰äºè¿ç®—ç¬¦" class="headerlink" title="2) ä¸ç­‰äºè¿ç®—ç¬¦"></a>2) ä¸ç­‰äºè¿ç®—ç¬¦</h3><p>ä¸ç­‰äºè¿ç®—ç¬¦ï¼ˆ&lt;&gt;å’Œ!&#x3D;ï¼‰ç”¨äºåˆ¤æ–­ä¸¤è¾¹çš„æ•°å­—ã€å­—ç¬¦ä¸²æˆ–è€…è¡¨è¾¾å¼çš„å€¼æ˜¯å¦ä¸ç›¸ç­‰ï¼Œ å¦‚æœä¸ç›¸ç­‰åˆ™è¿”å›1ï¼Œç›¸ç­‰åˆ™è¿”å›0ã€‚ä¸ç­‰äºè¿ç®—ç¬¦ä¸èƒ½åˆ¤æ–­NULLå€¼ã€‚å¦‚æœä¸¤è¾¹çš„å€¼æœ‰ä»»æ„ä¸€ä¸ªä¸ºNULLï¼Œ æˆ–ä¸¤è¾¹éƒ½ä¸ºNULLï¼Œåˆ™ç»“æœä¸ºNULLã€‚ SQLè¯­å¥ç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT 1 &lt;&gt; 1, 1 != 2, &#x27;a&#x27; != &#x27;b&#x27;, (3+4) &lt;&gt; (2+6), &#x27;a&#x27; != NULL, NULL &lt;&gt; NULL;</span><br><span class="line">+--------+--------+------------+----------------+-------------+--------------+</span><br><span class="line">| 1 &lt;&gt; 1 | 1 != 2 | &#x27;a&#x27; != &#x27;b&#x27; | (3+4) &lt;&gt; (2+6) | &#x27;a&#x27; != NULL | NULL &lt;&gt; NULL |</span><br><span class="line">+--------+--------+------------+----------------+-------------+--------------+</span><br><span class="line">|    0   |    1   |      1     |        1       |     NULL    |      NULL    |</span><br><span class="line">+--------+--------+------------+----------------+-------------+--------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure><p>æ­¤å¤–ï¼Œè¿˜æœ‰éç¬¦å·ç±»å‹çš„è¿ç®—ç¬¦ï¼š</p><img src="/2023/03/04/00-Mysql%E5%9F%BA%E7%A1%80%E7%AF%87/image-20220531154418141.png" class=""><h3 id="3-ç©ºè¿ç®—ç¬¦"><a href="#3-ç©ºè¿ç®—ç¬¦" class="headerlink" title="3) ç©ºè¿ç®—ç¬¦"></a>3) ç©ºè¿ç®—ç¬¦</h3><p>ç©ºè¿ç®—ç¬¦ (IS NULL æˆ–è€… ISNULL) åˆ¤æ–­ä¸€ä¸ªå€¼æ˜¯å¦ä¸ºNULLï¼Œå¦‚æœä¸ºNULLåˆ™è¿”å›1ï¼Œå¦åˆ™è¿”å›0ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT NULL IS NULL, ISNULL(NULL), ISNULL(&#x27;a&#x27;), 1 IS NULL;</span><br><span class="line">+--------------+--------------+-------------+-----------+</span><br><span class="line">| NULL IS NULL | ISNULL(NULL) | ISNULL(&#x27;a&#x27;) | 1 IS NULL |</span><br><span class="line">+--------------+--------------+-------------+-----------+</span><br><span class="line">|      1       |       1      |      0      |     0     |</span><br><span class="line">+--------------+--------------+-------------+-----------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure><h3 id="4-éç©ºè¿ç®—ç¬¦"><a href="#4-éç©ºè¿ç®—ç¬¦" class="headerlink" title="4) éç©ºè¿ç®—ç¬¦"></a>4) éç©ºè¿ç®—ç¬¦</h3><p>éç©ºè¿ç®—ç¬¦ï¼ˆIS NOT NULLï¼‰åˆ¤æ–­ä¸€ä¸ªå€¼æ˜¯å¦ä¸ä¸ºNULLï¼Œå¦‚æœä¸ä¸ºNULLåˆ™è¿”å›1ï¼Œå¦åˆ™è¿”å›0ã€‚</p><h3 id="5-æœ€å°å€¼è¿ç®—ç¬¦"><a href="#5-æœ€å°å€¼è¿ç®—ç¬¦" class="headerlink" title="5) æœ€å°å€¼è¿ç®—ç¬¦"></a>5) æœ€å°å€¼è¿ç®—ç¬¦</h3><p>è¯­æ³•æ ¼å¼ä¸ºï¼šLEAST(å€¼1ï¼Œå€¼2ï¼Œâ€¦ï¼Œå€¼n)ã€‚å…¶ä¸­ï¼Œâ€œå€¼nâ€è¡¨ç¤ºå‚æ•°åˆ—è¡¨ä¸­æœ‰nä¸ªå€¼ã€‚åœ¨æœ‰ ä¸¤ä¸ªæˆ–å¤šä¸ªå‚æ•°çš„æƒ…å†µä¸‹ï¼Œè¿”å›æœ€å°å€¼ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT LEAST (1,0,2), LEAST(&#x27;b&#x27;,&#x27;a&#x27;,&#x27;c&#x27;), LEAST(1,NULL,2);</span><br><span class="line">+---------------+--------------------+-----------------+</span><br><span class="line">| LEAST (1,0,2) | LEAST(&#x27;b&#x27;,&#x27;a&#x27;,&#x27;c&#x27;) | LEAST(1,NULL,2) |</span><br><span class="line">+---------------+--------------------+-----------------+</span><br><span class="line">|       0       |          a         |        NULL     |</span><br><span class="line">+---------------+--------------------+-----------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure><p>ç”±ç»“æœå¯ä»¥çœ‹åˆ°ï¼Œå½“å‚æ•°æ˜¯æ•´æ•°æˆ–è€…æµ®ç‚¹æ•°æ—¶ï¼ŒLEASTå°†è¿”å›å…¶ä¸­æœ€å°çš„å€¼ï¼›å½“å‚æ•°ä¸ºå­—ç¬¦ä¸²æ—¶ï¼Œè¿”å›å­— æ¯è¡¨ä¸­é¡ºåºæœ€é å‰çš„å­—ç¬¦ï¼›å½“æ¯”è¾ƒå€¼åˆ—è¡¨ä¸­æœ‰NULLæ—¶ï¼Œä¸èƒ½åˆ¤æ–­å¤§å°ï¼Œè¿”å›å€¼ä¸ºNULLã€‚</p><h3 id="6-æœ€å¤§å€¼è¿ç®—ç¬¦"><a href="#6-æœ€å¤§å€¼è¿ç®—ç¬¦" class="headerlink" title="6) æœ€å¤§å€¼è¿ç®—ç¬¦"></a>6) æœ€å¤§å€¼è¿ç®—ç¬¦</h3><p>è¯­æ³•æ ¼å¼ä¸ºï¼šGREATEST(å€¼1ï¼Œå€¼2ï¼Œâ€¦ï¼Œå€¼n)ã€‚å…¶ä¸­ï¼Œnè¡¨ç¤ºå‚æ•°åˆ—è¡¨ä¸­æœ‰nä¸ªå€¼ã€‚å½“æœ‰ ä¸¤ä¸ªæˆ–å¤šä¸ªå‚æ•°æ—¶ï¼Œè¿”å›å€¼ä¸ºæœ€å¤§å€¼ã€‚å‡å¦‚ä»»æ„ä¸€ä¸ªè‡ªå˜é‡ä¸ºNULLï¼Œåˆ™GREATEST()çš„è¿”å›å€¼ä¸ºNULLã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT GREATEST(1,0,2), GREATEST(&#x27;b&#x27;,&#x27;a&#x27;,&#x27;c&#x27;), GREATEST(1,NULL,2);</span><br><span class="line">+-----------------+-----------------------+--------------------+</span><br><span class="line">| GREATEST(1,0,2) | GREATEST(&#x27;b&#x27;,&#x27;a&#x27;,&#x27;c&#x27;) | GREATEST(1,NULL,2) |</span><br><span class="line">+-----------------+-----------------------+--------------------+</span><br><span class="line">|         2       |             c         |         NULL       |</span><br><span class="line">+-----------------+-----------------------+--------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure><p>ç”±ç»“æœå¯ä»¥çœ‹åˆ°ï¼Œå½“å‚æ•°ä¸­æ˜¯æ•´æ•°æˆ–è€…æµ®ç‚¹æ•°æ—¶ï¼ŒGREATESTå°†è¿”å›å…¶ä¸­æœ€å¤§çš„å€¼ï¼›å½“å‚æ•°ä¸ºå­—ç¬¦ä¸²æ—¶ï¼Œ è¿”å›å­—æ¯è¡¨ä¸­é¡ºåºæœ€é åçš„å­—ç¬¦ï¼›å½“æ¯”è¾ƒå€¼åˆ—è¡¨ä¸­æœ‰NULLæ—¶ï¼Œä¸èƒ½åˆ¤æ–­å¤§å°ï¼Œè¿”å›å€¼ä¸ºNULLã€‚</p><h3 id="7-BETWEEN-ANDè¿ç®—ç¬¦"><a href="#7-BETWEEN-ANDè¿ç®—ç¬¦" class="headerlink" title="7) BETWEEN ANDè¿ç®—ç¬¦"></a>7) BETWEEN ANDè¿ç®—ç¬¦</h3><p>BETWEENè¿ç®—ç¬¦ä½¿ç”¨çš„æ ¼å¼é€šå¸¸ä¸ºSELECT D FROM TABLE WHERE C BETWEEN A AND Bï¼Œæ­¤æ—¶ï¼Œå½“Cå¤§äºæˆ–ç­‰äºAï¼Œå¹¶ä¸”Cå°äºæˆ–ç­‰äºBæ—¶ï¼Œç»“æœä¸º1ï¼Œå¦åˆ™ç»“æœä¸º0ã€‚</p><h3 id="8-INè¿ç®—ç¬¦"><a href="#8-INè¿ç®—ç¬¦" class="headerlink" title="8) INè¿ç®—ç¬¦"></a>8) INè¿ç®—ç¬¦</h3><p>INè¿ç®—ç¬¦ç”¨äºåˆ¤æ–­ç»™å®šçš„å€¼æ˜¯å¦æ˜¯INåˆ—è¡¨ä¸­çš„ä¸€ä¸ªå€¼ï¼Œå¦‚æœæ˜¯åˆ™è¿”å›1ï¼Œå¦åˆ™è¿”å›0ã€‚å¦‚æœç»™ å®šçš„å€¼ä¸ºNULLï¼Œæˆ–è€…INåˆ—è¡¨ä¸­å­˜åœ¨NULLï¼Œåˆ™ç»“æœä¸ºNULLã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT &#x27;a&#x27; IN (&#x27;a&#x27;,&#x27;b&#x27;,&#x27;c&#x27;), 1 IN (2,3), NULL IN (&#x27;a&#x27;,&#x27;b&#x27;), &#x27;a&#x27; IN (&#x27;a&#x27;, NULL);</span><br><span class="line">+----------------------+------------+-------------------+--------------------+</span><br><span class="line">| &#x27;a&#x27; IN (&#x27;a&#x27;,&#x27;b&#x27;,&#x27;c&#x27;) | 1 IN (2,3) | NULL IN (&#x27;a&#x27;,&#x27;b&#x27;) | &#x27;a&#x27; IN (&#x27;a&#x27;, NULL) |</span><br><span class="line">+----------------------+------------+-------------------+--------------------+</span><br><span class="line">|            1         |      0     |         NULL      |          1         |</span><br><span class="line">+----------------------+------------+-------------------+--------------------+</span><br></pre></td></tr></table></figure><h3 id="9-NOT-INè¿ç®—ç¬¦"><a href="#9-NOT-INè¿ç®—ç¬¦" class="headerlink" title="9) NOT INè¿ç®—ç¬¦"></a>9) NOT INè¿ç®—ç¬¦</h3><p>NOT INè¿ç®—ç¬¦ç”¨äºåˆ¤æ–­ç»™å®šçš„å€¼æ˜¯å¦ä¸æ˜¯INåˆ—è¡¨ä¸­çš„ä¸€ä¸ªå€¼ï¼Œå¦‚æœä¸æ˜¯INåˆ—è¡¨ä¸­çš„ä¸€ ä¸ªå€¼ï¼Œåˆ™è¿”å›1ï¼Œå¦åˆ™è¿”å›0ã€‚</p><h3 id="10-LIKEè¿ç®—ç¬¦"><a href="#10-LIKEè¿ç®—ç¬¦" class="headerlink" title="10) LIKEè¿ç®—ç¬¦"></a>10) LIKEè¿ç®—ç¬¦</h3><p>LIKEè¿ç®—ç¬¦ä¸»è¦ç”¨æ¥åŒ¹é…å­—ç¬¦ä¸²ï¼Œé€šå¸¸ç”¨äºæ¨¡ç³ŠåŒ¹é…ï¼Œå¦‚æœæ»¡è¶³æ¡ä»¶åˆ™è¿”å›1ï¼Œå¦åˆ™è¿”å› 0ã€‚å¦‚æœç»™å®šçš„å€¼æˆ–è€…åŒ¹é…æ¡ä»¶ä¸ºNULLï¼Œåˆ™è¿”å›ç»“æœä¸ºNULLã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">â€œ%â€ï¼šåŒ¹é…0ä¸ªæˆ–å¤šä¸ªå­—ç¬¦ã€‚</span><br><span class="line">â€œ_â€ï¼šåªèƒ½åŒ¹é…ä¸€ä¸ªå­—ç¬¦ã€‚</span><br></pre></td></tr></table></figure><h3 id="11-ESCAPE"><a href="#11-ESCAPE" class="headerlink" title="11) ESCAPE"></a>11) ESCAPE</h3><p>å›é¿ç‰¹æ®Šç¬¦å·çš„ï¼šä½¿ç”¨è½¬ä¹‰ç¬¦ã€‚ä¾‹å¦‚ï¼šå°†[%]è½¬ä¸º[$%]ã€[]è½¬ä¸º[$]ï¼Œç„¶åå†åŠ ä¸Š[ESCAPEâ€˜$â€™]å³å¯ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SELECT job_id</span><br><span class="line">FROM jobs</span><br><span class="line">WHERE job_id LIKE â€˜IT\_%â€˜;</span><br></pre></td></tr></table></figure><p>å¦‚æœä½¿ç”¨\è¡¨ç¤ºè½¬ä¹‰ï¼Œè¦çœç•¥ESCAPEã€‚å¦‚æœä¸æ˜¯\ï¼Œåˆ™è¦åŠ ä¸ŠESCAPEã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SELECT job_id</span><br><span class="line">FROM jobs</span><br><span class="line">WHERE job_id LIKE â€˜IT$_%â€˜ escape â€˜$â€˜;</span><br></pre></td></tr></table></figure><h3 id="12-REGEXPè¿ç®—ç¬¦"><a href="#12-REGEXPè¿ç®—ç¬¦" class="headerlink" title="12) REGEXPè¿ç®—ç¬¦"></a>12) REGEXPè¿ç®—ç¬¦</h3><p>REGEXPè¿ç®—ç¬¦ç”¨æ¥åŒ¹é…å­—ç¬¦ä¸²ï¼Œè¯­æ³•æ ¼å¼ä¸ºï¼š expr REGEXP åŒ¹é…æ¡ä»¶ ã€‚</p><blockquote><p>ï¼ˆ1ï¼‰â€˜^â€™åŒ¹é…ä»¥è¯¥å­—ç¬¦åé¢çš„å­—ç¬¦å¼€å¤´çš„å­—ç¬¦ä¸²ã€‚ </p><p>ï¼ˆ2ï¼‰â€˜$â€™åŒ¹é…ä»¥è¯¥å­—ç¬¦å‰é¢çš„å­—ç¬¦ç»“å°¾çš„å­—ç¬¦ä¸²ã€‚ </p><p>ï¼ˆ3ï¼‰â€˜.â€™åŒ¹é…ä»»ä½•ä¸€ä¸ªå•å­—ç¬¦ã€‚ </p><p>ï¼ˆ4ï¼‰â€œ[â€¦]â€åŒ¹é…åœ¨æ–¹æ‹¬å·å†…çš„ä»»ä½•å­—ç¬¦ã€‚ä¾‹å¦‚ï¼Œâ€œ[abc]â€åŒ¹é…â€œaâ€æˆ–â€œbâ€æˆ–â€œcâ€ã€‚ä¸ºäº†å‘½åå­—ç¬¦çš„èŒƒå›´ï¼Œä½¿ç”¨ä¸€ ä¸ªâ€˜-â€™ã€‚â€œ[a-z]â€åŒ¹é…ä»»ä½•å­—æ¯ï¼Œè€Œâ€œ[0-9]â€åŒ¹é…ä»»ä½•æ•°å­—ã€‚</p><p>ï¼ˆ5ï¼‰â€˜<em>â€™åŒ¹é…é›¶ä¸ªæˆ–å¤šä¸ªåœ¨å®ƒå‰é¢çš„å­—ç¬¦ã€‚ä¾‹å¦‚ï¼Œâ€œx</em>â€åŒ¹é…ä»»ä½•æ•°é‡çš„â€˜xâ€™å­—ç¬¦ï¼Œâ€œ[0-9]<em>â€åŒ¹é…ä»»ä½•æ•°é‡çš„æ•°å­—ï¼Œ è€Œâ€œ</em>â€åŒ¹é…ä»»ä½•æ•°é‡çš„ä»»ä½•å­—ç¬¦ã€‚</p></blockquote><h2 id="3-é€»è¾‘è¿ç®—ç¬¦"><a href="#3-é€»è¾‘è¿ç®—ç¬¦" class="headerlink" title="3. é€»è¾‘è¿ç®—ç¬¦"></a>3. é€»è¾‘è¿ç®—ç¬¦</h2><p>é€»è¾‘è¿ç®—ç¬¦ä¸»è¦ç”¨æ¥åˆ¤æ–­è¡¨è¾¾å¼çš„çœŸå‡ï¼Œåœ¨MySQLä¸­ï¼Œé€»è¾‘è¿ç®—ç¬¦çš„è¿”å›ç»“æœä¸º1ã€0æˆ–è€…NULLã€‚ </p><p>MySQLä¸­æ”¯æŒ4ç§é€»è¾‘è¿ç®—ç¬¦å¦‚ä¸‹ï¼š</p><p><img src="/MySQL%E5%9F%BA%E7%A1%80%E7%AF%87.assets/image-20220531195405333.png" alt="image-20220531195405333"></p><h2 id="4-ä½è¿ç®—"><a href="#4-ä½è¿ç®—" class="headerlink" title="4. ä½è¿ç®—"></a>4. ä½è¿ç®—</h2><p>ä½è¿ç®—ç¬¦æ˜¯åœ¨äºŒè¿›åˆ¶æ•°ä¸Šè¿›è¡Œè®¡ç®—çš„è¿ç®—ç¬¦ã€‚ä½è¿ç®—ç¬¦ä¼šå…ˆå°†æ“ä½œæ•°å˜æˆäºŒè¿›åˆ¶æ•°ï¼Œç„¶åè¿›è¡Œä½è¿ç®—ï¼Œ æœ€åå°†è®¡ç®—ç»“æœä»äºŒè¿›åˆ¶å˜å›åè¿›åˆ¶æ•°ã€‚ </p><p>MySQLæ”¯æŒçš„ä½è¿ç®—ç¬¦å¦‚ä¸‹ï¼š</p><p><img src="/MySQL%E5%9F%BA%E7%A1%80%E7%AF%87.assets/image-20220531195442995.png" alt="image-20220531195442995"></p><h2 id="5-è¿ç®—ç¬¦çš„ä¼˜å…ˆçº§"><a href="#5-è¿ç®—ç¬¦çš„ä¼˜å…ˆçº§" class="headerlink" title="5. è¿ç®—ç¬¦çš„ä¼˜å…ˆçº§"></a>5. è¿ç®—ç¬¦çš„ä¼˜å…ˆçº§</h2><p>æ•°å­—ç¼–å·è¶Šå¤§ï¼Œä¼˜å…ˆçº§è¶Šé«˜ï¼Œä¼˜å…ˆçº§é«˜çš„è¿ç®—ç¬¦å…ˆè¿›è¡Œè®¡ç®—ã€‚</p><p><img src="/MySQL%E5%9F%BA%E7%A1%80%E7%AF%87.assets/image-20220531195522668.png" alt="image-20220531195522668"></p><h2 id="æ‰©å±•ï¼šä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æŸ¥è¯¢"><a href="#æ‰©å±•ï¼šä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æŸ¥è¯¢" class="headerlink" title="æ‰©å±•ï¼šä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æŸ¥è¯¢"></a>æ‰©å±•ï¼šä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æŸ¥è¯¢</h2><p><img src="/MySQL%E5%9F%BA%E7%A1%80%E7%AF%87.assets/image-20220531204253508.png" alt="image-20220531204253508"></p><h1 id="ç¬¬äº”ç« -æ’åºä¸åˆ†é¡µ"><a href="#ç¬¬äº”ç« -æ’åºä¸åˆ†é¡µ" class="headerlink" title="ç¬¬äº”ç« _æ’åºä¸åˆ†é¡µ"></a>ç¬¬äº”ç« _æ’åºä¸åˆ†é¡µ</h1><h2 id="1-æ’åºè§„åˆ™"><a href="#1-æ’åºè§„åˆ™" class="headerlink" title="1. æ’åºè§„åˆ™"></a>1. æ’åºè§„åˆ™</h2><ul><li><p>ä½¿ç”¨ ORDER BY å­å¥æ’åº</p><ul><li>ASCï¼ˆascendï¼‰: å‡åº </li><li>DESCï¼ˆdescendï¼‰:é™åº</li></ul></li><li><p>ORDER BY å­å¥åœ¨SELECTè¯­å¥çš„ç»“å°¾ã€‚</p></li></ul><h3 id="1-å•åˆ—æ’åº"><a href="#1-å•åˆ—æ’åº" class="headerlink" title="1) å•åˆ—æ’åº"></a>1) å•åˆ—æ’åº</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SELECT last_name, job_id, department_id, hire_date</span><br><span class="line">FROM employees</span><br><span class="line">ORDER BY hire_date;</span><br></pre></td></tr></table></figure><h3 id="2-å¤šåˆ—æ’åº"><a href="#2-å¤šåˆ—æ’åº" class="headerlink" title="2) å¤šåˆ—æ’åº"></a>2) å¤šåˆ—æ’åº</h3><ul><li>å¯ä»¥ä½¿ç”¨ä¸åœ¨SELECTåˆ—è¡¨ä¸­çš„åˆ—æ’åºã€‚ </li><li>åœ¨å¯¹å¤šåˆ—è¿›è¡Œæ’åºçš„æ—¶å€™ï¼Œé¦–å…ˆæ’åºçš„ç¬¬ä¸€åˆ—å¿…é¡»æœ‰ç›¸åŒçš„åˆ—å€¼ï¼Œæ‰ä¼šå¯¹ç¬¬äºŒåˆ—è¿›è¡Œæ’åºã€‚å¦‚æœç¬¬ ä¸€åˆ—æ•°æ®ä¸­æ‰€æœ‰å€¼éƒ½æ˜¯å”¯ä¸€çš„ï¼Œå°†ä¸å†å¯¹ç¬¬äºŒåˆ—è¿›è¡Œæ’åºã€‚</li></ul><h2 id="2-åˆ†é¡µ"><a href="#2-åˆ†é¡µ" class="headerlink" title="2. åˆ†é¡µ"></a>2. åˆ†é¡µ</h2><ul><li>æ ¼å¼ï¼š</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LIMIT [ä½ç½®åç§»é‡,] è¡Œæ•°</span><br></pre></td></tr></table></figure><ul><li>ä¸¾ä¾‹ï¼š</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">--å‰10æ¡è®°å½•ï¼š</span><br><span class="line">SELECT * FROM è¡¨å LIMIT 0,10;</span><br><span class="line">æˆ–è€…</span><br><span class="line">SELECT * FROM è¡¨å LIMIT 10;</span><br><span class="line">--ç¬¬11è‡³20æ¡è®°å½•ï¼š</span><br><span class="line">SELECT * FROM è¡¨å LIMIT 10,10;</span><br><span class="line">--ç¬¬21è‡³30æ¡è®°å½•ï¼š</span><br><span class="line">SELECT * FROM è¡¨å LIMIT 20,10;</span><br></pre></td></tr></table></figure><blockquote><p>MySQL 8.0ä¸­å¯ä»¥ä½¿ç”¨â€œLIMIT 3 OFFSET 4â€ï¼Œæ„æ€æ˜¯è·å–ä»ç¬¬5æ¡è®°å½•å¼€å§‹åé¢çš„3æ¡è®°å½•ï¼Œå’Œâ€œLIMIT 4,3;â€è¿”å›çš„ç»“æœç›¸åŒã€‚</p></blockquote><ul><li>åˆ†é¡µæ˜¾å¼å…¬å¼ï¼šï¼ˆå½“å‰é¡µæ•°-1ï¼‰* æ¯é¡µæ¡æ•°ï¼Œæ¯é¡µæ¡æ•°</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM table</span><br><span class="line">LIMIT(PageNo - 1) * PageSize, PageSize;</span><br></pre></td></tr></table></figure><ul><li><p>æ³¨æ„ï¼šLIMIT å­å¥å¿…é¡»æ”¾åœ¨æ•´ä¸ªSELECTè¯­å¥çš„æœ€åï¼</p></li><li><p>ä½¿ç”¨LIMITçš„å¥½å¤„</p></li></ul><p>çº¦æŸè¿”å›ç»“æœçš„æ•°é‡å¯ä»¥ å‡å°‘æ•°æ®è¡¨çš„ç½‘ç»œä¼ è¾“é‡ ï¼Œä¹Ÿå¯ä»¥ æå‡æŸ¥è¯¢æ•ˆç‡ ã€‚å¦‚æœæˆ‘ä»¬çŸ¥é“è¿”å›ç»“æœåªæœ‰ 1 æ¡ï¼Œå°±å¯ä»¥ä½¿ç”¨ LIMIT 1 ï¼Œå‘Šè¯‰ SELECT è¯­å¥åªéœ€è¦è¿”å›ä¸€æ¡è®°å½•å³å¯ã€‚è¿™æ ·çš„å¥½å¤„å°±æ˜¯ SELECT ä¸éœ€ è¦æ‰«æå®Œæ•´çš„è¡¨ï¼Œåªéœ€è¦æ£€ç´¢åˆ°ä¸€æ¡ç¬¦åˆæ¡ä»¶çš„è®°å½•å³å¯è¿”å›ã€‚</p><h1 id="ç¬¬å…­ç« -å¤šè¡¨æŸ¥è¯¢"><a href="#ç¬¬å…­ç« -å¤šè¡¨æŸ¥è¯¢" class="headerlink" title="ç¬¬å…­ç« _å¤šè¡¨æŸ¥è¯¢"></a>ç¬¬å…­ç« _å¤šè¡¨æŸ¥è¯¢</h1><h2 id="1-å¤šè¡¨æŸ¥è¯¢åˆ†ç±»è®²è§£"><a href="#1-å¤šè¡¨æŸ¥è¯¢åˆ†ç±»è®²è§£" class="headerlink" title="1. å¤šè¡¨æŸ¥è¯¢åˆ†ç±»è®²è§£"></a>1. å¤šè¡¨æŸ¥è¯¢åˆ†ç±»è®²è§£</h2><h3 id="1-è‡ªè¿æ¥"><a href="#1-è‡ªè¿æ¥" class="headerlink" title="1) è‡ªè¿æ¥"></a>1) è‡ªè¿æ¥</h3><p>é¢˜ç›®ï¼šæŸ¥è¯¢employeesè¡¨ï¼Œè¿”å› &lt;å‘˜å·¥ works for è€æ¿&gt;</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SELECT CONCAT(worker.last_name , &#x27; works for &#x27;, manager.last_name)</span><br><span class="line">FROM employees worker, employees manager</span><br><span class="line">WHERE worker.manager_id = manager.employee_id;</span><br></pre></td></tr></table></figure><h3 id="2-å†…è¿æ¥ä¸å¤–è¿æ¥"><a href="#2-å†…è¿æ¥ä¸å¤–è¿æ¥" class="headerlink" title="2) å†…è¿æ¥ä¸å¤–è¿æ¥"></a>2) å†…è¿æ¥ä¸å¤–è¿æ¥</h3><ul><li>å†…è¿æ¥: åˆå¹¶å…·æœ‰åŒä¸€åˆ—çš„ä¸¤ä¸ªä»¥ä¸Šçš„è¡¨çš„è¡Œ, ç»“æœé›†ä¸­ä¸åŒ…å«ä¸€ä¸ªè¡¨ä¸å¦ä¸€ä¸ªè¡¨ä¸åŒ¹é…çš„è¡Œ</li></ul><p><strong>SQL92è¯­æ³•</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SELECT emp.employee_id, dep.department_name</span><br><span class="line">FROM employee emp, department dep</span><br><span class="line">WHERE emp.`department_id` = dep.`department_id`;</span><br></pre></td></tr></table></figure><p><strong>SQL99è¯­æ³•</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SELECT emp.employee_id, dep.department_name</span><br><span class="line">FROM employee emp JOIN department dep</span><br><span class="line">ON emp.`department_id` = dep.`department_id`;</span><br></pre></td></tr></table></figure><ul><li>å¤–è¿æ¥: ä¸¤ä¸ªè¡¨åœ¨è¿æ¥è¿‡ç¨‹ä¸­é™¤äº†è¿”å›æ»¡è¶³è¿æ¥æ¡ä»¶çš„è¡Œä»¥å¤–è¿˜è¿”å›å·¦ï¼ˆæˆ–å³ï¼‰è¡¨ä¸­ä¸æ»¡è¶³æ¡ä»¶çš„ è¡Œ ï¼Œè¿™ç§è¿æ¥ç§°ä¸ºå·¦ï¼ˆæˆ–å³ï¼‰ å¤–è¿æ¥ã€‚æ²¡æœ‰åŒ¹é…çš„è¡Œæ—¶, ç»“æœè¡¨ä¸­ç›¸åº”çš„åˆ—ä¸ºç©º(NULL)ã€‚ </li><li>å¦‚æœæ˜¯å·¦å¤–è¿æ¥ï¼Œåˆ™è¿æ¥æ¡ä»¶ä¸­å·¦è¾¹çš„è¡¨ä¹Ÿç§°ä¸º ä¸»è¡¨ ï¼Œå³è¾¹çš„è¡¨ç§°ä¸º ä»è¡¨ ã€‚</li></ul><p><strong>LEFT OUTER JOIN</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SELECT last_name, department_name</span><br><span class="line">FROM employees emp LEFT OUTER JOIN department dep</span><br><span class="line">ON emp.`department_id` = dep.`department_id`;</span><br></pre></td></tr></table></figure><ul><li>å¦‚æœæ˜¯å³å¤–è¿æ¥ï¼Œåˆ™è¿æ¥æ¡ä»¶ä¸­å³è¾¹çš„è¡¨ä¹Ÿç§°ä¸º ä¸»è¡¨ ï¼Œå·¦è¾¹çš„è¡¨ç§°ä¸º ä»è¡¨ ã€‚</li></ul><p><strong>RIGHT OUTER JOIN</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SELECT last_name, department_name</span><br><span class="line">FROM employees emp RIGHT OUTER JOIN department dep</span><br><span class="line">ON emp.`department_id` = dep.`department_id`;</span><br></pre></td></tr></table></figure><h2 id="2-UNIONçš„ä½¿ç”¨"><a href="#2-UNIONçš„ä½¿ç”¨" class="headerlink" title="2. UNIONçš„ä½¿ç”¨"></a>2. UNIONçš„ä½¿ç”¨</h2><p><strong>åˆå¹¶æŸ¥è¯¢ç»“æœ</strong> </p><p>åˆ©ç”¨UNIONå…³é”®å­—ï¼Œå¯ä»¥ç»™å‡ºå¤šæ¡SELECTè¯­å¥ï¼Œå¹¶å°†å®ƒä»¬çš„ç»“æœç»„åˆæˆå•ä¸ªç»“æœé›†ã€‚åˆå¹¶ æ—¶ï¼Œä¸¤ä¸ªè¡¨å¯¹åº”çš„åˆ—æ•°å’Œæ•°æ®ç±»å‹å¿…é¡»ç›¸åŒï¼Œå¹¶ä¸”ç›¸äº’å¯¹åº”ã€‚å„ä¸ªSELECTè¯­å¥ä¹‹é—´ä½¿ç”¨UNIONæˆ–UNION ALLå…³é”®å­—åˆ†éš”ã€‚</p><p>è¯­æ³•æ ¼å¼ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SELECT column,... FROM table1</span><br><span class="line">UNION [ALL]</span><br><span class="line">SELECT column,... FROM table2</span><br></pre></td></tr></table></figure><p><strong>UNIONæ“ä½œç¬¦</strong></p><p>UNION æ“ä½œç¬¦è¿”å›ä¸¤ä¸ªæŸ¥è¯¢çš„ç»“æœé›†çš„å¹¶é›†ï¼Œå»é™¤é‡å¤è®°å½•ã€‚</p><p><strong>UNION ALLæ“ä½œç¬¦</strong></p><p>UNION ALLæ“ä½œç¬¦è¿”å›ä¸¤ä¸ªæŸ¥è¯¢çš„ç»“æœé›†çš„å¹¶é›†ã€‚å¯¹äºä¸¤ä¸ªç»“æœé›†çš„é‡å¤éƒ¨åˆ†ï¼Œä¸å»é‡ã€‚</p><blockquote><p>æ³¨æ„ï¼šæ‰§è¡ŒUNION ALLè¯­å¥æ—¶æ‰€éœ€è¦çš„èµ„æºæ¯”UNIONè¯­å¥å°‘ã€‚å¦‚æœæ˜ç¡®çŸ¥é“åˆå¹¶æ•°æ®åçš„ç»“æœæ•°æ®ä¸å­˜åœ¨é‡å¤æ•°æ®ï¼Œæˆ–è€…ä¸éœ€è¦å»é™¤é‡å¤çš„æ•°æ®ï¼Œåˆ™å°½é‡ä½¿ç”¨UNION ALLè¯­å¥ï¼Œä»¥æé«˜æ•°æ®æŸ¥è¯¢çš„æ•ˆç‡ã€‚</p></blockquote><p>ä¸¾ä¾‹ï¼šæŸ¥è¯¢éƒ¨é—¨ç¼–å·&gt;90æˆ–é‚®ç®±åŒ…å«açš„å‘˜å·¥ä¿¡æ¯</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#æ–¹å¼1</span><br><span class="line">SELECT * FROM employees WHERE email LIKE &#x27;%a%&#x27; OR department_id&gt;90;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#æ–¹å¼2</span><br><span class="line">SELECT * FROM employees WHERE email LIKE &#x27;%a%&#x27;</span><br><span class="line">UNION</span><br><span class="line">SELECT * FROM employees WHERE department_id&gt;90;</span><br></pre></td></tr></table></figure><p>ä¸¾ä¾‹ï¼šæŸ¥è¯¢ä¸­å›½ç”¨æˆ·ä¸­ç”·æ€§çš„ä¿¡æ¯ä»¥åŠç¾å›½ç”¨æˆ·ä¸­å¹´ç”·æ€§çš„ç”¨æˆ·ä¿¡æ¯</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SELECT id,cname FROM t_chinamale WHERE csex=&#x27;ç”·&#x27;</span><br><span class="line">UNION ALL</span><br><span class="line">SELECT id,tname FROM t_usmale WHERE tGender=&#x27;male&#x27;;</span><br></pre></td></tr></table></figure><h2 id="3-ä¸ƒç§SQL-JOINSçš„å®ç°"><a href="#3-ä¸ƒç§SQL-JOINSçš„å®ç°" class="headerlink" title="3.ä¸ƒç§SQL JOINSçš„å®ç°"></a>3.ä¸ƒç§SQL JOINSçš„å®ç°</h2><img src="/2023/03/04/00-Mysql%E5%9F%BA%E7%A1%80%E7%AF%87/image-20220531224324213.png" class=""><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"># ä¸­å›¾ï¼šå†…è¿æ¥</span><br><span class="line">SELECT employee_id,department_name</span><br><span class="line">FROM employees e JOIN departments d</span><br><span class="line">ON e.`department_id` = d.`department_id`;</span><br><span class="line"></span><br><span class="line"># å·¦ä¸Šå›¾ï¼šå·¦å¤–è¿æ¥</span><br><span class="line">SELECT employee_id,department_name</span><br><span class="line">FROM employees e LEFT JOIN departments d</span><br><span class="line">ON e.`department_id` = d.`department_id`;</span><br><span class="line"></span><br><span class="line"># å³ä¸Šå›¾ï¼šå³å¤–è¿æ¥</span><br><span class="line">SELECT employee_id,department_name</span><br><span class="line">FROM employees e RIGHT JOIN departments d</span><br><span class="line">ON e.`department_id` = d.`department_id`;</span><br><span class="line"></span><br><span class="line"># å·¦ä¸­å›¾ï¼š</span><br><span class="line">SELECT employee_id,department_name</span><br><span class="line">FROM employees e LEFT JOIN departments d</span><br><span class="line">ON e.`department_id` = d.`department_id`</span><br><span class="line">WHERE d.`department_id` IS NULL;</span><br><span class="line"></span><br><span class="line"># å³ä¸­å›¾ï¼š</span><br><span class="line">SELECT employee_id,department_name</span><br><span class="line">FROM employees e RIGHT JOIN departments d</span><br><span class="line">ON e.`department_id` = d.`department_id`</span><br><span class="line">WHERE e.`department_id` IS NULL;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># å·¦ä¸‹å›¾ï¼šæ»¡å¤–è¿æ¥</span><br><span class="line"># æ–¹å¼1ï¼šå·¦ä¸Šå›¾ UNION ALL å³ä¸­å›¾</span><br><span class="line">SELECT employee_id,department_name</span><br><span class="line">FROM employees e LEFT JOIN departments d</span><br><span class="line">ON e.`department_id` = d.`department_id`</span><br><span class="line">UNION ALL</span><br><span class="line">SELECT employee_id,department_name</span><br><span class="line">FROM employees e RIGHT JOIN departments d</span><br><span class="line">ON e.`department_id` = d.`department_id`</span><br><span class="line">WHERE e.`department_id` IS NULL;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># æ–¹å¼2ï¼šå·¦ä¸­å›¾ UNION ALL å³ä¸Šå›¾</span><br><span class="line">SELECT employee_id,department_name</span><br><span class="line">FROM employees e LEFT JOIN departments d</span><br><span class="line">ON e.`department_id` = d.`department_id`</span><br><span class="line">WHERE d.`department_id` IS NULL</span><br><span class="line">UNION ALL</span><br><span class="line">SELECT employee_id,department_name</span><br><span class="line">FROM employees e RIGHT JOIN departments d</span><br><span class="line">ON e.`department_id` = d.`department_id`;</span><br><span class="line"></span><br><span class="line"># å³ä¸‹å›¾ï¼šå·¦ä¸­å›¾  UNION ALL å³ä¸­å›¾</span><br><span class="line">SELECT employee_id,department_name</span><br><span class="line">FROM employees e LEFT JOIN departments d</span><br><span class="line">ON e.`department_id` = d.`department_id`</span><br><span class="line">WHERE d.`department_id` IS NULL</span><br><span class="line">UNION ALL</span><br><span class="line">SELECT employee_id,department_name</span><br><span class="line">FROM employees e RIGHT JOIN departments d</span><br><span class="line">ON e.`department_id` = d.`department_id`</span><br><span class="line">WHERE e.`department_id` IS NULL;</span><br></pre></td></tr></table></figure><h2 id="4-SQL99è¯­æ³•çš„æ–°ç‰¹æ€§"><a href="#4-SQL99è¯­æ³•çš„æ–°ç‰¹æ€§" class="headerlink" title="4. SQL99è¯­æ³•çš„æ–°ç‰¹æ€§"></a>4. SQL99è¯­æ³•çš„æ–°ç‰¹æ€§</h2><h3 id="1-è‡ªç„¶è¿æ¥"><a href="#1-è‡ªç„¶è¿æ¥" class="headerlink" title="1) è‡ªç„¶è¿æ¥"></a>1) è‡ªç„¶è¿æ¥</h3><p>SQL99 åœ¨ SQL92 çš„åŸºç¡€ä¸Šæä¾›äº†ä¸€äº›ç‰¹æ®Šè¯­æ³•ï¼Œæ¯”å¦‚ NATURAL JOIN ç”¨æ¥è¡¨ç¤ºè‡ªç„¶è¿æ¥ã€‚æˆ‘ä»¬å¯ä»¥æŠŠ è‡ªç„¶è¿æ¥ç†è§£ä¸º SQL92 ä¸­çš„ç­‰å€¼è¿æ¥ã€‚å®ƒä¼šå¸®ä½ è‡ªåŠ¨æŸ¥è¯¢ä¸¤å¼ è¿æ¥è¡¨ä¸­ æ‰€æœ‰ç›¸åŒçš„å­—æ®µ ï¼Œç„¶åè¿›è¡Œ ç­‰å€¼ è¿æ¥ ã€‚</p><p>åœ¨SQL92æ ‡å‡†ä¸­ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SELECT employee_id,last_name,department_name</span><br><span class="line">FROM employees e JOIN departments d</span><br><span class="line">ON e.`department_id` = d.`department_id`</span><br><span class="line">AND e.`manager_id` = d.`manager_id`;</span><br></pre></td></tr></table></figure><p>åœ¨ SQL99 ä¸­ä½ å¯ä»¥å†™æˆï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT employee_id,last_name,department_name</span><br><span class="line">FROM employees e NATURAL JOIN departments d;</span><br></pre></td></tr></table></figure><h3 id="2-USINGè¿æ¥"><a href="#2-USINGè¿æ¥" class="headerlink" title="2) USINGè¿æ¥"></a>2) USINGè¿æ¥</h3><p>å½“æˆ‘ä»¬è¿›è¡Œè¿æ¥çš„æ—¶å€™ï¼ŒSQL99è¿˜æ”¯æŒä½¿ç”¨ USING æŒ‡å®šæ•°æ®è¡¨é‡Œçš„ åŒåå­—æ®µ è¿›è¡Œç­‰å€¼è¿æ¥ã€‚ä½†æ˜¯åªèƒ½é… åˆJOINä¸€èµ·ä½¿ç”¨ã€‚æ¯”å¦‚ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SELECT employee_id,last_name,department_name</span><br><span class="line">FROM employees e JOIN departments d</span><br><span class="line">USING (department_id);</span><br></pre></td></tr></table></figure><p>ä½ èƒ½çœ‹å‡ºä¸è‡ªç„¶è¿æ¥ NATURAL JOIN ä¸åŒçš„æ˜¯ï¼ŒUSING æŒ‡å®šäº†å…·ä½“çš„ç›¸åŒçš„å­—æ®µåç§°ï¼Œä½ éœ€è¦åœ¨ USING çš„æ‹¬å· () ä¸­å¡«å…¥è¦æŒ‡å®šçš„åŒåå­—æ®µã€‚åŒæ—¶ä½¿ç”¨ JOINâ€¦USING å¯ä»¥ç®€åŒ– JOIN ON çš„ç­‰å€¼è¿æ¥ã€‚å®ƒä¸ä¸‹ é¢çš„ SQL æŸ¥è¯¢ç»“æœæ˜¯ç›¸åŒçš„ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SELECT employee_id,last_name,department_name</span><br><span class="line">FROM employees e ,departments d</span><br><span class="line">WHERE e.department_id = d.department_id;</span><br></pre></td></tr></table></figure><h2 id="5-å°ç»“"><a href="#5-å°ç»“" class="headerlink" title="5. å°ç»“"></a>5. å°ç»“</h2><p>è¡¨è¿æ¥çš„çº¦æŸæ¡ä»¶å¯ä»¥æœ‰ä¸‰ç§æ–¹å¼ï¼šWHERE, ON, USING </p><ul><li>WHEREï¼šé€‚ç”¨äºæ‰€æœ‰å…³è”æŸ¥è¯¢ </li><li>ON ï¼šåªèƒ½å’ŒJOINä¸€èµ·ä½¿ç”¨ï¼Œåªèƒ½å†™å…³è”æ¡ä»¶ã€‚è™½ç„¶å…³è”æ¡ä»¶å¯ä»¥å¹¶åˆ°WHEREä¸­å’Œå…¶ä»–æ¡ä»¶ä¸€èµ· å†™ï¼Œä½†åˆ†å¼€å†™å¯è¯»æ€§æ›´å¥½ã€‚ </li><li>USINGï¼šåªèƒ½å’ŒJOINä¸€èµ·ä½¿ç”¨ï¼Œè€Œä¸”è¦æ±‚ä¸¤ä¸ªå…³è”å­—æ®µåœ¨å…³è”è¡¨ä¸­åç§°ä¸€è‡´ï¼Œè€Œä¸”åªèƒ½è¡¨ç¤ºå…³è”å­— æ®µå€¼ç›¸ç­‰</li></ul><blockquote><p>æˆ‘ä»¬è¦æ§åˆ¶è¿æ¥è¡¨çš„æ•°é‡ ã€‚</p><p>å¤šè¡¨è¿æ¥å°±ç›¸å½“äºåµŒå¥— for å¾ªç¯ä¸€æ ·ï¼Œéå¸¸æ¶ˆè€—èµ„æºï¼Œä¼šè®© SQL æŸ¥è¯¢æ€§èƒ½ä¸‹ é™å¾—å¾ˆä¸¥é‡ï¼Œå› æ­¤ä¸è¦è¿æ¥ä¸å¿…è¦çš„è¡¨ã€‚</p><p>åœ¨è®¸å¤š DBMS ä¸­ï¼Œä¹Ÿéƒ½ä¼šæœ‰æœ€å¤§è¿æ¥è¡¨çš„é™åˆ¶ã€‚</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"># ä¹ é¢˜å·©å›º</span><br><span class="line"># æ³¨æ„ï¼šå½“ä¸¤ä¸ªè¡¨å¤–è¿æ¥ä¹‹åï¼Œç»„æˆä¸»è¡¨å’Œä»è¡¨ï¼Œä¸»è¡¨çš„è¿æ¥å­—æ®µæ˜¯ä¸ä¸ºç©ºçš„ï¼Œä»è¡¨çš„è¿æ¥å­—æ®µå¯èƒ½ä¸ºç©ºï¼Œå› æ­¤ä»è¡¨çš„å…³é”®å­—æ®µç”¨æ¥åˆ¤æ–­æ˜¯å¦ä¸ºç©ºã€‚</span><br><span class="line"></span><br><span class="line"># 1.æŸ¥è¯¢å“ªäº›éƒ¨é—¨æ²¡æœ‰å‘˜å·¥</span><br><span class="line"># æ–¹å¼ä¸€</span><br><span class="line">SELECT d.department_id</span><br><span class="line">FROM departments d LEFT JOIN employees e</span><br><span class="line">ON d.`department_id` = e.`department_id`</span><br><span class="line">WHERE e.`department_id` IS NULL;</span><br><span class="line"></span><br><span class="line"># æ–¹å¼äºŒ</span><br><span class="line">SELECT department_id</span><br><span class="line">FROM departments d</span><br><span class="line">WHERE NOT EXISTS (</span><br><span class="line">SELECT *</span><br><span class="line">    FROM employees e</span><br><span class="line">    WHERE e.`department_id` = d.`department_id`</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"># 2.æŸ¥è¯¢å“ªä¸ªåŸå¸‚æ²¡æœ‰éƒ¨é—¨</span><br><span class="line">SELECT l.location_id, l.city</span><br><span class="line">FROM locations l LEFT JOIN departments d</span><br><span class="line">ON l.`location_id` = d.`location_id`</span><br><span class="line">WHERE d.`location_id` IS NULL;</span><br><span class="line"></span><br><span class="line"># 3.æŸ¥è¯¢éƒ¨é—¨åä¸º Sales æˆ– IT çš„å‘˜å·¥ä¿¡æ¯</span><br><span class="line">SELECT e.employee_id, e.last_name, e.department_id</span><br><span class="line">FROM employees e JOIN department d</span><br><span class="line">ON e.`department_id` = d.`department_id`</span><br><span class="line">WHERE d.`department_name` IN (&#x27;Sales&#x27;, &#x27;IT&#x27;);</span><br></pre></td></tr></table></figure><h1 id="ç¬¬ä¸ƒç« -å•è¡Œå‡½æ•°"><a href="#ç¬¬ä¸ƒç« -å•è¡Œå‡½æ•°" class="headerlink" title="ç¬¬ä¸ƒç« _å•è¡Œå‡½æ•°"></a>ç¬¬ä¸ƒç« _å•è¡Œå‡½æ•°</h1><h2 id="1-æ•°å€¼å‡½æ•°"><a href="#1-æ•°å€¼å‡½æ•°" class="headerlink" title="1. æ•°å€¼å‡½æ•°"></a>1. æ•°å€¼å‡½æ•°</h2><h3 id="1-åŸºæœ¬å‡½æ•°"><a href="#1-åŸºæœ¬å‡½æ•°" class="headerlink" title="1) åŸºæœ¬å‡½æ•°"></a>1) åŸºæœ¬å‡½æ•°</h3><table><thead><tr><th>å‡½æ•°</th><th>ç”¨æ³•</th></tr></thead><tbody><tr><td>ABS(x)</td><td>è¿”å›xçš„ç»å¯¹å€¼</td></tr><tr><td>SIGN(X)</td><td>å•å…ƒæ ¼</td></tr><tr><td>PI()</td><td>è¿”å›åœ†å‘¨ç‡çš„å€¼</td></tr><tr><td>CEIL(x)ï¼ŒCEILING(x)</td><td>è¿”å›å¤§äºæˆ–ç­‰äºæŸä¸ªå€¼çš„æœ€å°æ•´æ•°</td></tr><tr><td>FLOOR(x)</td><td>è¿”å›å°äºæˆ–ç­‰äºæŸä¸ªå€¼çš„æœ€å¤§æ•´æ•°</td></tr><tr><td>LEAST(e1,e2,e3â€¦)</td><td>è¿”å›åˆ—è¡¨ä¸­çš„æœ€å°å€¼</td></tr><tr><td>GREATEST(e1,e2,e3â€¦)</td><td>è¿”å›åˆ—è¡¨ä¸­çš„æœ€å¤§å€¼</td></tr><tr><td>MOD(x,y)</td><td>è¿”å›Xé™¤ä»¥Yåçš„ä½™æ•°</td></tr><tr><td>RAND()</td><td>è¿”å›0~1çš„éšæœºå€¼</td></tr><tr><td>RAND(x)</td><td>è¿”å›0~1çš„éšæœºå€¼ï¼Œå…¶ä¸­xçš„å€¼ç”¨ä½œç§å­å€¼ï¼Œç›¸åŒçš„Xå€¼ä¼šäº§ç”Ÿç›¸åŒçš„éšæœº æ•°</td></tr><tr><td>ROUND(x)</td><td>è¿”å›ä¸€ä¸ªå¯¹xçš„å€¼è¿›è¡Œå››èˆäº”å…¥åï¼Œæœ€æ¥è¿‘äºXçš„æ•´æ•°</td></tr><tr><td>ROUND(x,y)</td><td>è¿”å›ä¸€ä¸ªå¯¹xçš„å€¼è¿›è¡Œå››èˆäº”å…¥åæœ€æ¥è¿‘Xçš„å€¼ï¼Œå¹¶ä¿ç•™åˆ°å°æ•°ç‚¹åé¢Yä½</td></tr><tr><td>TRUNCATE(x,y)</td><td>è¿”å›æ•°å­—xæˆªæ–­ä¸ºyä½å°æ•°çš„ç»“æœ</td></tr><tr><td>SQRT(x)</td><td>è¿”å›xçš„å¹³æ–¹æ ¹ã€‚å½“Xçš„å€¼ä¸ºè´Ÿæ•°æ—¶ï¼Œè¿”å›NULL</td></tr></tbody></table><h3 id="2-è§’åº¦ä¸å¼§åº¦äº’æ¢å‡½æ•°"><a href="#2-è§’åº¦ä¸å¼§åº¦äº’æ¢å‡½æ•°" class="headerlink" title="2) è§’åº¦ä¸å¼§åº¦äº’æ¢å‡½æ•°"></a>2) è§’åº¦ä¸å¼§åº¦äº’æ¢å‡½æ•°</h3><table><thead><tr><th>å‡½æ•°</th><th>ç”¨æ³•</th></tr></thead><tbody><tr><td>RADIANS(x)</td><td>å°†è§’åº¦è½¬åŒ–ä¸ºå¼§åº¦ï¼Œå…¶ä¸­ï¼Œå‚æ•°xä¸ºè§’åº¦å€¼</td></tr><tr><td>DEGREES(x)</td><td>å°†å¼§åº¦è½¬åŒ–ä¸ºè§’åº¦ï¼Œå…¶ä¸­ï¼Œå‚æ•°xä¸ºå¼§åº¦å€¼</td></tr></tbody></table><h3 id="3-ä¸‰è§’å‡½æ•°"><a href="#3-ä¸‰è§’å‡½æ•°" class="headerlink" title="3) ä¸‰è§’å‡½æ•°"></a>3) ä¸‰è§’å‡½æ•°</h3><table><thead><tr><th>å‡½æ•°</th><th>ç”¨æ³•</th></tr></thead><tbody><tr><td>SIN(x)</td><td>å°†è§’åº¦è½¬åŒ–ä¸ºå¼§åº¦ï¼Œå…¶ä¸­ï¼Œå‚æ•°xä¸ºè§’åº¦å€¼</td></tr><tr><td>ASIN(x)</td><td>å°†å¼§åº¦è½¬åŒ–ä¸ºè§’åº¦ï¼Œå…¶ä¸­ï¼Œå‚æ•°xä¸ºå¼§åº¦å€¼</td></tr><tr><td>COS(x)</td><td>è¿”å›xçš„ä½™å¼¦å€¼ï¼Œå…¶ä¸­ï¼Œå‚æ•°xä¸ºå¼§åº¦å€¼</td></tr><tr><td>ACOS(x)</td><td>è¿”å›xçš„åä½™å¼¦å€¼ï¼Œå³è·å–ä½™å¼¦ä¸ºxçš„å€¼ã€‚å¦‚æœxçš„å€¼ä¸åœ¨-1åˆ°1ä¹‹é—´ï¼Œåˆ™è¿”å›NULL</td></tr><tr><td>TAN(x)</td><td>è¿”å›xçš„æ­£åˆ‡å€¼ï¼Œå…¶ä¸­ï¼Œå‚æ•°xä¸ºå¼§åº¦å€¼</td></tr><tr><td>ATAN(x)</td><td>è¿”å›xçš„åæ­£åˆ‡å€¼ï¼Œå³è¿”å›æ­£åˆ‡å€¼ä¸ºxçš„å€¼</td></tr><tr><td>ATAN2(m,n)</td><td>è¿”å›ä¸¤ä¸ªå‚æ•°çš„åæ­£åˆ‡å€¼</td></tr><tr><td>COT(x)</td><td>è¿”å›xçš„ä½™åˆ‡å€¼ï¼Œå…¶ä¸­ï¼ŒXä¸ºå¼§åº¦å€¼</td></tr></tbody></table><h3 id="4-æŒ‡æ•°ä¸å¯¹æ•°å‡½æ•°"><a href="#4-æŒ‡æ•°ä¸å¯¹æ•°å‡½æ•°" class="headerlink" title="4) æŒ‡æ•°ä¸å¯¹æ•°å‡½æ•°"></a>4) æŒ‡æ•°ä¸å¯¹æ•°å‡½æ•°</h3><table><thead><tr><th>å‡½æ•°</th><th>ç”¨æ³•</th></tr></thead><tbody><tr><td>POW(x,y)ï¼ŒPOWER(X,Y)</td><td>è¿”å›xçš„yæ¬¡æ–¹</td></tr><tr><td>EXP(X)</td><td>è¿”å›eçš„Xæ¬¡æ–¹ï¼Œå…¶ä¸­eæ˜¯ä¸€ä¸ªå¸¸æ•°ï¼Œ2.718281828459045</td></tr><tr><td>LN(X)ï¼ŒLOG(X)</td><td>è¿”å›ä»¥eä¸ºåº•çš„Xçš„å¯¹æ•°ï¼Œå½“X &lt;&#x3D; 0 æ—¶ï¼Œè¿”å›çš„ç»“æœä¸ºNULL</td></tr><tr><td>LOG10(X)</td><td>è¿”å›ä»¥10ä¸ºåº•çš„Xçš„å¯¹æ•°ï¼Œå½“X &lt;&#x3D; 0 æ—¶ï¼Œè¿”å›çš„ç»“æœä¸ºNULL</td></tr><tr><td>LOG2(X)</td><td>è¿”å›ä»¥2ä¸ºåº•çš„Xçš„å¯¹æ•°ï¼Œå½“X &lt;&#x3D; 0 æ—¶ï¼Œè¿”å›NULL</td></tr></tbody></table><h3 id="5-è¿›åˆ¶é—´çš„è½¬æ¢"><a href="#5-è¿›åˆ¶é—´çš„è½¬æ¢" class="headerlink" title="5) è¿›åˆ¶é—´çš„è½¬æ¢"></a>5) è¿›åˆ¶é—´çš„è½¬æ¢</h3><table><thead><tr><th>å‡½æ•°</th><th>ç”¨æ³•</th></tr></thead><tbody><tr><td>BIN(x)</td><td>è¿”å›xçš„äºŒè¿›åˆ¶ç¼–ç </td></tr><tr><td>HEX(x)</td><td>è¿”å›xçš„åå…­è¿›åˆ¶ç¼–ç </td></tr><tr><td>OCT(x)</td><td>è¿”å›xçš„å…«è¿›åˆ¶ç¼–ç </td></tr><tr><td>CONV(x,f1,f2)</td><td>è¿”å›f1è¿›åˆ¶æ•°å˜æˆf2è¿›åˆ¶æ•°</td></tr></tbody></table><h2 id="2-å­—ç¬¦ä¸²å‡½æ•°"><a href="#2-å­—ç¬¦ä¸²å‡½æ•°" class="headerlink" title="2. å­—ç¬¦ä¸²å‡½æ•°"></a>2. å­—ç¬¦ä¸²å‡½æ•°</h2><table><thead><tr><th>å‡½æ•°</th><th>ç”¨æ³•</th></tr></thead><tbody><tr><td>ASCII(S)</td><td>è¿”å›å­—ç¬¦ä¸²Sä¸­çš„ç¬¬ä¸€ä¸ªå­—ç¬¦çš„ASCIIç å€¼</td></tr><tr><td>CHAR_LENGTH(s)</td><td>è¿”å›å­—ç¬¦ä¸²sçš„å­—ç¬¦æ•°ã€‚ä½œç”¨ä¸CHARACTER_LENGTH(s)ç›¸åŒ</td></tr><tr><td>LENGTH(s)</td><td>è¿”å›å­—ç¬¦ä¸²sçš„å­—èŠ‚æ•°ï¼Œå’Œå­—ç¬¦é›†æœ‰å…³</td></tr><tr><td>CONCAT(s1,s2,â€¦â€¦,sn)</td><td>è¿æ¥s1,s2,â€¦â€¦,snä¸ºä¸€ä¸ªå­—ç¬¦ä¸²</td></tr><tr><td>CONCAT_WS(x, s1,s2,â€¦â€¦,sn)</td><td>åŒCONCAT(s1,s2,â€¦)å‡½æ•°ï¼Œä½†æ˜¯æ¯ä¸ªå­—ç¬¦ä¸²ä¹‹é—´è¦åŠ ä¸Šx</td></tr><tr><td>INSERT(str, idx, len, replacestr)</td><td>å°†å­—ç¬¦ä¸²strä»ç¬¬idxä½ç½®å¼€å§‹ï¼Œlenä¸ªå­—ç¬¦é•¿çš„å­ä¸²æ›¿æ¢ä¸ºå­—ç¬¦ä¸²replacestr</td></tr><tr><td>REPLACE(str, a, b)</td><td>ç”¨å­—ç¬¦ä¸²bæ›¿æ¢å­—ç¬¦ä¸²strä¸­æ‰€æœ‰å‡ºç°çš„å­—ç¬¦ä¸²a</td></tr><tr><td>UPPER(s) æˆ– UCASE(s)</td><td>å°†å­—ç¬¦ä¸²sçš„æ‰€æœ‰å­—æ¯è½¬æˆå¤§å†™å­—æ¯</td></tr><tr><td>LOWER(s) æˆ–LCASE(s)</td><td>å°†å­—ç¬¦ä¸²sçš„æ‰€æœ‰å­—æ¯è½¬æˆå°å†™å­—æ¯</td></tr><tr><td>LEFT(str,n)</td><td>è¿”å›å­—ç¬¦ä¸²stræœ€å·¦è¾¹çš„nä¸ªå­—ç¬¦</td></tr><tr><td>RIGHT(str,n)</td><td>è¿”å›å­—ç¬¦ä¸²stræœ€å³è¾¹çš„nä¸ªå­—ç¬¦</td></tr><tr><td>LPAD(str, len, pad)</td><td>ç”¨å­—ç¬¦ä¸²padå¯¹stræœ€å·¦è¾¹è¿›è¡Œå¡«å……ï¼Œç›´åˆ°strçš„é•¿åº¦ä¸ºlenä¸ªå­—ç¬¦</td></tr><tr><td>RPAD(str ,len, pad)</td><td>ç”¨å­—ç¬¦ä¸²padå¯¹stræœ€å³è¾¹è¿›è¡Œå¡«å……ï¼Œç›´åˆ°strçš„é•¿åº¦ä¸ºlenä¸ªå­—ç¬¦</td></tr><tr><td>LTRIM(s)</td><td>å»æ‰å­—ç¬¦ä¸²så·¦ä¾§çš„ç©ºæ ¼</td></tr><tr><td>RTRIM(s)</td><td>å»æ‰å­—ç¬¦ä¸²så³ä¾§çš„ç©ºæ ¼</td></tr><tr><td>TRIM(s)</td><td>å»æ‰å­—ç¬¦ä¸²så¼€å§‹ä¸ç»“å°¾çš„ç©ºæ ¼</td></tr><tr><td>TRIM(s1 FROM s)</td><td>å»æ‰å­—ç¬¦ä¸²så¼€å§‹ä¸ç»“å°¾çš„s1</td></tr><tr><td>TRIM(LEADING s1 FROM s)</td><td>å»æ‰å­—ç¬¦ä¸²så¼€å§‹å¤„çš„s1</td></tr><tr><td>TRIM(TRAILING s1 FROM s)</td><td>å»æ‰å­—ç¬¦ä¸²sç»“å°¾å¤„çš„s1</td></tr><tr><td>REPEAT(str, n)</td><td>è¿”å›stré‡å¤næ¬¡çš„ç»“æœ</td></tr><tr><td>SPACE(n)</td><td>è¿”å›nä¸ªç©ºæ ¼</td></tr><tr><td>STRCMP(s1,s2)</td><td>æ¯”è¾ƒå­—ç¬¦ä¸²s1,s2çš„ASCIIç å€¼çš„å¤§å°</td></tr><tr><td>SUBSTR(s,index,len)</td><td>è¿”å›ä»å­—ç¬¦ä¸²sçš„indexä½ç½®å…¶lenä¸ªå­—ç¬¦ï¼Œä½œç”¨ä¸SUBSTRING(s,n,len)ã€ MID(s,n,len)ç›¸åŒ</td></tr><tr><td>LOCATE(substr,str)</td><td>è¿”å›å­—ç¬¦ä¸²substråœ¨å­—ç¬¦ä¸²strä¸­é¦–æ¬¡å‡ºç°çš„ä½ç½®ï¼Œä½œç”¨äºPOSITION(substr IN str)ã€INSTR(str,substr)ç›¸åŒã€‚æœªæ‰¾åˆ°ï¼Œè¿”å›0</td></tr><tr><td>ELT(m,s1,s2,â€¦,sn)</td><td>è¿”å›æŒ‡å®šä½ç½®çš„å­—ç¬¦ä¸²ï¼Œå¦‚æœm&#x3D;1ï¼Œåˆ™è¿”å›s1ï¼Œå¦‚æœm&#x3D;2ï¼Œåˆ™è¿”å›s2ï¼Œå¦‚æœm&#x3D;nï¼Œåˆ™è¿”å›sn</td></tr><tr><td>FIELD(s,s1,s2,â€¦,sn)</td><td>è¿”å›å­—ç¬¦ä¸²såœ¨å­—ç¬¦ä¸²åˆ—è¡¨ä¸­ç¬¬ä¸€æ¬¡å‡ºç°çš„ä½ç½®</td></tr><tr><td>FIND_IN_SET(s1,s2)</td><td>è¿”å›å­—ç¬¦ä¸²s1åœ¨å­—ç¬¦ä¸²s2ä¸­å‡ºç°çš„ä½ç½®ã€‚å…¶ä¸­ï¼Œå­—ç¬¦ä¸²s2æ˜¯ä¸€ä¸ªä»¥é€—å·åˆ†éš”çš„å­—ç¬¦ä¸²</td></tr><tr><td>REVERSE(s)</td><td>è¿”å›såè½¬åçš„å­—ç¬¦ä¸²</td></tr><tr><td>NULLIF(value1,value2)</td><td>æ¯”è¾ƒä¸¤ä¸ªå­—ç¬¦ä¸²ï¼Œå¦‚æœvalue1ä¸value2ç›¸ç­‰ï¼Œåˆ™è¿”å›NULLï¼Œå¦åˆ™è¿”å› value1</td></tr></tbody></table><blockquote><p>æ³¨æ„ï¼šMySQLä¸­ï¼Œå­—ç¬¦ä¸²çš„ä½ç½®æ˜¯ä»1å¼€å§‹çš„ã€‚</p></blockquote><h2 id="3-æ—¥æœŸå’Œæ—¶é—´å‡½æ•°"><a href="#3-æ—¥æœŸå’Œæ—¶é—´å‡½æ•°" class="headerlink" title="3. æ—¥æœŸå’Œæ—¶é—´å‡½æ•°"></a>3. æ—¥æœŸå’Œæ—¶é—´å‡½æ•°</h2><h3 id="1-è·å–æ—¥æœŸã€æ—¶é—´"><a href="#1-è·å–æ—¥æœŸã€æ—¶é—´" class="headerlink" title="1) è·å–æ—¥æœŸã€æ—¶é—´"></a>1) è·å–æ—¥æœŸã€æ—¶é—´</h3><table><thead><tr><th>å‡½æ•°</th><th>ç”¨æ³•</th></tr></thead><tbody><tr><td>CURDATE() ï¼ŒCURRENT_DATE()</td><td>è¿”å›å½“å‰æ—¥æœŸï¼ŒåªåŒ…å«å¹´ã€ æœˆã€æ—¥</td></tr><tr><td>CURTIME() ï¼Œ CURRENT_TIME()</td><td>è¿”å›å½“å‰æ—¶é—´ï¼ŒåªåŒ…å«æ—¶ã€ åˆ†ã€ç§’</td></tr><tr><td>NOW() &#x2F; SYSDATE() &#x2F; CURRENT_TIMESTAMP() &#x2F; LOCALTIME() &#x2F; LOCALTIMESTAMP()</td><td>è¿”å›å½“å‰ç³»ç»Ÿæ—¥æœŸå’Œæ—¶é—´</td></tr><tr><td>UTC_DATE()</td><td>è¿”å›UTCï¼ˆä¸–ç•Œæ ‡å‡†æ—¶é—´ï¼‰ æ—¥æœŸ</td></tr><tr><td>UTC_TIME()</td><td>è¿”å›UTCï¼ˆä¸–ç•Œæ ‡å‡†æ—¶é—´ï¼‰ æ—¶é—´</td></tr></tbody></table><h3 id="2-æ—¥æœŸä¸æ—¶é—´æˆ³çš„è½¬æ¢"><a href="#2-æ—¥æœŸä¸æ—¶é—´æˆ³çš„è½¬æ¢" class="headerlink" title="2) æ—¥æœŸä¸æ—¶é—´æˆ³çš„è½¬æ¢"></a>2) æ—¥æœŸä¸æ—¶é—´æˆ³çš„è½¬æ¢</h3><table><thead><tr><th>å‡½æ•°</th><th>ç”¨æ³•</th></tr></thead><tbody><tr><td>UNIX_TIMESTAMP()</td><td>ä»¥UNIXæ—¶é—´æˆ³çš„å½¢å¼è¿”å›å½“å‰æ—¶é—´ã€‚SELECT UNIX_TIMESTAMP() - &gt;1634348884</td></tr><tr><td>UNIX_TIMESTAMP(date)</td><td>å°†æ—¶é—´dateä»¥UNIXæ—¶é—´æˆ³çš„å½¢å¼è¿”å›ã€‚</td></tr><tr><td>FROM_UNIXTIME(timestamp)</td><td>å°†UNIXæ—¶é—´æˆ³çš„æ—¶é—´è½¬æ¢ä¸ºæ™®é€šæ ¼å¼çš„æ—¶é—´</td></tr></tbody></table><h3 id="3-è·å–æœˆä»½ã€æ˜ŸæœŸã€æ˜ŸæœŸæ•°ã€å¤©æ•°ç­‰å‡½æ•°"><a href="#3-è·å–æœˆä»½ã€æ˜ŸæœŸã€æ˜ŸæœŸæ•°ã€å¤©æ•°ç­‰å‡½æ•°" class="headerlink" title="3) è·å–æœˆä»½ã€æ˜ŸæœŸã€æ˜ŸæœŸæ•°ã€å¤©æ•°ç­‰å‡½æ•°"></a>3) è·å–æœˆä»½ã€æ˜ŸæœŸã€æ˜ŸæœŸæ•°ã€å¤©æ•°ç­‰å‡½æ•°</h3><table><thead><tr><th>å‡½æ•°</th><th>ç”¨æ³•</th></tr></thead><tbody><tr><td>YEAR(date) &#x2F; MONTH(date) &#x2F; DAY(date)</td><td>è¿”å›å…·ä½“çš„æ—¥æœŸå€¼</td></tr><tr><td>HOUR(time) &#x2F; MINUTE(time) &#x2F; SECOND(time)</td><td>è¿”å›å…·ä½“çš„æ—¶é—´å€¼</td></tr><tr><td>FROM_UNIXTIME(timestamp)</td><td>å°†UNIXæ—¶é—´æˆ³çš„æ—¶é—´è½¬æ¢ä¸ºæ™®é€šæ ¼å¼çš„æ—¶é—´</td></tr><tr><td>MONTHNAME(date)</td><td>è¿”å›æœˆä»½ï¼šJanuaryï¼Œâ€¦</td></tr><tr><td>DAYNAME(date)</td><td>è¿”å›æ˜ŸæœŸå‡ ï¼šMONDAYï¼ŒTUESDAYâ€¦..SUNDAY</td></tr><tr><td>WEEKDAY(date)</td><td>è¿”å›å‘¨å‡ ï¼Œæ³¨æ„ï¼Œå‘¨1æ˜¯0ï¼Œå‘¨2æ˜¯1ï¼Œã€‚ã€‚ã€‚å‘¨æ—¥æ˜¯6</td></tr><tr><td>QUARTER(date)</td><td>è¿”å›æ—¥æœŸå¯¹åº”çš„å­£åº¦ï¼ŒèŒƒå›´ä¸º1ï½4</td></tr><tr><td>WEEK(date) ï¼Œ WEEKOFYEAR(date)</td><td>è¿”å›ä¸€å¹´ä¸­çš„ç¬¬å‡ å‘¨</td></tr><tr><td>DAYOFYEAR(date)</td><td>è¿”å›æ—¥æœŸæ˜¯ä¸€å¹´ä¸­çš„ç¬¬å‡ å¤©</td></tr><tr><td>DAYOFMONTH(date)</td><td>è¿”å›æ—¥æœŸä½äºæ‰€åœ¨æœˆä»½çš„ç¬¬å‡ å¤©</td></tr><tr><td>DAYOFWEEK(date)</td><td>è¿”å›å‘¨å‡ ï¼Œæ³¨æ„ï¼šå‘¨æ—¥æ˜¯1ï¼Œå‘¨ä¸€æ˜¯2ï¼Œã€‚ã€‚ã€‚å‘¨å…­æ˜¯ 7</td></tr></tbody></table><h3 id="4-æ—¥æœŸçš„æ“ä½œå‡½æ•°"><a href="#4-æ—¥æœŸçš„æ“ä½œå‡½æ•°" class="headerlink" title="4) æ—¥æœŸçš„æ“ä½œå‡½æ•°"></a>4) æ—¥æœŸçš„æ“ä½œå‡½æ•°</h3><table><thead><tr><th>å‡½æ•°</th><th>ç”¨æ³•</th></tr></thead><tbody><tr><td>EXTRACT(type FROM date)</td><td>è¿”å›æŒ‡å®šæ—¥æœŸä¸­ç‰¹å®šçš„éƒ¨åˆ†ï¼ŒtypeæŒ‡å®šè¿”å›çš„å€¼</td></tr></tbody></table><p>EXTRACT(type FROM date)å‡½æ•°ä¸­typeçš„å–å€¼ä¸å«ä¹‰ï¼š</p><p><img src="/MySQL%E5%9F%BA%E7%A1%80%E7%AF%87.assets/image-20220601162705975.png" alt="image-20220601162705975"></p><h3 id="5-æ—¶é—´å’Œç§’é’Ÿè½¬æ¢çš„å‡½æ•°"><a href="#5-æ—¶é—´å’Œç§’é’Ÿè½¬æ¢çš„å‡½æ•°" class="headerlink" title="5) æ—¶é—´å’Œç§’é’Ÿè½¬æ¢çš„å‡½æ•°"></a>5) æ—¶é—´å’Œç§’é’Ÿè½¬æ¢çš„å‡½æ•°</h3><table><thead><tr><th>å‡½æ•°</th><th>ç”¨æ³•</th></tr></thead><tbody><tr><td>TIME_TO_SEC(time)</td><td>å°† time è½¬åŒ–ä¸ºç§’å¹¶è¿”å›ç»“æœå€¼ã€‚è½¬åŒ–çš„å…¬å¼ä¸ºï¼š å°æ—¶*3600+åˆ†é’Ÿ *60+ç§’</td></tr><tr><td>SEC_TO_TIME(seconds)</td><td>å°† seconds æè¿°è½¬åŒ–ä¸ºåŒ…å«å°æ—¶ã€åˆ†é’Ÿå’Œç§’çš„æ—¶é—´</td></tr></tbody></table><h3 id="6-è®¡ç®—æ—¥æœŸå’Œæ—¶é—´çš„å‡½æ•°"><a href="#6-è®¡ç®—æ—¥æœŸå’Œæ—¶é—´çš„å‡½æ•°" class="headerlink" title="6) è®¡ç®—æ—¥æœŸå’Œæ—¶é—´çš„å‡½æ•°"></a>6) è®¡ç®—æ—¥æœŸå’Œæ—¶é—´çš„å‡½æ•°</h3><table><thead><tr><th>å‡½æ•°</th><th>ç”¨æ³•</th></tr></thead><tbody><tr><td>DATE_ADD(datetime, INTERVAL expr type)ï¼Œ ADDDATE(date,INTERVAL expr type)</td><td>è¿”å›ä¸ç»™å®šæ—¥æœŸæ—¶é—´ç›¸å·®INTERVALæ—¶é—´æ®µçš„æ—¥æœŸæ—¶é—´</td></tr><tr><td>DATE_SUB(date,INTERVAL expr type)ï¼Œ SUBDATE(date,INTERVAL expr type)</td><td>è¿”å›ä¸dateç›¸å·®INTERVALæ—¶é—´é—´éš”çš„æ—¥æœŸ</td></tr></tbody></table><p>ä¸Šè¿°å‡½æ•°ä¸­typeçš„å–å€¼ï¼š</p><p><img src="/MySQL%E5%9F%BA%E7%A1%80%E7%AF%87.assets/image-20220601165055639.png" alt="image-20220601165055639"></p><table><thead><tr><th>å‡½æ•°</th><th>ç”¨æ³•</th></tr></thead><tbody><tr><td>ADDTIME(time1,time2)</td><td>è¿”å›time1åŠ ä¸Štime2çš„æ—¶é—´ã€‚å½“time2ä¸ºä¸€ä¸ªæ•°å­—æ—¶ï¼Œä»£è¡¨çš„æ˜¯ ç§’ ï¼Œå¯ä»¥ä¸ºè´Ÿæ•°</td></tr><tr><td>SUBTIME(time1,time2)</td><td>è¿”å›time1å‡å»time2åçš„æ—¶é—´ã€‚å½“time2ä¸ºä¸€ä¸ªæ•°å­—æ—¶ï¼Œä»£è¡¨çš„ æ˜¯ ç§’ ï¼Œå¯ä»¥ä¸ºè´Ÿæ•°</td></tr><tr><td>DATEDIFF(date1,date2)</td><td>è¿”å›date1 - date2çš„æ—¥æœŸé—´éš”å¤©æ•°</td></tr><tr><td>TIMEDIFF(time1, time2)</td><td>è¿”å›time1 - time2çš„æ—¶é—´é—´éš”</td></tr><tr><td>FROM_DAYS(N)</td><td>è¿”å›ä»0000å¹´1æœˆ1æ—¥èµ·ï¼ŒNå¤©ä»¥åçš„æ—¥æœŸ</td></tr><tr><td>TO_DAYS(date)</td><td>è¿”å›æ—¥æœŸdateè·ç¦»0000å¹´1æœˆ1æ—¥çš„å¤©æ•°</td></tr><tr><td>LAST_DAY(date)</td><td>è¿”å›dateæ‰€åœ¨æœˆä»½çš„æœ€åä¸€å¤©çš„æ—¥æœŸ</td></tr><tr><td>MAKEDATE(year,n)</td><td>é’ˆå¯¹ç»™å®šå¹´ä»½ä¸æ‰€åœ¨å¹´ä»½ä¸­çš„å¤©æ•°è¿”å›ä¸€ä¸ªæ—¥æœŸ</td></tr><tr><td>MAKETIME(hour,minute,second)</td><td>å°†ç»™å®šçš„å°æ—¶ã€åˆ†é’Ÿå’Œç§’ç»„åˆæˆæ—¶é—´å¹¶è¿”å›</td></tr><tr><td>PERIOD_ADD(time,n)</td><td>è¿”å›timeåŠ ä¸Šnåçš„æ—¶é—´</td></tr></tbody></table><h3 id="7-æ—¥æœŸçš„æ ¼å¼åŒ–ä¸è§£æ"><a href="#7-æ—¥æœŸçš„æ ¼å¼åŒ–ä¸è§£æ" class="headerlink" title="7)  æ—¥æœŸçš„æ ¼å¼åŒ–ä¸è§£æ"></a>7)  æ—¥æœŸçš„æ ¼å¼åŒ–ä¸è§£æ</h3><table><thead><tr><th>å‡½æ•°</th><th>ç”¨æ³•</th></tr></thead><tbody><tr><td>DATE_FORMAT(date,fmt)</td><td>æŒ‰ç…§å­—ç¬¦ä¸²fmtæ ¼å¼åŒ–æ—¥æœŸdateå€¼</td></tr><tr><td>TIME_FORMAT(time,fmt)</td><td>æŒ‰ç…§å­—ç¬¦ä¸²fmtæ ¼å¼åŒ–æ—¶é—´timeå€¼</td></tr><tr><td>GET_FORMAT(date_type,format_type)</td><td>è¿”å›æ—¥æœŸå­—ç¬¦ä¸²çš„æ˜¾ç¤ºæ ¼å¼</td></tr><tr><td>STR_TO_DATE(str, fmt)</td><td>æŒ‰ç…§å­—ç¬¦ä¸²fmtå¯¹strè¿›è¡Œè§£æï¼Œè§£æä¸ºä¸€ä¸ªæ—¥æœŸ</td></tr></tbody></table><p>ä¸Šè¿° éGET_FORMAT å‡½æ•°ä¸­fmtå‚æ•°å¸¸ç”¨çš„æ ¼å¼ç¬¦ï¼š</p><table><thead><tr><th>æ ¼å¼ç¬¦</th><th>è¯´æ˜</th><th>æ ¼å¼ç¬¦</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>%Y</td><td>4ä½æ•°å­—è¡¨ç¤ºå¹´ä»½</td><td>%y</td><td>è¡¨ç¤ºä¸¤ä½æ•°å­—è¡¨ç¤ºå¹´ä»½</td></tr><tr><td>%M</td><td>æœˆåè¡¨ç¤ºæœˆä»½ï¼ˆJanuary,â€¦.ï¼‰</td><td>%m</td><td>ä¸¤ä½æ•°å­—è¡¨ç¤ºæœˆä»½ ï¼ˆ01,02,03ã€‚ã€‚ã€‚ï¼‰</td></tr><tr><td>%b</td><td>ç¼©å†™çš„æœˆåï¼ˆJan.ï¼ŒFeb.ï¼Œâ€¦.ï¼‰</td><td>%c</td><td>æ•°å­—è¡¨ç¤ºæœˆä»½ï¼ˆ1,2,3,â€¦ï¼‰</td></tr><tr><td>%D</td><td>è‹±æ–‡åç¼€è¡¨ç¤ºæœˆä¸­çš„å¤©æ•° ï¼ˆ1st,2nd,3rd,â€¦ï¼‰</td><td>%d</td><td>ä¸¤ä½æ•°å­—è¡¨ç¤ºæœˆä¸­çš„å¤©æ•°(01,02â€¦)</td></tr><tr><td>%e</td><td>æ•°å­—å½¢å¼è¡¨ç¤ºæœˆä¸­çš„å¤©æ•° ï¼ˆ1,2,3,4,5â€¦..ï¼‰</td><td></td><td></td></tr><tr><td>%H</td><td>ä¸¤ä½æ•°å­—è¡¨ç¤ºå°æ•°ï¼Œ24å°æ—¶åˆ¶ ï¼ˆ01,02..ï¼‰</td><td>%h å’Œ%I</td><td>ä¸¤ä½æ•°å­—è¡¨ç¤ºå°æ—¶ï¼Œ12å°æ—¶åˆ¶ ï¼ˆ01,02..ï¼‰</td></tr><tr><td>%k</td><td>æ•°å­—å½¢å¼çš„å°æ—¶ï¼Œ24å°æ—¶åˆ¶(1,2,3)</td><td>%l</td><td>æ•°å­—å½¢å¼è¡¨ç¤ºå°æ—¶ï¼Œ12å°æ—¶åˆ¶ ï¼ˆ1,2,3,4â€¦.ï¼‰</td></tr><tr><td>%i</td><td>ä¸¤ä½æ•°å­—è¡¨ç¤ºåˆ†é’Ÿï¼ˆ00,01,02ï¼‰</td><td>%S å’Œ%s</td><td>ä¸¤ä½æ•°å­—è¡¨ç¤ºç§’(00,01,02â€¦)</td></tr><tr><td>%W</td><td>ä¸€å‘¨ä¸­çš„æ˜ŸæœŸåç§°ï¼ˆSundayâ€¦ï¼‰</td><td>%a</td><td>ä¸€å‘¨ä¸­çš„æ˜ŸæœŸç¼©å†™ï¼ˆSun.ï¼Œ Mon.,Tues.ï¼Œ..ï¼‰</td></tr><tr><td>%w</td><td>ä»¥æ•°å­—è¡¨ç¤ºå‘¨ä¸­çš„å¤©æ•° (0&#x3D;Sunday,1&#x3D;Mondayâ€¦.)</td><td></td><td></td></tr><tr><td>%j</td><td>ä»¥3ä½æ•°å­—è¡¨ç¤ºå¹´ä¸­çš„å¤©æ•°(001,002â€¦)</td><td>%U</td><td>ä»¥æ•°å­—è¡¨ç¤ºå¹´ä¸­çš„ç¬¬å‡ å‘¨ï¼Œ ï¼ˆ1,2,3ã€‚ã€‚ï¼‰å…¶ä¸­Sundayä¸ºå‘¨ä¸­ç¬¬ä¸€ å¤©</td></tr><tr><td>%u</td><td>ä»¥æ•°å­—è¡¨ç¤ºå¹´ä¸­çš„ç¬¬å‡ å‘¨ï¼Œ ï¼ˆ1,2,3ã€‚ã€‚ï¼‰å…¶ä¸­Mondayä¸ºå‘¨ä¸­ç¬¬ä¸€ å¤©</td><td></td><td></td></tr><tr><td>%T</td><td>24å°æ—¶åˆ¶</td><td>%r</td><td>12å°æ—¶åˆ¶</td></tr><tr><td>%p</td><td>AMæˆ–PM</td><td>%%</td><td>è¡¨ç¤º%</td></tr></tbody></table><h2 id="4-æµç¨‹æ§åˆ¶å‡½æ•°"><a href="#4-æµç¨‹æ§åˆ¶å‡½æ•°" class="headerlink" title="4. æµç¨‹æ§åˆ¶å‡½æ•°"></a>4. æµç¨‹æ§åˆ¶å‡½æ•°</h2><p>æµç¨‹å¤„ç†å‡½æ•°å¯ä»¥æ ¹æ®ä¸åŒçš„æ¡ä»¶ï¼Œæ‰§è¡Œä¸åŒçš„å¤„ç†æµç¨‹ï¼Œå¯ä»¥åœ¨SQLè¯­å¥ä¸­å®ç°ä¸åŒçš„æ¡ä»¶é€‰æ‹©ã€‚ MySQLä¸­çš„æµç¨‹å¤„ç†å‡½æ•°ä¸»è¦åŒ…æ‹¬IF()ã€IFNULL()å’ŒCASE()å‡½æ•°ã€‚</p><table><thead><tr><th>å‡½æ•°</th><th>ç”¨æ³•</th></tr></thead><tbody><tr><td>IF(value,value1,value2)</td><td>å¦‚æœvalueçš„å€¼ä¸ºTRUEï¼Œè¿”å›value1ï¼Œ å¦åˆ™è¿”å›value2</td></tr><tr><td>IFNULL(value1, value2)</td><td>å¦‚æœvalue1ä¸ä¸ºNULLï¼Œè¿”å›value1ï¼Œå¦åˆ™è¿”å›value2</td></tr><tr><td>CASE WHEN æ¡ä»¶1 THEN ç»“æœ1 WHEN æ¡ä»¶2 THEN ç»“æœ2 â€¦. [ELSE resultn] END</td><td>ç›¸å½“äºJavaçš„ifâ€¦else ifâ€¦elseâ€¦</td></tr><tr><td>CASE expr WHEN å¸¸é‡å€¼1 THEN å€¼1 WHEN å¸¸é‡å€¼1 THEN å€¼1 â€¦. [ELSE å€¼n] END</td><td>ç›¸å½“äºJavaçš„switchâ€¦caseâ€¦</td></tr></tbody></table><h2 id="5-åŠ å¯†ä¸è§£å¯†å‡½æ•°"><a href="#5-åŠ å¯†ä¸è§£å¯†å‡½æ•°" class="headerlink" title="5. åŠ å¯†ä¸è§£å¯†å‡½æ•°"></a>5. åŠ å¯†ä¸è§£å¯†å‡½æ•°</h2><p>åŠ å¯†ä¸è§£å¯†å‡½æ•°ä¸»è¦ç”¨äºå¯¹æ•°æ®åº“ä¸­çš„æ•°æ®è¿›è¡ŒåŠ å¯†å’Œè§£å¯†å¤„ç†ï¼Œä»¥é˜²æ­¢æ•°æ®è¢«ä»–äººçªƒå–ã€‚è¿™äº›å‡½æ•°åœ¨ä¿è¯æ•°æ®åº“å®‰å…¨æ—¶éå¸¸æœ‰ç”¨ã€‚</p><table><thead><tr><th>å‡½æ•°</th><th>ç”¨æ³•</th></tr></thead><tbody><tr><td>PASSWORD(str)</td><td>è¿”å›å­—ç¬¦ä¸²strçš„åŠ å¯†ç‰ˆæœ¬ï¼Œ41ä½é•¿çš„å­—ç¬¦ä¸²ã€‚åŠ å¯†ç»“æœä¸å¯é€† ï¼Œå¸¸ç”¨äºç”¨æˆ·çš„å¯†ç åŠ å¯†</td></tr><tr><td>MD5(str)</td><td>è¿”å›å­—ç¬¦ä¸²strçš„md5åŠ å¯†åçš„å€¼ï¼Œä¹Ÿæ˜¯ä¸€ç§åŠ å¯†æ–¹å¼ã€‚è‹¥å‚æ•°ä¸º NULLï¼Œåˆ™ä¼šè¿”å›NULL</td></tr><tr><td>SHA(str)</td><td>ä»åŸæ˜æ–‡å¯†ç strè®¡ç®—å¹¶è¿”å›åŠ å¯†åçš„å¯†ç å­—ç¬¦ä¸²ï¼Œå½“å‚æ•°ä¸º NULLæ—¶ï¼Œè¿”å›NULLã€‚ SHAåŠ å¯†ç®—æ³•æ¯”MD5æ›´åŠ å®‰å…¨ ã€‚</td></tr><tr><td>ENCODE(value,password_seed)</td><td>è¿”å›ä½¿ç”¨password_seedä½œä¸ºåŠ å¯†å¯†ç åŠ å¯†value</td></tr><tr><td>DECODE(value,password_seed)</td><td>è¿”å›ä½¿ç”¨password_seedä½œä¸ºåŠ å¯†å¯†ç è§£å¯†value</td></tr></tbody></table><h2 id="6-MySQLä¿¡æ¯å‡½æ•°"><a href="#6-MySQLä¿¡æ¯å‡½æ•°" class="headerlink" title="6. MySQLä¿¡æ¯å‡½æ•°"></a>6. MySQLä¿¡æ¯å‡½æ•°</h2><p>MySQLä¸­å†…ç½®äº†ä¸€äº›å¯ä»¥æŸ¥è¯¢MySQLä¿¡æ¯çš„å‡½æ•°ï¼Œè¿™äº›å‡½æ•°ä¸»è¦ç”¨äºå¸®åŠ©æ•°æ®åº“å¼€å‘æˆ–è¿ç»´äººå‘˜æ›´å¥½åœ° å¯¹æ•°æ®åº“è¿›è¡Œç»´æŠ¤å·¥ä½œã€‚</p><table><thead><tr><th>å‡½æ•°</th><th>ç”¨æ³•</th></tr></thead><tbody><tr><td>VERSION()</td><td>è¿”å›å½“å‰MySQLçš„ç‰ˆæœ¬å·</td></tr><tr><td>CONNECTION_ID()</td><td>è¿”å›å½“å‰MySQLæœåŠ¡å™¨çš„è¿æ¥æ•°</td></tr><tr><td>DATABASE()ï¼ŒSCHEMA()</td><td>è¿”å›MySQLå‘½ä»¤è¡Œå½“å‰æ‰€åœ¨çš„æ•°æ®åº“</td></tr><tr><td>USER()ï¼ŒCURRENT_USER()ã€SYSTEM_USER()ï¼Œ SESSION_USER()</td><td>è¿”å›å½“å‰è¿æ¥MySQLçš„ç”¨æˆ·åï¼Œè¿”å›ç»“æœæ ¼å¼ä¸º â€œä¸»æœºå@ç”¨æˆ·åâ€</td></tr><tr><td>CHARSET(value)</td><td>è¿”å›å­—ç¬¦ä¸²valueè‡ªå˜é‡çš„å­—ç¬¦é›†</td></tr><tr><td>COLLATION(value)</td><td>è¿”å›å­—ç¬¦ä¸²valueçš„æ¯”è¾ƒè§„åˆ™</td></tr></tbody></table><p>MySQLä¸­æœ‰äº›å‡½æ•°æ— æ³•å¯¹å…¶è¿›è¡Œå…·ä½“çš„åˆ†ç±»ï¼Œä½†æ˜¯è¿™äº›å‡½æ•°åœ¨MySQLçš„å¼€å‘å’Œè¿ç»´è¿‡ç¨‹ä¸­ä¹Ÿæ˜¯ä¸å®¹å¿½è§† çš„ã€‚</p><table><thead><tr><th>å‡½æ•°</th><th>ç”¨æ³•</th></tr></thead><tbody><tr><td>FORMAT(value,n)</td><td>è¿”å›å¯¹æ•°å­—valueè¿›è¡Œæ ¼å¼åŒ–åçš„ç»“æœæ•°æ®ã€‚nè¡¨ç¤º å››èˆäº”å…¥ åä¿ç•™ åˆ°å°æ•°ç‚¹ånä½</td></tr><tr><td>CONV(value,from,to)</td><td>å°†valueçš„å€¼è¿›è¡Œä¸åŒè¿›åˆ¶ä¹‹é—´çš„è½¬æ¢</td></tr><tr><td>INET_ATON(ipvalue)</td><td>å°†ä»¥ç‚¹åˆ†éš”çš„IPåœ°å€è½¬åŒ–ä¸ºä¸€ä¸ªæ•°å­—</td></tr><tr><td>INET_NTOA(value)</td><td>å°†æ•°å­—å½¢å¼çš„IPåœ°å€è½¬åŒ–ä¸ºä»¥ç‚¹åˆ†éš”çš„IPåœ°å€</td></tr><tr><td>BENCHMARK(n,expr)</td><td>å°†è¡¨è¾¾å¼expré‡å¤æ‰§è¡Œnæ¬¡ã€‚ç”¨äºæµ‹è¯•MySQLå¤„ç†exprè¡¨è¾¾å¼æ‰€è€—è´¹ çš„æ—¶é—´</td></tr><tr><td>CONVERT(value USING char_code)</td><td>å°†valueæ‰€ä½¿ç”¨çš„å­—ç¬¦ç¼–ç ä¿®æ”¹ä¸ºchar_code</td></tr></tbody></table><h1 id="ç¬¬å…«ç« -èšåˆå‡½æ•°"><a href="#ç¬¬å…«ç« -èšåˆå‡½æ•°" class="headerlink" title="ç¬¬å…«ç« _èšåˆå‡½æ•°"></a>ç¬¬å…«ç« _èšåˆå‡½æ•°</h1><h2 id="1-èšåˆå‡½æ•°ä»‹ç»"><a href="#1-èšåˆå‡½æ•°ä»‹ç»" class="headerlink" title="1. èšåˆå‡½æ•°ä»‹ç»"></a>1. èšåˆå‡½æ•°ä»‹ç»</h2><ul><li>ä»€ä¹ˆæ˜¯èšåˆå‡½æ•°</li></ul><p>èšåˆå‡½æ•°ä½œç”¨äºä¸€ç»„æ•°æ®ï¼Œå¹¶å¯¹ä¸€ç»„æ•°æ®è¿”å›ä¸€ä¸ªå€¼ã€‚</p><ul><li>èšåˆå‡½æ•°ç±»å‹<ul><li>AVG()</li><li>SUM()</li><li>MAX()</li><li>MIN()</li><li>COUNT()</li></ul></li></ul><h3 id="1-AVGå’ŒSUMå‡½æ•°"><a href="#1-AVGå’ŒSUMå‡½æ•°" class="headerlink" title="1) AVGå’ŒSUMå‡½æ•°"></a>1) AVGå’ŒSUMå‡½æ•°</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SELECT AVG(salary), MAX(salary),MIN(salary), SUM(salary)</span><br><span class="line">FROM employees</span><br><span class="line">WHERE job_id LIKE &#x27;%REP%&#x27;;</span><br></pre></td></tr></table></figure><h3 id="2-MINå’ŒMAXå‡½æ•°"><a href="#2-MINå’ŒMAXå‡½æ•°" class="headerlink" title="2) MINå’ŒMAXå‡½æ•°"></a>2) MINå’ŒMAXå‡½æ•°</h3><p>å¯ä»¥å¯¹ä»»æ„æ•°æ®ç±»å‹çš„æ•°æ®ä½¿ç”¨ MIN å’Œ MAX å‡½æ•°ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT MIN(hire_date), MAX(hire_date)</span><br><span class="line">FROM employees;</span><br></pre></td></tr></table></figure><h3 id="3-COUNTå‡½æ•°"><a href="#3-COUNTå‡½æ•°" class="headerlink" title="3) COUNTå‡½æ•°"></a>3) COUNTå‡½æ•°</h3><p>COUNT(*)è¿”å›è¡¨ä¸­è®°å½•æ€»æ•°ï¼Œé€‚ç”¨äºä»»æ„æ•°æ®ç±»å‹ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SELECT COUNT(*)</span><br><span class="line">FROM employees</span><br><span class="line">WHERE department_id = 50;</span><br></pre></td></tr></table></figure><p>COUNT(expr) è¿”å›exprä¸ä¸ºç©ºçš„è®°å½•æ€»æ•°ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SELECT COUNT(commission_pct)</span><br><span class="line">FROM employees</span><br><span class="line">WHERE department_id = 50;</span><br></pre></td></tr></table></figure><ul><li>é—®é¢˜ï¼šç”¨count(*)ï¼Œcount(1)ï¼Œcount(åˆ—å)è°å¥½å‘¢?</li></ul><p>å…¶å®ï¼Œå¯¹äºMyISAMå¼•æ“çš„è¡¨æ˜¯æ²¡æœ‰åŒºåˆ«çš„ã€‚è¿™ç§å¼•æ“å†…éƒ¨æœ‰ä¸€è®¡æ•°å™¨åœ¨ç»´æŠ¤ç€è¡Œæ•°ã€‚ Innodbå¼•æ“çš„è¡¨ç”¨count(*),count(1)ç›´æ¥è¯»è¡Œæ•°ï¼Œå¤æ‚åº¦æ˜¯O(n)ï¼Œå› ä¸ºinnodbçœŸçš„è¦å»æ•°ä¸€éã€‚ä½†å¥½ äºå…·ä½“çš„count(åˆ—å)ã€‚</p><ul><li>é—®é¢˜ï¼šèƒ½ä¸èƒ½ä½¿ç”¨count(åˆ—å)æ›¿æ¢count(*)?</li></ul><p>ä¸è¦ä½¿ç”¨ count(åˆ—å)æ¥æ›¿ä»£ count(<em>) ï¼Œ count(</em>) æ˜¯ SQL92 å®šä¹‰çš„æ ‡å‡†ç»Ÿè®¡è¡Œæ•°çš„è¯­æ³•ï¼Œè·Ÿæ•° æ®åº“æ— å…³ï¼Œè·Ÿ NULL å’Œé NULL æ— å…³ã€‚ è¯´æ˜ï¼šcount(*)ä¼šç»Ÿè®¡å€¼ä¸º NULL çš„è¡Œï¼Œè€Œ count(åˆ—å)ä¸ä¼šç»Ÿè®¡æ­¤åˆ—ä¸º NULL å€¼çš„è¡Œã€‚</p><h2 id="2-GROUP-BY"><a href="#2-GROUP-BY" class="headerlink" title="2. GROUP BY"></a>2. GROUP BY</h2><h3 id="1-åŸºæœ¬ä½¿ç”¨"><a href="#1-åŸºæœ¬ä½¿ç”¨" class="headerlink" title="1) åŸºæœ¬ä½¿ç”¨"></a>1) åŸºæœ¬ä½¿ç”¨</h3><p>å¯ä»¥ä½¿ç”¨GROUP BYå­å¥å°†è¡¨ä¸­çš„æ•°æ®åˆ†æˆè‹¥å¹²ç»„</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SELECT column, group_function(column)</span><br><span class="line">FROM table</span><br><span class="line">[WHERE condition]</span><br><span class="line">[GROUP BY group_by_expression]</span><br><span class="line">[ORDER BY column];</span><br></pre></td></tr></table></figure><blockquote><p>ç»“è®º1ï¼šSELECTä¸­å‡ºç°çš„éç»„å‡½æ•°çš„å­—æ®µå¿…é¡»å£°æ˜åœ¨GROUP BYä¸­ã€‚</p><p>â€‹åä¹‹ï¼ŒGROUP BYä¸­å£°æ˜çš„å­—æ®µå¯ä»¥ä¸å‡ºç°åœ¨SELECTä¸­ã€‚</p><p>ç»“è®º2ï¼šGROUP BYå£°æ˜åœ¨FROMåé¢ã€WHEREåé¢ã€ORDER BYå‰é¢ã€LIMITå‰é¢ã€‚</p></blockquote><h3 id="2-ä½¿ç”¨WITH-ROLLUP"><a href="#2-ä½¿ç”¨WITH-ROLLUP" class="headerlink" title="2) ä½¿ç”¨WITH ROLLUP"></a>2) ä½¿ç”¨WITH ROLLUP</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SELECT department_id,AVG(salary)</span><br><span class="line">FROM employees</span><br><span class="line">WHERE department_id &gt; 80</span><br><span class="line">GROUP BY department_id WITH ROLLUP;</span><br></pre></td></tr></table></figure><blockquote><p>æ³¨æ„ï¼š å½“ä½¿ç”¨ROLLUPæ—¶ï¼Œä¸èƒ½åŒæ—¶ä½¿ç”¨ORDER BYå­å¥è¿›è¡Œç»“æœæ’åºï¼Œå³ROLLUPå’ŒORDER BYæ˜¯äº’ç›¸æ’æ–¥çš„ã€‚</p></blockquote><h2 id="3-HAVING"><a href="#3-HAVING" class="headerlink" title="3. HAVING"></a>3. HAVING</h2><h3 id="1-åŸºæœ¬ä½¿ç”¨-1"><a href="#1-åŸºæœ¬ä½¿ç”¨-1" class="headerlink" title="1) åŸºæœ¬ä½¿ç”¨"></a>1) åŸºæœ¬ä½¿ç”¨</h3><p>è¿‡æ»¤åˆ†ç»„ï¼šHAVINGå­å¥ </p><ol><li>è¡Œå·²ç»è¢«åˆ†ç»„ã€‚ </li><li>ä½¿ç”¨äº†èšåˆå‡½æ•°ã€‚ </li><li>æ»¡è¶³HAVING å­å¥ä¸­æ¡ä»¶çš„åˆ†ç»„å°†è¢«æ˜¾ç¤ºã€‚ </li><li>HAVING ä¸èƒ½å•ç‹¬ä½¿ç”¨ï¼Œå¿…é¡»è¦è·Ÿ GROUP BY ä¸€èµ·ä½¿ç”¨ã€‚</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SELECT department_id, MAX(salary)</span><br><span class="line">FROM employees</span><br><span class="line">GROUP BY department_id</span><br><span class="line">HAVING MAX(salary)&gt;10000 ;</span><br></pre></td></tr></table></figure><p><strong>è¦æ±‚</strong></p><ul><li>å¦‚æœè¿‡æ»¤æ¡ä»¶ä¸­ä½¿ç”¨äº†èšåˆå‡½æ•°ï¼Œåˆ™å¿…é¡»ä½¿ç”¨HAVINGæ¥æ›¿æ¢WHEREã€‚å¦åˆ™ï¼ŒæŠ¥é”™ã€‚</li><li>å½“è¿‡æ»¤æ¡ä»¶ä¸­æ²¡æœ‰èšåˆå‡½æ•°æ—¶ï¼Œåˆ™æ¬¡è¿‡æ»¤æ¡ä»¶å£°æ˜åœ¨WHEREä¸­æˆ–HAVINGä¸­éƒ½å¯ä»¥ã€‚ä½†æ˜¯ï¼Œå»ºè®®å£°æ˜åœ¨WHEREä¸­çš„æ‰§è¡Œæ•ˆç‡é«˜ã€‚</li><li>HAVINGå¿…é¡»å£°æ˜åœ¨GROUP BY çš„åé¢</li><li>å¼€å‘ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨HAVINGçš„å‰ææ˜¯SQLä¸­ä½¿ç”¨äº†GROUP BYã€‚</li></ul><h3 id="2-WHEREå’ŒHAVINGçš„å¯¹æ¯”"><a href="#2-WHEREå’ŒHAVINGçš„å¯¹æ¯”" class="headerlink" title="2) WHEREå’ŒHAVINGçš„å¯¹æ¯”"></a>2) WHEREå’ŒHAVINGçš„å¯¹æ¯”</h3><p><strong>åŒºåˆ«1ï¼šWHERE å¯ä»¥ç›´æ¥ä½¿ç”¨è¡¨ä¸­çš„å­—æ®µä½œä¸ºç­›é€‰æ¡ä»¶ï¼Œä½†ä¸èƒ½ä½¿ç”¨åˆ†ç»„ä¸­çš„è®¡ç®—å‡½æ•°ä½œä¸ºç­›é€‰æ¡ä»¶ï¼› HAVING å¿…é¡»è¦ä¸ GROUP BY é…åˆä½¿ç”¨ï¼Œå¯ä»¥æŠŠåˆ†ç»„è®¡ç®—çš„å‡½æ•°å’Œåˆ†ç»„å­—æ®µä½œä¸ºç­›é€‰æ¡ä»¶ã€‚</strong></p><p>è¿™å†³å®šäº†ï¼Œåœ¨éœ€è¦å¯¹æ•°æ®è¿›è¡Œåˆ†ç»„ç»Ÿè®¡çš„æ—¶å€™ï¼ŒHAVING å¯ä»¥å®Œæˆ WHERE ä¸èƒ½å®Œæˆçš„ä»»åŠ¡ã€‚è¿™æ˜¯å› ä¸ºï¼Œ åœ¨æŸ¥è¯¢è¯­æ³•ç»“æ„ä¸­ï¼ŒWHERE åœ¨ GROUP BY ä¹‹å‰ï¼Œæ‰€ä»¥æ— æ³•å¯¹åˆ†ç»„ç»“æœè¿›è¡Œç­›é€‰ã€‚HAVING åœ¨ GROUP BY ä¹‹ åï¼Œå¯ä»¥ä½¿ç”¨åˆ†ç»„å­—æ®µå’Œåˆ†ç»„ä¸­çš„è®¡ç®—å‡½æ•°ï¼Œå¯¹åˆ†ç»„çš„ç»“æœé›†è¿›è¡Œç­›é€‰ï¼Œè¿™ä¸ªåŠŸèƒ½æ˜¯ WHERE æ— æ³•å®Œæˆ çš„ã€‚å¦å¤–ï¼ŒWHEREæ’é™¤çš„è®°å½•ä¸å†åŒ…æ‹¬åœ¨åˆ†ç»„ä¸­ã€‚</p><p><strong>åŒºåˆ«2ï¼šå¦‚æœéœ€è¦é€šè¿‡è¿æ¥ä»å…³è”è¡¨ä¸­è·å–éœ€è¦çš„æ•°æ®ï¼ŒWHERE æ˜¯å…ˆç­›é€‰åè¿æ¥ï¼Œè€Œ HAVING æ˜¯å…ˆè¿æ¥ åç­›é€‰ã€‚</strong></p><p>è¿™ä¸€ç‚¹ï¼Œå°±å†³å®šäº†åœ¨å…³è”æŸ¥è¯¢ä¸­ï¼ŒWHERE æ¯” HAVING æ›´é«˜æ•ˆã€‚å› ä¸º WHERE å¯ä»¥å…ˆç­›é€‰ï¼Œç”¨ä¸€ ä¸ªç­›é€‰åçš„è¾ƒå°æ•°æ®é›†å’Œå…³è”è¡¨è¿›è¡Œè¿æ¥ï¼Œè¿™æ ·å ç”¨çš„èµ„æºæ¯”è¾ƒå°‘ï¼Œæ‰§è¡Œæ•ˆç‡ä¹Ÿæ¯”è¾ƒé«˜ã€‚HAVING åˆ™éœ€è¦ å…ˆæŠŠç»“æœé›†å‡†å¤‡å¥½ï¼Œä¹Ÿå°±æ˜¯ç”¨æœªè¢«ç­›é€‰çš„æ•°æ®é›†è¿›è¡Œå…³è”ï¼Œç„¶åå¯¹è¿™ä¸ªå¤§çš„æ•°æ®é›†è¿›è¡Œç­›é€‰ï¼Œè¿™æ ·å ç”¨ çš„èµ„æºå°±æ¯”è¾ƒå¤šï¼Œæ‰§è¡Œæ•ˆç‡ä¹Ÿè¾ƒä½ã€‚</p><p>å°ç»“å¦‚ä¸‹ï¼š</p><table><thead><tr><th>å…³é”®å­—</th><th>ç”¨æ³•</th><th>ç¼ºç‚¹</th></tr></thead><tbody><tr><td>WHERE</td><td>å…ˆç­›é€‰æ•°æ®å†å…³è”ï¼Œæ‰§è¡Œæ•ˆç‡é«˜</td><td>ä¸èƒ½ä½¿ç”¨åˆ†ç»„ä¸­çš„è®¡ç®—å‡½æ•°è¿›è¡Œç­›é€‰</td></tr><tr><td>HAVING</td><td>å¯ä»¥ä½¿ç”¨åˆ†ç»„ä¸­çš„è®¡ç®—å‡½æ•°</td><td>åœ¨æœ€åçš„ç»“æœé›†ä¸­è¿›è¡Œç­›é€‰ï¼Œæ‰§è¡Œæ•ˆç‡è¾ƒä½</td></tr></tbody></table><p><strong>å¼€å‘ä¸­çš„é€‰æ‹©ï¼š</strong> </p><p>WHERE å’Œ HAVING ä¹Ÿä¸æ˜¯äº’ç›¸æ’æ–¥çš„ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ä¸€ä¸ªæŸ¥è¯¢é‡Œé¢åŒæ—¶ä½¿ç”¨ WHERE å’Œ HAVINGã€‚åŒ…å«åˆ†ç»„ ç»Ÿè®¡å‡½æ•°çš„æ¡ä»¶ç”¨ HAVINGï¼Œæ™®é€šæ¡ä»¶ç”¨ WHEREã€‚è¿™æ ·ï¼Œæˆ‘ä»¬å°±æ—¢åˆ©ç”¨äº† WHERE æ¡ä»¶çš„é«˜æ•ˆå¿«é€Ÿï¼Œåˆå‘ æŒ¥äº† HAVING å¯ä»¥ä½¿ç”¨åŒ…å«åˆ†ç»„ç»Ÿè®¡å‡½æ•°çš„æŸ¥è¯¢æ¡ä»¶çš„ä¼˜ç‚¹ã€‚å½“æ•°æ®é‡ç‰¹åˆ«å¤§çš„æ—¶å€™ï¼Œè¿è¡Œæ•ˆç‡ä¼šæœ‰å¾ˆ å¤§çš„å·®åˆ«ã€‚</p><h2 id="4-SELECTçš„æ‰§è¡Œè¿‡ç¨‹"><a href="#4-SELECTçš„æ‰§è¡Œè¿‡ç¨‹" class="headerlink" title="4. SELECTçš„æ‰§è¡Œè¿‡ç¨‹"></a>4. SELECTçš„æ‰§è¡Œè¿‡ç¨‹</h2><h3 id="1-æŸ¥è¯¢çš„ç»“æ„"><a href="#1-æŸ¥è¯¢çš„ç»“æ„" class="headerlink" title="1) æŸ¥è¯¢çš„ç»“æ„"></a>1) æŸ¥è¯¢çš„ç»“æ„</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">#æ–¹å¼1ï¼š</span><br><span class="line">SELECT ...,....,...</span><br><span class="line">FROM ...,...,....</span><br><span class="line">WHERE å¤šè¡¨çš„è¿æ¥æ¡ä»¶</span><br><span class="line">AND ä¸åŒ…å«ç»„å‡½æ•°çš„è¿‡æ»¤æ¡ä»¶</span><br><span class="line">GROUP BY ...,...</span><br><span class="line">HAVING åŒ…å«ç»„å‡½æ•°çš„è¿‡æ»¤æ¡ä»¶</span><br><span class="line">ORDER BY ... ASC/DESC</span><br><span class="line">LIMIT ...,...</span><br><span class="line">#æ–¹å¼2ï¼š</span><br><span class="line">SELECT ...,....,...</span><br><span class="line">FROM ... JOIN ...</span><br><span class="line">ON å¤šè¡¨çš„è¿æ¥æ¡ä»¶</span><br><span class="line">JOIN ...</span><br><span class="line">ON ...</span><br><span class="line">WHERE ä¸åŒ…å«ç»„å‡½æ•°çš„è¿‡æ»¤æ¡ä»¶</span><br><span class="line">AND/OR ä¸åŒ…å«ç»„å‡½æ•°çš„è¿‡æ»¤æ¡ä»¶</span><br><span class="line">GROUP BY ...,...</span><br><span class="line">HAVING åŒ…å«ç»„å‡½æ•°çš„è¿‡æ»¤æ¡ä»¶</span><br><span class="line">ORDER BY ... ASC/DESC</span><br><span class="line">LIMIT ...,...</span><br><span class="line">#å…¶ä¸­ï¼š</span><br><span class="line">#ï¼ˆ1ï¼‰fromï¼šä»å“ªäº›è¡¨ä¸­ç­›é€‰</span><br><span class="line">#ï¼ˆ2ï¼‰onï¼šå…³è”å¤šè¡¨æŸ¥è¯¢æ—¶ï¼Œå»é™¤ç¬›å¡å°”ç§¯</span><br><span class="line">#ï¼ˆ3ï¼‰whereï¼šä»è¡¨ä¸­ç­›é€‰çš„æ¡ä»¶</span><br><span class="line">#ï¼ˆ4ï¼‰group byï¼šåˆ†ç»„ä¾æ®</span><br><span class="line">#ï¼ˆ5ï¼‰havingï¼šåœ¨ç»Ÿè®¡ç»“æœä¸­å†æ¬¡ç­›é€‰</span><br><span class="line">#ï¼ˆ6ï¼‰order byï¼šæ’åº</span><br><span class="line">#ï¼ˆ7ï¼‰limitï¼šåˆ†é¡µ</span><br></pre></td></tr></table></figure><p><strong>éœ€è¦è®°ä½ SELECT æŸ¥è¯¢æ—¶çš„ä¸¤ä¸ªé¡ºåºï¼š</strong></p><p><font color=red>1. å…³é”®å­—çš„é¡ºåºæ˜¯ä¸èƒ½é¢ å€’çš„ï¼š</font></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT ... FROM ... WHERE ... GROUP BY ... HAVING ... ORDER BY ... LIMIT...</span><br></pre></td></tr></table></figure><p><font color=red>1. SELECT è¯­å¥çš„æ‰§è¡Œé¡ºåº</font>ï¼ˆåœ¨ MySQL å’Œ Oracle ä¸­ï¼ŒSELECT æ‰§è¡Œé¡ºåºåŸºæœ¬ç›¸åŒï¼‰ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FROM -&gt; WHERE -&gt; GROUP BY -&gt; HAVING -&gt; SELECT çš„å­—æ®µ -&gt; DISTINCT -&gt; ORDER BY -&gt; LIMIT</span><br></pre></td></tr></table></figure><p>æ¯”å¦‚ä½ å†™äº†ä¸€ä¸ª SQL è¯­å¥ï¼Œé‚£ä¹ˆå®ƒçš„å…³é”®å­—é¡ºåºå’Œæ‰§è¡Œé¡ºåºæ˜¯ä¸‹é¢è¿™æ ·çš„ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SELECT DISTINCT player_id, player_name, count(*) as num # é¡ºåº 5</span><br><span class="line">FROM player JOIN team ON player.team_id = team.team_id # é¡ºåº 1</span><br><span class="line">WHERE height &gt; 1.80 # é¡ºåº 2</span><br><span class="line">GROUP BY player.team_id # é¡ºåº 3</span><br><span class="line">HAVING num &gt; 2 # é¡ºåº 4</span><br><span class="line">ORDER BY num DESC # é¡ºåº 6</span><br><span class="line">LIMIT 2 # é¡ºåº 7</span><br></pre></td></tr></table></figure><p>åœ¨ SELECT è¯­å¥æ‰§è¡Œè¿™äº›æ­¥éª¤çš„æ—¶å€™ï¼Œæ¯ä¸ªæ­¥éª¤éƒ½ä¼šäº§ç”Ÿä¸€ä¸ª è™šæ‹Ÿè¡¨ ï¼Œç„¶åå°†è¿™ä¸ªè™šæ‹Ÿè¡¨ä¼ å…¥ä¸‹ä¸€ä¸ªæ­¥ éª¤ä¸­ä½œä¸ºè¾“å…¥ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™äº›æ­¥éª¤éšå«åœ¨ SQL çš„æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå¯¹äºæˆ‘ä»¬æ¥è¯´æ˜¯ä¸å¯è§çš„ã€‚</p><h3 id="2-SQLçš„æ‰§è¡ŒåŸç†"><a href="#2-SQLçš„æ‰§è¡ŒåŸç†" class="headerlink" title="2) SQLçš„æ‰§è¡ŒåŸç†"></a>2) SQLçš„æ‰§è¡ŒåŸç†</h3><p>SELECT æ˜¯å…ˆæ‰§è¡Œ FROM è¿™ä¸€æ­¥çš„ã€‚åœ¨è¿™ä¸ªé˜¶æ®µï¼Œå¦‚æœæ˜¯å¤šå¼ è¡¨è”æŸ¥ï¼Œè¿˜ä¼šç»å†ä¸‹é¢çš„å‡ ä¸ªæ­¥éª¤ï¼š</p><ol><li>é¦–å…ˆå…ˆé€šè¿‡ CROSS JOIN æ±‚ç¬›å¡å°”ç§¯ï¼Œç›¸å½“äºå¾—åˆ°è™šæ‹Ÿè¡¨ vtï¼ˆvirtual tableï¼‰1-1ï¼›</li><li>é€šè¿‡ ON è¿›è¡Œç­›é€‰ï¼Œåœ¨è™šæ‹Ÿè¡¨ vt1-1 çš„åŸºç¡€ä¸Šè¿›è¡Œç­›é€‰ï¼Œå¾—åˆ°è™šæ‹Ÿè¡¨ vt1-2ï¼›</li><li>æ·»åŠ å¤–éƒ¨è¡Œã€‚å¦‚æœæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯å·¦è¿æ¥ã€å³é“¾æ¥æˆ–è€…å…¨è¿æ¥ï¼Œå°±ä¼šæ¶‰åŠåˆ°å¤–éƒ¨è¡Œï¼Œä¹Ÿå°±æ˜¯åœ¨è™šæ‹Ÿ è¡¨ vt1-2 çš„åŸºç¡€ä¸Šå¢åŠ å¤–éƒ¨è¡Œï¼Œå¾—åˆ°è™šæ‹Ÿè¡¨ vt1-3ã€‚</li></ol><ul><li><p>å½“ç„¶å¦‚æœæˆ‘ä»¬æ“ä½œçš„æ˜¯ä¸¤å¼ ä»¥ä¸Šçš„è¡¨ï¼Œè¿˜ä¼šé‡å¤ä¸Šé¢çš„æ­¥éª¤ï¼Œç›´åˆ°æ‰€æœ‰è¡¨éƒ½è¢«å¤„ç†å®Œä¸ºæ­¢ã€‚è¿™ä¸ªè¿‡ç¨‹å¾— åˆ°æ˜¯æˆ‘ä»¬çš„åŸå§‹æ•°æ®ã€‚</p></li><li><p>ç„¶åè¿›å…¥ç¬¬ä¸‰æ­¥å’Œç¬¬å››æ­¥ï¼Œä¹Ÿå°±æ˜¯ GROUP å’Œ HAVING é˜¶æ®µ ã€‚åœ¨è¿™ä¸ªé˜¶æ®µä¸­ï¼Œå®é™…ä¸Šæ˜¯åœ¨è™šæ‹Ÿè¡¨ vt2 çš„ åŸºç¡€ä¸Šè¿›è¡Œåˆ†ç»„å’Œåˆ†ç»„è¿‡æ»¤ï¼Œå¾—åˆ°ä¸­é—´çš„è™šæ‹Ÿè¡¨ vt3 å’Œ vt4 ã€‚</p></li><li><p>å½“æˆ‘ä»¬å®Œæˆäº†æ¡ä»¶ç­›é€‰éƒ¨åˆ†ä¹‹åï¼Œå°±å¯ä»¥ç­›é€‰è¡¨ä¸­æå–çš„å­—æ®µï¼Œä¹Ÿå°±æ˜¯è¿›å…¥åˆ° SELECT å’Œ DISTINCT é˜¶æ®µ ã€‚</p></li><li><p>é¦–å…ˆåœ¨ SELECT é˜¶æ®µä¼šæå–æƒ³è¦çš„å­—æ®µï¼Œç„¶ååœ¨ DISTINCT é˜¶æ®µè¿‡æ»¤æ‰é‡å¤çš„è¡Œï¼Œåˆ†åˆ«å¾—åˆ°ä¸­é—´çš„è™šæ‹Ÿè¡¨ vt5-1 å’Œ vt5-2 ã€‚</p></li><li><p>å½“æˆ‘ä»¬æå–äº†æƒ³è¦çš„å­—æ®µæ•°æ®ä¹‹åï¼Œå°±å¯ä»¥æŒ‰ç…§æŒ‡å®šçš„å­—æ®µè¿›è¡Œæ’åºï¼Œä¹Ÿå°±æ˜¯ ORDER BY é˜¶æ®µ ï¼Œå¾—åˆ° è™šæ‹Ÿè¡¨ vt6 ã€‚</p></li><li><p>æœ€ååœ¨ vt6 çš„åŸºç¡€ä¸Šï¼Œå–å‡ºæŒ‡å®šè¡Œçš„è®°å½•ï¼Œä¹Ÿå°±æ˜¯ LIMIT é˜¶æ®µ ï¼Œå¾—åˆ°æœ€ç»ˆçš„ç»“æœï¼Œå¯¹åº”çš„æ˜¯è™šæ‹Ÿè¡¨ vt7 ã€‚</p></li><li><p>å½“ç„¶æˆ‘ä»¬åœ¨å†™ SELECT è¯­å¥çš„æ—¶å€™ï¼Œä¸ä¸€å®šå­˜åœ¨æ‰€æœ‰çš„å…³é”®å­—ï¼Œç›¸åº”çš„é˜¶æ®µå°±ä¼šçœç•¥ã€‚</p></li></ul><p>åŒæ—¶å› ä¸º SQL æ˜¯ä¸€é—¨ç±»ä¼¼è‹±è¯­çš„ç»“æ„åŒ–æŸ¥è¯¢è¯­è¨€ï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨å†™ SELECT è¯­å¥çš„æ—¶å€™ï¼Œè¿˜è¦æ³¨æ„ç›¸åº”çš„ å…³é”®å­—é¡ºåºï¼Œæ‰€è°“åº•å±‚è¿è¡Œçš„åŸç†ï¼Œå°±æ˜¯æˆ‘ä»¬åˆšæ‰è®²åˆ°çš„æ‰§è¡Œé¡ºåºã€‚</p><h1 id="ç¬¬ä¹ç« -å­æŸ¥è¯¢"><a href="#ç¬¬ä¹ç« -å­æŸ¥è¯¢" class="headerlink" title="ç¬¬ä¹ç« _å­æŸ¥è¯¢"></a>ç¬¬ä¹ç« _å­æŸ¥è¯¢</h1><h2 id="1-åŸºæœ¬ä½¿ç”¨-2"><a href="#1-åŸºæœ¬ä½¿ç”¨-2" class="headerlink" title="1. åŸºæœ¬ä½¿ç”¨"></a>1. åŸºæœ¬ä½¿ç”¨</h2><ul><li>å­æŸ¥è¯¢çš„åŸºæœ¬è¯­æ³•ç»“æ„ï¼š</li></ul><p><img src="/MySQL%E5%9F%BA%E7%A1%80%E7%AF%87.assets/image-20220603133759153.png" alt="image-20220603133759153"></p><ul><li>å­æŸ¥è¯¢ï¼ˆå†…æŸ¥è¯¢ï¼‰åœ¨ä¸»æŸ¥è¯¢ä¹‹å‰ä¸€æ¬¡æ‰§è¡Œå®Œæˆã€‚</li><li>å­æŸ¥è¯¢çš„ç»“æœè¢«ä¸»æŸ¥è¯¢ï¼ˆå¤–æŸ¥è¯¢ï¼‰ä½¿ç”¨ ã€‚</li><li><strong>æ³¨æ„äº‹é¡¹</strong><ul><li>å­æŸ¥è¯¢è¦åŒ…å«åœ¨æ‹¬å·å†…</li><li>å°†å­æŸ¥è¯¢æ”¾åœ¨æ¯”è¾ƒæ¡ä»¶çš„å³ä¾§</li><li>å•è¡Œæ“ä½œç¬¦å¯¹åº”å•è¡Œå­æŸ¥è¯¢ï¼Œå¤šè¡Œæ“ä½œç¬¦å¯¹åº”å¤šè¡Œå­æŸ¥è¯¢</li></ul></li></ul><h2 id="2-å­æŸ¥è¯¢çš„åˆ†ç±»"><a href="#2-å­æŸ¥è¯¢çš„åˆ†ç±»" class="headerlink" title="2. å­æŸ¥è¯¢çš„åˆ†ç±»"></a>2. å­æŸ¥è¯¢çš„åˆ†ç±»</h2><p><strong>åˆ†ç±»æ–¹å¼1ï¼š</strong></p><p>æˆ‘ä»¬æŒ‰å†…æŸ¥è¯¢çš„ç»“æœè¿”å›ä¸€æ¡è¿˜æ˜¯å¤šæ¡è®°å½•ï¼Œå°†å­æŸ¥è¯¢åˆ†ä¸º å•è¡Œå­æŸ¥è¯¢ ã€ å¤šè¡Œå­æŸ¥è¯¢ ã€‚</p><ul><li>å•è¡Œå­æŸ¥è¯¢</li></ul><p><img src="/MySQL%E5%9F%BA%E7%A1%80%E7%AF%87.assets/image-20220603135507360.png" alt="image-20220603135507360"></p><ul><li>å¤šè¡Œå­æŸ¥è¯¢</li></ul><p><img src="/MySQL%E5%9F%BA%E7%A1%80%E7%AF%87.assets/image-20220603135544144.png" alt="image-20220603135544144"></p><p><strong>åˆ†ç±»æ–¹å¼2ï¼š</strong></p><p>æˆ‘ä»¬æŒ‰å†…æŸ¥è¯¢æ˜¯å¦è¢«æ‰§è¡Œå¤šæ¬¡ï¼Œå°†å­æŸ¥è¯¢åˆ’åˆ†ä¸º ç›¸å…³(æˆ–å…³è”)å­æŸ¥è¯¢ å’Œ ä¸ç›¸å…³(æˆ–éå…³è”)å­æŸ¥è¯¢ ã€‚ </p><p>å­æŸ¥è¯¢ä»æ•°æ®è¡¨ä¸­æŸ¥è¯¢äº†æ•°æ®ç»“æœï¼Œå¦‚æœè¿™ä¸ªæ•°æ®ç»“æœåªæ‰§è¡Œä¸€æ¬¡ï¼Œç„¶åè¿™ä¸ªæ•°æ®ç»“æœä½œä¸ºä¸»æŸ¥è¯¢çš„æ¡ä»¶è¿›è¡Œæ‰§è¡Œï¼Œé‚£ä¹ˆè¿™æ ·çš„å­æŸ¥è¯¢å«åšä¸ç›¸å…³å­æŸ¥è¯¢ã€‚ </p><p>åŒæ ·ï¼Œå¦‚æœå­æŸ¥è¯¢éœ€è¦æ‰§è¡Œå¤šæ¬¡ï¼Œå³é‡‡ç”¨å¾ªç¯çš„æ–¹å¼ï¼Œå…ˆä»å¤–éƒ¨æŸ¥è¯¢å¼€å§‹ï¼Œæ¯æ¬¡éƒ½ä¼ å…¥å­æŸ¥è¯¢è¿›è¡ŒæŸ¥è¯¢ï¼Œç„¶åå†å°†ç»“æœåé¦ˆç»™å¤–éƒ¨ï¼Œè¿™ç§åµŒå¥—çš„æ‰§è¡Œæ–¹å¼å°±ç§°ä¸ºç›¸å…³å­æŸ¥è¯¢ã€‚</p><h2 id="3-å•è¡Œå­æŸ¥è¯¢"><a href="#3-å•è¡Œå­æŸ¥è¯¢" class="headerlink" title="3. å•è¡Œå­æŸ¥è¯¢"></a>3. å•è¡Œå­æŸ¥è¯¢</h2><h3 id="1-å•è¡Œæ¯”è¾ƒæ“ä½œç¬¦"><a href="#1-å•è¡Œæ¯”è¾ƒæ“ä½œç¬¦" class="headerlink" title="1) å•è¡Œæ¯”è¾ƒæ“ä½œç¬¦"></a>1) å•è¡Œæ¯”è¾ƒæ“ä½œç¬¦</h3><table><thead><tr><th>æ“ä½œç¬¦</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>&#x3D;</td><td>equal to</td></tr><tr><td>&gt;</td><td>greater than</td></tr><tr><td>&gt;&#x3D;</td><td>greater than or equal to</td></tr><tr><td>&lt;</td><td>less than</td></tr><tr><td>&lt;&#x3D;</td><td>less than or equal to</td></tr><tr><td>&lt;&gt;</td><td>not equal to</td></tr></tbody></table><h3 id="2-ä»£ç ç¤ºä¾‹"><a href="#2-ä»£ç ç¤ºä¾‹" class="headerlink" title="2) ä»£ç ç¤ºä¾‹"></a>2) ä»£ç ç¤ºä¾‹</h3><ul><li>é¢˜ç›®ï¼šè¿”å›job_idä¸141å·å‘˜å·¥ç›¸åŒï¼Œsalaryæ¯”143å·å‘˜å·¥å¤šçš„å‘˜å·¥å§“åï¼Œjob_idå’Œå·¥èµ„</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">SELECT last_name, job_id, salary</span><br><span class="line">FROM eployees</span><br><span class="line">WHERE job_id = (</span><br><span class="line">SELECT job_id</span><br><span class="line">FROM eployees</span><br><span class="line">    WHERE employee_id = 141</span><br><span class="line">)</span><br><span class="line">AND salary &gt; (</span><br><span class="line">SELECT salary</span><br><span class="line">FROM eployees</span><br><span class="line">    WHERE employee_id = 143</span><br><span class="line">);</span><br></pre></td></tr></table></figure><ul><li>é¢˜ç›®ï¼šæŸ¥è¯¢ä¸141å·æˆ–174å·å‘˜å·¥çš„manager_idå’Œdepartment_idç›¸åŒçš„å…¶ä»–å‘˜å·¥çš„employee_idï¼Œ manager_idï¼Œdepartment_id</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"># å®ç°æ–¹å¼ä¸€ï¼šä¸æˆå¯¹æ¯”è¾ƒ</span><br><span class="line">SELECT employee_id, manager_id, department_id</span><br><span class="line">FROM employees</span><br><span class="line">WHERE manager_id IN</span><br><span class="line">        (SELECT manager_id</span><br><span class="line">        FROM employees</span><br><span class="line">        WHERE employee_id IN (174,141))</span><br><span class="line">AND department_id IN</span><br><span class="line">        (SELECT department_id</span><br><span class="line">        FROM employees</span><br><span class="line">        WHERE employee_id IN (174,141))</span><br><span class="line">AND employee_id NOT IN(174,141);</span><br><span class="line"></span><br><span class="line"># å®ç°æ–¹å¼äºŒï¼šæˆå¯¹æ¯”è¾ƒ</span><br><span class="line">SELECT employee_id, manager_id, department_id</span><br><span class="line">FROM employees</span><br><span class="line">WHERE (manager_id, department_id) IN</span><br><span class="line">        (SELECT manager_id, department_id</span><br><span class="line">        FROM employees</span><br><span class="line">        WHERE employee_id IN (141,174))</span><br><span class="line">AND employee_id NOT IN (141,174);</span><br></pre></td></tr></table></figure><ul><li>é¢˜ç›®ï¼šæŸ¥è¯¢æœ€ä½å·¥èµ„å¤§äº50å·éƒ¨é—¨æœ€ä½å·¥èµ„çš„éƒ¨é—¨idå’Œå…¶æœ€ä½å·¥èµ„</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SELECT department_id, MIN(salary)</span><br><span class="line">FROM employees</span><br><span class="line">GROUP BY department_id</span><br><span class="line">HAVING MIN(salary) &gt;</span><br><span class="line">            (SELECT MIN(salary)</span><br><span class="line">            FROM employees</span><br><span class="line">            WHERE department_id = 50);</span><br></pre></td></tr></table></figure><h3 id="3-CASEä¸­çš„å­æŸ¥è¯¢"><a href="#3-CASEä¸­çš„å­æŸ¥è¯¢" class="headerlink" title="3) CASEä¸­çš„å­æŸ¥è¯¢"></a>3) CASEä¸­çš„å­æŸ¥è¯¢</h3><p>é¢˜ç›®ï¼šæ˜¾å¼å‘˜å·¥çš„employee_id,last_nameå’Œlocationã€‚å…¶ä¸­ï¼Œè‹¥å‘˜å·¥department_idä¸location_idä¸º1800 çš„department_idç›¸åŒï¼Œåˆ™locationä¸ºâ€™Canadaâ€™ï¼Œå…¶ä½™åˆ™ä¸ºâ€™USAâ€™ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SELECT employee_id, last_name,</span><br><span class="line">    (CASE department_id</span><br><span class="line">    WHEN</span><br><span class="line">        (SELECT department_id FROM departments</span><br><span class="line">        WHERE location_id = 1800)</span><br><span class="line">    THEN &#x27;Canada&#x27; ELSE &#x27;USA&#x27; END) location</span><br><span class="line">FROM employees;</span><br></pre></td></tr></table></figure><h3 id="4-å­æŸ¥è¯¢ä¸­çš„ç©ºå€¼é—®é¢˜"><a href="#4-å­æŸ¥è¯¢ä¸­çš„ç©ºå€¼é—®é¢˜" class="headerlink" title="4) å­æŸ¥è¯¢ä¸­çš„ç©ºå€¼é—®é¢˜"></a>4) å­æŸ¥è¯¢ä¸­çš„ç©ºå€¼é—®é¢˜</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SELECT last_name, job_id</span><br><span class="line">FROM employees</span><br><span class="line">WHERE job_id =</span><br><span class="line">(SELECT job_id</span><br><span class="line">FROM employees</span><br><span class="line">WHERE last_name = &#x27;Haas&#x27;);</span><br></pre></td></tr></table></figure><blockquote><p>å­æŸ¥è¯¢ä¸è¿”å›ä»»ä½•è¡Œ</p></blockquote><h3 id="5-éæ³•ä½¿ç”¨å­æŸ¥è¯¢"><a href="#5-éæ³•ä½¿ç”¨å­æŸ¥è¯¢" class="headerlink" title="5) éæ³•ä½¿ç”¨å­æŸ¥è¯¢"></a>5) éæ³•ä½¿ç”¨å­æŸ¥è¯¢</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SELECT employee_id, last_name</span><br><span class="line">FROM employees</span><br><span class="line">WHERE salary =</span><br><span class="line">(SELECT MIN(salary)</span><br><span class="line">FROM employees</span><br><span class="line">GROUP BY department_id);</span><br></pre></td></tr></table></figure><blockquote><p>å¤šè¡Œå­æŸ¥è¯¢ä½¿ç”¨å•è¡Œæ¯”è¾ƒç¬¦</p></blockquote><h2 id="4-å¤šè¡Œå­æŸ¥è¯¢"><a href="#4-å¤šè¡Œå­æŸ¥è¯¢" class="headerlink" title="4. å¤šè¡Œå­æŸ¥è¯¢"></a>4. å¤šè¡Œå­æŸ¥è¯¢</h2><ul><li>ä¹Ÿç§°ä¸ºé›†åˆæ¯”è¾ƒå­æŸ¥è¯¢</li><li>å†…æŸ¥è¯¢è¿”å›å¤šè¡Œ</li><li>ä½¿ç”¨å¤šè¡Œæ¯”è¾ƒæ“ä½œç¬¦</li></ul><h3 id="1-å¤šè¡Œæ¯”è¾ƒæ“ä½œç¬¦"><a href="#1-å¤šè¡Œæ¯”è¾ƒæ“ä½œç¬¦" class="headerlink" title="1) å¤šè¡Œæ¯”è¾ƒæ“ä½œç¬¦"></a>1) å¤šè¡Œæ¯”è¾ƒæ“ä½œç¬¦</h3><table><thead><tr><th>æ“ä½œç¬¦</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>IN</td><td>ç­‰äºåˆ—è¡¨ä¸­çš„ä»»æ„ä¸€ä¸ª</td></tr><tr><td>ANY</td><td>éœ€è¦å’Œå•è¡Œæ¯”è¾ƒæ“ä½œç¬¦ä¸€èµ·ä½¿ç”¨ï¼Œå’Œå­æŸ¥è¯¢è¿”å›çš„æŸä¸€ä¸ªå€¼æ¯”è¾ƒ</td></tr><tr><td>ALL</td><td>éœ€è¦å’Œå•è¡Œæ¯”è¾ƒæ“ä½œç¬¦ä¸€èµ·ä½¿ç”¨ï¼Œå’Œå­æŸ¥è¯¢è¿”å›çš„æ‰€æœ‰å€¼æ¯”è¾ƒ</td></tr><tr><td>SOME</td><td>å®é™…ä¸Šæ˜¯ANYçš„åˆ«åï¼Œä½œç”¨ç›¸åŒï¼Œä¸€èˆ¬å¸¸ä½¿ç”¨ANY</td></tr></tbody></table><h3 id="2-ä»£ç ç¤ºä¾‹-1"><a href="#2-ä»£ç ç¤ºä¾‹-1" class="headerlink" title="2) ä»£ç ç¤ºä¾‹"></a>2) ä»£ç ç¤ºä¾‹</h3><ul><li>é¢˜ç›®ï¼šè¿”å›å…¶å®ƒjob_idä¸­æ¯”job_idä¸ºâ€˜IT_PROGâ€™éƒ¨é—¨ä»»ä¸€å·¥èµ„ä½çš„å‘˜å·¥çš„å‘˜å·¥å·ã€å§“åã€job_id ä»¥åŠsalary</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">SELECT employee_id, last_name, job_id, salary</span><br><span class="line">FROM employees</span><br><span class="line">WHERE job_id &lt;&gt; &#x27;IT_PROG&#x27; </span><br><span class="line">AND salary &lt; ANY(</span><br><span class="line">SELECT salary</span><br><span class="line">    FROM emplyees</span><br><span class="line">    WHERE job_id = &#x27;IT_PROG&#x27;</span><br><span class="line">);</span><br></pre></td></tr></table></figure><ul><li>é¢˜ç›®ï¼šæŸ¥è¯¢å¹³å‡å·¥èµ„æœ€ä½çš„éƒ¨é—¨id</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#æ–¹å¼1ï¼š</span><br><span class="line">SELECT department_id</span><br><span class="line">FROM employees</span><br><span class="line">GROUP BY department_id</span><br><span class="line">HAVING AVG(salary) = (</span><br><span class="line">        SELECT MIN(avg_sal)</span><br><span class="line">        FROM (</span><br><span class="line">            SELECT AVG(salary) avg_sal</span><br><span class="line">            FROM employees</span><br><span class="line">            GROUP BY department_id</span><br><span class="line">            ) dept_avg_sal</span><br><span class="line">);</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#æ–¹å¼2ï¼š</span><br><span class="line">SELECT department_id</span><br><span class="line">FROM employees</span><br><span class="line">GROUP BY department_id</span><br><span class="line">HAVING AVG(salary) &lt;= ALL (</span><br><span class="line">        SELECT AVG(salary) avg_sal</span><br><span class="line">        FROM employees</span><br><span class="line">        GROUP BY department_id</span><br><span class="line">);</span><br></pre></td></tr></table></figure><h3 id="3-ç©ºå€¼é—®é¢˜"><a href="#3-ç©ºå€¼é—®é¢˜" class="headerlink" title="3) ç©ºå€¼é—®é¢˜"></a>3) ç©ºå€¼é—®é¢˜</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SELECT last_name</span><br><span class="line">FROM employees</span><br><span class="line">WHERE employee_id NOT IN (</span><br><span class="line">    SELECT manager_id</span><br><span class="line">    FROM employees</span><br><span class="line">    WHERE manager_id IS NOT NULL</span><br><span class="line">);</span><br></pre></td></tr></table></figure><h2 id="5-ç›¸å…³å­æŸ¥è¯¢"><a href="#5-ç›¸å…³å­æŸ¥è¯¢" class="headerlink" title="5. ç›¸å…³å­æŸ¥è¯¢"></a>5. ç›¸å…³å­æŸ¥è¯¢</h2><p>å¦‚æœå­æŸ¥è¯¢çš„æ‰§è¡Œä¾èµ–äºå¤–éƒ¨æŸ¥è¯¢ï¼Œé€šå¸¸æƒ…å†µä¸‹éƒ½æ˜¯å› ä¸ºå­æŸ¥è¯¢ä¸­çš„è¡¨ç”¨åˆ°äº†å¤–éƒ¨çš„è¡¨ï¼Œå¹¶è¿›è¡Œäº†æ¡ä»¶ å…³è”ï¼Œå› æ­¤æ¯æ‰§è¡Œä¸€æ¬¡å¤–éƒ¨æŸ¥è¯¢ï¼Œå­æŸ¥è¯¢éƒ½è¦é‡æ–°è®¡ç®—ä¸€æ¬¡ï¼Œè¿™æ ·çš„å­æŸ¥è¯¢å°±ç§°ä¹‹ä¸º å…³è”å­æŸ¥è¯¢ ã€‚ </p><p>ç›¸å…³å­æŸ¥è¯¢æŒ‰ç…§ä¸€è¡Œæ¥ä¸€è¡Œçš„é¡ºåºæ‰§è¡Œï¼Œä¸»æŸ¥è¯¢çš„æ¯ä¸€è¡Œéƒ½æ‰§è¡Œä¸€æ¬¡å­æŸ¥è¯¢ã€‚</p><p><img src="/MySQL%E5%9F%BA%E7%A1%80%E7%AF%87.assets/image-20220603154919387.png" alt="image-20220603154919387"></p><p><img src="/MySQL%E5%9F%BA%E7%A1%80%E7%AF%87.assets/image-20220603155013864.png" alt="image-20220603155013864"></p><blockquote><p>è¯´æ˜ï¼šå­æŸ¥è¯¢ä¸­ä½¿ç”¨ä¸»æŸ¥è¯¢ä¸­çš„åˆ—</p></blockquote><h3 id="1-ä»£ç ç¤ºä¾‹"><a href="#1-ä»£ç ç¤ºä¾‹" class="headerlink" title="1) ä»£ç ç¤ºä¾‹"></a>1) ä»£ç ç¤ºä¾‹</h3><ul><li>é¢˜ç›®ï¼šæŸ¥è¯¢å‘˜å·¥ä¸­å·¥èµ„å¤§äºæœ¬éƒ¨é—¨å¹³å‡å·¥èµ„çš„å‘˜å·¥çš„last_name,salaryå’Œå…¶department_id</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># æ–¹å¼ä¸€ï¼šä½¿ç”¨ç›¸å…³å­æŸ¥è¯¢</span><br><span class="line">SELECT last_name, salary, department</span><br><span class="line">FROM employees e1</span><br><span class="line">WHERE salary &gt; (</span><br><span class="line">SELECT AVG(salary)</span><br><span class="line">    FROM employees e2</span><br><span class="line">    WHERE department_id = e1.`department_id`</span><br><span class="line">);</span><br><span class="line"># æ–¹å¼äºŒï¼šåœ¨FROMä¸­å£°æ˜å­æŸ¥è¯¢</span><br><span class="line">SELECT e.last_name, e.salary, e.department_id</span><br><span class="line">FROM employees e, (</span><br><span class="line">    SELECT department_id, AVG(salary) avg_sal</span><br><span class="line">    FROM employees</span><br><span class="line">    GROUP BY department_id) t_dept_avg_salary</span><br><span class="line">WHERE e.department_id = t_dept_avg_salary.department_id</span><br><span class="line">AND e.salary &gt; t_dept_avg_salary.avg_sal;</span><br></pre></td></tr></table></figure><p>åœ¨ORDER BY ä¸­ä½¿ç”¨å­æŸ¥è¯¢ï¼š</p><ul><li>æŸ¥è¯¢å‘˜å·¥çš„id,salary,æŒ‰ç…§department_name æ’åº</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SELECT employee_id, salary</span><br><span class="line">FROM employees e</span><br><span class="line">ORDER BY (</span><br><span class="line">SELECT department_name</span><br><span class="line">    FROM departments d</span><br><span class="line">    WHERE e.`department_id` = d.`department_id`</span><br><span class="line">);</span><br></pre></td></tr></table></figure><ul><li>é¢˜ç›®ï¼šè‹¥employeesè¡¨ä¸­employee_idä¸job_historyè¡¨ä¸­employee_idç›¸åŒçš„æ•°ç›®ä¸å°äº2ï¼Œè¾“å‡ºè¿™äº›ç›¸åŒ idçš„å‘˜å·¥çš„employee_id,last_nameå’Œå…¶job_id</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SELECT e.employee_id, last_name,e.job_id</span><br><span class="line">FROM employees e</span><br><span class="line">WHERE 2 &lt;= (SELECT COUNT(*)</span><br><span class="line">        FROM job_history</span><br><span class="line">        WHERE employee_id = e.employee_id</span><br><span class="line">);</span><br></pre></td></tr></table></figure><h3 id="2-EXISTS-ä¸-NOT-EXISTS-å…³é”®å­—"><a href="#2-EXISTS-ä¸-NOT-EXISTS-å…³é”®å­—" class="headerlink" title="2) EXISTS ä¸ NOT EXISTS å…³é”®å­—"></a>2) EXISTS ä¸ NOT EXISTS å…³é”®å­—</h3><ul><li>å…³è”å­æŸ¥è¯¢é€šå¸¸ä¹Ÿä¼šå’Œ EXISTSæ“ä½œç¬¦ä¸€èµ·æ¥ä½¿ç”¨ï¼Œç”¨æ¥æ£€æŸ¥åœ¨å­æŸ¥è¯¢ä¸­æ˜¯å¦å­˜åœ¨æ»¡è¶³æ¡ä»¶çš„è¡Œã€‚</li><li>å¦‚æœåœ¨å­æŸ¥è¯¢ä¸­ä¸å­˜åœ¨æ»¡è¶³æ¡ä»¶çš„è¡Œï¼š<ul><li>æ¡ä»¶è¿”å› FALSE</li><li>ç»§ç»­åœ¨å­æŸ¥è¯¢ä¸­æŸ¥æ‰¾</li></ul></li><li>å¦‚æœåœ¨å­æŸ¥è¯¢ä¸­å­˜åœ¨æ»¡è¶³æ¡ä»¶çš„è¡Œï¼š<ul><li>ä¸åœ¨å­æŸ¥è¯¢ä¸­ç»§ç»­æŸ¥æ‰¾</li><li>æ¡ä»¶è¿”å› TRUE</li></ul></li><li>NOT EXISTSå…³é”®å­—è¡¨ç¤ºå¦‚æœä¸å­˜åœ¨æŸç§æ¡ä»¶ï¼Œåˆ™è¿”å›TRUEï¼Œå¦åˆ™è¿”å›FALSEã€‚</li></ul><p>é¢˜ç›®ï¼šæŸ¥è¯¢å…¬å¸ç®¡ç†è€…çš„employee_idï¼Œlast_nameï¼Œjob_idï¼Œdepartment_idä¿¡æ¯</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># æ–¹å¼ä¸€ï¼šEXISTS</span><br><span class="line">SELECT employee_id, last_name, job_id, department_id</span><br><span class="line">FROM employees e1</span><br><span class="line">WHERE EXISTS ( SELECT *</span><br><span class="line">        FROM employees e2</span><br><span class="line">        WHERE e2.manager_id =</span><br><span class="line">        e1.employee_id</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"># æ–¹å¼äºŒï¼šè‡ªè¿æ¥</span><br><span class="line">SELECT DISTINCT e1.employee_id, e1.last_name, e1.job_id, e1.department_id</span><br><span class="line">FROM employees e1 JOIN employees e2</span><br><span class="line">ON e1.employee_id = e2.manager_id;</span><br><span class="line"></span><br><span class="line"># æ–¹å¼ä¸‰ï¼šIN</span><br><span class="line">SELECT employee_id, last_name, job_id, department_id</span><br><span class="line">WHERE employee_id IN (</span><br><span class="line">        SELECT DISTINCT manager_id</span><br><span class="line">        FROM employees</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>é¢˜ç›®ï¼šæŸ¥è¯¢departmentsè¡¨ä¸­ï¼Œä¸å­˜åœ¨äºemployeesè¡¨ä¸­çš„éƒ¨é—¨çš„department_idå’Œdepartment_name</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># æ–¹å¼ä¸€ï¼š</span><br><span class="line">SELECT d.department_id, d.department_name</span><br><span class="line">FROM departments e RIGHT JOIN departments d</span><br><span class="line">ON e.`department_id` = d.`department_id`</span><br><span class="line">WHERE e.`department_id` IS NULL;</span><br><span class="line"></span><br><span class="line"># æ–¹å¼äºŒï¼š</span><br><span class="line">SELECT department_id, department_name</span><br><span class="line">FROM departments d</span><br><span class="line">WHERE NOT EXISTS (</span><br><span class="line">SELECT *</span><br><span class="line">    FROM employees e</span><br><span class="line">    WHERE d.`department_id` = e.`department_id`</span><br><span class="line">);</span><br></pre></td></tr></table></figure><h3 id="3-ç›¸å…³æ›´æ–°"><a href="#3-ç›¸å…³æ›´æ–°" class="headerlink" title="3) ç›¸å…³æ›´æ–°"></a>3) ç›¸å…³æ›´æ–°</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">UPDATE table1 alias1</span><br><span class="line">SET column = (SELECT expression</span><br><span class="line">FROM table2 alias2</span><br><span class="line">WHERE alias1.column = alias2.column);</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ç›¸å…³å­æŸ¥è¯¢ä¾æ®ä¸€ä¸ªè¡¨ä¸­çš„æ•°æ®æ›´æ–°å¦ä¸€ä¸ªè¡¨çš„æ•°æ®ã€‚</p><p>é¢˜ç›®ï¼šåœ¨employeesä¸­å¢åŠ ä¸€ä¸ªdepartment_nameå­—æ®µï¼Œæ•°æ®ä¸ºå‘˜å·¥å¯¹åº”çš„éƒ¨é—¨åç§°</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># 1ï¼‰</span><br><span class="line">ALTER TABLE employees</span><br><span class="line">ADD(department_name VARCHAR2(14));</span><br><span class="line"></span><br><span class="line"># 2ï¼‰</span><br><span class="line">UPDATE employees e</span><br><span class="line">SET department_name = (SELECT department_name</span><br><span class="line">FROM departments d</span><br><span class="line">WHERE e.department_id = d.department_id);</span><br></pre></td></tr></table></figure><h3 id="4-ç›¸å…³åˆ é™¤"><a href="#4-ç›¸å…³åˆ é™¤" class="headerlink" title="4) ç›¸å…³åˆ é™¤"></a>4) ç›¸å…³åˆ é™¤</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">DELETE FROM table1 alias1</span><br><span class="line">WHERE column operator (SELECT expression</span><br><span class="line">FROM table2 alias2</span><br><span class="line">WHERE alias1.column = alias2.column);</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ç›¸å…³å­æŸ¥è¯¢ä¾æ®ä¸€ä¸ªè¡¨ä¸­çš„æ•°æ®åˆ é™¤å¦ä¸€ä¸ªè¡¨çš„æ•°æ®ã€‚</p><p>é¢˜ç›®ï¼šåˆ é™¤è¡¨employeesä¸­ï¼Œå…¶ä¸emp_historyè¡¨çš†æœ‰çš„æ•°æ®</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">DELETE FROM employees e</span><br><span class="line">WHERE employee_id in(</span><br><span class="line">    SELECT employee_id</span><br><span class="line">    FROM emp_history</span><br><span class="line">    WHERE employee_id = e.employee_id</span><br><span class="line">);</span><br></pre></td></tr></table></figure><h2 id="6-æ€è€ƒé¢˜"><a href="#6-æ€è€ƒé¢˜" class="headerlink" title="6. æ€è€ƒé¢˜"></a>6. æ€è€ƒé¢˜</h2><p>é—®é¢˜ï¼šè°çš„å·¥èµ„æ¯”Abelçš„é«˜ï¼Ÿ è§£ç­”ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#æ–¹å¼1ï¼šè‡ªè¿æ¥</span><br><span class="line">SELECT e2.last_name,e2.salary</span><br><span class="line">FROM employees e1,employees e2</span><br><span class="line">WHERE e1.last_name = &#x27;Abel&#x27;</span><br><span class="line">AND e1.`salary` &lt; e2.`salary`;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#æ–¹å¼2ï¼šå­æŸ¥è¯¢</span><br><span class="line">SELECT last_name,salary</span><br><span class="line">FROM employees</span><br><span class="line">WHERE salary &gt; (</span><br><span class="line">    SELECT salary</span><br><span class="line">    FROM employees</span><br><span class="line">    WHERE last_name = &#x27;Abel&#x27;</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>é—®é¢˜ï¼šä»¥ä¸Šä¸¤ç§æ–¹å¼æœ‰å¥½åä¹‹åˆ†å—ï¼Ÿ </p><p>è§£ç­”ï¼šè‡ªè¿æ¥æ–¹å¼å¥½ï¼ </p><p>é¢˜ç›®ä¸­å¯ä»¥ä½¿ç”¨å­æŸ¥è¯¢ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨è‡ªè¿æ¥ã€‚ä¸€èˆ¬æƒ…å†µå»ºè®®ä½ ä½¿ç”¨è‡ªè¿æ¥ï¼Œå› ä¸ºåœ¨è®¸å¤š DBMS çš„å¤„ç†è¿‡ ç¨‹ä¸­ï¼Œå¯¹äºè‡ªè¿æ¥çš„å¤„ç†é€Ÿåº¦è¦æ¯”å­æŸ¥è¯¢å¿«å¾—å¤šã€‚ å¯ä»¥è¿™æ ·ç†è§£ï¼šå­æŸ¥è¯¢å®é™…ä¸Šæ˜¯é€šè¿‡æœªçŸ¥è¡¨è¿›è¡ŒæŸ¥è¯¢åçš„æ¡ä»¶åˆ¤æ–­ï¼Œè€Œè‡ªè¿æ¥æ˜¯é€šè¿‡å·²çŸ¥çš„è‡ªèº«æ•°æ®è¡¨ è¿›è¡Œæ¡ä»¶åˆ¤æ–­ï¼Œå› æ­¤åœ¨å¤§éƒ¨åˆ† DBMS ä¸­éƒ½å¯¹è‡ªè¿æ¥å¤„ç†è¿›è¡Œäº†ä¼˜åŒ–ã€‚</p><h2 id="7-è¯¾åç»ƒä¹ "><a href="#7-è¯¾åç»ƒä¹ " class="headerlink" title="7. è¯¾åç»ƒä¹ "></a>7. è¯¾åç»ƒä¹ </h2><ol><li>æŸ¥è¯¢å’ŒZlotkeyç›¸åŒéƒ¨é—¨çš„å‘˜å·¥å§“åå’Œå·¥èµ„</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SELECT last_name, salary</span><br><span class="line">FROM employees</span><br><span class="line">WHERE department_id = (</span><br><span class="line">SELECT department_id</span><br><span class="line">    FROM employees</span><br><span class="line">    WHERE last_name = &#x27;Zlotkey&#x27;</span><br><span class="line">);</span><br></pre></td></tr></table></figure><ol start="2"><li>æŸ¥è¯¢å·¥èµ„æ¯”å…¬å¸å¹³å‡å·¥èµ„é«˜çš„å‘˜å·¥çš„å‘˜å·¥å·ï¼Œå§“åå’Œå·¥èµ„ã€‚</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SELECT employee_id, last_name, salary</span><br><span class="line">FROM employees</span><br><span class="line">WHERE salary &gt; (</span><br><span class="line">SELECT AVG(salary)</span><br><span class="line">    FROM employee</span><br><span class="line">);</span><br></pre></td></tr></table></figure><ol start="3"><li>é€‰æ‹©å·¥èµ„å¤§äºæ‰€æœ‰JOB_ID &#x3D; â€˜SA_MANâ€™ çš„å‘˜å·¥çš„å·¥èµ„çš„å‘˜å·¥çš„last_name, job_id, salary</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SELECT last_name, job_id, salary</span><br><span class="line">FROM employees</span><br><span class="line">WHERE salary &gt; ALL (</span><br><span class="line">SELECT salary</span><br><span class="line">    FROM employees</span><br><span class="line">    WHERE job_id = &#x27;SA_MAN&#x27;</span><br><span class="line">);</span><br></pre></td></tr></table></figure><ol start="4"><li>æŸ¥è¯¢å’Œå§“åä¸­åŒ…å«å­—æ¯uçš„å‘˜å·¥åœ¨ç›¸åŒéƒ¨é—¨çš„å‘˜å·¥çš„å‘˜å·¥å·å’Œå§“å</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SELECT employee_id, last_name</span><br><span class="line">FROM eployees</span><br><span class="line">WHERE department_id IN (</span><br><span class="line">    SELECT DISTINCT department_id</span><br><span class="line">    FROM employees</span><br><span class="line">    WHERE last_name LIKE &#x27;%u%&#x27;</span><br><span class="line">);</span><br></pre></td></tr></table></figure><ol start="5"><li>æŸ¥è¯¢åœ¨éƒ¨é—¨çš„location_idä¸º1700çš„éƒ¨é—¨å·¥ä½œçš„å‘˜å·¥çš„å‘˜å·¥å·</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SELECT employee_id</span><br><span class="line">FROM employees</span><br><span class="line">WHERE department_id IN (</span><br><span class="line">SELECT department_id</span><br><span class="line">    FROM departments</span><br><span class="line">    WHERE location_id = 1700</span><br><span class="line">);</span><br></pre></td></tr></table></figure><ol start="6"><li>æŸ¥è¯¢ç®¡ç†è€…æ˜¯Kingçš„å‘˜å·¥å§“åå’Œå·¥èµ„</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SELECT last_name, salary</span><br><span class="line">FROM employees</span><br><span class="line">WHERE manage_id IN (</span><br><span class="line">SELECT employee_id</span><br><span class="line">    FROM employees</span><br><span class="line">    WHERE last_name = &#x27;King&#x27;</span><br><span class="line">);</span><br></pre></td></tr></table></figure><ol start="7"><li>æŸ¥è¯¢å·¥èµ„æœ€ä½çš„å‘˜å·¥ä¿¡æ¯ (last_name, salary)</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SELECT last_name, salary</span><br><span class="line">FROM employees</span><br><span class="line">WHERE salary = (</span><br><span class="line">SELECT MIN(salary)</span><br><span class="line">    FROM employees</span><br><span class="line">);</span><br></pre></td></tr></table></figure><ol start="8"><li>æŸ¥è¯¢å¹³å‡å·¥èµ„æœ€ä½çš„éƒ¨é—¨ä¿¡æ¯</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"># æ–¹å¼ä¸€</span><br><span class="line">SELECT *</span><br><span class="line">FROM departments</span><br><span class="line">WHERE department_id = (</span><br><span class="line">SELECT department_id</span><br><span class="line">    FROM employees</span><br><span class="line">    GROUP BY department_id</span><br><span class="line">    HAVING AVG(salary) = (</span><br><span class="line">    SELECT MIN(avg_sal)</span><br><span class="line">        FROM (</span><br><span class="line">        SELECT AVG(salary) avg_sal</span><br><span class="line">            FROM employees</span><br><span class="line">            GROUP BY department_id</span><br><span class="line">        ) t_dept_avg_sal</span><br><span class="line">    )</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"># æ–¹å¼äºŒ</span><br><span class="line">SELECT *</span><br><span class="line">FROM departments</span><br><span class="line">WHERE department_id = (</span><br><span class="line">SELECT department_id</span><br><span class="line">    FROM employees</span><br><span class="line">    GROUP BY department_id</span><br><span class="line">    HAVING AVG(salary) &lt;= ALL (</span><br><span class="line">        SELECT AVG(salary) avg_sal</span><br><span class="line">        FROM employees</span><br><span class="line">        GROUP BY department_id</span><br><span class="line">    )</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"># æ–¹å¼ä¸‰: LIMIT</span><br><span class="line">SELECT *</span><br><span class="line">FROM departments</span><br><span class="line">WHERE department_id IN (</span><br><span class="line">    SELECT department_id</span><br><span class="line">    FROM employees</span><br><span class="line">    GROUP BY department_id</span><br><span class="line">    HAVING AVG(salary) = (</span><br><span class="line">    SELECT AVG(salary) avg_sal</span><br><span class="line">        FROM employees</span><br><span class="line">        GROUP BY department_id</span><br><span class="line">        ORDER BY avg_sal ASC</span><br><span class="line">        LIMIT 1</span><br><span class="line">    )</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"># æ–¹å¼å››</span><br><span class="line">SELECT d.*</span><br><span class="line">FROM departments d, (</span><br><span class="line">SELECT department_id, AVG(salary) avg_sal</span><br><span class="line">    FROM employees</span><br><span class="line">    GROUP BY department_id</span><br><span class="line">    ORDER BY avg_sal ASC</span><br><span class="line">    LIMIT 0,1</span><br><span class="line">) t_dept_avg_sal</span><br><span class="line">WHERE d.`department_id` = t_dept_avg_sal.`department_id`;</span><br></pre></td></tr></table></figure><ol start="9"><li>æŸ¥è¯¢å¹³å‡å·¥èµ„æœ€ä½çš„éƒ¨é—¨ä¿¡æ¯å’Œè¯¥éƒ¨é—¨çš„å¹³å‡å·¥èµ„ (ç›¸å…³å­æŸ¥è¯¢)</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">SELECT d.*, (SELECT AVG(salary) FROM employees WHERE department_id = d.`department_id`) avg_sal</span><br><span class="line">FROM departments d, (</span><br><span class="line">SELECT department_id, AVG(salary) avg_sal</span><br><span class="line">    FROM employees</span><br><span class="line">    GROUP BY department_id</span><br><span class="line">    ORDER BY avg_sal ASC</span><br><span class="line">    LIMIT 0,1</span><br><span class="line">) t_dept_avg_sal</span><br><span class="line">WHERE d.`department_id` = t_dept_avg_sal.`department_id`;</span><br></pre></td></tr></table></figure><ol start="10"><li>æŸ¥è¯¢å¹³å‡å·¥èµ„æœ€é«˜çš„jobä¿¡æ¯</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">SELECT *</span><br><span class="line">FROM jobs</span><br><span class="line">WHERE job_id = (</span><br><span class="line">SELECT job_id</span><br><span class="line">    FROM employees</span><br><span class="line">    GROUP BY job_id</span><br><span class="line">    HAVING AVG(salary) = (</span><br><span class="line">    SELECT MAX(avg_sal)</span><br><span class="line">        FROM (</span><br><span class="line">        SELECT AVG(salary) avg_sal</span><br><span class="line">            FROM employees</span><br><span class="line">            GROUP BY job_id</span><br><span class="line">        ) t_job_avg_sal</span><br><span class="line">    )</span><br><span class="line">);</span><br></pre></td></tr></table></figure><ol start="11"><li>æŸ¥è¯¢å¹³å‡å·¥èµ„é«˜äºå…¬å¸å¹³å‡å·¥èµ„çš„éƒ¨é—¨æœ‰å“ªäº›ï¼Ÿ</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">SELECT depatment_id</span><br><span class="line">FROM employees</span><br><span class="line">WHERE department_id IS NOT NULL</span><br><span class="line">GROUP BY department_id</span><br><span class="line">HAVING AVG(salary) &gt; (</span><br><span class="line">SELECT AVG(salary)</span><br><span class="line">    FROM eployees</span><br><span class="line">);</span><br></pre></td></tr></table></figure><ol start="12"><li>æŸ¥è¯¢å‡ºå…¬å¸ä¸­æ‰€æœ‰managerçš„è¯¦ç»†ä¿¡æ¯</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"># æ–¹å¼1ï¼šè‡ªè¿æ¥</span><br><span class="line">SELECT DISTINCT *</span><br><span class="line">FROM employees emp, employees manager</span><br><span class="line">WHERE emp.`manager_id` = manager.`employee_id`;</span><br><span class="line"></span><br><span class="line">SELECT DISTINCT *</span><br><span class="line">FROM employees emp JOIN employees manager</span><br><span class="line">ON emp.`manager_id` = manager.`employee_id`; </span><br><span class="line"></span><br><span class="line"># æ–¹å¼2ï¼šå­æŸ¥è¯¢</span><br><span class="line">SELECT *</span><br><span class="line">FROM employees</span><br><span class="line">WHERE employee_id IN (</span><br><span class="line">SELECT manager_id</span><br><span class="line">    FROM employees</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"># æ–¹å¼3ï¼šEXISTS</span><br><span class="line">SELECT *</span><br><span class="line">FROM employees manager</span><br><span class="line">WHERE EXISTS (</span><br><span class="line">SELECT *</span><br><span class="line">    FROM employees emp</span><br><span class="line">    WHERE manager.`employee_id` = emp.`manager_id`</span><br><span class="line">);</span><br></pre></td></tr></table></figure><ol start="13"><li>å„ä¸ªéƒ¨é—¨ä¸­ï¼Œæœ€é«˜å·¥èµ„ä¸­æœ€ä½çš„é‚£ä¸ªéƒ¨é—¨çš„æœ€ä½å·¥èµ„æ˜¯å¤šå°‘ï¼Ÿ</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"># æ–¹å¼ä¸€ï¼š</span><br><span class="line">SELECT MIN(salary)</span><br><span class="line">FROM employees</span><br><span class="line">WHERE department_id = (</span><br><span class="line">    SELECT department_id</span><br><span class="line">    FROM employees</span><br><span class="line">GROUP BY department_id</span><br><span class="line">HAVING MAX(salary) = (</span><br><span class="line">    SELECT MIN(max_sal)</span><br><span class="line">        FROM (</span><br><span class="line">        SELECT MAX(salary) max_sal</span><br><span class="line">            FROM employees</span><br><span class="line">            GROUP BY department_id</span><br><span class="line">        ) t_dept_max_sal</span><br><span class="line">    ) </span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"># æ–¹å¼äºŒï¼š</span><br><span class="line">SELECT MIN(salary)</span><br><span class="line">FROM employees</span><br><span class="line">WHERE department_id = (</span><br><span class="line">    SELECT department_id</span><br><span class="line">    FROM employees</span><br><span class="line">GROUP BY department_id</span><br><span class="line">HAVING MAX(salary) &lt;= ALL (</span><br><span class="line">        SELECT MAX(salary)</span><br><span class="line">        FROM employees</span><br><span class="line">        GROUP BY department_id</span><br><span class="line">    ) </span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"># æ–¹å¼ä¸‰ï¼š</span><br><span class="line">SELECT MIN(salary)</span><br><span class="line">FROM employees</span><br><span class="line">WHERE department_id = (</span><br><span class="line">    SELECT department_id</span><br><span class="line">    FROM employees</span><br><span class="line">GROUP BY department_id</span><br><span class="line">HAVING MAX(salary) = (</span><br><span class="line">        SELECT MAX(salary) max_sal</span><br><span class="line">        FROM employees</span><br><span class="line">        GROUP BY department_id</span><br><span class="line">        ORDER BY max_sal ASC</span><br><span class="line">        LIMIT 0,1</span><br><span class="line">    ) </span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"># æ–¹å¼å››ï¼š</span><br><span class="line">FROM employees e, (</span><br><span class="line">SELECT department_id, MAX(salary) max_sal</span><br><span class="line">    FROM employees</span><br><span class="line">    GROUP BY department_id</span><br><span class="line">    ORDER BY max_sal ASC</span><br><span class="line">    LIMIT 0,1</span><br><span class="line">) t_dept_max_sal</span><br><span class="line">WHERE e.`department_id` = t_dept_max_sal.`department_id`;</span><br></pre></td></tr></table></figure><ol start="14"><li>æŸ¥è¯¢å¹³å‡å·¥èµ„æœ€é«˜çš„éƒ¨é—¨çš„managerçš„è¯¦ç»†ä¿¡æ¯ï¼šlast_name, department_id, email, salary</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">SELECT last_name, department_id, email, salary</span><br><span class="line">FROM employees</span><br><span class="line">WHERE employee_id IN (</span><br><span class="line">SELECT DISTINCT manager_id</span><br><span class="line">    FROM employees</span><br><span class="line">    WHERE department_id = (</span><br><span class="line">    SELECT department_id</span><br><span class="line">        FROM employees</span><br><span class="line">        GROUP BY department_id</span><br><span class="line">        HAVING AVG(salary) = (</span><br><span class="line">        SELECT MAX(avg_sal)</span><br><span class="line">            FROM (</span><br><span class="line">            SELECT AVG(salary) avg_sal</span><br><span class="line">                FROM employees</span><br><span class="line">                GROUP BY department_id</span><br><span class="line">            ) t_dept_avg_sal</span><br><span class="line">        )</span><br><span class="line">    )</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">SELECT last_name, department_id, email, salary</span><br><span class="line">FROM employees</span><br><span class="line">WHERE employee_id IN (</span><br><span class="line">    SELECT DISTINCT manager_id</span><br><span class="line">    FROM employees e, (</span><br><span class="line">        SELECT department_id, AVG(salary) avg_sal</span><br><span class="line">        FROM employees</span><br><span class="line">        GROUP BY department_id</span><br><span class="line">        ORDER BY avg_sal DESC</span><br><span class="line">        LIMIT 0,1</span><br><span class="line">    ) t_dept_avg_sal</span><br><span class="line">    WHERE e.`department_id` = t_dept_avg_sal.`department_id`</span><br><span class="line">);</span><br></pre></td></tr></table></figure><ol start="15"><li>æŸ¥è¯¢éƒ¨é—¨çš„éƒ¨é—¨å·ï¼Œå…¶ä¸­ä¸åŒ…æ‹¬job_idæ˜¯â€ST_CLERKâ€çš„éƒ¨é—¨å·</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">SELECT department_id</span><br><span class="line">FROM departments</span><br><span class="line">WHERE department_id NOT IN (</span><br><span class="line">SELECT DISTINCT department_id</span><br><span class="line">    FROM employees</span><br><span class="line">    WHERE job_id = `ST_CLERK`</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">SELECT department_id</span><br><span class="line">FROM department d</span><br><span class="line">WHERE NOT EXISTS (</span><br><span class="line">SELECT *</span><br><span class="line">    FROM employees e</span><br><span class="line">    WHERE d.`department_id` = e.`department_id`</span><br><span class="line">    AND e.`job_id` = &#x27;ST_CLERK&#x27;</span><br><span class="line">);</span><br></pre></td></tr></table></figure><ol start="16"><li>é€‰æ‹©æ‰€æœ‰æ²¡æœ‰ç®¡ç†è€…çš„å‘˜å·¥çš„last_name</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SELECT last_name</span><br><span class="line">FROM employees emp</span><br><span class="line">WHERE NOT EXISTS (</span><br><span class="line">SELECT *</span><br><span class="line">    FROM employees mgr</span><br><span class="line">    WHERE emp.`manager_id` = mgr.`employee_id`</span><br><span class="line">);</span><br></pre></td></tr></table></figure><ol start="17"><li>æŸ¥è¯¢å‘˜å·¥å·ã€å§“åã€é›‡ç”¨æ—¶é—´ã€å·¥èµ„ï¼Œå…¶ä¸­å‘˜å·¥çš„ç®¡ç†è€…ä¸º â€˜De Haanâ€™</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SELECT employee_id, last_name, hire_date, salary</span><br><span class="line">FROM employee</span><br><span class="line">WHERE manager_id IN (</span><br><span class="line">SELECT manager_id</span><br><span class="line">    FROM employee</span><br><span class="line">    WHERE last_name = &#x27;De Haan&#x27;</span><br><span class="line">);</span><br></pre></td></tr></table></figure><ol start="18"><li>æŸ¥è¯¢å„éƒ¨é—¨ä¸­å·¥èµ„æ¯”æœ¬éƒ¨é—¨å¹³å‡å·¥èµ„é«˜çš„å‘˜å·¥çš„å‘˜å·¥å·ï¼Œå§“åå’Œå·¥èµ„ï¼ˆç›¸å…³å­æŸ¥è¯¢ï¼‰</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">SELECT department_id, last_name, salary</span><br><span class="line">FROM employees e1</span><br><span class="line">WHERE salary &gt; (</span><br><span class="line">SELECT AVG(salary)</span><br><span class="line">    FROM employees e2</span><br><span class="line">    WHERE e2.`department_id` = e1.`department_id`</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">SELECT e.last_name, e.salary, e.department_id</span><br><span class="line">FROM employees e, (</span><br><span class="line">SELECT department_id, AVG(salary) avg_sal</span><br><span class="line">    FROM employees</span><br><span class="line">    GROUP BY department_id</span><br><span class="line">) t_dept_avg_sal</span><br><span class="line">WHERE e.`department_id` = t_dept_avg_sal.`department_id`</span><br><span class="line">AND e.`salary` &gt; t_dept_avg_sal.`avg_sal`;</span><br></pre></td></tr></table></figure><ol start="19"><li>æŸ¥è¯¢æ¯ä¸ªéƒ¨é—¨ä¸‹çš„éƒ¨é—¨äººæ•°å¤§äº5çš„éƒ¨é—¨åç§°ï¼ˆç›¸å…³å­æŸ¥è¯¢ï¼‰</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SELECT department_name</span><br><span class="line">FROM departments d</span><br><span class="line">WHERE 5 &lt; (</span><br><span class="line">SELECT COUNT(*)</span><br><span class="line">    FROM employees e</span><br><span class="line">    WHERE d.`department_id` = e.`department_id`</span><br><span class="line">);</span><br></pre></td></tr></table></figure><ol start="20"><li>æŸ¥è¯¢æ¯ä¸ªå›½å®¶ä¸‹çš„éƒ¨é—¨ä¸ªæ•°å¤§äº2çš„å›½å®¶ç¼–å·ï¼ˆç›¸å…³å­æŸ¥è¯¢ï¼‰</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SELECT country_id</span><br><span class="line">FROM locations l</span><br><span class="line">WHERE 2 &lt; (</span><br><span class="line">SELECT COUNT(*)</span><br><span class="line">    FROM department d</span><br><span class="line">    WHERE l.`location_id` = d.`location_id`</span><br><span class="line">);</span><br></pre></td></tr></table></figure><h1 id="ç¬¬åç« -åˆ›å»ºå’Œç®¡ç†è¡¨"><a href="#ç¬¬åç« -åˆ›å»ºå’Œç®¡ç†è¡¨" class="headerlink" title="ç¬¬åç« _åˆ›å»ºå’Œç®¡ç†è¡¨"></a>ç¬¬åç« _åˆ›å»ºå’Œç®¡ç†è¡¨</h1><h2 id="1-åŸºç¡€çŸ¥è¯†"><a href="#1-åŸºç¡€çŸ¥è¯†" class="headerlink" title="1. åŸºç¡€çŸ¥è¯†"></a>1. åŸºç¡€çŸ¥è¯†</h2><h3 id="1-æ ‡è¯†ç¬¦å‘½åè§„åˆ™"><a href="#1-æ ‡è¯†ç¬¦å‘½åè§„åˆ™" class="headerlink" title="1) æ ‡è¯†ç¬¦å‘½åè§„åˆ™"></a>1) æ ‡è¯†ç¬¦å‘½åè§„åˆ™</h3><ul><li>æ•°æ®åº“åã€è¡¨åä¸å¾—è¶…è¿‡30ä¸ªå­—ç¬¦ï¼Œå˜é‡åé™åˆ¶ä¸º29ä¸ª </li><li>å¿…é¡»åªèƒ½åŒ…å« Aâ€“Z, aâ€“z, 0â€“9, _å…±63ä¸ªå­—ç¬¦ </li><li>æ•°æ®åº“åã€è¡¨åã€å­—æ®µåç­‰å¯¹è±¡åä¸­é—´ä¸è¦åŒ…å«ç©ºæ ¼ </li><li>åŒä¸€ä¸ªMySQLè½¯ä»¶ä¸­ï¼Œæ•°æ®åº“ä¸èƒ½åŒåï¼›åŒä¸€ä¸ªåº“ä¸­ï¼Œè¡¨ä¸èƒ½é‡åï¼›åŒä¸€ä¸ªè¡¨ä¸­ï¼Œå­—æ®µä¸èƒ½é‡å </li><li>å¿…é¡»ä¿è¯ä½ çš„å­—æ®µæ²¡æœ‰å’Œä¿ç•™å­—ã€æ•°æ®åº“ç³»ç»Ÿæˆ–å¸¸ç”¨æ–¹æ³•å†²çªã€‚å¦‚æœåšæŒä½¿ç”¨ï¼Œè¯·åœ¨SQLè¯­å¥ä¸­ä½¿ ç”¨&#96;ï¼ˆç€é‡å·ï¼‰å¼•èµ·æ¥ </li><li>ä¿æŒå­—æ®µåå’Œç±»å‹çš„ä¸€è‡´æ€§ï¼šåœ¨å‘½åå­—æ®µå¹¶ä¸ºå…¶æŒ‡å®šæ•°æ®ç±»å‹çš„æ—¶å€™ä¸€å®šè¦ä¿è¯ä¸€è‡´æ€§ï¼Œå‡å¦‚æ•°æ® ç±»å‹åœ¨ä¸€ä¸ªè¡¨é‡Œæ˜¯æ•´æ•°ï¼Œé‚£åœ¨å¦ä¸€ä¸ªè¡¨é‡Œå¯å°±åˆ«å˜æˆå­—ç¬¦å‹äº†</li></ul><h3 id="2-MySQLä¸­çš„æ•°æ®ç±»å‹"><a href="#2-MySQLä¸­çš„æ•°æ®ç±»å‹" class="headerlink" title="2) MySQLä¸­çš„æ•°æ®ç±»å‹"></a>2) MySQLä¸­çš„æ•°æ®ç±»å‹</h3><table><thead><tr><th>ç±»å‹</th><th>æ•°æ®å˜é‡</th></tr></thead><tbody><tr><td>æ•´æ•°ç±»å‹</td><td>TINYINTã€SMALLINTã€MEDIUMINTã€INT(æˆ–INTEGER)ã€BIGINT</td></tr><tr><td>æµ®ç‚¹ç±»å‹</td><td>FLOATã€DOUBLE</td></tr><tr><td>å®šç‚¹æ•°ç±»å‹</td><td>DECIMAL</td></tr><tr><td>ä½ç±»å‹</td><td>BIT</td></tr><tr><td>æ—¥æœŸæ—¶é—´ç±»å‹</td><td>YEARã€TIMEã€DATEã€DATETIMEã€TIMESTAMP</td></tr><tr><td>æ–‡æœ¬å­—ç¬¦ä¸²ç±»å‹</td><td>CHARã€VARCHARã€TINYTEXTã€TEXTã€MEDIUMTEXTã€LONGTEXT</td></tr><tr><td>æšä¸¾ç±»å‹</td><td>ENUM</td></tr><tr><td>é›†åˆç±»å‹</td><td>SET</td></tr><tr><td>äºŒè¿›åˆ¶å­—ç¬¦ä¸²ç±»å‹</td><td>BINARYã€VARBINARYã€TINYBLOBã€BLOBã€MEDIUMBLOBã€LONGBLOB</td></tr><tr><td>JSONç±»å‹</td><td>JSONå¯¹è±¡ã€JSONæ•°ç»„</td></tr><tr><td>ç©ºé—´æ•°æ®ç±»å‹</td><td>å•å€¼ï¼šGEOMETRYã€POINTã€LINESTRINGã€POLYGONï¼› é›†åˆï¼šMULTIPOINTã€MULTILINESTRINGã€MULTIPOLYGONã€ GEOMETRYCOLLECTION</td></tr></tbody></table><p>å…¶ä¸­ï¼Œå¸¸ç”¨çš„å‡ ç±»ç±»å‹ä»‹ç»å¦‚ä¸‹ï¼š</p><table><thead><tr><th>æ•°æ®ç±»å‹</th><th>æè¿°</th></tr></thead><tbody><tr><td>INT</td><td>ä»-2^31åˆ°2^31-1çš„æ•´å‹æ•°æ®ã€‚å­˜å‚¨å¤§å°ä¸º 4ä¸ªå­—èŠ‚</td></tr><tr><td>CHAR(size)</td><td>FLOATã€DOUBLE</td></tr><tr><td>VARCHAR(size)</td><td>DECIMAL</td></tr><tr><td>FLOAT(M,D)</td><td>BIT</td></tr><tr><td>DOUBLE(M,D)</td><td>YEARã€TIMEã€DATEã€DATETIMEã€TIMESTAMP</td></tr><tr><td>DECIMAL(M,D)</td><td>CHARã€VARCHARã€TINYTEXTã€TEXTã€MEDIUMTEXTã€LONGTEXT</td></tr><tr><td>DATE</td><td>ENUM</td></tr><tr><td>BLOB</td><td>SET</td></tr><tr><td>TEXT</td><td>BINARYã€VARBINARYã€TINYBLOBã€BLOBã€MEDIUMBLOBã€LONGBLOB</td></tr></tbody></table><h2 id="2-åˆ›å»ºå’Œç®¡ç†æ•°æ®åº“"><a href="#2-åˆ›å»ºå’Œç®¡ç†æ•°æ®åº“" class="headerlink" title="2. åˆ›å»ºå’Œç®¡ç†æ•°æ®åº“"></a>2. åˆ›å»ºå’Œç®¡ç†æ•°æ®åº“</h2><h3 id="1-åˆ›å»ºæ•°æ®åº“"><a href="#1-åˆ›å»ºæ•°æ®åº“" class="headerlink" title="1) åˆ›å»ºæ•°æ®åº“"></a>1) åˆ›å»ºæ•°æ®åº“</h3><ul><li><p>æ–¹å¼1ï¼šåˆ›å»ºæ•°æ®åº“</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CREATE DATABASE æ•°æ®åº“å;</span><br></pre></td></tr></table></figure></li><li><p>æ–¹å¼2ï¼šåˆ›å»ºæ•°æ®åº“å¹¶æŒ‡å®šå­—ç¬¦é›†</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CREATE DATABASE æ•°æ®åº“å CHARACTER SET å­—ç¬¦é›†;</span><br></pre></td></tr></table></figure></li><li><p>æ–¹å¼3ï¼šåˆ¤æ–­æ•°æ®åº“æ˜¯å¦å·²ç»å­˜åœ¨ï¼Œä¸å­˜åœ¨åˆ™åˆ›å»ºæ•°æ®åº“ï¼ˆ æ¨è ï¼‰</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CREATE DATABASE IF NOT EXISTS æ•°æ®åº“å;</span><br></pre></td></tr></table></figure></li></ul><p>å¦‚æœMySQLä¸­å·²ç»å­˜åœ¨ç›¸å…³çš„æ•°æ®åº“ï¼Œåˆ™å¿½ç•¥åˆ›å»ºè¯­å¥ï¼Œä¸å†åˆ›å»ºæ•°æ®åº“ã€‚</p><blockquote><p>æ³¨æ„ï¼šDATABASE ä¸èƒ½æ”¹åã€‚ä¸€äº›å¯è§†åŒ–å·¥å…·å¯ä»¥æ”¹åï¼Œå®ƒæ˜¯å»ºæ–°åº“ï¼ŒæŠŠæ‰€æœ‰è¡¨å¤åˆ¶åˆ°æ–°åº“ï¼Œå†åˆ  æ—§åº“å®Œæˆçš„ã€‚</p></blockquote><h3 id="2-ä½¿ç”¨æ•°æ®åº“"><a href="#2-ä½¿ç”¨æ•°æ®åº“" class="headerlink" title="2) ä½¿ç”¨æ•°æ®åº“"></a>2) ä½¿ç”¨æ•°æ®åº“</h3><ul><li><p>æŸ¥çœ‹å½“å‰æ‰€æœ‰çš„æ•°æ®åº“</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHOW DATABASES; #æœ‰ä¸€ä¸ªSï¼Œä»£è¡¨å¤šä¸ªæ•°æ®åº“</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹å½“å‰æ­£åœ¨ä½¿ç”¨çš„æ•°æ®åº“</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT DATABASE(); #ä½¿ç”¨çš„ä¸€ä¸ª mysql ä¸­çš„å…¨å±€å‡½æ•°</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹æŒ‡å®šåº“ä¸‹æ‰€æœ‰çš„è¡¨</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHOW TABLES FROM æ•°æ®åº“å</span><br></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹æ•°æ®åº“çš„åˆ›å»ºä¿¡æ¯</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SHOW CREATE DATABASE æ•°æ®åº“å;</span><br><span class="line">æˆ–è€…ï¼š</span><br><span class="line">SHOW CREATE DATABASE æ•°æ®åº“å\G</span><br></pre></td></tr></table></figure></li><li><p>ä½¿ç”¨&#x2F;åˆ‡æ¢æ•°æ®åº“</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">USE æ•°æ®åº“å;</span><br></pre></td></tr></table></figure></li></ul><blockquote><p>æ³¨æ„ï¼šè¦æ“ä½œè¡¨æ ¼å’Œæ•°æ®ä¹‹å‰å¿…é¡»å…ˆè¯´æ˜æ˜¯å¯¹å“ªä¸ªæ•°æ®åº“è¿›è¡Œæ“ä½œï¼Œå¦åˆ™å°±è¦å¯¹æ‰€æœ‰å¯¹è±¡åŠ ä¸Šâ€œæ•° æ®åº“å.â€ã€‚</p></blockquote><h3 id="3-ä¿®æ”¹æ•°æ®åº“"><a href="#3-ä¿®æ”¹æ•°æ®åº“" class="headerlink" title="3) ä¿®æ”¹æ•°æ®åº“"></a>3) ä¿®æ”¹æ•°æ®åº“</h3><ul><li><p>æ›´æ”¹æ•°æ®åº“å­—ç¬¦é›†</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ALTER DATABASE æ•°æ®åº“å CHARACTER SET å­—ç¬¦é›†; #æ¯”å¦‚ï¼šgbkã€utf8ç­‰</span><br></pre></td></tr></table></figure></li><li><p>æ–¹å¼1ï¼šåˆ é™¤æŒ‡å®šçš„æ•°æ®åº“</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DROP DATABASE æ•°æ®åº“å;</span><br></pre></td></tr></table></figure></li><li><p>æ–¹å¼2ï¼šåˆ é™¤æŒ‡å®šçš„æ•°æ®åº“ï¼ˆ æ¨è ï¼‰</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DROP DATABASE IF EXISTS æ•°æ®åº“å;</span><br></pre></td></tr></table></figure></li></ul><h2 id="3-åˆ›å»ºè¡¨"><a href="#3-åˆ›å»ºè¡¨" class="headerlink" title="3. åˆ›å»ºè¡¨"></a>3. åˆ›å»ºè¡¨</h2><h3 id="1-åˆ›å»ºæ–¹å¼1"><a href="#1-åˆ›å»ºæ–¹å¼1" class="headerlink" title="1) åˆ›å»ºæ–¹å¼1"></a>1) åˆ›å»ºæ–¹å¼1</h3><ul><li>è¯­æ³•æ ¼å¼ï¼š</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE [IF NOT EXISTS] è¡¨å(</span><br><span class="line">å­—æ®µ1, æ•°æ®ç±»å‹ [çº¦æŸæ¡ä»¶] [é»˜è®¤å€¼],</span><br><span class="line">å­—æ®µ2, æ•°æ®ç±»å‹ [çº¦æŸæ¡ä»¶] [é»˜è®¤å€¼],</span><br><span class="line">å­—æ®µ3, æ•°æ®ç±»å‹ [çº¦æŸæ¡ä»¶] [é»˜è®¤å€¼],</span><br><span class="line">â€¦â€¦</span><br><span class="line">[è¡¨çº¦æŸæ¡ä»¶]</span><br><span class="line">);</span><br></pre></td></tr></table></figure><blockquote><p>åŠ ä¸Šäº†IF NOT EXISTSå…³é”®å­—ï¼Œåˆ™è¡¨ç¤ºï¼šå¦‚æœå½“å‰æ•°æ®åº“ä¸­ä¸å­˜åœ¨è¦åˆ›å»ºçš„æ•°æ®è¡¨ï¼Œåˆ™åˆ›å»ºæ•°æ®è¡¨ï¼› å¦‚æœå½“å‰æ•°æ®åº“ä¸­å·²ç»å­˜åœ¨è¦åˆ›å»ºçš„æ•°æ®è¡¨ï¼Œåˆ™å¿½ç•¥å»ºè¡¨è¯­å¥ï¼Œä¸å†åˆ›å»ºæ•°æ®è¡¨ã€‚</p></blockquote><h3 id="2-åˆ›å»ºæ–¹å¼2"><a href="#2-åˆ›å»ºæ–¹å¼2" class="headerlink" title="2) åˆ›å»ºæ–¹å¼2"></a>2) åˆ›å»ºæ–¹å¼2</h3><ul><li>ä½¿ç”¨ AS subquery é€‰é¡¹ï¼Œå°†åˆ›å»ºè¡¨å’Œæ’å…¥æ•°æ®ç»“åˆèµ·æ¥</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE è¡¨å</span><br><span class="line">[(column, column, ...)]</span><br><span class="line">AS subquery;</span><br></pre></td></tr></table></figure><ul><li>æŒ‡å®šçš„åˆ—å’Œå­æŸ¥è¯¢ä¸­çš„åˆ—è¦ä¸€ä¸€å¯¹åº”</li><li>é€šè¿‡åˆ—åå’Œé»˜è®¤å€¼å®šä¹‰åˆ—</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE dept80</span><br><span class="line">AS</span><br><span class="line">SELECT employee_id, last_name, salary*12 ANNSAL, hire_date</span><br><span class="line">FROM employees</span><br><span class="line">WHERE department_id = 80;</span><br></pre></td></tr></table></figure><h3 id="3-æŸ¥çœ‹æ•°æ®è¡¨ç»“æ„"><a href="#3-æŸ¥çœ‹æ•°æ®è¡¨ç»“æ„" class="headerlink" title="3) æŸ¥çœ‹æ•°æ®è¡¨ç»“æ„"></a>3) æŸ¥çœ‹æ•°æ®è¡¨ç»“æ„</h3><p>åœ¨MySQLä¸­åˆ›å»ºå¥½æ•°æ®è¡¨ä¹‹åï¼Œå¯ä»¥æŸ¥çœ‹æ•°æ®è¡¨çš„ç»“æ„ã€‚MySQLæ”¯æŒä½¿ç”¨ DESCRIBE&#x2F;DESC è¯­å¥æŸ¥çœ‹æ•°æ® è¡¨ç»“æ„ï¼Œä¹Ÿæ”¯æŒä½¿ç”¨ SHOW CREATE TABLE è¯­å¥æŸ¥çœ‹æ•°æ®è¡¨ç»“æ„ã€‚</p><p>è¯­æ³•æ ¼å¼å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHOW CREATE TABLE è¡¨å\G</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨SHOW CREATE TABLEè¯­å¥ä¸ä»…å¯ä»¥æŸ¥çœ‹è¡¨åˆ›å»ºæ—¶çš„è¯¦ç»†è¯­å¥ï¼Œè¿˜å¯ä»¥æŸ¥çœ‹å­˜å‚¨å¼•æ“å’Œå­—ç¬¦ç¼–ç ã€‚</p><h2 id="4-ä¿®æ”¹è¡¨"><a href="#4-ä¿®æ”¹è¡¨" class="headerlink" title="4. ä¿®æ”¹è¡¨"></a>4. ä¿®æ”¹è¡¨</h2><p>ä¿®æ”¹è¡¨æŒ‡çš„æ˜¯ä¿®æ”¹æ•°æ®åº“ä¸­å·²ç»å­˜åœ¨çš„æ•°æ®è¡¨çš„ç»“æ„ã€‚</p><p>ä½¿ç”¨ ALTER TABLE è¯­å¥å¯ä»¥å®ç°ï¼š</p><ul><li>å‘å·²æœ‰çš„è¡¨ä¸­æ·»åŠ åˆ—</li><li>ä¿®æ”¹ç°æœ‰è¡¨ä¸­çš„åˆ—</li><li>åˆ é™¤ç°æœ‰è¡¨ä¸­çš„åˆ—</li><li>é‡å‘½åç°æœ‰è¡¨ä¸­çš„åˆ—</li></ul><h3 id="1-è¿½åŠ ä¸€ä¸ªåˆ—"><a href="#1-è¿½åŠ ä¸€ä¸ªåˆ—" class="headerlink" title="1) è¿½åŠ ä¸€ä¸ªåˆ—"></a>1) è¿½åŠ ä¸€ä¸ªåˆ—</h3><p>è¯­æ³•æ ¼å¼å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ALTER TABLE è¡¨å ADD ã€COLUMNã€‘ å­—æ®µå å­—æ®µç±»å‹ ã€FIRST|AFTER å­—æ®µåã€‘;</span><br></pre></td></tr></table></figure><p>ä¸¾ä¾‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ALTER TABLE dept80</span><br><span class="line">ADD job_id varchar(15);</span><br></pre></td></tr></table></figure><h3 id="2-ä¿®æ”¹ä¸€ä¸ªåˆ—"><a href="#2-ä¿®æ”¹ä¸€ä¸ªåˆ—" class="headerlink" title="2) ä¿®æ”¹ä¸€ä¸ªåˆ—"></a>2) ä¿®æ”¹ä¸€ä¸ªåˆ—</h3><ul><li>å¯ä»¥ä¿®æ”¹åˆ—çš„æ•°æ®ç±»å‹ï¼Œé•¿åº¦ã€é»˜è®¤å€¼å’Œä½ç½® </li><li>ä¿®æ”¹å­—æ®µæ•°æ®ç±»å‹ã€é•¿åº¦ã€é»˜è®¤å€¼ã€ä½ç½®çš„è¯­æ³•æ ¼å¼å¦‚ä¸‹ï¼š</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ALTER TABLE è¡¨å MODIFY ã€COLUMNã€‘ å­—æ®µå1 å­—æ®µç±»å‹ ã€DEFAULT é»˜è®¤å€¼ã€‘ã€FIRST|AFTER å­—æ®µå2ã€‘;</span><br></pre></td></tr></table></figure><ul><li>ä¸¾ä¾‹ï¼š</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ALTER TABLE dept80</span><br><span class="line">MODIFY salary double(9,2) default 1000;</span><br></pre></td></tr></table></figure><ul><li>å¯¹é»˜è®¤å€¼çš„ä¿®æ”¹åªå½±å“ä»Šåå¯¹è¡¨çš„ä¿®æ”¹</li><li>æ­¤å¤–ï¼Œè¿˜å¯ä»¥é€šè¿‡æ­¤ç§æ–¹å¼ä¿®æ”¹åˆ—çš„çº¦æŸã€‚</li></ul><h3 id="3-é‡å‘½åä¸€ä¸ªåˆ—"><a href="#3-é‡å‘½åä¸€ä¸ªåˆ—" class="headerlink" title="3) é‡å‘½åä¸€ä¸ªåˆ—"></a>3) é‡å‘½åä¸€ä¸ªåˆ—</h3><p>ä½¿ç”¨ CHANGE old_column new_column dataTypeå­å¥é‡å‘½ååˆ—ã€‚è¯­æ³•æ ¼å¼å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ALTER TABLE è¡¨å CHANGE ã€columnã€‘ åˆ—å æ–°åˆ—å æ–°æ•°æ®ç±»å‹;</span><br></pre></td></tr></table></figure><p>ä¸¾ä¾‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ALTER TABLE dept80</span><br><span class="line">CHANGE department_name dept_name varchar(15);</span><br></pre></td></tr></table></figure><h3 id="4-åˆ é™¤ä¸€ä¸ªåˆ—"><a href="#4-åˆ é™¤ä¸€ä¸ªåˆ—" class="headerlink" title="4) åˆ é™¤ä¸€ä¸ªåˆ—"></a>4) åˆ é™¤ä¸€ä¸ªåˆ—</h3><p>åˆ é™¤è¡¨ä¸­æŸä¸ªå­—æ®µçš„è¯­æ³•æ ¼å¼å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ALTER TABLE è¡¨å DROP ã€COLUMNã€‘å­—æ®µå</span><br></pre></td></tr></table></figure><h3 id="5-æ›´æ”¹è¡¨å"><a href="#5-æ›´æ”¹è¡¨å" class="headerlink" title="5) æ›´æ”¹è¡¨å"></a>5) æ›´æ”¹è¡¨å</h3><ul><li>æ–¹å¼ä¸€ï¼šä½¿ç”¨RENAME</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">RENAME TABLE emp</span><br><span class="line">TO myemp;</span><br></pre></td></tr></table></figure><ul><li>æ–¹å¼äºŒï¼š</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ALTER table dept</span><br><span class="line">RENAME [TO] detail_dept; -- [TO]å¯ä»¥çœç•¥</span><br></pre></td></tr></table></figure><ul><li>å¿…é¡»æ˜¯å¯¹è±¡çš„æ‹¥æœ‰è€…</li></ul><h2 id="5-åˆ é™¤è¡¨"><a href="#5-åˆ é™¤è¡¨" class="headerlink" title="5. åˆ é™¤è¡¨"></a>5. åˆ é™¤è¡¨</h2><ul><li>åœ¨MySQLä¸­ï¼Œå½“ä¸€å¼ æ•°æ®è¡¨ æ²¡æœ‰ä¸å…¶ä»–ä»»ä½•æ•°æ®è¡¨å½¢æˆå…³è”å…³ç³» æ—¶ï¼Œå¯ä»¥å°†å½“å‰æ•°æ®è¡¨ç›´æ¥åˆ é™¤ã€‚ </li><li>æ•°æ®å’Œç»“æ„éƒ½è¢«åˆ é™¤ </li><li>æ‰€æœ‰æ­£åœ¨è¿è¡Œçš„ç›¸å…³äº‹åŠ¡è¢«æäº¤ </li><li>æ‰€æœ‰ç›¸å…³ç´¢å¼•è¢«åˆ é™¤ </li><li>è¯­æ³•æ ¼å¼ï¼š</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DROP TABLE [IF EXISTS] æ•°æ®è¡¨1 [, æ•°æ®è¡¨2, â€¦, æ•°æ®è¡¨n];</span><br></pre></td></tr></table></figure><p>IF EXISTS çš„å«ä¹‰ä¸ºï¼šå¦‚æœå½“å‰æ•°æ®åº“ä¸­å­˜åœ¨ç›¸åº”çš„æ•°æ®è¡¨ï¼Œåˆ™åˆ é™¤æ•°æ®è¡¨ï¼›å¦‚æœå½“å‰æ•°æ®åº“ä¸­ä¸å­˜ åœ¨ç›¸åº”çš„æ•°æ®è¡¨ï¼Œåˆ™å¿½ç•¥åˆ é™¤è¯­å¥ï¼Œä¸å†æ‰§è¡Œåˆ é™¤æ•°æ®è¡¨çš„æ“ä½œã€‚</p><p>ä¸¾ä¾‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DROP TABLE dept80;</span><br></pre></td></tr></table></figure><ul><li>DROP TABLE è¯­å¥ä¸èƒ½å›æ»š</li></ul><h2 id="6-æ¸…ç©ºè¡¨"><a href="#6-æ¸…ç©ºè¡¨" class="headerlink" title="6. æ¸…ç©ºè¡¨"></a>6. æ¸…ç©ºè¡¨</h2><ul><li>TRUNCATE TABLEè¯­å¥ï¼š<ul><li>åˆ é™¤è¡¨ä¸­æ‰€æœ‰çš„æ•°æ®</li><li>é‡Šæ”¾è¡¨çš„å­˜å‚¨ç©ºé—´</li></ul></li><li>ä¸¾ä¾‹ï¼š</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TRUNCATE TABLE detail_dept;</span><br></pre></td></tr></table></figure><ul><li>TRUNCATEè¯­å¥ä¸èƒ½å›æ»šï¼Œè€Œä½¿ç”¨ DELETE è¯­å¥åˆ é™¤æ•°æ®ï¼Œå¯ä»¥å›æ»š</li></ul><blockquote><p>é˜¿é‡Œå¼€å‘è§„èŒƒï¼š ã€å‚è€ƒã€‘TRUNCATE TABLE æ¯” DELETE é€Ÿåº¦å¿«ï¼Œä¸”ä½¿ç”¨çš„ç³»ç»Ÿå’Œäº‹åŠ¡æ—¥å¿—èµ„æºå°‘ï¼Œä½† TRUNCATE æ—  äº‹åŠ¡ä¸”ä¸è§¦å‘ TRIGGERï¼Œæœ‰å¯èƒ½é€ æˆäº‹æ•…ï¼Œæ•…ä¸å»ºè®®åœ¨å¼€å‘ä»£ç ä¸­ä½¿ç”¨æ­¤è¯­å¥ã€‚ è¯´æ˜ï¼šTRUNCATE TABLE åœ¨åŠŸèƒ½ä¸Šä¸ä¸å¸¦ WHERE å­å¥çš„ DELETE è¯­å¥ç›¸åŒã€‚</p></blockquote><h2 id="7-å†…å®¹æ‰©å±•"><a href="#7-å†…å®¹æ‰©å±•" class="headerlink" title="7. å†…å®¹æ‰©å±•"></a>7. å†…å®¹æ‰©å±•</h2><h3 id="æ‹“å±•1ï¼šé˜¿é‡Œå·´å·´ã€ŠJavaå¼€å‘æ‰‹å†Œã€‹ä¹‹MySQLå­—æ®µå‘½å"><a href="#æ‹“å±•1ï¼šé˜¿é‡Œå·´å·´ã€ŠJavaå¼€å‘æ‰‹å†Œã€‹ä¹‹MySQLå­—æ®µå‘½å" class="headerlink" title="æ‹“å±•1ï¼šé˜¿é‡Œå·´å·´ã€ŠJavaå¼€å‘æ‰‹å†Œã€‹ä¹‹MySQLå­—æ®µå‘½å"></a>æ‹“å±•1ï¼šé˜¿é‡Œå·´å·´ã€ŠJavaå¼€å‘æ‰‹å†Œã€‹ä¹‹MySQLå­—æ®µå‘½å</h3><ul><li><p>ã€ å¼ºåˆ¶ ã€‘è¡¨åã€å­—æ®µåå¿…é¡»ä½¿ç”¨å°å†™å­—æ¯æˆ–æ•°å­—ï¼Œç¦æ­¢å‡ºç°æ•°å­—å¼€å¤´ï¼Œç¦æ­¢ä¸¤ä¸ªä¸‹åˆ’çº¿ä¸­é—´åªå‡º ç°æ•°å­—ã€‚æ•°æ®åº“å­—æ®µåçš„ä¿®æ”¹ä»£ä»·å¾ˆå¤§ï¼Œå› ä¸ºæ— æ³•è¿›è¡Œé¢„å‘å¸ƒï¼Œæ‰€ä»¥å­—æ®µåç§°éœ€è¦æ…é‡è€ƒè™‘ã€‚</p><ul><li>æ­£ä¾‹ï¼šaliyun_adminï¼Œrdc_configï¼Œlevel3_name</li><li>åä¾‹ï¼šAliyunAdminï¼ŒrdcConfigï¼Œlevel_3_name</li></ul></li><li><p>ã€ å¼ºåˆ¶ ã€‘ç¦ç”¨ä¿ç•™å­—ï¼Œå¦‚ descã€rangeã€matchã€delayed ç­‰ï¼Œè¯·å‚è€ƒ MySQL å®˜æ–¹ä¿ç•™å­—ã€‚</p></li><li><p>ã€ å¼ºåˆ¶ ã€‘è¡¨å¿…å¤‡ä¸‰å­—æ®µï¼šid, gmt_create, gmt_modifiedã€‚</p><ul><li>è¯´æ˜ï¼šå…¶ä¸­ id å¿…ä¸ºä¸»é”®ï¼Œç±»å‹ä¸ºBIGINT UNSIGNEDã€å•è¡¨æ—¶è‡ªå¢ã€æ­¥é•¿ä¸º 1ã€‚gmt_create, gmt_modified çš„ç±»å‹å‡ä¸º DATETIME ç±»å‹ï¼Œå‰è€…ç°åœ¨æ—¶è¡¨ç¤ºä¸»åŠ¨å¼åˆ›å»ºï¼Œåè€…è¿‡å»åˆ†è¯è¡¨ç¤ºè¢« åŠ¨å¼æ›´æ–°</li></ul></li><li><p>ã€ æ¨è ã€‘è¡¨çš„å‘½åæœ€å¥½æ˜¯éµå¾ª â€œä¸šåŠ¡åç§°_è¡¨çš„ä½œç”¨â€ã€‚</p><ul><li>æ­£ä¾‹ï¼šalipay_task ã€ force_projectã€ trade_config</li></ul></li><li><p>ã€ æ¨è ã€‘åº“åä¸åº”ç”¨åç§°å°½é‡ä¸€è‡´ã€‚</p></li><li><p>ã€å‚è€ƒã€‘åˆé€‚çš„å­—ç¬¦å­˜å‚¨é•¿åº¦ï¼Œä¸ä½†èŠ‚çº¦æ•°æ®åº“è¡¨ç©ºé—´ã€èŠ‚çº¦ç´¢å¼•å­˜å‚¨ï¼Œæ›´é‡è¦çš„æ˜¯æå‡æ£€ç´¢é€Ÿåº¦ã€‚</p><ul><li>æ­£ä¾‹ï¼šæ— ç¬¦å·å€¼å¯ä»¥é¿å…è¯¯å­˜è´Ÿæ•°ï¼Œä¸”æ‰©å¤§äº†è¡¨ç¤ºèŒƒå›´ã€‚</li></ul></li></ul><h3 id="æ‰©å±•2ï¼šæ“ä½œæ³¨æ„è¦æ±‚"><a href="#æ‰©å±•2ï¼šæ“ä½œæ³¨æ„è¦æ±‚" class="headerlink" title="æ‰©å±•2ï¼šæ“ä½œæ³¨æ„è¦æ±‚"></a>æ‰©å±•2ï¼šæ“ä½œæ³¨æ„è¦æ±‚</h3><ul><li>è¡¨åˆ é™¤ æ“ä½œå°†æŠŠè¡¨çš„å®šä¹‰å’Œè¡¨ä¸­çš„æ•°æ®ä¸€èµ·åˆ é™¤ï¼Œå¹¶ä¸”MySQLåœ¨æ‰§è¡Œåˆ é™¤æ“ä½œæ—¶ï¼Œä¸ä¼šæœ‰ä»»ä½•çš„ç¡®è®¤ä¿¡ æ¯æç¤ºï¼Œå› æ­¤æ‰§è¡Œåˆ é™¤æ“æ—¶åº”å½“æ…é‡ã€‚åœ¨åˆ é™¤è¡¨å‰ï¼Œæœ€å¥½å¯¹è¡¨ä¸­çš„æ•°æ®è¿›è¡Œ å¤‡ä»½ ï¼Œè¿™æ ·å½“æ“ä½œå¤±è¯¯æ—¶å¯ ä»¥å¯¹æ•°æ®è¿›è¡Œæ¢å¤ï¼Œä»¥å…é€ æˆæ— æ³•æŒ½å›çš„åæœã€‚</li><li>åŒæ ·çš„ï¼Œåœ¨ä½¿ç”¨ ALTER TABLE è¿›è¡Œè¡¨çš„åŸºæœ¬ä¿®æ”¹æ“ä½œæ—¶ï¼Œåœ¨æ‰§è¡Œæ“ä½œè¿‡ç¨‹ä¹‹å‰ï¼Œä¹Ÿåº”è¯¥ç¡®ä¿å¯¹æ•°æ®è¿› è¡Œå®Œæ•´çš„ å¤‡ä»½ ï¼Œå› ä¸ºæ•°æ®åº“çš„æ”¹å˜æ˜¯ æ— æ³•æ’¤é”€ çš„ï¼Œå¦‚æœæ·»åŠ äº†ä¸€ä¸ªä¸éœ€è¦çš„å­—æ®µï¼Œå¯ä»¥å°†å…¶åˆ é™¤ï¼›ç›¸ åŒçš„ï¼Œå¦‚æœåˆ é™¤äº†ä¸€ä¸ªéœ€è¦çš„åˆ—ï¼Œè¯¥åˆ—ä¸‹é¢çš„æ‰€æœ‰æ•°æ®éƒ½å°†ä¼šä¸¢å¤±ã€‚</li></ul><h3 id="æ‰©å±•3ï¼šMySQL8æ–°ç‰¹æ€§â€”DDLçš„åŸå­åŒ–"><a href="#æ‰©å±•3ï¼šMySQL8æ–°ç‰¹æ€§â€”DDLçš„åŸå­åŒ–" class="headerlink" title="æ‰©å±•3ï¼šMySQL8æ–°ç‰¹æ€§â€”DDLçš„åŸå­åŒ–"></a>æ‰©å±•3ï¼šMySQL8æ–°ç‰¹æ€§â€”DDLçš„åŸå­åŒ–</h3><p>åœ¨MySQL 8.0ç‰ˆæœ¬ä¸­ï¼ŒInnoDBè¡¨çš„DDLæ”¯æŒäº‹åŠ¡å®Œæ•´æ€§ï¼Œå³ DDLæ“ä½œè¦ä¹ˆæˆåŠŸè¦ä¹ˆå›æ»š ã€‚DDLæ“ä½œå›æ»šæ—¥å¿— å†™å…¥åˆ°data dictionaryæ•°æ®å­—å…¸è¡¨mysql.innodb_ddl_logï¼ˆè¯¥è¡¨æ˜¯éšè—çš„è¡¨ï¼Œé€šè¿‡show tablesæ— æ³•çœ‹åˆ°ï¼‰ ä¸­ï¼Œç”¨äºå›æ»šæ“ä½œã€‚é€šè¿‡è®¾ç½®å‚æ•°ï¼Œå¯å°†DDLæ“ä½œæ—¥å¿—æ‰“å°è¾“å‡ºåˆ°MySQLé”™è¯¯æ—¥å¿—ä¸­ã€‚</p><h1 id="ç¬¬11ç« -æ•°æ®å¤„ç†ä¹‹å¢åˆ æ”¹"><a href="#ç¬¬11ç« -æ•°æ®å¤„ç†ä¹‹å¢åˆ æ”¹" class="headerlink" title="ç¬¬11ç« _æ•°æ®å¤„ç†ä¹‹å¢åˆ æ”¹"></a>ç¬¬11ç« _æ•°æ®å¤„ç†ä¹‹å¢åˆ æ”¹</h1><h2 id="1-æ’å…¥æ•°æ®"><a href="#1-æ’å…¥æ•°æ®" class="headerlink" title="1. æ’å…¥æ•°æ®"></a>1. æ’å…¥æ•°æ®</h2><h3 id="1-æ–¹å¼1ï¼šVALUESçš„æ–¹å¼æ·»åŠ "><a href="#1-æ–¹å¼1ï¼šVALUESçš„æ–¹å¼æ·»åŠ " class="headerlink" title="1) æ–¹å¼1ï¼šVALUESçš„æ–¹å¼æ·»åŠ "></a>1) æ–¹å¼1ï¼šVALUESçš„æ–¹å¼æ·»åŠ </h3><p>ä½¿ç”¨è¿™ç§è¯­æ³•ä¸€æ¬¡åªèƒ½å‘è¡¨ä¸­æ’å…¥ä¸€æ¡æ•°æ®ã€‚</p><p><strong>æƒ…å†µ1ï¼šä¸ºè¡¨çš„æ‰€æœ‰å­—æ®µæŒ‰é»˜è®¤é¡ºåºæ’å…¥æ•°æ®</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO è¡¨å</span><br><span class="line">VALUES (value1,value2,....);</span><br></pre></td></tr></table></figure><p>å€¼åˆ—è¡¨ä¸­éœ€è¦ä¸ºè¡¨çš„æ¯ä¸€ä¸ªå­—æ®µæŒ‡å®šå€¼ï¼Œå¹¶ä¸”å€¼çš„é¡ºåºå¿…é¡»å’Œæ•°æ®è¡¨ä¸­å­—æ®µå®šä¹‰æ—¶çš„é¡ºåºç›¸åŒã€‚</p><p>ä¸¾ä¾‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO departments</span><br><span class="line">VALUES (70, &#x27;Pub&#x27;, 100, 1700);</span><br></pre></td></tr></table></figure><p><strong>æƒ…å†µ2: æŒ‡å®šå­—æ®µåæ’å…¥æ•°æ®</strong></p><p>ä¸ºè¡¨çš„æŒ‡å®šå­—æ®µæ’å…¥æ•°æ®ï¼Œå°±æ˜¯åœ¨INSERTè¯­å¥ä¸­åªå‘éƒ¨åˆ†å­—æ®µä¸­æ’å…¥å€¼ï¼Œè€Œå…¶ä»–å­—æ®µçš„å€¼ä¸ºè¡¨å®šä¹‰æ—¶çš„ é»˜è®¤å€¼ã€‚ åœ¨ INSERT å­å¥ä¸­éšæ„åˆ—å‡ºåˆ—åï¼Œä½†æ˜¯ä¸€æ—¦åˆ—å‡ºï¼ŒVALUESä¸­è¦æ’å…¥çš„value1,â€¦.valuenéœ€è¦ä¸ column1,â€¦columnnåˆ—ä¸€ä¸€å¯¹åº”ã€‚å¦‚æœç±»å‹ä¸åŒï¼Œå°†æ— æ³•æ’å…¥ï¼Œå¹¶ä¸”MySQLä¼šäº§ç”Ÿé”™è¯¯ã€‚ </p><p>ä¸¾ä¾‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO departments(department_id, department_name)</span><br><span class="line">VALUES (80, &#x27;IT&#x27;);</span><br></pre></td></tr></table></figure><p><strong>æƒ…å†µ3ï¼šåŒæ—¶æ’å…¥å¤šæ¡è®°å½•</strong></p><p>INSERTè¯­å¥å¯ä»¥åŒæ—¶å‘æ•°æ®è¡¨ä¸­æ’å…¥å¤šæ¡è®°å½•ï¼Œæ’å…¥æ—¶æŒ‡å®šå¤šä¸ªå€¼åˆ—è¡¨ï¼Œæ¯ä¸ªå€¼åˆ—è¡¨ä¹‹é—´ç”¨é€—å·åˆ†éš” å¼€ï¼ŒåŸºæœ¬è¯­æ³•æ ¼å¼å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO table_name</span><br><span class="line">VALUES</span><br><span class="line">(value1 [,value2, â€¦, valuen]),</span><br><span class="line">(value1 [,value2, â€¦, valuen]),</span><br><span class="line">â€¦â€¦</span><br><span class="line">(value1 [,value2, â€¦, valuen]);</span><br></pre></td></tr></table></figure><p>æˆ–è€…</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO table_name(column1 [, column2, â€¦, columnn])</span><br><span class="line">VALUES</span><br><span class="line">(value1 [,value2, â€¦, valuen]),</span><br><span class="line">(value1 [,value2, â€¦, valuen]),</span><br><span class="line">â€¦â€¦</span><br><span class="line">(value1 [,value2, â€¦, valuen]);</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨INSERTåŒæ—¶æ’å…¥å¤šæ¡è®°å½•æ—¶ï¼ŒMySQLä¼šè¿”å›ä¸€äº›åœ¨æ‰§è¡Œå•è¡Œæ’å…¥æ—¶æ²¡æœ‰çš„é¢å¤–ä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯çš„å« ä¹‰å¦‚ä¸‹ï¼š</p><ul><li>Recordsï¼šè¡¨æ˜æ’å…¥çš„è®°å½•æ¡æ•°ã€‚ </li><li>Duplicatesï¼šè¡¨æ˜æ’å…¥æ—¶è¢«å¿½ç•¥çš„è®°å½•ï¼ŒåŸå› å¯èƒ½æ˜¯è¿™ äº›è®°å½•åŒ…å«äº†é‡å¤çš„ä¸»é”®å€¼ã€‚ </li><li>Warningsï¼šè¡¨æ˜æœ‰é—®é¢˜çš„æ•°æ®å€¼ï¼Œä¾‹å¦‚å‘ç”Ÿæ•°æ®ç±»å‹è½¬æ¢ã€‚</li></ul><blockquote><p>ä¸€ä¸ªåŒæ—¶æ’å…¥å¤šè¡Œè®°å½•çš„INSERTè¯­å¥ç­‰åŒäºå¤šä¸ªå•è¡Œæ’å…¥çš„INSERTè¯­å¥ï¼Œä½†æ˜¯å¤šè¡Œçš„INSERTè¯­å¥ åœ¨å¤„ç†è¿‡ç¨‹ä¸­ æ•ˆç‡æ›´é«˜ ã€‚å› ä¸ºMySQLæ‰§è¡Œå•æ¡INSERTè¯­å¥æ’å…¥å¤šè¡Œæ•°æ®æ¯”ä½¿ç”¨å¤šæ¡INSERTè¯­å¥ å¿«ï¼Œæ‰€ä»¥åœ¨æ’å…¥å¤šæ¡è®°å½•æ—¶æœ€å¥½é€‰æ‹©ä½¿ç”¨å•æ¡INSERTè¯­å¥çš„æ–¹å¼æ’å…¥ã€‚</p></blockquote><h3 id="2-æ–¹å¼2ï¼šå°†æŸ¥è¯¢ç»“æœæ’å…¥åˆ°è¡¨ä¸­"><a href="#2-æ–¹å¼2ï¼šå°†æŸ¥è¯¢ç»“æœæ’å…¥åˆ°è¡¨ä¸­" class="headerlink" title="2) æ–¹å¼2ï¼šå°†æŸ¥è¯¢ç»“æœæ’å…¥åˆ°è¡¨ä¸­"></a>2) æ–¹å¼2ï¼šå°†æŸ¥è¯¢ç»“æœæ’å…¥åˆ°è¡¨ä¸­</h3><p>INSERTè¿˜å¯ä»¥å°†SELECTè¯­å¥æŸ¥è¯¢çš„ç»“æœæ’å…¥åˆ°è¡¨ä¸­ï¼Œæ­¤æ—¶ä¸éœ€è¦æŠŠæ¯ä¸€æ¡è®°å½•çš„å€¼ä¸€ä¸ªä¸€ä¸ªè¾“å…¥ï¼Œåªéœ€è¦ä½¿ç”¨ä¸€æ¡INSERTè¯­å¥å’Œä¸€æ¡SELECTè¯­å¥ç»„æˆçš„ç»„åˆè¯­å¥å³å¯å¿«é€Ÿåœ°ä»ä¸€ä¸ªæˆ–å¤šä¸ªè¡¨ä¸­å‘ä¸€ä¸ªè¡¨ä¸­æ’å…¥å¤šè¡Œ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">INSET INTO ç›®æ ‡è¡¨å</span><br><span class="line">(tar_column1 [, tar_column2, ..., tar_columnn])</span><br><span class="line">SELECT</span><br><span class="line">(src_column1 [, src_column2, â€¦, src_columnn])</span><br><span class="line">FROM æºè¡¨å</span><br><span class="line">[WHERE condition]</span><br></pre></td></tr></table></figure><ul><li>åœ¨ INSERT è¯­å¥ä¸­åŠ å…¥å­æŸ¥è¯¢ã€‚ </li><li>ä¸å¿…ä¹¦å†™ VALUES å­å¥ã€‚ </li><li>å­æŸ¥è¯¢ä¸­çš„å€¼åˆ—è¡¨åº”ä¸ INSERT å­å¥ä¸­çš„åˆ—åå¯¹åº”ã€‚</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO emp2</span><br><span class="line">SELECT *</span><br><span class="line">FROM employees</span><br><span class="line">WHERE department_id = 90;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO sales_reps(id, name, salary, commission_pct)</span><br><span class="line">SELECT employee_id, last_name, salary, commission_pct</span><br><span class="line">FROM employees</span><br><span class="line">WHERE job_id LIKE &#x27;%REP%&#x27;;</span><br></pre></td></tr></table></figure><h2 id="2-æ›´æ–°æ•°æ®"><a href="#2-æ›´æ–°æ•°æ®" class="headerlink" title="2. æ›´æ–°æ•°æ®"></a>2. æ›´æ–°æ•°æ®</h2><ul><li>ä½¿ç”¨ UPDATE è¯­å¥æ›´æ–°æ•°æ®ã€‚è¯­æ³•å¦‚ä¸‹ï¼š</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">UPDATE table_name</span><br><span class="line">SET column1=value1, column2=value2, ..., column=valuen</span><br><span class="line">[WHERE condition]</span><br></pre></td></tr></table></figure><ul><li><p>å¯ä»¥ä¸€æ¬¡æ›´æ–°å¤šæ¡æ•°æ®ã€‚</p></li><li><p>å¦‚æœéœ€è¦å›æ»šæ•°æ®ï¼Œéœ€è¦ä¿è¯åœ¨DMLå‰ï¼Œè¿›è¡Œè®¾ç½®ï¼šSET AUTOCOMMIT &#x3D; FALSE;</p></li><li><p>ä½¿ç”¨ WHERE å­å¥æŒ‡å®šéœ€è¦æ›´æ–°çš„æ•°æ®ã€‚</p></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">UPDATE employees</span><br><span class="line">SET department_id = 70</span><br><span class="line">WHERE employee_id = 113;</span><br></pre></td></tr></table></figure><ul><li>å¦‚æœçœç•¥ WHERE å­å¥ï¼Œåˆ™è¡¨ä¸­çš„æ‰€æœ‰æ•°æ®éƒ½å°†è¢«æ›´æ–°ã€‚</li></ul><h2 id="3-åˆ é™¤æ•°æ®"><a href="#3-åˆ é™¤æ•°æ®" class="headerlink" title="3. åˆ é™¤æ•°æ®"></a>3. åˆ é™¤æ•°æ®</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DELETE FROM table_name [WHERE &lt;condition&gt;];</span><br></pre></td></tr></table></figure><p>table_nameæŒ‡å®šè¦æ‰§è¡Œåˆ é™¤æ“ä½œçš„è¡¨ï¼›â€œ[WHERE ]â€ä¸ºå¯é€‰å‚æ•°ï¼ŒæŒ‡å®šåˆ é™¤æ¡ä»¶ï¼Œå¦‚æœæ²¡æœ‰WHEREå­å¥ï¼Œ DELETEè¯­å¥å°†åˆ é™¤è¡¨ä¸­çš„æ‰€æœ‰è®°å½•ã€‚</p><h2 id="4-MySQL8æ–°ç‰¹æ€§ï¼šè®¡ç®—åˆ—"><a href="#4-MySQL8æ–°ç‰¹æ€§ï¼šè®¡ç®—åˆ—" class="headerlink" title="4. MySQL8æ–°ç‰¹æ€§ï¼šè®¡ç®—åˆ—"></a>4. MySQL8æ–°ç‰¹æ€§ï¼šè®¡ç®—åˆ—</h2><p>ä»€ä¹ˆå«è®¡ç®—åˆ—å‘¢ï¼Ÿç®€å•æ¥è¯´å°±æ˜¯æŸä¸€åˆ—çš„å€¼æ˜¯é€šè¿‡åˆ«çš„åˆ—è®¡ç®—å¾—æ¥çš„ã€‚ä¾‹å¦‚ï¼Œaåˆ—å€¼ä¸º1ã€båˆ—å€¼ä¸º2ï¼Œcåˆ— ä¸éœ€è¦æ‰‹åŠ¨æ’å…¥ï¼Œå®šä¹‰a+bçš„ç»“æœä¸ºcçš„å€¼ï¼Œé‚£ä¹ˆcå°±æ˜¯è®¡ç®—åˆ—ï¼Œæ˜¯é€šè¿‡åˆ«çš„åˆ—è®¡ç®—å¾—æ¥çš„ã€‚</p><p>åœ¨MySQL 8.0ä¸­ï¼ŒCREATE TABLE å’Œ ALTER TABLE ä¸­éƒ½æ”¯æŒå¢åŠ è®¡ç®—åˆ—ã€‚ä¸‹é¢ä»¥CREATE TABLEä¸ºä¾‹è¿›è¡Œè®²è§£ã€‚</p><p>ä¸¾ä¾‹ï¼šå®šä¹‰æ•°æ®è¡¨tb1ï¼Œç„¶åå®šä¹‰å­—æ®µidã€å­—æ®µaã€å­—æ®µbå’Œå­—æ®µcï¼Œå…¶ä¸­å­—æ®µcä¸ºè®¡ç®—åˆ—ï¼Œç”¨äºè®¡ç®—a+bçš„ å€¼ã€‚ é¦–å…ˆåˆ›å»ºæµ‹è¯•è¡¨tb1ï¼Œè¯­å¥å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE tb1(</span><br><span class="line">id INT,</span><br><span class="line">a INT,</span><br><span class="line">b INT,</span><br><span class="line">c INT GENERATED ALWAYS AS (a + b) VIRTUAL</span><br><span class="line">);</span><br></pre></td></tr></table></figure><h1 id="ç¬¬12ç« -MySQLæ•°æ®ç±»å‹ç²¾è®²"><a href="#ç¬¬12ç« -MySQLæ•°æ®ç±»å‹ç²¾è®²" class="headerlink" title="ç¬¬12ç« _MySQLæ•°æ®ç±»å‹ç²¾è®²"></a>ç¬¬12ç« _MySQLæ•°æ®ç±»å‹ç²¾è®²</h1><h2 id="1-MySQLä¸­çš„æ•°æ®ç±»å‹"><a href="#1-MySQLä¸­çš„æ•°æ®ç±»å‹" class="headerlink" title="1. MySQLä¸­çš„æ•°æ®ç±»å‹"></a>1. MySQLä¸­çš„æ•°æ®ç±»å‹</h2><table><thead><tr><th>ç±»å‹</th><th>ä¸¾ä¾‹</th></tr></thead><tbody><tr><td>æ•´æ•°ç±»å‹</td><td>TINYINTã€SMALLINTã€MEDIUMINTã€INT(æˆ–INTEGER)ã€BIGINT</td></tr><tr><td>æµ®ç‚¹ç±»å‹</td><td>FLOATã€DOUBLE</td></tr><tr><td>å®šç‚¹æ•°ç±»å‹</td><td>DECIMAL</td></tr><tr><td>ä½ç±»å‹</td><td>BIT</td></tr><tr><td>æ—¥æœŸæ—¶é—´ç±»å‹</td><td>YEARã€TIMEã€DATEã€DATETIMEã€TIMESTAMP</td></tr><tr><td>æ–‡æœ¬å­—ç¬¦ä¸²ç±»å‹</td><td>CHARã€VARCHARã€TINYTEXTã€TEXTã€MEDIUMTEXTã€LONGTEXT</td></tr><tr><td>æšä¸¾ç±»å‹</td><td>ENUM</td></tr><tr><td>é›†åˆç±»å‹</td><td>SET</td></tr><tr><td>äºŒè¿›åˆ¶å­—ç¬¦ä¸²ç±»å‹</td><td>BINARYã€VARBINARYã€TINYBLOBã€BLOBã€MEDIUMBLOBã€LONGBLOB</td></tr><tr><td>JSONç±»å‹</td><td>JSONå¯¹è±¡ã€JSONæ•°ç»„</td></tr><tr><td>ç©ºé—´æ•°æ®ç±»å‹</td><td>å•å€¼ç±»å‹ï¼šGEOMETRYã€POINTã€LINESTRINGã€POLYGONï¼› é›†åˆç±»å‹ï¼šMULTIPOINTã€MULTILINESTRINGã€MULTIPOLYGONã€ GEOMETRYCOLLECTION</td></tr></tbody></table><p>å¸¸è§æ•°æ®ç±»å‹çš„å±æ€§ï¼Œå¦‚ä¸‹ï¼š</p><table><thead><tr><th>MySQLå…³é”®å­—</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>NULL</td><td>TINYINTã€SMALLINTã€MEDIUMINTã€INT(æˆ–INTEGER)ã€BIGINT</td></tr><tr><td>NOT NULL</td><td>FLOATã€DOUBLE</td></tr><tr><td>DEFAULT</td><td>DECIMAL</td></tr><tr><td>PRIMARY KEY</td><td>BIT</td></tr><tr><td>AUTO_INCREMENT</td><td>YEARã€TIMEã€DATEã€DATETIMEã€TIMESTAMP</td></tr><tr><td>UNSIGNED</td><td>CHARã€VARCHARã€TINYTEXTã€TEXTã€MEDIUMTEXTã€LONGTEXT</td></tr><tr><td>CHARACTER SET name</td><td>ENUM</td></tr></tbody></table><h2 id="2-æ•´æ•°ç±»å‹"><a href="#2-æ•´æ•°ç±»å‹" class="headerlink" title="2. æ•´æ•°ç±»å‹"></a>2. æ•´æ•°ç±»å‹</h2><h3 id="1-ç±»å‹ä»‹ç»"><a href="#1-ç±»å‹ä»‹ç»" class="headerlink" title="1) ç±»å‹ä»‹ç»"></a>1) ç±»å‹ä»‹ç»</h3><p>æ•´æ•°ç±»å‹ä¸€å…±æœ‰ 5 ç§ï¼ŒåŒ…æ‹¬ TINYINTã€SMALLINTã€MEDIUMINTã€INTï¼ˆINTEGERï¼‰å’Œ BIGINTã€‚ </p><p>å®ƒä»¬çš„åŒºåˆ«å¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š</p><table><thead><tr><th>æ•´æ•°ç±»å‹</th><th>å­—èŠ‚</th><th>æœ‰ç¬¦å·æ•°å–å€¼èŒƒå›´</th><th>æ— ç¬¦å·æ•°å–å€¼èŒƒå›´</th></tr></thead><tbody><tr><td>TINYINT</td><td>1</td><td>-128~127</td><td>0~255</td></tr><tr><td>SMALLINT</td><td>2</td><td>-32768~32767</td><td>0~65535</td></tr><tr><td>MEDIUMINT</td><td>3</td><td>-8388608~8388607</td><td>0~16777215</td></tr><tr><td>INTã€INTEGER</td><td>4</td><td>-2147483648~2147483647</td><td>0~4294967295</td></tr><tr><td>BIGINT</td><td>8</td><td>-9223372036854775808~9223372036854775807</td><td>0~18446744073709551615</td></tr></tbody></table><h3 id="2-å¯é€‰å±æ€§"><a href="#2-å¯é€‰å±æ€§" class="headerlink" title="2) å¯é€‰å±æ€§"></a>2) å¯é€‰å±æ€§</h3><p>æ•´æ•°ç±»å‹çš„å¯é€‰å±æ€§æœ‰ä¸‰ä¸ªï¼š</p><ul><li>M</li></ul><p>M : è¡¨ç¤ºæ˜¾ç¤ºå®½åº¦ï¼ŒMçš„å–å€¼èŒƒå›´æ˜¯(0, 255)ã€‚ä¾‹å¦‚ï¼Œint(5)ï¼šå½“æ•°æ®å®½åº¦å°äº5ä½çš„æ—¶å€™åœ¨æ•°å­—å‰é¢éœ€è¦ç”¨ å­—ç¬¦å¡«æ»¡å®½åº¦ã€‚è¯¥é¡¹åŠŸèƒ½éœ€è¦é…åˆâ€œ ZEROFILL â€ä½¿ç”¨ï¼Œè¡¨ç¤ºç”¨â€œ0â€å¡«æ»¡å®½åº¦ï¼Œå¦åˆ™æŒ‡å®šæ˜¾ç¤ºå®½åº¦æ— æ•ˆã€‚ å¦‚æœè®¾ç½®äº†æ˜¾ç¤ºå®½åº¦ï¼Œé‚£ä¹ˆæ’å…¥çš„æ•°æ®å®½åº¦è¶…è¿‡æ˜¾ç¤ºå®½åº¦é™åˆ¶ï¼Œä¼šä¸ä¼šæˆªæ–­æˆ–æ’å…¥å¤±è´¥ï¼Ÿ </p><p>ç­”æ¡ˆï¼šä¸ä¼šå¯¹æ’å…¥çš„æ•°æ®æœ‰ä»»ä½•å½±å“ï¼Œè¿˜æ˜¯æŒ‰ç…§ç±»å‹çš„å®é™…å®½åº¦è¿›è¡Œä¿å­˜ï¼Œå³ æ˜¾ç¤ºå®½åº¦ä¸ç±»å‹å¯ä»¥å­˜å‚¨çš„ å€¼èŒƒå›´æ— å…³ ã€‚ä»MySQL 8.0.17å¼€å§‹ï¼Œæ•´æ•°æ•°æ®ç±»å‹ä¸æ¨èä½¿ç”¨æ˜¾ç¤ºå®½åº¦å±æ€§ã€‚ æ•´å‹æ•°æ®ç±»å‹å¯ä»¥åœ¨å®šä¹‰è¡¨ç»“æ„æ—¶æŒ‡å®šæ‰€éœ€è¦çš„æ˜¾ç¤ºå®½åº¦ï¼Œå¦‚æœä¸æŒ‡å®šï¼Œåˆ™ç³»ç»Ÿä¸ºæ¯ä¸€ç§ç±»å‹æŒ‡å®šé»˜è®¤ çš„å®½åº¦å€¼ã€‚</p><p>ä¸¾ä¾‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE test_int1 ( x TINYINT, y SMALLINT, z MEDIUMINT, m INT, n BIGINT );</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹è¡¨ç»“æ„ ï¼ˆMySQL5.7ä¸­æ˜¾å¼å¦‚ä¸‹ï¼ŒMySQL8ä¸­ä¸å†æ˜¾å¼èŒƒå›´ï¼‰</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; desc test_int1;</span><br><span class="line">+-------+--------------+------+-----+---------+-------+</span><br><span class="line">| Field | Type | Null | Key | Default | Extra |</span><br><span class="line">+-------+--------------+------+-----+---------+-------+</span><br><span class="line">| x | tinyint(4) | YES | | NULL | |</span><br><span class="line">| y | smallint(6) | YES | | NULL | |</span><br><span class="line">| z | mediumint(9) | YES | | NULL | |</span><br><span class="line">| m | int(11) | YES | | NULL | |</span><br><span class="line">| n | bigint(20) | YES | | NULL | |</span><br><span class="line">+-------+--------------+------+-----+---------+-------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><p>TINYINTæœ‰ç¬¦å·æ•°å’Œæ— ç¬¦å·æ•°çš„å–å€¼èŒƒå›´åˆ†åˆ«ä¸º-128~127å’Œ0~255ï¼Œç”±äºè´Ÿå·å äº†ä¸€ä¸ªæ•°å­—ä½ï¼Œå› æ­¤ TINYINTé»˜è®¤çš„æ˜¾ç¤ºå®½åº¦ä¸º4ã€‚åŒç†ï¼Œå…¶ä»–æ•´æ•°ç±»å‹çš„é»˜è®¤æ˜¾ç¤ºå®½åº¦ä¸å…¶æœ‰ç¬¦å·æ•°çš„æœ€å°å€¼çš„å®½åº¦ç›¸åŒã€‚</p><ul><li>UNSIGNED</li></ul><p>UNSIGNED : æ— ç¬¦å·ç±»å‹ï¼ˆéè´Ÿï¼‰ï¼Œæ‰€æœ‰çš„æ•´æ•°ç±»å‹éƒ½æœ‰ä¸€ä¸ªå¯é€‰çš„å±æ€§UNSIGNEDï¼ˆæ— ç¬¦å·å±æ€§ï¼‰ï¼Œæ—  ç¬¦å·æ•´æ•°ç±»å‹çš„æœ€å°å–å€¼ä¸º0ã€‚æ‰€ä»¥ï¼Œå¦‚æœéœ€è¦åœ¨MySQLæ•°æ®åº“ä¸­ä¿å­˜éè´Ÿæ•´æ•°å€¼æ—¶ï¼Œå¯ä»¥å°†æ•´æ•°ç±»å‹è®¾ ç½®ä¸ºæ— ç¬¦å·ç±»å‹ã€‚ intç±»å‹é»˜è®¤æ˜¾ç¤ºå®½åº¦ä¸ºint(11)ï¼Œæ— ç¬¦å·intç±»å‹é»˜è®¤æ˜¾ç¤ºå®½åº¦ä¸ºint(10)ã€‚</p><ul><li>ZEROFILL</li></ul><p>ZEROFILL : 0å¡«å……,ï¼ˆå¦‚æœæŸåˆ—æ˜¯ZEROFILLï¼Œé‚£ä¹ˆMySQLä¼šè‡ªåŠ¨ä¸ºå½“å‰åˆ—æ·»åŠ UNSIGNEDå±æ€§ï¼‰ï¼Œå¦‚æœæŒ‡ å®šäº†ZEROFILLåªæ˜¯è¡¨ç¤ºä¸å¤ŸMä½æ—¶ï¼Œç”¨0åœ¨å·¦è¾¹å¡«å……ï¼Œå¦‚æœè¶…è¿‡Mä½ï¼Œåªè¦ä¸è¶…è¿‡æ•°æ®å­˜å‚¨èŒƒå›´å³å¯ã€‚ </p><p>åŸæ¥ï¼Œåœ¨ int(M) ä¸­ï¼ŒM çš„å€¼è·Ÿ int(M) æ‰€å å¤šå°‘å­˜å‚¨ç©ºé—´å¹¶æ— ä»»ä½•å…³ç³»ã€‚ int(3)ã€int(4)ã€int(8) åœ¨ç£ç›˜ä¸Šéƒ½ æ˜¯å ç”¨ 4 bytes çš„å­˜å‚¨ç©ºé—´ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œint(M)ï¼Œå¿…é¡»å’ŒUNSIGNED ZEROFILLä¸€èµ·ä½¿ç”¨æ‰æœ‰æ„ä¹‰ã€‚å¦‚æœæ•´ æ•°å€¼è¶…è¿‡Mä½ï¼Œå°±æŒ‰ç…§å®é™…ä½æ•°å­˜å‚¨ã€‚åªæ˜¯æ— é¡»å†ç”¨å­—ç¬¦ 0 è¿›è¡Œå¡«å……ã€‚</p><h3 id="3-é€‚ç”¨åœºæ™¯"><a href="#3-é€‚ç”¨åœºæ™¯" class="headerlink" title="3) é€‚ç”¨åœºæ™¯"></a>3) é€‚ç”¨åœºæ™¯</h3><p>TINYINT ï¼šä¸€èˆ¬ç”¨äºæšä¸¾æ•°æ®ï¼Œæ¯”å¦‚ç³»ç»Ÿè®¾å®šå–å€¼èŒƒå›´å¾ˆå°ä¸”å›ºå®šçš„åœºæ™¯ã€‚ </p><p>SMALLINT ï¼šå¯ä»¥ç”¨äºè¾ƒå°èŒƒå›´çš„ç»Ÿè®¡æ•°æ®ï¼Œæ¯”å¦‚ç»Ÿè®¡å·¥å‚çš„å›ºå®šèµ„äº§åº“å­˜æ•°é‡ç­‰ã€‚ </p><p>MEDIUMINT ï¼šç”¨äºè¾ƒå¤§æ•´æ•°çš„è®¡ç®—ï¼Œæ¯”å¦‚è½¦ç«™æ¯æ—¥çš„å®¢æµé‡ç­‰ã€‚ </p><p>INTã€INTEGER ï¼šå–å€¼èŒƒå›´è¶³å¤Ÿå¤§ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ä¸ç”¨è€ƒè™‘è¶…é™é—®é¢˜ï¼Œç”¨å¾—æœ€å¤šã€‚æ¯”å¦‚å•†å“ç¼–å·ã€‚ </p><p>BIGINT ï¼šåªæœ‰å½“ä½ å¤„ç†ç‰¹åˆ«å·¨å¤§çš„æ•´æ•°æ—¶æ‰ä¼šç”¨åˆ°ã€‚æ¯”å¦‚åŒåä¸€çš„äº¤æ˜“é‡ã€å¤§å‹é—¨æˆ·ç½‘ç«™ç‚¹å‡»é‡ã€è¯ åˆ¸å…¬å¸è¡ç”Ÿäº§å“æŒä»“ç­‰ã€‚</p><h3 id="4-å¦‚ä½•é€‰æ‹©ï¼Ÿ"><a href="#4-å¦‚ä½•é€‰æ‹©ï¼Ÿ" class="headerlink" title="4) å¦‚ä½•é€‰æ‹©ï¼Ÿ"></a>4) å¦‚ä½•é€‰æ‹©ï¼Ÿ</h3><p>åœ¨è¯„ä¼°ç”¨å“ªç§æ•´æ•°ç±»å‹çš„æ—¶å€™ï¼Œä½ éœ€è¦è€ƒè™‘ å­˜å‚¨ç©ºé—´ å’Œ å¯é æ€§ çš„å¹³è¡¡é—®é¢˜ï¼šä¸€æ–¹ é¢ï¼Œç”¨å ç”¨å­—èŠ‚æ•°å°‘ çš„æ•´æ•°ç±»å‹å¯ä»¥èŠ‚çœå­˜å‚¨ç©ºé—´ï¼›å¦ä¸€æ–¹é¢ï¼Œè¦æ˜¯ä¸ºäº†èŠ‚çœå­˜å‚¨ç©ºé—´ï¼Œ ä½¿ç”¨çš„æ•´æ•°ç±»å‹å–å€¼èŒƒå›´å¤ªå°ï¼Œä¸€ æ—¦é‡åˆ°è¶…å‡ºå–å€¼èŒƒå›´çš„æƒ…å†µï¼Œå°±å¯èƒ½å¼•èµ· ç³»ç»Ÿé”™è¯¯ ï¼Œå½±å“å¯é æ€§ã€‚ </p><p>ä¸¾ä¸ªä¾‹å­ï¼Œå•†å“ç¼–å·é‡‡ç”¨çš„æ•°æ®ç±»å‹æ˜¯ INTã€‚åŸå› å°±åœ¨äºï¼Œå®¢æˆ·é—¨åº—ä¸­æµé€šçš„å•†å“ç§ç±»è¾ƒå¤šï¼Œè€Œä¸”ï¼Œæ¯ å¤©éƒ½æœ‰æ—§å•†å“ä¸‹æ¶ï¼Œæ–°å•†å“ä¸Šæ¶ï¼Œè¿™æ ·ä¸æ–­è¿­ä»£ï¼Œæ—¥ç§¯æœˆç´¯ã€‚ </p><p>å¦‚æœä½¿ç”¨ SMALLINT ç±»å‹ï¼Œè™½ç„¶å ç”¨å­—èŠ‚æ•°æ¯” INT ç±»å‹çš„æ•´æ•°å°‘ï¼Œä½†æ˜¯å´ä¸èƒ½ä¿è¯æ•°æ®ä¸ä¼šè¶…å‡ºèŒƒå›´ 65535ã€‚ç›¸åï¼Œä½¿ç”¨ INTï¼Œå°±èƒ½ç¡®ä¿æœ‰è¶³å¤Ÿå¤§çš„å–å€¼èŒƒå›´ï¼Œä¸ç”¨æ‹…å¿ƒæ•°æ®è¶…å‡ºèŒƒå›´å½±å“å¯é æ€§çš„é—®é¢˜ã€‚ </p><p>ä½ è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨å®é™…å·¥ä½œä¸­ï¼Œç³»ç»Ÿæ•…éšœäº§ç”Ÿçš„æˆæœ¬è¿œè¿œè¶…è¿‡å¢åŠ å‡ ä¸ªå­—æ®µå­˜å‚¨ç©ºé—´æ‰€äº§ç”Ÿçš„æˆæœ¬ã€‚å›  æ­¤ï¼Œæˆ‘å»ºè®®ä½ é¦–å…ˆç¡®ä¿æ•°æ®ä¸ä¼šè¶…è¿‡å–å€¼èŒƒå›´ï¼Œåœ¨è¿™ä¸ªå‰æä¹‹ä¸‹ï¼Œå†å»è€ƒè™‘å¦‚ä½•èŠ‚çœå­˜å‚¨ç©ºé—´ã€‚</p><h2 id="3-æµ®ç‚¹ç±»å‹"><a href="#3-æµ®ç‚¹ç±»å‹" class="headerlink" title="3. æµ®ç‚¹ç±»å‹"></a>3. æµ®ç‚¹ç±»å‹</h2><h3 id="1-ç±»å‹ä»‹ç»-1"><a href="#1-ç±»å‹ä»‹ç»-1" class="headerlink" title="1) ç±»å‹ä»‹ç»"></a>1) ç±»å‹ä»‹ç»</h3><p>æµ®ç‚¹æ•°å’Œå®šç‚¹æ•°ç±»å‹çš„ç‰¹ç‚¹æ˜¯å¯ä»¥ å¤„ç†å°æ•° ï¼Œä½ å¯ä»¥æŠŠæ•´æ•°çœ‹æˆå°æ•°çš„ä¸€ä¸ªç‰¹ä¾‹ã€‚å› æ­¤ï¼Œæµ®ç‚¹æ•°å’Œå®šç‚¹ æ•°çš„ä½¿ç”¨åœºæ™¯ï¼Œæ¯”æ•´æ•°å¤§å¤šäº†ã€‚ MySQLæ”¯æŒçš„æµ®ç‚¹æ•°ç±»å‹ï¼Œåˆ†åˆ«æ˜¯ FLOATã€DOUBLEã€REALã€‚</p><ul><li><p>FLOAT è¡¨ç¤ºå•ç²¾åº¦æµ®ç‚¹æ•°ï¼› </p></li><li><p>DOUBLE è¡¨ç¤ºåŒç²¾åº¦æµ®ç‚¹æ•°ï¼›</p></li><li><p>REALé»˜è®¤å°±æ˜¯ DOUBLEã€‚å¦‚æœä½ æŠŠ SQL æ¨¡å¼è®¾å®šä¸ºå¯ç”¨â€œ REAL_AS_FLOAT â€ï¼Œé‚£ ä¹ˆï¼ŒMySQL å°±è®¤ä¸º REAL æ˜¯ FLOATã€‚å¦‚æœè¦å¯ç”¨â€œREAL_AS_FLOATâ€ï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹ SQL è¯­å¥å®ç°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SET sql_mode = â€œREAL_AS_FLOATâ€;</span><br></pre></td></tr></table></figure></li></ul><p><strong>é—®é¢˜ï¼šä¸ºä»€ä¹ˆæµ®ç‚¹æ•°ç±»å‹çš„æ— ç¬¦å·æ•°å–å€¼èŒƒå›´ï¼Œåªç›¸å½“äºæœ‰ç¬¦å·æ•°å–å€¼èŒƒå›´çš„ä¸€åŠï¼Œä¹Ÿå°±æ˜¯åªç›¸å½“äº æœ‰ç¬¦å·æ•°å–å€¼èŒƒå›´å¤§äºç­‰äºé›¶çš„éƒ¨åˆ†å‘¢ï¼Ÿ</strong></p><p>MySQL å­˜å‚¨æµ®ç‚¹æ•°çš„æ ¼å¼ä¸ºï¼š ç¬¦å·(S) ã€ å°¾æ•°(M) å’Œ é˜¶ç (E) ã€‚å› æ­¤ï¼Œæ— è®ºæœ‰æ²¡æœ‰ç¬¦å·ï¼ŒMySQL çš„æµ® ç‚¹æ•°éƒ½ä¼šå­˜å‚¨è¡¨ç¤ºç¬¦å·çš„éƒ¨åˆ†ã€‚å› æ­¤ï¼Œ æ‰€è°“çš„æ— ç¬¦å·æ•°å–å€¼èŒƒå›´ï¼Œå…¶å®å°±æ˜¯æœ‰ç¬¦å·æ•°å–å€¼èŒƒå›´å¤§äºç­‰äº é›¶çš„éƒ¨åˆ†ã€‚</p><h3 id="2-æ•°æ®ç²¾åº¦è¯´æ˜"><a href="#2-æ•°æ®ç²¾åº¦è¯´æ˜" class="headerlink" title="2) æ•°æ®ç²¾åº¦è¯´æ˜"></a>2) æ•°æ®ç²¾åº¦è¯´æ˜</h3><p>å¯¹äºæµ®ç‚¹ç±»å‹ï¼Œåœ¨MySQLä¸­å•ç²¾åº¦å€¼ä½¿ç”¨ 4 ä¸ªå­—èŠ‚ï¼ŒåŒç²¾åº¦å€¼ä½¿ç”¨ 8 ä¸ªå­—èŠ‚ã€‚</p><ul><li><p>MySQLå…è®¸ä½¿ç”¨ éæ ‡å‡†è¯­æ³• ï¼ˆå…¶ä»–æ•°æ®åº“æœªå¿…æ”¯æŒï¼Œå› æ­¤å¦‚æœæ¶‰åŠåˆ°æ•°æ®è¿ç§»ï¼Œåˆ™æœ€å¥½ä¸è¦è¿™ä¹ˆ ç”¨ï¼‰ï¼š FLOAT(M,D) æˆ– DOUBLE(M,D) ã€‚è¿™é‡Œï¼ŒMç§°ä¸º ç²¾åº¦ ï¼ŒDç§°ä¸º æ ‡åº¦ ã€‚(M,D)ä¸­ M&#x3D;æ•´æ•°ä½+å°æ•° ä½ï¼ŒD&#x3D;å°æ•°ä½ã€‚ D&lt;&#x3D;M&lt;&#x3D;255ï¼Œ0&lt;&#x3D;D&lt;&#x3D;30ã€‚ </p><p>ä¾‹å¦‚ï¼Œå®šä¹‰ä¸ºFLOAT(5,2)çš„ä¸€ä¸ªåˆ—å¯ä»¥æ˜¾ç¤ºä¸º-999.99-999.99ã€‚å¦‚æœè¶…è¿‡è¿™ä¸ªèŒƒå›´ä¼šæŠ¥é”™ã€‚</p></li><li><p>FLOATå’ŒDOUBLEç±»å‹åœ¨ä¸æŒ‡å®š(M,D)æ—¶ï¼Œé»˜è®¤ä¼šæŒ‰ç…§å®é™…çš„ç²¾åº¦ï¼ˆç”±å®é™…çš„ç¡¬ä»¶å’Œæ“ä½œç³»ç»Ÿå†³å®šï¼‰ æ¥æ˜¾ç¤ºã€‚</p></li><li><p>è¯´æ˜ï¼šæµ®ç‚¹ç±»å‹ï¼Œä¹Ÿå¯ä»¥åŠ  UNSIGNED ï¼Œä½†æ˜¯ä¸ä¼šæ”¹å˜æ•°æ®èŒƒå›´ï¼Œä¾‹å¦‚ï¼šFLOAT(3,2) UNSIGNEDä»ç„¶ åªèƒ½è¡¨ç¤º0-9.99çš„èŒƒå›´ã€‚</p></li><li><p>ä¸ç®¡æ˜¯å¦æ˜¾å¼è®¾ç½®äº†ç²¾åº¦(M,D)ï¼Œè¿™é‡ŒMySQLçš„å¤„ç†æ–¹æ¡ˆå¦‚ä¸‹ï¼š</p><ul><li>å¦‚æœå­˜å‚¨æ—¶ï¼Œæ•´æ•°éƒ¨åˆ†è¶…å‡ºäº†èŒƒå›´ï¼ŒMySQLå°±ä¼šæŠ¥é”™ï¼Œä¸å…è®¸å­˜è¿™æ ·çš„å€¼</li><li>å¦‚æœå­˜å‚¨æ—¶ï¼Œå°æ•°ç‚¹éƒ¨åˆ†è‹¥è¶…å‡ºèŒƒå›´ï¼Œå°±åˆ†ä»¥ä¸‹æƒ…å†µï¼š<ul><li>è‹¥å››èˆäº”å…¥åï¼Œæ•´æ•°éƒ¨åˆ†æ²¡æœ‰è¶…å‡ºèŒƒå›´ï¼Œåˆ™åªè­¦å‘Šï¼Œä½†èƒ½æˆåŠŸæ“ä½œå¹¶å››èˆäº”å…¥åˆ é™¤å¤šä½™ çš„å°æ•°ä½åä¿å­˜ã€‚ä¾‹å¦‚åœ¨FLOAT(5,2)åˆ—å†…æ’å…¥999.009ï¼Œè¿‘ä¼¼ç»“æœæ˜¯999.01ã€‚</li><li>è‹¥å››èˆäº”å…¥åï¼Œæ•´æ•°éƒ¨åˆ†è¶…å‡ºèŒƒå›´ï¼Œåˆ™MySQLæŠ¥é”™ï¼Œå¹¶æ‹’ç»å¤„ç†ã€‚å¦‚FLOAT(5,2)åˆ—å†…æ’å…¥ 999.995å’Œ-999.995éƒ½ä¼šæŠ¥é”™ã€‚</li></ul></li></ul></li><li><p>ä»MySQL 8.0.17å¼€å§‹ï¼ŒFLOAT(M,D) å’ŒDOUBLE(M,D)ç”¨æ³•åœ¨å®˜æ–¹æ–‡æ¡£ä¸­å·²ç»æ˜ç¡®ä¸æ¨èä½¿ç”¨ï¼Œå°†æ¥å¯ èƒ½è¢«ç§»é™¤ã€‚å¦å¤–ï¼Œå…³äºæµ®ç‚¹å‹FLOATå’ŒDOUBLEçš„UNSIGNEDä¹Ÿä¸æ¨èä½¿ç”¨äº†ï¼Œå°†æ¥ä¹Ÿå¯èƒ½è¢«ç§»é™¤ã€‚</p></li></ul><h3 id="3-ç²¾åº¦è¯¯å·®è¯´æ˜"><a href="#3-ç²¾åº¦è¯¯å·®è¯´æ˜" class="headerlink" title="3) ç²¾åº¦è¯¯å·®è¯´æ˜"></a>3) ç²¾åº¦è¯¯å·®è¯´æ˜</h3><p>æµ®ç‚¹æ•°ç±»å‹æœ‰ä¸ªç¼ºé™·ï¼Œå°±æ˜¯ä¸ç²¾å‡†ã€‚ä¸‹é¢æˆ‘æ¥é‡ç‚¹è§£é‡Šä¸€ä¸‹ä¸ºä»€ä¹ˆ MySQL çš„æµ®ç‚¹æ•°ä¸å¤Ÿç²¾å‡†ã€‚æ¯”å¦‚ï¼Œæˆ‘ ä»¬è®¾è®¡ä¸€ä¸ªè¡¨ï¼Œæœ‰f1è¿™ä¸ªå­—æ®µï¼Œæ’å…¥å€¼åˆ†åˆ«ä¸º0.47,0.44,0.19ï¼Œæˆ‘ä»¬æœŸå¾…çš„è¿è¡Œç»“æœæ˜¯ï¼š0.47 + 0.44 + 0.19 &#x3D; 1.1ã€‚è€Œä½¿ç”¨sumä¹‹åæŸ¥è¯¢ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE test_double2(</span><br><span class="line">f1 DOUBLE</span><br><span class="line">);</span><br><span class="line">INSERT INTO test_double2</span><br><span class="line">VALUES(0.47),(0.44),(0.19);</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT SUM(f1)</span><br><span class="line">-&gt; FROM test_double2;</span><br><span class="line">+--------------------+</span><br><span class="line">| SUM(f1) |</span><br><span class="line">+--------------------+</span><br><span class="line">| 1.0999999999999999 |</span><br><span class="line">+--------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure><p>æŸ¥è¯¢ç»“æœæ˜¯ 1.0999999999999999ã€‚çœ‹åˆ°äº†å—ï¼Ÿè™½ç„¶è¯¯å·®å¾ˆå°ï¼Œä½†ç¡®å®æœ‰è¯¯å·®ã€‚ ä½ ä¹Ÿå¯ä»¥å°è¯•æŠŠæ•°æ®ç±»å‹ æ”¹æˆ FLOATï¼Œç„¶åè¿è¡Œæ±‚å’ŒæŸ¥è¯¢ï¼Œå¾—åˆ°çš„æ˜¯ï¼Œ 1.0999999940395355ã€‚æ˜¾ç„¶ï¼Œè¯¯å·®æ›´å¤§äº†ã€‚</p><p>é‚£ä¹ˆï¼Œä¸ºä»€ä¹ˆä¼šå­˜åœ¨è¿™æ ·çš„è¯¯å·®å‘¢ï¼Ÿé—®é¢˜è¿˜æ˜¯å‡ºåœ¨ MySQL å¯¹æµ®ç‚¹ç±»å‹æ•°æ®çš„å­˜å‚¨æ–¹å¼ä¸Šã€‚</p><p>MySQL ç”¨ 4 ä¸ªå­—èŠ‚å­˜å‚¨ FLOAT ç±»å‹æ•°æ®ï¼Œç”¨ 8 ä¸ªå­—èŠ‚æ¥å­˜å‚¨ DOUBLE ç±»å‹æ•°æ®ã€‚æ— è®ºå“ªä¸ªï¼Œéƒ½æ˜¯é‡‡ç”¨äºŒ è¿›åˆ¶çš„æ–¹å¼æ¥è¿›è¡Œå­˜å‚¨çš„ã€‚æ¯”å¦‚ 9.625ï¼Œç”¨äºŒè¿›åˆ¶æ¥è¡¨è¾¾ï¼Œå°±æ˜¯ 1001.101ï¼Œæˆ–è€…è¡¨è¾¾æˆ 1.001101Ã—2^3ã€‚å¦‚ æœå°¾æ•°ä¸æ˜¯ 0 æˆ– 5ï¼ˆæ¯”å¦‚ 9.624ï¼‰ï¼Œä½ å°±æ— æ³•ç”¨ä¸€ä¸ªäºŒè¿›åˆ¶æ•°æ¥ç²¾ç¡®è¡¨è¾¾ã€‚è¿›è€Œï¼Œå°±åªå¥½åœ¨å–å€¼å…è®¸çš„èŒƒ å›´å†…è¿›è¡Œå››èˆäº”å…¥ã€‚</p><p>åœ¨ç¼–ç¨‹ä¸­ï¼Œå¦‚æœç”¨åˆ°æµ®ç‚¹æ•°ï¼Œè¦ç‰¹åˆ«æ³¨æ„è¯¯å·®é—®é¢˜ï¼Œå› ä¸ºæµ®ç‚¹æ•°æ˜¯ä¸å‡†ç¡®çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦é¿å…ä½¿ç”¨â€œ&#x3D;â€æ¥ åˆ¤æ–­ä¸¤ä¸ªæ•°æ˜¯å¦ç›¸ç­‰ã€‚åŒæ—¶ï¼Œåœ¨ä¸€äº›å¯¹ç²¾ç¡®åº¦è¦æ±‚è¾ƒé«˜çš„é¡¹ç›®ä¸­ï¼Œåƒä¸‡ä¸è¦ä½¿ç”¨æµ®ç‚¹æ•°ï¼Œä¸ç„¶ä¼šå¯¼è‡´ç»“ æœé”™è¯¯ï¼Œç”šè‡³æ˜¯é€ æˆä¸å¯æŒ½å›çš„æŸå¤±ã€‚é‚£ä¹ˆï¼ŒMySQL æœ‰æ²¡æœ‰ç²¾å‡†çš„æ•°æ®ç±»å‹å‘¢ï¼Ÿå½“ç„¶æœ‰ï¼Œè¿™å°±æ˜¯å®šç‚¹æ•° ç±»å‹ï¼š DECIMAL ã€‚</p><h2 id="4-å®šç‚¹æ•°ç±»å‹"><a href="#4-å®šç‚¹æ•°ç±»å‹" class="headerlink" title="4. å®šç‚¹æ•°ç±»å‹"></a>4. å®šç‚¹æ•°ç±»å‹</h2><h3 id="1-ç±»å‹ä»‹ç»-2"><a href="#1-ç±»å‹ä»‹ç»-2" class="headerlink" title="1) ç±»å‹ä»‹ç»"></a>1) ç±»å‹ä»‹ç»</h3><ul><li>MySQLä¸­çš„å®šç‚¹æ•°ç±»å‹åªæœ‰ DECIMAL ä¸€ç§ç±»å‹ã€‚</li></ul><table><thead><tr><th>ç±»å‹</th><th>å­—èŠ‚</th><th>æœ‰ç¬¦å·æ•°å–å€¼èŒƒå›´</th></tr></thead><tbody><tr><td>DECIMAL(M,D),DEC,NUMERIC</td><td>M+2å­—èŠ‚</td><td>æœ‰æ•ˆèŒƒå›´ç”±Må’ŒDå†³å®š</td></tr></tbody></table><p>ä½¿ç”¨ DECIMAL(M,D) çš„æ–¹å¼è¡¨ç¤ºé«˜ç²¾åº¦å°æ•°ã€‚å…¶ä¸­ï¼ŒMè¢«ç§°ä¸ºç²¾åº¦ï¼ŒDè¢«ç§°ä¸ºæ ‡åº¦ã€‚0&lt;&#x3D;M&lt;&#x3D;65ï¼Œ 0&lt;&#x3D;D&lt;&#x3D;30ï¼ŒD</p><ul><li>DECIMAL(M,D)çš„æœ€å¤§å–å€¼èŒƒå›´ä¸DOUBLEç±»å‹ä¸€æ ·ï¼Œä½†æ˜¯æœ‰æ•ˆçš„æ•°æ®èŒƒå›´æ˜¯ç”±Må’ŒDå†³å®šçš„ã€‚ DECIMAL çš„å­˜å‚¨ç©ºé—´å¹¶ä¸æ˜¯å›ºå®šçš„ï¼Œç”±ç²¾åº¦å€¼Må†³å®šï¼Œæ€»å…±å ç”¨çš„å­˜å‚¨ç©ºé—´ä¸ºM+2ä¸ªå­—èŠ‚ã€‚ä¹Ÿå°±æ˜¯ è¯´ï¼Œåœ¨ä¸€äº›å¯¹ç²¾åº¦è¦æ±‚ä¸é«˜çš„åœºæ™¯ä¸‹ï¼Œæ¯”èµ·å ç”¨åŒæ ·å­—èŠ‚é•¿åº¦çš„å®šç‚¹æ•°ï¼Œæµ®ç‚¹æ•°è¡¨è¾¾çš„æ•°å€¼èŒƒå›´å¯ ä»¥æ›´å¤§ä¸€äº›ã€‚</li><li>å®šç‚¹æ•°åœ¨MySQLå†…éƒ¨æ˜¯ä»¥ å­—ç¬¦ä¸² çš„å½¢å¼è¿›è¡Œå­˜å‚¨ï¼Œè¿™å°±å†³å®šäº†å®ƒä¸€å®šæ˜¯ç²¾å‡†çš„ã€‚</li><li>å½“DECIMALç±»å‹ä¸æŒ‡å®šç²¾åº¦å’Œæ ‡åº¦æ—¶ï¼Œå…¶é»˜è®¤ä¸ºDECIMAL(10,0)ã€‚å½“æ•°æ®çš„ç²¾åº¦è¶…å‡ºäº†å®šç‚¹æ•°ç±»å‹çš„ ç²¾åº¦èŒƒå›´æ—¶ï¼Œåˆ™MySQLåŒæ ·ä¼šè¿›è¡Œå››èˆäº”å…¥å¤„ç†ã€‚</li><li>æµ®ç‚¹æ•° vs å®šç‚¹æ•°<ul><li>æµ®ç‚¹æ•°ç›¸å¯¹äºå®šç‚¹æ•°çš„ä¼˜ç‚¹æ˜¯åœ¨é•¿åº¦ä¸€å®šçš„æƒ…å†µä¸‹ï¼Œæµ®ç‚¹ç±»å‹å–å€¼èŒƒå›´å¤§ï¼Œä½†æ˜¯ä¸ç²¾å‡†ï¼Œé€‚ç”¨ äºéœ€è¦å–å€¼èŒƒå›´å¤§ï¼Œåˆå¯ä»¥å®¹å¿å¾®å°è¯¯å·®çš„ç§‘å­¦è®¡ç®—åœºæ™¯ï¼ˆæ¯”å¦‚è®¡ç®—åŒ–å­¦ã€åˆ†å­å»ºæ¨¡ã€æµä½“åŠ¨ åŠ›å­¦ç­‰ï¼‰</li><li>å®šç‚¹æ•°ç±»å‹å–å€¼èŒƒå›´ç›¸å¯¹å°ï¼Œä½†æ˜¯ç²¾å‡†ï¼Œæ²¡æœ‰è¯¯å·®ï¼Œé€‚åˆäºå¯¹ç²¾åº¦è¦æ±‚æé«˜çš„åœºæ™¯ ï¼ˆæ¯”å¦‚æ¶‰ åŠé‡‘é¢è®¡ç®—çš„åœºæ™¯ï¼‰</li></ul></li></ul><h3 id="2-å¼€å‘ä¸­çš„ç»éªŒ"><a href="#2-å¼€å‘ä¸­çš„ç»éªŒ" class="headerlink" title="2) å¼€å‘ä¸­çš„ç»éªŒ"></a>2) å¼€å‘ä¸­çš„ç»éªŒ</h3><p>â€œç”±äº DECIMAL æ•°æ®ç±»å‹çš„ç²¾å‡†æ€§ï¼Œåœ¨æˆ‘ä»¬çš„é¡¹ç›®ä¸­ï¼Œé™¤äº†æå°‘æ•°ï¼ˆæ¯”å¦‚å•†å“ç¼–å·ï¼‰ç”¨åˆ°æ•´æ•°ç±»å‹ å¤–ï¼Œå…¶ä»–çš„æ•°å€¼éƒ½ç”¨çš„æ˜¯ DECIMALï¼ŒåŸå› å°±æ˜¯è¿™ä¸ªé¡¹ç›®æ‰€å¤„çš„é›¶å”®è¡Œä¸šï¼Œè¦æ±‚ç²¾å‡†ï¼Œä¸€åˆ†é’±ä¹Ÿä¸èƒ½ å·®ã€‚ â€ â€”â€”æ¥è‡ªæŸé¡¹ç›®ç»ç†</p><h2 id="5-ä½ç±»å‹ï¼šBIT"><a href="#5-ä½ç±»å‹ï¼šBIT" class="headerlink" title="5. ä½ç±»å‹ï¼šBIT"></a>5. ä½ç±»å‹ï¼šBIT</h2><p>BITç±»å‹ä¸­å­˜å‚¨çš„æ˜¯äºŒè¿›åˆ¶å€¼ï¼Œç±»ä¼¼010110ã€‚</p><table><thead><tr><th>äºŒè¿›åˆ¶å­—ç¬¦ä¸²ç±»å‹</th><th>é•¿åº¦</th><th>é•¿åº¦èŒƒå›´</th><th>å ç”¨ç©ºé—´</th></tr></thead><tbody><tr><td>BIT(M)</td><td>M</td><td>1 &lt;&#x3D; M &lt;&#x3D; 64</td><td>çº¦ä¸º(M + 7)&#x2F;8ä¸ªå­—èŠ‚</td></tr></tbody></table><p>BITç±»å‹ï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®š(M)ï¼Œé»˜è®¤æ˜¯1ä½ã€‚è¿™ä¸ª1ä½ï¼Œè¡¨ç¤ºåªèƒ½å­˜1ä½çš„äºŒè¿›åˆ¶å€¼ã€‚è¿™é‡Œ(M)æ˜¯è¡¨ç¤ºäºŒè¿›åˆ¶çš„ ä½æ•°ï¼Œä½æ•°æœ€å°å€¼ä¸º1ï¼Œæœ€å¤§å€¼ä¸º64ã€‚</p><h2 id="6-æ—¥æœŸä¸æ—¶é—´ç±»å‹"><a href="#6-æ—¥æœŸä¸æ—¶é—´ç±»å‹" class="headerlink" title="6. æ—¥æœŸä¸æ—¶é—´ç±»å‹"></a>6. æ—¥æœŸä¸æ—¶é—´ç±»å‹</h2><p>æ—¥æœŸä¸æ—¶é—´æ˜¯é‡è¦çš„ä¿¡æ¯ï¼Œåœ¨æˆ‘ä»¬çš„ç³»ç»Ÿä¸­ï¼Œå‡ ä¹æ‰€æœ‰çš„æ•°æ®è¡¨éƒ½ç”¨å¾—åˆ°ã€‚åŸå› æ˜¯å®¢æˆ·éœ€è¦çŸ¥é“æ•°æ®çš„ æ—¶é—´æ ‡ç­¾ï¼Œä»è€Œè¿›è¡Œæ•°æ®æŸ¥è¯¢ã€ç»Ÿè®¡å’Œå¤„ç†ã€‚</p><p>MySQLæœ‰å¤šç§è¡¨ç¤ºæ—¥æœŸå’Œæ—¶é—´çš„æ•°æ®ç±»å‹ï¼Œä¸åŒçš„ç‰ˆæœ¬å¯èƒ½æœ‰æ‰€å·®å¼‚ï¼ŒMySQL8.0ç‰ˆæœ¬æ”¯æŒçš„æ—¥æœŸå’Œæ—¶é—´ ç±»å‹ä¸»è¦æœ‰ï¼šYEARç±»å‹ã€TIMEç±»å‹ã€DATEç±»å‹ã€DATETIMEç±»å‹å’ŒTIMESTAMPç±»å‹ã€‚</p><ul><li>YEAR ç±»å‹é€šå¸¸ç”¨æ¥è¡¨ç¤ºå¹´ </li><li>DATE ç±»å‹é€šå¸¸ç”¨æ¥è¡¨ç¤ºå¹´ã€æœˆã€æ—¥ </li><li>TIME ç±»å‹é€šå¸¸ç”¨æ¥è¡¨ç¤ºæ—¶ã€åˆ†ã€ç§’ </li><li>DATETIME ç±»å‹é€šå¸¸ç”¨æ¥è¡¨ç¤ºå¹´ã€æœˆã€æ—¥ã€æ—¶ã€åˆ†ã€ç§’ </li><li>TIMESTAMP ç±»å‹é€šå¸¸ç”¨æ¥è¡¨ç¤ºå¸¦æ—¶åŒºçš„å¹´ã€æœˆã€æ—¥ã€æ—¶ã€åˆ†ã€ç§’</li></ul><table><thead><tr><th>ç±»å‹</th><th>åç§°</th><th>å­—èŠ‚</th><th>æ—¥æœŸæ ¼å¼</th><th>æœ€å°å€¼</th><th>æœ€å¤§å€¼</th></tr></thead><tbody><tr><td>YEAR</td><td>å¹´</td><td>1</td><td>YYYYæˆ–YY</td><td>1901</td><td>2155</td></tr><tr><td>TIME</td><td>æ—¶é—´</td><td>3</td><td>HH:MM:SS</td><td>-838:59:59</td><td>838:59:59</td></tr><tr><td>DATE</td><td>æ—¥æœŸ</td><td>3</td><td>YYYY-MM-DD</td><td>1000-01-01</td><td>9999-12-03</td></tr><tr><td>DATETIME</td><td>æ—¥æœŸæ—¶é—´</td><td>8</td><td>YYYY-MM-DD HH:MM:SS</td><td>1000-01-01 00:00:00</td><td>9999-12-31 23:59:59</td></tr><tr><td>TIMESTAMP</td><td>æ—¥æœŸæ—¶é—´</td><td>4</td><td>YYYY-MM-DD HH:MM:SS</td><td>1970-01-01 00:00:00 UTC</td><td>2038-01-19 03:14:07UTC</td></tr></tbody></table><p>å¯ä»¥çœ‹åˆ°ï¼Œä¸åŒæ•°æ®ç±»å‹è¡¨ç¤ºçš„æ—¶é—´å†…å®¹ä¸åŒã€å–å€¼èŒƒå›´ä¸åŒï¼Œè€Œä¸”å ç”¨çš„å­—èŠ‚æ•°ä¹Ÿä¸ä¸€æ ·ï¼Œä½ è¦æ ¹æ® å®é™…éœ€è¦çµæ´»é€‰å–ã€‚</p><p>ä¸ºä»€ä¹ˆæ—¶é—´ç±»å‹ TIME çš„å–å€¼èŒƒå›´ä¸æ˜¯ -23:59:59ï½23:59:59 å‘¢ï¼ŸåŸå› æ˜¯ MySQL è®¾è®¡çš„ TIME ç±»å‹ï¼Œä¸å…‰è¡¨ ç¤ºä¸€å¤©ä¹‹å†…çš„æ—¶é—´ï¼Œè€Œä¸”å¯ä»¥ç”¨æ¥è¡¨ç¤ºä¸€ä¸ªæ—¶é—´é—´éš”ï¼Œè¿™ä¸ªæ—¶é—´é—´éš”å¯ä»¥è¶…è¿‡ 24 å°æ—¶ã€‚</p><h2 id="7-æ–‡æœ¬å­—ç¬¦ä¸²ç±»å‹"><a href="#7-æ–‡æœ¬å­—ç¬¦ä¸²ç±»å‹" class="headerlink" title="7. æ–‡æœ¬å­—ç¬¦ä¸²ç±»å‹"></a>7. æ–‡æœ¬å­—ç¬¦ä¸²ç±»å‹</h2><p>MySQLä¸­ï¼Œæ–‡æœ¬å­—ç¬¦ä¸²æ€»ä½“ä¸Šåˆ†ä¸º CHAR ã€ VARCHAR ã€ TINYTEXT ã€ TEXT ã€ MEDIUMTEXT ã€ LONGTEXT ã€ ENUM ã€ SET ç­‰ç±»å‹ã€‚</p><h2 id="8-ENUMç±»å‹"><a href="#8-ENUMç±»å‹" class="headerlink" title="8. ENUMç±»å‹"></a>8. ENUMç±»å‹</h2><p>ENUMç±»å‹ä¹Ÿå«ä½œæšä¸¾ç±»å‹ï¼ŒENUMç±»å‹çš„å–å€¼èŒƒå›´éœ€è¦åœ¨å®šä¹‰å­—æ®µæ—¶è¿›è¡ŒæŒ‡å®šã€‚è®¾ç½®å­—æ®µå€¼æ—¶ï¼ŒENUM ç±»å‹åªå…è®¸ä»æˆå‘˜ä¸­é€‰å–å•ä¸ªå€¼ï¼Œä¸èƒ½ä¸€æ¬¡é€‰å–å¤šä¸ªå€¼ã€‚ å…¶æ‰€éœ€è¦çš„å­˜å‚¨ç©ºé—´ç”±å®šä¹‰ENUMç±»å‹æ—¶æŒ‡å®šçš„æˆå‘˜ä¸ªæ•°å†³å®šã€‚</p><table><thead><tr><th>æ–‡æœ¬å­—ç¬¦ä¸²ç±»å‹</th><th>é•¿åº¦</th><th>é•¿åº¦èŒƒå›´</th><th>å ç”¨çš„å­˜å‚¨ç©ºé—´</th></tr></thead><tbody><tr><td>ENUM</td><td>L</td><td>1 &lt;&#x3D; L &lt;&#x3D; 65535</td><td>1æˆ–2ä¸ªå­—èŠ‚</td></tr></tbody></table><ul><li>å½“ENUMç±»å‹åŒ…å«1ï½255ä¸ªæˆå‘˜æ—¶ï¼Œéœ€è¦1ä¸ªå­—èŠ‚çš„å­˜å‚¨ç©ºé—´ï¼› </li><li>å½“ENUMç±»å‹åŒ…å«256ï½65535ä¸ªæˆå‘˜æ—¶ï¼Œéœ€è¦2ä¸ªå­—èŠ‚çš„å­˜å‚¨ç©ºé—´ã€‚ </li><li>ENUMç±»å‹çš„æˆå‘˜ä¸ªæ•°çš„ä¸Šé™ä¸º65535ä¸ªã€‚</li></ul><h2 id="9-SETç±»å‹"><a href="#9-SETç±»å‹" class="headerlink" title="9. SETç±»å‹"></a>9. SETç±»å‹</h2><p>å½“SETç±»å‹åŒ…å«çš„æˆå‘˜ä¸ªæ•°ä¸åŒæ—¶ï¼Œå…¶æ‰€å ç”¨çš„å­˜å‚¨ç©ºé—´ä¹Ÿæ˜¯ä¸åŒçš„ï¼Œå…·ä½“å¦‚ä¸‹ï¼š</p><table><thead><tr><th>æˆå‘˜ä¸ªæ•°èŒƒå›´ï¼ˆLè¡¨ç¤ºå®é™…æˆå‘˜ä¸ªæ•°ï¼‰</th><th>å ç”¨çš„å­˜å‚¨ç©ºé—´</th></tr></thead><tbody><tr><td>1 &lt;&#x3D; L &lt;&#x3D; 8</td><td>1ä¸ªå­—èŠ‚</td></tr><tr><td>9 &lt;&#x3D; L &lt;&#x3D; 16</td><td>2ä¸ªå­—èŠ‚</td></tr><tr><td>17 &lt;&#x3D; L &lt;&#x3D; 24</td><td>3ä¸ªå­—èŠ‚</td></tr><tr><td>25 &lt;&#x3D; L &lt;&#x3D; 32</td><td>4ä¸ªå­—èŠ‚</td></tr><tr><td>33 &lt;&#x3D; L &lt;&#x3D; 64</td><td>8ä¸ªå­—èŠ‚</td></tr></tbody></table><p>SETç±»å‹åœ¨å­˜å‚¨æ•°æ®æ—¶æˆå‘˜ä¸ªæ•°è¶Šå¤šï¼Œå…¶å ç”¨çš„å­˜å‚¨ç©ºé—´è¶Šå¤§ã€‚æ³¨æ„ï¼šSETç±»å‹åœ¨é€‰å–æˆå‘˜æ—¶ï¼Œå¯ä»¥ä¸€æ¬¡ é€‰æ‹©å¤šä¸ªæˆå‘˜ï¼Œè¿™ä¸€ç‚¹ä¸ENUMç±»å‹ä¸åŒã€‚</p><h2 id="13-å°ç»“åŠé€‰æ‹©å»ºè®®"><a href="#13-å°ç»“åŠé€‰æ‹©å»ºè®®" class="headerlink" title="13. å°ç»“åŠé€‰æ‹©å»ºè®®"></a>13. å°ç»“åŠé€‰æ‹©å»ºè®®</h2><p>åœ¨å®šä¹‰æ•°æ®ç±»å‹æ—¶ï¼Œå¦‚æœç¡®å®šæ˜¯ æ•´æ•° ï¼Œå°±ç”¨ INT ï¼› å¦‚æœæ˜¯ å°æ•° ï¼Œä¸€å®šç”¨å®šç‚¹æ•°ç±»å‹ DECIMAL(M,D) ï¼› å¦‚æœæ˜¯æ—¥æœŸä¸æ—¶é—´ï¼Œå°±ç”¨ DATETIME ã€‚ è¿™æ ·åšçš„å¥½å¤„æ˜¯ï¼Œé¦–å…ˆç¡®ä¿ä½ çš„ç³»ç»Ÿä¸ä¼šå› ä¸ºæ•°æ®ç±»å‹å®šä¹‰å‡ºé”™ã€‚ä¸è¿‡ï¼Œå‡¡äº‹éƒ½æ˜¯æœ‰ä¸¤é¢çš„ï¼Œå¯é æ€§ å¥½ï¼Œå¹¶ä¸æ„å‘³ç€é«˜æ•ˆã€‚æ¯”å¦‚ï¼ŒTEXT è™½ç„¶ä½¿ç”¨æ–¹ä¾¿ï¼Œä½†æ˜¯æ•ˆç‡ä¸å¦‚ CHAR(M) å’Œ VARCHAR(M)ã€‚</p><p><strong>é˜¿é‡Œå·´å·´ã€ŠJavaå¼€å‘æ‰‹å†Œã€‹ä¹‹MySQLæ•°æ®åº“ï¼š</strong></p><ul><li><p>ä»»ä½•å­—æ®µå¦‚æœä¸ºéè´Ÿæ•°ï¼Œå¿…é¡»æ˜¯ UNSIGNED </p></li><li><p>ã€ å¼ºåˆ¶ ã€‘å°æ•°ç±»å‹ä¸º DECIMALï¼Œç¦æ­¢ä½¿ç”¨ FLOAT å’Œ DOUBLEã€‚ </p><p>è¯´æ˜ï¼šåœ¨å­˜å‚¨çš„æ—¶å€™ï¼ŒFLOAT å’Œ DOUBLE éƒ½å­˜åœ¨ç²¾åº¦æŸå¤±çš„é—®é¢˜ï¼Œå¾ˆå¯èƒ½åœ¨æ¯”è¾ƒå€¼çš„æ—¶å€™ï¼Œå¾—åˆ°ä¸æ­£ç¡®çš„ç»“æœã€‚å¦‚æœå­˜å‚¨çš„æ•°æ®èŒƒå›´è¶…è¿‡ DECIMAL çš„èŒƒå›´ï¼Œå»ºè®®å°†æ•°æ®æ‹†æˆæ•´æ•°å’Œå°æ•°å¹¶åˆ†å¼€å­˜å‚¨ã€‚ </p></li><li><p>ã€ å¼ºåˆ¶ ã€‘å¦‚æœå­˜å‚¨çš„å­—ç¬¦ä¸²é•¿åº¦å‡ ä¹ç›¸ç­‰ï¼Œä½¿ç”¨ CHAR å®šé•¿å­—ç¬¦ä¸²ç±»å‹ã€‚</p></li><li><p>ã€ å¼ºåˆ¶ ã€‘VARCHAR æ˜¯å¯å˜é•¿å­—ç¬¦ä¸²ï¼Œä¸é¢„å…ˆåˆ†é…å­˜å‚¨ç©ºé—´ï¼Œé•¿åº¦ä¸è¦è¶…è¿‡ 5000ã€‚å¦‚æœå­˜å‚¨é•¿åº¦å¤§äºæ­¤å€¼ï¼Œå®šä¹‰å­—æ®µç±»å‹ä¸º TEXTï¼Œç‹¬ç«‹å‡ºæ¥ä¸€å¼ è¡¨ï¼Œç”¨ä¸»é”®æ¥å¯¹åº”ï¼Œé¿å…å½±å“å…¶å®ƒå­—æ®µç´¢å¼•æ•ˆç‡ã€‚</p></li></ul><h1 id="ç¬¬13ç« -çº¦æŸ"><a href="#ç¬¬13ç« -çº¦æŸ" class="headerlink" title="ç¬¬13ç« _çº¦æŸ"></a>ç¬¬13ç« _çº¦æŸ</h1><h2 id="1-çº¦æŸçš„åˆ†ç±»"><a href="#1-çº¦æŸçš„åˆ†ç±»" class="headerlink" title="1. çº¦æŸçš„åˆ†ç±»"></a>1. çº¦æŸçš„åˆ†ç±»</h2><ul><li>æ ¹æ®çº¦æŸæ•°æ®åˆ—çš„é™åˆ¶ï¼Œçº¦æŸå¯åˆ†ä¸ºï¼š<ul><li>å•åˆ—çº¦æŸï¼šæ¯ä¸ªçº¦æŸåªçº¦æŸä¸€åˆ—</li><li>å¤šåˆ—çº¦æŸï¼šæ¯ä¸ªçº¦æŸå¯çº¦æŸå¤šåˆ—æ•°æ®</li></ul></li><li>æ ¹æ®çº¦æŸçš„ä½œç”¨èŒƒå›´ï¼Œçº¦æŸå¯åˆ†ä¸ºï¼š<ul><li>åˆ—çº§çº¦æŸï¼šåªèƒ½ä½œç”¨åœ¨ä¸€ä¸ªåˆ—ä¸Šï¼Œè·Ÿåœ¨åˆ—çš„å®šä¹‰åé¢</li><li>è¡¨çº§çº¦æŸï¼šå¯ä»¥ä½œç”¨åœ¨å¤šä¸ªåˆ—ä¸Šï¼Œä¸ä¸åˆ—ä¸€èµ·ï¼Œè€Œæ˜¯å•ç‹¬å®šä¹‰</li></ul></li><li>æ ¹æ®çº¦æŸèµ·çš„ä½œç”¨ï¼Œçº¦æŸå¯åˆ†ä¸ºï¼š<ul><li>NOT NULL éç©ºçº¦æŸï¼Œè§„å®šæŸä¸ªå­—æ®µä¸èƒ½ä¸ºç©º </li><li>UNIQUE å”¯ä¸€çº¦æŸï¼Œè§„å®šæŸä¸ªå­—æ®µåœ¨æ•´ä¸ªè¡¨ä¸­æ˜¯å”¯ä¸€çš„ </li><li>PRIMARY KEY ä¸»é”®(éç©ºä¸”å”¯ä¸€)çº¦æŸ </li><li>FOREIGN KEY å¤–é”®çº¦æŸ </li><li>CHECK æ£€æŸ¥çº¦æŸ </li><li>DEFAULT é»˜è®¤å€¼çº¦æŸ</li></ul></li></ul><blockquote><p>æ³¨æ„ï¼š MySQLä¸æ”¯æŒcheckçº¦æŸï¼Œä½†å¯ä»¥ä½¿ç”¨checkçº¦æŸï¼Œè€Œæ²¡æœ‰ä»»ä½•æ•ˆæœ </p></blockquote><ul><li>å¦‚ä½•æ·»åŠ &#x2F; åˆ é™¤çº¦æŸï¼Ÿ</li></ul><p>CREATE TABLEæ—¶æ·»åŠ çº¦æŸ</p><p>ALTER TABLEæ—¶å¢åŠ çº¦æŸã€åˆ é™¤çº¦æŸ</p><ul><li>æŸ¥çœ‹æŸä¸ªè¡¨å·²æœ‰çš„çº¦æŸ</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#information_schemaæ•°æ®åº“åï¼ˆç³»ç»Ÿåº“ï¼‰</span><br><span class="line">#table_constraintsè¡¨åç§°ï¼ˆä¸“é—¨å­˜å‚¨å„ä¸ªè¡¨çš„çº¦æŸï¼‰</span><br><span class="line">SELECT * FROM information_schema.table_constraints</span><br><span class="line">WHERE table_name = &#x27;è¡¨åç§°&#x27;;</span><br></pre></td></tr></table></figure><h2 id="2-éç©ºçº¦æŸ"><a href="#2-éç©ºçº¦æŸ" class="headerlink" title="2. éç©ºçº¦æŸ"></a>2. éç©ºçº¦æŸ</h2><h3 id="1-ä½œç”¨"><a href="#1-ä½œç”¨" class="headerlink" title="1) ä½œç”¨"></a>1) ä½œç”¨</h3><p>é™å®šæŸä¸ªå­—æ®µ&#x2F; æŸåˆ—çš„å€¼ä¸å…è®¸ä¸ºç©º</p><h3 id="2-å…³é”®å­—"><a href="#2-å…³é”®å­—" class="headerlink" title="2) å…³é”®å­—"></a>2) å…³é”®å­—</h3><p>NOT NULL</p><h3 id="3-ç‰¹ç‚¹"><a href="#3-ç‰¹ç‚¹" class="headerlink" title="3) ç‰¹ç‚¹"></a>3) ç‰¹ç‚¹</h3><ul><li>é»˜è®¤ï¼Œæ‰€æœ‰çš„ç±»å‹çš„å€¼éƒ½å¯ä»¥æ˜¯NULLï¼ŒåŒ…æ‹¬INTã€FLOATç­‰æ•°æ®ç±»å‹ </li><li>éç©ºçº¦æŸåªèƒ½å‡ºç°åœ¨è¡¨å¯¹è±¡çš„åˆ—ä¸Šï¼Œåªèƒ½æŸä¸ªåˆ—å•ç‹¬é™å®šéç©ºï¼Œä¸èƒ½ç»„åˆéç©º </li><li>ä¸€ä¸ªè¡¨å¯ä»¥æœ‰å¾ˆå¤šåˆ—éƒ½åˆ†åˆ«é™å®šäº†éç©º </li><li>ç©ºå­—ç¬¦ä¸²â€™â€™ä¸ç­‰äºNULLï¼Œ0ä¹Ÿä¸ç­‰äºNULL</li></ul><h3 id="4-æ·»åŠ éç©ºçº¦æŸ"><a href="#4-æ·»åŠ éç©ºçº¦æŸ" class="headerlink" title="4) æ·»åŠ éç©ºçº¦æŸ"></a>4) æ·»åŠ éç©ºçº¦æŸ</h3><p><strong>1. å»ºè¡¨æ—¶</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE è¡¨åç§°(</span><br><span class="line">å­—æ®µå æ•°æ®ç±»å‹,</span><br><span class="line">å­—æ®µå æ•°æ®ç±»å‹ NOT NULL,</span><br><span class="line">å­—æ®µå æ•°æ®ç±»å‹ NOT NULL</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p><strong>2. å»ºè¡¨å</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alter table è¡¨åç§° modify å­—æ®µå æ•°æ®ç±»å‹ not null;</span><br></pre></td></tr></table></figure><h3 id="5-åˆ é™¤éç©ºçº¦æŸ"><a href="#5-åˆ é™¤éç©ºçº¦æŸ" class="headerlink" title="5) åˆ é™¤éç©ºçº¦æŸ"></a>5) åˆ é™¤éç©ºçº¦æŸ</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">alter table è¡¨åç§° modify å­—æ®µå æ•°æ®ç±»å‹ NULL;#å»æ‰not nullï¼Œç›¸å½“äºä¿®æ”¹æŸä¸ªéæ³¨è§£å­—æ®µï¼Œè¯¥å­—æ®µå…è®¸ä¸ºç©º</span><br><span class="line">æˆ–</span><br><span class="line">alter table è¡¨åç§° modify å­—æ®µå æ•°æ®ç±»å‹;#å»æ‰not nullï¼Œç›¸å½“äºä¿®æ”¹æŸä¸ªéæ³¨è§£å­—æ®µï¼Œè¯¥å­—æ®µå…è®¸ä¸ºç©º</span><br></pre></td></tr></table></figure><h2 id="3-å”¯ä¸€æ€§çº¦æŸ"><a href="#3-å”¯ä¸€æ€§çº¦æŸ" class="headerlink" title="3. å”¯ä¸€æ€§çº¦æŸ"></a>3. å”¯ä¸€æ€§çº¦æŸ</h2><h3 id="1-ä½œç”¨-1"><a href="#1-ä½œç”¨-1" class="headerlink" title="1) ä½œç”¨"></a>1) ä½œç”¨</h3><p>ç”¨æ¥é™åˆ¶æŸä¸ªå­—æ®µ&#x2F;æŸåˆ—çš„å€¼ä¸èƒ½é‡å¤ã€‚</p><h3 id="2-å…³é”®å­—-1"><a href="#2-å…³é”®å­—-1" class="headerlink" title="2) å…³é”®å­—"></a>2) å…³é”®å­—</h3><p>UNIQUE</p><h3 id="3-ç‰¹ç‚¹-1"><a href="#3-ç‰¹ç‚¹-1" class="headerlink" title="3) ç‰¹ç‚¹"></a>3) ç‰¹ç‚¹</h3><ul><li>åŒä¸€ä¸ªè¡¨å¯ä»¥æœ‰å¤šä¸ªå”¯ä¸€çº¦æŸã€‚</li><li>å”¯ä¸€çº¦æŸå¯ä»¥æ˜¯æŸä¸€ä¸ªåˆ—çš„å€¼å”¯ä¸€ï¼Œä¹Ÿå¯ä»¥å¤šä¸ªåˆ—ç»„åˆçš„å€¼å”¯ä¸€ã€‚ </li><li>å”¯ä¸€æ€§çº¦æŸå…è®¸åˆ—å€¼ä¸ºç©ºã€‚ </li><li>åœ¨åˆ›å»ºå”¯ä¸€çº¦æŸçš„æ—¶å€™ï¼Œå¦‚æœä¸ç»™å”¯ä¸€çº¦æŸå‘½åï¼Œå°±é»˜è®¤å’Œåˆ—åç›¸åŒã€‚ </li><li>MySQLä¼šç»™å”¯ä¸€çº¦æŸçš„åˆ—ä¸Šé»˜è®¤åˆ›å»ºä¸€ä¸ªå”¯ä¸€ç´¢å¼•ã€‚</li></ul><h3 id="4-æ·»åŠ å”¯ä¸€çº¦æŸ"><a href="#4-æ·»åŠ å”¯ä¸€çº¦æŸ" class="headerlink" title="4) æ·»åŠ å”¯ä¸€çº¦æŸ"></a>4) æ·»åŠ å”¯ä¸€çº¦æŸ</h3><p><strong>1. å»ºè¡¨æ—¶</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">create table è¡¨åç§°(</span><br><span class="line">å­—æ®µå æ•°æ®ç±»å‹,</span><br><span class="line">å­—æ®µå æ•°æ®ç±»å‹ unique,</span><br><span class="line">å­—æ®µå æ•°æ®ç±»å‹ unique key,</span><br><span class="line">å­—æ®µå æ•°æ®ç±»å‹</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">create table è¡¨åç§°(</span><br><span class="line">å­—æ®µå æ•°æ®ç±»å‹,</span><br><span class="line">å­—æ®µå æ•°æ®ç±»å‹,</span><br><span class="line">å­—æ®µå æ•°æ®ç±»å‹,</span><br><span class="line">[constraint çº¦æŸå] unique key(å­—æ®µå)</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>ä¸¾ä¾‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE USER(</span><br><span class="line">id INT NOT NULL,</span><br><span class="line">NAME VARCHAR(25),</span><br><span class="line">PASSWORD VARCHAR(16),</span><br><span class="line">-- ä½¿ç”¨è¡¨çº§çº¦æŸè¯­æ³•</span><br><span class="line">CONSTRAINT uk_name_pwd UNIQUE(NAME,PASSWORD)</span><br><span class="line">);</span><br></pre></td></tr></table></figure><blockquote><p>è¡¨ç¤ºç”¨æˆ·åå’Œå¯†ç ç»„åˆä¸èƒ½é‡å¤</p></blockquote><p><strong>2. å»ºè¡¨åæŒ‡å®šå”¯ä¸€é”®çº¦æŸ</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#å­—æ®µåˆ—è¡¨ä¸­å¦‚æœæ˜¯ä¸€ä¸ªå­—æ®µï¼Œè¡¨ç¤ºè¯¥åˆ—çš„å€¼å”¯ä¸€ã€‚å¦‚æœæ˜¯ä¸¤ä¸ªæˆ–æ›´å¤šä¸ªå­—æ®µï¼Œé‚£ä¹ˆå¤åˆå”¯ä¸€ï¼Œå³å¤šä¸ªå­—æ®µçš„ç»„åˆæ˜¯å”¯</span><br><span class="line">ä¸€çš„</span><br><span class="line">#æ–¹å¼1ï¼š</span><br><span class="line">alter table è¡¨åç§° add unique key(å­—æ®µåˆ—è¡¨);</span><br><span class="line">#æ–¹å¼2ï¼š</span><br><span class="line">alter table è¡¨åç§° modify å­—æ®µå å­—æ®µç±»å‹ unique;</span><br></pre></td></tr></table></figure><h3 id="5-å…³äºå¤åˆå”¯ä¸€çº¦æŸ"><a href="#5-å…³äºå¤åˆå”¯ä¸€çº¦æŸ" class="headerlink" title="5) å…³äºå¤åˆå”¯ä¸€çº¦æŸ"></a>5) å…³äºå¤åˆå”¯ä¸€çº¦æŸ</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">create table è¡¨åç§°(</span><br><span class="line">å­—æ®µå æ•°æ®ç±»å‹,</span><br><span class="line">å­—æ®µå æ•°æ®ç±»å‹,</span><br><span class="line">å­—æ®µå æ•°æ®ç±»å‹,</span><br><span class="line">unique key(å­—æ®µåˆ—è¡¨) #å­—æ®µåˆ—è¡¨ä¸­å†™çš„æ˜¯å¤šä¸ªå­—æ®µåï¼Œå¤šä¸ªå­—æ®µåç”¨é€—å·åˆ†éš”ï¼Œè¡¨ç¤ºé‚£ä¹ˆæ˜¯å¤åˆå”¯ä¸€ï¼Œå³å¤š</span><br><span class="line">ä¸ªå­—æ®µçš„ç»„åˆæ˜¯å”¯ä¸€çš„</span><br><span class="line">);</span><br></pre></td></tr></table></figure><h3 id="6-åˆ é™¤å”¯ä¸€çº¦æŸ"><a href="#6-åˆ é™¤å”¯ä¸€çº¦æŸ" class="headerlink" title="6) åˆ é™¤å”¯ä¸€çº¦æŸ"></a>6) åˆ é™¤å”¯ä¸€çº¦æŸ</h3><ul><li>æ·»åŠ å”¯ä¸€æ€§çº¦æŸçš„åˆ—ä¸Šä¹Ÿä¼šè‡ªåŠ¨åˆ›å»ºå”¯ä¸€ç´¢å¼•ã€‚ </li><li>åˆ é™¤å”¯ä¸€çº¦æŸåªèƒ½é€šè¿‡åˆ é™¤å”¯ä¸€ç´¢å¼•çš„æ–¹å¼åˆ é™¤ã€‚ </li><li>åˆ é™¤æ—¶éœ€è¦æŒ‡å®šå”¯ä¸€ç´¢å¼•åï¼Œå”¯ä¸€ç´¢å¼•åå°±å’Œå”¯ä¸€çº¦æŸåä¸€æ ·ã€‚ </li><li>å¦‚æœåˆ›å»ºå”¯ä¸€çº¦æŸæ—¶æœªæŒ‡å®šåç§°ï¼Œå¦‚æœæ˜¯å•åˆ—ï¼Œå°±é»˜è®¤å’Œåˆ—åç›¸åŒï¼›</li><li>å¦‚æœæ˜¯ç»„åˆåˆ—ï¼Œé‚£ä¹ˆé»˜è®¤å’Œ() ä¸­æ’åœ¨ç¬¬ä¸€ä¸ªçš„åˆ—åç›¸åŒã€‚ä¹Ÿå¯ä»¥è‡ªå®šä¹‰å”¯ä¸€æ€§çº¦æŸåã€‚</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM information_schema.table_constraints WHERE table_name = &#x27;è¡¨å&#x27;; #æŸ¥çœ‹éƒ½æœ‰å“ªäº›çº¦æŸ</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ALTER TABLE USER</span><br><span class="line">DROP INDEX uk_name_pwd;</span><br></pre></td></tr></table></figure><blockquote><p>æ³¨æ„ï¼šå¯ä»¥é€šè¿‡ show index from è¡¨åç§°;        #æŸ¥çœ‹è¡¨çš„ç´¢å¼•</p></blockquote><h2 id="4-PRIMARY-KEY-çº¦æŸ"><a href="#4-PRIMARY-KEY-çº¦æŸ" class="headerlink" title="4. PRIMARY KEY çº¦æŸ"></a>4. PRIMARY KEY çº¦æŸ</h2><h3 id="1-ä½œç”¨-2"><a href="#1-ä½œç”¨-2" class="headerlink" title="1) ä½œç”¨"></a>1) ä½œç”¨</h3><p>ç”¨æ¥å”¯ä¸€æ ‡è¯†è¡¨ä¸­çš„ä¸€è¡Œè®°å½•ã€‚</p><h3 id="2-å…³é”®å­—-2"><a href="#2-å…³é”®å­—-2" class="headerlink" title="2) å…³é”®å­—"></a>2) å…³é”®å­—</h3><p>primary key</p><h3 id="3-ç‰¹ç‚¹-2"><a href="#3-ç‰¹ç‚¹-2" class="headerlink" title="3) ç‰¹ç‚¹"></a>3) ç‰¹ç‚¹</h3><p>ä¸»é”®çº¦æŸç›¸å½“äºå”¯ä¸€çº¦æŸ+éç©ºçº¦æŸçš„ç»„åˆï¼Œä¸»é”®çº¦æŸåˆ—ä¸å…è®¸é‡å¤ï¼Œä¹Ÿä¸å…è®¸å‡ºç°ç©ºå€¼ã€‚</p><ul><li>ä¸€ä¸ªè¡¨æœ€å¤šåªèƒ½æœ‰ä¸€ä¸ªä¸»é”®çº¦æŸï¼Œå»ºç«‹ä¸»é”®çº¦æŸå¯ä»¥åœ¨åˆ—çº§åˆ«åˆ›å»ºï¼Œä¹Ÿå¯ä»¥åœ¨è¡¨çº§åˆ«ä¸Šåˆ›å»ºã€‚ </li><li>ä¸»é”®çº¦æŸå¯¹åº”ç€è¡¨ä¸­çš„ä¸€åˆ—æˆ–è€…å¤šåˆ—ï¼ˆå¤åˆä¸»é”®ï¼‰ </li><li>å¦‚æœæ˜¯å¤šåˆ—ç»„åˆçš„å¤åˆä¸»é”®çº¦æŸï¼Œé‚£ä¹ˆè¿™äº›åˆ—éƒ½ä¸å…è®¸ä¸ºç©ºå€¼ï¼Œå¹¶ä¸”ç»„åˆçš„å€¼ä¸å…è®¸é‡å¤ã€‚ </li><li>MySQLçš„ä¸»é”®åæ€»æ˜¯PRIMARYï¼Œå°±ç®—è‡ªå·±å‘½åäº†ä¸»é”®çº¦æŸåä¹Ÿæ²¡ç”¨ã€‚ </li><li>å½“åˆ›å»ºä¸»é”®çº¦æŸæ—¶ï¼Œç³»ç»Ÿé»˜è®¤ä¼šåœ¨æ‰€åœ¨çš„åˆ—æˆ–åˆ—ç»„åˆä¸Šå»ºç«‹å¯¹åº”çš„ä¸»é”®ç´¢å¼•ï¼ˆèƒ½å¤Ÿæ ¹æ®ä¸»é”®æŸ¥è¯¢çš„ï¼Œå°±æ ¹æ®ä¸»é”®æŸ¥è¯¢ï¼Œæ•ˆç‡æ›´é«˜ã€‚å¦‚æœåˆ é™¤ä¸»é”®çº¦æŸäº†ï¼Œä¸»é”®çº¦æŸå¯¹åº”çš„ç´¢å¼•å°±è‡ªåŠ¨åˆ é™¤äº†ã€‚ </li><li>éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼Œä¸è¦ä¿®æ”¹ä¸»é”®å­—æ®µçš„å€¼ã€‚å› ä¸ºä¸»é”®æ˜¯æ•°æ®è®°å½•çš„å”¯ä¸€æ ‡è¯†ï¼Œå¦‚æœä¿®æ”¹äº†ä¸»é”®çš„å€¼ï¼Œå°±æœ‰å¯èƒ½ä¼šç ´åæ•°æ®çš„å®Œæ•´æ€§ã€‚</li></ul><h3 id="4-æ·»åŠ ä¸»é”®çº¦æŸ"><a href="#4-æ·»åŠ ä¸»é”®çº¦æŸ" class="headerlink" title="4) æ·»åŠ ä¸»é”®çº¦æŸ"></a>4) æ·»åŠ ä¸»é”®çº¦æŸ</h3><p><strong>1. å»ºè¡¨æ—¶æŒ‡å®šä¸»é”®çº¦æŸ</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">create table è¡¨åç§°(</span><br><span class="line">å­—æ®µå æ•°æ®ç±»å‹ primary key, #åˆ—çº§æ¨¡å¼</span><br><span class="line">å­—æ®µå æ•°æ®ç±»å‹,</span><br><span class="line">å­—æ®µå æ•°æ®ç±»å‹</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">create table è¡¨åç§°(</span><br><span class="line">å­—æ®µå æ•°æ®ç±»å‹,</span><br><span class="line">å­—æ®µå æ•°æ®ç±»å‹,</span><br><span class="line">å­—æ®µå æ•°æ®ç±»å‹,</span><br><span class="line">[constraint çº¦æŸå] primary key(å­—æ®µå) #è¡¨çº§æ¨¡å¼</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p><strong>2. å»ºè¡¨åå¢åŠ ä¸»é”®çº¦æŸ</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ALTER TABLE è¡¨åç§° ADD PRIMARY KEY(å­—æ®µåˆ—è¡¨); #å­—æ®µåˆ—è¡¨å¯ä»¥æ˜¯ä¸€ä¸ªå­—æ®µï¼Œä¹Ÿå¯ä»¥æ˜¯å¤šä¸ªå­—æ®µï¼Œå¦‚æœæ˜¯å¤šä¸ªå­—æ®µçš„è¯ï¼Œæ˜¯å¤åˆä¸»é”®</span><br></pre></td></tr></table></figure><h3 id="5-å…³äºå¤åˆä¸»é”®"><a href="#5-å…³äºå¤åˆä¸»é”®" class="headerlink" title="5) å…³äºå¤åˆä¸»é”®"></a>5) å…³äºå¤åˆä¸»é”®</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">create table è¡¨åç§°(</span><br><span class="line">å­—æ®µå æ•°æ®ç±»å‹,</span><br><span class="line">å­—æ®µå æ•°æ®ç±»å‹,</span><br><span class="line">å­—æ®µå æ•°æ®ç±»å‹,</span><br><span class="line">primary key(å­—æ®µå1,å­—æ®µå2) #è¡¨ç¤ºå­—æ®µ1å’Œå­—æ®µ2çš„ç»„åˆæ˜¯å”¯ä¸€çš„ï¼Œä¹Ÿå¯ä»¥æœ‰æ›´å¤šä¸ªå­—æ®µ</span><br><span class="line">);</span><br></pre></td></tr></table></figure><h3 id="6-åˆ é™¤ä¸»é”®çº¦æŸ"><a href="#6-åˆ é™¤ä¸»é”®çº¦æŸ" class="headerlink" title="6) åˆ é™¤ä¸»é”®çº¦æŸ"></a>6) åˆ é™¤ä¸»é”®çº¦æŸ</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alter table è¡¨åç§° drop primary key</span><br></pre></td></tr></table></figure><blockquote><p>è¯´æ˜ï¼šåˆ é™¤ä¸»é”®çº¦æŸï¼Œä¸éœ€è¦æŒ‡å®šä¸»é”®åï¼Œå› ä¸ºä¸€ä¸ªè¡¨åªæœ‰ä¸€ä¸ªä¸»é”®ï¼Œåˆ é™¤ä¸»é”®çº¦æŸåï¼Œéç©ºè¿˜å­˜åœ¨ã€‚</p></blockquote><h2 id="5-è‡ªå¢åˆ—ï¼šAUTO-INCREMENT"><a href="#5-è‡ªå¢åˆ—ï¼šAUTO-INCREMENT" class="headerlink" title="5. è‡ªå¢åˆ—ï¼šAUTO_INCREMENT"></a>5. è‡ªå¢åˆ—ï¼šAUTO_INCREMENT</h2><h3 id="1-ä½œç”¨-3"><a href="#1-ä½œç”¨-3" class="headerlink" title="1) ä½œç”¨"></a>1) ä½œç”¨</h3><p>æŸä¸ªå­—æ®µçš„å€¼è‡ªå¢</p><h3 id="2-å…³é”®å­—-3"><a href="#2-å…³é”®å­—-3" class="headerlink" title="2) å…³é”®å­—"></a>2) å…³é”®å­—</h3><p>auto_increment</p><h3 id="3-ç‰¹ç‚¹-3"><a href="#3-ç‰¹ç‚¹-3" class="headerlink" title="3) ç‰¹ç‚¹"></a>3) ç‰¹ç‚¹</h3><p>ï¼ˆ1ï¼‰ä¸€ä¸ªè¡¨æœ€å¤šåªèƒ½æœ‰ä¸€ä¸ªè‡ªå¢é•¿åˆ— </p><p>ï¼ˆ2ï¼‰å½“éœ€è¦äº§ç”Ÿå”¯ä¸€æ ‡è¯†ç¬¦æˆ–é¡ºåºå€¼æ—¶ï¼Œå¯è®¾ç½®è‡ªå¢é•¿ </p><p>ï¼ˆ3ï¼‰è‡ªå¢é•¿åˆ—çº¦æŸçš„åˆ—å¿…é¡»æ˜¯é”®åˆ—ï¼ˆä¸»é”®åˆ—ï¼Œå”¯ä¸€é”®åˆ—ï¼‰ </p><p>ï¼ˆ4ï¼‰è‡ªå¢çº¦æŸçš„åˆ—çš„æ•°æ®ç±»å‹å¿…é¡»æ˜¯æ•´æ•°ç±»å‹ </p><p>ï¼ˆ5ï¼‰å¦‚æœè‡ªå¢åˆ—æŒ‡å®šäº† 0 å’Œ nullï¼Œä¼šåœ¨å½“å‰æœ€å¤§å€¼çš„åŸºç¡€ä¸Šè‡ªå¢ï¼›å¦‚æœè‡ªå¢åˆ—æ‰‹åŠ¨æŒ‡å®šäº†å…·ä½“å€¼ï¼Œç›´æ¥èµ‹å€¼ä¸ºå…·ä½“å€¼ã€‚</p><h3 id="4-å¦‚ä½•æŒ‡å®šè‡ªå¢çº¦æŸ"><a href="#4-å¦‚ä½•æŒ‡å®šè‡ªå¢çº¦æŸ" class="headerlink" title="4) å¦‚ä½•æŒ‡å®šè‡ªå¢çº¦æŸ"></a>4) å¦‚ä½•æŒ‡å®šè‡ªå¢çº¦æŸ</h3><p><strong>1. å»ºè¡¨æ—¶</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">create table è¡¨åç§°(</span><br><span class="line">å­—æ®µå æ•°æ®ç±»å‹ primary key auto_increment,</span><br><span class="line">å­—æ®µå æ•°æ®ç±»å‹ unique key not null,</span><br><span class="line">å­—æ®µå æ•°æ®ç±»å‹ unique key,</span><br><span class="line">å­—æ®µå æ•°æ®ç±»å‹ not null default é»˜è®¤å€¼,</span><br><span class="line">);</span><br><span class="line">create table è¡¨åç§°(</span><br><span class="line">å­—æ®µå æ•°æ®ç±»å‹ default é»˜è®¤å€¼ ,</span><br><span class="line">å­—æ®µå æ•°æ®ç±»å‹ unique key auto_increment,</span><br><span class="line">å­—æ®µå æ•°æ®ç±»å‹ not null default é»˜è®¤å€¼,</span><br><span class="line">primary key(å­—æ®µå)</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p><strong>2. å»ºè¡¨å</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">alter table è¡¨åç§° modify å­—æ®µå æ•°æ®ç±»å‹ auto_increment;</span><br></pre></td></tr></table></figure><h3 id="5-åˆ é™¤è‡ªå¢çº¦æŸ"><a href="#5-åˆ é™¤è‡ªå¢çº¦æŸ" class="headerlink" title="5) åˆ é™¤è‡ªå¢çº¦æŸ"></a>5) åˆ é™¤è‡ªå¢çº¦æŸ</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#alter table è¡¨åç§° modify å­—æ®µå æ•°æ®ç±»å‹ auto_increment;#ç»™è¿™ä¸ªå­—æ®µå¢åŠ è‡ªå¢çº¦æŸ</span><br><span class="line">alter table è¡¨åç§° modify å­—æ®µå æ•°æ®ç±»å‹; #å»æ‰auto_incrementç›¸å½“äºåˆ é™¤</span><br></pre></td></tr></table></figure><h3 id="6-MySQL-8-0æ–°ç‰¹æ€§â€”è‡ªå¢å˜é‡çš„æŒä¹…åŒ–"><a href="#6-MySQL-8-0æ–°ç‰¹æ€§â€”è‡ªå¢å˜é‡çš„æŒä¹…åŒ–" class="headerlink" title="6) MySQL 8.0æ–°ç‰¹æ€§â€”è‡ªå¢å˜é‡çš„æŒä¹…åŒ–"></a>6) MySQL 8.0æ–°ç‰¹æ€§â€”è‡ªå¢å˜é‡çš„æŒä¹…åŒ–</h3><p>åœ¨MySQL 8.0ä¹‹å‰ï¼Œè‡ªå¢ä¸»é”®AUTO_INCREMENTçš„å€¼å¦‚æœå¤§äºmax(primary key)+1ï¼Œåœ¨MySQLé‡å¯åï¼Œä¼šé‡ç½®AUTO_INCREMENT&#x3D;max(primary key)+1ï¼Œè¿™ç§ç°è±¡åœ¨æŸäº›æƒ…å†µä¸‹ä¼šå¯¼è‡´ä¸šåŠ¡ä¸»é”®å†²çªæˆ–è€…å…¶ä»–éš¾ä»¥å‘ç°çš„é—®é¢˜ã€‚ ä¸‹é¢é€šè¿‡æ¡ˆä¾‹æ¥å¯¹æ¯”ä¸åŒçš„ç‰ˆæœ¬ä¸­è‡ªå¢å˜é‡æ˜¯å¦æŒä¹…åŒ–ã€‚ åœ¨MySQL 5.7ç‰ˆæœ¬ä¸­ï¼Œæµ‹è¯•æ­¥éª¤å¦‚ ä¸‹ï¼š åˆ›å»ºçš„æ•°æ®è¡¨ä¸­åŒ…å«è‡ªå¢ä¸»é”®çš„idå­—æ®µï¼Œè¯­å¥å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE test1(</span><br><span class="line">id INT PRIMARY KEY AUTO_INCREMENT</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>åœ¨MySQL 5.7ç³»ç»Ÿä¸­ï¼Œå¯¹äºè‡ªå¢ä¸»é”®çš„åˆ†é…è§„åˆ™ï¼Œæ˜¯ç”±InnoDBæ•°æ®å­—å…¸ å†…éƒ¨ä¸€ä¸ª è®¡æ•°å™¨ æ¥å†³å®šçš„ï¼Œè€Œè¯¥è®¡æ•°å™¨åªåœ¨ å†…å­˜ä¸­ç»´æŠ¤ ï¼Œå¹¶ä¸ä¼šæŒä¹…åŒ–åˆ°ç£ç›˜ä¸­ã€‚å½“æ•°æ®åº“é‡å¯æ—¶ï¼Œè¯¥ è®¡æ•°å™¨ä¼šè¢«åˆå§‹åŒ–ã€‚</p><p>åœ¨MySQL 8.0å°†è‡ªå¢ä¸»é”®çš„è®¡æ•°å™¨æŒä¹…åŒ–åˆ° é‡åšæ—¥å¿— ä¸­ã€‚æ¯æ¬¡è®¡æ•°å™¨å‘ç”Ÿæ”¹å˜ï¼Œéƒ½ä¼šå°†å…¶å†™å…¥é‡åšæ—¥å¿— ä¸­ã€‚å¦‚æœæ•°æ®åº“é‡å¯ï¼ŒInnoDBä¼šæ ¹æ®é‡åšæ—¥å¿—ä¸­çš„ä¿¡æ¯æ¥åˆå§‹åŒ–è®¡æ•°å™¨çš„å†…å­˜å€¼ã€‚</p><h2 id="6-FOREIGN-KEY-çº¦æŸ"><a href="#6-FOREIGN-KEY-çº¦æŸ" class="headerlink" title="6. FOREIGN KEY çº¦æŸ"></a>6. FOREIGN KEY çº¦æŸ</h2><h3 id="1-ä½œç”¨-4"><a href="#1-ä½œç”¨-4" class="headerlink" title="1) ä½œç”¨"></a>1) ä½œç”¨</h3><p>é™å®šæŸä¸ªè¡¨çš„æŸä¸ªå­—æ®µçš„å¼•ç”¨å®Œæ•´æ€§ã€‚</p><h3 id="2-å…³é”®å­—-4"><a href="#2-å…³é”®å­—-4" class="headerlink" title="2) å…³é”®å­—"></a>2) å…³é”®å­—</h3><p>FOREIGN KEY</p><h3 id="3-ä¸»è¡¨å’Œä»è¡¨-x2F-çˆ¶è¡¨å’Œå­è¡¨"><a href="#3-ä¸»è¡¨å’Œä»è¡¨-x2F-çˆ¶è¡¨å’Œå­è¡¨" class="headerlink" title="3) ä¸»è¡¨å’Œä»è¡¨&#x2F;çˆ¶è¡¨å’Œå­è¡¨"></a>3) ä¸»è¡¨å’Œä»è¡¨&#x2F;çˆ¶è¡¨å’Œå­è¡¨</h3><p>ä¸»è¡¨ï¼ˆçˆ¶è¡¨ï¼‰ï¼šè¢«å¼•ç”¨çš„è¡¨ï¼Œè¢«å‚è€ƒçš„è¡¨ </p><p>ä»è¡¨ï¼ˆå­è¡¨ï¼‰ï¼šå¼•ç”¨åˆ«äººçš„è¡¨ï¼Œå‚è€ƒåˆ«äººçš„è¡¨</p><h3 id="4-ç‰¹ç‚¹"><a href="#4-ç‰¹ç‚¹" class="headerlink" title="4) ç‰¹ç‚¹"></a>4) ç‰¹ç‚¹</h3><p>ï¼ˆ1ï¼‰ä»è¡¨çš„å¤–é”®åˆ—ï¼Œå¿…é¡»å¼•ç”¨&#x2F;å‚è€ƒä¸»è¡¨çš„ä¸»é”®æˆ–å”¯ä¸€çº¦æŸçš„åˆ—ä¸ºä»€ä¹ˆï¼Ÿå› ä¸ºè¢«ä¾èµ–&#x2F;è¢«å‚è€ƒçš„å€¼å¿…é¡»æ˜¯å”¯ä¸€çš„ </p><p>ï¼ˆ2ï¼‰åœ¨åˆ›å»ºå¤–é”®çº¦æŸæ—¶ï¼Œå¦‚æœä¸ç»™å¤–é”®çº¦æŸå‘½åï¼Œé»˜è®¤åä¸æ˜¯åˆ—åï¼Œè€Œæ˜¯è‡ªåŠ¨äº§ç”Ÿä¸€ä¸ªå¤–é”®åï¼ˆä¾‹å¦‚ student_ibfk_1;ï¼‰ï¼Œä¹Ÿå¯ä»¥æŒ‡å®šå¤–é”®çº¦æŸåã€‚ </p><p>ï¼ˆ3ï¼‰åˆ›å»º(CREATE)è¡¨æ—¶å°±æŒ‡å®šå¤–é”®çº¦æŸçš„è¯ï¼Œ<strong>å…ˆåˆ›å»ºä¸»è¡¨</strong>ï¼Œå†åˆ›å»ºä»è¡¨ </p><p>ï¼ˆ4ï¼‰åˆ è¡¨æ—¶ï¼Œ<strong>å…ˆåˆ ä»è¡¨</strong>ï¼ˆæˆ–å…ˆåˆ é™¤å¤–é”®çº¦æŸï¼‰ï¼Œå†åˆ é™¤ä¸»è¡¨ </p><p>ï¼ˆ5ï¼‰å½“ä¸»è¡¨çš„è®°å½•è¢«ä»è¡¨å‚ç…§æ—¶ï¼Œä¸»è¡¨çš„è®°å½•å°†ä¸å…è®¸åˆ é™¤ï¼Œå¦‚æœè¦åˆ é™¤æ•°æ®ï¼Œéœ€è¦å…ˆåˆ é™¤ä»è¡¨ä¸­ä¾èµ–è¯¥è®°å½•çš„æ•°æ®ï¼Œç„¶åæ‰å¯ä»¥åˆ é™¤ä¸»è¡¨çš„æ•°æ® </p><p>ï¼ˆ6ï¼‰åœ¨â€œä»è¡¨â€ä¸­æŒ‡å®šå¤–é”®çº¦æŸï¼Œå¹¶ä¸”ä¸€ä¸ªè¡¨å¯ä»¥å»ºç«‹å¤šä¸ªå¤–é”®çº¦æŸ </p><p>ï¼ˆ7ï¼‰ä»è¡¨çš„å¤–é”®åˆ—ä¸ä¸»è¡¨è¢«å‚ç…§çš„åˆ—åå­—å¯ä»¥ä¸ç›¸åŒï¼Œä½†æ˜¯æ•°æ®ç±»å‹å¿…é¡»ä¸€æ ·ï¼Œé€»è¾‘æ„ä¹‰ä¸€è‡´ã€‚å¦‚æœç±»å‹ä¸ä¸€æ ·ï¼Œåˆ›å»ºå­è¡¨æ—¶ï¼Œå°±ä¼šå‡ºç°é”™è¯¯â€œERROR 1005 (HY000): Canâ€™t create tableâ€™database.tablenameâ€™(errno: 150)â€ã€‚ ä¾‹å¦‚ï¼šéƒ½æ˜¯è¡¨ç¤ºéƒ¨é—¨ç¼–å·ï¼Œéƒ½æ˜¯intç±»å‹ã€‚</p><p>ï¼ˆ8ï¼‰å½“åˆ›å»ºå¤–é”®çº¦æŸæ—¶ï¼Œç³»ç»Ÿé»˜è®¤ä¼šåœ¨æ‰€åœ¨çš„åˆ—ä¸Šå»ºç«‹å¯¹åº”çš„æ™®é€šç´¢å¼•ã€‚ä½†æ˜¯ç´¢å¼•åæ˜¯å¤–é”®çš„çº¦æŸåã€‚ï¼ˆæ ¹æ®å¤–é”®æŸ¥è¯¢æ•ˆç‡å¾ˆé«˜ï¼‰ </p><p>ï¼ˆ9ï¼‰åˆ é™¤å¤–é”®çº¦æŸåï¼Œå¿…é¡»æ‰‹åŠ¨åˆ é™¤å¯¹åº”çš„ç´¢å¼•</p><h3 id="5-æ·»åŠ å¤–é”®çº¦æŸ"><a href="#5-æ·»åŠ å¤–é”®çº¦æŸ" class="headerlink" title="5) æ·»åŠ å¤–é”®çº¦æŸ"></a>5) æ·»åŠ å¤–é”®çº¦æŸ</h3><p><strong>1. å»ºè¡¨æ—¶</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">create table ä¸»è¡¨åç§°(</span><br><span class="line">å­—æ®µ1 æ•°æ®ç±»å‹ primary key,</span><br><span class="line">å­—æ®µ2 æ•°æ®ç±»å‹</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">create table ä»è¡¨åç§°(</span><br><span class="line">å­—æ®µ1 æ•°æ®ç±»å‹ primary key,</span><br><span class="line">å­—æ®µ2 æ•°æ®ç±»å‹,</span><br><span class="line">[CONSTRAINT &lt;å¤–é”®çº¦æŸåç§°&gt;] FOREIGN KEYï¼ˆä»è¡¨çš„æŸä¸ªå­—æ®µ) references ä¸»è¡¨å(è¢«å‚è€ƒå­—æ®µ)</span><br><span class="line">);</span><br><span class="line">#(ä»è¡¨çš„æŸä¸ªå­—æ®µ)çš„æ•°æ®ç±»å‹å¿…é¡»ä¸ä¸»è¡¨å(è¢«å‚è€ƒå­—æ®µ)çš„æ•°æ®ç±»å‹ä¸€è‡´ï¼Œé€»è¾‘æ„ä¹‰ä¹Ÿä¸€æ ·</span><br><span class="line">#(ä»è¡¨çš„æŸä¸ªå­—æ®µ)çš„å­—æ®µåå¯ä»¥ä¸ä¸»è¡¨å(è¢«å‚è€ƒå­—æ®µ)çš„å­—æ®µåä¸€æ ·ï¼Œä¹Ÿå¯ä»¥ä¸ä¸€æ ·</span><br><span class="line">-- FOREIGN KEY: åœ¨è¡¨çº§æŒ‡å®šå­è¡¨ä¸­çš„åˆ—</span><br><span class="line">-- REFERENCES: æ ‡ç¤ºåœ¨çˆ¶è¡¨ä¸­çš„åˆ—</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">create table dept( #ä¸»è¡¨</span><br><span class="line">did int primary key, #éƒ¨é—¨ç¼–å·</span><br><span class="line">dname varchar(50) #éƒ¨é—¨åç§°</span><br><span class="line">);</span><br><span class="line">create table emp(#ä»è¡¨</span><br><span class="line">eid int primary key, #å‘˜å·¥ç¼–å·</span><br><span class="line">ename varchar(5), #å‘˜å·¥å§“å</span><br><span class="line">deptid int, #å‘˜å·¥æ‰€åœ¨çš„éƒ¨é—¨</span><br><span class="line">foreign key (deptid) references dept(did) #åœ¨ä»è¡¨ä¸­æŒ‡å®šå¤–é”®çº¦æŸ</span><br><span class="line">#empè¡¨çš„deptidå’Œå’Œdeptè¡¨çš„didçš„æ•°æ®ç±»å‹ä¸€è‡´ï¼Œæ„ä¹‰éƒ½æ˜¯è¡¨ç¤ºéƒ¨é—¨çš„ç¼–å·</span><br><span class="line">);</span><br><span class="line">è¯´æ˜ï¼š</span><br><span class="line">ï¼ˆ1ï¼‰ä¸»è¡¨deptå¿…é¡»å…ˆåˆ›å»ºæˆåŠŸï¼Œç„¶åæ‰èƒ½åˆ›å»ºempè¡¨ï¼ŒæŒ‡å®šå¤–é”®æˆåŠŸã€‚</span><br><span class="line">ï¼ˆ2ï¼‰åˆ é™¤è¡¨æ—¶ï¼Œå…ˆåˆ é™¤ä»è¡¨empï¼Œå†åˆ é™¤ä¸»è¡¨dept</span><br></pre></td></tr></table></figure><p><strong>2. å»ºè¡¨å</strong></p><p>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œè¡¨ä¸è¡¨çš„å…³è”éƒ½æ˜¯æå‰è®¾è®¡å¥½äº†çš„ï¼Œå› æ­¤ï¼Œä¼šåœ¨åˆ›å»ºè¡¨çš„æ—¶å€™å°±æŠŠå¤–é”®çº¦æŸå®šä¹‰å¥½ã€‚ä¸ è¿‡ï¼Œå¦‚æœéœ€è¦ä¿®æ”¹è¡¨çš„è®¾è®¡ï¼ˆæ¯”å¦‚æ·»åŠ æ–°çš„å­—æ®µï¼Œå¢åŠ æ–°çš„å…³è”å…³ç³»ï¼‰ï¼Œä½†æ²¡æœ‰é¢„å…ˆå®šä¹‰å¤–é”®çº¦æŸï¼Œé‚£ ä¹ˆï¼Œå°±è¦ç”¨ä¿®æ”¹è¡¨çš„æ–¹å¼æ¥è¡¥å……å®šä¹‰ã€‚</p><p>æ ¼å¼ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ALTER TABLE ä»è¡¨å ADD [CONSTRAINT çº¦æŸå] FOREIGN KEY (ä»è¡¨çš„å­—æ®µ) REFERENCES ä¸»è¡¨å(è¢«å¼•ç”¨å­—æ®µ) [on update xx][on delete xx];</span><br></pre></td></tr></table></figure><p>ä¸¾ä¾‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ALTER TABLE emp1</span><br><span class="line">ADD [CONSTRAINT emp_dept_id_fk] FOREIGN KEY(dept_id) REFERENCES dept(dept_id);</span><br></pre></td></tr></table></figure><h3 id="6-çº¦æŸç­‰çº§"><a href="#6-çº¦æŸç­‰çº§" class="headerlink" title="6) çº¦æŸç­‰çº§"></a>6) çº¦æŸç­‰çº§</h3><ul><li><code>Cascadeæ–¹å¼ </code>ï¼šåœ¨çˆ¶è¡¨ä¸Šupdate&#x2F;deleteè®°å½•æ—¶ï¼ŒåŒæ­¥update&#x2F;deleteæ‰å­è¡¨çš„åŒ¹é…è®°å½• </li><li><code>Set nullæ–¹å¼</code> ï¼šåœ¨çˆ¶è¡¨ä¸Šupdate&#x2F;deleteè®°å½•æ—¶ï¼Œå°†å­è¡¨ä¸ŠåŒ¹é…è®°å½•çš„åˆ—è®¾ä¸ºnullï¼Œä½†æ˜¯è¦æ³¨æ„å­ è¡¨çš„å¤–é”®åˆ—ä¸èƒ½ä¸ºnot null </li><li><code>No actionæ–¹å¼</code> ï¼šå¦‚æœå­è¡¨ä¸­æœ‰åŒ¹é…çš„è®°å½•ï¼Œåˆ™ä¸å…è®¸å¯¹çˆ¶è¡¨å¯¹åº”å€™é€‰é”®è¿›è¡Œupdate&#x2F;deleteæ“ä½œ </li><li><code>Restrictæ–¹å¼</code> ï¼šåŒno actionï¼Œ éƒ½æ˜¯ç«‹å³æ£€æŸ¥å¤–é”®çº¦æŸ </li><li><code>Set defaultæ–¹å¼</code> ï¼ˆåœ¨å¯è§†åŒ–å·¥å…·SQLyogä¸­å¯èƒ½æ˜¾ç¤ºç©ºç™½ï¼‰ï¼šçˆ¶è¡¨æœ‰å˜æ›´æ—¶ï¼Œå­è¡¨å°†å¤–é”®åˆ—è®¾ç½® æˆä¸€ä¸ªé»˜è®¤çš„å€¼ï¼Œä½†Innodbä¸èƒ½è¯†åˆ«x</li></ul><p>å¦‚æœæ²¡æœ‰æŒ‡å®šç­‰çº§ï¼Œå°±ç›¸å½“äºRestrictæ–¹å¼ã€‚ å¯¹äºå¤–é”®çº¦æŸï¼Œæœ€å¥½æ˜¯é‡‡ç”¨: ON UPDATE CASCADE ON DELETE RESTRICT çš„æ–¹å¼ã€‚</p><h3 id="7-åˆ é™¤å¤–é”®çº¦æŸ"><a href="#7-åˆ é™¤å¤–é”®çº¦æŸ" class="headerlink" title="7) åˆ é™¤å¤–é”®çº¦æŸ"></a>7) åˆ é™¤å¤–é”®çº¦æŸ</h3><p>æµç¨‹å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">(1)ç¬¬ä¸€æ­¥å…ˆæŸ¥çœ‹çº¦æŸåå’Œåˆ é™¤å¤–é”®çº¦æŸ</span><br><span class="line">SELECT * FROM information_schema.table_constraints WHERE table_name = &#x27;è¡¨åç§°&#x27;;  #æŸ¥çœ‹æŸä¸ªè¡¨çš„çº¦æŸå</span><br><span class="line">ALTER TABLE ä»è¡¨å DROP FOREIGN KEY å¤–é”®çº¦æŸå;</span><br><span class="line"></span><br><span class="line">ï¼ˆ2ï¼‰ç¬¬äºŒæ­¥æŸ¥çœ‹ç´¢å¼•åå’Œåˆ é™¤ç´¢å¼•ã€‚ï¼ˆæ³¨æ„ï¼Œåªèƒ½æ‰‹åŠ¨åˆ é™¤ï¼‰</span><br><span class="line">SHOW INDEX FROM è¡¨åç§°; #æŸ¥çœ‹æŸä¸ªè¡¨çš„ç´¢å¼•å</span><br><span class="line">ALTER TABLE ä»è¡¨å DROP INDEX ç´¢å¼•å;</span><br></pre></td></tr></table></figure><h3 id="8-å¼€å‘åœºæ™¯"><a href="#8-å¼€å‘åœºæ™¯" class="headerlink" title="8) å¼€å‘åœºæ™¯"></a>8) å¼€å‘åœºæ™¯</h3><p><strong>é—®é¢˜1ï¼šå¦‚æœä¸¤ä¸ªè¡¨ä¹‹é—´æœ‰å…³ç³»ï¼ˆä¸€å¯¹ä¸€ã€ä¸€å¯¹å¤šï¼‰ï¼Œæ¯”å¦‚ï¼šå‘˜å·¥è¡¨å’Œéƒ¨é—¨è¡¨ï¼ˆä¸€å¯¹å¤šï¼‰ï¼Œå®ƒä»¬ä¹‹é—´æ˜¯å¦ ä¸€å®šè¦å»ºå¤–é”®çº¦æŸï¼Ÿ</strong></p><p>ç­”ï¼šä¸æ˜¯çš„</p><p><strong>é—®é¢˜2ï¼šå»ºå’Œä¸å»ºå¤–é”®çº¦æŸæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</strong></p><p>ç­”ï¼šå»ºå¤–é”®çº¦æŸï¼Œä½ çš„æ“ä½œï¼ˆåˆ›å»ºè¡¨ã€åˆ é™¤è¡¨ã€æ·»åŠ ã€ä¿®æ”¹ã€åˆ é™¤ï¼‰ä¼šå—åˆ°é™åˆ¶ï¼Œä»è¯­æ³•å±‚é¢å—åˆ°é™ åˆ¶ã€‚ä¾‹å¦‚ï¼šåœ¨å‘˜å·¥è¡¨ä¸­ä¸å¯èƒ½æ·»åŠ ä¸€ä¸ªå‘˜å·¥ä¿¡æ¯ï¼Œå®ƒçš„éƒ¨é—¨çš„å€¼åœ¨éƒ¨é—¨è¡¨ä¸­æ‰¾ä¸åˆ°ã€‚ </p><p>ä¸å»ºå¤–é”®çº¦æŸï¼Œä½ çš„æ“ä½œï¼ˆåˆ›å»ºè¡¨ã€åˆ é™¤è¡¨ã€æ·»åŠ ã€ä¿®æ”¹ã€åˆ é™¤ï¼‰ä¸å—é™åˆ¶ï¼Œè¦ä¿è¯æ•°æ®çš„ å¼•ç”¨å®Œæ•´ æ€§ ï¼Œåªèƒ½ä¾é ç¨‹åºå‘˜çš„è‡ªè§‰ ï¼Œæˆ–è€…æ˜¯ åœ¨Javaç¨‹åºä¸­è¿›è¡Œé™å®š ã€‚ä¾‹å¦‚ï¼šåœ¨å‘˜å·¥è¡¨ä¸­ï¼Œå¯ä»¥æ·»åŠ ä¸€ä¸ªå‘˜å·¥çš„ ä¿¡æ¯ï¼Œå®ƒçš„éƒ¨é—¨æŒ‡å®šä¸ºä¸€ä¸ªå®Œå…¨ä¸å­˜åœ¨çš„éƒ¨é—¨ã€‚</p><p><strong>é—®é¢˜3ï¼šé‚£ä¹ˆå»ºå’Œä¸å»ºå¤–é”®çº¦æŸå’ŒæŸ¥è¯¢æœ‰æ²¡æœ‰å…³ç³»ï¼Ÿ</strong></p><p>ç­”ï¼šæ²¡æœ‰</p><blockquote><p>åœ¨ MySQL é‡Œï¼Œå¤–é”®çº¦æŸæ˜¯æœ‰æˆæœ¬çš„ï¼Œéœ€è¦æ¶ˆè€—ç³»ç»Ÿèµ„æºã€‚å¯¹äºå¤§å¹¶å‘çš„ SQL æ“ä½œï¼Œæœ‰å¯èƒ½ä¼šä¸é€‚åˆã€‚æ¯”å¦‚å¤§å‹ç½‘ç«™çš„ä¸­å¤®æ•°æ®åº“ï¼Œå¯èƒ½ä¼šå› ä¸ºå¤–é”®çº¦æŸçš„ç³»ç»Ÿå¼€é”€è€Œå˜å¾—éå¸¸æ…¢ ã€‚æ‰€ä»¥ï¼Œ MySQL å…è®¸ä½ ä¸ä½¿ç”¨ç³»ç»Ÿè‡ªå¸¦çš„å¤–é”®çº¦æŸï¼Œåœ¨ åº”ç”¨å±‚é¢ å®Œæˆæ£€æŸ¥æ•°æ®ä¸€è‡´æ€§çš„é€»è¾‘ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå³ä½¿ä½ ä¸ ç”¨å¤–é”®çº¦æŸï¼Œä¹Ÿè¦æƒ³åŠæ³•é€šè¿‡åº”ç”¨å±‚é¢çš„é™„åŠ é€»è¾‘ï¼Œæ¥å®ç°å¤–é”®çº¦æŸçš„åŠŸèƒ½ï¼Œç¡®ä¿æ•°æ®çš„ä¸€è‡´æ€§ã€‚</p></blockquote><h3 id="9-é˜¿é‡Œå¼€å‘è§„èŒƒ"><a href="#9-é˜¿é‡Œå¼€å‘è§„èŒƒ" class="headerlink" title="9)  é˜¿é‡Œå¼€å‘è§„èŒƒ"></a>9)  é˜¿é‡Œå¼€å‘è§„èŒƒ</h3><p>ã€ å¼ºåˆ¶ ã€‘ä¸å¾—ä½¿ç”¨å¤–é”®ä¸çº§è”ï¼Œä¸€åˆ‡å¤–é”®æ¦‚å¿µå¿…é¡»åœ¨åº”ç”¨å±‚è§£å†³ã€‚ </p><p>è¯´æ˜ï¼šï¼ˆæ¦‚å¿µè§£é‡Šï¼‰å­¦ç”Ÿè¡¨ä¸­çš„ student_id æ˜¯ä¸»é”®ï¼Œé‚£ä¹ˆæˆç»©è¡¨ä¸­çš„ student_id åˆ™ä¸ºå¤–é”®ã€‚å¦‚æœæ›´æ–°å­¦ ç”Ÿè¡¨ä¸­çš„ student_idï¼ŒåŒæ—¶è§¦å‘æˆç»©è¡¨ä¸­çš„ student_id æ›´æ–°ï¼Œå³ä¸ºçº§è”æ›´æ–°ã€‚å¤–é”®ä¸çº§è”æ›´æ–°é€‚ç”¨äº å• æœºä½å¹¶å‘ ï¼Œä¸é€‚åˆ åˆ†å¸ƒå¼ ã€ é«˜å¹¶å‘é›†ç¾¤ ï¼›çº§è”æ›´æ–°æ˜¯å¼ºé˜»å¡ï¼Œå­˜åœ¨æ•°æ®åº“ æ›´æ–°é£æš´ çš„é£é™©ï¼›å¤–é”®å½±å“ æ•°æ®åº“çš„ æ’å…¥é€Ÿåº¦ ã€‚</p><h2 id="7-CHECK-çº¦æŸ"><a href="#7-CHECK-çº¦æŸ" class="headerlink" title="7. CHECK çº¦æŸ"></a>7. CHECK çº¦æŸ</h2><h3 id="1-ä½œç”¨-5"><a href="#1-ä½œç”¨-5" class="headerlink" title="1) ä½œç”¨"></a>1) ä½œç”¨</h3><p>æ£€æŸ¥æŸä¸ªå­—æ®µçš„å€¼æ˜¯å¦ç¬¦å·xxè¦æ±‚ï¼Œä¸€èˆ¬æŒ‡çš„æ˜¯å€¼çš„èŒƒå›´</p><h3 id="2-å…³é”®å­—-5"><a href="#2-å…³é”®å­—-5" class="headerlink" title="2) å…³é”®å­—"></a>2) å…³é”®å­—</h3><p>CHECK</p><h3 id="3-è¯´æ˜"><a href="#3-è¯´æ˜" class="headerlink" title="3) è¯´æ˜"></a>3) è¯´æ˜</h3><p>MySQL5.7 å¯ä»¥ä½¿ç”¨checkçº¦æŸï¼Œä½†checkçº¦æŸå¯¹æ•°æ®éªŒè¯æ²¡æœ‰ä»»ä½•ä½œç”¨ã€‚æ·»åŠ æ•°æ®æ—¶ï¼Œæ²¡æœ‰ä»»ä½•é”™è¯¯æˆ–è­¦å‘Š</p><p>ä½†æ˜¯<strong>MySQL 8.0ä¸­å¯ä»¥ä½¿ç”¨checkçº¦æŸäº†</strong>ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">create table employee(</span><br><span class="line">eid int primary key,</span><br><span class="line">ename varchar(5),</span><br><span class="line">gender char check (&#x27;ç”·&#x27; or &#x27;å¥³&#x27;)</span><br><span class="line">);</span><br></pre></td></tr></table></figure><h2 id="8-DEFAULTçº¦æŸ"><a href="#8-DEFAULTçº¦æŸ" class="headerlink" title="8. DEFAULTçº¦æŸ"></a>8. DEFAULTçº¦æŸ</h2><h3 id="1-ä½œç”¨-6"><a href="#1-ä½œç”¨-6" class="headerlink" title="1) ä½œç”¨"></a>1) ä½œç”¨</h3><p>ç»™æŸä¸ªå­—æ®µ&#x2F;æŸåˆ—æŒ‡å®šé»˜è®¤å€¼ï¼Œä¸€æ—¦è®¾ç½®é»˜è®¤å€¼ï¼Œåœ¨æ’å…¥æ•°æ®æ—¶ï¼Œå¦‚æœæ­¤å­—æ®µæ²¡æœ‰æ˜¾å¼èµ‹å€¼ï¼Œåˆ™èµ‹å€¼ä¸ºé»˜è®¤å€¼ã€‚</p><h3 id="2-å…³é”®å­—-6"><a href="#2-å…³é”®å­—-6" class="headerlink" title="2) å…³é”®å­—"></a>2) å…³é”®å­—</h3><p>DEFAULT</p><h3 id="3-æ·»åŠ é»˜è®¤å€¼"><a href="#3-æ·»åŠ é»˜è®¤å€¼" class="headerlink" title="3) æ·»åŠ é»˜è®¤å€¼"></a>3) æ·»åŠ é»˜è®¤å€¼</h3><p><strong>1. å»ºè¡¨æ—¶</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">create table è¡¨åç§°(</span><br><span class="line">å­—æ®µå æ•°æ®ç±»å‹ primary key,</span><br><span class="line">å­—æ®µå æ•°æ®ç±»å‹ unique key not null,</span><br><span class="line">å­—æ®µå æ•°æ®ç±»å‹ unique key,</span><br><span class="line">å­—æ®µå æ•°æ®ç±»å‹ not null default é»˜è®¤å€¼,</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p><strong>2. å»ºè¡¨å</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">alter table è¡¨åç§° modify å­—æ®µå æ•°æ®ç±»å‹ default é»˜è®¤å€¼;</span><br><span class="line">#å¦‚æœè¿™ä¸ªå­—æ®µåŸæ¥æœ‰éç©ºçº¦æŸï¼Œä½ è¿˜ä¿ç•™éç©ºçº¦æŸï¼Œé‚£ä¹ˆåœ¨åŠ é»˜è®¤å€¼çº¦æŸæ—¶ï¼Œè¿˜å¾—ä¿ç•™éç©ºçº¦æŸï¼Œå¦åˆ™éç©ºçº¦æŸå°±è¢«åˆ é™¤äº†</span><br><span class="line">#åŒç†ï¼Œåœ¨ç»™æŸä¸ªå­—æ®µåŠ éç©ºçº¦æŸä¹Ÿä¸€æ ·ï¼Œå¦‚æœè¿™ä¸ªå­—æ®µåŸæ¥æœ‰é»˜è®¤å€¼çº¦æŸï¼Œä½ æƒ³ä¿ç•™ï¼Œä¹Ÿè¦åœ¨modifyè¯­å¥ä¸­ä¿ç•™é»˜è®¤å€¼çº¦æŸï¼Œå¦åˆ™å°±åˆ é™¤äº†</span><br><span class="line">alter table è¡¨åç§° modify å­—æ®µå æ•°æ®ç±»å‹ default é»˜è®¤å€¼ not null;</span><br></pre></td></tr></table></figure><p><strong>åˆ é™¤é»˜è®¤å€¼</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">alter table è¡¨åç§° modify å­—æ®µå æ•°æ®ç±»å‹; #åˆ é™¤é»˜è®¤å€¼çº¦æŸï¼Œä¹Ÿä¸ä¿ç•™éç©ºçº¦æŸ</span><br><span class="line">alter table è¡¨åç§° modify å­—æ®µå æ•°æ®ç±»å‹ not null; #åˆ é™¤é»˜è®¤å€¼çº¦æŸï¼Œä¿ç•™éç©ºçº¦æŸ</span><br></pre></td></tr></table></figure><h2 id="9-é¢è¯•"><a href="#9-é¢è¯•" class="headerlink" title="9. é¢è¯•"></a>9. é¢è¯•</h2><p><strong>é¢è¯•1ã€ä¸ºä»€ä¹ˆå»ºè¡¨æ—¶ï¼ŒåŠ  not null default â€˜â€™ æˆ– default 0</strong></p><p>ç­”ï¼šä¸æƒ³è®©è¡¨ä¸­å‡ºç°nullå€¼ã€‚</p><p><strong>é¢è¯•2ã€ä¸ºä»€ä¹ˆä¸æƒ³è¦ null çš„å€¼</strong></p><p>ç­”:</p><p>ï¼ˆ1ï¼‰ä¸å¥½æ¯”è¾ƒã€‚nullæ˜¯ä¸€ç§ç‰¹æ®Šå€¼ï¼Œæ¯”è¾ƒæ—¶åªèƒ½ç”¨ä¸“é—¨çš„is null å’Œ is not nullæ¥æ¯”è¾ƒã€‚ç¢°åˆ°è¿ç®—ç¬¦ï¼Œé€š å¸¸è¿”å›nullã€‚ </p><p>ï¼ˆ2ï¼‰æ•ˆç‡ä¸é«˜ã€‚å½±å“æé«˜ç´¢å¼•æ•ˆæœã€‚å› æ­¤ï¼Œæˆ‘ä»¬å¾€å¾€åœ¨å»ºè¡¨æ—¶ not null default â€˜â€™ æˆ– default 0</p><p><strong>é¢è¯•3ã€å¸¦AUTO_INCREMENTçº¦æŸçš„å­—æ®µå€¼æ˜¯ä»1å¼€å§‹çš„å—ï¼Ÿ</strong></p><p>åœ¨MySQLä¸­ï¼Œé»˜è®¤AUTO_INCREMENTçš„åˆå§‹ å€¼æ˜¯1ï¼Œæ¯æ–°å¢ä¸€æ¡è®°å½•ï¼Œå­—æ®µå€¼è‡ªåŠ¨åŠ 1ã€‚è®¾ç½®è‡ªå¢å±æ€§ï¼ˆAUTO_INCREMENTï¼‰çš„æ—¶å€™ï¼Œè¿˜å¯ä»¥æŒ‡å®šç¬¬ ä¸€æ¡æ’å…¥è®°å½•çš„è‡ªå¢å­—æ®µçš„å€¼ï¼Œè¿™æ ·æ–°æ’å…¥çš„è®°å½•çš„è‡ªå¢å­—æ®µå€¼ä»åˆå§‹å€¼å¼€å§‹é€’å¢ï¼Œå¦‚åœ¨è¡¨ä¸­æ’å…¥ç¬¬ä¸€ æ¡è®°å½•ï¼ŒåŒæ—¶æŒ‡å®šidå€¼ä¸º5ï¼Œåˆ™ä»¥åæ’å…¥çš„è®°å½•çš„idå€¼å°±ä¼šä»6å¼€å§‹å¾€ä¸Šå¢åŠ ã€‚æ·»åŠ ä¸»é”®çº¦æŸæ—¶ï¼Œå¾€å¾€éœ€è¦ è®¾ç½®å­—æ®µè‡ªåŠ¨å¢åŠ å±æ€§ã€‚</p><p><strong>é¢è¯•4ã€å¹¶ä¸æ˜¯æ¯ä¸ªè¡¨éƒ½å¯ä»¥ä»»æ„é€‰æ‹©å­˜å‚¨å¼•æ“ï¼Ÿ</strong></p><p>å¤–é”®çº¦æŸï¼ˆFOREIGN KEYï¼‰ä¸èƒ½è·¨å¼•æ“ä½¿ç”¨ã€‚</p><p>MySQLæ”¯æŒå¤šç§å­˜å‚¨å¼•æ“ï¼Œæ¯ä¸€ä¸ªè¡¨éƒ½å¯ä»¥æŒ‡å®šä¸€ä¸ªä¸åŒçš„å­˜å‚¨å¼•æ“ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼šå¤–é”®çº¦æŸæ˜¯ç”¨æ¥ ä¿è¯æ•°æ®çš„å‚ç…§å®Œæ•´æ€§çš„ï¼Œå¦‚æœè¡¨ä¹‹é—´éœ€è¦å…³è”å¤–é”®ï¼Œå´æŒ‡å®šäº†ä¸åŒçš„å­˜å‚¨å¼•æ“ï¼Œé‚£ä¹ˆè¿™äº›è¡¨ä¹‹é—´æ˜¯ä¸ èƒ½åˆ›å»ºå¤–é”®çº¦æŸçš„ã€‚æ‰€ä»¥è¯´ï¼Œå­˜å‚¨å¼•æ“çš„é€‰æ‹©ä¹Ÿä¸å®Œå…¨æ˜¯éšæ„çš„ã€‚</p><h1 id="ç¬¬14ç« -è§†å›¾"><a href="#ç¬¬14ç« -è§†å›¾" class="headerlink" title="ç¬¬14ç« _è§†å›¾"></a>ç¬¬14ç« _è§†å›¾</h1><h2 id="1-å¸¸è§çš„æ•°æ®åº“å¯¹è±¡"><a href="#1-å¸¸è§çš„æ•°æ®åº“å¯¹è±¡" class="headerlink" title="1. å¸¸è§çš„æ•°æ®åº“å¯¹è±¡"></a>1. å¸¸è§çš„æ•°æ®åº“å¯¹è±¡</h2><table><thead><tr><th>å¯¹è±¡</th><th>æè¿°</th></tr></thead><tbody><tr><td>è¡¨(TABLE)</td><td>è¡¨æ˜¯å­˜å‚¨æ•°æ®çš„é€»è¾‘å•å…ƒï¼Œä»¥è¡Œå’Œåˆ—çš„å½¢å¼å­˜åœ¨ï¼Œåˆ—å°±æ˜¯å­—æ®µï¼Œè¡Œå°±æ˜¯è®°å½•</td></tr><tr><td>æ•°æ®å­—å…¸</td><td>å°±æ˜¯ç³»ç»Ÿè¡¨ï¼Œå­˜æ”¾æ•°æ®åº“ç›¸å…³ä¿¡æ¯çš„è¡¨ã€‚ç³»ç»Ÿè¡¨çš„æ•°æ®é€šå¸¸ç”±æ•°æ®åº“ç³»ç»Ÿç»´æŠ¤ï¼Œ ç¨‹åºå‘˜é€šå¸¸ä¸åº”è¯¥ä¿®æ”¹ï¼Œåªå¯æŸ¥çœ‹</td></tr><tr><td>çº¦æŸ (CONSTRAINT)</td><td>æ‰§è¡Œæ•°æ®æ ¡éªŒçš„è§„åˆ™ï¼Œç”¨äºä¿è¯æ•°æ®å®Œæ•´æ€§çš„è§„åˆ™</td></tr><tr><td>è§†å›¾(VIEW)</td><td>ä¸€ä¸ªæˆ–è€…å¤šä¸ªæ•°æ®è¡¨é‡Œçš„æ•°æ®çš„é€»è¾‘æ˜¾ç¤ºï¼Œè§†å›¾å¹¶ä¸å­˜å‚¨æ•°æ®</td></tr><tr><td>ç´¢å¼•(INDEX)</td><td>ç”¨äºæé«˜æŸ¥è¯¢æ€§èƒ½ï¼Œç›¸å½“äºä¹¦çš„ç›®å½•</td></tr><tr><td>å­˜å‚¨è¿‡ç¨‹ (PROCEDURE)</td><td>ç”¨äºå®Œæˆä¸€æ¬¡å®Œæ•´çš„ä¸šåŠ¡å¤„ç†ï¼Œæ²¡æœ‰è¿”å›å€¼ï¼Œä½†å¯é€šè¿‡ä¼ å‡ºå‚æ•°å°†å¤šä¸ªå€¼ä¼ ç»™è°ƒ ç”¨ç¯å¢ƒ</td></tr><tr><td>å­˜å‚¨å‡½æ•° (FUNCTION)</td><td>ç”¨äºå®Œæˆä¸€æ¬¡ç‰¹å®šçš„è®¡ç®—ï¼Œå…·æœ‰ä¸€ä¸ªè¿”å›å€¼</td></tr><tr><td>è§¦å‘å™¨ (TRIGGER)</td><td>ç›¸å½“äºä¸€ä¸ªäº‹ä»¶ç›‘å¬å™¨ï¼Œå½“æ•°æ®åº“å‘ç”Ÿç‰¹å®šäº‹ä»¶åï¼Œè§¦å‘å™¨è¢«è§¦å‘ï¼Œå®Œæˆç›¸åº”çš„å¤„ç†</td></tr></tbody></table><h2 id="2-è§†å›¾æ¦‚è¿°"><a href="#2-è§†å›¾æ¦‚è¿°" class="headerlink" title="2. è§†å›¾æ¦‚è¿°"></a>2. è§†å›¾æ¦‚è¿°</h2><ul><li>è§†å›¾æ˜¯ä¸€ç§ è™šæ‹Ÿè¡¨ ï¼Œæœ¬èº«æ˜¯ ä¸å…·æœ‰æ•°æ® çš„ï¼Œå ç”¨å¾ˆå°‘çš„å†…å­˜ç©ºé—´ï¼Œå®ƒæ˜¯ SQL ä¸­çš„ä¸€ä¸ªé‡è¦æ¦‚å¿µã€‚ </li><li>è§†å›¾å»ºç«‹åœ¨å·²æœ‰è¡¨çš„åŸºç¡€ä¸Š, è§†å›¾èµ–ä»¥å»ºç«‹çš„è¿™äº›è¡¨ç§°ä¸ºåŸºè¡¨ã€‚</li></ul><p><img src="/MySQL%E5%9F%BA%E7%A1%80%E7%AF%87.assets/image-20220608173721188.png" alt="image-20220608173721188"></p><ul><li>è§†å›¾çš„åˆ›å»ºå’Œåˆ é™¤åªå½±å“è§†å›¾æœ¬èº«ï¼Œä¸å½±å“å¯¹åº”çš„åŸºè¡¨ã€‚ä½†æ˜¯å½“å¯¹è§†å›¾ä¸­çš„æ•°æ®è¿›è¡Œå¢åŠ ã€åˆ é™¤å’Œ ä¿®æ”¹æ“ä½œæ—¶ï¼Œæ•°æ®è¡¨ä¸­çš„æ•°æ®ä¼šç›¸åº”åœ°å‘ç”Ÿå˜åŒ–ï¼Œåä¹‹äº¦ç„¶ã€‚</li><li>è§†å›¾æä¾›æ•°æ®å†…å®¹çš„è¯­å¥ä¸º SELECT è¯­å¥, å¯ä»¥å°†è§†å›¾ç†è§£ä¸ºå­˜å‚¨èµ·æ¥çš„ SELECT è¯­å¥ <ul><li>åœ¨æ•°æ®åº“ä¸­ï¼Œè§†å›¾ä¸ä¼šä¿å­˜æ•°æ®ï¼Œæ•°æ®çœŸæ­£ä¿å­˜åœ¨æ•°æ®è¡¨ä¸­ã€‚å½“å¯¹è§†å›¾ä¸­çš„æ•°æ®è¿›è¡Œå¢åŠ ã€åˆ  é™¤å’Œä¿®æ”¹æ“ä½œæ—¶ï¼Œæ•°æ®è¡¨ä¸­çš„æ•°æ®ä¼šç›¸åº”åœ°å‘ç”Ÿå˜åŒ–ï¼›åä¹‹äº¦ç„¶ã€‚</li></ul></li><li>è§†å›¾ï¼Œæ˜¯å‘ç”¨æˆ·æä¾›åŸºè¡¨æ•°æ®çš„å¦ä¸€ç§è¡¨ç°å½¢å¼ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œå°å‹é¡¹ç›®çš„æ•°æ®åº“å¯ä»¥ä¸ä½¿ç”¨è§† å›¾ï¼Œä½†æ˜¯åœ¨å¤§å‹é¡¹ç›®ä¸­ï¼Œä»¥åŠæ•°æ®è¡¨æ¯”è¾ƒå¤æ‚çš„æƒ…å†µä¸‹ï¼Œè§†å›¾çš„ä»·å€¼å°±å‡¸æ˜¾å‡ºæ¥äº†ï¼Œå®ƒå¯ä»¥å¸®åŠ©æˆ‘ ä»¬æŠŠç»å¸¸æŸ¥è¯¢çš„ç»“æœé›†æ”¾åˆ°è™šæ‹Ÿè¡¨ä¸­ï¼Œæå‡ä½¿ç”¨æ•ˆç‡ã€‚ç†è§£å’Œä½¿ç”¨èµ·æ¥éƒ½éå¸¸æ–¹ä¾¿ã€‚</li></ul><h2 id="3-åˆ›å»ºè§†å›¾"><a href="#3-åˆ›å»ºè§†å›¾" class="headerlink" title="3. åˆ›å»ºè§†å›¾"></a>3. åˆ›å»ºè§†å›¾</h2><ul><li>åœ¨ CREATE VIEW è¯­å¥ä¸­åµŒå…¥å­æŸ¥è¯¢</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CREATE [OR REPLACE]</span><br><span class="line">[ALGORITHM = &#123;UNDEFINED | MERGE | TEMPTABLE&#125;]</span><br><span class="line">VIEW è§†å›¾åç§° [(å­—æ®µåˆ—è¡¨)]</span><br><span class="line">AS æŸ¥è¯¢è¯­å¥</span><br><span class="line">[WITH [CASCADED|LOCAL] CHECK OPTION]</span><br></pre></td></tr></table></figure><ul><li>ç²¾ç®€ç‰ˆ</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CREATE VIEW è§†å›¾åç§°</span><br><span class="line">AS æŸ¥è¯¢è¯­å¥</span><br></pre></td></tr></table></figure><h3 id="1-åˆ›å»ºå•è¡¨è§†å›¾"><a href="#1-åˆ›å»ºå•è¡¨è§†å›¾" class="headerlink" title="1) åˆ›å»ºå•è¡¨è§†å›¾"></a>1) åˆ›å»ºå•è¡¨è§†å›¾</h3><p>ä¸¾ä¾‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># æ–¹å¼ä¸€ï¼š</span><br><span class="line">CREATE VIEW empvu80</span><br><span class="line">AS</span><br><span class="line">SELECT employee_id, last_name, salary</span><br><span class="line">FROM employees</span><br><span class="line">WHERE department_id = 80;</span><br><span class="line"></span><br><span class="line"># æ–¹å¼äºŒï¼š</span><br><span class="line">CREATE VIEW empsalary8000(emp_id, NAME, monthly_sal) # å°æ‹¬å·å†…å­—æ®µä¸ªæ•°ä¸SELECTä¸­å­—æ®µä¸ªæ•°ç›¸åŒ</span><br><span class="line">AS</span><br><span class="line">SELECT employee_id, last_name, salary</span><br><span class="line">FROM employees</span><br><span class="line">WHERE salary &gt; 8000;</span><br></pre></td></tr></table></figure><p>æŸ¥è¯¢è§†å›¾ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT *</span><br><span class="line">FROM salvu80;</span><br></pre></td></tr></table></figure><h3 id="2-åˆ›å»ºå¤šè¡¨è”åˆè§†å›¾"><a href="#2-åˆ›å»ºå¤šè¡¨è”åˆè§†å›¾" class="headerlink" title="2) åˆ›å»ºå¤šè¡¨è”åˆè§†å›¾"></a>2) åˆ›å»ºå¤šè¡¨è”åˆè§†å›¾</h3><p>ä¸¾ä¾‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CREATE VIEW empview</span><br><span class="line">AS</span><br><span class="line">SELECT employee_id emp_id,last_name NAME,department_name</span><br><span class="line">FROM employees e,departments d</span><br><span class="line">WHERE e.department_id = d.department_id;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">CREATE VIEW dept_sum_vu</span><br><span class="line">(name, minsal, maxsal, avgsal)</span><br><span class="line">AS</span><br><span class="line">SELECT d.department_name, MIN(e.salary), MAX(e.salary),AVG(e.salary)</span><br><span class="line">FROM employees e, departments d</span><br><span class="line">WHERE e.department_id = d.department_id</span><br><span class="line">GROUP BY d.department_name;</span><br></pre></td></tr></table></figure><ul><li>åˆ©ç”¨è§†å›¾å¯¹æ•°æ®è¿›è¡Œæ ¼å¼åŒ–</li></ul><p>å¸¸éœ€è¦è¾“å‡ºæŸä¸ªæ ¼å¼çš„å†…å®¹ï¼Œæ¯”å¦‚æˆ‘ä»¬æƒ³è¾“å‡ºå‘˜å·¥å§“åå’Œå¯¹åº”çš„éƒ¨é—¨åï¼Œå¯¹åº”æ ¼å¼ä¸º emp_name(department_name)ï¼Œå°±å¯ä»¥ä½¿ç”¨è§†å›¾æ¥å®Œæˆæ•°æ®æ ¼å¼åŒ–çš„æ“ä½œï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CREATE VIEW emp_depart</span><br><span class="line">AS</span><br><span class="line">SELECT CONCAT(last_name,&#x27;(&#x27;,department_name,&#x27;)&#x27;) AS emp_dept</span><br><span class="line">FROM employees e JOIN departments d</span><br><span class="line">WHERE e.department_id = d.department_id;</span><br></pre></td></tr></table></figure><h3 id="3-åŸºäºè§†å›¾åˆ›å»ºè§†å›¾"><a href="#3-åŸºäºè§†å›¾åˆ›å»ºè§†å›¾" class="headerlink" title="3) åŸºäºè§†å›¾åˆ›å»ºè§†å›¾"></a>3) åŸºäºè§†å›¾åˆ›å»ºè§†å›¾</h3><p>å½“æˆ‘ä»¬åˆ›å»ºå¥½ä¸€å¼ è§†å›¾ä¹‹åï¼Œè¿˜å¯ä»¥åœ¨å®ƒçš„åŸºç¡€ä¸Šç»§ç»­åˆ›å»ºè§†å›¾ã€‚</p><p>ä¸¾ä¾‹ï¼šè”åˆâ€œemp_deptâ€è§†å›¾å’Œâ€œemp_year_salaryâ€è§†å›¾æŸ¥è¯¢å‘˜å·¥å§“åã€éƒ¨é—¨åç§°ã€å¹´è–ªä¿¡æ¯åˆ›å»º â€œemp_dept_ysalaryâ€è§†å›¾ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CREATE VIEW emp_dept_ysalary</span><br><span class="line">AS</span><br><span class="line">SELECT emp_dept.ename,dname,year_salary</span><br><span class="line">FROM emp_dept INNER JOIN emp_year_salary</span><br><span class="line">ON emp_dept.ename = emp_year_salary.ename;</span><br></pre></td></tr></table></figure><h2 id="4-æŸ¥çœ‹è§†å›¾"><a href="#4-æŸ¥çœ‹è§†å›¾" class="headerlink" title="4. æŸ¥çœ‹è§†å›¾"></a>4. æŸ¥çœ‹è§†å›¾</h2><p>è¯­æ³•1ï¼šæŸ¥çœ‹æ•°æ®åº“çš„è¡¨å¯¹è±¡ã€è§†å›¾å¯¹è±¡</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHOW TABLES;</span><br></pre></td></tr></table></figure><p>è¯­æ³•2ï¼šæŸ¥çœ‹è§†å›¾çš„ç»“æ„</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DESC / DESCRIBE è§†å›¾åç§°;</span><br></pre></td></tr></table></figure><p>è¯­æ³•3ï¼šæŸ¥çœ‹è§†å›¾çš„å±æ€§ä¿¡æ¯</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># æŸ¥çœ‹è§†å›¾ä¿¡æ¯ï¼ˆæ˜¾ç¤ºæ•°æ®è¡¨çš„å­˜å‚¨å¼•æ“ã€ç‰ˆæœ¬ã€æ•°æ®è¡Œæ•°å’Œæ•°æ®å¤§å°ç­‰ï¼‰</span><br><span class="line">SHOW TABLE STATUS LIKE &#x27;è§†å›¾åç§°&#x27;\G</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œç»“æœæ˜¾ç¤ºï¼Œæ³¨é‡ŠCommentä¸ºVIEWï¼Œè¯´æ˜è¯¥è¡¨ä¸ºè§†å›¾ï¼Œå…¶ä»–çš„ä¿¡æ¯ä¸ºNULLï¼Œè¯´æ˜è¿™æ˜¯ä¸€ä¸ªè™šè¡¨ã€‚ è¯­æ³•4ï¼šæŸ¥çœ‹è§†å›¾çš„è¯¦ç»†å®šä¹‰ä¿¡æ¯</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHOW CREATE VIEW è§†å›¾åç§°;</span><br></pre></td></tr></table></figure><h2 id="5-æ›´æ–°è§†å›¾çš„æ•°æ®"><a href="#5-æ›´æ–°è§†å›¾çš„æ•°æ®" class="headerlink" title="5. æ›´æ–°è§†å›¾çš„æ•°æ®"></a>5. æ›´æ–°è§†å›¾çš„æ•°æ®</h2><h3 id="1-ä¸€èˆ¬æƒ…å†µ"><a href="#1-ä¸€èˆ¬æƒ…å†µ" class="headerlink" title="1) ä¸€èˆ¬æƒ…å†µ"></a>1) ä¸€èˆ¬æƒ…å†µ</h3><p>MySQLæ”¯æŒä½¿ç”¨INSERTã€UPDATEå’ŒDELETEè¯­å¥å¯¹è§†å›¾ä¸­çš„æ•°æ®è¿›è¡Œæ’å…¥ã€æ›´æ–°å’Œåˆ é™¤æ“ä½œã€‚å½“è§†å›¾ä¸­çš„ æ•°æ®å‘ç”Ÿå˜åŒ–æ—¶ï¼Œæ•°æ®è¡¨ä¸­çš„æ•°æ®ä¹Ÿä¼šå‘ç”Ÿå˜åŒ–ï¼Œåä¹‹äº¦ç„¶ã€‚</p><p>ä¸¾ä¾‹ï¼šUPDATEæ“ä½œ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UPDATE emp_tel SET tel = &#x27;13789091234&#x27; WHERE ename = &#x27;å­™æ´ªäº®&#x27;;</span><br></pre></td></tr></table></figure><p>ä¸¾ä¾‹ï¼šDELETEæ“ä½œ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DELETE FROM emp_tel WHERE ename = &#x27;å­™æ´ªäº®&#x27;;</span><br></pre></td></tr></table></figure><h3 id="2-ä¸å¯æ›´æ–°çš„è§†å›¾"><a href="#2-ä¸å¯æ›´æ–°çš„è§†å›¾" class="headerlink" title="2) ä¸å¯æ›´æ–°çš„è§†å›¾"></a>2) ä¸å¯æ›´æ–°çš„è§†å›¾</h3><p>è¦ä½¿è§†å›¾å¯æ›´æ–°ï¼Œè§†å›¾ä¸­çš„è¡Œå’Œåº•å±‚åŸºæœ¬è¡¨ä¸­çš„è¡Œä¹‹é—´å¿…é¡»å­˜åœ¨ ä¸€å¯¹ä¸€ çš„å…³ç³»ã€‚å¦å¤–å½“è§†å›¾å®šä¹‰å‡ºç°å¦‚ä¸‹æƒ…å†µæ—¶ï¼Œè§†å›¾ä¸æ”¯æŒæ›´æ–°æ“ä½œï¼š</p><ul><li>åœ¨å®šä¹‰è§†å›¾çš„æ—¶å€™æŒ‡å®šäº†â€œALGORITHM &#x3D; TEMPTABLEâ€ï¼Œè§†å›¾å°†ä¸æ”¯æŒINSERTå’ŒDELETEæ“ä½œï¼› </li><li>è§†å›¾ä¸­ä¸åŒ…å«åŸºè¡¨ä¸­æ‰€æœ‰è¢«å®šä¹‰ä¸ºéç©ºåˆæœªæŒ‡å®šé»˜è®¤å€¼çš„åˆ—ï¼Œè§†å›¾å°†ä¸æ”¯æŒINSERTæ“ä½œï¼› </li><li>åœ¨å®šä¹‰è§†å›¾çš„SELECTè¯­å¥ä¸­ä½¿ç”¨äº† JOINè”åˆæŸ¥è¯¢ ï¼Œè§†å›¾å°†ä¸æ”¯æŒINSERTå’ŒDELETEæ“ä½œï¼› </li><li>åœ¨å®šä¹‰è§†å›¾çš„SELECTè¯­å¥åçš„å­—æ®µåˆ—è¡¨ä¸­ä½¿ç”¨äº† æ•°å­¦è¡¨è¾¾å¼ æˆ– å­æŸ¥è¯¢ ï¼Œè§†å›¾å°†ä¸æ”¯æŒINSERTï¼Œä¹Ÿ ä¸æ”¯æŒUPDATEä½¿ç”¨äº†æ•°å­¦è¡¨è¾¾å¼ã€å­æŸ¥è¯¢çš„å­—æ®µå€¼ï¼› </li><li>åœ¨å®šä¹‰è§†å›¾çš„SELECTè¯­å¥åçš„å­—æ®µåˆ—è¡¨ä¸­ä½¿ç”¨ DISTINCT ã€ èšåˆå‡½æ•° ã€ GROUP BY ã€ HAVING ã€ UNION ç­‰ï¼Œè§†å›¾å°†ä¸æ”¯æŒINSERTã€UPDATEã€DELETEï¼› </li><li>åœ¨å®šä¹‰è§†å›¾çš„SELECTè¯­å¥ä¸­åŒ…å«äº†å­æŸ¥è¯¢ï¼Œè€Œå­æŸ¥è¯¢ä¸­å¼•ç”¨äº†FROMåé¢çš„è¡¨ï¼Œè§†å›¾å°†ä¸æ”¯æŒ INSERTã€UPDATEã€DELETEï¼› </li><li>è§†å›¾å®šä¹‰åŸºäºä¸€ä¸ª ä¸å¯æ›´æ–°è§†å›¾ ï¼› å¸¸é‡è§†å›¾ã€‚</li></ul><blockquote><p>è™½ç„¶å¯ä»¥æ›´æ–°è§†å›¾æ•°æ®ï¼Œä½†æ€»çš„æ¥è¯´ï¼Œè§†å›¾ä½œä¸ºè™šæ‹Ÿè¡¨ ï¼Œä¸»è¦ç”¨äºæ–¹ä¾¿æŸ¥è¯¢ ï¼Œä¸å»ºè®®æ›´æ–°è§†å›¾çš„æ•°æ®ã€‚å¯¹è§†å›¾æ•°æ®çš„æ›´æ”¹ï¼Œéƒ½æ˜¯é€šè¿‡å¯¹å®é™…æ•°æ®è¡¨é‡Œæ•°æ®çš„æ“ä½œæ¥å®Œæˆçš„ã€‚</p></blockquote><h2 id="6-ä¿®æ”¹ã€åˆ é™¤è§†å›¾"><a href="#6-ä¿®æ”¹ã€åˆ é™¤è§†å›¾" class="headerlink" title="6. ä¿®æ”¹ã€åˆ é™¤è§†å›¾"></a>6. ä¿®æ”¹ã€åˆ é™¤è§†å›¾</h2><h3 id="1-ä¿®æ”¹è§†å›¾"><a href="#1-ä¿®æ”¹è§†å›¾" class="headerlink" title="1) ä¿®æ”¹è§†å›¾"></a>1) ä¿®æ”¹è§†å›¾</h3><p>æ–¹å¼1ï¼šä½¿ç”¨CREATE OR REPLACE VIEW å­å¥ä¿®æ”¹è§†å›¾</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CREATE OR REPLACE VIEW empvu80</span><br><span class="line">(id_number, name, sal, department_id)</span><br><span class="line">AS</span><br><span class="line">SELECT employee_id, first_name || &#x27; &#x27; || last_name, salary, department_id</span><br><span class="line">FROM employees</span><br><span class="line">WHERE department_id = 80;</span><br></pre></td></tr></table></figure><blockquote><p>è¯´æ˜ï¼šCREATE VIEW å­å¥ä¸­å„åˆ—çš„åˆ«ååº”å’Œå­æŸ¥è¯¢ä¸­å„åˆ—ç›¸å¯¹åº”ã€‚</p></blockquote><p>æ–¹å¼2ï¼šALTER VIEW</p><p>ä¿®æ”¹è§†å›¾çš„è¯­æ³•æ˜¯ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ALTER VIEW è§†å›¾åç§°</span><br><span class="line">AS</span><br><span class="line">æŸ¥è¯¢è¯­å¥</span><br></pre></td></tr></table></figure><h3 id="2-åˆ é™¤è§†å›¾"><a href="#2-åˆ é™¤è§†å›¾" class="headerlink" title="2) åˆ é™¤è§†å›¾"></a>2) åˆ é™¤è§†å›¾</h3><ul><li>åˆ é™¤è§†å›¾åªæ˜¯åˆ é™¤è§†å›¾çš„å®šä¹‰ï¼Œå¹¶ä¸ä¼šåˆ é™¤åŸºè¡¨çš„æ•°æ®ã€‚ </li><li>åˆ é™¤è§†å›¾çš„è¯­æ³•æ˜¯ï¼š</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DROP VIEW IF EXISTS è§†å›¾åç§°;</span><br></pre></td></tr></table></figure><ul><li>ä¸¾ä¾‹ï¼š</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DROP VIEW empvu80;</span><br></pre></td></tr></table></figure><ul><li>è¯´æ˜ï¼šåŸºäºè§†å›¾aã€båˆ›å»ºäº†æ–°çš„è§†å›¾cï¼Œå¦‚æœå°†è§†å›¾aæˆ–è€…è§†å›¾båˆ é™¤ï¼Œä¼šå¯¼è‡´è§†å›¾cçš„æŸ¥è¯¢å¤±è´¥ã€‚è¿™ æ ·çš„è§†å›¾céœ€è¦æ‰‹åŠ¨åˆ é™¤æˆ–ä¿®æ”¹ï¼Œå¦åˆ™å½±å“ä½¿ç”¨ã€‚</li></ul><h2 id="7-æ€»ç»“"><a href="#7-æ€»ç»“" class="headerlink" title="7. æ€»ç»“"></a>7. æ€»ç»“</h2><h3 id="1-ä¼˜ç‚¹"><a href="#1-ä¼˜ç‚¹" class="headerlink" title="1) ä¼˜ç‚¹"></a>1) ä¼˜ç‚¹</h3><p><strong>1. æ“ä½œç®€å•</strong></p><p>å°†ç»å¸¸ä½¿ç”¨çš„æŸ¥è¯¢æ“ä½œå®šä¹‰ä¸ºè§†å›¾ï¼Œå¯ä»¥ä½¿å¼€å‘äººå‘˜ä¸éœ€è¦å…³å¿ƒè§†å›¾å¯¹åº”çš„æ•°æ®è¡¨çš„ç»“æ„ã€è¡¨ä¸è¡¨ä¹‹é—´çš„å…³è”å…³ç³»ï¼Œä¹Ÿä¸éœ€è¦å…³å¿ƒæ•°æ®è¡¨ä¹‹é—´çš„ä¸šåŠ¡é€»è¾‘å’ŒæŸ¥è¯¢æ¡ä»¶ï¼Œè€Œåªéœ€è¦ç®€å•åœ°æ“ä½œè§†å›¾å³å¯ï¼Œæå¤§ç®€åŒ–äº†å¼€å‘äººå‘˜å¯¹æ•°æ®åº“çš„æ“ä½œã€‚</p><p><strong>2. å‡å°‘æ•°æ®å†—ä½™</strong></p><p>è§†å›¾è·Ÿå®é™…æ•°æ®è¡¨ä¸ä¸€æ ·ï¼Œå®ƒå­˜å‚¨çš„æ˜¯æŸ¥è¯¢è¯­å¥ã€‚æ‰€ä»¥ï¼Œåœ¨ä½¿ç”¨çš„æ—¶å€™ï¼Œæˆ‘ä»¬è¦é€šè¿‡å®šä¹‰è§†å›¾çš„æŸ¥è¯¢è¯­ å¥æ¥è·å–ç»“æœé›†ã€‚è€Œè§†å›¾æœ¬èº«ä¸å­˜å‚¨æ•°æ®ï¼Œä¸å ç”¨æ•°æ®å­˜å‚¨çš„èµ„æºï¼Œå‡å°‘äº†æ•°æ®å†—ä½™ã€‚</p><p><strong>3. æ•°æ®å®‰å…¨</strong></p><p>MySQLå°†ç”¨æˆ·å¯¹æ•°æ®çš„ è®¿é—®é™åˆ¶ åœ¨æŸäº›æ•°æ®çš„ç»“æœé›†ä¸Šï¼Œè€Œè¿™äº›æ•°æ®çš„ç»“æœé›†å¯ä»¥ä½¿ç”¨è§†å›¾æ¥å®ç°ã€‚ç”¨ æˆ·ä¸å¿…ç›´æ¥æŸ¥è¯¢æˆ–æ“ä½œæ•°æ®è¡¨ã€‚è¿™ä¹Ÿå¯ä»¥ç†è§£ä¸ºè§†å›¾å…·æœ‰ éš”ç¦»æ€§ ã€‚è§†å›¾ç›¸å½“äºåœ¨ç”¨æˆ·å’Œå®é™…çš„æ•°æ®è¡¨ä¹‹é—´åŠ äº†ä¸€å±‚è™šæ‹Ÿè¡¨ã€‚</p><p>åŒæ—¶ï¼ŒMySQLå¯ä»¥æ ¹æ®æƒé™å°†ç”¨æˆ·å¯¹æ•°æ®çš„è®¿é—®é™åˆ¶åœ¨æŸäº›è§†å›¾ä¸Šï¼Œç”¨æˆ·ä¸éœ€è¦æŸ¥è¯¢æ•°æ®è¡¨ï¼Œå¯ä»¥ç›´æ¥é€šè¿‡è§†å›¾è·å–æ•°æ®è¡¨ä¸­çš„ä¿¡æ¯ã€‚è¿™åœ¨ä¸€å®šç¨‹åº¦ä¸Šä¿éšœäº†æ•°æ®è¡¨ä¸­æ•°æ®çš„å®‰å…¨æ€§ã€‚</p><p><strong>4. é€‚åº”çµæ´»å¤šå˜çš„éœ€æ±‚</strong></p><p>å½“ä¸šåŠ¡ç³»ç»Ÿçš„éœ€æ±‚å‘ç”Ÿå˜åŒ–åï¼Œå¦‚æœéœ€è¦æ”¹åŠ¨æ•°æ®è¡¨çš„ç»“æ„ï¼Œåˆ™å·¥ä½œé‡ç›¸å¯¹è¾ƒ å¤§ï¼Œå¯ä»¥ä½¿ç”¨è§†å›¾æ¥å‡å°‘æ”¹åŠ¨çš„å·¥ä½œé‡ã€‚è¿™ç§æ–¹å¼åœ¨å®é™…å·¥ä½œä¸­ä½¿ç”¨å¾—æ¯”è¾ƒå¤šã€‚</p><p><strong>5. èƒ½å¤Ÿåˆ†è§£å¤æ‚çš„æŸ¥è¯¢é€»è¾‘</strong></p><p> æ•°æ®åº“ä¸­å¦‚æœå­˜åœ¨å¤æ‚çš„æŸ¥è¯¢é€»è¾‘ï¼Œåˆ™å¯ä»¥å°†é—®é¢˜è¿›è¡Œåˆ†è§£ï¼Œåˆ›å»ºå¤šä¸ªè§†å›¾ è·å–æ•°æ®ï¼Œå†å°†åˆ›å»ºçš„å¤šä¸ªè§†å›¾ç»“åˆèµ·æ¥ï¼Œå®Œæˆå¤æ‚çš„æŸ¥è¯¢é€»è¾‘ã€‚</p><h3 id="2-ä¸è¶³"><a href="#2-ä¸è¶³" class="headerlink" title="2) ä¸è¶³"></a>2) ä¸è¶³</h3><p>å¦‚æœæˆ‘ä»¬åœ¨å®é™…æ•°æ®è¡¨çš„åŸºç¡€ä¸Šåˆ›å»ºäº†è§†å›¾ï¼Œé‚£ä¹ˆï¼Œå¦‚æœå®é™…æ•°æ®è¡¨çš„ç»“æ„å˜æ›´äº†ï¼Œæˆ‘ä»¬å°±éœ€è¦åŠæ—¶å¯¹ç›¸å…³çš„è§†å›¾è¿›è¡Œç›¸åº”çš„ç»´æŠ¤ã€‚ç‰¹åˆ«æ˜¯åµŒå¥—çš„è§†å›¾ï¼ˆå°±æ˜¯åœ¨è§†å›¾çš„åŸºç¡€ä¸Šåˆ›å»ºè§†å›¾ï¼‰ï¼Œç»´æŠ¤ä¼šå˜å¾—æ¯”è¾ƒå¤æ‚ï¼Œ å¯è¯»æ€§ä¸å¥½ ï¼Œå®¹æ˜“å˜æˆç³»ç»Ÿçš„æ½œåœ¨éšæ‚£ã€‚å› ä¸ºåˆ›å»ºè§†å›¾çš„ SQL æŸ¥è¯¢å¯èƒ½ä¼šå¯¹å­—æ®µé‡å‘½åï¼Œä¹Ÿå¯èƒ½åŒ…å«å¤æ‚çš„é€»è¾‘ï¼Œè¿™äº›éƒ½ä¼šå¢åŠ ç»´æŠ¤çš„æˆæœ¬ã€‚ </p><p>å®é™…é¡¹ç›®ä¸­ï¼Œå¦‚æœè§†å›¾è¿‡å¤šï¼Œä¼šå¯¼è‡´æ•°æ®åº“ç»´æŠ¤æˆæœ¬çš„é—®é¢˜ã€‚ </p><p>æ‰€ä»¥ï¼Œåœ¨åˆ›å»ºè§†å›¾çš„æ—¶å€™ï¼Œä½ è¦ç»“åˆå®é™…é¡¹ç›®éœ€æ±‚ï¼Œç»¼åˆè€ƒè™‘è§†å›¾çš„ä¼˜ç‚¹å’Œä¸è¶³ï¼Œè¿™æ ·æ‰èƒ½æ­£ç¡®ä½¿ç”¨è§†å›¾ï¼Œä½¿ç³»ç»Ÿæ•´ä½“è¾¾åˆ°æœ€ä¼˜ã€‚</p><h1 id="ç¬¬15ç« -å­˜å‚¨è¿‡ç¨‹ä¸å‡½æ•°"><a href="#ç¬¬15ç« -å­˜å‚¨è¿‡ç¨‹ä¸å‡½æ•°" class="headerlink" title="ç¬¬15ç« _å­˜å‚¨è¿‡ç¨‹ä¸å‡½æ•°"></a>ç¬¬15ç« _å­˜å‚¨è¿‡ç¨‹ä¸å‡½æ•°</h1><p>MySQLä»5.0ç‰ˆæœ¬å¼€å§‹æ”¯æŒå­˜å‚¨è¿‡ç¨‹å’Œå‡½æ•°ã€‚å­˜å‚¨è¿‡ç¨‹å’Œå‡½æ•°èƒ½å¤Ÿå°†å¤æ‚çš„SQLé€»è¾‘å°è£…åœ¨ä¸€èµ·ï¼Œåº”ç”¨ç¨‹ åºæ— é¡»å…³æ³¨å­˜å‚¨è¿‡ç¨‹å’Œå‡½æ•°å†…éƒ¨å¤æ‚çš„SQLé€»è¾‘ï¼Œè€Œåªéœ€è¦ç®€å•åœ°è°ƒç”¨å­˜å‚¨è¿‡ç¨‹å’Œå‡½æ•°å³å¯ã€‚</p><h2 id="1-å­˜å‚¨è¿‡ç¨‹æ¦‚è¿°"><a href="#1-å­˜å‚¨è¿‡ç¨‹æ¦‚è¿°" class="headerlink" title="1. å­˜å‚¨è¿‡ç¨‹æ¦‚è¿°"></a>1. å­˜å‚¨è¿‡ç¨‹æ¦‚è¿°</h2><h3 id="1-ç†è§£"><a href="#1-ç†è§£" class="headerlink" title="1) ç†è§£"></a>1) ç†è§£</h3><p><strong>å«ä¹‰ï¼š</strong>å­˜å‚¨è¿‡ç¨‹çš„è‹±æ–‡æ˜¯ Stored Procedure ã€‚å®ƒçš„æ€æƒ³å¾ˆç®€å•ï¼Œå°±æ˜¯ä¸€ç»„ç»è¿‡ é¢„å…ˆç¼–è¯‘çš„ SQL è¯­å¥ çš„å°è£…ã€‚</p><p>æ‰§è¡Œè¿‡ç¨‹ï¼šå­˜å‚¨è¿‡ç¨‹é¢„å…ˆå­˜å‚¨åœ¨ MySQL æœåŠ¡å™¨ä¸Šï¼Œéœ€è¦æ‰§è¡Œçš„æ—¶å€™ï¼Œå®¢æˆ·ç«¯åªéœ€è¦å‘æœåŠ¡å™¨ç«¯å‘å‡ºè°ƒç”¨å­˜å‚¨è¿‡ç¨‹çš„å‘½ä»¤ï¼ŒæœåŠ¡å™¨ç«¯å°±å¯ä»¥æŠŠé¢„å…ˆå­˜å‚¨å¥½çš„è¿™ä¸€ç³»åˆ— SQL è¯­å¥å…¨éƒ¨æ‰§è¡Œã€‚</p><p><strong>å¥½å¤„ï¼š</strong></p><ul><li>1ã€ç®€åŒ–æ“ä½œï¼Œæé«˜äº†sqlè¯­å¥çš„é‡ç”¨æ€§ï¼Œå‡å°‘äº†å¼€å‘ç¨‹åºå‘˜çš„å‹åŠ›ã€‚</li><li>2ã€å‡å°‘æ“ä½œè¿‡ç¨‹ä¸­çš„å¤±è¯¯ï¼Œæé«˜æ•ˆç‡ã€‚</li><li>3ã€å‡å°‘ç½‘ç»œä¼ è¾“é‡ï¼ˆå®¢æˆ·ç«¯ä¸éœ€è¦æŠŠæ‰€æœ‰çš„ SQL è¯­å¥é€šè¿‡ç½‘ç»œå‘ç»™æœåŠ¡å™¨ï¼‰ã€‚</li><li>4ã€å‡å°‘äº† SQL è¯­å¥æš´éœ²åœ¨ ç½‘ä¸Šçš„é£é™©ï¼Œä¹Ÿæé«˜äº†æ•°æ®æŸ¥è¯¢çš„å®‰å…¨æ€§ã€‚</li></ul><p><strong>å’Œè§†å›¾ã€å‡½æ•°çš„å¯¹æ¯”ï¼š</strong></p><p>å®ƒå’Œè§†å›¾æœ‰ç€åŒæ ·çš„ä¼˜ç‚¹ï¼Œæ¸…æ™°ã€å®‰å…¨ï¼Œè¿˜å¯ä»¥å‡å°‘ç½‘ç»œä¼ è¾“é‡ã€‚ä¸è¿‡å®ƒå’Œè§†å›¾ä¸åŒï¼Œè§†å›¾æ˜¯è™šæ‹Ÿè¡¨ ï¼Œé€šå¸¸ä¸å¯¹åº•å±‚æ•°æ®è¡¨ç›´æ¥æ“ä½œï¼Œè€Œå­˜å‚¨è¿‡ç¨‹æ˜¯ç¨‹åºåŒ–çš„ SQLï¼Œå¯ä»¥ ç›´æ¥æ“ä½œåº•å±‚æ•°æ®è¡¨ ï¼Œç›¸æ¯”äºé¢å‘é›†åˆçš„æ“ä½œæ–¹å¼ï¼Œèƒ½å¤Ÿå®ç°ä¸€äº›æ›´å¤æ‚çš„æ•°æ®å¤„ç†ã€‚</p><p>ä¸€æ—¦å­˜å‚¨è¿‡ç¨‹è¢«åˆ›å»ºå‡ºæ¥ï¼Œä½¿ç”¨å®ƒå°±åƒä½¿ç”¨å‡½æ•°ä¸€æ ·ç®€å•ï¼Œæˆ‘ä»¬ç›´æ¥é€šè¿‡è°ƒç”¨å­˜å‚¨è¿‡ç¨‹åå³å¯ã€‚ç›¸è¾ƒäºå‡½æ•°ï¼Œå­˜å‚¨è¿‡ç¨‹æ˜¯ æ²¡æœ‰è¿”å›å€¼ çš„ã€‚</p><h3 id="2-åˆ†ç±»"><a href="#2-åˆ†ç±»" class="headerlink" title="2) åˆ†ç±»"></a>2) åˆ†ç±»</h3><p>å­˜å‚¨è¿‡ç¨‹çš„å‚æ•°ç±»å‹å¯ä»¥æ˜¯INã€OUTå’ŒINOUTã€‚æ ¹æ®è¿™ç‚¹åˆ†ç±»å¦‚ä¸‹ï¼š</p><p>1ã€æ²¡æœ‰å‚æ•°ï¼ˆæ— å‚æ•°æ— è¿”å›ï¼‰ </p><p>2ã€ä»…ä»…å¸¦ IN ç±»å‹ï¼ˆæœ‰å‚æ•°æ— è¿”å›ï¼‰ </p><p>3ã€ä»…ä»…å¸¦ OUT ç±»å‹ï¼ˆæ— å‚æ•°æœ‰è¿”å›ï¼‰ </p><p>4ã€æ—¢å¸¦ IN åˆå¸¦ OUTï¼ˆæœ‰å‚æ•°æœ‰è¿”å›ï¼‰ </p><p>5ã€å¸¦ INOUTï¼ˆæœ‰å‚æ•°æœ‰è¿”å›ï¼‰</p><p>æ³¨æ„ï¼šINã€OUTã€INOUT éƒ½å¯ä»¥åœ¨ä¸€ä¸ªå­˜å‚¨è¿‡ç¨‹ä¸­å¸¦å¤šä¸ªã€‚</p><h2 id="2-åˆ›å»ºå­˜å‚¨è¿‡ç¨‹"><a href="#2-åˆ›å»ºå­˜å‚¨è¿‡ç¨‹" class="headerlink" title="2. åˆ›å»ºå­˜å‚¨è¿‡ç¨‹"></a>2. åˆ›å»ºå­˜å‚¨è¿‡ç¨‹</h2><h3 id="1-è¯­æ³•åˆ†æ"><a href="#1-è¯­æ³•åˆ†æ" class="headerlink" title="1) è¯­æ³•åˆ†æ"></a>1) è¯­æ³•åˆ†æ</h3><p><strong>è¯­æ³•ï¼š</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CREATE PROCEDURE å­˜å‚¨è¿‡ç¨‹å(IN|OUT|INOUT å‚æ•°å å‚æ•°ç±»å‹,...)</span><br><span class="line">[characteristics ...]</span><br><span class="line">BEGIN</span><br><span class="line">å­˜å‚¨è¿‡ç¨‹ä½“</span><br><span class="line">END</span><br></pre></td></tr></table></figure><p><strong>è¯´æ˜ï¼š</strong></p><p>1ã€å‚æ•°å‰é¢çš„ç¬¦å·çš„æ„æ€</p><ul><li><p>IN ï¼šå½“å‰å‚æ•°ä¸ºè¾“å…¥å‚æ•°ï¼Œä¹Ÿå°±æ˜¯è¡¨ç¤ºå…¥å‚ï¼›</p><p>å­˜å‚¨è¿‡ç¨‹åªæ˜¯è¯»å–è¿™ä¸ªå‚æ•°çš„å€¼ã€‚å¦‚æœæ²¡æœ‰å®šä¹‰å‚æ•°ç§ç±»ï¼Œ é»˜è®¤å°±æ˜¯ IN ï¼Œè¡¨ç¤ºè¾“å…¥å‚æ•°ã€‚</p></li><li><p>OUT ï¼šå½“å‰å‚æ•°ä¸ºè¾“å‡ºå‚æ•°ï¼Œä¹Ÿå°±æ˜¯è¡¨ç¤ºå‡ºå‚ï¼›</p><p>æ‰§è¡Œå®Œæˆä¹‹åï¼Œè°ƒç”¨è¿™ä¸ªå­˜å‚¨è¿‡ç¨‹çš„å®¢æˆ·ç«¯æˆ–è€…åº”ç”¨ç¨‹åºå°±å¯ä»¥è¯»å–è¿™ä¸ªå‚æ•°è¿”å›çš„å€¼äº†ã€‚</p></li><li><p>INOUT ï¼šå½“å‰å‚æ•°æ—¢å¯ä»¥ä¸ºè¾“å…¥å‚æ•°ï¼Œä¹Ÿå¯ä»¥ä¸ºè¾“å‡ºå‚æ•°ã€‚</p></li></ul><p>2ã€å½¢å‚ç±»å‹å¯ä»¥æ˜¯ MySQLæ•°æ®åº“ä¸­çš„ä»»æ„ç±»å‹ã€‚</p><p>3ã€characteristics è¡¨ç¤ºåˆ›å»ºå­˜å‚¨è¿‡ç¨‹æ—¶æŒ‡å®šçš„å¯¹å­˜å‚¨è¿‡ç¨‹çš„çº¦æŸæ¡ä»¶ï¼Œå…¶å–å€¼ä¿¡æ¯å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">LANGUAGE SQL</span><br><span class="line">| [NOT] DETERMINISTIC</span><br><span class="line">| &#123; CONTAINS SQL | NO SQL | READS SQL DATA | MODIFIES SQL DATA &#125;</span><br><span class="line">| SQL SECURITY &#123; DEFINER | INVOKER &#125;</span><br><span class="line">| COMMENT &#x27;string&#x27;</span><br></pre></td></tr></table></figure><ul><li><p>LANGUAGE SQL ï¼šè¯´æ˜å­˜å‚¨è¿‡ç¨‹æ‰§è¡Œä½“æ˜¯ç”±SQLè¯­å¥ç»„æˆçš„ï¼Œå½“å‰ç³»ç»Ÿæ”¯æŒçš„è¯­è¨€ä¸ºSQLã€‚</p></li><li><p>[NOT] DETERMINISTIC ï¼šæŒ‡æ˜å­˜å‚¨è¿‡ç¨‹æ‰§è¡Œçš„ç»“æœæ˜¯å¦ç¡®å®šã€‚DETERMINISTICè¡¨ç¤ºç»“æœæ˜¯ç¡®å®š çš„ã€‚æ¯æ¬¡æ‰§è¡Œå­˜å‚¨è¿‡ç¨‹æ—¶ï¼Œç›¸åŒçš„è¾“å…¥ä¼šå¾—åˆ°ç›¸åŒçš„è¾“å‡ºã€‚NOT DETERMINISTICè¡¨ç¤ºç»“æœæ˜¯ä¸ç¡®å®š çš„ï¼Œç›¸åŒçš„è¾“å…¥å¯èƒ½å¾—åˆ°ä¸åŒçš„è¾“å‡ºã€‚å¦‚æœæ²¡æœ‰æŒ‡å®šä»»æ„ä¸€ä¸ªå€¼ï¼Œé»˜è®¤ä¸ºNOT DETERMINISTICã€‚</p></li><li><p>{ CONTAINS SQL | NO SQL | READS SQL DATA | MODIFIES SQL DATA } ï¼šæŒ‡æ˜å­ç¨‹åºä½¿ ç”¨SQLè¯­å¥çš„é™åˆ¶ã€‚</p><ul><li>CONTAINS SQLè¡¨ç¤ºå½“å‰å­˜å‚¨è¿‡ç¨‹çš„å­ç¨‹åºåŒ…å«SQLè¯­å¥ï¼Œä½†æ˜¯å¹¶ä¸åŒ…å«è¯»å†™æ•°æ®çš„SQLè¯­å¥ï¼›</li><li>NO SQLè¡¨ç¤ºå½“å‰å­˜å‚¨è¿‡ç¨‹çš„å­ç¨‹åºä¸­ä¸åŒ…å«ä»»ä½•SQLè¯­å¥ï¼› </li><li>READS SQL DATAè¡¨ç¤ºå½“å‰å­˜å‚¨è¿‡ç¨‹çš„å­ç¨‹åºä¸­åŒ…å«è¯»æ•°æ®çš„SQLè¯­å¥ï¼› </li><li>MODIFIES SQL DATAè¡¨ç¤ºå½“å‰å­˜å‚¨è¿‡ç¨‹çš„å­ç¨‹åºä¸­åŒ…å«å†™æ•°æ®çš„SQLè¯­å¥ã€‚ </li><li>é»˜è®¤æƒ…å†µä¸‹ï¼Œç³»ç»Ÿä¼šæŒ‡å®šä¸ºCONTAINS SQLã€‚</li></ul></li><li><p>SQL SECURITY { DEFINER | INVOKER } ï¼šæ‰§è¡Œå½“å‰å­˜å‚¨è¿‡ç¨‹çš„æƒé™ï¼Œå³æŒ‡æ˜å“ªäº›ç”¨æˆ·èƒ½å¤Ÿæ‰§è¡Œå½“å‰å­˜å‚¨è¿‡ç¨‹ã€‚</p><ul><li>DEFINER è¡¨ç¤ºåªæœ‰å½“å‰å­˜å‚¨è¿‡ç¨‹çš„åˆ›å»ºè€…æˆ–è€…å®šä¹‰è€…æ‰èƒ½æ‰§è¡Œå½“å‰å­˜å‚¨è¿‡ç¨‹ï¼›</li><li>INVOKER è¡¨ç¤ºæ‹¥æœ‰å½“å‰å­˜å‚¨è¿‡ç¨‹çš„è®¿é—®æƒé™çš„ç”¨æˆ·èƒ½å¤Ÿæ‰§è¡Œå½“å‰å­˜å‚¨è¿‡ç¨‹ã€‚</li></ul></li><li><p>COMMENT â€˜stringâ€™ ï¼šæ³¨é‡Šä¿¡æ¯ï¼Œå¯ä»¥ç”¨æ¥æè¿°å­˜å‚¨è¿‡ç¨‹ã€‚</p></li></ul><p>4ã€å­˜å‚¨è¿‡ç¨‹ä½“ä¸­å¯ä»¥æœ‰å¤šæ¡ SQL è¯­å¥ï¼Œå¦‚æœä»…ä»…ä¸€æ¡SQL è¯­å¥ï¼Œåˆ™å¯ä»¥çœç•¥ BEGIN å’Œ END</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1. BEGINâ€¦ENDï¼šBEGINâ€¦END ä¸­é—´åŒ…å«äº†å¤šä¸ªè¯­å¥ï¼Œæ¯ä¸ªè¯­å¥éƒ½ä»¥ï¼ˆ;ï¼‰å·ä¸ºç»“æŸç¬¦ã€‚</span><br><span class="line">2. DECLAREï¼šDECLARE ç”¨æ¥å£°æ˜å˜é‡ï¼Œä½¿ç”¨çš„ä½ç½®åœ¨äº BEGINâ€¦END è¯­å¥ä¸­é—´ï¼Œè€Œä¸”éœ€è¦åœ¨å…¶ä»–è¯­å¥ä½¿ç”¨ä¹‹å‰è¿›</span><br><span class="line">è¡Œå˜é‡çš„å£°æ˜ã€‚</span><br><span class="line">3. SETï¼šèµ‹å€¼è¯­å¥ï¼Œç”¨äºå¯¹å˜é‡è¿›è¡Œèµ‹å€¼ã€‚</span><br><span class="line">4. SELECTâ€¦ INTOï¼šæŠŠä»æ•°æ®è¡¨ä¸­æŸ¥è¯¢çš„ç»“æœå­˜æ”¾åˆ°å˜é‡ä¸­ï¼Œä¹Ÿå°±æ˜¯ä¸ºå˜é‡èµ‹å€¼ã€‚</span><br></pre></td></tr></table></figure><p>5ã€éœ€è¦è®¾ç½®æ–°çš„ç»“æŸæ ‡è®°</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER æ–°çš„ç»“æŸæ ‡è®°</span><br></pre></td></tr></table></figure><p>å› ä¸ºMySQLé»˜è®¤çš„è¯­å¥ç»“æŸç¬¦å·ä¸ºåˆ†å·â€˜;â€™ã€‚ä¸ºäº†é¿å…ä¸å­˜å‚¨è¿‡ç¨‹ä¸­SQLè¯­å¥ç»“æŸç¬¦ç›¸å†²çªï¼Œéœ€è¦ä½¿ç”¨ DELIMITERæ”¹å˜å­˜å‚¨è¿‡ç¨‹çš„ç»“æŸç¬¦ã€‚</p><p>æ¯”å¦‚ï¼šâ€œDELIMITER &#x2F;&#x2F;â€è¯­å¥çš„ä½œç”¨æ˜¯å°†MySQLçš„ç»“æŸç¬¦è®¾ç½®ä¸º&#x2F;&#x2F;ï¼Œå¹¶ä»¥â€œEND &#x2F;&#x2F;â€ç»“æŸå­˜å‚¨è¿‡ç¨‹ã€‚å­˜å‚¨è¿‡ç¨‹å®š ä¹‰å®Œæ¯•ä¹‹åå†ä½¿ç”¨â€œDELIMITER ;â€æ¢å¤é»˜è®¤ç»“æŸç¬¦ã€‚DELIMITERä¹Ÿå¯ä»¥æŒ‡å®šå…¶ä»–ç¬¦å·ä½œä¸ºç»“æŸç¬¦ã€‚</p><p>å½“ä½¿ç”¨DELIMITERå‘½ä»¤æ—¶ï¼Œåº”è¯¥é¿å…ä½¿ç”¨åæ–œæ ï¼ˆâ€˜\â€™ï¼‰å­—ç¬¦ï¼Œå› ä¸ºåæ–œçº¿æ˜¯MySQLçš„è½¬ä¹‰å­—ç¬¦ã€‚ </p><p>ç¤ºä¾‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER $</span><br><span class="line">CREATE PROCEDURE å­˜å‚¨è¿‡ç¨‹å(IN|OUT|INOUT å‚æ•°å å‚æ•°ç±»å‹,...)</span><br><span class="line">[characteristics ...]</span><br><span class="line">BEGIN</span><br><span class="line">sqlè¯­å¥1;</span><br><span class="line">sqlè¯­å¥2;</span><br><span class="line">END $</span><br></pre></td></tr></table></figure><h3 id="2-ä»£ç ä¸¾ä¾‹"><a href="#2-ä»£ç ä¸¾ä¾‹" class="headerlink" title="2)  ä»£ç ä¸¾ä¾‹"></a>2)  ä»£ç ä¸¾ä¾‹</h3><p>ä¸¾ä¾‹1ï¼šåˆ›å»ºå­˜å‚¨è¿‡ç¨‹select_all_data()ï¼ŒæŸ¥çœ‹ emps è¡¨çš„æ‰€æœ‰æ•°æ®</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER $</span><br><span class="line">CREATE PROCEDURE select_all_data()</span><br><span class="line">BEGIN</span><br><span class="line">SELECT * FROM emps;</span><br><span class="line">END $</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure><p>ä¸¾ä¾‹2ï¼šåˆ›å»ºå­˜å‚¨è¿‡ç¨‹avg_employee_salary()ï¼Œè¿”å›æ‰€æœ‰å‘˜å·¥çš„å¹³å‡å·¥èµ„</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER //</span><br><span class="line">CREATE PROCEDURE avg_employee_salary ()</span><br><span class="line">BEGIN</span><br><span class="line">SELECT AVG(salary) AS avg_salary FROM emps;</span><br><span class="line">END //</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure><h2 id="3-è°ƒç”¨å­˜å‚¨è¿‡ç¨‹"><a href="#3-è°ƒç”¨å­˜å‚¨è¿‡ç¨‹" class="headerlink" title="3. è°ƒç”¨å­˜å‚¨è¿‡ç¨‹"></a>3. è°ƒç”¨å­˜å‚¨è¿‡ç¨‹</h2><h3 id="1-è°ƒç”¨æ ¼å¼"><a href="#1-è°ƒç”¨æ ¼å¼" class="headerlink" title="1) è°ƒç”¨æ ¼å¼"></a>1) è°ƒç”¨æ ¼å¼</h3><p>å­˜å‚¨è¿‡ç¨‹æœ‰å¤šç§è°ƒç”¨æ–¹æ³•ã€‚å­˜å‚¨è¿‡ç¨‹å¿…é¡»ä½¿ç”¨CALLè¯­å¥è°ƒç”¨ï¼Œå¹¶ä¸”å­˜å‚¨è¿‡ç¨‹å’Œæ•°æ®åº“ç›¸å…³ï¼Œå¦‚æœè¦æ‰§è¡Œå…¶ä»–æ•°æ®åº“ä¸­çš„å­˜å‚¨è¿‡ç¨‹ï¼Œéœ€è¦æŒ‡å®šæ•°æ®åº“åç§°ï¼Œä¾‹å¦‚CALL dbname.procnameã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CALL å­˜å‚¨è¿‡ç¨‹å(å®å‚åˆ—è¡¨)</span><br></pre></td></tr></table></figure><p><strong>æ ¼å¼ï¼š</strong></p><p>1ã€è°ƒç”¨inæ¨¡å¼çš„å‚æ•°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CALL sp1(&#x27;å€¼&#x27;);</span><br></pre></td></tr></table></figure><p>2ã€è°ƒç”¨outæ¨¡å¼çš„å‚æ•°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SET @name;</span><br><span class="line">CALL sp1(@name);</span><br><span class="line">SELECT @name;</span><br></pre></td></tr></table></figure><p>3ã€è°ƒç”¨inoutæ¨¡å¼çš„å‚æ•°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SET @name=å€¼;</span><br><span class="line">CALL sp1(@name);</span><br><span class="line">SELECT @name;</span><br></pre></td></tr></table></figure><h3 id="2-ä»£ç ä¸¾ä¾‹-1"><a href="#2-ä»£ç ä¸¾ä¾‹-1" class="headerlink" title="2) ä»£ç ä¸¾ä¾‹"></a>2) ä»£ç ä¸¾ä¾‹</h3><p><strong>ä¸¾ä¾‹1ï¼š</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER //</span><br><span class="line">CREATE PROCEDURE CountProc(IN sid INT,OUT num INT)</span><br><span class="line">BEGIN</span><br><span class="line">SELECT COUNT(*) INTO num FROM fruits</span><br><span class="line">WHERE s_id = sid;</span><br><span class="line">END //</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨å­˜å‚¨è¿‡ç¨‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CALL CountProc (101, @num);</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹è¿”å›ç»“æœï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT @num;</span><br></pre></td></tr></table></figure><p><strong>ä¸¾ä¾‹2ï¼š</strong>åˆ›å»ºå­˜å‚¨è¿‡ç¨‹ï¼Œå®ç°ç´¯åŠ è¿ç®—ï¼Œè®¡ç®— 1+2+â€¦+n ç­‰äºå¤šå°‘ã€‚å…·ä½“çš„ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER //</span><br><span class="line">CREATE PROCEDURE `add_num`(IN n INT)</span><br><span class="line">BEGIN</span><br><span class="line">DECLARE i INT;</span><br><span class="line">DECLARE sum INT;</span><br><span class="line">SET i = 1;</span><br><span class="line">SET sum = 0;</span><br><span class="line">WHILE i &lt;= n DO</span><br><span class="line">SET sum = sum + i;</span><br><span class="line">SET i = i +1;</span><br><span class="line">END WHILE;</span><br><span class="line">SELECT sum;</span><br><span class="line">END //</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure><p>ç›´æ¥ä½¿ç”¨ CALL add_num(50); å³å¯ã€‚è¿™é‡Œæˆ‘ä¼ å…¥çš„å‚æ•°ä¸º 50ï¼Œä¹Ÿå°±æ˜¯ç»Ÿè®¡ 1+2+â€¦+50 çš„ç§¯ç´¯ä¹‹å’Œã€‚</p><h3 id="3-å¦‚ä½•è°ƒè¯•"><a href="#3-å¦‚ä½•è°ƒè¯•" class="headerlink" title="3) å¦‚ä½•è°ƒè¯•"></a>3) å¦‚ä½•è°ƒè¯•</h3><p>åœ¨ MySQL ä¸­ï¼Œå­˜å‚¨è¿‡ç¨‹ä¸åƒæ™®é€šçš„ç¼–ç¨‹è¯­è¨€ï¼ˆæ¯”å¦‚ VC++ã€Java ç­‰ï¼‰é‚£æ ·æœ‰ä¸“é—¨çš„é›†æˆå¼€å‘ç¯å¢ƒã€‚å›  æ­¤ï¼Œä½ å¯ä»¥é€šè¿‡ SELECT è¯­å¥ï¼ŒæŠŠç¨‹åºæ‰§è¡Œçš„ä¸­é—´ç»“æœæŸ¥è¯¢å‡ºæ¥ï¼Œæ¥è°ƒè¯•ä¸€ä¸ª SQL è¯­å¥çš„æ­£ç¡®æ€§ã€‚è°ƒè¯• æˆåŠŸä¹‹åï¼ŒæŠŠ SELECT è¯­å¥åç§»åˆ°ä¸‹ä¸€ä¸ª SQL è¯­å¥ä¹‹åï¼Œå†è°ƒè¯•ä¸‹ä¸€ä¸ª SQL è¯­å¥ã€‚è¿™æ · é€æ­¥æ¨è¿› ï¼Œå°±å¯ä»¥å®Œæˆå¯¹å­˜å‚¨è¿‡ç¨‹ä¸­æ‰€æœ‰æ“ä½œçš„è°ƒè¯•äº†ã€‚å½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥æŠŠå­˜å‚¨è¿‡ç¨‹ä¸­çš„ SQL è¯­å¥å¤åˆ¶å‡ºæ¥ï¼Œé€æ®µå•ç‹¬ è°ƒè¯•ã€‚</p><h2 id="4-å­˜å‚¨å‡½æ•°çš„ä½¿ç”¨"><a href="#4-å­˜å‚¨å‡½æ•°çš„ä½¿ç”¨" class="headerlink" title="4. å­˜å‚¨å‡½æ•°çš„ä½¿ç”¨"></a>4. å­˜å‚¨å‡½æ•°çš„ä½¿ç”¨</h2><h3 id="1-è¯­æ³•åˆ†æ-1"><a href="#1-è¯­æ³•åˆ†æ-1" class="headerlink" title="1) è¯­æ³•åˆ†æ"></a>1) è¯­æ³•åˆ†æ</h3><p>å­¦è¿‡çš„å‡½æ•°ï¼šLENGTHã€SUBSTRã€CONCATç­‰</p><p>è¯­æ³•æ ¼å¼ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CREATE FUNCTION å‡½æ•°å(å‚æ•°å å‚æ•°ç±»å‹,...)</span><br><span class="line">RETURNS è¿”å›å€¼ç±»å‹</span><br><span class="line">[characteristics ...]</span><br><span class="line">BEGIN</span><br><span class="line">å‡½æ•°ä½“ #å‡½æ•°ä½“ä¸­è‚¯å®šæœ‰ RETURN è¯­å¥</span><br><span class="line">END</span><br></pre></td></tr></table></figure><p>è¯´æ˜ï¼š</p><p>1ã€å‚æ•°åˆ—è¡¨ï¼šæŒ‡å®šå‚æ•°ä¸ºINã€OUTæˆ–INOUTåªå¯¹PROCEDUREæ˜¯åˆæ³•çš„ï¼ŒFUNCTIONä¸­æ€»æ˜¯é»˜è®¤ä¸ºINå‚æ•°ã€‚ </p><p>2ã€RETURNS type è¯­å¥è¡¨ç¤ºå‡½æ•°è¿”å›æ•°æ®çš„ç±»å‹ï¼› RETURNSå­å¥åªèƒ½å¯¹FUNCTIONåšæŒ‡å®šï¼Œå¯¹å‡½æ•°è€Œè¨€è¿™æ˜¯ å¼ºåˆ¶ çš„ã€‚å®ƒç”¨æ¥æŒ‡å®šå‡½æ•°çš„è¿”å›ç±»å‹ï¼Œè€Œä¸”å‡½ æ•°ä½“å¿…é¡»åŒ…å«ä¸€ä¸ª RETURN value è¯­å¥ã€‚ </p><p>3ã€characteristic åˆ›å»ºå‡½æ•°æ—¶æŒ‡å®šçš„å¯¹å‡½æ•°çš„çº¦æŸã€‚å–å€¼ä¸åˆ›å»ºå­˜å‚¨è¿‡ç¨‹æ—¶ç›¸åŒï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚ </p><p>4ã€å‡½æ•°ä½“ä¹Ÿå¯ä»¥ç”¨BEGINâ€¦ENDæ¥è¡¨ç¤ºSQLä»£ç çš„å¼€å§‹å’Œç»“æŸã€‚å¦‚æœå‡½æ•°ä½“åªæœ‰ä¸€æ¡è¯­å¥ï¼Œä¹Ÿå¯ä»¥çœç•¥ BEGINâ€¦ENDã€‚</p><h3 id="2-è°ƒç”¨å­˜å‚¨å‡½æ•°"><a href="#2-è°ƒç”¨å­˜å‚¨å‡½æ•°" class="headerlink" title="2) è°ƒç”¨å­˜å‚¨å‡½æ•°"></a>2) è°ƒç”¨å­˜å‚¨å‡½æ•°</h3><p>åœ¨MySQLä¸­ï¼Œå­˜å‚¨å‡½æ•°çš„ä½¿ç”¨æ–¹æ³•ä¸MySQLå†…éƒ¨å‡½æ•°çš„ä½¿ç”¨æ–¹æ³•æ˜¯ä¸€æ ·çš„ã€‚æ¢è¨€ä¹‹ï¼Œç”¨æˆ·è‡ªå·±å®šä¹‰çš„å­˜å‚¨å‡½æ•°ä¸MySQLå†…éƒ¨å‡½æ•°æ˜¯ä¸€ä¸ªæ€§è´¨çš„ã€‚åŒºåˆ«åœ¨äºï¼Œå­˜å‚¨å‡½æ•°æ˜¯ ç”¨æˆ·è‡ªå·±å®šä¹‰ çš„ï¼Œè€Œå†…éƒ¨å‡½æ•°æ˜¯MySQL çš„ å¼€å‘è€…å®šä¹‰ çš„ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT å‡½æ•°å(å®å‚åˆ—è¡¨)</span><br></pre></td></tr></table></figure><h3 id="3-ä»£ç ä¸¾ä¾‹"><a href="#3-ä»£ç ä¸¾ä¾‹" class="headerlink" title="3) ä»£ç ä¸¾ä¾‹"></a>3) ä»£ç ä¸¾ä¾‹</h3><p><strong>ä¸¾ä¾‹1ï¼š</strong></p><p>åˆ›å»ºå­˜å‚¨å‡½æ•°ï¼Œåç§°ä¸ºemail_by_name()ï¼Œå‚æ•°å®šä¹‰ä¸ºç©ºï¼Œè¯¥å‡½æ•°æŸ¥è¯¢Abelçš„emailï¼Œå¹¶è¿”å›ï¼Œæ•°æ®ç±»å‹ä¸ºå­—ç¬¦ä¸²å‹ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER //</span><br><span class="line">CREATE FUNCTION email_by_name()</span><br><span class="line">RETURNS VARCHAR(25)</span><br><span class="line">DETERMINISTIC</span><br><span class="line">CONTAINS SQL</span><br><span class="line">BEGIN</span><br><span class="line">RETURN (SELECT email FROM employees WHERE last_name = &#x27;Abel&#x27;);</span><br><span class="line">END //</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT email_by_name();</span><br></pre></td></tr></table></figure><p><strong>ä¸¾ä¾‹2ï¼š</strong></p><p>åˆ›å»ºå­˜å‚¨å‡½æ•°ï¼Œåç§°ä¸ºemail_by_id()ï¼Œå‚æ•°ä¼ å…¥emp_idï¼Œè¯¥å‡½æ•°æŸ¥è¯¢emp_idçš„emailï¼Œå¹¶è¿”å›ï¼Œæ•°æ®ç±»å‹ ä¸ºå­—ç¬¦ä¸²å‹ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER //</span><br><span class="line">CREATE FUNCTION email_by_id(emp_id INT)</span><br><span class="line">RETURNS VARCHAR(25)</span><br><span class="line">DETERMINISTIC</span><br><span class="line">CONTAINS SQL</span><br><span class="line">BEGIN</span><br><span class="line">RETURN (SELECT email FROM employees WHERE employee_id = emp_id);</span><br><span class="line">END //</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SET @emp_id = 102;</span><br><span class="line">SELECT email_by_id(@emp_id);</span><br></pre></td></tr></table></figure><p><strong>æ³¨æ„ï¼š</strong></p><p>è‹¥åœ¨åˆ›å»ºå­˜å‚¨å‡½æ•°ä¸­æŠ¥é”™â€œ you might want to use the less safe log_bin_trust_function_creators variable â€ï¼Œæœ‰ä¸¤ç§å¤„ç†æ–¹æ³•ï¼š</p><ul><li><p>æ–¹å¼1ï¼š</p><p>åŠ ä¸Šå¿…è¦çš„å‡½æ•°ç‰¹æ€§â€œ[NOT] DETERMINISTICâ€å’Œâ€œ{CONTAINS SQL | NO SQL | READS SQL DATA | MODIFIES SQL DATA}â€</p></li><li><p>æ–¹å¼2ï¼š</p></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SET GLOBAL log_bin_trust_function_creators = 1;</span><br></pre></td></tr></table></figure><h3 id="4-å¯¹æ¯”å­˜å‚¨å‡½æ•°ä¸å­˜å‚¨è¿‡ç¨‹"><a href="#4-å¯¹æ¯”å­˜å‚¨å‡½æ•°ä¸å­˜å‚¨è¿‡ç¨‹" class="headerlink" title="4) å¯¹æ¯”å­˜å‚¨å‡½æ•°ä¸å­˜å‚¨è¿‡ç¨‹"></a>4) å¯¹æ¯”å­˜å‚¨å‡½æ•°ä¸å­˜å‚¨è¿‡ç¨‹</h3><table><thead><tr><th></th><th>å…³é”®å­—</th><th>è°ƒç”¨è¯­æ³•</th><th>è¿”å›å€¼</th><th>åº”ç”¨åœºæ™¯</th></tr></thead><tbody><tr><td>å­˜å‚¨è¿‡ç¨‹</td><td>PROCEDURE</td><td>CALL å­˜å‚¨è¿‡ç¨‹()</td><td>ç†è§£ä¸ºæœ‰0ä¸ªæˆ–å¤šä¸ª</td><td>ä¸€èˆ¬ç”¨äºæ›´æ–°</td></tr><tr><td>å­˜å‚¨å‡½æ•°</td><td>FUNCTION</td><td>SELECT å‡½æ•° ()</td><td>åªèƒ½æ˜¯ä¸€ä¸ª</td><td>ä¸€èˆ¬ç”¨äºæŸ¥è¯¢ç»“æœä¸ºä¸€ä¸ªå€¼å¹¶è¿”å›æ—¶</td></tr></tbody></table><p>æ­¤å¤–ï¼Œ<strong>å­˜å‚¨å‡½æ•°å¯ä»¥æ”¾åœ¨æŸ¥è¯¢è¯­å¥ä¸­ä½¿ç”¨ï¼Œå­˜å‚¨è¿‡ç¨‹ä¸è¡Œ</strong>ã€‚åä¹‹ï¼Œå­˜å‚¨è¿‡ç¨‹çš„åŠŸèƒ½æ›´åŠ å¼ºå¤§ï¼ŒåŒ…æ‹¬èƒ½å¤Ÿ æ‰§è¡Œå¯¹è¡¨çš„æ“ä½œï¼ˆæ¯”å¦‚åˆ›å»ºè¡¨ï¼Œåˆ é™¤è¡¨ç­‰ï¼‰å’Œäº‹åŠ¡æ“ä½œï¼Œè¿™äº›åŠŸèƒ½æ˜¯å­˜å‚¨å‡½æ•°ä¸å…·å¤‡çš„ã€‚</p><h2 id="5-å­˜å‚¨è¿‡ç¨‹å’Œå‡½æ•°çš„æŸ¥çœ‹ã€ä¿®æ”¹ã€åˆ é™¤"><a href="#5-å­˜å‚¨è¿‡ç¨‹å’Œå‡½æ•°çš„æŸ¥çœ‹ã€ä¿®æ”¹ã€åˆ é™¤" class="headerlink" title="5. å­˜å‚¨è¿‡ç¨‹å’Œå‡½æ•°çš„æŸ¥çœ‹ã€ä¿®æ”¹ã€åˆ é™¤"></a>5. å­˜å‚¨è¿‡ç¨‹å’Œå‡½æ•°çš„æŸ¥çœ‹ã€ä¿®æ”¹ã€åˆ é™¤</h2><h3 id="1-æŸ¥çœ‹"><a href="#1-æŸ¥çœ‹" class="headerlink" title="1) æŸ¥çœ‹"></a>1) æŸ¥çœ‹</h3><p> åˆ›å»ºå®Œä¹‹åï¼Œæ€ä¹ˆçŸ¥é“æˆ‘ä»¬åˆ›å»ºçš„å­˜å‚¨è¿‡ç¨‹ã€å­˜å‚¨å‡½æ•°æ˜¯å¦æˆåŠŸäº†å‘¢ï¼Ÿ</p><p>MySQLå­˜å‚¨äº†å­˜å‚¨è¿‡ç¨‹å’Œå‡½æ•°çš„çŠ¶æ€ä¿¡æ¯ï¼Œç”¨æˆ·å¯ä»¥ä½¿ç”¨SHOW STATUSè¯­å¥æˆ–SHOW CREATEè¯­å¥æ¥æŸ¥ çœ‹ï¼Œä¹Ÿå¯ç›´æ¥ä»ç³»ç»Ÿçš„information_schemaæ•°æ®åº“ä¸­æŸ¥è¯¢ã€‚è¿™é‡Œä»‹ç»3ç§æ–¹æ³•ã€‚</p><ol><li>ä½¿ç”¨SHOW CREATEè¯­å¥æŸ¥çœ‹å­˜å‚¨è¿‡ç¨‹å’Œå‡½æ•°çš„åˆ›å»ºä¿¡æ¯</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHOW CREATE &#123;PROCEDURE | FUNCTION&#125; å­˜å‚¨è¿‡ç¨‹åæˆ–å‡½æ•°å</span><br></pre></td></tr></table></figure><ol start="2"><li>ä½¿ç”¨SHOW STATUSè¯­å¥æŸ¥çœ‹å­˜å‚¨è¿‡ç¨‹å’Œå‡½æ•°çš„çŠ¶æ€ä¿¡æ¯</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHOW &#123;PROCEDURE | FUNCTION&#125; STATUS [LIKE &#x27;pattern&#x27;]</span><br></pre></td></tr></table></figure><ol start="3"><li>ä»information_schema.Routinesè¡¨ä¸­æŸ¥çœ‹å­˜å‚¨è¿‡ç¨‹å’Œå‡½æ•°çš„ä¿¡æ¯</li></ol><p>MySQLä¸­å­˜å‚¨è¿‡ç¨‹å’Œå‡½æ•°çš„ä¿¡æ¯å­˜å‚¨åœ¨information_schemaæ•°æ®åº“ä¸‹çš„Routinesè¡¨ä¸­ã€‚å¯ä»¥é€šè¿‡æŸ¥è¯¢è¯¥è¡¨çš„è®°å½•æ¥æŸ¥è¯¢å­˜å‚¨è¿‡ç¨‹å’Œå‡½æ•°çš„ä¿¡æ¯ã€‚å…¶åŸºæœ¬è¯­æ³•å½¢å¼å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM information_schema.Routines</span><br><span class="line">WHERE ROUTINE_NAME=&#x27;å­˜å‚¨è¿‡ç¨‹æˆ–å‡½æ•°çš„å&#x27; [AND ROUTINE_TYPE = &#123;&#x27;PROCEDURE|FUNCTION&#x27;&#125;];</span><br></pre></td></tr></table></figure><p>è¯´æ˜ï¼šå¦‚æœåœ¨MySQLæ•°æ®åº“ä¸­å­˜åœ¨å­˜å‚¨è¿‡ç¨‹å’Œå‡½æ•°åç§°ç›¸åŒçš„æƒ…å†µï¼Œæœ€å¥½æŒ‡å®šROUTINE_TYPEæŸ¥è¯¢æ¡ä»¶æ¥ æŒ‡æ˜æŸ¥è¯¢çš„æ˜¯å­˜å‚¨è¿‡ç¨‹è¿˜æ˜¯å‡½æ•°ã€‚</p><h3 id="2-ä¿®æ”¹"><a href="#2-ä¿®æ”¹" class="headerlink" title="2) ä¿®æ”¹"></a>2) ä¿®æ”¹</h3><p>ä¿®æ”¹å­˜å‚¨è¿‡ç¨‹æˆ–å‡½æ•°ï¼Œä¸å½±å“å­˜å‚¨è¿‡ç¨‹æˆ–å‡½æ•°åŠŸèƒ½ï¼Œåªæ˜¯ä¿®æ”¹ç›¸å…³ç‰¹æ€§ã€‚ä½¿ç”¨ALTERè¯­å¥å®ç°ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ALTER &#123;PROCEDURE | FUNCTION&#125; å­˜å‚¨è¿‡ç¨‹æˆ–å‡½æ•°çš„å [characteristic ...]</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ï¼ŒcharacteristicæŒ‡å®šå­˜å‚¨è¿‡ç¨‹æˆ–å‡½æ•°çš„ç‰¹æ€§ï¼Œå…¶å–å€¼ä¿¡æ¯ä¸åˆ›å»ºå­˜å‚¨è¿‡ç¨‹ã€å‡½æ•°æ—¶çš„å–å€¼ä¿¡æ¯ç•¥æœ‰ä¸åŒã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123; CONTAINS SQL | NO SQL | READS SQL DATA | MODIFIES SQL DATA &#125;</span><br><span class="line">| SQL SECURITY &#123; DEFINER | INVOKER &#125;</span><br><span class="line">| COMMENT &#x27;string&#x27;</span><br></pre></td></tr></table></figure><ul><li><p>CONTAINS SQL ï¼Œè¡¨ç¤ºå­ç¨‹åºåŒ…å«SQLè¯­å¥ï¼Œä½†ä¸åŒ…å«è¯»æˆ–å†™æ•°æ®çš„è¯­å¥ã€‚ </p></li><li><p>NO SQL ï¼Œè¡¨ç¤ºå­ç¨‹åºä¸­ä¸åŒ…å«SQLè¯­å¥ã€‚ </p></li><li><p>READS SQL DATA ï¼Œè¡¨ç¤ºå­ç¨‹åºä¸­åŒ…å«è¯»æ•°æ®çš„è¯­å¥ã€‚ </p></li><li><p>MODIFIES SQL DATA ï¼Œè¡¨ç¤ºå­ç¨‹åºä¸­åŒ…å«å†™æ•°æ®çš„è¯­å¥ã€‚ </p></li><li><p>SQL SECURITY { DEFINER | INVOKER } ï¼ŒæŒ‡æ˜è°æœ‰æƒé™æ¥æ‰§è¡Œã€‚ </p><ul><li>DEFINER ï¼Œè¡¨ç¤ºåªæœ‰å®šä¹‰è€…è‡ªå·±æ‰èƒ½å¤Ÿæ‰§è¡Œã€‚ </li><li>INVOKER ï¼Œè¡¨ç¤ºè°ƒç”¨è€…å¯ä»¥æ‰§è¡Œã€‚</li></ul></li><li><p>COMMENT â€˜stringâ€™ ï¼Œè¡¨ç¤ºæ³¨é‡Šä¿¡æ¯ã€‚</p></li></ul><blockquote><p>ä¿®æ”¹å­˜å‚¨è¿‡ç¨‹ä½¿ç”¨ALTER PROCEDUREè¯­å¥ï¼Œä¿®æ”¹å­˜å‚¨å‡½æ•°ä½¿ç”¨ALTER FUNCTIONè¯­å¥ã€‚ä½†æ˜¯ï¼Œè¿™ä¸¤ ä¸ªè¯­å¥çš„ç»“æ„æ˜¯ä¸€æ ·çš„ï¼Œè¯­å¥ä¸­çš„æ‰€æœ‰å‚æ•°ä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚</p></blockquote><h3 id="3-åˆ é™¤"><a href="#3-åˆ é™¤" class="headerlink" title="3) åˆ é™¤"></a>3) åˆ é™¤</h3><p>åˆ é™¤å­˜å‚¨è¿‡ç¨‹å’Œå‡½æ•°ï¼Œå¯ä»¥ä½¿ç”¨DROPè¯­å¥ï¼Œå…¶è¯­æ³•ç»“æ„å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DROP &#123;PROCEDURE | FUNCTION&#125; [IF EXISTS] å­˜å‚¨è¿‡ç¨‹æˆ–å‡½æ•°çš„å</span><br></pre></td></tr></table></figure><h2 id="6-å…³äºå­˜å‚¨è¿‡ç¨‹ä½¿ç”¨çš„äº‰è®®"><a href="#6-å…³äºå­˜å‚¨è¿‡ç¨‹ä½¿ç”¨çš„äº‰è®®" class="headerlink" title="6. å…³äºå­˜å‚¨è¿‡ç¨‹ä½¿ç”¨çš„äº‰è®®"></a>6. å…³äºå­˜å‚¨è¿‡ç¨‹ä½¿ç”¨çš„äº‰è®®</h2><h3 id="1-ä¼˜ç‚¹-1"><a href="#1-ä¼˜ç‚¹-1" class="headerlink" title="1) ä¼˜ç‚¹"></a>1) ä¼˜ç‚¹</h3><p>1ã€å­˜å‚¨è¿‡ç¨‹å¯ä»¥ä¸€æ¬¡ç¼–è¯‘å¤šæ¬¡ä½¿ç”¨ã€‚å­˜å‚¨è¿‡ç¨‹åªåœ¨åˆ›å»ºæ—¶è¿›è¡Œç¼–è¯‘ï¼Œä¹‹åçš„ä½¿ç”¨éƒ½ä¸éœ€è¦é‡æ–°ç¼–è¯‘ï¼Œ è¿™å°±æå‡äº† SQL çš„æ‰§è¡Œæ•ˆç‡ã€‚</p><p>2ã€å¯ä»¥å‡å°‘å¼€å‘å·¥ä½œé‡ã€‚å°†ä»£ç  å°è£… æˆæ¨¡å—ï¼Œå®é™…ä¸Šæ˜¯ç¼–ç¨‹çš„æ ¸å¿ƒæ€æƒ³ä¹‹ä¸€ï¼Œè¿™æ ·å¯ä»¥æŠŠå¤æ‚çš„é—®é¢˜ æ‹†è§£æˆä¸åŒçš„æ¨¡å—ï¼Œç„¶åæ¨¡å—ä¹‹é—´å¯ä»¥ é‡å¤ä½¿ç”¨ ï¼Œåœ¨å‡å°‘å¼€å‘å·¥ä½œé‡çš„åŒæ—¶ï¼Œè¿˜èƒ½ä¿è¯ä»£ç çš„ç»“æ„æ¸… æ™°ã€‚ </p><p>3ã€å­˜å‚¨è¿‡ç¨‹çš„å®‰å…¨æ€§å¼ºã€‚æˆ‘ä»¬åœ¨è®¾å®šå­˜å‚¨è¿‡ç¨‹çš„æ—¶å€™å¯ä»¥ è®¾ç½®å¯¹ç”¨æˆ·çš„ä½¿ç”¨æƒé™ ï¼Œè¿™æ ·å°±å’Œè§†å›¾ä¸€æ ·å…· æœ‰è¾ƒå¼ºçš„å®‰å…¨æ€§ã€‚ </p><p>4ã€å¯ä»¥å‡å°‘ç½‘ç»œä¼ è¾“é‡ã€‚å› ä¸ºä»£ç å°è£…åˆ°å­˜å‚¨è¿‡ç¨‹ä¸­ï¼Œæ¯æ¬¡ä½¿ç”¨åªéœ€è¦è°ƒç”¨å­˜å‚¨è¿‡ç¨‹å³å¯ï¼Œè¿™æ ·å°±å‡ å°‘äº†ç½‘ç»œä¼ è¾“é‡ã€‚ </p><p>5ã€è‰¯å¥½çš„å°è£…æ€§ã€‚åœ¨è¿›è¡Œç›¸å¯¹å¤æ‚çš„æ•°æ®åº“æ“ä½œæ—¶ï¼ŒåŸæœ¬éœ€è¦ä½¿ç”¨ä¸€æ¡ä¸€æ¡çš„ SQL è¯­å¥ï¼Œå¯èƒ½è¦è¿æ¥ å¤šæ¬¡æ•°æ®åº“æ‰èƒ½å®Œæˆçš„æ“ä½œï¼Œç°åœ¨å˜æˆäº†ä¸€æ¬¡å­˜å‚¨è¿‡ç¨‹ï¼Œåªéœ€è¦ è¿æ¥ä¸€æ¬¡å³å¯ ã€‚</p><h3 id="2-ç¼ºç‚¹"><a href="#2-ç¼ºç‚¹" class="headerlink" title="2) ç¼ºç‚¹"></a>2) ç¼ºç‚¹</h3><blockquote><p>é˜¿é‡Œå¼€å‘è§„èŒƒ ã€å¼ºåˆ¶ã€‘ç¦æ­¢ä½¿ç”¨å­˜å‚¨è¿‡ç¨‹ï¼Œå­˜å‚¨è¿‡ç¨‹éš¾ä»¥è°ƒè¯•å’Œæ‰©å±•ï¼Œæ›´æ²¡æœ‰ç§»æ¤æ€§ã€‚</p></blockquote><p>1ã€å¯ç§»æ¤æ€§å·®ã€‚å­˜å‚¨è¿‡ç¨‹ä¸èƒ½è·¨æ•°æ®åº“ç§»æ¤ï¼Œæ¯”å¦‚åœ¨ MySQLã€Oracle å’Œ SQL Server é‡Œç¼–å†™çš„å­˜å‚¨è¿‡ ç¨‹ï¼Œåœ¨æ¢æˆå…¶ä»–æ•°æ®åº“æ—¶éƒ½éœ€è¦é‡æ–°ç¼–å†™ã€‚ </p><p>2ã€è°ƒè¯•å›°éš¾ã€‚åªæœ‰å°‘æ•° DBMS æ”¯æŒå­˜å‚¨è¿‡ç¨‹çš„è°ƒè¯•ã€‚å¯¹äºå¤æ‚çš„å­˜å‚¨è¿‡ç¨‹æ¥è¯´ï¼Œå¼€å‘å’Œç»´æŠ¤éƒ½ä¸å®¹ æ˜“ã€‚è™½ç„¶ä¹Ÿæœ‰ä¸€äº›ç¬¬ä¸‰æ–¹å·¥å…·å¯ä»¥å¯¹å­˜å‚¨è¿‡ç¨‹è¿›è¡Œè°ƒè¯•ï¼Œä½†è¦æ”¶è´¹ã€‚ </p><p>3ã€å­˜å‚¨è¿‡ç¨‹çš„ç‰ˆæœ¬ç®¡ç†å¾ˆå›°éš¾ã€‚æ¯”å¦‚æ•°æ®è¡¨ç´¢å¼•å‘ç”Ÿå˜åŒ–äº†ï¼Œå¯èƒ½ä¼šå¯¼è‡´å­˜å‚¨è¿‡ç¨‹å¤±æ•ˆã€‚æˆ‘ä»¬åœ¨å¼€å‘ è½¯ä»¶çš„æ—¶å€™å¾€å¾€éœ€è¦è¿›è¡Œç‰ˆæœ¬ç®¡ç†ï¼Œä½†æ˜¯å­˜å‚¨è¿‡ç¨‹æœ¬èº«æ²¡æœ‰ç‰ˆæœ¬æ§åˆ¶ï¼Œç‰ˆæœ¬è¿­ä»£æ›´æ–°çš„æ—¶å€™å¾ˆéº»çƒ¦ã€‚ </p><p>4ã€å®ƒä¸é€‚åˆé«˜å¹¶å‘çš„åœºæ™¯ã€‚é«˜å¹¶å‘çš„åœºæ™¯éœ€è¦å‡å°‘æ•°æ®åº“çš„å‹åŠ›ï¼Œæœ‰æ—¶æ•°æ®åº“ä¼šé‡‡ç”¨åˆ†åº“åˆ†è¡¨çš„æ–¹å¼ï¼Œè€Œä¸”å¯¹å¯æ‰©å±•æ€§è¦æ±‚å¾ˆé«˜ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå­˜å‚¨è¿‡ç¨‹ä¼šå˜å¾—éš¾ä»¥ç»´æŠ¤ï¼Œ å¢åŠ æ•°æ®åº“çš„å‹åŠ› ï¼Œæ˜¾ç„¶å°±ä¸é€‚ç”¨äº†ã€‚</p><h3 id="3-å°ç»“"><a href="#3-å°ç»“" class="headerlink" title="3) å°ç»“"></a>3) å°ç»“</h3><p>å­˜å‚¨è¿‡ç¨‹æ—¢æ–¹ä¾¿ï¼Œåˆæœ‰å±€é™æ€§ã€‚å°½ç®¡ä¸åŒçš„å…¬å¸å¯¹å­˜å‚¨è¿‡ç¨‹çš„æ€åº¦ä¸ä¸€ï¼Œä½†æ˜¯å¯¹äºæˆ‘ä»¬å¼€å‘äººå‘˜æ¥è¯´ï¼Œ ä¸è®ºæ€æ ·ï¼ŒæŒæ¡å­˜å‚¨è¿‡ç¨‹éƒ½æ˜¯å¿…å¤‡çš„æŠ€èƒ½ä¹‹ä¸€ã€‚</p><h1 id="ç¬¬16ç« -å˜é‡ã€æµç¨‹æ§åˆ¶ä¸æ¸¸æ ‡"><a href="#ç¬¬16ç« -å˜é‡ã€æµç¨‹æ§åˆ¶ä¸æ¸¸æ ‡" class="headerlink" title="ç¬¬16ç« _å˜é‡ã€æµç¨‹æ§åˆ¶ä¸æ¸¸æ ‡"></a>ç¬¬16ç« _å˜é‡ã€æµç¨‹æ§åˆ¶ä¸æ¸¸æ ‡</h1><p>åœ¨MySQLæ•°æ®åº“çš„å­˜å‚¨è¿‡ç¨‹å’Œå‡½æ•°ä¸­ï¼Œå¯ä»¥ä½¿ç”¨å˜é‡æ¥å­˜å‚¨æŸ¥è¯¢æˆ–è®¡ç®—çš„ä¸­é—´ç»“æœæ•°æ®ï¼Œæˆ–è€…è¾“å‡ºæœ€ç»ˆçš„ç»“æœæ•°æ®ã€‚</p><h2 id="1-å˜é‡"><a href="#1-å˜é‡" class="headerlink" title="1. å˜é‡"></a>1. å˜é‡</h2><p>åœ¨MySQLæ•°æ®åº“çš„å­˜å‚¨è¿‡ç¨‹å’Œå‡½æ•°ä¸­ï¼Œå¯ä»¥ä½¿ç”¨å˜é‡æ¥å­˜å‚¨æŸ¥è¯¢æˆ–è®¡ç®—çš„ä¸­é—´ç»“æœæ•°æ®ï¼Œæˆ–è€…è¾“å‡ºæœ€ç»ˆ çš„ç»“æœæ•°æ®ã€‚ </p><p>åœ¨ MySQL æ•°æ®åº“ä¸­ï¼Œå˜é‡åˆ†ä¸º ç³»ç»Ÿå˜é‡ ä»¥åŠ ç”¨æˆ·è‡ªå®šä¹‰å˜é‡ ã€‚</p><h3 id="1-ç³»ç»Ÿå˜é‡"><a href="#1-ç³»ç»Ÿå˜é‡" class="headerlink" title="1) ç³»ç»Ÿå˜é‡"></a>1) ç³»ç»Ÿå˜é‡</h3><p><strong>ç³»ç»Ÿå˜é‡åˆ†ç±»</strong></p><p>å˜é‡ç”±ç³»ç»Ÿå®šä¹‰ï¼Œä¸æ˜¯ç”¨æˆ·å®šä¹‰ï¼Œå±äº æœåŠ¡å™¨ å±‚é¢ã€‚å¯åŠ¨MySQLæœåŠ¡ï¼Œç”ŸæˆMySQLæœåŠ¡å®ä¾‹æœŸé—´ï¼Œ MySQLå°†ä¸ºMySQLæœåŠ¡å™¨å†…å­˜ä¸­çš„ç³»ç»Ÿå˜é‡èµ‹å€¼ï¼Œè¿™äº›ç³»ç»Ÿå˜é‡å®šä¹‰äº†å½“å‰MySQLæœåŠ¡å®ä¾‹çš„å±æ€§ã€ç‰¹ å¾ã€‚è¿™äº›ç³»ç»Ÿå˜é‡çš„å€¼è¦ä¹ˆæ˜¯ ç¼–è¯‘MySQLæ—¶å‚æ•° çš„é»˜è®¤å€¼ï¼Œè¦ä¹ˆæ˜¯ é…ç½®æ–‡ä»¶ ï¼ˆä¾‹å¦‚my.iniç­‰ï¼‰ä¸­çš„å‚æ•° å€¼ã€‚å¤§å®¶å¯ä»¥é€šè¿‡ç½‘å€ <a href="https://dev.mysql.com/doc/refman/8.0/en/server-systemvariables.html">https://dev.mysql.com/doc/refman/8.0/en/server-systemvariables.html</a> æŸ¥çœ‹MySQLæ–‡æ¡£çš„ç³»ç»Ÿå˜é‡ã€‚</p><p>ç³»ç»Ÿå˜é‡åˆ†ä¸ºå…¨å±€ç³»ç»Ÿå˜é‡ï¼ˆéœ€è¦æ·»åŠ  global å…³é”®å­—ï¼‰ä»¥åŠä¼šè¯ç³»ç»Ÿå˜é‡ï¼ˆéœ€è¦æ·»åŠ  session å…³é”®å­—ï¼‰ï¼Œæœ‰æ—¶ä¹ŸæŠŠå…¨å±€ç³»ç»Ÿå˜é‡ç®€ç§°ä¸ºå…¨å±€å˜é‡ï¼Œæœ‰æ—¶ä¹ŸæŠŠä¼šè¯ç³»ç»Ÿå˜é‡ç§°ä¸ºlocalå˜é‡ã€‚å¦‚æœä¸å†™ï¼Œé»˜è®¤ä¼šè¯çº§åˆ«ã€‚é™æ€å˜é‡ï¼ˆåœ¨ MySQL æœåŠ¡å®ä¾‹è¿è¡ŒæœŸé—´å®ƒä»¬çš„å€¼ä¸èƒ½ä½¿ç”¨ set åŠ¨æ€ä¿®æ”¹ï¼‰å±äºç‰¹æ®Šçš„å…¨å±€ç³»ç»Ÿå˜é‡ã€‚</p><p>æ¯ä¸€ä¸ªMySQLå®¢æˆ·æœºæˆåŠŸè¿æ¥MySQLæœåŠ¡å™¨åï¼Œéƒ½ä¼šäº§ç”Ÿä¸ä¹‹å¯¹åº”çš„ä¼šè¯ã€‚ä¼šè¯æœŸé—´ï¼ŒMySQLæœåŠ¡å®ä¾‹ä¼šåœ¨MySQLæœåŠ¡å™¨å†…å­˜ä¸­ç”Ÿæˆä¸è¯¥ä¼šè¯å¯¹åº”çš„ä¼šè¯ç³»ç»Ÿå˜é‡ï¼Œè¿™äº›ä¼šè¯ç³»ç»Ÿå˜é‡çš„åˆå§‹å€¼æ˜¯å…¨å±€ç³»ç»Ÿå˜é‡å€¼çš„å¤åˆ¶ã€‚å¦‚ä¸‹å›¾ï¼š</p><img src="/2023/03/04/00-Mysql%E5%9F%BA%E7%A1%80%E7%AF%87/image-20220613135809104.png" class=""><ul><li>å…¨å±€ç³»ç»Ÿå˜é‡é’ˆå¯¹äºæ‰€æœ‰ä¼šè¯ï¼ˆè¿æ¥ï¼‰æœ‰æ•ˆï¼Œä½† ä¸èƒ½è·¨é‡å¯</li><li>ä¼šè¯ç³»ç»Ÿå˜é‡ä»…é’ˆå¯¹äºå½“å‰ä¼šè¯ï¼ˆè¿æ¥ï¼‰æœ‰æ•ˆã€‚ä¼šè¯æœŸé—´ï¼Œå½“å‰ä¼šè¯å¯¹æŸä¸ªä¼šè¯ç³»ç»Ÿå˜é‡å€¼çš„ä¿®æ”¹ï¼Œä¸ä¼šå½±å“å…¶ä»–ä¼šè¯åŒä¸€ä¸ªä¼šè¯ç³»ç»Ÿå˜é‡çš„å€¼ã€‚ </li><li>ä¼šè¯1å¯¹æŸä¸ªå…¨å±€ç³»ç»Ÿå˜é‡å€¼çš„ä¿®æ”¹ä¼šå¯¼è‡´ä¼šè¯2ä¸­åŒä¸€ä¸ªå…¨å±€ç³»ç»Ÿå˜é‡å€¼çš„ä¿®æ”¹ã€‚</li></ul><p>åœ¨MySQLä¸­æœ‰äº›ç³»ç»Ÿå˜é‡åªèƒ½æ˜¯å…¨å±€çš„ï¼Œä¾‹å¦‚ max_connections ç”¨äºé™åˆ¶æœåŠ¡å™¨çš„æœ€å¤§è¿æ¥æ•°ï¼›æœ‰äº›ç³» ç»Ÿå˜é‡ä½œç”¨åŸŸæ—¢å¯ä»¥æ˜¯å…¨å±€åˆå¯ä»¥æ˜¯ä¼šè¯ï¼Œä¾‹å¦‚ character_set_client ç”¨äºè®¾ç½®å®¢æˆ·ç«¯çš„å­—ç¬¦é›†ï¼›æœ‰äº›ç³» ç»Ÿå˜é‡çš„ä½œç”¨åŸŸåªèƒ½æ˜¯å½“å‰ä¼šè¯ï¼Œä¾‹å¦‚ pseudo_thread_id ç”¨äºæ ‡è®°å½“å‰ä¼šè¯çš„ MySQL è¿æ¥ IDã€‚</p><p><strong>æŸ¥çœ‹ç³»ç»Ÿå˜é‡</strong></p><ul><li>æŸ¥çœ‹æ‰€æœ‰æˆ–éƒ¨åˆ†ç³»ç»Ÿå˜é‡</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#æŸ¥çœ‹æ‰€æœ‰å…¨å±€å˜é‡</span><br><span class="line">SHOW GLOBAL VARIABLES;</span><br><span class="line">#æŸ¥çœ‹æ‰€æœ‰ä¼šè¯å˜é‡</span><br><span class="line">SHOW SESSION VARIABLES;</span><br><span class="line">æˆ–</span><br><span class="line">SHOW VARIABLES;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#æŸ¥çœ‹æ»¡è¶³æ¡ä»¶çš„éƒ¨åˆ†ç³»ç»Ÿå˜é‡ã€‚</span><br><span class="line">SHOW GLOBAL VARIABLES LIKE &#x27;%æ ‡è¯†ç¬¦%&#x27;;</span><br><span class="line">#æŸ¥çœ‹æ»¡è¶³æ¡ä»¶çš„éƒ¨åˆ†ä¼šè¯å˜é‡</span><br><span class="line">SHOW SESSION VARIABLES LIKE &#x27;%æ ‡è¯†ç¬¦%&#x27;;</span><br></pre></td></tr></table></figure><p><strong>æŸ¥çœ‹æŒ‡å®šç³»ç»Ÿå˜é‡</strong></p><p>ä½œä¸º MySQL ç¼–ç è§„èŒƒï¼ŒMySQL ä¸­çš„ç³»ç»Ÿå˜é‡ä»¥ ä¸¤ä¸ªâ€œ@â€ å¼€å¤´ï¼Œå…¶ä¸­â€œ@@globalâ€ä»…ç”¨äºæ ‡è®°å…¨å±€ç³»ç»Ÿå˜é‡ï¼Œâ€œ@@sessionâ€ä»…ç”¨äºæ ‡è®°ä¼šè¯ç³»ç»Ÿå˜é‡ã€‚â€œ@@â€é¦–å…ˆæ ‡è®°ä¼šè¯ç³»ç»Ÿå˜é‡ï¼Œå¦‚æœä¼šè¯ç³»ç»Ÿå˜é‡ä¸å­˜åœ¨ï¼Œ åˆ™æ ‡è®°å…¨å±€ç³»ç»Ÿå˜é‡ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#æŸ¥çœ‹æŒ‡å®šçš„ç³»ç»Ÿå˜é‡çš„å€¼</span><br><span class="line">SELECT @@global.å˜é‡å;</span><br><span class="line">#æŸ¥çœ‹æŒ‡å®šçš„ä¼šè¯å˜é‡çš„å€¼</span><br><span class="line">SELECT @@session.å˜é‡å;</span><br><span class="line">#æˆ–è€…</span><br><span class="line">SELECT @@å˜é‡å;</span><br></pre></td></tr></table></figure><p><strong>ä¿®æ”¹ç³»ç»Ÿå˜é‡çš„å€¼</strong></p><p>æœ‰äº›æ—¶å€™ï¼Œæ•°æ®åº“ç®¡ç†å‘˜éœ€è¦ä¿®æ”¹ç³»ç»Ÿå˜é‡çš„é»˜è®¤å€¼ï¼Œä»¥ä¾¿ä¿®æ”¹å½“å‰ä¼šè¯æˆ–è€…MySQLæœåŠ¡å®ä¾‹çš„å±æ€§ã€ ç‰¹å¾ã€‚å…·ä½“æ–¹æ³•ï¼š</p><p>æ–¹å¼1ï¼šä¿®æ”¹MySQL é…ç½®æ–‡ä»¶ ï¼Œç»§è€Œä¿®æ”¹MySQLç³»ç»Ÿå˜é‡çš„å€¼ï¼ˆè¯¥æ–¹æ³•éœ€è¦é‡å¯MySQLæœåŠ¡ï¼‰ </p><p>æ–¹å¼2ï¼šåœ¨MySQLæœåŠ¡è¿è¡ŒæœŸé—´ï¼Œä½¿ç”¨â€œsetâ€å‘½ä»¤é‡æ–°è®¾ç½®ç³»ç»Ÿå˜é‡çš„å€¼</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#ä¸ºæŸä¸ªç³»ç»Ÿå˜é‡èµ‹å€¼</span><br><span class="line">#æ–¹å¼1ï¼š</span><br><span class="line">SET @@global.å˜é‡å=å˜é‡å€¼;</span><br><span class="line">#æ–¹å¼2ï¼š</span><br><span class="line">SET GLOBAL å˜é‡å=å˜é‡å€¼;</span><br><span class="line">#ä¸ºæŸä¸ªä¼šè¯å˜é‡èµ‹å€¼</span><br><span class="line">#æ–¹å¼1ï¼š</span><br><span class="line">SET @@session.å˜é‡å=å˜é‡å€¼;</span><br><span class="line">#æ–¹å¼2ï¼š</span><br><span class="line">SET SESSION å˜é‡å=å˜é‡å€¼;</span><br></pre></td></tr></table></figure><h3 id="2-ç”¨æˆ·å˜é‡"><a href="#2-ç”¨æˆ·å˜é‡" class="headerlink" title="2) ç”¨æˆ·å˜é‡"></a>2) ç”¨æˆ·å˜é‡</h3><p><strong>ç”¨æˆ·å˜é‡åˆ†ç±»</strong></p><p>ç”¨æˆ·å˜é‡æ˜¯ç”¨æˆ·è‡ªå·±å®šä¹‰çš„ï¼Œä½œä¸º MySQL ç¼–ç è§„èŒƒï¼ŒMySQL ä¸­çš„ç”¨æˆ·å˜é‡ä»¥ä¸€ä¸ªâ€œ@â€ å¼€å¤´ã€‚æ ¹æ®ä½œç”¨èŒƒå›´ä¸åŒï¼Œåˆåˆ†ä¸º ä¼šè¯ç”¨æˆ·å˜é‡ å’Œ å±€éƒ¨å˜é‡ ã€‚ </p><ul><li>ä¼šè¯ç”¨æˆ·å˜é‡ï¼šä½œç”¨åŸŸå’Œä¼šè¯å˜é‡ä¸€æ ·ï¼Œåªå¯¹ å½“å‰è¿æ¥ ä¼šè¯æœ‰æ•ˆã€‚ </li><li>å±€éƒ¨å˜é‡ï¼šåªåœ¨ BEGIN å’Œ END è¯­å¥å—ä¸­æœ‰æ•ˆã€‚å±€éƒ¨å˜é‡åªèƒ½åœ¨ å­˜å‚¨è¿‡ç¨‹å’Œå‡½æ•° ä¸­ä½¿ç”¨ã€‚</li></ul><p><strong>ä¼šè¯ç”¨æˆ·å˜é‡</strong></p><ul><li>å˜é‡çš„å®šä¹‰</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#æ–¹å¼1ï¼šâ€œ=â€æˆ–â€œ:=â€</span><br><span class="line">SET @ç”¨æˆ·å˜é‡ = å€¼;</span><br><span class="line">SET @ç”¨æˆ·å˜é‡ := å€¼;</span><br><span class="line">#æ–¹å¼2ï¼šâ€œ:=â€ æˆ– INTOå…³é”®å­—</span><br><span class="line">SELECT @ç”¨æˆ·å˜é‡ := è¡¨è¾¾å¼ [FROM ç­‰å­å¥];</span><br><span class="line">SELECT è¡¨è¾¾å¼ INTO @ç”¨æˆ·å˜é‡ [FROM ç­‰å­å¥];</span><br></pre></td></tr></table></figure><ul><li>æŸ¥çœ‹ç”¨æˆ·å˜é‡çš„å€¼ (æŸ¥çœ‹ã€æ¯”è¾ƒã€è¿ç®—ç­‰)</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT @ç”¨æˆ·å˜é‡</span><br></pre></td></tr></table></figure><p><strong>å±€éƒ¨å˜é‡</strong></p><p>å®šä¹‰ï¼šå¯ä»¥ä½¿ç”¨ DECLARE è¯­å¥å®šä¹‰ä¸€ä¸ªå±€éƒ¨å˜é‡ </p><p>ä½œç”¨åŸŸï¼šä»…ä»…åœ¨å®šä¹‰å®ƒçš„ BEGIN â€¦ END ä¸­æœ‰æ•ˆ </p><p>ä½ç½®ï¼šåªèƒ½æ”¾åœ¨ BEGIN â€¦ END ä¸­ï¼Œè€Œä¸”åªèƒ½æ”¾åœ¨ç¬¬ä¸€å¥</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">BEGIN</span><br><span class="line">#å£°æ˜å±€éƒ¨å˜é‡</span><br><span class="line">DECLARE å˜é‡å1 å˜é‡æ•°æ®ç±»å‹ [DEFAULT å˜é‡é»˜è®¤å€¼];</span><br><span class="line">DECLARE å˜é‡å2,å˜é‡å3,... å˜é‡æ•°æ®ç±»å‹ [DEFAULT å˜é‡é»˜è®¤å€¼];</span><br><span class="line">#ä¸ºå±€éƒ¨å˜é‡èµ‹å€¼</span><br><span class="line">SET å˜é‡å1 = å€¼;</span><br><span class="line">SELECT å€¼ INTO å˜é‡å2 [FROM å­å¥];</span><br><span class="line">#æŸ¥çœ‹å±€éƒ¨å˜é‡çš„å€¼</span><br><span class="line">SELECT å˜é‡1,å˜é‡2,å˜é‡3;</span><br><span class="line">END</span><br></pre></td></tr></table></figure><ol><li>å®šä¹‰å˜é‡</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DECLARE å˜é‡å ç±»å‹ [default å€¼]; # å¦‚æœæ²¡æœ‰DEFAULTå­å¥ï¼Œåˆå§‹å€¼ä¸ºNULL</span><br></pre></td></tr></table></figure><ol start="2"><li>å˜é‡èµ‹å€¼</li></ol><p>æ–¹å¼1ï¼šä¸€èˆ¬ç”¨äºèµ‹ç®€å•çš„å€¼</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SET å˜é‡å=å€¼;</span><br><span class="line">SET å˜é‡å:=å€¼;</span><br></pre></td></tr></table></figure><p>æ–¹å¼2ï¼šä¸€èˆ¬ç”¨äºèµ‹è¡¨ä¸­çš„å­—æ®µå€¼</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT å­—æ®µåæˆ–è¡¨è¾¾å¼ INTO å˜é‡å FROM è¡¨;</span><br></pre></td></tr></table></figure><ol start="3"><li>ä½¿ç”¨å˜é‡ (æŸ¥çœ‹ã€æ¯”è¾ƒã€è¿ç®—ç­‰)</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT å±€éƒ¨å˜é‡å;</span><br></pre></td></tr></table></figure><p>ä¸¾ä¾‹1ï¼šå£°æ˜å±€éƒ¨å˜é‡ï¼Œå¹¶åˆ†åˆ«èµ‹å€¼ä¸ºemployeesè¡¨ä¸­employee_idä¸º102çš„last_nameå’Œsalary</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER //</span><br><span class="line">CREATE PROCEDURE set_value()</span><br><span class="line">BEGIN</span><br><span class="line">DECLARE emp_name VARCHAR(25);</span><br><span class="line">DECLARE sal DOUBLE(10,2);</span><br><span class="line">SELECT last_name, salary INTO emp_name,sal</span><br><span class="line">FROM employees</span><br><span class="line">WHERE employee_id = 102;</span><br><span class="line">SELECT emp_name, sal;</span><br><span class="line">END //</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure><p>ä¸¾ä¾‹2ï¼šå£°æ˜ä¸¤ä¸ªå˜é‡ï¼Œæ±‚å’Œå¹¶æ‰“å° ï¼ˆåˆ†åˆ«ä½¿ç”¨ä¼šè¯ç”¨æˆ·å˜é‡ã€å±€éƒ¨å˜é‡çš„æ–¹å¼å®ç°ï¼‰</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">#æ–¹å¼1ï¼šä½¿ç”¨ç”¨æˆ·å˜é‡</span><br><span class="line">SET @m=1;</span><br><span class="line">SET @n=1;</span><br><span class="line">SET @sum=@m+@n;</span><br><span class="line">SELECT @sum;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">#æ–¹å¼2ï¼šä½¿ç”¨å±€éƒ¨å˜é‡</span><br><span class="line">DELIMITER //</span><br><span class="line">CREATE PROCEDURE add_value()</span><br><span class="line">BEGIN</span><br><span class="line">#å±€éƒ¨å˜é‡</span><br><span class="line">DECLARE m INT DEFAULT 1;</span><br><span class="line">DECLARE n INT DEFAULT 3;</span><br><span class="line">DECLARE SUM INT;</span><br><span class="line">SET SUM = m+n;</span><br><span class="line">SELECT SUM;</span><br><span class="line">END //</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure><p><strong>å¯¹æ¯”ä¼šè¯ç”¨æˆ·å˜é‡ä¸å±€éƒ¨å˜é‡</strong></p><table><thead><tr><th></th><th>ä½œç”¨åŸŸ</th><th>å®šä¹‰ä½ç½®</th><th>è¯­æ³•</th></tr></thead><tbody><tr><td>ä¼šè¯ç”¨æˆ·å˜é‡</td><td>å½“å‰ä¼šè¯</td><td>ä¼šè¯çš„ä»»ä½•åœ°æ–¹</td><td>åŠ @ç¬¦å·ï¼Œä¸ç”¨æŒ‡å®šç±»å‹</td></tr><tr><td>å±€éƒ¨å˜é‡</td><td>å®šä¹‰å®ƒçš„BEGIN ENDä¸­</td><td>BEGIN ENDçš„ç¬¬ä¸€å¥è¯</td><td>ä¸€èˆ¬ä¸ç”¨åŠ @,éœ€è¦æŒ‡å®šç±»å‹</td></tr></tbody></table><h2 id="2-å®šä¹‰æ¡ä»¶ä¸å¤„ç†ç¨‹åº"><a href="#2-å®šä¹‰æ¡ä»¶ä¸å¤„ç†ç¨‹åº" class="headerlink" title="2. å®šä¹‰æ¡ä»¶ä¸å¤„ç†ç¨‹åº"></a>2. å®šä¹‰æ¡ä»¶ä¸å¤„ç†ç¨‹åº</h2><p>å®šä¹‰æ¡ä»¶ æ˜¯äº‹å…ˆå®šä¹‰ç¨‹åºæ‰§è¡Œè¿‡ç¨‹ä¸­å¯èƒ½é‡åˆ°çš„é—®é¢˜ï¼Œ å¤„ç†ç¨‹åº å®šä¹‰äº†åœ¨é‡åˆ°é—®é¢˜æ—¶åº”å½“é‡‡å–çš„å¤„ç†æ–¹å¼ï¼Œå¹¶ä¸”ä¿è¯å­˜å‚¨è¿‡ç¨‹æˆ–å‡½æ•°åœ¨é‡åˆ°è­¦å‘Šæˆ–é”™è¯¯æ—¶èƒ½ç»§ç»­æ‰§è¡Œã€‚è¿™æ ·å¯ä»¥å¢å¼ºå­˜å‚¨ç¨‹åºå¤„ç†é—®é¢˜çš„èƒ½åŠ›ï¼Œé¿å…ç¨‹åºå¼‚å¸¸åœæ­¢è¿è¡Œã€‚</p><p>è¯´æ˜ï¼šå®šä¹‰æ¡ä»¶å’Œå¤„ç†ç¨‹åºåœ¨å­˜å‚¨è¿‡ç¨‹ã€å­˜å‚¨å‡½æ•°ä¸­éƒ½æ˜¯æ”¯æŒçš„ã€‚</p><h3 id="1-æ¡ˆä¾‹åˆ†æ"><a href="#1-æ¡ˆä¾‹åˆ†æ" class="headerlink" title="1) æ¡ˆä¾‹åˆ†æ"></a>1) æ¡ˆä¾‹åˆ†æ</h3><p>æ¡ˆä¾‹åˆ†æï¼šåˆ›å»ºä¸€ä¸ªåç§°ä¸ºâ€œUpdateDataNoConditionâ€çš„å­˜å‚¨è¿‡ç¨‹ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER //</span><br><span class="line">CREATE PROCEDURE UpdateDataNoCondition()</span><br><span class="line">BEGIN</span><br><span class="line">SET @x = 1;</span><br><span class="line">UPDATE employees SET email = NULL WHERE last_name = &#x27;Abel&#x27;;</span><br><span class="line">SET @x = 2;</span><br><span class="line">UPDATE employees SET email = &#x27;aabbel&#x27; WHERE last_name = &#x27;Abel&#x27;;</span><br><span class="line">SET @x = 3;</span><br><span class="line">END //</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨å­˜å‚¨è¿‡ç¨‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; CALL UpdateDataNoCondition();</span><br><span class="line">ERROR 1048 (23000): Column &#x27;email&#x27; cannot be null</span><br><span class="line">mysql&gt; SELECT @x;</span><br><span class="line">+------+</span><br><span class="line">| @x |</span><br><span class="line">+------+</span><br><span class="line">| 1 |</span><br><span class="line">+------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œæ­¤æ—¶@xå˜é‡çš„å€¼ä¸º1ã€‚ç»“åˆåˆ›å»ºå­˜å‚¨è¿‡ç¨‹çš„SQLè¯­å¥ä»£ç å¯ä»¥å¾—å‡ºï¼šåœ¨å­˜å‚¨è¿‡ç¨‹ä¸­æœªå®šä¹‰æ¡ä»¶ å’Œå¤„ç†ç¨‹åºï¼Œä¸”å½“å­˜å‚¨è¿‡ç¨‹ä¸­æ‰§è¡Œçš„SQLè¯­å¥æŠ¥é”™æ—¶ï¼ŒMySQLæ•°æ®åº“ä¼šæŠ›å‡ºé”™è¯¯ï¼Œå¹¶é€€å‡ºå½“å‰SQLé€»è¾‘ï¼Œ ä¸å†å‘ä¸‹ç»§ç»­æ‰§è¡Œã€‚</p><h3 id="2-å®šä¹‰æ¡ä»¶"><a href="#2-å®šä¹‰æ¡ä»¶" class="headerlink" title="2) å®šä¹‰æ¡ä»¶"></a>2) å®šä¹‰æ¡ä»¶</h3><p>å®šä¹‰æ¡ä»¶å°±æ˜¯ç»™MySQLä¸­çš„é”™è¯¯ç å‘½åï¼Œè¿™æœ‰åŠ©äºå­˜å‚¨çš„ç¨‹åºä»£ç æ›´æ¸…æ™°ã€‚å®ƒå°†ä¸€ä¸ª é”™è¯¯åå­— å’Œ æŒ‡å®šçš„ é”™è¯¯æ¡ä»¶ å…³è”èµ·æ¥ã€‚è¿™ä¸ªåå­—å¯ä»¥éšåè¢«ç”¨åœ¨å®šä¹‰å¤„ç†ç¨‹åºçš„ DECLARE HANDLER è¯­å¥ä¸­ã€‚</p><p>å®šä¹‰æ¡ä»¶ä½¿ç”¨DECLAREè¯­å¥ï¼Œè¯­æ³•æ ¼å¼å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DECLARE é”™è¯¯åç§° CONDITION FOR é”™è¯¯ç ï¼ˆæˆ–é”™è¯¯æ¡ä»¶ï¼‰</span><br></pre></td></tr></table></figure><p>é”™è¯¯ç çš„è¯´æ˜ï¼š</p><ul><li>MySQL_error_code å’Œ sqlstate_value éƒ½å¯ä»¥è¡¨ç¤ºMySQLçš„é”™è¯¯ã€‚<ul><li>MySQL_error_codeæ˜¯æ•°å€¼ç±»å‹é”™è¯¯ä»£ç ã€‚ </li><li>sqlstate_valueæ˜¯é•¿åº¦ä¸º5çš„å­—ç¬¦ä¸²ç±»å‹é”™è¯¯ä»£ç ã€‚</li></ul></li></ul><p>ä¾‹å¦‚ï¼Œåœ¨ERROR 1418 (HY000)ä¸­ï¼Œ1418æ˜¯MySQL_error_codeï¼Œâ€™HY000â€™æ˜¯sqlstate_valueã€‚ </p><p>ä¾‹å¦‚ï¼Œåœ¨ERROR 1142ï¼ˆ42000ï¼‰ä¸­ï¼Œ1142æ˜¯MySQL_error_codeï¼Œâ€™42000â€™æ˜¯sqlstate_valueã€‚</p><p>ä¸¾ä¾‹1ï¼šå®šä¹‰â€œField_Not_Be_NULLâ€é”™è¯¯åä¸MySQLä¸­è¿åéç©ºçº¦æŸçš„é”™è¯¯ç±»å‹æ˜¯â€œERROR 1048 (23000)â€å¯¹åº”ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#ä½¿ç”¨MySQL_error_code</span><br><span class="line">DECLARE Field_Not_Be_NULL CONDITION FOR 1048;</span><br><span class="line">#ä½¿ç”¨sqlstate_value</span><br><span class="line">DECLARE Field_Not_Be_NULL CONDITION FOR SQLSTATE &#x27;23000&#x27;;</span><br></pre></td></tr></table></figure><h3 id="3-å®šä¹‰å¤„ç†ç¨‹åº"><a href="#3-å®šä¹‰å¤„ç†ç¨‹åº" class="headerlink" title="3) å®šä¹‰å¤„ç†ç¨‹åº"></a>3) å®šä¹‰å¤„ç†ç¨‹åº</h3><p>å¯ä»¥ä¸ºSQLæ‰§è¡Œè¿‡ç¨‹ä¸­å‘ç”Ÿçš„æŸç§ç±»å‹çš„é”™è¯¯å®šä¹‰ç‰¹æ®Šçš„å¤„ç†ç¨‹åºã€‚å®šä¹‰å¤„ç†ç¨‹åºæ—¶ï¼Œä½¿ç”¨DECLAREè¯­å¥ çš„è¯­æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DECLARE å¤„ç†æ–¹å¼ HANDLER FOR é”™è¯¯ç±»å‹ å¤„ç†è¯­å¥</span><br></pre></td></tr></table></figure><ul><li><p>å¤„ç†æ–¹å¼ï¼šå¤„ç†æ–¹å¼æœ‰3ä¸ªå–å€¼ï¼šCONTINUEã€EXITã€UNDOã€‚</p><ul><li>CONTINUE ï¼šè¡¨ç¤ºé‡åˆ°é”™è¯¯ä¸å¤„ç†ï¼Œç»§ç»­æ‰§è¡Œã€‚</li><li>EXIT ï¼šè¡¨ç¤ºé‡åˆ°é”™è¯¯é©¬ä¸Šé€€å‡ºã€‚</li><li>UNDO ï¼šè¡¨ç¤ºé‡åˆ°é”™è¯¯åæ’¤å›ä¹‹å‰çš„æ“ä½œã€‚MySQLä¸­æš‚æ—¶ä¸æ”¯æŒè¿™æ ·çš„æ“ä½œã€‚</li></ul></li><li><p>é”™è¯¯ç±»å‹ï¼ˆå³æ¡ä»¶ï¼‰å¯ä»¥æœ‰å¦‚ä¸‹å–å€¼ï¼š</p><ul><li>SQLSTATE â€˜å­—ç¬¦ä¸²é”™è¯¯ç â€™ ï¼šè¡¨ç¤ºé•¿åº¦ä¸º5çš„sqlstate_valueç±»å‹çš„é”™è¯¯ä»£ç ï¼› </li><li>MySQL_error_code ï¼šåŒ¹é…æ•°å€¼ç±»å‹é”™è¯¯ä»£ç ï¼› </li><li>é”™è¯¯åç§° ï¼šè¡¨ç¤ºDECLARE â€¦ CONDITIONå®šä¹‰çš„é”™è¯¯æ¡ä»¶åç§°ã€‚ </li><li>SQLWARNING ï¼šåŒ¹é…æ‰€æœ‰ä»¥01å¼€å¤´çš„SQLSTATEé”™è¯¯ä»£ç ï¼› </li><li>NOT FOUND ï¼šåŒ¹é…æ‰€æœ‰ä»¥02å¼€å¤´çš„SQLSTATEé”™è¯¯ä»£ç ï¼› </li><li>SQLEXCEPTION ï¼šåŒ¹é…æ‰€æœ‰æ²¡æœ‰è¢«SQLWARNINGæˆ–NOT FOUNDæ•è·çš„SQLSTATEé”™è¯¯ä»£ç ï¼›</li></ul></li><li><p>å¤„ç†è¯­å¥ï¼šå¦‚æœå‡ºç°ä¸Šè¿°æ¡ä»¶ä¹‹ä¸€ï¼Œåˆ™é‡‡ç”¨å¯¹åº”çš„å¤„ç†æ–¹å¼ï¼Œå¹¶æ‰§è¡ŒæŒ‡å®šçš„å¤„ç†è¯­å¥ã€‚è¯­å¥å¯ä»¥æ˜¯ åƒâ€œ SET å˜é‡ &#x3D; å€¼ â€è¿™æ ·çš„ç®€å•è¯­å¥ï¼Œä¹Ÿå¯ä»¥æ˜¯ä½¿ç”¨ BEGIN â€¦ END ç¼–å†™çš„å¤åˆè¯­å¥ã€‚</p></li></ul><p>å®šä¹‰å¤„ç†ç¨‹åºçš„å‡ ç§æ–¹å¼ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#æ–¹æ³•1ï¼šæ•è·sqlstate_value</span><br><span class="line">DECLARE CONTINUE HANDLER FOR SQLSTATE &#x27;42S02&#x27; SET @info = &#x27;NO_SUCH_TABLE&#x27;;</span><br><span class="line">#æ–¹æ³•2ï¼šæ•è·mysql_error_value</span><br><span class="line">DECLARE CONTINUE HANDLER FOR 1146 SET @info = &#x27;NO_SUCH_TABLE&#x27;;</span><br><span class="line">#æ–¹æ³•3ï¼šå…ˆå®šä¹‰æ¡ä»¶ï¼Œå†è°ƒç”¨</span><br><span class="line">DECLARE no_such_table CONDITION FOR 1146;</span><br><span class="line">DECLARE CONTINUE HANDLER FOR NO_SUCH_TABLE SET @info = &#x27;NO_SUCH_TABLE&#x27;;</span><br><span class="line">#æ–¹æ³•4ï¼šä½¿ç”¨SQLWARNING</span><br><span class="line">DECLARE EXIT HANDLER FOR SQLWARNING SET @info = &#x27;ERROR&#x27;;</span><br><span class="line">#æ–¹æ³•5ï¼šä½¿ç”¨NOT FOUND</span><br><span class="line">DECLARE EXIT HANDLER FOR NOT FOUND SET @info = &#x27;NO_SUCH_TABLE&#x27;;</span><br><span class="line">#æ–¹æ³•6ï¼šä½¿ç”¨SQLEXCEPTION</span><br><span class="line">DECLARE EXIT HANDLER FOR SQLEXCEPTION SET @info = &#x27;ERROR&#x27;;</span><br></pre></td></tr></table></figure><h3 id="4-æ¡ˆä¾‹è§£å†³"><a href="#4-æ¡ˆä¾‹è§£å†³" class="headerlink" title="4) æ¡ˆä¾‹è§£å†³"></a>4) æ¡ˆä¾‹è§£å†³</h3><p>åœ¨å­˜å‚¨è¿‡ç¨‹ä¸­ï¼Œå®šä¹‰å¤„ç†ç¨‹åºï¼Œæ•è·sqlstate_valueå€¼ï¼Œå½“é‡åˆ°MySQL_error_codeå€¼ä¸º1048æ—¶ï¼Œæ‰§è¡Œ CONTINUEæ“ä½œï¼Œå¹¶ä¸”å°†@proc_valueçš„å€¼è®¾ç½®ä¸º-1ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER //</span><br><span class="line">CREATE PROCEDURE UpdateDataNoCondition()</span><br><span class="line">BEGIN</span><br><span class="line">    #å®šä¹‰å¤„ç†ç¨‹åº</span><br><span class="line">    DECLARE CONTINUE HANDLER FOR 1048 SET @proc_value = -1;</span><br><span class="line">    SET @x = 1;</span><br><span class="line">    UPDATE employees SET email = NULL WHERE last_name = &#x27;Abel&#x27;;</span><br><span class="line">    SET @x = 2;</span><br><span class="line">    UPDATE employees SET email = &#x27;aabbel&#x27; WHERE last_name = &#x27;Abel&#x27;;</span><br><span class="line">    SET @x = 3;</span><br><span class="line">END //</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure><h2 id="3-æµç¨‹æ§åˆ¶"><a href="#3-æµç¨‹æ§åˆ¶" class="headerlink" title="3. æµç¨‹æ§åˆ¶"></a>3. æµç¨‹æ§åˆ¶</h2><p>è§£å†³å¤æ‚é—®é¢˜ä¸å¯èƒ½é€šè¿‡ä¸€ä¸ª SQL è¯­å¥å®Œæˆï¼Œæˆ‘ä»¬éœ€è¦æ‰§è¡Œå¤šä¸ª SQL æ“ä½œã€‚æµç¨‹æ§åˆ¶è¯­å¥çš„ä½œç”¨å°±æ˜¯æ§ åˆ¶å­˜å‚¨è¿‡ç¨‹ä¸­ SQL è¯­å¥çš„æ‰§è¡Œé¡ºåºï¼Œæ˜¯æˆ‘ä»¬å®Œæˆå¤æ‚æ“ä½œå¿…ä¸å¯å°‘çš„ä¸€éƒ¨åˆ†ã€‚åªè¦æ˜¯æ‰§è¡Œçš„ç¨‹åºï¼Œæµç¨‹å°±åˆ†ä¸ºä¸‰å¤§ç±»ï¼š</p><ul><li>é¡ºåºç»“æ„ ï¼šç¨‹åºä»ä¸Šå¾€ä¸‹ä¾æ¬¡æ‰§è¡Œ </li><li>åˆ†æ”¯ç»“æ„ ï¼šç¨‹åºæŒ‰æ¡ä»¶è¿›è¡Œé€‰æ‹©æ‰§è¡Œï¼Œä»ä¸¤æ¡æˆ–å¤šæ¡è·¯å¾„ä¸­é€‰æ‹©ä¸€æ¡æ‰§è¡Œ </li><li>å¾ªç¯ç»“æ„ ï¼šç¨‹åºæ»¡è¶³ä¸€å®šæ¡ä»¶ä¸‹ï¼Œé‡å¤æ‰§è¡Œä¸€ç»„è¯­å¥</li></ul><p>é’ˆå¯¹äºMySQL çš„æµç¨‹æ§åˆ¶è¯­å¥ä¸»è¦æœ‰ 3 ç±»ã€‚æ³¨æ„ï¼šåªèƒ½ç”¨äºå­˜å‚¨ç¨‹åºã€‚</p><ul><li>æ¡ä»¶åˆ¤æ–­è¯­å¥ ï¼šIF è¯­å¥å’Œ CASE è¯­å¥ </li><li>å¾ªç¯è¯­å¥ ï¼šLOOPã€WHILE å’Œ REPEAT è¯­å¥ </li><li>è·³è½¬è¯­å¥ ï¼šITERATE å’Œ LEAVE è¯­å¥</li></ul><h3 id="1-åˆ†æ”¯ç»“æ„ä¹‹-IF"><a href="#1-åˆ†æ”¯ç»“æ„ä¹‹-IF" class="headerlink" title="1) åˆ†æ”¯ç»“æ„ä¹‹ IF"></a>1) åˆ†æ”¯ç»“æ„ä¹‹ IF</h3><ul><li>IF è¯­å¥çš„è¯­æ³•ç»“æ„æ˜¯ï¼š</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">IF è¡¨è¾¾å¼1 THEN æ“ä½œ1</span><br><span class="line">[ELSEIF è¡¨è¾¾å¼2 THEN æ“ä½œ2]â€¦â€¦</span><br><span class="line">[ELSE æ“ä½œN]</span><br><span class="line">END IF</span><br></pre></td></tr></table></figure><p>æ ¹æ®è¡¨è¾¾å¼çš„ç»“æœä¸ºTRUEæˆ–FALSEæ‰§è¡Œç›¸åº”çš„è¯­å¥ã€‚è¿™é‡Œâ€œ[]â€ä¸­çš„å†…å®¹æ˜¯å¯é€‰çš„ã€‚</p><ul><li><p>ç‰¹ç‚¹ï¼šâ‘  ä¸åŒçš„è¡¨è¾¾å¼å¯¹åº”ä¸åŒçš„æ“ä½œ â‘¡ ä½¿ç”¨åœ¨begin endä¸­</p></li><li><p>ä¸¾ä¾‹1ï¼š</p></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">IF val IS NULL</span><br><span class="line">THEN SELECT &#x27;val is null&#x27;;</span><br><span class="line">ELSE SELECT &#x27;val is not null&#x27;;</span><br><span class="line">END IF;</span><br></pre></td></tr></table></figure><ul><li>ä¸¾ä¾‹2ï¼šå£°æ˜å­˜å‚¨è¿‡ç¨‹â€œupdate_salary_by_eid1â€ï¼Œå®šä¹‰INå‚æ•°emp_idï¼Œè¾“å…¥å‘˜å·¥ç¼–å·ã€‚åˆ¤æ–­è¯¥å‘˜å·¥è–ªèµ„å¦‚æœä½äº8000å…ƒå¹¶ä¸”å…¥èŒæ—¶é—´è¶…è¿‡5å¹´ï¼Œå°±æ¶¨è–ª500å…ƒï¼›å¦åˆ™å°±ä¸å˜ã€‚</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER //</span><br><span class="line">CREATE PROCEDURE update_salary_by_eid1(IN emp_id INT)</span><br><span class="line">BEGIN</span><br><span class="line">    DECLARE emp_salary DOUBLE;</span><br><span class="line">    DECLARE hire_year DOUBLE;</span><br><span class="line">    SELECT salary INTO emp_salary FROM employees WHERE employee_id = emp_id;</span><br><span class="line">    SELECT DATEDIFF(CURDATE(),hire_date)/365 INTO hire_year</span><br><span class="line">    FROM employees WHERE employee_id = emp_id;</span><br><span class="line">    IF emp_salary &lt; 8000 AND hire_year &gt; 5</span><br><span class="line">    THEN UPDATE employees SET salary = salary + 500 WHERE employee_id = emp_id;</span><br><span class="line">    END IF;</span><br><span class="line">END //</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure><h3 id="2-åˆ†æ”¯ç»“æ„ä¹‹-CASE"><a href="#2-åˆ†æ”¯ç»“æ„ä¹‹-CASE" class="headerlink" title="2) åˆ†æ”¯ç»“æ„ä¹‹ CASE"></a>2) åˆ†æ”¯ç»“æ„ä¹‹ CASE</h3><ul><li>CASE è¯­å¥çš„è¯­æ³•ç»“æ„1ï¼š</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#æƒ…å†µä¸€ï¼šç±»ä¼¼äºswitch</span><br><span class="line">CASE è¡¨è¾¾å¼</span><br><span class="line">WHEN å€¼1 THEN ç»“æœ1æˆ–è¯­å¥1(å¦‚æœæ˜¯è¯­å¥ï¼Œéœ€è¦åŠ åˆ†å·)</span><br><span class="line">WHEN å€¼2 THEN ç»“æœ2æˆ–è¯­å¥2(å¦‚æœæ˜¯è¯­å¥ï¼Œéœ€è¦åŠ åˆ†å·)</span><br><span class="line">...</span><br><span class="line">ELSE ç»“æœnæˆ–è¯­å¥n(å¦‚æœæ˜¯è¯­å¥ï¼Œéœ€è¦åŠ åˆ†å·)</span><br><span class="line">END [case]ï¼ˆå¦‚æœæ˜¯æ”¾åœ¨begin endä¸­éœ€è¦åŠ ä¸Šcaseï¼Œå¦‚æœæ”¾åœ¨selectåé¢ä¸éœ€è¦ï¼‰</span><br></pre></td></tr></table></figure><ul><li>CASE è¯­å¥çš„è¯­æ³•ç»“æ„2ï¼š</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#æƒ…å†µäºŒï¼šç±»ä¼¼äºå¤šé‡if</span><br><span class="line">CASE</span><br><span class="line">WHEN æ¡ä»¶1 THEN ç»“æœ1æˆ–è¯­å¥1(å¦‚æœæ˜¯è¯­å¥ï¼Œéœ€è¦åŠ åˆ†å·)</span><br><span class="line">WHEN æ¡ä»¶2 THEN ç»“æœ2æˆ–è¯­å¥2(å¦‚æœæ˜¯è¯­å¥ï¼Œéœ€è¦åŠ åˆ†å·)</span><br><span class="line">...</span><br><span class="line">ELSE ç»“æœnæˆ–è¯­å¥n(å¦‚æœæ˜¯è¯­å¥ï¼Œéœ€è¦åŠ åˆ†å·)</span><br><span class="line">END [case]ï¼ˆå¦‚æœæ˜¯æ”¾åœ¨begin endä¸­éœ€è¦åŠ ä¸Šcaseï¼Œå¦‚æœæ”¾åœ¨selectåé¢ä¸éœ€è¦ï¼‰</span><br></pre></td></tr></table></figure><ul><li>ä¸¾ä¾‹1ï¼šä½¿ç”¨CASEæµç¨‹æ§åˆ¶è¯­å¥çš„ç¬¬1ç§æ ¼å¼ï¼Œåˆ¤æ–­valå€¼ç­‰äº1ã€ç­‰äº2ï¼Œæˆ–è€…ä¸¤è€…éƒ½ä¸ç­‰ã€‚</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CASE val</span><br><span class="line">    WHEN 1 THEN SELECT &#x27;val is 1&#x27;;</span><br><span class="line">    WHEN 2 THEN SELECT &#x27;val is 2&#x27;;</span><br><span class="line">    ELSE SELECT &#x27;val is not 1 or 2&#x27;;</span><br><span class="line">END CASE;</span><br></pre></td></tr></table></figure><ul><li>ä¸¾ä¾‹2ï¼šå£°æ˜å­˜å‚¨è¿‡ç¨‹â€œupdate_salary_by_eid4â€ï¼Œå®šä¹‰INå‚æ•°emp_idï¼Œè¾“å…¥å‘˜å·¥ç¼–å·ã€‚åˆ¤æ–­è¯¥å‘˜å·¥ è–ªèµ„å¦‚æœä½äº9000å…ƒï¼Œå°±æ›´æ–°è–ªèµ„ä¸º9000å…ƒï¼›è–ªèµ„å¤§äºç­‰äº9000å…ƒä¸”ä½äº10000çš„ï¼Œä½†æ˜¯å¥–é‡‘æ¯”ä¾‹ ä¸ºNULLçš„ï¼Œå°±æ›´æ–°å¥–é‡‘æ¯”ä¾‹ä¸º0.01ï¼›å…¶ä»–çš„æ¶¨è–ª100å…ƒã€‚</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER //</span><br><span class="line">CREATE PROCEDURE update_salary_by_eid4(IN emp_id INT)</span><br><span class="line">BEGIN</span><br><span class="line">    DECLARE emp_sal DOUBLE;</span><br><span class="line">    DECLARE bonus DECIMAL(3,2);</span><br><span class="line">    SELECT salary INTO emp_sal FROM employees WHERE employee_id = emp_id;</span><br><span class="line">    SELECT commission_pct INTO bonus FROM employees WHERE employee_id = emp_id;</span><br><span class="line">    CASE</span><br><span class="line">    WHEN emp_sal&lt;9000</span><br><span class="line">    THEN UPDATE employees SET salary=9000 WHERE employee_id = emp_id;</span><br><span class="line">    WHEN emp_sal&lt;10000 AND bonus IS NULL</span><br><span class="line">    THEN UPDATE employees SET commission_pct=0.01 WHERE employee_id = emp_id;</span><br><span class="line">    ELSE</span><br><span class="line">    UPDATE employees SET salary=salary+100 WHERE employee_id = emp_id;</span><br><span class="line">    END CASE;</span><br><span class="line">END //</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure><ul><li>ä¸¾ä¾‹3ï¼šå£°æ˜å­˜å‚¨è¿‡ç¨‹update_salary_by_eid5ï¼Œå®šä¹‰INå‚æ•°emp_idï¼Œè¾“å…¥å‘˜å·¥ç¼–å·ã€‚åˆ¤æ–­è¯¥å‘˜å·¥çš„ å…¥èŒå¹´é™ï¼Œå¦‚æœæ˜¯0å¹´ï¼Œè–ªèµ„æ¶¨50ï¼›å¦‚æœæ˜¯1å¹´ï¼Œè–ªèµ„æ¶¨100ï¼›å¦‚æœæ˜¯2å¹´ï¼Œè–ªèµ„æ¶¨200ï¼›å¦‚æœæ˜¯3å¹´ï¼Œ è–ªèµ„æ¶¨300ï¼›å¦‚æœæ˜¯4å¹´ï¼Œè–ªèµ„æ¶¨400ï¼›å…¶ä»–çš„æ¶¨è–ª500ã€‚</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER //</span><br><span class="line">CREATE PROCEDURE update_salary_by_eid5(IN emp_id INT)</span><br><span class="line">BEGIN</span><br><span class="line">    DECLARE emp_sal DOUBLE;</span><br><span class="line">    DECLARE hire_year DOUBLE;</span><br><span class="line">    SELECT salary INTO emp_sal FROM employees WHERE employee_id = emp_id;</span><br><span class="line">    SELECT ROUND(DATEDIFF(CURDATE(),hire_date)/365) INTO hire_year FROM employees</span><br><span class="line">    WHERE employee_id = emp_id;</span><br><span class="line">    CASE hire_year</span><br><span class="line">        WHEN 0 THEN UPDATE employees SET salary=salary+50 WHERE employee_id = emp_id;</span><br><span class="line">        WHEN 1 THEN UPDATE employees SET salary=salary+100 WHERE employee_id = emp_id;</span><br><span class="line">        WHEN 2 THEN UPDATE employees SET salary=salary+200 WHERE employee_id = emp_id;</span><br><span class="line">        WHEN 3 THEN UPDATE employees SET salary=salary+300 WHERE employee_id = emp_id;</span><br><span class="line">        WHEN 4 THEN UPDATE employees SET salary=salary+400 WHERE employee_id = emp_id;</span><br><span class="line">        ELSE UPDATE employees SET salary=salary+500 WHERE employee_id = emp_id;</span><br><span class="line">    END CASE;</span><br><span class="line">END //</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure><h3 id="3-å¾ªç¯ç»“æ„ä¹‹LOOP"><a href="#3-å¾ªç¯ç»“æ„ä¹‹LOOP" class="headerlink" title="3) å¾ªç¯ç»“æ„ä¹‹LOOP"></a>3) å¾ªç¯ç»“æ„ä¹‹LOOP</h3><p>LOOPå¾ªç¯è¯­å¥ç”¨æ¥é‡å¤æ‰§è¡ŒæŸäº›è¯­å¥ã€‚LOOPå†…çš„è¯­å¥ä¸€ç›´é‡å¤æ‰§è¡Œç›´åˆ°å¾ªç¯è¢«é€€å‡ºï¼ˆä½¿ç”¨LEAVEå­ å¥ï¼‰ï¼Œè·³å‡ºå¾ªç¯è¿‡ç¨‹ã€‚</p><p>LOOPè¯­å¥çš„åŸºæœ¬æ ¼å¼å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[loop_label:] LOOP</span><br><span class="line">å¾ªç¯æ‰§è¡Œçš„è¯­å¥</span><br><span class="line">END LOOP [loop_label]</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ï¼Œloop_labelè¡¨ç¤ºLOOPè¯­å¥çš„æ ‡æ³¨åç§°ï¼Œè¯¥å‚æ•°å¯ä»¥çœç•¥ã€‚</p><p>ä¸¾ä¾‹1ï¼šä½¿ç”¨LOOPè¯­å¥è¿›è¡Œå¾ªç¯æ“ä½œï¼Œidå€¼å°äº10æ—¶å°†é‡å¤æ‰§è¡Œå¾ªç¯è¿‡ç¨‹ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">DECLARE id INT DEFAULT 0;</span><br><span class="line">add_loop:LOOP</span><br><span class="line">    SET id = id +1;</span><br><span class="line">    IF id &gt;= 10 THEN LEAVE add_loop;</span><br><span class="line">    END IF;</span><br><span class="line">END LOOP add_loop;</span><br></pre></td></tr></table></figure><p>ä¸¾ä¾‹2ï¼šå½“å¸‚åœºç¯å¢ƒå˜å¥½æ—¶ï¼Œå…¬å¸ä¸ºäº†å¥–åŠ±å¤§å®¶ï¼Œå†³å®šç»™å¤§å®¶æ¶¨å·¥èµ„ã€‚å£°æ˜å­˜å‚¨è¿‡ç¨‹ â€œupdate_salary_loop()â€ï¼Œå£°æ˜OUTå‚æ•°numï¼Œè¾“å‡ºå¾ªç¯æ¬¡æ•°ã€‚å­˜å‚¨è¿‡ç¨‹ä¸­å®ç°å¾ªç¯ç»™å¤§å®¶æ¶¨è–ªï¼Œè–ªèµ„æ¶¨ä¸º åŸæ¥çš„1.1å€ã€‚ç›´åˆ°å…¨å…¬å¸çš„å¹³å‡è–ªèµ„è¾¾åˆ°12000ç»“æŸã€‚å¹¶ç»Ÿè®¡å¾ªç¯æ¬¡æ•°ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER //</span><br><span class="line">CREATE PROCEDURE update_salary_loop(OUT num INT)</span><br><span class="line">BEGIN</span><br><span class="line">DECLARE avg_salary DOUBLE;</span><br><span class="line">DECLARE loop_count INT DEFAULT 0;</span><br><span class="line">SELECT AVG(salary) INTO avg_salary FROM employees;</span><br><span class="line">label_loop:LOOP</span><br><span class="line">        IF avg_salary &gt;= 12000 THEN LEAVE label_loop;</span><br><span class="line">        END IF;</span><br><span class="line">        UPDATE employees SET salary = salary * 1.1;</span><br><span class="line">        SET loop_count = loop_count + 1;</span><br><span class="line">        SELECT AVG(salary) INTO avg_salary FROM employees;</span><br><span class="line">    END LOOP label_loop;</span><br><span class="line">    SET num = loop_count;</span><br><span class="line">END //</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure><h3 id="4-å¾ªç¯ç»“æ„ä¹‹WHILE"><a href="#4-å¾ªç¯ç»“æ„ä¹‹WHILE" class="headerlink" title="4) å¾ªç¯ç»“æ„ä¹‹WHILE"></a>4) å¾ªç¯ç»“æ„ä¹‹WHILE</h3><p>WHILEè¯­å¥åˆ›å»ºä¸€ä¸ªå¸¦æ¡ä»¶åˆ¤æ–­çš„å¾ªç¯è¿‡ç¨‹ã€‚WHILEåœ¨æ‰§è¡Œè¯­å¥æ‰§è¡Œæ—¶ï¼Œå…ˆå¯¹æŒ‡å®šçš„è¡¨è¾¾å¼è¿›è¡Œåˆ¤æ–­ï¼Œå¦‚ æœä¸ºçœŸï¼Œå°±æ‰§è¡Œå¾ªç¯å†…çš„è¯­å¥ï¼Œå¦åˆ™é€€å‡ºå¾ªç¯ã€‚WHILEè¯­å¥çš„åŸºæœ¬æ ¼å¼å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[while_label:] WHILE å¾ªç¯æ¡ä»¶ DO</span><br><span class="line">å¾ªç¯ä½“</span><br><span class="line">END WHILE [while_label];</span><br></pre></td></tr></table></figure><p>while_labelä¸ºWHILEè¯­å¥çš„æ ‡æ³¨åç§°ï¼›å¦‚æœå¾ªç¯æ¡ä»¶ç»“æœä¸ºçœŸï¼ŒWHILEè¯­å¥å†…çš„è¯­å¥æˆ–è¯­å¥ç¾¤è¢«æ‰§è¡Œï¼Œç›´ è‡³å¾ªç¯æ¡ä»¶ä¸ºå‡ï¼Œé€€å‡ºå¾ªç¯ã€‚</p><ul><li>ä¸¾ä¾‹1ï¼šWHILEè¯­å¥ç¤ºä¾‹ï¼Œiå€¼å°äº10æ—¶ï¼Œå°†é‡å¤æ‰§è¡Œå¾ªç¯è¿‡ç¨‹ï¼Œä»£ç å¦‚ä¸‹ï¼š</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER //</span><br><span class="line">CREATE PROCEDURE test_while()</span><br><span class="line">BEGIN</span><br><span class="line">    DECLARE i INT DEFAULT 0;</span><br><span class="line">    WHILE i &lt; 10 DO</span><br><span class="line">    SET i = i + 1;</span><br><span class="line">    END WHILE;</span><br><span class="line">    SELECT i;</span><br><span class="line">END //</span><br><span class="line">DELIMITER ;</span><br><span class="line">#è°ƒç”¨</span><br><span class="line">CALL test_while();</span><br></pre></td></tr></table></figure><ul><li>ä¸¾ä¾‹2ï¼šå¸‚åœºç¯å¢ƒä¸å¥½æ—¶ï¼Œå…¬å¸ä¸ºäº†æ¸¡è¿‡éš¾å…³ï¼Œå†³å®šæš‚æ—¶é™ä½å¤§å®¶çš„è–ªèµ„ã€‚å£°æ˜å­˜å‚¨è¿‡ç¨‹ â€œupdate_salary_while()â€ï¼Œå£°æ˜OUTå‚æ•°numï¼Œè¾“å‡ºå¾ªç¯æ¬¡æ•°ã€‚å­˜å‚¨è¿‡ç¨‹ä¸­å®ç°å¾ªç¯ç»™å¤§å®¶é™è–ªï¼Œè–ªèµ„é™ ä¸ºåŸæ¥çš„90%ã€‚ç›´åˆ°å…¨å…¬å¸çš„å¹³å‡è–ªèµ„è¾¾åˆ°5000ç»“æŸã€‚å¹¶ç»Ÿè®¡å¾ªç¯æ¬¡æ•°ã€‚</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER //</span><br><span class="line">CREATE PROCEDURE update_salary_while(OUT num INT)</span><br><span class="line">BEGIN</span><br><span class="line">    DECLARE avg_sal DOUBLE ;</span><br><span class="line">    DECLARE while_count INT DEFAULT 0;</span><br><span class="line">    SELECT AVG(salary) INTO avg_sal FROM employees;</span><br><span class="line">    WHILE avg_sal &gt; 5000 DO</span><br><span class="line">        UPDATE employees SET salary = salary * 0.9;</span><br><span class="line">        SET while_count = while_count + 1;</span><br><span class="line">        SELECT AVG(salary) INTO avg_sal FROM employees;</span><br><span class="line">    END WHILE;</span><br><span class="line">    SET num = while_count;</span><br><span class="line">END //</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure><h3 id="5-å¾ªç¯ç»“æ„ä¹‹REPEAT"><a href="#5-å¾ªç¯ç»“æ„ä¹‹REPEAT" class="headerlink" title="5) å¾ªç¯ç»“æ„ä¹‹REPEAT"></a>5) å¾ªç¯ç»“æ„ä¹‹REPEAT</h3><p>REPEATè¯­å¥åˆ›å»ºä¸€ä¸ªå¸¦æ¡ä»¶åˆ¤æ–­çš„å¾ªç¯è¿‡ç¨‹ã€‚ä¸WHILEå¾ªç¯ä¸åŒçš„æ˜¯ï¼ŒREPEAT å¾ªç¯é¦–å…ˆä¼šæ‰§è¡Œä¸€æ¬¡å¾ªç¯ï¼Œç„¶ååœ¨ UNTIL ä¸­è¿›è¡Œè¡¨è¾¾å¼çš„åˆ¤æ–­ï¼Œå¦‚æœæ»¡è¶³æ¡ä»¶å°±é€€å‡ºï¼Œå³ END REPEATï¼›å¦‚æœæ¡ä»¶ä¸æ»¡è¶³ï¼Œåˆ™ä¼šå°±ç»§ç»­æ‰§è¡Œå¾ªç¯ï¼Œç›´åˆ°æ»¡è¶³é€€å‡ºæ¡ä»¶ä¸ºæ­¢ã€‚</p><p>REPEATè¯­å¥çš„åŸºæœ¬æ ¼å¼å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[repeat_label:] REPEAT</span><br><span class="line">å¾ªç¯ä½“çš„è¯­å¥</span><br><span class="line">UNTIL ç»“æŸå¾ªç¯çš„æ¡ä»¶è¡¨è¾¾å¼</span><br><span class="line">END REPEAT [repeat_label]</span><br></pre></td></tr></table></figure><p>repeat_labelä¸ºREPEATè¯­å¥çš„æ ‡æ³¨åç§°ï¼Œè¯¥å‚æ•°å¯ä»¥çœç•¥ï¼›REPEATè¯­å¥å†…çš„è¯­å¥æˆ–è¯­å¥ç¾¤è¢«é‡å¤ï¼Œç›´è‡³ expr_conditionä¸ºçœŸã€‚</p><p>ä¸¾ä¾‹1ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER //</span><br><span class="line">CREATE PROCEDURE test_repeat()</span><br><span class="line">BEGIN</span><br><span class="line">    DECLARE i INT DEFAULT 0;</span><br><span class="line">    REPEAT</span><br><span class="line">    SET i = i + 1;</span><br><span class="line">    UNTIL i &gt;= 10</span><br><span class="line">    END REPEAT;</span><br><span class="line">    SELECT i;</span><br><span class="line">END //</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure><p>ä¸¾ä¾‹2ï¼šå½“å¸‚åœºç¯å¢ƒå˜å¥½æ—¶ï¼Œå…¬å¸ä¸ºäº†å¥–åŠ±å¤§å®¶ï¼Œå†³å®šç»™å¤§å®¶æ¶¨å·¥èµ„ã€‚å£°æ˜å­˜å‚¨è¿‡ç¨‹ â€œupdate_salary_repeat()â€ï¼Œå£°æ˜OUTå‚æ•°numï¼Œè¾“å‡ºå¾ªç¯æ¬¡æ•°ã€‚å­˜å‚¨è¿‡ç¨‹ä¸­å®ç°å¾ªç¯ç»™å¤§å®¶æ¶¨è–ªï¼Œè–ªèµ„æ¶¨ ä¸ºåŸæ¥çš„1.15å€ã€‚ç›´åˆ°å…¨å…¬å¸çš„å¹³å‡è–ªèµ„è¾¾åˆ°13000ç»“æŸã€‚å¹¶ç»Ÿè®¡å¾ªç¯æ¬¡æ•°ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER //</span><br><span class="line">CREATE PROCEDURE update_salary_repeat(OUT num INT)</span><br><span class="line">BEGIN</span><br><span class="line">    DECLARE avg_sal DOUBLE ;</span><br><span class="line">    DECLARE repeat_count INT DEFAULT 0;</span><br><span class="line">    SELECT AVG(salary) INTO avg_sal FROM employees;</span><br><span class="line">    REPEAT</span><br><span class="line">    UPDATE employees SET salary = salary * 1.15;</span><br><span class="line">    SET repeat_count = repeat_count + 1;</span><br><span class="line">    SELECT AVG(salary) INTO avg_sal FROM employees;</span><br><span class="line">    UNTIL avg_sal &gt;= 13000</span><br><span class="line">    END REPEAT;</span><br><span class="line">    SET num = repeat_count;</span><br><span class="line">END //</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure><p><strong>å¯¹æ¯”ä¸‰ç§å¾ªç¯ç»“æ„ï¼š</strong></p><ol><li><p>è¿™ä¸‰ç§å¾ªç¯éƒ½å¯ä»¥çœç•¥åç§°ï¼Œä½†å¦‚æœå¾ªç¯ä¸­æ·»åŠ äº†å¾ªç¯æ§åˆ¶è¯­å¥ï¼ˆLEAVEæˆ–ITERATEï¼‰åˆ™å¿…é¡»æ·»åŠ åç§°ã€‚ </p></li><li><p>LOOPï¼šä¸€èˆ¬ç”¨äºå®ç°ç®€å•çš„â€æ­»â€å¾ªç¯ WHILEï¼šå…ˆåˆ¤æ–­åæ‰§è¡Œ </p></li><li><p>REPEATï¼šå…ˆæ‰§è¡Œååˆ¤æ–­ï¼Œæ— æ¡ä»¶è‡³å°‘æ‰§è¡Œä¸€æ¬¡</p></li></ol><h3 id="6-è·³è½¬è¯­å¥ä¹‹LEAVEè¯­å¥"><a href="#6-è·³è½¬è¯­å¥ä¹‹LEAVEè¯­å¥" class="headerlink" title="6) è·³è½¬è¯­å¥ä¹‹LEAVEè¯­å¥"></a>6) è·³è½¬è¯­å¥ä¹‹LEAVEè¯­å¥</h3><p>LEAVEè¯­å¥ï¼šå¯ä»¥ç”¨åœ¨å¾ªç¯è¯­å¥å†…ï¼Œæˆ–è€…ä»¥ BEGIN å’Œ END åŒ…è£¹èµ·æ¥çš„ç¨‹åºä½“å†…ï¼Œè¡¨ç¤ºè·³å‡ºå¾ªç¯æˆ–è€…è·³å‡º ç¨‹åºä½“çš„æ“ä½œã€‚å¦‚æœä½ æœ‰é¢å‘è¿‡ç¨‹çš„ç¼–ç¨‹è¯­è¨€çš„ä½¿ç”¨ç»éªŒï¼Œä½ å¯ä»¥æŠŠ LEAVE ç†è§£ä¸º breakã€‚</p><p>åŸºæœ¬æ ¼å¼å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LEAVE æ ‡è®°å</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ï¼Œlabelå‚æ•°è¡¨ç¤ºå¾ªç¯çš„æ ‡å¿—ã€‚LEAVEå’ŒBEGIN â€¦ ENDæˆ–å¾ªç¯ä¸€èµ·è¢«ä½¿ç”¨ã€‚</p><p>ä¸¾ä¾‹1ï¼šåˆ›å»ºå­˜å‚¨è¿‡ç¨‹ â€œleave_begin()â€ï¼Œå£°æ˜INTç±»å‹çš„INå‚æ•°numã€‚ç»™BEGINâ€¦ENDåŠ æ ‡è®°åï¼Œå¹¶åœ¨ BEGINâ€¦ENDä¸­ä½¿ç”¨IFè¯­å¥åˆ¤æ–­numå‚æ•°çš„å€¼ã€‚</p><p>å¦‚æœnum&lt;&#x3D;0ï¼Œåˆ™ä½¿ç”¨LEAVEè¯­å¥é€€å‡ºBEGINâ€¦ENDï¼› å¦‚æœnum&#x3D;1ï¼Œåˆ™æŸ¥è¯¢â€œemployeesâ€è¡¨çš„å¹³å‡è–ªèµ„ï¼› å¦‚æœnum&#x3D;2ï¼Œåˆ™æŸ¥è¯¢â€œemployeesâ€è¡¨çš„æœ€ä½è–ªèµ„ï¼› å¦‚æœnum&gt;2ï¼Œåˆ™æŸ¥è¯¢â€œemployeesâ€è¡¨çš„æœ€é«˜è–ªèµ„ã€‚</p><p>IFè¯­å¥ç»“æŸåæŸ¥è¯¢â€œemployeesâ€è¡¨çš„æ€»äººæ•°ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER //</span><br><span class="line">CREATE PROCEDURE leave_begin(IN num INT)</span><br><span class="line">    begin_label: BEGIN</span><br><span class="line">        IF num&lt;=0</span><br><span class="line">        THEN LEAVE begin_label;</span><br><span class="line">        ELSEIF num=1</span><br><span class="line">        THEN SELECT AVG(salary) FROM employees;</span><br><span class="line">        ELSEIF num=2</span><br><span class="line">        THEN SELECT MIN(salary) FROM employees;</span><br><span class="line">        ELSE</span><br><span class="line">        SELECT MAX(salary) FROM employees;</span><br><span class="line">        END IF;</span><br><span class="line">        SELECT COUNT(*) FROM employees;</span><br><span class="line">    END //</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure><p>ä¸¾ä¾‹2ï¼š å½“å¸‚åœºç¯å¢ƒä¸å¥½æ—¶ï¼Œå…¬å¸ä¸ºäº†æ¸¡è¿‡éš¾å…³ï¼Œå†³å®šæš‚æ—¶é™ä½å¤§å®¶çš„è–ªèµ„ã€‚å£°æ˜å­˜å‚¨è¿‡ç¨‹â€œleave_while()â€ï¼Œå£°æ˜ OUTå‚æ•°numï¼Œè¾“å‡ºå¾ªç¯æ¬¡æ•°ï¼Œå­˜å‚¨è¿‡ç¨‹ä¸­ä½¿ç”¨WHILEå¾ªç¯ç»™å¤§å®¶é™ä½è–ªèµ„ä¸ºåŸæ¥è–ªèµ„çš„90%ï¼Œç›´åˆ°å…¨å…¬å¸çš„å¹³å‡è–ªèµ„å°äºç­‰äº10000ï¼Œå¹¶ç»Ÿè®¡å¾ªç¯æ¬¡æ•°ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER //</span><br><span class="line">CREATE PROCEDURE leave_while(OUT num INT)</span><br><span class="line">BEGIN</span><br><span class="line">    DECLARE avg_sal DOUBLE;#è®°å½•å¹³å‡å·¥èµ„</span><br><span class="line">    DECLARE while_count INT DEFAULT 0; #è®°å½•å¾ªç¯æ¬¡æ•°</span><br><span class="line">    SELECT AVG(salary) INTO avg_sal FROM employees; #â‘  åˆå§‹åŒ–æ¡ä»¶</span><br><span class="line">    while_label:WHILE TRUE DO #â‘¡ å¾ªç¯æ¡ä»¶</span><br><span class="line">    #â‘¢ å¾ªç¯ä½“</span><br><span class="line">    IF avg_sal &lt;= 10000 THEN</span><br><span class="line">    LEAVE while_label;</span><br><span class="line">    END IF;</span><br><span class="line">    UPDATE employees SET salary = salary * 0.9;</span><br><span class="line">    SET while_count = while_count + 1;</span><br><span class="line">    #â‘£ è¿­ä»£æ¡ä»¶</span><br><span class="line">    SELECT AVG(salary) INTO avg_sal FROM employees;</span><br><span class="line">    END WHILE;</span><br><span class="line">    #èµ‹å€¼</span><br><span class="line">    SET num = while_count;</span><br><span class="line">END //</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure><h3 id="7-è·³è½¬è¯­å¥ä¹‹ITERATEè¯­å¥"><a href="#7-è·³è½¬è¯­å¥ä¹‹ITERATEè¯­å¥" class="headerlink" title="7) è·³è½¬è¯­å¥ä¹‹ITERATEè¯­å¥"></a>7) è·³è½¬è¯­å¥ä¹‹ITERATEè¯­å¥</h3><p>ITERATEè¯­å¥ï¼šåªèƒ½ç”¨åœ¨å¾ªç¯è¯­å¥ï¼ˆLOOPã€REPEATå’ŒWHILEè¯­å¥ï¼‰å†…ï¼Œè¡¨ç¤ºé‡æ–°å¼€å§‹å¾ªç¯ï¼Œå°†æ‰§è¡Œé¡ºåºè½¬åˆ°è¯­å¥æ®µå¼€å¤´å¤„ã€‚å¦‚æœä½ æœ‰é¢å‘è¿‡ç¨‹çš„ç¼–ç¨‹è¯­è¨€çš„ä½¿ç”¨ç»éªŒï¼Œä½ å¯ä»¥æŠŠ ITERATE ç†è§£ä¸º continueï¼Œæ„æ€ä¸ºâ€œå†æ¬¡å¾ªç¯â€ã€‚</p><p>è¯­å¥åŸºæœ¬æ ¼å¼å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ITERATE label</span><br></pre></td></tr></table></figure><p>labelå‚æ•°è¡¨ç¤ºå¾ªç¯çš„æ ‡å¿—ã€‚ITERATEè¯­å¥å¿…é¡»è·Ÿåœ¨å¾ªç¯æ ‡å¿—å‰é¢ã€‚</p><p>ä¸¾ä¾‹ï¼š å®šä¹‰å±€éƒ¨å˜é‡numï¼Œåˆå§‹å€¼ä¸º0ã€‚å¾ªç¯ç»“æ„ä¸­æ‰§è¡Œnum + 1æ“ä½œã€‚</p><ul><li>å¦‚æœnum &lt; 10ï¼Œåˆ™ç»§ç»­æ‰§è¡Œå¾ªç¯ï¼›</li><li>å¦‚æœnum &gt; 15ï¼Œåˆ™é€€å‡ºå¾ªç¯ç»“æ„ï¼›</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER //</span><br><span class="line">CREATE PROCEDURE test_iterate()</span><br><span class="line">BEGIN</span><br><span class="line">    DECLARE num INT DEFAULT 0;</span><br><span class="line">    my_loop:LOOP</span><br><span class="line">    SET num = num + 1;</span><br><span class="line">        IF num &lt; 10</span><br><span class="line">        THEN ITERATE my_loop;</span><br><span class="line">        ELSEIF num &gt; 15</span><br><span class="line">        THEN LEAVE my_loop;</span><br><span class="line">        END IF;</span><br><span class="line">        SELECT &#x27;MySQL&#x27;;</span><br><span class="line">    END LOOP my_loop;</span><br><span class="line">END //</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure><h2 id="4-æ¸¸æ ‡"><a href="#4-æ¸¸æ ‡" class="headerlink" title="4. æ¸¸æ ‡"></a>4. æ¸¸æ ‡</h2><h3 id="1-ä»€ä¹ˆæ˜¯æ¸¸æ ‡ï¼ˆæˆ–å…‰æ ‡ï¼‰"><a href="#1-ä»€ä¹ˆæ˜¯æ¸¸æ ‡ï¼ˆæˆ–å…‰æ ‡ï¼‰" class="headerlink" title="1)  ä»€ä¹ˆæ˜¯æ¸¸æ ‡ï¼ˆæˆ–å…‰æ ‡ï¼‰"></a>1)  ä»€ä¹ˆæ˜¯æ¸¸æ ‡ï¼ˆæˆ–å…‰æ ‡ï¼‰</h3><p>è™½ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ç­›é€‰æ¡ä»¶ WHERE å’Œ HAVINGï¼Œæˆ–è€…æ˜¯é™å®šè¿”å›è®°å½•çš„å…³é”®å­— LIMIT è¿”å›ä¸€æ¡è®°å½•ï¼Œ ä½†æ˜¯ï¼Œå´æ— æ³•åœ¨ç»“æœé›†ä¸­åƒæŒ‡é’ˆä¸€æ ·ï¼Œå‘å‰å®šä½ä¸€æ¡è®°å½•ã€å‘åå®šä½ä¸€æ¡è®°å½•ï¼Œæˆ–è€…æ˜¯éšæ„å®šä½åˆ°æŸä¸€ æ¡è®°å½• ï¼Œå¹¶å¯¹è®°å½•çš„æ•°æ®è¿›è¡Œå¤„ç†ã€‚</p><p>è¿™ä¸ªæ—¶å€™ï¼Œå°±å¯ä»¥ç”¨åˆ°æ¸¸æ ‡ã€‚æ¸¸æ ‡ï¼Œæä¾›äº†ä¸€ç§çµæ´»çš„æ“ä½œæ–¹å¼ï¼Œè®©æˆ‘ä»¬èƒ½å¤Ÿå¯¹ç»“æœé›†ä¸­çš„æ¯ä¸€æ¡è®°å½•è¿›è¡Œå®šä½ï¼Œå¹¶å¯¹æŒ‡å‘çš„è®°å½•ä¸­çš„æ•°æ®è¿›è¡Œæ“ä½œçš„æ•°æ®ç»“æ„ã€‚æ¸¸æ ‡è®© SQL è¿™ç§é¢å‘é›†åˆçš„è¯­è¨€æœ‰äº†é¢å‘è¿‡ç¨‹å¼€å‘çš„èƒ½åŠ›ã€‚</p><p>åœ¨ SQL ä¸­ï¼Œæ¸¸æ ‡æ˜¯ä¸€ç§ä¸´æ—¶çš„æ•°æ®åº“å¯¹è±¡ï¼Œå¯ä»¥æŒ‡å‘å­˜å‚¨åœ¨æ•°æ®åº“è¡¨ä¸­çš„æ•°æ®è¡ŒæŒ‡é’ˆã€‚è¿™é‡Œæ¸¸æ ‡ å……å½“äº† æŒ‡é’ˆçš„ä½œç”¨ ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æ“ä½œæ¸¸æ ‡æ¥å¯¹æ•°æ®è¡Œè¿›è¡Œæ“ä½œã€‚</p><p>MySQLä¸­æ¸¸æ ‡å¯ä»¥åœ¨å­˜å‚¨è¿‡ç¨‹å’Œå‡½æ•°ä¸­ä½¿ç”¨ã€‚ </p><h3 id="2-ä½¿ç”¨æ¸¸æ ‡æ­¥éª¤"><a href="#2-ä½¿ç”¨æ¸¸æ ‡æ­¥éª¤" class="headerlink" title="2) ä½¿ç”¨æ¸¸æ ‡æ­¥éª¤"></a>2) ä½¿ç”¨æ¸¸æ ‡æ­¥éª¤</h3><p>æ¸¸æ ‡å¿…é¡»åœ¨å£°æ˜å¤„ç†ç¨‹åºä¹‹å‰è¢«å£°æ˜ï¼Œå¹¶ä¸”å˜é‡å’Œæ¡ä»¶è¿˜å¿…é¡»åœ¨å£°æ˜æ¸¸æ ‡æˆ–å¤„ç†ç¨‹åºä¹‹å‰è¢«å£°æ˜ã€‚ </p><p>å¦‚æœæˆ‘ä»¬æƒ³è¦ä½¿ç”¨æ¸¸æ ‡ï¼Œä¸€èˆ¬éœ€è¦ç»å†å››ä¸ªæ­¥éª¤ã€‚ä¸åŒçš„ DBMS ä¸­ï¼Œä½¿ç”¨æ¸¸æ ‡çš„è¯­æ³•å¯èƒ½ç•¥æœ‰ä¸åŒã€‚</p><p><strong>ç¬¬ä¸€æ­¥ï¼Œå£°æ˜æ¸¸æ ‡</strong></p><p>åœ¨MySQLä¸­ï¼Œä½¿ç”¨DECLAREå…³é”®å­—æ¥å£°æ˜æ¸¸æ ‡ï¼Œå…¶è¯­æ³•çš„åŸºæœ¬å½¢å¼å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DECLARE cursor_name CURSOR FOR select_statement;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªè¯­æ³•é€‚ç”¨äº MySQLï¼ŒSQL Serverï¼ŒDB2 å’Œ MariaDBã€‚å¦‚æœæ˜¯ç”¨ Oracle æˆ–è€… PostgreSQLï¼Œéœ€è¦å†™æˆï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DECLARE cursor_name CURSOR IS select_statement;</span><br></pre></td></tr></table></figure><p>è¦ä½¿ç”¨ SELECT è¯­å¥æ¥è·å–æ•°æ®ç»“æœé›†ï¼Œè€Œæ­¤æ—¶è¿˜æ²¡æœ‰å¼€å§‹éå†æ•°æ®ï¼Œè¿™é‡Œ select_statement ä»£è¡¨çš„æ˜¯ SELECT è¯­å¥ï¼Œè¿”å›ä¸€ä¸ªç”¨äºåˆ›å»ºæ¸¸æ ‡çš„ç»“æœé›†ã€‚</p><p>æ¯”å¦‚ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DECLARE cur_emp CURSOR FOR</span><br><span class="line">SELECT employee_id,salary FROM employees;</span><br></pre></td></tr></table></figure><p><strong>ç¬¬äºŒæ­¥ï¼Œæ‰“å¼€æ¸¸æ ‡</strong></p><p>æ‰“å¼€æ¸¸æ ‡çš„è¯­æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">OPEN cursor_name</span><br></pre></td></tr></table></figure><p>å½“æˆ‘ä»¬å®šä¹‰å¥½æ¸¸æ ‡ä¹‹åï¼Œå¦‚æœæƒ³è¦ä½¿ç”¨æ¸¸æ ‡ï¼Œå¿…é¡»å…ˆæ‰“å¼€æ¸¸æ ‡ã€‚æ‰“å¼€æ¸¸æ ‡çš„æ—¶å€™ SELECT è¯­å¥çš„æŸ¥è¯¢ç»“æœé›†å°±ä¼šé€åˆ°æ¸¸æ ‡å·¥ä½œåŒºï¼Œä¸ºåé¢æ¸¸æ ‡çš„ é€æ¡è¯»å– ç»“æœé›†ä¸­çš„è®°å½•åšå‡†å¤‡ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">OPEN cur_emp;</span><br></pre></td></tr></table></figure><p><strong>ç¬¬ä¸‰æ­¥ï¼Œä½¿ç”¨æ¸¸æ ‡ï¼ˆä»æ¸¸æ ‡ä¸­å–å¾—æ•°æ®ï¼‰</strong></p><p>è¯­æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FETCH cursor_name INTO var_name [, var_name] ...</span><br></pre></td></tr></table></figure><p>è¿™å¥çš„ä½œç”¨æ˜¯ä½¿ç”¨ cursor_name è¿™ä¸ªæ¸¸æ ‡æ¥è¯»å–å½“å‰è¡Œï¼Œå¹¶ä¸”å°†æ•°æ®ä¿å­˜åˆ° var_name è¿™ä¸ªå˜é‡ä¸­ï¼Œæ¸¸æ ‡æŒ‡é’ˆæŒ‡åˆ°ä¸‹ä¸€è¡Œã€‚å¦‚æœæ¸¸æ ‡è¯»å–çš„æ•°æ®è¡Œæœ‰å¤šä¸ªåˆ—åï¼Œåˆ™åœ¨ INTO å…³é”®å­—åé¢èµ‹å€¼ç»™å¤šä¸ªå˜é‡åå³å¯ã€‚</p><p>æ³¨æ„ï¼švar_nameå¿…é¡»åœ¨å£°æ˜æ¸¸æ ‡ä¹‹å‰å°±å®šä¹‰å¥½ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FETCH cur_emp INTO emp_id, emp_sal ;</span><br></pre></td></tr></table></figure><p>æ³¨æ„ï¼š<strong>æ¸¸æ ‡çš„æŸ¥è¯¢ç»“æœé›†ä¸­çš„å­—æ®µæ•°ï¼Œå¿…é¡»è·Ÿ INTO åé¢çš„å˜é‡æ•°ä¸€è‡´</strong>ï¼Œå¦åˆ™ï¼Œåœ¨å­˜å‚¨è¿‡ç¨‹æ‰§è¡Œçš„æ—¶ å€™ï¼ŒMySQL ä¼šæç¤ºé”™è¯¯ã€‚</p><p><strong>ç¬¬å››æ­¥ï¼Œå…³é—­æ¸¸æ ‡</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CLOSE cursor_name</span><br></pre></td></tr></table></figure><p>æœ‰ OPEN å°±ä¼šæœ‰ CLOSEï¼Œä¹Ÿå°±æ˜¯æ‰“å¼€å’Œå…³é—­æ¸¸æ ‡ã€‚å½“æˆ‘ä»¬ä½¿ç”¨å®Œæ¸¸æ ‡åéœ€è¦å…³é—­æ‰è¯¥æ¸¸æ ‡ã€‚å› ä¸ºæ¸¸æ ‡ä¼š å ç”¨ç³»ç»Ÿèµ„æº ï¼Œå¦‚æœä¸åŠæ—¶å…³é—­ï¼Œæ¸¸æ ‡ä¼šä¸€ç›´ä¿æŒåˆ°å­˜å‚¨è¿‡ç¨‹ç»“æŸï¼Œå½±å“ç³»ç»Ÿè¿è¡Œçš„æ•ˆç‡ã€‚è€Œå…³é—­æ¸¸æ ‡ çš„æ“ä½œï¼Œä¼šé‡Šæ”¾æ¸¸æ ‡å ç”¨çš„ç³»ç»Ÿèµ„æºã€‚</p><p>å…³é—­æ¸¸æ ‡ä¹‹åï¼Œæˆ‘ä»¬å°±ä¸èƒ½å†æ£€ç´¢æŸ¥è¯¢ç»“æœä¸­çš„æ•°æ®è¡Œï¼Œå¦‚æœéœ€è¦æ£€ç´¢åªèƒ½å†æ¬¡æ‰“å¼€æ¸¸æ ‡ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CLOSE cur_emp;</span><br></pre></td></tr></table></figure><h3 id="3-ä¸¾ä¾‹"><a href="#3-ä¸¾ä¾‹" class="headerlink" title="3) ä¸¾ä¾‹"></a>3) ä¸¾ä¾‹</h3><p>åˆ›å»ºå­˜å‚¨è¿‡ç¨‹â€œget_count_by_limit_total_salary()â€ï¼Œå£°æ˜INå‚æ•° limit_total_salaryï¼ŒDOUBLEç±»å‹ï¼›å£°æ˜ OUTå‚æ•°total_countï¼ŒINTç±»å‹ã€‚å‡½æ•°çš„åŠŸèƒ½å¯ä»¥å®ç°ç´¯åŠ è–ªèµ„æœ€é«˜çš„å‡ ä¸ªå‘˜å·¥çš„è–ªèµ„å€¼ï¼Œç›´åˆ°è–ªèµ„æ€»å’Œè¾¾åˆ°limit_total_salaryå‚æ•°çš„å€¼ï¼Œè¿”å›ç´¯åŠ çš„äººæ•°ç»™total_countã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER //</span><br><span class="line">CREATE PROCEDURE get_count_by_limit_total_salary(IN limit_total_salary DOUBLE, OUT total_count INT)</span><br><span class="line">BEGIN</span><br><span class="line">DECLARE sum_salary DOUBLE DEFAULT 0; # è®°å½•ç´¯åŠ çš„æ€»å·¥èµ„</span><br><span class="line">DECLARE cursor_salary DOUBLE DEFAULT 0; # è®°å½•æŸä¸€ä¸ªå·¥èµ„å€¼</span><br><span class="line">DECLARE emp_count INT DEFAULT 0; # è®°å½•å¾ªç¯ä¸ªæ•°</span><br><span class="line"># å®šä¹‰æ¸¸æ ‡</span><br><span class="line">DECLARE emp_cursor CURSOR FOR SELECT salary FROM employees ORDER BY salary DESC;</span><br><span class="line"># æ‰“å¼€æ¸¸æ ‡</span><br><span class="line">OPEN emp_cursor;</span><br><span class="line"></span><br><span class="line">REPEAT</span><br><span class="line"># ä½¿ç”¨æ¸¸æ ‡(ä»æ¸¸æ ‡ä¸­è·å–æ•°æ®)</span><br><span class="line">FETCH emp_cursor INTO cursor_salary;</span><br><span class="line">SET sum_salary = sum_salary + cursor_salary;</span><br><span class="line">SET emp_count = emp_count + 1;</span><br><span class="line">UNTIL sum_salary &gt;= limit_total_salary</span><br><span class="line">END REPEAT;</span><br><span class="line">set total_count = emp_count;</span><br><span class="line"># å…³é—­æ¸¸æ ‡</span><br><span class="line">CLOSE emp_cursor;</span><br><span class="line">END //</span><br><span class="line">DELIMITER;</span><br></pre></td></tr></table></figure><h3 id="4-å°ç»“"><a href="#4-å°ç»“" class="headerlink" title="4) å°ç»“"></a>4) å°ç»“</h3><p>æ¸¸æ ‡æ˜¯ MySQL çš„ä¸€ä¸ªé‡è¦çš„åŠŸèƒ½ï¼Œä¸º é€æ¡è¯»å– ç»“æœé›†ä¸­çš„æ•°æ®ï¼Œæä¾›äº†å®Œç¾çš„è§£å†³æ–¹æ¡ˆã€‚è·Ÿåœ¨åº”ç”¨å±‚é¢å®ç°ç›¸åŒçš„åŠŸèƒ½ç›¸æ¯”ï¼Œæ¸¸æ ‡å¯ä»¥åœ¨å­˜å‚¨ç¨‹åºä¸­ä½¿ç”¨ï¼Œæ•ˆç‡é«˜ï¼Œç¨‹åºä¹Ÿæ›´åŠ ç®€æ´ã€‚ </p><p>ä½†åŒæ—¶ä¹Ÿä¼šå¸¦æ¥ä¸€äº›æ€§èƒ½é—®é¢˜ï¼Œæ¯”å¦‚åœ¨ä½¿ç”¨æ¸¸æ ‡çš„è¿‡ç¨‹ä¸­ï¼Œä¼šå¯¹æ•°æ®è¡Œè¿›è¡Œ åŠ é” ï¼Œè¿™æ ·åœ¨ä¸šåŠ¡å¹¶å‘é‡å¤§ çš„æ—¶å€™ï¼Œä¸ä»…ä¼šå½±å“ä¸šåŠ¡ä¹‹é—´çš„æ•ˆç‡ï¼Œè¿˜ä¼š æ¶ˆè€—ç³»ç»Ÿèµ„æº ï¼Œé€ æˆå†…å­˜ä¸è¶³ï¼Œè¿™æ˜¯å› ä¸ºæ¸¸æ ‡æ˜¯åœ¨å†…å­˜ä¸­è¿›è¡Œçš„å¤„ç†ã€‚ </p><p>å»ºè®®ï¼šå…»æˆç”¨å®Œä¹‹åå°±å…³é—­çš„ä¹ æƒ¯ï¼Œè¿™æ ·æ‰èƒ½æé«˜ç³»ç»Ÿçš„æ•´ä½“æ•ˆç‡ã€‚</p><h2 id="è¡¥å……ï¼šMySQL-8-0çš„æ–°ç‰¹æ€§â€”å…¨å±€å˜é‡çš„æŒä¹…åŒ–"><a href="#è¡¥å……ï¼šMySQL-8-0çš„æ–°ç‰¹æ€§â€”å…¨å±€å˜é‡çš„æŒä¹…åŒ–" class="headerlink" title="è¡¥å……ï¼šMySQL 8.0çš„æ–°ç‰¹æ€§â€”å…¨å±€å˜é‡çš„æŒä¹…åŒ–"></a>è¡¥å……ï¼šMySQL 8.0çš„æ–°ç‰¹æ€§â€”å…¨å±€å˜é‡çš„æŒä¹…åŒ–</h2><p>åœ¨MySQLæ•°æ®åº“ä¸­ï¼Œå…¨å±€å˜é‡å¯ä»¥é€šè¿‡SET GLOBALè¯­å¥æ¥è®¾ç½®ã€‚ä¾‹å¦‚ï¼Œè®¾ç½®æœåŠ¡å™¨è¯­å¥è¶…æ—¶çš„é™åˆ¶ï¼Œå¯ ä»¥é€šè¿‡è®¾ç½®ç³»ç»Ÿå˜é‡max_execution_timeæ¥å®ç°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SET GLOBAL MAX_EXECUTION_TIME=2000;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨SET GLOBALè¯­å¥è®¾ç½®çš„å˜é‡å€¼åªä¼š ä¸´æ—¶ç”Ÿæ•ˆ ã€‚ æ•°æ®åº“é‡å¯ åï¼ŒæœåŠ¡å™¨åˆä¼šä»MySQLé…ç½®æ–‡ä»¶ä¸­è¯»å– å˜é‡çš„é»˜è®¤å€¼ã€‚ MySQL 8.0ç‰ˆæœ¬æ–°å¢äº† SET PERSIST å‘½ä»¤ã€‚ä¾‹å¦‚ï¼Œè®¾ç½®æœåŠ¡å™¨çš„æœ€å¤§è¿æ¥æ•°ä¸º1000ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SET PERSIST global max_connections = 1000;</span><br></pre></td></tr></table></figure><p>MySQLä¼šå°†è¯¥å‘½ä»¤çš„é…ç½®ä¿å­˜åˆ°æ•°æ®ç›®å½•ä¸‹çš„ mysqld-auto.cnf æ–‡ä»¶ä¸­ï¼Œä¸‹æ¬¡å¯åŠ¨æ—¶ä¼šè¯»å–è¯¥æ–‡ä»¶ï¼Œç”¨å…¶ä¸­çš„é…ç½®æ¥è¦†ç›–é»˜è®¤çš„é…ç½®æ–‡ä»¶ã€‚</p><h1 id="ç¬¬17ç« -è§¦å‘å™¨"><a href="#ç¬¬17ç« -è§¦å‘å™¨" class="headerlink" title="ç¬¬17ç« _è§¦å‘å™¨"></a>ç¬¬17ç« _è§¦å‘å™¨</h1><p>åœ¨å®é™…å¼€å‘ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸ä¼šé‡åˆ°è¿™æ ·çš„æƒ…å†µï¼šæœ‰ 2 ä¸ªæˆ–è€…å¤šä¸ªç›¸äº’å…³è”çš„è¡¨ï¼Œå¦‚ å•†å“ä¿¡æ¯ å’Œ åº“å­˜ä¿¡æ¯ åˆ† åˆ«å­˜æ”¾åœ¨ 2 ä¸ªä¸åŒçš„æ•°æ®è¡¨ä¸­ï¼Œæˆ‘ä»¬åœ¨æ·»åŠ ä¸€æ¡æ–°å•†å“è®°å½•çš„æ—¶å€™ï¼Œä¸ºäº†ä¿è¯æ•°æ®çš„å®Œæ•´æ€§ï¼Œå¿…é¡»åŒæ—¶ åœ¨åº“å­˜è¡¨ä¸­æ·»åŠ ä¸€æ¡åº“å­˜è®°å½•ã€‚ </p><p>è¿™æ ·ä¸€æ¥ï¼Œæˆ‘ä»¬å°±å¿…é¡»æŠŠè¿™ä¸¤ä¸ªå…³è”çš„æ“ä½œæ­¥éª¤å†™åˆ°ç¨‹åºé‡Œé¢ï¼Œè€Œä¸”è¦ç”¨ äº‹åŠ¡ åŒ…è£¹èµ·æ¥ï¼Œç¡®ä¿è¿™ä¸¤ä¸ªæ“ ä½œæˆä¸ºä¸€ä¸ª åŸå­æ“ä½œ ï¼Œè¦ä¹ˆå…¨éƒ¨æ‰§è¡Œï¼Œè¦ä¹ˆå…¨éƒ¨ä¸æ‰§è¡Œã€‚è¦æ˜¯é‡åˆ°ç‰¹æ®Šæƒ…å†µï¼Œå¯èƒ½è¿˜éœ€è¦å¯¹æ•°æ®è¿›è¡Œæ‰‹åŠ¨ç»´æŠ¤ï¼Œè¿™æ ·å°±å¾ˆ å®¹æ˜“å¿˜è®°å…¶ä¸­çš„ä¸€æ­¥ ï¼Œå¯¼è‡´æ•°æ®ç¼ºå¤±ã€‚ </p><p>è¿™ä¸ªæ—¶å€™ï¼Œå’±ä»¬å¯ä»¥ä½¿ç”¨è§¦å‘å™¨ã€‚ä½ å¯ä»¥åˆ›å»ºä¸€ä¸ªè§¦å‘å™¨ï¼Œè®©å•†å“ä¿¡æ¯æ•°æ®çš„æ’å…¥æ“ä½œè‡ªåŠ¨è§¦å‘åº“å­˜æ•°æ®çš„æ’å…¥æ“ä½œã€‚è¿™æ ·ä¸€æ¥ï¼Œå°±ä¸ç”¨æ‹…å¿ƒå› ä¸ºå¿˜è®°æ·»åŠ åº“å­˜æ•°æ®è€Œå¯¼è‡´çš„æ•°æ®ç¼ºå¤±äº†ã€‚</p><h2 id="1-è§¦å‘å™¨æ¦‚è¿°"><a href="#1-è§¦å‘å™¨æ¦‚è¿°" class="headerlink" title="1. è§¦å‘å™¨æ¦‚è¿°"></a>1. è§¦å‘å™¨æ¦‚è¿°</h2><p>è§¦å‘å™¨æ˜¯ç”± äº‹ä»¶æ¥è§¦å‘ æŸä¸ªæ“ä½œï¼Œè¿™äº›äº‹ä»¶åŒ…æ‹¬ INSERT ã€ UPDATE ã€ DELETE äº‹ä»¶ã€‚æ‰€è°“äº‹ä»¶å°±æ˜¯æŒ‡ç”¨æˆ·çš„åŠ¨ä½œæˆ–è€…è§¦å‘æŸé¡¹è¡Œä¸ºã€‚å¦‚æœå®šä¹‰äº†è§¦å‘ç¨‹åºï¼Œå½“æ•°æ®åº“æ‰§è¡Œè¿™äº›è¯­å¥æ—¶å€™ï¼Œå°±ç›¸å½“äºäº‹ä»¶å‘ç”Ÿ äº†ï¼Œå°±ä¼š è‡ªåŠ¨ æ¿€å‘è§¦å‘å™¨æ‰§è¡Œç›¸åº”çš„æ“ä½œã€‚</p><p>å½“å¯¹æ•°æ®è¡¨ä¸­çš„æ•°æ®æ‰§è¡Œæ’å…¥ã€æ›´æ–°å’Œåˆ é™¤æ“ä½œï¼Œéœ€è¦è‡ªåŠ¨æ‰§è¡Œä¸€äº›æ•°æ®åº“é€»è¾‘æ—¶ï¼Œå¯ä»¥ä½¿ç”¨è§¦å‘å™¨æ¥å®ç°ã€‚</p><h2 id="2-è§¦å‘å™¨çš„åˆ›å»º"><a href="#2-è§¦å‘å™¨çš„åˆ›å»º" class="headerlink" title="2. è§¦å‘å™¨çš„åˆ›å»º"></a>2. è§¦å‘å™¨çš„åˆ›å»º</h2><h3 id="1-è¯­æ³•"><a href="#1-è¯­æ³•" class="headerlink" title="1) è¯­æ³•"></a>1) è¯­æ³•</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CREATE TRIGGER è§¦å‘å™¨åç§°</span><br><span class="line">&#123;BEFORE|AFTER&#125; &#123;INSERT|UPDATE|DELETE&#125; ON è¡¨å</span><br><span class="line">FOR EACH ROW</span><br><span class="line">è§¦å‘å™¨æ‰§è¡Œçš„è¯­å¥å—</span><br></pre></td></tr></table></figure><p>è¯´æ˜ï¼š</p><ul><li>è¡¨å ï¼šè¡¨ç¤ºè§¦å‘å™¨ç›‘æ§çš„å¯¹è±¡ã€‚ </li><li>BEFORE|AFTER ï¼šè¡¨ç¤ºè§¦å‘çš„æ—¶é—´ã€‚BEFORE è¡¨ç¤ºåœ¨äº‹ä»¶ä¹‹å‰è§¦å‘ï¼›AFTER è¡¨ç¤ºåœ¨äº‹ä»¶ä¹‹åè§¦å‘ã€‚ </li><li>INSERT|UPDATE|DELETE ï¼šè¡¨ç¤ºè§¦å‘çš„äº‹ä»¶ã€‚<ul><li>INSERT è¡¨ç¤ºæ’å…¥è®°å½•æ—¶è§¦å‘ï¼› </li><li>UPDATE è¡¨ç¤ºæ›´æ–°è®°å½•æ—¶è§¦å‘ï¼› </li><li>DELETE è¡¨ç¤ºåˆ é™¤è®°å½•æ—¶è§¦å‘ã€‚</li></ul></li><li>è§¦å‘å™¨æ‰§è¡Œçš„è¯­å¥å— ï¼šå¯ä»¥æ˜¯å•æ¡SQLè¯­å¥ï¼Œä¹Ÿå¯ä»¥æ˜¯ç”±BEGINâ€¦ENDç»“æ„ç»„æˆçš„å¤åˆè¯­å¥å—ã€‚</li></ul><h3 id="2-ä»£ç ä¸¾ä¾‹-2"><a href="#2-ä»£ç ä¸¾ä¾‹-2" class="headerlink" title="2) ä»£ç ä¸¾ä¾‹"></a>2) ä»£ç ä¸¾ä¾‹</h3><p><strong>ä¸¾ä¾‹1ï¼š</strong></p><ol><li>åˆ›å»ºæ•°æ®è¡¨ï¼š</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE test_trigger (</span><br><span class="line">id INT PRIMARY KEY AUTO_INCREMENT,</span><br><span class="line">t_note VARCHAR(30)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">CREATE TABLE test_trigger_log (</span><br><span class="line">id INT PRIMARY KEY AUTO_INCREMENT,</span><br><span class="line">t_log VARCHAR(30)</span><br><span class="line">);</span><br></pre></td></tr></table></figure><ol start="2"><li>åˆ›å»ºè§¦å‘å™¨ï¼šåˆ›å»ºåç§°ä¸ºbefore_insertçš„è§¦å‘å™¨ï¼Œå‘test_triggeræ•°æ®è¡¨æ’å…¥æ•°æ®ä¹‹å‰ï¼Œå‘ test_trigger_logæ•°æ®è¡¨ä¸­æ’å…¥before_insertçš„æ—¥å¿—ä¿¡æ¯ã€‚</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER //</span><br><span class="line">CREATE TRIGGER before_insert</span><br><span class="line">BEFORE INSERT ON test_trigger</span><br><span class="line">FOR EACH ROW</span><br><span class="line">BEGIN</span><br><span class="line">    INSERT INTO test_trigger_log (t_log)</span><br><span class="line">    VALUES(&#x27;before_insert&#x27;);</span><br><span class="line">END //</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure><ol start="3"><li>å‘test_triggeræ•°æ®è¡¨ä¸­æ’å…¥æ•°æ®</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO test_trigger (t_note) VALUES (&#x27;æµ‹è¯• BEFORE INSERT è§¦å‘å™¨&#x27;);</span><br></pre></td></tr></table></figure><ol start="4"><li>æŸ¥çœ‹test_trigger_logæ•°æ®è¡¨ä¸­çš„æ•°æ®</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT * FROM test_trigger_log;</span><br><span class="line">+----+---------------+</span><br><span class="line">| id | t_log |</span><br><span class="line">+----+---------------+</span><br><span class="line">| 1 | before_insert |</span><br><span class="line">+----+---------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure><p><strong>ä¸¾ä¾‹2ï¼š</strong></p><p>å®šä¹‰è§¦å‘å™¨â€œsalary_check_triggerâ€ï¼ŒåŸºäºå‘˜å·¥è¡¨â€œemployeesâ€çš„INSERTäº‹ä»¶ï¼Œåœ¨INSERTä¹‹å‰æ£€æŸ¥ å°†è¦æ·»åŠ çš„æ–°å‘˜å·¥è–ªèµ„æ˜¯å¦å¤§äºä»–é¢†å¯¼çš„è–ªèµ„ï¼Œå¦‚æœå¤§äºé¢†å¯¼è–ªèµ„ï¼Œåˆ™æŠ¥sqlstate_valueä¸ºâ€™HY000â€™çš„é”™ è¯¯ï¼Œä»è€Œä½¿å¾—æ·»åŠ å¤±è´¥ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER //</span><br><span class="line">CREATE TRIGGER salary_check_trigger</span><br><span class="line">BEFORE INSERT ON employees FOR EACH ROW</span><br><span class="line">BEGIN</span><br><span class="line">    DECLARE mgrsalary DOUBLE;</span><br><span class="line">    SELECT salary INTO mgrsalary FROM employees WHERE employee_id = NEW.manager_id;</span><br><span class="line">    IF NEW.salary &gt; mgrsalary THEN</span><br><span class="line">    SIGNAL SQLSTATE &#x27;HY000&#x27; SET MESSAGE_TEXT = &#x27;è–ªèµ„é«˜äºé¢†å¯¼è–ªèµ„é”™è¯¯&#x27;;</span><br><span class="line">    END IF;</span><br><span class="line">END //</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢è§¦å‘å™¨å£°æ˜è¿‡ç¨‹ä¸­çš„NEWå…³é”®å­—ä»£è¡¨INSERTæ·»åŠ è¯­å¥çš„æ–°è®°å½•ã€‚</p><h2 id="3-æŸ¥çœ‹ã€åˆ é™¤è§¦å‘å™¨"><a href="#3-æŸ¥çœ‹ã€åˆ é™¤è§¦å‘å™¨" class="headerlink" title="3. æŸ¥çœ‹ã€åˆ é™¤è§¦å‘å™¨"></a>3. æŸ¥çœ‹ã€åˆ é™¤è§¦å‘å™¨</h2><h3 id="1-æŸ¥çœ‹è§¦å‘å™¨"><a href="#1-æŸ¥çœ‹è§¦å‘å™¨" class="headerlink" title="1)  æŸ¥çœ‹è§¦å‘å™¨"></a>1)  æŸ¥çœ‹è§¦å‘å™¨</h3><p>æŸ¥çœ‹è§¦å‘å™¨æ˜¯æŸ¥çœ‹æ•°æ®åº“ä¸­å·²ç»å­˜åœ¨çš„è§¦å‘å™¨çš„å®šä¹‰ã€çŠ¶æ€å’Œè¯­æ³•ä¿¡æ¯ç­‰ã€‚</p><p>æ–¹å¼1ï¼šæŸ¥çœ‹å½“å‰æ•°æ®åº“çš„æ‰€æœ‰è§¦å‘å™¨çš„å®šä¹‰</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHOW TRIGGERS\G</span><br></pre></td></tr></table></figure><p>æ–¹å¼2ï¼šæŸ¥çœ‹å½“å‰æ•°æ®åº“ä¸­æŸä¸ªè§¦å‘å™¨çš„å®šä¹‰</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHOW CREATE TRIGGER è§¦å‘å™¨å</span><br></pre></td></tr></table></figure><p>æ–¹å¼3ï¼šä»ç³»ç»Ÿåº“information_schemaçš„TRIGGERSè¡¨ä¸­æŸ¥è¯¢â€œsalary_check_triggerâ€è§¦å‘å™¨çš„ä¿¡æ¯ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM information_schema.TRIGGERS;</span><br></pre></td></tr></table></figure><h3 id="2-åˆ é™¤è§¦å‘å™¨"><a href="#2-åˆ é™¤è§¦å‘å™¨" class="headerlink" title="2) åˆ é™¤è§¦å‘å™¨"></a>2) åˆ é™¤è§¦å‘å™¨</h3><p>è§¦å‘å™¨ä¹Ÿæ˜¯æ•°æ®åº“å¯¹è±¡ï¼Œåˆ é™¤è§¦å‘å™¨ä¹Ÿç”¨DROPè¯­å¥ï¼Œè¯­æ³•æ ¼å¼å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DROP TRIGGER IF EXISTS è§¦å‘å™¨åç§°;</span><br></pre></td></tr></table></figure><h2 id="4-è§¦å‘å™¨çš„ä¼˜ç¼ºç‚¹"><a href="#4-è§¦å‘å™¨çš„ä¼˜ç¼ºç‚¹" class="headerlink" title="4. è§¦å‘å™¨çš„ä¼˜ç¼ºç‚¹"></a>4. è§¦å‘å™¨çš„ä¼˜ç¼ºç‚¹</h2><h3 id="1-ä¼˜ç‚¹-2"><a href="#1-ä¼˜ç‚¹-2" class="headerlink" title="1) ä¼˜ç‚¹"></a>1) ä¼˜ç‚¹</h3><p><strong>1ã€è§¦å‘å™¨å¯ä»¥ç¡®ä¿æ•°æ®çš„å®Œæ•´æ€§ã€‚</strong></p><p>å‡è®¾æˆ‘ä»¬ç”¨ è¿›è´§å•å¤´è¡¨ ï¼ˆdemo.importheadï¼‰æ¥ä¿å­˜è¿›è´§å•çš„æ€»ä½“ä¿¡æ¯ï¼ŒåŒ…æ‹¬è¿›è´§å•ç¼–å·ã€ä¾›è´§å•†ç¼–å·ã€ä»“åº“ç¼–å·ã€æ€»è®¡è¿›è´§æ•°é‡ã€æ€»è®¡è¿›è´§é‡‘é¢å’ŒéªŒæ”¶æ—¥æœŸã€‚</p><table><thead><tr><th>listnumber                  (è¿›è´§å•ç¼–å·)</th><th>supplierid                 (è¿›è´§å•†ç¼–å·)</th><th>stockid             (å‚åº“ç¼–å·)</th><th>quantity            (æ€»è®¡æ•°é‡)</th><th>importvalue           (æ€»è®¡é‡‘é¢)</th><th>confirmationdate        ï¼ˆéªŒæ”¶æ—¥æœŸ)</th></tr></thead><tbody><tr><td></td><td></td><td></td><td></td><td></td><td></td></tr></tbody></table><p>ç”¨è¿›è´§å•æ˜ç»†è¡¨ ï¼ˆdemo.importdetailsï¼‰æ¥ä¿å­˜è¿›è´§å•†å“çš„æ˜ç»†ï¼ŒåŒ…æ‹¬è¿›è´§å•ç¼–å·ã€å•†å“ç¼–å·ã€è¿›è´§æ•° é‡ã€è¿›è´§ä»·æ ¼å’Œè¿›è´§é‡‘é¢ã€‚</p><table><thead><tr><th>listnumber                          (è¿›è´§å•ç¼–å·)</th><th>itemnumber                      (å•†å“ç¼–å·)</th><th>quantity                     (è¿›è´§æ•°é‡)</th><th>importprice                     (è¿›è´§ä»·æ ¼)</th><th>importvalue                   ï¼ˆè¿›è´§é‡‘é¢)</th></tr></thead><tbody><tr><td></td><td></td><td></td><td></td><td></td></tr></tbody></table><p>æ¯å½“æˆ‘ä»¬å½•å…¥ã€åˆ é™¤å’Œä¿®æ”¹ä¸€æ¡è¿›è´§å•æ˜ç»†æ•°æ®çš„æ—¶å€™ï¼Œè¿›è´§å•æ˜ç»†è¡¨é‡Œçš„æ•°æ®å°±ä¼šå‘ç”Ÿå˜åŠ¨ã€‚è¿™ä¸ªæ—¶å€™ï¼Œåœ¨è¿›è´§å•å¤´è¡¨ä¸­çš„æ€»è®¡æ•°é‡å’Œæ€»è®¡é‡‘é¢å°±å¿…é¡»é‡æ–°è®¡ç®—ï¼Œå¦åˆ™ï¼Œè¿›è´§å•å¤´è¡¨ä¸­çš„æ€»è®¡æ•°é‡å’Œæ€»è®¡é‡‘ é¢å°±ä¸ç­‰äºè¿›è´§å•æ˜ç»†è¡¨ä¸­æ•°é‡åˆè®¡å’Œé‡‘é¢åˆè®¡äº†ï¼Œè¿™å°±æ˜¯æ•°æ®ä¸ä¸€è‡´ã€‚</p><p>ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨è§¦å‘å™¨ï¼Œè§„å®šæ¯å½“è¿›è´§å•æ˜ç»†è¡¨æœ‰æ•°æ®æ’å…¥ã€ä¿®æ”¹å’Œåˆ é™¤çš„æ“ä½œ æ—¶ï¼Œè‡ªåŠ¨è§¦å‘ 2 æ­¥æ“ä½œï¼š</p><p>1ï¼‰é‡æ–°è®¡ç®—è¿›è´§å•æ˜ç»†è¡¨ä¸­çš„æ•°é‡åˆè®¡å’Œé‡‘é¢åˆè®¡ï¼›</p><p>2ï¼‰ç”¨ç¬¬ä¸€æ­¥ä¸­è®¡ç®—å‡ºæ¥çš„å€¼æ›´æ–°è¿›è´§å•å¤´è¡¨ä¸­çš„åˆè®¡æ•°é‡ä¸åˆè®¡é‡‘é¢ã€‚</p><p>è¿™æ ·ä¸€æ¥ï¼Œè¿›è´§å•å¤´è¡¨ä¸­çš„åˆè®¡æ•°é‡ä¸åˆè®¡é‡‘é¢çš„å€¼ï¼Œå°±å§‹ç»ˆä¸è¿›è´§å•æ˜ç»†è¡¨ä¸­è®¡ç®—å‡ºæ¥çš„åˆè®¡æ•°é‡ä¸ åˆè®¡é‡‘é¢çš„å€¼ç›¸åŒï¼Œæ•°æ®å°±æ˜¯ä¸€è‡´çš„ï¼Œä¸ä¼šäº’ç›¸çŸ›ç›¾ã€‚</p><p><strong>2ã€è§¦å‘å™¨å¯ä»¥å¸®åŠ©æˆ‘ä»¬è®°å½•æ“ä½œæ—¥å¿—ã€‚</strong></p><p>åˆ©ç”¨è§¦å‘å™¨ï¼Œå¯ä»¥å…·ä½“è®°å½•ä»€ä¹ˆæ—¶é—´å‘ç”Ÿäº†ä»€ä¹ˆã€‚æ¯”å¦‚ï¼Œè®°å½•ä¿®æ”¹ä¼šå‘˜å‚¨å€¼é‡‘é¢çš„è§¦å‘å™¨ï¼Œå°±æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„ä¾‹å­ã€‚è¿™å¯¹æˆ‘ä»¬è¿˜åŸæ“ä½œæ‰§è¡Œæ—¶çš„å…·ä½“åœºæ™¯ï¼Œæ›´å¥½åœ°å®šä½é—®é¢˜åŸå› å¾ˆæœ‰å¸®åŠ©ã€‚</p><p><strong>3ã€è§¦å‘å™¨è¿˜å¯ä»¥ç”¨åœ¨æ“ä½œæ•°æ®å‰ï¼Œå¯¹æ•°æ®è¿›è¡Œåˆæ³•æ€§æ£€æŸ¥ã€‚</strong></p><p>æ¯”å¦‚ï¼Œè¶…å¸‚è¿›è´§çš„æ—¶å€™ï¼Œéœ€è¦åº“ç®¡å½•å…¥è¿›è´§ä»·æ ¼ã€‚ä½†æ˜¯ï¼Œäººä¸ºæ“ä½œå¾ˆå®¹æ˜“çŠ¯é”™è¯¯ï¼Œæ¯”å¦‚è¯´åœ¨å½•å…¥æ•°é‡çš„æ—¶å€™ï¼ŒæŠŠæ¡å½¢ç æ‰«è¿›å»äº†ï¼›å½•å…¥é‡‘é¢çš„æ—¶å€™ï¼Œçœ‹ä¸²äº†è¡Œï¼Œå½•å…¥çš„ä»·æ ¼è¿œè¶…å”®ä»·ï¼Œå¯¼è‡´è´¦é¢ä¸Šçš„å·¨äºâ€¦â€¦ è¿™äº›éƒ½å¯ä»¥é€šè¿‡è§¦å‘å™¨ï¼Œåœ¨å®é™…æ’å…¥æˆ–è€…æ›´æ–°æ“ä½œä¹‹å‰ï¼Œå¯¹ç›¸åº”çš„æ•°æ®è¿›è¡Œæ£€æŸ¥ï¼ŒåŠæ—¶æç¤ºé”™è¯¯ï¼Œé˜²æ­¢é”™è¯¯æ•°æ®è¿›å…¥ç³»ç»Ÿã€‚</p><h3 id="2-ç¼ºç‚¹-1"><a href="#2-ç¼ºç‚¹-1" class="headerlink" title="2) ç¼ºç‚¹"></a>2) ç¼ºç‚¹</h3><p><strong>1ã€è§¦å‘å™¨æœ€å¤§çš„ä¸€ä¸ªé—®é¢˜å°±æ˜¯å¯è¯»æ€§å·®ã€‚</strong></p><p>å› ä¸ºè§¦å‘å™¨å­˜å‚¨åœ¨æ•°æ®åº“ä¸­ï¼Œå¹¶ä¸”ç”±äº‹ä»¶é©±åŠ¨ï¼Œè¿™å°±æ„å‘³ç€è§¦å‘å™¨æœ‰å¯èƒ½ä¸å—åº”ç”¨å±‚çš„æ§åˆ¶ ã€‚è¿™å¯¹ç³»ç»Ÿç»´æŠ¤æ˜¯éå¸¸æœ‰æŒ‘æˆ˜çš„ã€‚</p><p><strong>2ã€ç›¸å…³æ•°æ®çš„å˜æ›´ï¼Œå¯èƒ½ä¼šå¯¼è‡´è§¦å‘å™¨å‡ºé”™ã€‚</strong></p><p>ç‰¹åˆ«æ˜¯æ•°æ®è¡¨ç»“æ„çš„å˜æ›´ï¼Œéƒ½å¯èƒ½ä¼šå¯¼è‡´è§¦å‘å™¨å‡ºé”™ï¼Œè¿›è€Œå½±å“æ•°æ®æ“ä½œçš„æ­£å¸¸è¿è¡Œã€‚è¿™äº›éƒ½ä¼šç”±äºè§¦å‘å™¨æœ¬èº«çš„éšè”½æ€§ï¼Œå½±å“åˆ°åº”ç”¨ä¸­é”™è¯¯åŸå› æ’æŸ¥çš„æ•ˆç‡ã€‚</p><h3 id="3-æ³¨æ„ç‚¹"><a href="#3-æ³¨æ„ç‚¹" class="headerlink" title="3) æ³¨æ„ç‚¹"></a>3) æ³¨æ„ç‚¹</h3><p>æ³¨æ„ï¼Œå¦‚æœåœ¨å­è¡¨ä¸­å®šä¹‰äº†å¤–é”®çº¦æŸï¼Œå¹¶ä¸”å¤–é”®æŒ‡å®šäº†ON UPDATE&#x2F;DELETE CASCADE&#x2F;SET NULLå­å¥ï¼Œæ­¤æ—¶ä¿®æ”¹çˆ¶è¡¨è¢«å¼•ç”¨çš„é”®å€¼æˆ–åˆ é™¤çˆ¶è¡¨è¢«å¼•ç”¨çš„è®°å½•è¡Œæ—¶ï¼Œä¹Ÿä¼šå¼•èµ·å­è¡¨çš„ä¿®æ”¹å’Œåˆ é™¤æ“ä½œï¼Œæ­¤æ—¶åŸºäºå­è¡¨çš„UPDATEå’ŒDELETEè¯­å¥å®šä¹‰çš„è§¦å‘å™¨å¹¶ä¸ä¼šè¢«æ¿€æ´»ã€‚</p><p>ä¾‹å¦‚ï¼šåŸºäºå­è¡¨å‘˜å·¥è¡¨ï¼ˆt_employeeï¼‰çš„DELETEè¯­å¥å®šä¹‰äº†è§¦å‘å™¨t1ï¼Œè€Œå­è¡¨çš„éƒ¨é—¨ç¼–å·ï¼ˆdidï¼‰å­—æ®µå®šä¹‰äº†å¤–é”®çº¦æŸå¼•ç”¨äº†çˆ¶è¡¨éƒ¨é—¨è¡¨ï¼ˆt_departmentï¼‰çš„ä¸»é”®åˆ—éƒ¨é—¨ç¼–å·ï¼ˆdidï¼‰ï¼Œå¹¶ä¸”è¯¥å¤–é”®åŠ äº†â€œON DELETE SET NULLâ€å­å¥ï¼Œé‚£ä¹ˆå¦‚æœæ­¤æ—¶åˆ é™¤çˆ¶è¡¨éƒ¨é—¨è¡¨ï¼ˆt_departmentï¼‰åœ¨å­è¡¨å‘˜å·¥è¡¨ï¼ˆt_employeeï¼‰ æœ‰åŒ¹é…è®°å½•çš„éƒ¨é—¨è®°å½•æ—¶ï¼Œä¼šå¼•èµ·å­è¡¨å‘˜å·¥è¡¨ï¼ˆt_employeeï¼‰åŒ¹é…è®°å½•çš„éƒ¨é—¨ç¼–å·ï¼ˆdidï¼‰ä¿®æ”¹ä¸ºNULLï¼Œ mysql&gt; update demo.membermaster set memberdeposit&#x3D;20 where memberid &#x3D; 2; ERROR 1054 (42S22): Unknown column â€˜aaâ€™ in â€˜field listâ€™ ä½†æ˜¯æ­¤æ—¶ä¸ä¼šæ¿€æ´»è§¦å‘å™¨t1ã€‚åªæœ‰ç›´æ¥å¯¹å­è¡¨å‘˜å·¥è¡¨ï¼ˆt_employeeï¼‰æ‰§è¡ŒDELETEè¯­å¥æ—¶æ‰ä¼šæ¿€æ´»è§¦å‘å™¨ t1ã€‚</p><h1 id="ç¬¬18ç« -MySQL8å…¶ä»–æ–°ç‰¹æ€§"><a href="#ç¬¬18ç« -MySQL8å…¶ä»–æ–°ç‰¹æ€§" class="headerlink" title="ç¬¬18ç« _MySQL8å…¶ä»–æ–°ç‰¹æ€§"></a>ç¬¬18ç« _MySQL8å…¶ä»–æ–°ç‰¹æ€§</h1><h2 id="1-MySQL8æ–°ç‰¹æ€§æ¦‚è¿°"><a href="#1-MySQL8æ–°ç‰¹æ€§æ¦‚è¿°" class="headerlink" title="1. MySQL8æ–°ç‰¹æ€§æ¦‚è¿°"></a>1. MySQL8æ–°ç‰¹æ€§æ¦‚è¿°</h2><p>MySQLä»5.7ç‰ˆæœ¬ç›´æ¥è·³è·ƒå‘å¸ƒäº†8.0ç‰ˆæœ¬ ï¼Œå¯è§è¿™æ˜¯ä¸€ä¸ªä»¤äººå…´å¥‹çš„é‡Œç¨‹ç¢‘ç‰ˆæœ¬ã€‚MySQL 8ç‰ˆæœ¬åœ¨åŠŸèƒ½ä¸Šåšäº†æ˜¾è‘—çš„æ”¹è¿›ä¸å¢å¼ºï¼Œå¼€å‘è€…å¯¹MySQLçš„æºä»£ç è¿›è¡Œäº†é‡æ„ï¼Œæœ€çªå‡ºçš„ä¸€ç‚¹æ˜¯å¤šMySQL Optimizerä¼˜åŒ–å™¨è¿›è¡Œäº†æ”¹è¿›ã€‚ä¸ä»…åœ¨é€Ÿåº¦ä¸Šå¾—åˆ°äº†æ”¹å–„ï¼Œè¿˜ä¸ºç”¨æˆ·å¸¦æ¥äº†æ›´å¥½çš„æ€§èƒ½å’Œæ›´æ£’çš„ä½“éªŒã€‚</p><h3 id="1-MySQL8-0-æ–°å¢ç‰¹æ€§"><a href="#1-MySQL8-0-æ–°å¢ç‰¹æ€§" class="headerlink" title="1) MySQL8.0 æ–°å¢ç‰¹æ€§"></a>1) MySQL8.0 æ–°å¢ç‰¹æ€§</h3><ol><li><p>æ›´ç®€ä¾¿çš„NoSQLæ”¯æŒ NoSQLæ³›æŒ‡éå…³ç³»å‹æ•°æ®åº“å’Œæ•°æ®å­˜å‚¨ã€‚éšç€äº’è”ç½‘å¹³å°çš„è§„æ¨¡é£é€Ÿå‘å±•ï¼Œä¼ ç»Ÿ çš„å…³ç³»å‹æ•°æ®åº“å·²ç»è¶Šæ¥è¶Šä¸èƒ½æ»¡è¶³éœ€æ±‚ã€‚ä»5.6ç‰ˆæœ¬å¼€å§‹ï¼ŒMySQLå°±å¼€å§‹æ”¯æŒç®€å•çš„NoSQLå­˜å‚¨åŠŸèƒ½ã€‚ MySQL 8å¯¹è¿™ä¸€åŠŸèƒ½åšäº†ä¼˜åŒ–ï¼Œä»¥æ›´çµæ´»çš„æ–¹å¼å®ç°NoSQLåŠŸèƒ½ï¼Œä¸å†ä¾èµ–æ¨¡å¼ï¼ˆschemaï¼‰ã€‚ </p></li><li><p>æ›´å¥½çš„ç´¢å¼• åœ¨æŸ¥è¯¢ä¸­ï¼Œæ­£ç¡®åœ°ä½¿ç”¨ç´¢å¼•å¯ä»¥æé«˜æŸ¥è¯¢çš„æ•ˆç‡ã€‚MySQL 8ä¸­æ–°å¢äº† éšè—ç´¢å¼• å’Œ é™åºç´¢ å¼• ã€‚éšè—ç´¢å¼•å¯ä»¥ç”¨æ¥æµ‹è¯•å»æ‰ç´¢å¼•å¯¹æŸ¥è¯¢æ€§èƒ½çš„å½±å“ã€‚åœ¨æŸ¥è¯¢ä¸­æ··åˆå­˜åœ¨å¤šåˆ—ç´¢å¼•æ—¶ï¼Œä½¿ç”¨é™åºç´¢å¼• å¯ä»¥æé«˜æŸ¥è¯¢çš„æ€§èƒ½ã€‚ </p></li><li><p>æ›´å®Œå–„çš„JSONæ”¯æŒ MySQLä»5.7å¼€å§‹æ”¯æŒåŸç”ŸJSONæ•°æ®çš„å­˜å‚¨ï¼ŒMySQL 8å¯¹è¿™ä¸€åŠŸèƒ½åšäº†ä¼˜åŒ–ï¼Œå¢åŠ  äº†èšåˆå‡½æ•° JSON_ARRAYAGG() å’Œ JSON_OBJECTAGG() ï¼Œå°†å‚æ•°èšåˆä¸ºJSONæ•°ç»„æˆ–å¯¹è±¡ï¼Œæ–°å¢äº†è¡Œå†… æ“ä½œç¬¦ -&gt;&gt;ï¼Œæ˜¯åˆ—è·¯å¾„è¿ç®—ç¬¦ -&gt;çš„å¢å¼ºï¼Œå¯¹JSONæ’åºåšäº†æå‡ï¼Œå¹¶ä¼˜åŒ–äº†JSONçš„æ›´æ–°æ“ä½œã€‚ </p></li><li><p>å®‰å…¨å’Œè´¦æˆ·ç®¡ç† MySQL 8ä¸­æ–°å¢äº† caching_sha2_password æˆæƒæ’ä»¶ã€è§’è‰²ã€å¯†ç å†å²è®°å½•å’ŒFIPS æ¨¡å¼æ”¯æŒï¼Œè¿™äº›ç‰¹æ€§æé«˜äº†æ•°æ®åº“çš„å®‰å…¨æ€§å’Œæ€§èƒ½ï¼Œä½¿æ•°æ®åº“ç®¡ç†å‘˜èƒ½å¤Ÿæ›´çµæ´»åœ°è¿›è¡Œè´¦æˆ·ç®¡ç†å·¥ä½œã€‚ </p></li><li><p>InnoDBçš„å˜åŒ– InnoDBæ˜¯MySQLé»˜è®¤çš„å­˜å‚¨å¼•æ“ ï¼Œæ˜¯äº‹åŠ¡å‹æ•°æ®åº“çš„é¦–é€‰å¼•æ“ï¼Œæ”¯æŒäº‹åŠ¡å®‰å…¨è¡¨ ï¼ˆACIDï¼‰ï¼Œæ”¯æŒè¡Œé”å®šå’Œå¤–é”®ã€‚åœ¨MySQL 8 ç‰ˆæœ¬ä¸­ï¼ŒInnoDBåœ¨è‡ªå¢ã€ç´¢å¼•ã€åŠ å¯†ã€æ­»é”ã€å…±äº«é”ç­‰æ–¹é¢ åšäº†å¤§é‡çš„ æ”¹è¿›å’Œä¼˜åŒ– ï¼Œå¹¶ä¸”æ”¯æŒåŸå­æ•°æ®å®šä¹‰è¯­è¨€ï¼ˆDDLï¼‰ï¼Œæé«˜äº†æ•°æ®å®‰å…¨æ€§ï¼Œå¯¹äº‹åŠ¡æä¾›æ›´å¥½çš„ æ”¯æŒã€‚</p></li><li><p>æ•°æ®å­—å…¸ åœ¨ä¹‹å‰çš„MySQLç‰ˆæœ¬ä¸­ï¼Œå­—å…¸æ•°æ®éƒ½å­˜å‚¨åœ¨å…ƒæ•°æ®æ–‡ä»¶å’Œéäº‹åŠ¡è¡¨ä¸­ã€‚ä»MySQL 8å¼€å§‹æ–°å¢ äº†äº‹åŠ¡æ•°æ®å­—å…¸ï¼Œåœ¨è¿™ä¸ªå­—å…¸é‡Œå­˜å‚¨ç€æ•°æ®åº“å¯¹è±¡ä¿¡æ¯ï¼Œè¿™äº›æ•°æ®å­—å…¸å­˜å‚¨åœ¨å†…éƒ¨äº‹åŠ¡è¡¨ä¸­ã€‚ </p></li><li><p>åŸå­æ•°æ®å®šä¹‰è¯­å¥ MySQL 8å¼€å§‹æ”¯æŒåŸå­æ•°æ®å®šä¹‰è¯­å¥ï¼ˆAutomic DDLï¼‰ï¼Œå³ åŸå­DDL ã€‚ç›®å‰ï¼Œåªæœ‰ InnoDBå­˜å‚¨å¼•æ“æ”¯æŒåŸå­DDLã€‚åŸå­æ•°æ®å®šä¹‰è¯­å¥ï¼ˆDDLï¼‰å°†ä¸DDLæ“ä½œç›¸å…³çš„æ•°æ®å­—å…¸æ›´æ–°ã€å­˜å‚¨å¼•æ“ æ“ä½œã€äºŒè¿›åˆ¶æ—¥å¿—å†™å…¥ç»“åˆåˆ°ä¸€ä¸ªå•ç‹¬çš„åŸå­äº‹åŠ¡ä¸­ï¼Œè¿™ä½¿å¾—å³ä½¿æœåŠ¡å™¨å´©æºƒï¼Œäº‹åŠ¡ä¹Ÿä¼šæäº¤æˆ–å›æ»šã€‚ ä½¿ç”¨æ”¯æŒåŸå­æ“ä½œçš„å­˜å‚¨å¼•æ“æ‰€åˆ›å»ºçš„è¡¨ï¼Œåœ¨æ‰§è¡ŒDROP TABLEã€CREATE TABLEã€ALTER TABLEã€ RENAME TABLEã€TRUNCATE TABLEã€CREATE TABLESPACEã€DROP TABLESPACEç­‰æ“ä½œæ—¶ï¼Œéƒ½æ”¯æŒåŸå­æ“ ä½œï¼Œå³äº‹åŠ¡è¦ä¹ˆå®Œå…¨æ“ä½œæˆåŠŸï¼Œè¦ä¹ˆå¤±è´¥åå›æ»šï¼Œä¸å†è¿›è¡Œéƒ¨åˆ†æäº¤ã€‚ å¯¹äºä»MySQL 5.7å¤åˆ¶åˆ°MySQL 8 ç‰ˆæœ¬ä¸­çš„è¯­å¥ï¼Œå¯ä»¥æ·»åŠ  IF EXISTS æˆ– IF NOT EXISTS è¯­å¥æ¥é¿å…å‘ç”Ÿé”™è¯¯ã€‚ </p></li><li><p>èµ„æºç®¡ç† MySQL 8å¼€å§‹æ”¯æŒåˆ›å»ºå’Œç®¡ç†èµ„æºç»„ï¼Œå…è®¸å°†æœåŠ¡å™¨å†…è¿è¡Œçš„çº¿ç¨‹åˆ†é…ç»™ç‰¹å®šçš„åˆ†ç»„ï¼Œä»¥ä¾¿ çº¿ç¨‹æ ¹æ®ç»„å†…å¯ç”¨èµ„æºæ‰§è¡Œã€‚ç»„å±æ€§èƒ½å¤Ÿæ§åˆ¶ç»„å†…èµ„æºï¼Œå¯ç”¨æˆ–é™åˆ¶ç»„å†…èµ„æºæ¶ˆè€—ã€‚æ•°æ®åº“ç®¡ç†å‘˜èƒ½å¤Ÿ æ ¹æ®ä¸åŒçš„å·¥ä½œè´Ÿè½½é€‚å½“åœ°æ›´æ”¹è¿™äº›å±æ€§ã€‚ ç›®å‰ï¼ŒCPUæ—¶é—´æ˜¯å¯æ§èµ„æºï¼Œç”±â€œè™šæ‹ŸCPUâ€è¿™ä¸ªæ¦‚å¿µæ¥è¡¨ ç¤ºï¼Œæ­¤æœ¯è¯­åŒ…å«CPUçš„æ ¸å¿ƒæ•°ï¼Œè¶…çº¿ç¨‹ï¼Œç¡¬ä»¶çº¿ç¨‹ç­‰ç­‰ã€‚æœåŠ¡å™¨åœ¨å¯åŠ¨æ—¶ç¡®å®šå¯ç”¨çš„è™šæ‹ŸCPUæ•°é‡ã€‚æ‹¥æœ‰ å¯¹åº”æƒé™çš„æ•°æ®åº“ç®¡ç†å‘˜å¯ä»¥å°†è¿™äº›CPUä¸èµ„æºç»„å…³è”ï¼Œå¹¶ä¸ºèµ„æºç»„åˆ†é…çº¿ç¨‹ã€‚ èµ„æºç»„ç»„ä»¶ä¸ºMySQLä¸­çš„èµ„æºç»„ç®¡ç†æä¾›äº†SQLæ¥å£ã€‚èµ„æºç»„çš„å±æ€§ç”¨äºå®šä¹‰èµ„æºç»„ã€‚MySQLä¸­å­˜åœ¨ä¸¤ä¸ªé»˜è®¤ç»„ï¼Œç³»ç»Ÿç»„å’Œç”¨æˆ· ç»„ï¼Œé»˜è®¤çš„ç»„ä¸èƒ½è¢«åˆ é™¤ï¼Œå…¶å±æ€§ä¹Ÿä¸èƒ½è¢«æ›´æ”¹ã€‚å¯¹äºç”¨æˆ·è‡ªå®šä¹‰çš„ç»„ï¼Œèµ„æºç»„åˆ›å»ºæ—¶å¯åˆå§‹åŒ–æ‰€æœ‰çš„ å±æ€§ï¼Œé™¤å»åå­—å’Œç±»å‹ï¼Œå…¶ä»–å±æ€§éƒ½å¯åœ¨åˆ›å»ºä¹‹åè¿›è¡Œæ›´æ”¹ã€‚ åœ¨ä¸€äº›å¹³å°ä¸‹ï¼Œæˆ–è¿›è¡Œäº†æŸäº›MySQLçš„é… ç½®æ—¶ï¼Œèµ„æºç®¡ç†çš„åŠŸèƒ½å°†å—åˆ°é™åˆ¶ï¼Œç”šè‡³ä¸å¯ç”¨ã€‚ä¾‹å¦‚ï¼Œå¦‚æœå®‰è£…äº†çº¿ç¨‹æ± æ’ä»¶ï¼Œæˆ–è€…ä½¿ç”¨çš„æ˜¯macOS ç³»ç»Ÿï¼Œèµ„æºç®¡ç†å°†å¤„äºä¸å¯ç”¨çŠ¶æ€ã€‚åœ¨FreeBSDå’ŒSolarisç³»ç»Ÿä¸­ï¼Œèµ„æºçº¿ç¨‹ä¼˜å…ˆçº§å°†å¤±æ•ˆã€‚åœ¨Linuxç³»ç»Ÿ ä¸­ï¼Œåªæœ‰é…ç½®äº†CAP_SYS_NICEå±æ€§ï¼Œèµ„æºç®¡ç†ä¼˜å…ˆçº§æ‰èƒ½å‘æŒ¥ä½œç”¨ã€‚</p></li><li><p>å­—ç¬¦é›†æ”¯æŒ MySQL 8ä¸­é»˜è®¤çš„å­—ç¬¦é›†ç”± latin1 æ›´æ”¹ä¸º utf8mb4 ï¼Œå¹¶é¦–æ¬¡å¢åŠ äº†æ—¥è¯­æ‰€ç‰¹å®šä½¿ç”¨çš„é›† åˆï¼Œutf8mb4_ja_0900_as_csã€‚ </p></li><li><p>ä¼˜åŒ–å™¨å¢å¼º MySQLä¼˜åŒ–å™¨å¼€å§‹æ”¯æŒéšè—ç´¢å¼•å’Œé™åºç´¢å¼•ã€‚éšè—ç´¢å¼•ä¸ä¼šè¢«ä¼˜åŒ–å™¨ä½¿ç”¨ï¼ŒéªŒè¯ç´¢å¼•çš„å¿… è¦æ€§æ—¶ä¸éœ€è¦åˆ é™¤ç´¢å¼•ï¼Œå…ˆå°†ç´¢å¼•éšè—ï¼Œå¦‚æœä¼˜åŒ–å™¨æ€§èƒ½æ— å½±å“å°±å¯ä»¥çœŸæ­£åœ°åˆ é™¤ç´¢å¼•ã€‚é™åºç´¢å¼•å…è®¸ ä¼˜åŒ–å™¨å¯¹å¤šä¸ªåˆ—è¿›è¡Œæ’åºï¼Œå¹¶ä¸”å…è®¸æ’åºé¡ºåºä¸ä¸€è‡´ã€‚ </p></li><li><p>å…¬ç”¨è¡¨è¡¨è¾¾å¼ å…¬ç”¨è¡¨è¡¨è¾¾å¼ï¼ˆCommon Table Expressionsï¼‰ç®€ç§°ä¸ºCTEï¼ŒMySQLç°åœ¨æ”¯æŒé€’å½’å’Œéé€’ å½’ä¸¤ç§å½¢å¼çš„CTEã€‚CTEé€šè¿‡åœ¨SELECTè¯­å¥æˆ–å…¶ä»–ç‰¹å®šè¯­å¥å‰ ä½¿ç”¨WITHè¯­å¥å¯¹ä¸´æ—¶ç»“æœé›† è¿›è¡Œå‘½åã€‚</p><p>åŸºç¡€è¯­æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">    WITH cte_name (col_name1,col_name2 ...) AS (Subquery)</span><br><span class="line">    SELECT * FROM cte_name;</span><br><span class="line"></span><br><span class="line">â€‹Subqueryä»£è¡¨å­æŸ¥è¯¢ï¼Œå­æŸ¥è¯¢å‰ä½¿ç”¨WITHè¯­å¥å°†ç»“æœé›†å‘½åä¸ºcte_nameï¼Œåœ¨åç»­çš„æŸ¥è¯¢ä¸­å³å¯ä½¿ç”¨ cte_nameè¿›è¡ŒæŸ¥è¯¢ã€‚</span><br><span class="line"></span><br><span class="line">12. çª—å£å‡½æ•° MySQL 8å¼€å§‹æ”¯æŒçª—å£å‡½æ•°ã€‚åœ¨ä¹‹å‰çš„ç‰ˆæœ¬ä¸­å·²å­˜åœ¨çš„å¤§éƒ¨åˆ† èšåˆå‡½æ•° åœ¨MySQL 8ä¸­ä¹Ÿå¯ä»¥ ä½œä¸ºçª—å£å‡½æ•°æ¥ä½¿ç”¨ã€‚</span><br><span class="line"></span><br><span class="line">![image-20220613202507072](MySQLåŸºç¡€ç¯‡.assets/image-20220613202507072.png)</span><br><span class="line"></span><br><span class="line">13. æ­£åˆ™è¡¨è¾¾å¼æ”¯æŒ MySQLåœ¨8.0.4ä»¥åçš„ç‰ˆæœ¬ä¸­é‡‡ç”¨æ”¯æŒUnicodeçš„å›½é™…åŒ–ç»„ä»¶åº“å®ç°æ­£åˆ™è¡¨è¾¾å¼æ“ä½œï¼Œ è¿™ç§æ–¹å¼ä¸ä»…èƒ½æä¾›å®Œå…¨çš„Unicodeæ”¯æŒï¼Œè€Œä¸”æ˜¯å¤šå­—èŠ‚å®‰å…¨ç¼–ç ã€‚MySQLå¢åŠ äº†REGEXP_LIKE()ã€ EGEXP_INSTR()ã€REGEXP_REPLACE()å’Œ REGEXP_SUBSTR()ç­‰å‡½æ•°æ¥æå‡æ€§èƒ½ã€‚å¦å¤–ï¼Œregexp_stack_limitå’Œ regexp_time_limit ç³»ç»Ÿå˜é‡èƒ½å¤Ÿé€šè¿‡åŒ¹é…å¼•æ“æ¥æ§åˆ¶èµ„æºæ¶ˆè€—ã€‚</span><br><span class="line">14. å†…éƒ¨ä¸´æ—¶è¡¨ TempTableå­˜å‚¨å¼•æ“å–ä»£MEMORYå­˜å‚¨å¼•æ“æˆä¸ºå†…éƒ¨ä¸´æ—¶è¡¨çš„é»˜è®¤å­˜å‚¨å¼•æ“ ã€‚TempTableå­˜å‚¨ å¼•æ“ä¸ºVARCHARå’ŒVARBINARYåˆ—æä¾›é«˜æ•ˆå­˜å‚¨ã€‚internal_tmp_mem_storage_engineä¼šè¯å˜é‡å®šä¹‰äº†å†…éƒ¨ ä¸´æ—¶è¡¨çš„å­˜å‚¨å¼•æ“ï¼Œå¯é€‰çš„å€¼æœ‰ä¸¤ä¸ªï¼ŒTempTableå’ŒMEMORYï¼Œå…¶ä¸­TempTableä¸ºé»˜è®¤çš„å­˜å‚¨å¼•æ“ã€‚ temptable_max_ramç³»ç»Ÿé…ç½®é¡¹å®šä¹‰äº†TempTableå­˜å‚¨å¼•æ“å¯ä½¿ç”¨çš„æœ€å¤§å†…å­˜æ•°é‡ã€‚</span><br><span class="line">15. æ—¥å¿—è®°å½• åœ¨MySQL 8ä¸­é”™è¯¯æ—¥å¿—å­ç³»ç»Ÿç”±ä¸€ç³»åˆ—MySQLç»„ä»¶æ„æˆã€‚è¿™äº›ç»„ä»¶çš„æ„æˆç”±ç³»ç»Ÿå˜é‡ log_error_servicesæ¥é…ç½®ï¼Œèƒ½å¤Ÿå®ç°æ—¥å¿—äº‹ä»¶çš„è¿‡æ»¤å’Œå†™å…¥ã€‚ WITH cte_name (col_name1,col_name2 ...) AS (Subquery) SELECT * FROM cte_name; </span><br><span class="line">16. å¤‡ä»½é” æ–°çš„å¤‡ä»½é”å…è®¸åœ¨çº¿å¤‡ä»½æœŸé—´æ‰§è¡Œæ•°æ®æ“ä½œè¯­å¥ï¼ŒåŒæ—¶é˜»æ­¢å¯èƒ½é€ æˆå¿«ç…§ä¸ä¸€è‡´çš„æ“ä½œã€‚æ–° å¤‡ä»½é”ç”± LOCK INSTANCE FOR BACKUP å’Œ UNLOCK INSTANCE è¯­æ³•æä¾›æ”¯æŒï¼Œæ‰§è¡Œè¿™äº›æ“ä½œéœ€è¦å¤‡ä»½ç®¡ç† å‘˜ç‰¹æƒã€‚ </span><br><span class="line">17. å¢å¼ºçš„MySQLå¤åˆ¶ MySQL 8å¤åˆ¶æ”¯æŒå¯¹ JSONæ–‡æ¡£ è¿›è¡Œéƒ¨åˆ†æ›´æ–°çš„ äºŒè¿›åˆ¶æ—¥å¿—è®°å½• ï¼Œè¯¥è®°å½• ä½¿ç”¨ç´§å‡‘ çš„äºŒè¿›åˆ¶æ ¼å¼ ï¼Œä»è€ŒèŠ‚çœè®°å½•å®Œæ•´JSONæ–‡æ¡£çš„ç©ºé—´ã€‚å½“ä½¿ç”¨åŸºäºè¯­å¥çš„æ—¥å¿—è®°å½•æ—¶ï¼Œè¿™ç§ç´§å‡‘çš„æ—¥å¿—è®° å½•ä¼šè‡ªåŠ¨å®Œæˆï¼Œå¹¶ä¸”å¯ä»¥é€šè¿‡å°†æ–°çš„binlog_row_value_optionsç³»ç»Ÿå˜é‡å€¼è®¾ç½®ä¸ºPARTIAL_JSONæ¥å¯ç”¨ã€‚</span><br><span class="line"></span><br><span class="line">### 2) MySQL8.0 ç§»é™¤çš„æ—§ç‰¹æ€§</span><br><span class="line"></span><br><span class="line">åœ¨MySQL 5.7ç‰ˆæœ¬ä¸Šå¼€å‘çš„åº”ç”¨ç¨‹åºå¦‚æœä½¿ç”¨äº†MySQL8.0 ç§»é™¤çš„ç‰¹æ€§ï¼Œè¯­å¥å¯èƒ½ä¼šå¤±è´¥ï¼Œæˆ–è€…äº§ç”Ÿä¸åŒ çš„æ‰§è¡Œç»“æœã€‚ä¸ºäº†é¿å…è¿™äº›é—®é¢˜ï¼Œå¯¹äºä½¿ç”¨äº†ç§»é™¤ç‰¹æ€§çš„åº”ç”¨ï¼Œåº”å½“å°½åŠ›ä¿®æ­£é¿å…ä½¿ç”¨è¿™äº›ç‰¹æ€§ï¼Œå¹¶å°½ å¯èƒ½ä½¿ç”¨æ›¿ä»£æ–¹æ³•ã€‚</span><br><span class="line"></span><br><span class="line">1. æŸ¥è¯¢ç¼“å­˜ æŸ¥è¯¢ç¼“å­˜å·²è¢«ç§»é™¤ ï¼Œåˆ é™¤çš„é¡¹æœ‰ï¼š ï¼ˆ1ï¼‰è¯­å¥ï¼šFLUSH QUERY CACHEå’ŒRESET QUERY CACHEã€‚ ï¼ˆ2ï¼‰ç³»ç»Ÿå˜é‡ï¼šquery_cache_limitã€query_cache_min_res_unitã€query_cache_sizeã€ query_cache_typeã€query_cache_wlock_invalidateã€‚ ï¼ˆ3ï¼‰çŠ¶æ€å˜é‡ï¼šQcache_free_blocksã€ Qcache_free_memoryã€Qcache_hitsã€Qcache_insertsã€Qcache_lowmem_prunesã€Qcache_not_cachedã€ Qcache_queries_in_cacheã€Qcache_total_blocksã€‚ ï¼ˆ4ï¼‰çº¿ç¨‹çŠ¶æ€ï¼šchecking privileges on cached queryã€checking query cache for queryã€invalidating query cache entriesã€sending cached result to clientã€storing result in query cacheã€waiting for query cache lockã€‚</span><br><span class="line">2. åŠ å¯†ç›¸å…³ åˆ é™¤çš„åŠ å¯†ç›¸å…³çš„å†…å®¹æœ‰ï¼šENCODE()ã€DECODE()ã€ENCRYPT()ã€DES_ENCRYPT()å’Œ DES_DECRYPT()å‡½æ•°ï¼Œé…ç½®é¡¹des-key-fileï¼Œç³»ç»Ÿå˜é‡have_cryptï¼ŒFLUSHè¯­å¥çš„DES_KEY_FILEé€‰é¡¹ï¼Œ HAVE_CRYPT CMakeé€‰é¡¹ã€‚ å¯¹äºç§»é™¤çš„ENCRYPT()å‡½æ•°ï¼Œè€ƒè™‘ä½¿ç”¨SHA2()æ›¿ä»£ï¼Œå¯¹äºå…¶ä»–ç§»é™¤çš„å‡½æ•°ï¼Œä½¿ ç”¨AES_ENCRYPT()å’ŒAES_DECRYPT()æ›¿ä»£ã€‚ </span><br><span class="line">3. ç©ºé—´å‡½æ•°ç›¸å…³ åœ¨MySQL 5.7ç‰ˆæœ¬ä¸­ï¼Œå¤šä¸ªç©ºé—´å‡½æ•°å·²è¢«æ ‡è®°ä¸ºè¿‡æ—¶ã€‚è¿™äº›è¿‡æ—¶å‡½æ•°åœ¨MySQL 8ä¸­éƒ½å·²è¢« ç§»é™¤ï¼Œåªä¿ç•™äº†å¯¹åº”çš„ST_å’ŒMBRå‡½æ•°ã€‚ </span><br><span class="line">4. \Nå’ŒNULL åœ¨SQLè¯­å¥ä¸­ï¼Œè§£æå™¨ä¸å†å°†\Nè§†ä¸ºNULLï¼Œæ‰€ä»¥åœ¨SQLè¯­å¥ä¸­åº”ä½¿ç”¨NULLä»£æ›¿\Nã€‚è¿™é¡¹å˜åŒ– ä¸ä¼šå½±å“ä½¿ç”¨LOAD DATA INFILEæˆ–è€…SELECT...INTO OUTFILEæ“ä½œæ–‡ä»¶çš„å¯¼å…¥å’Œå¯¼å‡ºã€‚åœ¨è¿™ç±»æ“ä½œä¸­ï¼ŒNULL ä»ç­‰åŒäº\Nã€‚ </span><br><span class="line">5. mysql_install_db åœ¨MySQLåˆ†å¸ƒä¸­ï¼Œå·²ç§»é™¤äº†mysql_install_dbç¨‹åºï¼Œæ•°æ®å­—å…¸åˆå§‹åŒ–éœ€è¦è°ƒç”¨å¸¦ç€-- initializeæˆ–è€…--initialize-insecureé€‰é¡¹çš„mysqldæ¥ä»£æ›¿å®ç°ã€‚å¦å¤–ï¼Œ--bootstrapå’ŒINSTALL_SCRIPTDIR CMakeä¹Ÿå·²è¢«åˆ é™¤ã€‚ </span><br><span class="line">6. é€šç”¨åˆ†åŒºå¤„ç†ç¨‹åº é€šç”¨åˆ†åŒºå¤„ç†ç¨‹åºå·²ä»MySQLæœåŠ¡ä¸­è¢«ç§»é™¤ã€‚ä¸ºäº†å®ç°ç»™å®šè¡¨åˆ†åŒºï¼Œè¡¨æ‰€ä½¿ç”¨çš„å­˜ å‚¨å¼•æ“éœ€è¦è‡ªæœ‰çš„åˆ†åŒºå¤„ç†ç¨‹åºã€‚ æä¾›æœ¬åœ°åˆ†åŒºæ”¯æŒçš„MySQLå­˜å‚¨å¼•æ“æœ‰ä¸¤ä¸ªï¼Œå³InnoDBå’ŒNDBï¼Œè€Œåœ¨ MySQL 8ä¸­åªæ”¯æŒInnoDBã€‚ </span><br><span class="line">7. ç³»ç»Ÿå’ŒçŠ¶æ€å˜é‡ä¿¡æ¯ åœ¨INFORMATION_SCHEMAæ•°æ®åº“ä¸­ï¼Œå¯¹ç³»ç»Ÿå’ŒçŠ¶æ€å˜é‡ä¿¡æ¯ä¸å†è¿›è¡Œç»´æŠ¤ã€‚ GLOBAL_VARIABLESã€SESSION_VARIABLESã€GLOBAL_STATUSã€SESSION_STATUSè¡¨éƒ½å·²è¢«åˆ é™¤ã€‚å¦å¤–ï¼Œç³» ç»Ÿå˜é‡show_compatibility_56ä¹Ÿå·²è¢«åˆ é™¤ã€‚è¢«åˆ é™¤çš„çŠ¶æ€å˜é‡æœ‰Slave_heartbeat_periodã€ Slave_last_heartbeat,Slave_received_heartbeatsã€Slave_retried_transactionsã€Slave_runningã€‚ä»¥ä¸Šè¢«åˆ é™¤ çš„å†…å®¹éƒ½å¯ä½¿ç”¨æ€§èƒ½æ¨¡å¼ä¸­å¯¹åº”çš„å†…å®¹è¿›è¡Œæ›¿ä»£ã€‚ </span><br><span class="line">8. mysql_pluginå·¥å…· mysql_pluginå·¥å…·ç”¨æ¥é…ç½®MySQLæœåŠ¡å™¨æ’ä»¶ï¼Œç°å·²è¢«åˆ é™¤ï¼Œå¯ä½¿ç”¨--plugin-loadæˆ–- -plugin-load-addé€‰é¡¹åœ¨æœåŠ¡å™¨å¯åŠ¨æ—¶åŠ è½½æ’ä»¶æˆ–è€…åœ¨è¿è¡Œæ—¶ä½¿ç”¨INSTALL PLUGINè¯­å¥åŠ è½½æ’ä»¶æ¥æ›¿ä»£è¯¥ å·¥å…·ã€‚</span><br><span class="line"></span><br><span class="line">## 2. æ–°ç‰¹æ€§1ï¼šçª—å£å‡½æ•°</span><br><span class="line"></span><br><span class="line">### 1) ä½¿ç”¨çª—å£å‡½æ•°å‰åå¯¹æ¯”</span><br><span class="line"></span><br><span class="line">å‡è®¾æˆ‘ç°åœ¨æœ‰è¿™æ ·ä¸€ä¸ªæ•°æ®è¡¨ï¼Œå®ƒæ˜¾ç¤ºäº†æŸè´­ç‰©ç½‘ç«™åœ¨æ¯ä¸ªåŸå¸‚æ¯ä¸ªåŒºçš„é”€å”®é¢ï¼š</span><br><span class="line"></span><br><span class="line">```mysql</span><br><span class="line">CREATE TABLE sales(</span><br><span class="line">id INT PRIMARY KEY AUTO_INCREMENT,</span><br><span class="line">city VARCHAR(15),</span><br><span class="line">county VARCHAR(15),</span><br><span class="line">sales_value DECIMAL</span><br><span class="line">);</span><br><span class="line">INSERT INTO sales(city,county,sales_value)</span><br><span class="line">VALUES</span><br><span class="line">(&#x27;åŒ—äº¬&#x27;,&#x27;æµ·æ·€&#x27;,10.00),</span><br><span class="line">(&#x27;åŒ—äº¬&#x27;,&#x27;æœé˜³&#x27;,20.00),</span><br><span class="line">(&#x27;ä¸Šæµ·&#x27;,&#x27;é»„åŸ”&#x27;,30.00),</span><br><span class="line">(&#x27;ä¸Šæµ·&#x27;,&#x27;é•¿å®&#x27;,10.00);</span><br></pre></td></tr></table></figure></li></ol><p>æŸ¥è¯¢ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT * FROM sales;</span><br><span class="line">+----+------+--------+-------------+</span><br><span class="line">| id | city | county | sales_value |</span><br><span class="line">+----+------+--------+-------------+</span><br><span class="line">| 1  | åŒ—äº¬  |  æµ·æ·€   |      10    |</span><br><span class="line">| 2  | åŒ—äº¬  |  æœé˜³   |      20    |</span><br><span class="line">| 3  | ä¸Šæµ·  |  é»„åŸ”   |      30    |</span><br><span class="line">| 4  | ä¸Šæµ·  |  é•¿å®   |      10    |</span><br><span class="line">+----+------+--------+-------------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><p>éœ€æ±‚ï¼šç°åœ¨è®¡ç®—è¿™ä¸ªç½‘ç«™åœ¨æ¯ä¸ªåŸå¸‚çš„é”€å”®æ€»é¢ã€åœ¨å…¨å›½çš„é”€å”®æ€»é¢ã€æ¯ä¸ªåŒºçš„é”€å”®é¢å æ‰€åœ¨åŸå¸‚é”€å”®é¢ä¸­çš„æ¯”ç‡ï¼Œä»¥åŠå æ€»é”€å”®é¢ä¸­çš„æ¯”ç‡ã€‚</p><p>å¦‚æœç”¨åˆ†ç»„å’Œèšåˆå‡½æ•°ï¼Œå°±éœ€è¦åˆ†å¥½å‡ æ­¥æ¥è®¡ç®—ã€‚</p><p>ç¬¬ä¸€æ­¥ï¼Œè®¡ç®—æ€»é”€å”®é‡‘é¢ï¼Œå¹¶å­˜å…¥ä¸´æ—¶è¡¨ aï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CREATE TEMPORARY TABLE a -- åˆ›å»ºä¸´æ—¶è¡¨</span><br><span class="line">SELECT SUM(sales_value) AS sales_value -- è®¡ç®—æ€»è®¡é‡‘é¢</span><br><span class="line">FROM sales;</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹ä¸€ä¸‹ä¸´æ—¶è¡¨ a ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT * FROM a;</span><br><span class="line">+-------------+</span><br><span class="line">| sales_value |</span><br><span class="line">+-------------+</span><br><span class="line">| 70 |</span><br><span class="line">+-------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure><p>ç¬¬äºŒæ­¥ï¼Œè®¡ç®—æ¯ä¸ªåŸå¸‚çš„é”€å”®æ€»é¢å¹¶å­˜å…¥ä¸´æ—¶è¡¨ bï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CREATE TEMPORARY TABLE b -- åˆ›å»ºä¸´æ—¶è¡¨</span><br><span class="line">SELECT city, SUM(sales_value) AS sales_value -- è®¡ç®—åŸå¸‚é”€å”®åˆè®¡</span><br><span class="line">FROM sales</span><br><span class="line">GROUP BY city;</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹ä¸´æ—¶è¡¨ b ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT * FROM b;</span><br><span class="line">+------+-------------+</span><br><span class="line">| city | sales_value |</span><br><span class="line">+------+-------------+</span><br><span class="line">| åŒ—äº¬  |     30      |</span><br><span class="line">| ä¸Šæµ·  |     40      |</span><br><span class="line">+------+-------------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸‰æ­¥ï¼Œè®¡ç®—å„åŒºçš„é”€å”®å æ‰€åœ¨åŸå¸‚çš„æ€»è®¡é‡‘é¢çš„æ¯”ä¾‹ï¼Œå’Œå å…¨éƒ¨é”€å”®æ€»è®¡é‡‘é¢çš„æ¯”ä¾‹ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸‹é¢çš„è¿æ¥æŸ¥è¯¢è·å¾—éœ€è¦çš„ç»“æœï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT s.city AS åŸå¸‚,s.county AS åŒº,s.sales_value AS åŒºé”€å”®é¢,</span><br><span class="line">-&gt; b.sales_value AS å¸‚é”€å”®é¢,s.sales_value/b.sales_value AS å¸‚æ¯”ç‡,</span><br><span class="line">-&gt; a.sales_value AS æ€»é”€å”®é¢,s.sales_value/a.sales_value AS æ€»æ¯”ç‡</span><br><span class="line">-&gt; FROM sales s</span><br><span class="line">-&gt; JOIN b ON (s.city=b.city) -- è¿æ¥å¸‚ç»Ÿè®¡ç»“æœä¸´æ—¶è¡¨</span><br><span class="line">-&gt; JOIN a -- è¿æ¥æ€»è®¡é‡‘é¢ä¸´æ—¶è¡¨</span><br><span class="line">-&gt; ORDER BY s.city,s.county;</span><br><span class="line">+------+------+----------+----------+--------+----------+--------+</span><br><span class="line">| åŸå¸‚ | åŒº | åŒºé”€å”®é¢ | å¸‚é”€å”®é¢ | å¸‚æ¯”ç‡ | æ€»é”€å”®é¢ | æ€»æ¯”ç‡ |</span><br><span class="line">+------+------+----------+----------+--------+----------+--------+</span><br><span class="line">| ä¸Šæµ· | é•¿å® | 10 | 40 | 0.2500 | 70 | 0.1429 |</span><br><span class="line">| ä¸Šæµ· | é»„åŸ” | 30 | 40 | 0.7500 | 70 | 0.4286 |</span><br><span class="line">| åŒ—äº¬ | æœé˜³ | 20 | 30 | 0.6667 | 70 | 0.2857 |</span><br><span class="line">| åŒ—äº¬ | æµ·æ·€ | 10 | 30 | 0.3333 | 70 | 0.1429 |</span><br><span class="line">+------+------+----------+----------+--------+----------+--------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><p>ç»“æœæ˜¾ç¤ºï¼šå¸‚é”€å”®é‡‘é¢ã€å¸‚é”€å”®å æ¯”ã€æ€»é”€å”®é‡‘é¢ã€æ€»é”€å”®å æ¯”éƒ½è®¡ç®—å‡ºæ¥äº†ã€‚</p><p>åŒæ ·çš„æŸ¥è¯¢ï¼Œå¦‚æœç”¨çª—å£å‡½æ•°ï¼Œå°±ç®€å•å¤šäº†ã€‚æˆ‘ä»¬å¯ä»¥ç”¨ä¸‹é¢çš„ä»£ç æ¥å®ç°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT city AS åŸå¸‚,county AS åŒº,sales_value AS åŒºé”€å”®é¢,</span><br><span class="line">-&gt; SUM(sales_value) OVER(PARTITION BY city) AS å¸‚é”€å”®é¢, -- è®¡ç®—å¸‚é”€å”®é¢</span><br><span class="line">-&gt; sales_value/SUM(sales_value) OVER(PARTITION BY city) AS å¸‚æ¯”ç‡,</span><br><span class="line">-&gt; SUM(sales_value) OVER() AS æ€»é”€å”®é¢, -- è®¡ç®—æ€»é”€å”®é¢</span><br><span class="line">-&gt; sales_value/SUM(sales_value) OVER() AS æ€»æ¯”ç‡</span><br><span class="line">-&gt; FROM sales</span><br><span class="line">-&gt; ORDER BY city,county;</span><br><span class="line">+------+------+----------+----------+--------+----------+--------+</span><br><span class="line">| åŸå¸‚ | åŒº | åŒºé”€å”®é¢ | å¸‚é”€å”®é¢ | å¸‚æ¯”ç‡ | æ€»é”€å”®é¢ | æ€»æ¯”ç‡ |</span><br><span class="line">+------+------+----------+----------+--------+----------+--------+</span><br><span class="line">| ä¸Šæµ· | é•¿å® | 10 | 40 | 0.2500 | 70 | 0.1429 |</span><br><span class="line">| ä¸Šæµ· | é»„åŸ” | 30 | 40 | 0.7500 | 70 | 0.4286 |</span><br><span class="line">| åŒ—äº¬ | æœé˜³ | 20 | 30 | 0.6667 | 70 | 0.2857 |</span><br><span class="line">| åŒ—äº¬ | æµ·æ·€ | 10 | 30 | 0.3333 | 70 | 0.1429 |</span><br><span class="line">+------+------+----------+-----------+--------+----------+--------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><p>ç»“æœæ˜¾ç¤ºï¼Œæˆ‘ä»¬å¾—åˆ°äº†ä¸ä¸Šé¢é‚£ç§æŸ¥è¯¢åŒæ ·çš„ç»“æœã€‚ </p><p>ä½¿ç”¨çª—å£å‡½æ•°ï¼Œåªç”¨äº†ä¸€æ­¥å°±å®Œæˆäº†æŸ¥è¯¢ã€‚è€Œä¸”ï¼Œç”±äºæ²¡æœ‰ç”¨åˆ°ä¸´æ—¶è¡¨ï¼Œæ‰§è¡Œçš„æ•ˆç‡ä¹Ÿæ›´é«˜äº†ã€‚å¾ˆæ˜¾ ç„¶ï¼Œåœ¨è¿™ç§éœ€è¦ç”¨åˆ°åˆ†ç»„ç»Ÿè®¡çš„ç»“æœå¯¹æ¯ä¸€æ¡è®°å½•è¿›è¡Œè®¡ç®—çš„åœºæ™¯ä¸‹ï¼Œä½¿ç”¨çª—å£å‡½æ•°æ›´å¥½ã€‚</p><h3 id="2-çª—å£å‡½æ•°åˆ†ç±»"><a href="#2-çª—å£å‡½æ•°åˆ†ç±»" class="headerlink" title="2) çª—å£å‡½æ•°åˆ†ç±»"></a>2) çª—å£å‡½æ•°åˆ†ç±»</h3><p>MySQLä»8.0ç‰ˆæœ¬å¼€å§‹æ”¯æŒçª—å£å‡½æ•°ã€‚çª—å£å‡½æ•°çš„ä½œç”¨ç±»ä¼¼äºåœ¨æŸ¥è¯¢ä¸­å¯¹æ•°æ®è¿›è¡Œåˆ†ç»„ï¼Œä¸åŒçš„æ˜¯ï¼Œåˆ†ç»„æ“ä½œä¼šæŠŠåˆ†ç»„çš„ç»“æœèšåˆæˆä¸€æ¡è®°å½•ï¼Œè€Œçª—å£å‡½æ•°æ˜¯å°†ç»“æœç½®äºæ¯ä¸€æ¡æ•°æ®è®°å½•ä¸­ã€‚</p><p>çª—å£å‡½æ•°å¯ä»¥åˆ†ä¸º é™æ€çª—å£å‡½æ•° å’Œ åŠ¨æ€çª—å£å‡½æ•° ã€‚</p><ul><li>é™æ€çª—å£å‡½æ•°çš„çª—å£å¤§å°æ˜¯å›ºå®šçš„ï¼Œä¸ä¼šå› ä¸ºè®°å½•çš„ä¸åŒè€Œä¸åŒï¼›</li><li>åŠ¨æ€çª—å£å‡½æ•°çš„çª—å£å¤§å°ä¼šéšç€è®°å½•çš„ä¸åŒè€Œå˜åŒ–ã€‚</li></ul><p>MySQLå®˜æ–¹ç½‘ç«™çª—å£å‡½æ•°çš„ç½‘å€ä¸º<a href="https://dev.mysql.com/doc/refman/8.0/en/window-function-descriptio">https://dev.mysql.com/doc/refman/8.0/en/window-function-descriptio</a> ns.html#function_row-numberã€‚ </p><p>çª—å£å‡½æ•°æ€»ä½“ä¸Šå¯ä»¥åˆ†ä¸ºåºå·å‡½æ•°ã€åˆ†å¸ƒå‡½æ•°ã€å‰åå‡½æ•°ã€é¦–å°¾å‡½æ•°å’Œå…¶ä»–å‡½æ•°ï¼Œå¦‚ä¸‹è¡¨ï¼š</p><p><img src="/MySQL%E5%9F%BA%E7%A1%80%E7%AF%87.assets/image-20220613210116486.png" alt="image-20220613210116486"></p><h3 id="3-è¯­æ³•ç»“æ„"><a href="#3-è¯­æ³•ç»“æ„" class="headerlink" title="3) è¯­æ³•ç»“æ„"></a>3) è¯­æ³•ç»“æ„</h3><p>çª—å£å‡½æ•°çš„è¯­æ³•ç»“æ„æ˜¯ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">å‡½æ•° OVERï¼ˆ[PARTITION BY å­—æ®µå ORDER BY å­—æ®µå ASC|DESC]ï¼‰</span><br></pre></td></tr></table></figure><p>æˆ–è€…æ˜¯ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">å‡½æ•° OVER çª—å£å â€¦ WINDOW çª—å£å AS ï¼ˆ[PARTITION BY å­—æ®µå ORDER BY å­—æ®µå ASC|DESC]ï¼‰</span><br></pre></td></tr></table></figure><ul><li>OVER å…³é”®å­—æŒ‡å®šå‡½æ•°çª—å£çš„èŒƒå›´ã€‚<ul><li>å¦‚æœçœç•¥åé¢æ‹¬å·ä¸­çš„å†…å®¹ï¼Œåˆ™çª—å£ä¼šåŒ…å«æ»¡è¶³WHEREæ¡ä»¶çš„æ‰€æœ‰è®°å½•ï¼Œçª—å£å‡½æ•°ä¼šåŸºäºæ‰€æœ‰æ»¡è¶³WHEREæ¡ä»¶çš„è®°å½•è¿›è¡Œè®¡ç®—ã€‚</li><li>å¦‚æœOVERå…³é”®å­—åé¢çš„æ‹¬å·ä¸ä¸ºç©ºï¼Œåˆ™å¯ä»¥ä½¿ç”¨å¦‚ä¸‹è¯­æ³•è®¾ç½®çª—å£ã€‚</li></ul></li><li>çª—å£åï¼šä¸ºçª—å£è®¾ç½®ä¸€ä¸ªåˆ«åï¼Œç”¨æ¥æ ‡è¯†çª—å£ã€‚</li><li>PARTITION BYå­å¥ï¼šæŒ‡å®šçª—å£å‡½æ•°æŒ‰ç…§å“ªäº›å­—æ®µè¿›è¡Œåˆ†ç»„ã€‚åˆ†ç»„åï¼Œçª—å£å‡½æ•°å¯ä»¥åœ¨æ¯ä¸ªåˆ†ç»„ä¸­åˆ†åˆ«æ‰§è¡Œã€‚</li><li>ORDER BYå­å¥ï¼šæŒ‡å®šçª—å£å‡½æ•°æŒ‰ç…§å“ªäº›å­—æ®µè¿›è¡Œæ’åºã€‚æ‰§è¡Œæ’åºæ“ä½œä½¿çª—å£å‡½æ•°æŒ‰ç…§æ’åºåçš„æ•°æ®è®°å½•çš„é¡ºåºè¿›è¡Œç¼–å·ã€‚</li><li>FRAMEå­å¥ï¼šä¸ºåˆ†åŒºä¸­çš„æŸä¸ªå­é›†å®šä¹‰è§„åˆ™ï¼Œå¯ä»¥ç”¨æ¥ä½œä¸ºæ»‘åŠ¨çª—å£ä½¿ç”¨ã€‚</li></ul><h3 id="4-åˆ†ç±»è®²è§£"><a href="#4-åˆ†ç±»è®²è§£" class="headerlink" title="4) åˆ†ç±»è®²è§£"></a>4) åˆ†ç±»è®²è§£</h3><p>åˆ›å»ºè¡¨ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE goods(</span><br><span class="line">id INT PRIMARY KEY AUTO_INCREMENT,</span><br><span class="line">category_id INT,</span><br><span class="line">category VARCHAR(15),</span><br><span class="line">NAME VARCHAR(30),</span><br><span class="line">price DECIMAL(10,2),</span><br><span class="line">stock INT,</span><br><span class="line">upper_time DATETIME</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>æ·»åŠ æ•°æ®ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO goods(category_id,category,NAME,price,stock,upper_time)</span><br><span class="line">VALUES</span><br><span class="line">(1, &#x27;å¥³è£…/å¥³å£«ç²¾å“&#x27;, &#x27;Tæ¤&#x27;, 39.90, 1000, &#x27;2020-11-10 00:00:00&#x27;),</span><br><span class="line">(1, &#x27;å¥³è£…/å¥³å£«ç²¾å“&#x27;, &#x27;è¿è¡£è£™&#x27;, 79.90, 2500, &#x27;2020-11-10 00:00:00&#x27;),</span><br><span class="line">(1, &#x27;å¥³è£…/å¥³å£«ç²¾å“&#x27;, &#x27;å«è¡£&#x27;, 89.90, 1500, &#x27;2020-11-10 00:00:00&#x27;),</span><br><span class="line">(1, &#x27;å¥³è£…/å¥³å£«ç²¾å“&#x27;, &#x27;ç‰›ä»”è£¤&#x27;, 89.90, 3500, &#x27;2020-11-10 00:00:00&#x27;),</span><br><span class="line">(1, &#x27;å¥³è£…/å¥³å£«ç²¾å“&#x27;, &#x27;ç™¾è¤¶è£™&#x27;, 29.90, 500, &#x27;2020-11-10 00:00:00&#x27;),</span><br><span class="line">(1, &#x27;å¥³è£…/å¥³å£«ç²¾å“&#x27;, &#x27;å‘¢ç»’å¤–å¥—&#x27;, 399.90, 1200, &#x27;2020-11-10 00:00:00&#x27;),</span><br><span class="line">(2, &#x27;æˆ·å¤–è¿åŠ¨&#x27;, &#x27;è‡ªè¡Œè½¦&#x27;, 399.90, 1000, &#x27;2020-11-10 00:00:00&#x27;),</span><br><span class="line">(2, &#x27;æˆ·å¤–è¿åŠ¨&#x27;, &#x27;å±±åœ°è‡ªè¡Œè½¦&#x27;, 1399.90, 2500, &#x27;2020-11-10 00:00:00&#x27;),</span><br><span class="line">(2, &#x27;æˆ·å¤–è¿åŠ¨&#x27;, &#x27;ç™»å±±æ–&#x27;, 59.90, 1500, &#x27;2020-11-10 00:00:00&#x27;),</span><br><span class="line">(2, &#x27;æˆ·å¤–è¿åŠ¨&#x27;, &#x27;éª‘è¡Œè£…å¤‡&#x27;, 399.90, 3500, &#x27;2020-11-10 00:00:00&#x27;),</span><br><span class="line">(2, &#x27;æˆ·å¤–è¿åŠ¨&#x27;, &#x27;è¿åŠ¨å¤–å¥—&#x27;, 799.90, 500, &#x27;2020-11-10 00:00:00&#x27;),</span><br><span class="line">(2, &#x27;æˆ·å¤–è¿åŠ¨&#x27;, &#x27;æ»‘æ¿&#x27;, 499.90, 1200, &#x27;2020-11-10 00:00:00&#x27;);</span><br></pre></td></tr></table></figure><p>ä¸‹é¢é’ˆå¯¹goodsè¡¨ä¸­çš„æ•°æ®æ¥éªŒè¯æ¯ä¸ªçª—å£å‡½æ•°çš„åŠŸèƒ½ã€‚</p><h4 id="1-åºå·å‡½æ•°"><a href="#1-åºå·å‡½æ•°" class="headerlink" title="1) åºå·å‡½æ•°"></a>1) åºå·å‡½æ•°</h4><p><strong>1. ROW_NUMBER()å‡½æ•°</strong></p><p>ROW_NUMBER()å‡½æ•°èƒ½å¤Ÿå¯¹æ•°æ®ä¸­çš„åºå·è¿›è¡Œé¡ºåºæ˜¾ç¤ºã€‚</p><p>ä¸¾ä¾‹ï¼šæŸ¥è¯¢ goods æ•°æ®è¡¨ä¸­æ¯ä¸ªå•†å“åˆ†ç±»ä¸‹ä»·æ ¼é™åºæ’åˆ—çš„å„ä¸ªå•†å“ä¿¡æ¯ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT ROW_NUMBER() OVER(PARTITION BY category_id ORDER BY price DESC) AS</span><br><span class="line">row_num, id, category_id, category, NAME, price, stock</span><br><span class="line">FROM goods;</span><br><span class="line">+---------+----+-------------+---------------+------------+---------+-------+</span><br><span class="line">| row_num | id | category_id |    category   |     NAME   |  price  | stock |</span><br><span class="line">+---------+----+-------------+---------------+------------+---------+-------+</span><br><span class="line">|    1    |  6 |     1       |  å¥³è£…/å¥³å£«ç²¾å“  | å‘¢ç»’å¤–å¥—     | 399.90  | 1200  |</span><br><span class="line">|    2    |  3 |     1       |  å¥³è£…/å¥³å£«ç²¾å“  | å«è¡£        | 89.90   | 1500  |</span><br><span class="line">|    3    |  4 |     1       |  å¥³è£…/å¥³å£«ç²¾å“  | ç‰›ä»”è£¤       | 89.90   | 3500  |</span><br><span class="line">|    4    |  2 |     1       |  å¥³è£…/å¥³å£«ç²¾å“  | è¿è¡£è£™       | 79.90   | 2500  |</span><br><span class="line">|    5    |  1 |     1       |  å¥³è£…/å¥³å£«ç²¾å“  | Tæ¤         | 39.90   | 1000  |</span><br><span class="line">|    6    |  5 |     1       |  å¥³è£…/å¥³å£«ç²¾å“  | ç™¾è¤¶è£™       | 29.90   | 500   |</span><br><span class="line">|    1    |  8 |     2       |     æˆ·å¤–è¿åŠ¨   | å±±åœ°è‡ªè¡Œè½¦    | 1399.90 | 2500  |</span><br><span class="line">|    2    | 11 |     2       |     æˆ·å¤–è¿åŠ¨   | è¿åŠ¨å¤–å¥—      | 799.90  | 500  |</span><br><span class="line">|    3    | 12 |     2       |     æˆ·å¤–è¿åŠ¨   | æ»‘æ¿         | 499.90  | 1200  |</span><br><span class="line">|    4    |  7 |     2       |     æˆ·å¤–è¿åŠ¨   | è‡ªè¡Œè½¦       | 399.90  | 1000  |</span><br><span class="line">|    5    | 10 |     2       |     æˆ·å¤–è¿åŠ¨   | éª‘è¡Œè£…å¤‡     | 399.90  | 3500  |</span><br><span class="line">|    6    |  9 |     2       |     æˆ·å¤–è¿åŠ¨   | ç™»å±±æ–       | 59.90   | 1500  |</span><br><span class="line">+---------+----+-------------+---------------+------------+---------+-------+</span><br><span class="line">12 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><p>ä¸¾ä¾‹ï¼šæŸ¥è¯¢ goods æ•°æ®è¡¨ä¸­æ¯ä¸ªå•†å“åˆ†ç±»ä¸‹ä»·æ ¼æœ€é«˜çš„3ç§å•†å“ä¿¡æ¯ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT *</span><br><span class="line">-&gt; FROM (</span><br><span class="line">-&gt; SELECT ROW_NUMBER() OVER(PARTITION BY category_id ORDER BY price DESC) AS</span><br><span class="line">row_num,</span><br><span class="line">-&gt; id, category_id, category, NAME, price, stock</span><br><span class="line">-&gt; FROM goods) t</span><br><span class="line">-&gt; WHERE row_num &lt;= 3;</span><br><span class="line">+---------+----+-------------+---------------+------------+---------+-------+</span><br><span class="line">| row_num | id | category_id |     category  |      NAME  |  price  | stock |</span><br><span class="line">+---------+----+-------------+---------------+------------+---------+-------+</span><br><span class="line">|     1   |  6 |      1      | å¥³è£…/å¥³å£«ç²¾å“   | å‘¢ç»’å¤–å¥—     | 399.90  | 1200  |</span><br><span class="line">|     2   |  3 |      1      | å¥³è£…/å¥³å£«ç²¾å“   | å«è¡£        | 89.90   | 1500  |</span><br><span class="line">|     3   |  4 |      1      | å¥³è£…/å¥³å£«ç²¾å“   | ç‰›ä»”è£¤      | 89.90    | 3500 |</span><br><span class="line">|     1   |  8 |      2      | æˆ·å¤–è¿åŠ¨       | å±±åœ°è‡ªè¡Œè½¦   | 1399.90  | 2500 |</span><br><span class="line">|     2   | 11 |      2      | æˆ·å¤–è¿åŠ¨       | è¿åŠ¨å¤–å¥—     | 799.90  | 500   |</span><br><span class="line">|     3   | 12 |      2      | æˆ·å¤–è¿åŠ¨       | æ»‘æ¿        | 499.90   | 1200 |</span><br><span class="line">+---------+----+-------------+---------------+------------+----------+-------+</span><br><span class="line">6 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><p>åœ¨åç§°ä¸ºâ€œå¥³è£…&#x2F;å¥³å£«ç²¾å“â€çš„å•†å“ç±»åˆ«ä¸­ï¼Œæœ‰ä¸¤æ¬¾å•†å“çš„ä»·æ ¼ä¸º89.90å…ƒï¼Œåˆ†åˆ«æ˜¯å«è¡£å’Œç‰›ä»”è£¤ã€‚ä¸¤æ¬¾å•†å“ çš„åºå·éƒ½åº”è¯¥ä¸º2ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªä¸º2ï¼Œå¦ä¸€ä¸ªä¸º3ã€‚æ­¤æ—¶ï¼Œå¯ä»¥ä½¿ç”¨RANK()å‡½æ•°å’ŒDENSE_RANK()å‡½æ•°è§£ å†³ã€‚</p><p><strong>2ï¼RANK()å‡½æ•°</strong></p><p>ä½¿ç”¨RANK()å‡½æ•°èƒ½å¤Ÿå¯¹åºå·è¿›è¡Œå¹¶åˆ—æ’åºï¼Œå¹¶ä¸”ä¼šè·³è¿‡é‡å¤çš„åºå·ï¼Œæ¯”å¦‚åºå·ä¸º1ã€1ã€3ã€‚ </p><p>ä¸¾ä¾‹ï¼šä½¿ç”¨RANK()å‡½æ•°è·å– goods æ•°æ®è¡¨ä¸­å„ç±»åˆ«çš„ä»·æ ¼ä»é«˜åˆ°ä½æ’åºçš„å„å•†å“ä¿¡æ¯ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT RANK() OVER(PARTITION BY category_id ORDER BY price DESC) AS row_num,</span><br><span class="line">-&gt; id, category_id, category, NAME, price, stock</span><br><span class="line">-&gt; FROM goods;</span><br><span class="line">+---------+----+-------------+---------------+------------+---------+-------+</span><br><span class="line">| row_num | id | category_id | category      | NAME       | price   | stock |</span><br><span class="line">+---------+----+-------------+---------------+------------+---------+-------+</span><br><span class="line">|     1   | 6  |     1       | å¥³è£…/å¥³å£«ç²¾å“   | å‘¢ç»’å¤–å¥—     | 399.90  | 1200  |</span><br><span class="line">|     2   | 3  |     1       | å¥³è£…/å¥³å£«ç²¾å“   | å«è¡£        | 89.90   | 1500  |</span><br><span class="line">|     2   | 4  |     1       | å¥³è£…/å¥³å£«ç²¾å“   | ç‰›ä»”è£¤      | 89.90   | 3500   |</span><br><span class="line">|     4   | 2  |     1       | å¥³è£…/å¥³å£«ç²¾å“   | è¿è¡£è£™      | 79.90   | 2500   |</span><br><span class="line">|     5   | 1  |     1       | å¥³è£…/å¥³å£«ç²¾å“   | Tæ¤        | 39.90   | 1000   |</span><br><span class="line">|     6   | 5  |     1       | å¥³è£…/å¥³å£«ç²¾å“   | ç™¾è¤¶è£™      | 29.90   | 500    |</span><br><span class="line">|     1   | 8  |     2       | æˆ·å¤–è¿åŠ¨       | å±±åœ°è‡ªè¡Œè½¦   | 1399.90 | 2500   |</span><br><span class="line">|     2   | 11 |     2       | æˆ·å¤–è¿åŠ¨       | è¿åŠ¨å¤–å¥—     | 799.90  | 500   |</span><br><span class="line">|     3   | 12 |     2       | æˆ·å¤–è¿åŠ¨       | æ»‘æ¿        | 499.90  | 1200   |</span><br><span class="line">|     4   | 7  |     2       | æˆ·å¤–è¿åŠ¨       | è‡ªè¡Œè½¦      | 399.90   | 1000  |</span><br><span class="line">|     4   | 10 |     2       | æˆ·å¤–è¿åŠ¨       | éª‘è¡Œè£…å¤‡    | 399.90   | 3500  |</span><br><span class="line">|     6   | 9  |     2       | æˆ·å¤–è¿åŠ¨       | ç™»å±±æ–      | 59.90   | 1500   |</span><br><span class="line">+---------+----+-------------+---------------+------------+---------+-------+</span><br><span class="line">12 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><p><strong>3ï¼DENSE_RANK()å‡½æ•°</strong></p><p>DENSE_RANK()å‡½æ•°å¯¹åºå·è¿›è¡Œå¹¶åˆ—æ’åºï¼Œå¹¶ä¸”ä¸ä¼šè·³è¿‡é‡å¤çš„åºå·ï¼Œæ¯”å¦‚åºå·ä¸º1ã€1ã€2ã€‚ ä¸¾ä¾‹ï¼šä½¿ç”¨DENSE_RANK()å‡½æ•°è·å– goods æ•°æ®è¡¨ä¸­å„ç±»åˆ«çš„ä»·æ ¼ä»é«˜åˆ°ä½æ’åºçš„å„å•†å“ä¿¡æ¯ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT DENSE_RANK() OVER(PARTITION BY category_id ORDER BY price DESC) AS</span><br><span class="line">row_num,</span><br><span class="line">-&gt; id, category_id, category, NAME, price, stock</span><br><span class="line">-&gt; FROM goods;</span><br><span class="line">+---------+----+-------------+---------------+------------+---------+-------+</span><br><span class="line">| row_num | id | category_id | category      | NAME       | price   | stock |</span><br><span class="line">+---------+----+-------------+---------------+------------+---------+-------+</span><br><span class="line">|    1    | 6  |      1      | å¥³è£…/å¥³å£«ç²¾å“   |     å‘¢ç»’å¤–å¥— | 399.90 | 1200   |</span><br><span class="line">|    2    | 3  |      1      | å¥³è£…/å¥³å£«ç²¾å“   |     å«è¡£    | 89.90  | 1500   |</span><br><span class="line">|    2    | 4  |      1      | å¥³è£…/å¥³å£«ç²¾å“   |     ç‰›ä»”è£¤  | 89.90   | 3500  |</span><br><span class="line">|    3    | 2  |      1      | å¥³è£…/å¥³å£«ç²¾å“   |     è¿è¡£è£™  | 79.90   | 2500  |</span><br><span class="line">|    4    | 1  |      1      | å¥³è£…/å¥³å£«ç²¾å“   |     Tæ¤    | 39.90   | 1000  |</span><br><span class="line">|    5    | 5  |      1      | å¥³è£…/å¥³å£«ç²¾å“   |     ç™¾è¤¶è£™  | 29.90   | 500   |</span><br><span class="line">|    1    | 8  |      2      | æˆ·å¤–è¿åŠ¨       |    å±±åœ°è‡ªè¡Œè½¦| 1399.90 | 2500 |</span><br><span class="line">|    2    | 11 |      2      | æˆ·å¤–è¿åŠ¨       |    è¿åŠ¨å¤–å¥—  | 799.90 | 500    |</span><br><span class="line">|    3    | 12 |      2      | æˆ·å¤–è¿åŠ¨       |    æ»‘æ¿     | 499.90 | 1200   |</span><br><span class="line">|    4    | 7  |      2      | æˆ·å¤–è¿åŠ¨       |    è‡ªè¡Œè½¦    | 399.90 | 1000   |</span><br><span class="line">|    4    | 10 |      2      | æˆ·å¤–è¿åŠ¨       |    éª‘è¡Œè£…å¤‡  | 399.90 | 3500   |</span><br><span class="line">|    5    | 9  |      2      | æˆ·å¤–è¿åŠ¨       |    ç™»å±±æ–    | 59.90 | 1500   |</span><br><span class="line">+---------+----+-------------+---------------+------------+---------+-------+</span><br><span class="line">12 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><h4 id="2-åˆ†å¸ƒå‡½æ•°"><a href="#2-åˆ†å¸ƒå‡½æ•°" class="headerlink" title="2) åˆ†å¸ƒå‡½æ•°"></a>2) åˆ†å¸ƒå‡½æ•°</h4><p><strong>1ï¼PERCENT_RANK()å‡½æ•°</strong></p><p>PERCENT_RANK()å‡½æ•°æ˜¯ç­‰çº§å€¼ç™¾åˆ†æ¯”å‡½æ•°ã€‚æŒ‰ç…§å¦‚ä¸‹æ–¹å¼è¿›è¡Œè®¡ç®—ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(rank - 1) / (rows - 1)</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ï¼Œrankçš„å€¼ä¸ºä½¿ç”¨RANK()å‡½æ•°äº§ç”Ÿçš„åºå·ï¼Œrowsçš„å€¼ä¸ºå½“å‰çª—å£çš„æ€»è®°å½•æ•°ã€‚</p><p>ä¸¾ä¾‹ï¼šè®¡ç®— goods æ•°æ®è¡¨ä¸­åç§°ä¸ºâ€œå¥³è£…&#x2F;å¥³å£«ç²¾å“â€çš„ç±»åˆ«ä¸‹çš„å•†å“çš„PERCENT_RANKå€¼ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">#å†™æ³•ä¸€ï¼š</span><br><span class="line">SELECT RANK() OVER (PARTITION BY category_id ORDER BY price DESC) AS r,</span><br><span class="line">PERCENT_RANK() OVER (PARTITION BY category_id ORDER BY price DESC) AS pr,</span><br><span class="line">id, category_id, category, NAME, price, stock</span><br><span class="line">FROM goods</span><br><span class="line">WHERE category_id = 1;</span><br><span class="line">#å†™æ³•äºŒï¼š</span><br><span class="line">mysql&gt; SELECT RANK() OVER w AS r,</span><br><span class="line">-&gt; PERCENT_RANK() OVER w AS pr,</span><br><span class="line">-&gt; id, category_id, category, NAME, price, stock</span><br><span class="line">-&gt; FROM goods</span><br><span class="line">-&gt; WHERE category_id = 1 WINDOW w AS (PARTITION BY category_id ORDER BY price</span><br><span class="line">DESC);</span><br><span class="line">+---+-----+----+-------------+---------------+----------+--------+-------+</span><br><span class="line">| r | pr  | id | category_id | category      | NAME     | price  | stock |</span><br><span class="line">+---+-----+----+-------------+---------------+----------+--------+-------+</span><br><span class="line">| 1 | 0   | 6  |          1  | å¥³è£…/å¥³å£«ç²¾å“   |   å‘¢ç»’å¤–å¥— | 399.90 | 1200 |</span><br><span class="line">| 2 | 0.2 | 3  |          1  | å¥³è£…/å¥³å£«ç²¾å“   |   å«è¡£    | 89.90 | 1500 |</span><br><span class="line">| 2 | 0.2 | 4  |          1  | å¥³è£…/å¥³å£«ç²¾å“   |   ç‰›ä»”è£¤  | 89.90 | 3500 |</span><br><span class="line">| 4 | 0.6 | 2  |          1  | å¥³è£…/å¥³å£«ç²¾å“   |   è¿è¡£è£™  | 79.90 | 2500 |</span><br><span class="line">| 5 | 0.8 | 1  |          1  | å¥³è£…/å¥³å£«ç²¾å“   |   Tæ¤    | 39.90 | 1000 |</span><br><span class="line">| 6 | 1   | 5  |          1  | å¥³è£…/å¥³å£«ç²¾å“   |   ç™¾è¤¶è£™  | 29.90 | 500 |</span><br><span class="line">+---+-----+----+-------------+---------------+----------+--------+-------+</span><br><span class="line">6 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><p><strong>2ï¼CUME_DIST()å‡½æ•°</strong></p><p>CUME_DIST()å‡½æ•°ä¸»è¦ç”¨äºæŸ¥è¯¢å°äºæˆ–ç­‰äºæŸä¸ªå€¼çš„æ¯”ä¾‹ã€‚ </p><p>ä¸¾ä¾‹ï¼šæŸ¥è¯¢goodsæ•°æ®è¡¨ä¸­å°äºæˆ–ç­‰äºå½“å‰ä»·æ ¼çš„æ¯”ä¾‹ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT CUME_DIST() OVER(PARTITION BY category_id ORDER BY price ASC) AS cd,</span><br><span class="line">-&gt; id, category, NAME, price</span><br><span class="line">-&gt; FROM goods;</span><br><span class="line">+---------------------+----+---------------+------------+---------+</span><br><span class="line">|                cd   | id | category      | NAME       | price   |</span><br><span class="line">+---------------------+----+---------------+------------+---------+</span><br><span class="line">| 0.16666666666666666 | 5  | å¥³è£…/å¥³å£«ç²¾å“   | ç™¾è¤¶è£™      | 29.90 |</span><br><span class="line">| 0.3333333333333333  | 1  | å¥³è£…/å¥³å£«ç²¾å“   | Tæ¤        | 39.90 |</span><br><span class="line">| 0.5                 | 2  | å¥³è£…/å¥³å£«ç²¾å“   | è¿è¡£è£™      | 79.90 |</span><br><span class="line">| 0.8333333333333334  | 3  | å¥³è£…/å¥³å£«ç²¾å“   | å«è¡£       | 89.90 |</span><br><span class="line">| 0.8333333333333334  | 4  | å¥³è£…/å¥³å£«ç²¾å“   | ç‰›ä»”è£¤     | 89.90 |</span><br><span class="line">| 1                   | 6  | å¥³è£…/å¥³å£«ç²¾å“   | å‘¢ç»’å¤–å¥—    | 399.90 |</span><br><span class="line">| 0.16666666666666666 | 9  | æˆ·å¤–è¿åŠ¨       | ç™»å±±æ–      | 59.90 |</span><br><span class="line">| 0.5                 | 7  | æˆ·å¤–è¿åŠ¨       | è‡ªè¡Œè½¦      | 399.90 |</span><br><span class="line">| 0.5                 | 10 | æˆ·å¤–è¿åŠ¨       | éª‘è¡Œè£…å¤‡     | 399.90 |</span><br><span class="line">| 0.6666666666666666  | 12 | æˆ·å¤–è¿åŠ¨       | æ»‘æ¿        | 499.90 |</span><br><span class="line">| 0.8333333333333334  | 11 | æˆ·å¤–è¿åŠ¨       | è¿åŠ¨å¤–å¥—     | 799.90 |</span><br><span class="line">| 1                   | 8  | æˆ·å¤–è¿åŠ¨       | å±±åœ°è‡ªè¡Œè½¦   | 1399.90 |</span><br><span class="line">+---------------------+----+---------------+------------+---------+</span><br><span class="line">12 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><h4 id="3-å‰åå‡½æ•°"><a href="#3-å‰åå‡½æ•°" class="headerlink" title="3) å‰åå‡½æ•°"></a>3) å‰åå‡½æ•°</h4><p><strong>1ï¼LAG(expr,n)å‡½æ•°</strong></p><p>LAG(expr,n)å‡½æ•°è¿”å›å½“å‰è¡Œçš„å‰nè¡Œçš„exprçš„å€¼ã€‚ </p><p>ä¸¾ä¾‹ï¼šæŸ¥è¯¢goodsæ•°æ®è¡¨ä¸­å‰ä¸€ä¸ªå•†å“ä»·æ ¼ä¸å½“å‰å•†å“ä»·æ ¼çš„å·®å€¼ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT id, category, NAME, price, pre_price, price - pre_price AS diff_price</span><br><span class="line">-&gt; FROM (</span><br><span class="line">-&gt; SELECT id, category, NAME, price,LAG(price,1) OVER w AS pre_price</span><br><span class="line">-&gt; FROM goods</span><br><span class="line">-&gt; WINDOW w AS (PARTITION BY category_id ORDER BY price)) t;</span><br><span class="line">+----+---------------+------------+---------+-----------+------------+</span><br><span class="line">| id | category | NAME | price | pre_price | diff_price |</span><br><span class="line">+----+---------------+------------+---------+-----------+------------+</span><br><span class="line">| 5 | å¥³è£…/å¥³å£«ç²¾å“ | ç™¾è¤¶è£™ | 29.90 | NULL | NULL |</span><br><span class="line">| 1 | å¥³è£…/å¥³å£«ç²¾å“ | Tæ¤ | 39.90 | 29.90 | 10.00 |</span><br><span class="line">| 2 | å¥³è£…/å¥³å£«ç²¾å“ | è¿è¡£è£™ | 79.90 | 39.90 | 40.00 |</span><br><span class="line">| 3 | å¥³è£…/å¥³å£«ç²¾å“ | å«è¡£ | 89.90 | 79.90 | 10.00 |</span><br><span class="line">| 4 | å¥³è£…/å¥³å£«ç²¾å“ | ç‰›ä»”è£¤ | 89.90 | 89.90 | 0.00 |</span><br><span class="line">| 6 | å¥³è£…/å¥³å£«ç²¾å“ | å‘¢ç»’å¤–å¥— | 399.90 | 89.90 | 310.00 |</span><br><span class="line">| 9 | æˆ·å¤–è¿åŠ¨ | ç™»å±±æ– | 59.90 | NULL | NULL |</span><br><span class="line">| 7 | æˆ·å¤–è¿åŠ¨ | è‡ªè¡Œè½¦ | 399.90 | 59.90 | 340.00 |</span><br><span class="line">| 10 | æˆ·å¤–è¿åŠ¨ | éª‘è¡Œè£…å¤‡ | 399.90 | 399.90 | 0.00 |</span><br><span class="line">| 12 | æˆ·å¤–è¿åŠ¨ | æ»‘æ¿ | 499.90 | 399.90 | 100.00 |</span><br><span class="line">| 11 | æˆ·å¤–è¿åŠ¨ | è¿åŠ¨å¤–å¥— | 799.90 | 499.90 | 300.00 |</span><br><span class="line">| 8 | æˆ·å¤–è¿åŠ¨ | å±±åœ°è‡ªè¡Œè½¦ | 1399.90 | 799.90 | 600.00 |</span><br><span class="line">+----+---------------+------------+---------+-----------+------------+</span><br><span class="line">12 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><p><strong>2ï¼LEAD(expr,n)å‡½æ•°</strong></p><p>LEAD(expr,n)å‡½æ•°è¿”å›å½“å‰è¡Œçš„ånè¡Œçš„exprçš„å€¼ã€‚ </p><p>ä¸¾ä¾‹ï¼šæŸ¥è¯¢goodsæ•°æ®è¡¨ä¸­åä¸€ä¸ªå•†å“ä»·æ ¼ä¸å½“å‰å•†å“ä»·æ ¼çš„å·®å€¼ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT id, category, NAME, behind_price, price,behind_price - price AS</span><br><span class="line">diff_price</span><br><span class="line">-&gt; FROM(</span><br><span class="line">-&gt; SELECT id, category, NAME, price,LEAD(price, 1) OVER w AS behind_price</span><br><span class="line">-&gt; FROM goods WINDOW w AS (PARTITION BY category_id ORDER BY price)) t;</span><br><span class="line">+----+---------------+------------+--------------+---------+------------+</span><br><span class="line">| id | category      | NAME       | behind_price | price   | diff_price |</span><br><span class="line">+----+---------------+------------+--------------+---------+------------+</span><br><span class="line">| 5  | å¥³è£…/å¥³å£«ç²¾å“   | ç™¾è¤¶è£™       | 39.90       | 29.90 | 10.00 |</span><br><span class="line">| 1  | å¥³è£…/å¥³å£«ç²¾å“   | Tæ¤         | 79.90       | 39.90 | 40.00 |</span><br><span class="line">| 2  | å¥³è£…/å¥³å£«ç²¾å“   | è¿è¡£è£™      | 89.90        | 79.90 | 10.00 |</span><br><span class="line">| 3  | å¥³è£…/å¥³å£«ç²¾å“   | å«è¡£        | 89.90       | 89.90 | 0.00 |</span><br><span class="line">| 4  | å¥³è£…/å¥³å£«ç²¾å“   | ç‰›ä»”è£¤       | 399.90     | 89.90 | 310.00 |</span><br><span class="line">| 6  | å¥³è£…/å¥³å£«ç²¾å“   | å‘¢ç»’å¤–å¥—     | NULL       | 399.90 | NULL |</span><br><span class="line">| 9  | æˆ·å¤–è¿åŠ¨       | ç™»å±±æ–       | 399.90    | 59.90 | 340.00 |</span><br><span class="line">| 7  | æˆ·å¤–è¿åŠ¨       | è‡ªè¡Œè½¦       | 399.90    | 399.90 | 0.00 |</span><br><span class="line">| 10 | æˆ·å¤–è¿åŠ¨       | éª‘è¡Œè£…å¤‡     | 499.90     | 399.90 | 100.00 |</span><br><span class="line">| 12 | æˆ·å¤–è¿åŠ¨       | æ»‘æ¿         | 799.90    | 499.90 | 300.00 |</span><br><span class="line">| 11 | æˆ·å¤–è¿åŠ¨       | è¿åŠ¨å¤–å¥—     | 1399.90    | 799.90 | 600.00 |</span><br><span class="line">| 8  | æˆ·å¤–è¿åŠ¨       | å±±åœ°è‡ªè¡Œè½¦   | NULL       | 1399.90 | NULL |</span><br><span class="line">+----+---------------+------------+--------------+---------+------------+</span><br><span class="line">12 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><h4 id="4-é¦–å°¾å‡½æ•°"><a href="#4-é¦–å°¾å‡½æ•°" class="headerlink" title="4) é¦–å°¾å‡½æ•°"></a>4) é¦–å°¾å‡½æ•°</h4><p><strong>1ï¼FIRST_VALUE(expr)å‡½æ•°</strong></p><p>FIRST_VALUE(expr)å‡½æ•°è¿”å›ç¬¬ä¸€ä¸ªexprçš„å€¼ã€‚</p><p>ä¸¾ä¾‹ï¼šæŒ‰ç…§ä»·æ ¼æ’åºï¼ŒæŸ¥è¯¢ç¬¬1ä¸ªå•†å“çš„ä»·æ ¼ä¿¡æ¯ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT id, category, NAME, price, stock,FIRST_VALUE(price) OVER w AS</span><br><span class="line">first_price</span><br><span class="line">-&gt; FROM goods WINDOW w AS (PARTITION BY category_id ORDER BY price);</span><br><span class="line">+----+---------------+------------+---------+-------+-------------+</span><br><span class="line">| id | category      | NAME | price | stock | first_price |</span><br><span class="line">+----+---------------+------------+---------+-------+-------------+</span><br><span class="line">| 5  | å¥³è£…/å¥³å£«ç²¾å“   | ç™¾è¤¶è£™ | 29.90 | 500 | 29.90 |</span><br><span class="line">| 1  | å¥³è£…/å¥³å£«ç²¾å“   | Tæ¤ | 39.90 | 1000 | 29.90 |</span><br><span class="line">| 2  | å¥³è£…/å¥³å£«ç²¾å“   | è¿è¡£è£™ | 79.90 | 2500 | 29.90 |</span><br><span class="line">| 3  | å¥³è£…/å¥³å£«ç²¾å“   | å«è¡£ | 89.90 | 1500 | 29.90 |</span><br><span class="line">| 4  | å¥³è£…/å¥³å£«ç²¾å“   | ç‰›ä»”è£¤ | 89.90 | 3500 | 29.90 |</span><br><span class="line">| 6  | å¥³è£…/å¥³å£«ç²¾å“   | å‘¢ç»’å¤–å¥— | 399.90 | 1200 | 29.90 |</span><br><span class="line">| 9  | æˆ·å¤–è¿åŠ¨       | ç™»å±±æ– | 59.90 | 1500 | 59.90 |</span><br><span class="line">| 7  | æˆ·å¤–è¿åŠ¨       | è‡ªè¡Œè½¦ | 399.90 | 1000 | 59.90 |</span><br><span class="line">| 10 | æˆ·å¤–è¿åŠ¨       | éª‘è¡Œè£…å¤‡ | 399.90 | 3500 | 59.90 |</span><br><span class="line">| 12 | æˆ·å¤–è¿åŠ¨       | æ»‘æ¿ | 499.90 | 1200 | 59.90 |</span><br><span class="line">| 11 | æˆ·å¤–è¿åŠ¨       | è¿åŠ¨å¤–å¥— | 799.90 | 500 | 59.90 |</span><br><span class="line">| 8  | æˆ·å¤–è¿åŠ¨       | å±±åœ°è‡ªè¡Œè½¦ | 1399.90 | 2500 | 59.90 |</span><br><span class="line">+----+---------------+------------+---------+-------+-------------+</span><br><span class="line">12 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><p><strong>LAST_VALUE(expr)å‡½æ•°</strong></p><p>LAST_VALUE(expr)å‡½æ•°è¿”å›æœ€åä¸€ä¸ªexprçš„å€¼ã€‚ </p><p>ä¸¾ä¾‹ï¼šæŒ‰ç…§ä»·æ ¼æ’åºï¼ŒæŸ¥è¯¢æœ€åä¸€ä¸ªå•†å“çš„ä»·æ ¼ä¿¡æ¯ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT id, category, NAME, price, stock,LAST_VALUE(price) OVER w AS last_price</span><br><span class="line">-&gt; FROM goods WINDOW w AS (PARTITION BY category_id ORDER BY price);</span><br><span class="line">+----+---------------+------------+---------+-------+------------+</span><br><span class="line">| id | category      | NAME | price | stock | last_price |</span><br><span class="line">+----+---------------+------------+---------+-------+------------+</span><br><span class="line">| 5  | å¥³è£…/å¥³å£«ç²¾å“   | ç™¾è¤¶è£™ | 29.90 | 500 | 29.90 |</span><br><span class="line">| 1  | å¥³è£…/å¥³å£«ç²¾å“   | Tæ¤ | 39.90 | 1000 | 39.90 |</span><br><span class="line">| 2  | å¥³è£…/å¥³å£«ç²¾å“   | è¿è¡£è£™ | 79.90 | 2500 | 79.90 |</span><br><span class="line">| 3  | å¥³è£…/å¥³å£«ç²¾å“   | å«è¡£ | 89.90 | 1500 | 89.90 |</span><br><span class="line">| 4  | å¥³è£…/å¥³å£«ç²¾å“   | ç‰›ä»”è£¤ | 89.90 | 3500 | 89.90 |</span><br><span class="line">| 6  | å¥³è£…/å¥³å£«ç²¾å“   | å‘¢ç»’å¤–å¥— | 399.90 | 1200 | 399.90 |</span><br><span class="line">| 9  | æˆ·å¤–è¿åŠ¨       | ç™»å±±æ– | 59.90 | 1500 | 59.90 |</span><br><span class="line">| 7  | æˆ·å¤–è¿åŠ¨       | è‡ªè¡Œè½¦ | 399.90 | 1000 | 399.90 |</span><br><span class="line">| 10 | æˆ·å¤–è¿åŠ¨       | éª‘è¡Œè£…å¤‡ | 399.90 | 3500 | 399.90 |</span><br><span class="line">| 12 | æˆ·å¤–è¿åŠ¨       | æ»‘æ¿ | 499.90 | 1200 | 499.90 |</span><br><span class="line">| 11 | æˆ·å¤–è¿åŠ¨       | è¿åŠ¨å¤–å¥— | 799.90 | 500 | 799.90 |</span><br><span class="line">| 8  | æˆ·å¤–è¿åŠ¨       | å±±åœ°è‡ªè¡Œè½¦ | 1399.90 | 2500 | 1399.90 |</span><br><span class="line">+----+---------------+------------+---------+-------+------------+</span><br><span class="line">12 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><h4 id="5-å…¶ä»–å‡½æ•°"><a href="#5-å…¶ä»–å‡½æ•°" class="headerlink" title="5) å…¶ä»–å‡½æ•°"></a>5) å…¶ä»–å‡½æ•°</h4><p><strong>1ï¼NTH_VALUE(expr,n)å‡½æ•°</strong></p><p>NTH_VALUE(expr,n)å‡½æ•°è¿”å›ç¬¬nä¸ªexprçš„å€¼ã€‚ ä¸¾ä¾‹ï¼šæŸ¥è¯¢goodsæ•°æ®è¡¨ä¸­æ’åç¬¬2å’Œç¬¬3çš„ä»·æ ¼ä¿¡æ¯ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT id, category, NAME, price,NTH_VALUE(price,2) OVER w AS second_price,</span><br><span class="line">-&gt; NTH_VALUE(price,3) OVER w AS third_price</span><br><span class="line">-&gt; FROM goods WINDOW w AS (PARTITION BY category_id ORDER BY price);</span><br><span class="line">+----+---------------+------------+---------+--------------+-------------+</span><br><span class="line">| id | category      | NAME       | price   | second_price | third_price |</span><br><span class="line">+----+---------------+------------+---------+--------------+-------------+</span><br><span class="line">| 5  | å¥³è£…/å¥³å£«ç²¾å“   | ç™¾è¤¶è£™ | 29.90 | NULL | NULL |</span><br><span class="line">| 1  | å¥³è£…/å¥³å£«ç²¾å“   | Tæ¤ | 39.90 | 39.90 | NULL |</span><br><span class="line">| 2  | å¥³è£…/å¥³å£«ç²¾å“   | è¿è¡£è£™ | 79.90 | 39.90 | 79.90 |</span><br><span class="line">| 3  | å¥³è£…/å¥³å£«ç²¾å“   | å«è¡£ | 89.90 | 39.90 | 79.90 |</span><br><span class="line">| 4  | å¥³è£…/å¥³å£«ç²¾å“   | ç‰›ä»”è£¤ | 89.90 | 39.90 | 79.90 |</span><br><span class="line">| 6  | å¥³è£…/å¥³å£«ç²¾å“   | å‘¢ç»’å¤–å¥— | 399.90 | 39.90 | 79.90 |</span><br><span class="line">| 9  | æˆ·å¤–è¿åŠ¨       | ç™»å±±æ– | 59.90 | NULL | NULL |</span><br><span class="line">| 7  | æˆ·å¤–è¿åŠ¨       | è‡ªè¡Œè½¦ | 399.90 | 399.90 | 399.90 |</span><br><span class="line">| 10 | æˆ·å¤–è¿åŠ¨       | éª‘è¡Œè£…å¤‡ | 399.90 | 399.90 | 399.90 |</span><br><span class="line">| 12 | æˆ·å¤–è¿åŠ¨       | æ»‘æ¿ | 499.90 | 399.90 | 399.90 |</span><br><span class="line">| 11 | æˆ·å¤–è¿åŠ¨       | è¿åŠ¨å¤–å¥— | 799.90 | 399.90 | 399.90 |</span><br><span class="line">| 8  | æˆ·å¤–è¿åŠ¨       | å±±åœ°è‡ªè¡Œè½¦ | 1399.90 | 399.90 | 399.90 |</span><br><span class="line">+----+---------------+------------+---------+--------------+-------------+</span><br><span class="line">12 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><p><strong>2ï¼NTILE(n)å‡½æ•°</strong></p><p>NTILE(n)å‡½æ•°å°†åˆ†åŒºä¸­çš„æœ‰åºæ•°æ®åˆ†ä¸ºnä¸ªæ¡¶ï¼Œè®°å½•æ¡¶ç¼–å·ã€‚ </p><p>ä¸¾ä¾‹ï¼šå°†goodsè¡¨ä¸­çš„å•†å“æŒ‰ç…§ä»·æ ¼åˆ†ä¸º3ç»„ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT NTILE(3) OVER w AS nt,id, category, NAME, price</span><br><span class="line">-&gt; FROM goods WINDOW w AS (PARTITION BY category_id ORDER BY price);</span><br><span class="line">+----+----+---------------+------------+---------+</span><br><span class="line">| nt | id | category      | NAME       | price |</span><br><span class="line">+----+----+---------------+------------+---------+</span><br><span class="line">| 1  | 5  | å¥³è£…/å¥³å£«ç²¾å“   | ç™¾è¤¶è£™ | 29.90 |</span><br><span class="line">| 1  | 1  | å¥³è£…/å¥³å£«ç²¾å“   | Tæ¤ | 39.90 |</span><br><span class="line">| 2  | 2  | å¥³è£…/å¥³å£«ç²¾å“   | è¿è¡£è£™ | 79.90 |</span><br><span class="line">| 2  | 3  | å¥³è£…/å¥³å£«ç²¾å“   | å«è¡£ | 89.90 |</span><br><span class="line">| 3  | 4  | å¥³è£…/å¥³å£«ç²¾å“   | ç‰›ä»”è£¤ | 89.90 |</span><br><span class="line">| 3  | 6  | å¥³è£…/å¥³å£«ç²¾å“   | å‘¢ç»’å¤–å¥— | 399.90 |</span><br><span class="line">| 1  | 9  | æˆ·å¤–è¿åŠ¨       | ç™»å±±æ– | 59.90 |</span><br><span class="line">| 1  | 7  | æˆ·å¤–è¿åŠ¨       | è‡ªè¡Œè½¦ | 399.90 |</span><br><span class="line">| 2  | 10 | æˆ·å¤–è¿åŠ¨       | éª‘è¡Œè£…å¤‡ | 399.90 |</span><br><span class="line">| 2  | 12 | æˆ·å¤–è¿åŠ¨       | æ»‘æ¿ | 499.90 |</span><br><span class="line">| 3  | 11 | æˆ·å¤–è¿åŠ¨       | è¿åŠ¨å¤–å¥— | 799.90 |</span><br><span class="line">| 3  | 8  | æˆ·å¤–è¿åŠ¨       | å±±åœ°è‡ªè¡Œè½¦ | 1399.90 |</span><br><span class="line">+----+----+---------------+------------+---------+</span><br><span class="line">12 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><h3 id="5-å°ç»“-1"><a href="#5-å°ç»“-1" class="headerlink" title="5) å°ç»“"></a>5) å°ç»“</h3><p>çª—å£å‡½æ•°çš„ç‰¹ç‚¹æ˜¯å¯ä»¥åˆ†ç»„ï¼Œè€Œä¸”å¯ä»¥åœ¨åˆ†ç»„å†…æ’åºã€‚å¦å¤–ï¼Œçª—å£å‡½æ•°ä¸ä¼šå› ä¸ºåˆ†ç»„è€Œå‡å°‘åŸè¡¨ä¸­çš„è¡Œ æ•°ï¼Œè¿™å¯¹æˆ‘ä»¬åœ¨åŸè¡¨æ•°æ®çš„åŸºç¡€ä¸Šè¿›è¡Œç»Ÿè®¡å’Œæ’åºéå¸¸æœ‰ç”¨ã€‚</p><h2 id="3-æ–°ç‰¹æ€§2ï¼šå…¬ç”¨è¡¨è¡¨è¾¾å¼"><a href="#3-æ–°ç‰¹æ€§2ï¼šå…¬ç”¨è¡¨è¡¨è¾¾å¼" class="headerlink" title="3. æ–°ç‰¹æ€§2ï¼šå…¬ç”¨è¡¨è¡¨è¾¾å¼"></a>3. æ–°ç‰¹æ€§2ï¼šå…¬ç”¨è¡¨è¡¨è¾¾å¼</h2><p>å…¬ç”¨è¡¨è¡¨è¾¾å¼ï¼ˆæˆ–é€šç”¨è¡¨è¡¨è¾¾å¼ï¼‰ç®€ç§°ä¸ºCTEï¼ˆCommon Table Expressionsï¼‰ã€‚CTEæ˜¯ä¸€ä¸ªå‘½åçš„ä¸´æ—¶ç»“ æœé›†ï¼Œä½œç”¨èŒƒå›´æ˜¯å½“å‰è¯­å¥ã€‚CTEå¯ä»¥ç†è§£æˆä¸€ä¸ªå¯ä»¥å¤ç”¨çš„å­æŸ¥è¯¢ï¼Œå½“ç„¶è·Ÿå­æŸ¥è¯¢è¿˜æ˜¯æœ‰ç‚¹åŒºåˆ«çš„ï¼Œ CTEå¯ä»¥å¼•ç”¨å…¶ä»–CTEï¼Œä½†å­æŸ¥è¯¢ä¸èƒ½å¼•ç”¨å…¶ä»–å­æŸ¥è¯¢ã€‚æ‰€ä»¥ï¼Œå¯ä»¥è€ƒè™‘ä»£æ›¿å­æŸ¥è¯¢ã€‚</p><p>ä¾æ®è¯­æ³•ç»“æ„å’Œæ‰§è¡Œæ–¹å¼çš„ä¸åŒï¼Œå…¬ç”¨è¡¨è¡¨è¾¾å¼åˆ†ä¸º æ™®é€šå…¬ç”¨è¡¨è¡¨è¾¾å¼ å’Œ é€’å½’å…¬ç”¨è¡¨è¡¨è¾¾å¼ 2 ç§ã€‚</p><h3 id="1-æ™®é€šå…¬ç”¨è¡¨è¡¨è¾¾å¼"><a href="#1-æ™®é€šå…¬ç”¨è¡¨è¡¨è¾¾å¼" class="headerlink" title="1) æ™®é€šå…¬ç”¨è¡¨è¡¨è¾¾å¼"></a>1) æ™®é€šå…¬ç”¨è¡¨è¡¨è¾¾å¼</h3><p>æ™®é€šå…¬ç”¨è¡¨è¡¨è¾¾å¼çš„è¯­æ³•ç»“æ„æ˜¯ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">WITH CTEåç§°</span><br><span class="line">AS ï¼ˆå­æŸ¥è¯¢ï¼‰</span><br><span class="line">SELECT|DELETE|UPDATE è¯­å¥;</span><br></pre></td></tr></table></figure><p>æ™®é€šå…¬ç”¨è¡¨è¡¨è¾¾å¼ç±»ä¼¼äºå­æŸ¥è¯¢ï¼Œä¸è¿‡ï¼Œè·Ÿå­æŸ¥è¯¢ä¸åŒçš„æ˜¯ï¼Œå®ƒå¯ä»¥è¢«å¤šæ¬¡å¼•ç”¨ï¼Œè€Œä¸”å¯ä»¥è¢«å…¶ä»–çš„æ™® é€šå…¬ç”¨è¡¨è¡¨è¾¾å¼æ‰€å¼•ç”¨ã€‚</p><p>ä¸¾ä¾‹ï¼šæŸ¥è¯¢å‘˜å·¥æ‰€åœ¨çš„éƒ¨é—¨çš„è¯¦ç»†ä¿¡æ¯ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT * FROM departments</span><br><span class="line">-&gt; WHERE department_id IN (</span><br><span class="line">-&gt; SELECT DISTINCT department_id</span><br><span class="line">-&gt; FROM employees</span><br><span class="line">-&gt; );</span><br><span class="line">+---------------+------------------+------------+-------------+</span><br><span class="line">| department_id | department_name  | manager_id | location_id |</span><br><span class="line">+---------------+------------------+------------+-------------+</span><br><span class="line">|     10        | Administration   | 200        | 1700        |</span><br><span class="line">|     20        | Marketing        | 201        | 1800        |</span><br><span class="line">|     30        | Purchasing       | 114        | 1700        |</span><br><span class="line">|     40        | Human Resources  | 203        | 2400        |</span><br><span class="line">|     50        | Shipping         | 121        | 1500        |</span><br><span class="line">|     60        | IT               | 103        | 1400        |</span><br><span class="line">|     70        | Public Relations | 204        | 2700        |</span><br><span class="line">|     80        | Sales            | 145        | 2500        |</span><br><span class="line">|     90        | Executive        | 100        | 1700        |</span><br><span class="line">|     100       | Finance          | 108        | 1700        |</span><br><span class="line">|     110       | Accounting       | 205        | 1700        |</span><br><span class="line">+---------------+------------------+------------+-------------+</span><br><span class="line">11 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæŸ¥è¯¢ä¹Ÿå¯ä»¥ç”¨æ™®é€šå…¬ç”¨è¡¨è¡¨è¾¾å¼çš„æ–¹å¼å®Œæˆï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; WITH emp_dept_id</span><br><span class="line">-&gt; AS (SELECT DISTINCT department_id FROM employees)</span><br><span class="line">-&gt; SELECT *</span><br><span class="line">-&gt; FROM departments d JOIN emp_dept_id e</span><br><span class="line">-&gt; ON d.department_id = e.department_id;</span><br><span class="line">+---------------+------------------+------------+-------------+---------------+</span><br><span class="line">| department_id | department_name  | manager_id | location_id | department_id |</span><br><span class="line">+---------------+------------------+------------+-------------+---------------+</span><br><span class="line">|      90       | Executive        | 100        | 1700        | 90            |</span><br><span class="line">|      60       | IT               | 103        | 1400        | 60            |</span><br><span class="line">|      100      | Finance          | 108        | 1700        | 100           |</span><br><span class="line">|      30       | Purchasing       | 114        | 1700        | 30            |</span><br><span class="line">|      50       | Shipping         | 121        | 1500        | 50            |</span><br><span class="line">|      80       | Sales            | 145        | 2500        | 80            |</span><br><span class="line">|      10       | Administration   | 200        | 1700        | 10            |</span><br><span class="line">|      20       | Marketing        | 201        | 1800        | 20            |</span><br><span class="line">|      40       | Human Resources  | 203        | 2400        | 40            |</span><br><span class="line">|      70       | Public Relations | 204        | 2700        | 70            |</span><br><span class="line">|      110      | Accounting       | 205        | 1700        | 110           |</span><br><span class="line">+---------------+------------------+------------+-------------+---------------+</span><br><span class="line">11 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><p>ä¾‹å­è¯´æ˜ï¼Œå…¬ç”¨è¡¨è¡¨è¾¾å¼å¯ä»¥èµ·åˆ°å­æŸ¥è¯¢çš„ä½œç”¨ã€‚ä»¥åå¦‚æœé‡åˆ°éœ€è¦ä½¿ç”¨å­æŸ¥è¯¢çš„åœºæ™¯ï¼Œä½ å¯ä»¥åœ¨æŸ¥è¯¢ ä¹‹å‰ï¼Œå…ˆå®šä¹‰å…¬ç”¨è¡¨è¡¨è¾¾å¼ï¼Œç„¶ååœ¨æŸ¥è¯¢ä¸­ç”¨å®ƒæ¥ä»£æ›¿å­æŸ¥è¯¢ã€‚è€Œä¸”ï¼Œè·Ÿå­æŸ¥è¯¢ç›¸æ¯”ï¼Œå…¬ç”¨è¡¨è¡¨è¾¾å¼æœ‰ ä¸€ä¸ªä¼˜ç‚¹ï¼Œå°±æ˜¯å®šä¹‰è¿‡å…¬ç”¨è¡¨è¡¨è¾¾å¼ä¹‹åçš„æŸ¥è¯¢ï¼Œå¯ä»¥åƒä¸€ä¸ªè¡¨ä¸€æ ·å¤šæ¬¡å¼•ç”¨å…¬ç”¨è¡¨è¡¨è¾¾å¼ï¼Œè€Œå­æŸ¥è¯¢ åˆ™ä¸èƒ½ã€‚</p><h3 id="2-é€’å½’å…¬ç”¨è¡¨è¡¨è¾¾å¼"><a href="#2-é€’å½’å…¬ç”¨è¡¨è¡¨è¾¾å¼" class="headerlink" title="2)  é€’å½’å…¬ç”¨è¡¨è¡¨è¾¾å¼"></a>2)  é€’å½’å…¬ç”¨è¡¨è¡¨è¾¾å¼</h3><p>é€’å½’å…¬ç”¨è¡¨è¡¨è¾¾å¼ä¹Ÿæ˜¯ä¸€ç§å…¬ç”¨è¡¨è¡¨è¾¾å¼ï¼Œåªä¸è¿‡ï¼Œé™¤äº†æ™®é€šå…¬ç”¨è¡¨è¡¨è¾¾å¼çš„ç‰¹ç‚¹ä»¥å¤–ï¼Œå®ƒè¿˜æœ‰è‡ªå·±çš„ç‰¹ç‚¹ï¼Œå°±æ˜¯å¯ä»¥è°ƒç”¨è‡ªå·±ã€‚å®ƒçš„è¯­æ³•ç»“æ„æ˜¯ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">WITH RECURSIVE</span><br><span class="line">CTEåç§° AS ï¼ˆå­æŸ¥è¯¢ï¼‰</span><br><span class="line">SELECT|DELETE|UPDATE è¯­å¥;</span><br></pre></td></tr></table></figure><p>é€’å½’å…¬ç”¨è¡¨è¡¨è¾¾å¼ç”± 2 éƒ¨åˆ†ç»„æˆï¼Œåˆ†åˆ«æ˜¯ç§å­æŸ¥è¯¢å’Œé€’å½’æŸ¥è¯¢ï¼Œä¸­é—´é€šè¿‡å…³é”®å­— UNION [ALL]è¿›è¡Œè¿æ¥ã€‚ è¿™é‡Œçš„ç§å­æŸ¥è¯¢ï¼Œæ„æ€å°±æ˜¯è·å¾—é€’å½’çš„åˆå§‹å€¼ã€‚è¿™ä¸ªæŸ¥è¯¢åªä¼šè¿è¡Œä¸€æ¬¡ï¼Œä»¥åˆ›å»ºåˆå§‹æ•°æ®é›†ï¼Œä¹‹åé€’å½’ æŸ¥è¯¢ä¼šä¸€ç›´æ‰§è¡Œï¼Œç›´åˆ°æ²¡æœ‰ä»»ä½•æ–°çš„æŸ¥è¯¢æ•°æ®äº§ç”Ÿï¼Œé€’å½’è¿”å›ã€‚</p><p>æ¡ˆä¾‹ï¼šé’ˆå¯¹äºæˆ‘ä»¬å¸¸ç”¨çš„employeesè¡¨ï¼ŒåŒ…å«employee_idï¼Œlast_nameå’Œmanager_idä¸‰ä¸ªå­—æ®µã€‚å¦‚æœaæ˜¯b çš„ç®¡ç†è€…ï¼Œé‚£ä¹ˆï¼Œæˆ‘ä»¬å¯ä»¥æŠŠbå«åšaçš„ä¸‹å±ï¼Œå¦‚æœåŒæ—¶båˆæ˜¯cçš„ç®¡ç†è€…ï¼Œé‚£ä¹ˆcå°±æ˜¯bçš„ä¸‹å±ï¼Œæ˜¯açš„ä¸‹ä¸‹ å±ã€‚</p><p>ä¸‹é¢æˆ‘ä»¬å°è¯•ç”¨æŸ¥è¯¢è¯­å¥åˆ—å‡ºæ‰€æœ‰å…·æœ‰ä¸‹ä¸‹å±èº«ä»½çš„äººå‘˜ä¿¡æ¯ã€‚</p><p>å¦‚æœç”¨æˆ‘ä»¬ä¹‹å‰å­¦è¿‡çš„çŸ¥è¯†æ¥è§£å†³ï¼Œä¼šæ¯”è¾ƒå¤æ‚ï¼Œè‡³å°‘è¦è¿›è¡Œ 4 æ¬¡æŸ¥è¯¢æ‰èƒ½æå®šï¼š</p><ul><li>ç¬¬ä¸€æ­¥ï¼Œå…ˆæ‰¾å‡ºåˆä»£ç®¡ç†è€…ï¼Œå°±æ˜¯ä¸ä»¥ä»»ä½•åˆ«äººä¸ºç®¡ç†è€…çš„äººï¼ŒæŠŠç»“æœå­˜å…¥ä¸´æ—¶è¡¨ï¼› </li><li>ç¬¬äºŒæ­¥ï¼Œæ‰¾å‡ºæ‰€æœ‰ä»¥åˆä»£ç®¡ç†è€…ä¸ºç®¡ç†è€…çš„äººï¼Œå¾—åˆ°ä¸€ä¸ªä¸‹å±é›†ï¼ŒæŠŠç»“æœå­˜å…¥ä¸´æ—¶è¡¨ï¼› </li><li>ç¬¬ä¸‰æ­¥ï¼Œæ‰¾å‡ºæ‰€æœ‰ä»¥ä¸‹å±ä¸ºç®¡ç†è€…çš„äººï¼Œå¾—åˆ°ä¸€ä¸ªä¸‹ä¸‹å±é›†ï¼ŒæŠŠç»“æœå­˜å…¥ä¸´æ—¶è¡¨ã€‚ </li><li>ç¬¬å››æ­¥ï¼Œæ‰¾å‡ºæ‰€æœ‰ä»¥ä¸‹ä¸‹å±ä¸ºç®¡ç†è€…çš„äººï¼Œå¾—åˆ°ä¸€ä¸ªç»“æœé›†ã€‚</li></ul><p>å¦‚æœç¬¬å››æ­¥çš„ç»“æœé›†ä¸ºç©ºï¼Œåˆ™è®¡ç®—ç»“æŸï¼Œç¬¬ä¸‰æ­¥çš„ç»“æœé›†å°±æ˜¯æˆ‘ä»¬éœ€è¦çš„ä¸‹ä¸‹å±é›†äº†ï¼Œå¦åˆ™å°±å¿…é¡»ç»§ç»­ è¿›è¡Œç¬¬å››æ­¥ï¼Œä¸€ç›´åˆ°ç»“æœé›†ä¸ºç©ºä¸ºæ­¢ã€‚æ¯”å¦‚ä¸Šé¢çš„è¿™ä¸ªæ•°æ®è¡¨ï¼Œå°±éœ€è¦åˆ°ç¬¬äº”æ­¥ï¼Œæ‰èƒ½å¾—åˆ°ç©ºç»“æœé›†ã€‚ è€Œä¸”ï¼Œæœ€åè¿˜è¦è¿›è¡Œç¬¬å…­æ­¥ï¼šæŠŠç¬¬ä¸‰æ­¥å’Œç¬¬å››æ­¥çš„ç»“æœé›†åˆå¹¶ï¼Œè¿™æ ·æ‰èƒ½æœ€ç»ˆè·å¾—æˆ‘ä»¬éœ€è¦çš„ç»“æœé›†ã€‚</p><p>å¦‚æœç”¨é€’å½’å…¬ç”¨è¡¨è¡¨è¾¾å¼ï¼Œå°±éå¸¸ç®€å•äº†ã€‚æˆ‘ä»‹ç»ä¸‹å…·ä½“çš„æ€è·¯ã€‚</p><ul><li>ç”¨é€’å½’å…¬ç”¨è¡¨è¡¨è¾¾å¼ä¸­çš„ç§å­æŸ¥è¯¢ï¼Œæ‰¾å‡ºåˆä»£ç®¡ç†è€…ã€‚å­—æ®µ n è¡¨ç¤ºä»£æ¬¡ï¼Œåˆå§‹å€¼ä¸º 1ï¼Œè¡¨ç¤ºæ˜¯ç¬¬ä¸€ ä»£ç®¡ç†è€…ã€‚</li><li>ç”¨é€’å½’å…¬ç”¨è¡¨è¡¨è¾¾å¼ä¸­çš„é€’å½’æŸ¥è¯¢ï¼ŒæŸ¥å‡ºä»¥è¿™ä¸ªé€’å½’å…¬ç”¨è¡¨è¡¨è¾¾å¼ä¸­çš„äººä¸ºç®¡ç†è€…çš„äººï¼Œå¹¶ä¸”ä»£æ¬¡ çš„å€¼åŠ  1ã€‚ç›´åˆ°æ²¡æœ‰äººä»¥è¿™ä¸ªé€’å½’å…¬ç”¨è¡¨è¡¨è¾¾å¼ä¸­çš„äººä¸ºç®¡ç†è€…äº†ï¼Œé€’å½’è¿”å›ã€‚</li><li>åœ¨æœ€åçš„æŸ¥è¯¢ä¸­ï¼Œé€‰å‡ºæ‰€æœ‰ä»£æ¬¡å¤§äºç­‰äº 3 çš„äººï¼Œä»–ä»¬è‚¯å®šæ˜¯ç¬¬ä¸‰ä»£åŠä»¥ä¸Šä»£æ¬¡çš„ä¸‹å±äº†ï¼Œä¹Ÿå°±æ˜¯ ä¸‹ä¸‹å±äº†ã€‚è¿™æ ·å°±å¾—åˆ°äº†æˆ‘ä»¬éœ€è¦çš„ç»“æœé›†ã€‚</li></ul><p>è¿™é‡Œçœ‹ä¼¼ä¹Ÿæ˜¯ 3 æ­¥ï¼Œå®é™…ä¸Šæ˜¯ä¸€ä¸ªæŸ¥è¯¢çš„ 3 ä¸ªéƒ¨åˆ†ï¼Œåªéœ€è¦æ‰§è¡Œä¸€æ¬¡å°±å¯ä»¥äº†ã€‚è€Œä¸”ä¹Ÿä¸éœ€è¦ç”¨ä¸´æ—¶è¡¨ ä¿å­˜ä¸­é—´ç»“æœï¼Œæ¯”åˆšåˆšçš„æ–¹æ³•ç®€å•å¤šäº†ã€‚</p><p>ä»£ç å®ç°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">WITH RECURSIVE cte</span><br><span class="line">AS</span><br><span class="line">(</span><br><span class="line">SELECT employee_id,last_name,manager_id,1 AS n FROM employees WHERE employee_id = 100</span><br><span class="line">-- ç§å­æŸ¥è¯¢ï¼Œæ‰¾åˆ°ç¬¬ä¸€ä»£é¢†å¯¼</span><br><span class="line">UNION ALL</span><br><span class="line">SELECT a.employee_id,a.last_name,a.manager_id,n+1 FROM employees AS a JOIN cte</span><br><span class="line">ON (a.manager_id = cte.employee_id) -- é€’å½’æŸ¥è¯¢ï¼Œæ‰¾å‡ºä»¥é€’å½’å…¬ç”¨è¡¨è¡¨è¾¾å¼çš„äººä¸ºé¢†å¯¼çš„äºº</span><br><span class="line">)</span><br><span class="line">SELECT employee_id,last_name FROM cte WHERE n &gt;= 3;</span><br></pre></td></tr></table></figure><p>æ€»ä¹‹ï¼Œé€’å½’å…¬ç”¨è¡¨è¡¨è¾¾å¼å¯¹äºæŸ¥è¯¢ä¸€ä¸ªæœ‰å…±åŒçš„æ ¹èŠ‚ç‚¹çš„æ ‘å½¢ç»“æ„æ•°æ®ï¼Œéå¸¸æœ‰ç”¨ã€‚å®ƒå¯ä»¥ä¸å—å±‚çº§çš„ é™åˆ¶ï¼Œè½»æ¾æŸ¥å‡ºæ‰€æœ‰èŠ‚ç‚¹çš„æ•°æ®ã€‚å¦‚æœç”¨å…¶ä»–çš„æŸ¥è¯¢æ–¹å¼ï¼Œå°±æ¯”è¾ƒå¤æ‚äº†ã€‚</p><h3 id="3-å°ç»“-1"><a href="#3-å°ç»“-1" class="headerlink" title="3) å°ç»“"></a>3) å°ç»“</h3><p>å…¬ç”¨è¡¨è¡¨è¾¾å¼çš„ä½œç”¨æ˜¯å¯ä»¥æ›¿ä»£å­æŸ¥è¯¢ï¼Œè€Œä¸”å¯ä»¥è¢«å¤šæ¬¡å¼•ç”¨ã€‚é€’å½’å…¬ç”¨è¡¨è¡¨è¾¾å¼å¯¹æŸ¥è¯¢æœ‰ä¸€ä¸ªå…±åŒæ ¹ èŠ‚ç‚¹çš„æ ‘å½¢ç»“æ„æ•°æ®éå¸¸é«˜æ•ˆï¼Œå¯ä»¥è½»æ¾æå®šå…¶ä»–æŸ¥è¯¢æ–¹å¼éš¾ä»¥å¤„ç†çš„æŸ¥è¯¢ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Mysql </category>
          
          <category> MysqlåŸºç¡€ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> MysqlåŸºç¡€ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>04_æ—¥å¿—ä¸å¤‡ä»½ç¯‡</title>
      <link href="/2023/03/04/04-%E6%97%A5%E5%BF%97%E4%B8%8E%E5%A4%87%E4%BB%BD%E7%AF%87/"/>
      <url>/2023/03/04/04-%E6%97%A5%E5%BF%97%E4%B8%8E%E5%A4%87%E4%BB%BD%E7%AF%87/</url>
      
        <content type="html"><![CDATA[<h1 id="ç¬¬17ç« -å…¶ä»–æ•°æ®åº“æ—¥å¿—"><a href="#ç¬¬17ç« -å…¶ä»–æ•°æ®åº“æ—¥å¿—" class="headerlink" title="ç¬¬17ç« _å…¶ä»–æ•°æ®åº“æ—¥å¿—"></a>ç¬¬17ç« _å…¶ä»–æ•°æ®åº“æ—¥å¿—</h1><img src="/2023/03/04/04-%E6%97%A5%E5%BF%97%E4%B8%8E%E5%A4%87%E4%BB%BD%E7%AF%87/image-20220715141705004.png" class=""><p><strong>åƒä¸‡ä¸è¦å°çœ‹æ—¥å¿—</strong>ã€‚å¾ˆå¤šçœ‹ä¼¼å¥‡æ€ªçš„é—®é¢˜ï¼Œç­”æ¡ˆå¾€å¾€å°±è—åœ¨æ—¥å¿—é‡Œã€‚å¾ˆå¤šæƒ…å†µä¸‹ï¼Œåªæœ‰é€šè¿‡æŸ¥çœ‹æ—¥å¿—æ‰ èƒ½å‘ç°é—®é¢˜çš„åŸå› ï¼ŒçœŸæ­£è§£å†³é—®é¢˜ã€‚æ‰€ä»¥ï¼Œä¸€å®šè¦å­¦ä¼šæŸ¥çœ‹æ—¥å¿—ï¼Œå…»æˆæ£€æŸ¥æ—¥å¿—çš„ä¹ æƒ¯ï¼Œå¯¹æå‡ä½ çš„æ•° æ®åº“åº”ç”¨å¼€å‘èƒ½åŠ›è‡³å…³é‡è¦ã€‚</p><p>MySQL8.0 å®˜ç½‘æ—¥å¿—åœ°å€ï¼šâ€œ <a href="https://dev.mysql.com/doc/refman/8.0/en/server-logs.html">https://dev.mysql.com/doc/refman/8.0/en/server-logs.html</a> â€</p><h2 id="1-MySQLæ”¯æŒçš„æ—¥å¿—"><a href="#1-MySQLæ”¯æŒçš„æ—¥å¿—" class="headerlink" title="1. MySQLæ”¯æŒçš„æ—¥å¿—"></a>1. MySQLæ”¯æŒçš„æ—¥å¿—</h2><h3 id="1-1-æ—¥å¿—ç±»å‹"><a href="#1-1-æ—¥å¿—ç±»å‹" class="headerlink" title="1.1 æ—¥å¿—ç±»å‹"></a>1.1 æ—¥å¿—ç±»å‹</h3><p>MySQLæœ‰ä¸åŒç±»å‹çš„æ—¥å¿—æ–‡ä»¶ï¼Œç”¨æ¥å­˜å‚¨ä¸åŒç±»å‹çš„æ—¥å¿—ï¼Œåˆ†ä¸º <code>äºŒè¿›åˆ¶æ—¥å¿—</code> ã€ <code>é”™è¯¯æ—¥å¿—</code> ã€ <code>é€šç”¨æŸ¥è¯¢æ—¥å¿—</code> å’Œ <code>æ…¢æŸ¥è¯¢æ—¥å¿—</code> ï¼Œè¿™ä¹Ÿæ˜¯å¸¸ç”¨çš„4ç§ã€‚MySQL 8åˆæ–°å¢ä¸¤ç§æ”¯æŒçš„æ—¥å¿—ï¼š ä¸­ç»§æ—¥å¿— å’Œ æ•°æ®å®šä¹‰è¯­å¥æ—¥å¿— ã€‚ä½¿ ç”¨è¿™äº›æ—¥å¿—æ–‡ä»¶ï¼Œå¯ä»¥æŸ¥çœ‹MySQLå†…éƒ¨å‘ç”Ÿçš„äº‹æƒ…ã€‚</p><p>è¿™6ç±»æ—¥å¿—åˆ†åˆ«ä¸ºï¼š</p><ul><li><strong>æ…¢æŸ¥è¯¢æ—¥å¿—</strong>ï¼šè®°å½•æ‰€æœ‰æ‰§è¡Œæ—¶é—´è¶…è¿‡long_query_timeçš„æ‰€æœ‰æŸ¥è¯¢ï¼Œæ–¹ä¾¿æˆ‘ä»¬å¯¹æŸ¥è¯¢è¿›è¡Œä¼˜åŒ–ã€‚ </li><li><strong>é€šç”¨æŸ¥è¯¢æ—¥å¿—</strong>ï¼šè®°å½•æ‰€æœ‰è¿æ¥çš„èµ·å§‹æ—¶é—´å’Œç»ˆæ­¢æ—¶é—´ï¼Œä»¥åŠè¿æ¥å‘é€ç»™æ•°æ®åº“æœåŠ¡å™¨çš„æ‰€æœ‰æŒ‡ä»¤ï¼Œ å¯¹æˆ‘ä»¬å¤åŸæ“ä½œçš„å®é™…åœºæ™¯ã€å‘ç°é—®é¢˜ï¼Œç”šè‡³æ˜¯å¯¹æ•°æ®åº“æ“ä½œçš„å®¡è®¡éƒ½æœ‰å¾ˆå¤§çš„å¸®åŠ©ã€‚ </li><li><strong>é”™è¯¯æ—¥å¿—</strong>ï¼šè®°å½•MySQLæœåŠ¡çš„å¯åŠ¨ã€è¿è¡Œæˆ–åœæ­¢MySQLæœåŠ¡æ—¶å‡ºç°çš„é—®é¢˜ï¼Œæ–¹ä¾¿æˆ‘ä»¬äº†è§£æœåŠ¡å™¨çš„ çŠ¶æ€ï¼Œä»è€Œå¯¹æœåŠ¡å™¨è¿›è¡Œç»´æŠ¤ã€‚ </li><li><strong>äºŒè¿›åˆ¶æ—¥å¿—</strong>ï¼šè®°å½•æ‰€æœ‰æ›´æ”¹æ•°æ®çš„è¯­å¥ï¼Œå¯ä»¥ç”¨äºä¸»ä»æœåŠ¡å™¨ä¹‹é—´çš„æ•°æ®åŒæ­¥ï¼Œä»¥åŠæœåŠ¡å™¨é‡åˆ°æ•… éšœæ—¶æ•°æ®çš„æ— æŸå¤±æ¢å¤ã€‚ </li><li><strong>ä¸­ç»§æ—¥å¿—</strong>ï¼šç”¨äºä¸»ä»æœåŠ¡å™¨æ¶æ„ä¸­ï¼Œä»æœåŠ¡å™¨ç”¨æ¥å­˜æ”¾ä¸»æœåŠ¡å™¨äºŒè¿›åˆ¶æ—¥å¿—å†…å®¹çš„ä¸€ä¸ªä¸­é—´æ–‡ä»¶ã€‚ ä»æœåŠ¡å™¨é€šè¿‡è¯»å–ä¸­ç»§æ—¥å¿—çš„å†…å®¹ï¼Œæ¥åŒæ­¥ä¸»æœåŠ¡å™¨ä¸Šçš„æ“ä½œã€‚ </li><li><strong>æ•°æ®å®šä¹‰è¯­å¥æ—¥å¿—</strong>ï¼šè®°å½•æ•°æ®å®šä¹‰è¯­å¥æ‰§è¡Œçš„å…ƒæ•°æ®æ“ä½œã€‚</li></ul><p>é™¤äºŒè¿›åˆ¶æ—¥å¿—å¤–ï¼Œå…¶ä»–æ—¥å¿—éƒ½æ˜¯ <code>æ–‡æœ¬æ–‡ä»¶</code> ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œæ‰€æœ‰æ—¥å¿—åˆ›å»ºäº <code>MySQLæ•°æ®ç›®å½•</code> ä¸­ã€‚</p><h3 id="1-2-æ—¥å¿—çš„å¼Šç«¯"><a href="#1-2-æ—¥å¿—çš„å¼Šç«¯" class="headerlink" title="1.2 æ—¥å¿—çš„å¼Šç«¯"></a>1.2 æ—¥å¿—çš„å¼Šç«¯</h3><ul><li>æ—¥å¿—åŠŸèƒ½ä¼š <code>é™ä½MySQLæ•°æ®åº“çš„æ€§èƒ½</code> ã€‚ä¾‹å¦‚ï¼Œåœ¨æŸ¥è¯¢éå¸¸é¢‘ç¹çš„MySQLæ•°æ®åº“ç³»ç»Ÿä¸­ï¼Œå¦‚æœå¼€å¯äº†é€šç”¨æŸ¥è¯¢æ—¥å¿—å’Œæ…¢æŸ¥è¯¢æ—¥å¿—ï¼ŒMySQLæ•°æ®åº“ä¼šèŠ±è´¹å¾ˆå¤šæ—¶é—´è®°å½•æ—¥å¿—ã€‚</li><li>æ—¥å¿—ä¼š <code>å ç”¨å¤§é‡çš„ç£ç›˜ç©ºé—´</code> ã€‚å¯¹äºç”¨æˆ·é‡éå¸¸å¤§ï¼Œæ“ä½œéå¸¸é¢‘ç¹çš„æ•°æ®åº“ï¼Œæ—¥å¿—æ–‡ä»¶éœ€è¦çš„å­˜å‚¨ç©ºé—´è®¾ç½®æ¯”æ•°æ®åº“æ–‡ä»¶éœ€è¦çš„å­˜å‚¨ç©ºé—´è¿˜è¦å¤§ã€‚</li></ul><h2 id="2-æ…¢æŸ¥è¯¢æ—¥å¿—-slow-query-log"><a href="#2-æ…¢æŸ¥è¯¢æ—¥å¿—-slow-query-log" class="headerlink" title="2. æ…¢æŸ¥è¯¢æ—¥å¿—(slow query log)"></a>2. æ…¢æŸ¥è¯¢æ—¥å¿—(slow query log)</h2><p>å‰é¢ç« èŠ‚ã€Šç¬¬09ç« _æ€§èƒ½åˆ†æå·¥å…·çš„ä½¿ç”¨ã€‹å·²ç»è¯¦ç»†è®²è¿°ã€‚</p><h2 id="3-é€šç”¨æŸ¥è¯¢æ—¥å¿—-general-query-log"><a href="#3-é€šç”¨æŸ¥è¯¢æ—¥å¿—-general-query-log" class="headerlink" title="3. é€šç”¨æŸ¥è¯¢æ—¥å¿—(general query log)"></a>3. é€šç”¨æŸ¥è¯¢æ—¥å¿—(general query log)</h2><p>é€šç”¨æŸ¥è¯¢æ—¥å¿—ç”¨æ¥ <code>è®°å½•ç”¨æˆ·çš„æ‰€æœ‰æ“ä½œ</code> ï¼ŒåŒ…æ‹¬å¯åŠ¨å’Œå…³é—­MySQLæœåŠ¡ã€æ‰€æœ‰ç”¨æˆ·çš„è¿æ¥å¼€å§‹æ—¶é—´å’Œæˆªæ­¢ æ—¶é—´ã€å‘ç»™ MySQL æ•°æ®åº“æœåŠ¡å™¨çš„æ‰€æœ‰ SQL æŒ‡ä»¤ç­‰ã€‚å½“æˆ‘ä»¬çš„æ•°æ®å‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œ<strong>æŸ¥çœ‹é€šç”¨æŸ¥è¯¢æ—¥å¿—ï¼Œ è¿˜åŸæ“ä½œæ—¶çš„å…·ä½“åœºæ™¯</strong>ï¼Œå¯ä»¥å¸®åŠ©æˆ‘ä»¬å‡†ç¡®å®šä½é—®é¢˜ã€‚</p><h3 id="3-1-é—®é¢˜åœºæ™¯"><a href="#3-1-é—®é¢˜åœºæ™¯" class="headerlink" title="3.1 é—®é¢˜åœºæ™¯"></a>3.1 é—®é¢˜åœºæ™¯</h3><img src="/2023/03/04/04-%E6%97%A5%E5%BF%97%E4%B8%8E%E5%A4%87%E4%BB%BD%E7%AF%87/image-20220715145650406.png" class=""><h3 id="3-2-æŸ¥çœ‹å½“å‰çŠ¶æ€"><a href="#3-2-æŸ¥çœ‹å½“å‰çŠ¶æ€" class="headerlink" title="3.2 æŸ¥çœ‹å½“å‰çŠ¶æ€"></a>3.2 æŸ¥çœ‹å½“å‰çŠ¶æ€</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SHOW VARIABLES LIKE &#x27;%general%&#x27;;</span><br><span class="line">+------------------+------------------------------+</span><br><span class="line">| Variable_name    | Value                        |</span><br><span class="line">+------------------+------------------------------+</span><br><span class="line">| general_log      | OFF                          | #é€šç”¨æŸ¥è¯¢æ—¥å¿—å¤„äºå…³é—­çŠ¶æ€</span><br><span class="line">| general_log_file | /var/lib/mysql/atguigu01.log | #é€šç”¨æŸ¥è¯¢æ—¥å¿—æ–‡ä»¶çš„åç§°æ˜¯atguigu01.log</span><br><span class="line">+------------------+------------------------------+</span><br><span class="line">2 rows in set (0.03 sec)</span><br></pre></td></tr></table></figure><img src="/2023/03/04/04-%E6%97%A5%E5%BF%97%E4%B8%8E%E5%A4%87%E4%BB%BD%E7%AF%87/image-20220715155010381.png" class=""><h3 id="3-3-å¯åŠ¨æ—¥å¿—"><a href="#3-3-å¯åŠ¨æ—¥å¿—" class="headerlink" title="3.3 å¯åŠ¨æ—¥å¿—"></a>3.3 å¯åŠ¨æ—¥å¿—</h3><p><strong>æ–¹å¼1ï¼šæ°¸ä¹…æ€§æ–¹å¼</strong></p><p>ä¿®æ”¹my.cnfæˆ–è€…my.inié…ç½®æ–‡ä»¶æ¥è®¾ç½®ã€‚åœ¨[mysqld]ç»„ä¸‹åŠ å…¥logé€‰é¡¹ï¼Œå¹¶é‡å¯MySQLæœåŠ¡ã€‚æ ¼å¼å¦‚ä¸‹ï¼š</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[mysqld]</span></span><br><span class="line"><span class="attr">general_log</span>=<span class="string">ON</span></span><br><span class="line"><span class="attr">general_log_file</span>=<span class="string">[path[filename]] #æ—¥å¿—æ–‡ä»¶æ‰€åœ¨ç›®å½•è·¯å¾„ï¼Œfilenameä¸ºæ—¥å¿—æ–‡ä»¶</span></span><br></pre></td></tr></table></figure><p>å¦‚æœä¸æŒ‡å®šç›®å½•å’Œæ–‡ä»¶åï¼Œé€šç”¨æŸ¥è¯¢æ—¥å¿—å°†é»˜è®¤å­˜å‚¨åœ¨MySQLæ•°æ®ç›®å½•ä¸­çš„hostname.logæ–‡ä»¶ä¸­ï¼Œ hostnameè¡¨ç¤ºä¸»æœºåã€‚</p><p><strong>æ–¹å¼2ï¼šä¸´æ—¶æ€§æ–¹å¼</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SET GLOBAL general_log=on; # å¼€å¯é€šç”¨æŸ¥è¯¢æ—¥å¿—</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SET GLOBAL general_log_file=â€™path/filenameâ€™; # è®¾ç½®æ—¥å¿—æ–‡ä»¶ä¿å­˜ä½ç½®</span><br></pre></td></tr></table></figure><p>å¯¹åº”çš„ï¼Œå…³é—­æ“ä½œSQLå‘½ä»¤å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SET GLOBAL general_log=off; # å…³é—­é€šç”¨æŸ¥è¯¢æ—¥å¿—</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹è®¾ç½®åæƒ…å†µï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHOW VARIABLES LIKE &#x27;general_log%&#x27;;</span><br></pre></td></tr></table></figure><h3 id="3-4-æŸ¥çœ‹æ—¥å¿—"><a href="#3-4-æŸ¥çœ‹æ—¥å¿—" class="headerlink" title="3.4 æŸ¥çœ‹æ—¥å¿—"></a>3.4 æŸ¥çœ‹æ—¥å¿—</h3><p>é€šç”¨æŸ¥è¯¢æ—¥å¿—æ˜¯ä»¥ <code>æ–‡æœ¬æ–‡ä»¶</code> çš„å½¢å¼å­˜å‚¨åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­çš„ï¼Œå¯ä»¥ä½¿ç”¨ <code>æ–‡æœ¬ç¼–è¾‘å™¨</code> ç›´æ¥æ‰“å¼€æ—¥å¿—æ–‡ä»¶ã€‚æ¯å° MySQLæœåŠ¡å™¨çš„é€šç”¨æŸ¥è¯¢æ—¥å¿—å†…å®¹æ˜¯ä¸åŒçš„ã€‚</p><ul><li>åœ¨Windowsæ“ä½œç³»ç»Ÿä¸­ï¼Œä½¿ç”¨æ–‡æœ¬æ–‡ä»¶æŸ¥çœ‹å™¨ï¼› </li><li>åœ¨Linuxç³»ç»Ÿä¸­ï¼Œå¯ä»¥ä½¿ç”¨viå·¥å…·æˆ–è€…geditå·¥å…·æŸ¥çœ‹ï¼› </li><li>åœ¨Mac OSXç³»ç»Ÿä¸­ï¼Œå¯ä»¥ä½¿ç”¨æ–‡æœ¬æ–‡ä»¶æŸ¥çœ‹å™¨æˆ–è€…viç­‰å·¥å…·æŸ¥çœ‹ã€‚</li></ul><p>ä» <code>SHOW VARIABLES LIKE &#39;general_log%&#39;</code>; ç»“æœä¸­å¯ä»¥çœ‹åˆ°é€šç”¨æŸ¥è¯¢æ—¥å¿—çš„ä½ç½®ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">/usr/sbin/mysqld, Version: 8.0.26 (MySQL Community Server - GPL). started with:</span><br><span class="line">Tcp port: 3306 Unix socket: /var/lib/mysql/mysql.sock</span><br><span class="line">Time Id Command Argument</span><br><span class="line">2022-01-04T07:44:58.052890Z 10 Query SHOW VARIABLES LIKE &#x27;%general%&#x27;</span><br><span class="line">2022-01-04T07:45:15.666672Z 10 Query SHOW VARIABLES LIKE &#x27;general_log%&#x27;</span><br><span class="line">2022-01-04T07:45:28.970765Z 10 Query select * from student</span><br><span class="line">2022-01-04T07:47:38.706804Z 11 Connect root@localhost on using Socket</span><br><span class="line">2022-01-04T07:47:38.707435Z 11 Query select @@version_comment limit 1</span><br><span class="line">2022-01-04T07:48:21.384886Z 12 Connect root@172.16.210.1 on using TCP/IP</span><br><span class="line">2022-01-04T07:48:21.385253Z 12 Query SET NAMES utf8</span><br><span class="line">2022-01-04T07:48:21.385640Z 12 Query USE `atguigu12`</span><br><span class="line">2022-01-04T07:48:21.386179Z 12 Query SHOW FULL TABLES WHERE Table_Type !=</span><br><span class="line">&#x27;VIEW&#x27;</span><br><span class="line">2022-01-04T07:48:23.901778Z 13 Connect root@172.16.210.1 on using TCP/IP</span><br><span class="line">2022-01-04T07:48:23.902128Z 13 Query SET NAMES utf8</span><br><span class="line">2022-01-04T07:48:23.905179Z 13 Query USE `atguigu`</span><br><span class="line">2022-01-04T07:48:23.905825Z 13 Query SHOW FULL TABLES WHERE Table_Type !=</span><br><span class="line">&#x27;VIEW&#x27;</span><br><span class="line">2022-01-04T07:48:32.163833Z 14 Connect root@172.16.210.1 on using TCP/IP</span><br><span class="line">2022-01-04T07:48:32.164451Z 14 Query SET NAMES utf8</span><br><span class="line">2022-01-04T07:48:32.164840Z 14 Query USE `atguigu`</span><br><span class="line">2022-01-04T07:48:40.006687Z 14 Query select * from account</span><br></pre></td></tr></table></figure><p>åœ¨é€šç”¨æŸ¥è¯¢æ—¥å¿—é‡Œé¢ï¼Œæˆ‘ä»¬å¯ä»¥æ¸…æ¥šåœ°çœ‹åˆ°ï¼Œä»€ä¹ˆæ—¶å€™å¼€å¯äº†æ–°çš„å®¢æˆ·ç«¯ç™»é™†æ•°æ®åº“ï¼Œç™»å½•ä¹‹ååšäº†ä»€ä¹ˆ SQL æ“ä½œï¼Œé’ˆå¯¹çš„æ˜¯å“ªä¸ªæ•°æ®è¡¨ç­‰ä¿¡æ¯ã€‚</p><h3 id="3-5-åœæ­¢æ—¥å¿—"><a href="#3-5-åœæ­¢æ—¥å¿—" class="headerlink" title="3.5 åœæ­¢æ—¥å¿—"></a>3.5 åœæ­¢æ—¥å¿—</h3><p><strong>æ–¹å¼1ï¼šæ°¸ä¹…æ€§æ–¹å¼</strong></p><p>ä¿®æ”¹ <code>my.cnf</code> æˆ–è€… <code>my.ini</code> æ–‡ä»¶ï¼ŒæŠŠ[mysqld]ç»„ä¸‹çš„ <code>general_log</code> å€¼è®¾ç½®ä¸º <code>OFF</code> æˆ–è€…æŠŠgeneral_logä¸€é¡¹ æ³¨é‡Šæ‰ã€‚ä¿®æ”¹ä¿å­˜åï¼Œå†<code>é‡å¯MySQLæœåŠ¡</code> ï¼Œå³å¯ç”Ÿæ•ˆã€‚ </p><p>ä¸¾ä¾‹1ï¼š</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[mysqld]</span></span><br><span class="line"><span class="attr">general_log</span>=<span class="string">OFF</span></span><br></pre></td></tr></table></figure><p>ä¸¾ä¾‹2ï¼š</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[mysqld]</span></span><br><span class="line"><span class="comment">#general_log=ON</span></span><br></pre></td></tr></table></figure><p><strong>æ–¹å¼2ï¼šä¸´æ—¶æ€§æ–¹å¼</strong></p><p>ä½¿ç”¨SETè¯­å¥åœæ­¢MySQLé€šç”¨æŸ¥è¯¢æ—¥å¿—åŠŸèƒ½ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SET GLOBAL general_log=off;</span><br></pre></td></tr></table></figure><p>æŸ¥è¯¢é€šç”¨æ—¥å¿—åŠŸèƒ½ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHOW VARIABLES LIKE &#x27;general_log%&#x27;;</span><br></pre></td></tr></table></figure><h3 id="3-6-åˆ é™¤-åˆ·æ–°æ—¥å¿—"><a href="#3-6-åˆ é™¤-åˆ·æ–°æ—¥å¿—" class="headerlink" title="3.6 åˆ é™¤\åˆ·æ–°æ—¥å¿—"></a>3.6 åˆ é™¤\åˆ·æ–°æ—¥å¿—</h3><p>å¦‚æœæ•°æ®çš„ä½¿ç”¨éå¸¸é¢‘ç¹ï¼Œé‚£ä¹ˆé€šç”¨æŸ¥è¯¢æ—¥å¿—ä¼šå ç”¨æœåŠ¡å™¨éå¸¸å¤§çš„ç£ç›˜ç©ºé—´ã€‚æ•°æ®ç®¡ç†å‘˜å¯ä»¥åˆ é™¤å¾ˆé•¿æ—¶é—´ä¹‹å‰çš„æŸ¥è¯¢æ—¥å¿—ï¼Œä»¥ä¿è¯MySQLæœåŠ¡å™¨ä¸Šçš„ç¡¬ç›˜ç©ºé—´ã€‚</p><p><strong>æ‰‹åŠ¨åˆ é™¤æ–‡ä»¶</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHOW VARIABLES LIKE &#x27;general_log%&#x27;;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºï¼Œé€šç”¨æŸ¥è¯¢æ—¥å¿—çš„ç›®å½•é»˜è®¤ä¸ºMySQLæ•°æ®ç›®å½•ã€‚åœ¨è¯¥ç›®å½•ä¸‹æ‰‹åŠ¨åˆ é™¤é€šç”¨æŸ¥è¯¢æ—¥å¿— atguigu01.log</p><p>ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤é‡æ–°ç”ŸæˆæŸ¥è¯¢æ—¥å¿—æ–‡ä»¶ï¼Œå…·ä½“å‘½ä»¤å¦‚ä¸‹ã€‚åˆ·æ–°MySQLæ•°æ®ç›®å½•ï¼Œå‘ç°åˆ›å»ºäº†æ–°çš„æ—¥å¿—æ–‡ ä»¶ã€‚å‰æä¸€å®šè¦å¼€å¯é€šç”¨æ—¥å¿—ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqladmin -uroot -p flush-logs</span><br></pre></td></tr></table></figure><p>å¦‚æœå¸Œæœ›å¤‡ä»½æ—§çš„é€šç”¨æŸ¥è¯¢æ—¥å¿—ï¼Œå°±å¿…é¡»å…ˆå°†æ—§çš„æ—¥å¿—æ–‡ä»¶å¤åˆ¶å‡ºæ¥æˆ–è€…æ”¹åï¼Œç„¶åæ‰§è¡Œä¸Šé¢çš„mysqladminå‘½ä»¤ã€‚æ­£ç¡®æµç¨‹å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd mysql-data-directory # è¾“å…¥è‡ªå·±çš„é€šç”¨æ—¥å¿—æ–‡ä»¶æ‰€åœ¨ç›®å½•</span><br><span class="line">mv mysql.general.log mysql.general.log.old # æŒ‡å®šæ—§çš„æ–‡ä»¶å ä»¥åŠ æ–°çš„æ–‡ä»¶å</span><br><span class="line">mysqladmin -uroot -p flush-logs</span><br></pre></td></tr></table></figure><h2 id="4-é”™è¯¯æ—¥å¿—-error-log"><a href="#4-é”™è¯¯æ—¥å¿—-error-log" class="headerlink" title="4. é”™è¯¯æ—¥å¿—(error log)"></a>4. é”™è¯¯æ—¥å¿—(error log)</h2><img src="/2023/03/04/04-%E6%97%A5%E5%BF%97%E4%B8%8E%E5%A4%87%E4%BB%BD%E7%AF%87/image-20220715160249271.png" class=""><h3 id="4-1-å¯åŠ¨æ—¥å¿—"><a href="#4-1-å¯åŠ¨æ—¥å¿—" class="headerlink" title="4.1 å¯åŠ¨æ—¥å¿—"></a>4.1 å¯åŠ¨æ—¥å¿—</h3><p>åœ¨MySQLæ•°æ®åº“ä¸­ï¼Œé”™è¯¯æ—¥å¿—åŠŸèƒ½æ˜¯ <code>é»˜è®¤å¼€å¯</code> çš„ã€‚è€Œä¸”ï¼Œé”™è¯¯æ—¥å¿— <code>æ— æ³•è¢«ç¦æ­¢</code> ã€‚</p><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œé”™è¯¯æ—¥å¿—å­˜å‚¨åœ¨MySQLæ•°æ®åº“çš„æ•°æ®æ–‡ä»¶å¤¹ä¸‹ï¼Œåç§°é»˜è®¤ä¸º <code>mysqld.log</code> ï¼ˆLinuxç³»ç»Ÿï¼‰æˆ– <code>hostname.err</code> ï¼ˆmacç³»ç»Ÿï¼‰ã€‚å¦‚æœéœ€è¦åˆ¶å®šæ–‡ä»¶åï¼Œåˆ™éœ€è¦åœ¨my.cnfæˆ–è€…my.iniä¸­åšå¦‚ä¸‹é…ç½®ï¼š</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[mysqld]</span></span><br><span class="line"><span class="attr">log-error</span>=<span class="string">[path/[filename]] #pathä¸ºæ—¥å¿—æ–‡ä»¶æ‰€åœ¨çš„ç›®å½•è·¯å¾„ï¼Œfilenameä¸ºæ—¥å¿—æ–‡ä»¶å</span></span><br></pre></td></tr></table></figure><p>ä¿®æ”¹é…ç½®é¡¹åï¼Œéœ€è¦é‡å¯MySQLæœåŠ¡ä»¥ç”Ÿæ•ˆã€‚</p><h3 id="4-2-æŸ¥çœ‹æ—¥å¿—"><a href="#4-2-æŸ¥çœ‹æ—¥å¿—" class="headerlink" title="4.2 æŸ¥çœ‹æ—¥å¿—"></a>4.2 æŸ¥çœ‹æ—¥å¿—</h3><p>MySQLé”™è¯¯æ—¥å¿—æ˜¯ä»¥æ–‡æœ¬æ–‡ä»¶å½¢å¼å­˜å‚¨çš„ï¼Œå¯ä»¥ä½¿ç”¨æ–‡æœ¬ç¼–è¾‘å™¨ç›´æ¥æŸ¥çœ‹ã€‚</p><p>æŸ¥è¯¢é”™è¯¯æ—¥å¿—çš„å­˜å‚¨è·¯å¾„ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SHOW VARIABLES LIKE &#x27;log_err%&#x27;;</span><br><span class="line">+----------------------------+----------------------------------------+</span><br><span class="line">| Variable_name              | Value                                  |</span><br><span class="line">+----------------------------+----------------------------------------+</span><br><span class="line">| log_error                  | /var/log/mysqld.log                    |</span><br><span class="line">| log_error_services         | log_filter_internal; log_sink_internal |</span><br><span class="line">| log_error_suppression_list |                                        |</span><br><span class="line">| log_error_verbosity        | 2                                      |</span><br><span class="line">+----------------------------+----------------------------------------+</span><br><span class="line">4 rows in set (0.01 sec)</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œç»“æœä¸­å¯ä»¥çœ‹åˆ°é”™è¯¯æ—¥å¿—æ–‡ä»¶æ˜¯mysqld.logï¼Œä½äºMySQLé»˜è®¤çš„æ•°æ®ç›®å½•ä¸‹ã€‚</p><img src="/2023/03/04/04-%E6%97%A5%E5%BF%97%E4%B8%8E%E5%A4%87%E4%BB%BD%E7%AF%87/image-20220715160657093.png" class=""><h3 id="4-3-åˆ é™¤-åˆ·æ–°æ—¥å¿—"><a href="#4-3-åˆ é™¤-åˆ·æ–°æ—¥å¿—" class="headerlink" title="4.3 åˆ é™¤\åˆ·æ–°æ—¥å¿—"></a>4.3 åˆ é™¤\åˆ·æ–°æ—¥å¿—</h3><p>å¯¹äºå¾ˆä¹…ä»¥å‰çš„é”™è¯¯æ—¥å¿—ï¼Œæ•°æ®åº“ç®¡ç†å‘˜æŸ¥çœ‹è¿™äº›é”™è¯¯æ—¥å¿—çš„å¯èƒ½æ€§ä¸å¤§ï¼Œå¯ä»¥å°†è¿™äº›é”™è¯¯æ—¥å¿—åˆ é™¤ï¼Œ ä»¥ä¿è¯MySQLæœåŠ¡å™¨ä¸Šçš„ <code>ç¡¬ç›˜ç©ºé—´</code> ã€‚MySQLçš„é”™è¯¯æ—¥å¿—æ˜¯ä»¥æ–‡æœ¬æ–‡ä»¶çš„å½¢å¼å­˜å‚¨åœ¨æ–‡ä»¶ç³»ç»Ÿä¸­çš„ï¼Œå¯ä»¥ <code>ç›´æ¥åˆ é™¤</code> ã€‚</p><ul><li><p>ç¬¬ä¸€æ­¥ï¼ˆæ–¹å¼1ï¼‰ï¼šåˆ é™¤æ“ä½œ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rm -f /var/lib/mysql/mysqld.log</span><br></pre></td></tr></table></figure><p>åœ¨è¿è¡ŒçŠ¶æ€ä¸‹åˆ é™¤é”™è¯¯æ—¥å¿—æ–‡ä»¶åï¼ŒMySQLå¹¶ä¸ä¼šè‡ªåŠ¨åˆ›å»ºæ—¥å¿—æ–‡ä»¶ã€‚</p></li><li><p>ç¬¬ä¸€æ­¥ï¼ˆæ–¹å¼2ï¼‰ï¼šé‡å‘½åæ–‡ä»¶</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mv /var/log/mysqld.log /var/log/mysqld.log.old</span><br></pre></td></tr></table></figure></li><li><p>ç¬¬äºŒæ­¥ï¼šé‡å»ºæ—¥å¿—</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqladmin -uroot -p flush-logs</span><br></pre></td></tr></table></figure><p>å¯èƒ½ä¼šæŠ¥é”™</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@atguigu01 log]# mysqladmin -uroot -p flush-logs</span><br><span class="line">Enter password:</span><br><span class="line">mysqladmin: refresh failed; error: &#x27;Could not open file &#x27;/var/log/mysqld.log&#x27; for</span><br><span class="line">error logging.&#x27;</span><br></pre></td></tr></table></figure><p>å®˜ç½‘æç¤ºï¼š</p></li></ul><img src="/2023/03/04/04-%E6%97%A5%E5%BF%97%E4%B8%8E%E5%A4%87%E4%BB%BD%E7%AF%87/image-20220715161132368.png" class=""><p>è¡¥å……æ“ä½œï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">install -omysql -gmysql -m0644 /dev/null /var/log/mysqld.log</span><br></pre></td></tr></table></figure><img src="/2023/03/04/04-%E6%97%A5%E5%BF%97%E4%B8%8E%E5%A4%87%E4%BB%BD%E7%AF%87/image-20220715161216556.png" class=""><h3 id="4-4-MySQL-8-0-æ–°ç‰¹æ€§"><a href="#4-4-MySQL-8-0-æ–°ç‰¹æ€§" class="headerlink" title="4.4 MySQL 8.0 æ–°ç‰¹æ€§"></a>4.4 MySQL 8.0 æ–°ç‰¹æ€§</h3><img src="/2023/03/04/04-%E6%97%A5%E5%BF%97%E4%B8%8E%E5%A4%87%E4%BB%BD%E7%AF%87/image-20220715161321565.png" class=""><blockquote><p>å°ç»“ï¼š</p><p>é€šå¸¸æƒ…å†µä¸‹ï¼Œç®¡ç†å‘˜ä¸éœ€è¦æŸ¥çœ‹é”™è¯¯æ—¥å¿—ã€‚ä½†æ˜¯ï¼ŒMySQLæœåŠ¡å™¨å‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œç®¡ç†å‘˜å¯ä»¥ä»é”™è¯¯æ—¥å¿—ä¸­æ‰¾åˆ°å‘ç”Ÿå¼‚å¸¸çš„æ—¶é—´ã€åŸå› ï¼Œç„¶åæ ¹æ®è¿™äº›ä¿¡æ¯æ¥è§£å†³å¼‚å¸¸ã€‚</p></blockquote><h2 id="5-äºŒè¿›åˆ¶æ—¥å¿—-bin-log"><a href="#5-äºŒè¿›åˆ¶æ—¥å¿—-bin-log" class="headerlink" title="5. äºŒè¿›åˆ¶æ—¥å¿—(bin log)"></a>5. äºŒè¿›åˆ¶æ—¥å¿—(bin log)</h2><p>binlogå¯ä»¥è¯´æ˜¯MySQLä¸­æ¯”è¾ƒ <code>é‡è¦</code> çš„æ—¥å¿—äº†ï¼Œåœ¨æ—¥å¸¸å¼€å‘åŠè¿ç»´è¿‡ç¨‹ä¸­ï¼Œç»å¸¸ä¼šé‡åˆ°ã€‚</p><p>binlogå³binary logï¼ŒäºŒè¿›åˆ¶æ—¥å¿—æ–‡ä»¶ï¼Œä¹Ÿå«ä½œå˜æ›´æ—¥å¿—ï¼ˆupdate logï¼‰ã€‚å®ƒè®°å½•äº†æ•°æ®åº“æ‰€æœ‰æ‰§è¡Œçš„ <code>DDL</code> å’Œ <code>DML</code> ç­‰æ•°æ®åº“æ›´æ–°äº‹ä»¶çš„è¯­å¥ï¼Œä½†æ˜¯ä¸åŒ…å«æ²¡æœ‰ä¿®æ”¹ä»»ä½•æ•°æ®çš„è¯­å¥ï¼ˆå¦‚æ•°æ®æŸ¥è¯¢è¯­å¥selectã€ showç­‰ï¼‰ã€‚</p><p>å®ƒä»¥<code>äº‹ä»¶å½¢å¼</code>è®°å½•å¹¶ä¿å­˜åœ¨<code>äºŒè¿›åˆ¶æ–‡ä»¶</code>ä¸­ã€‚é€šè¿‡è¿™äº›ä¿¡æ¯ï¼Œæˆ‘ä»¬å¯ä»¥å†ç°æ•°æ®æ›´æ–°æ“ä½œçš„å…¨è¿‡ç¨‹ã€‚</p><blockquote><p>å¦‚æœæƒ³è¦è®°å½•æ‰€æœ‰è¯­å¥ï¼ˆä¾‹å¦‚ï¼Œä¸ºäº†è¯†åˆ«æœ‰é—®é¢˜çš„æŸ¥è¯¢ï¼‰ï¼Œéœ€è¦ä½¿ç”¨é€šç”¨æŸ¥è¯¢æ—¥å¿—ã€‚</p></blockquote><p>binlogä¸»è¦åº”ç”¨åœºæ™¯ï¼š</p><img src="/2023/03/04/04-%E6%97%A5%E5%BF%97%E4%B8%8E%E5%A4%87%E4%BB%BD%E7%AF%87/image-20220715161800635.png" class=""><img src="/2023/03/04/04-%E6%97%A5%E5%BF%97%E4%B8%8E%E5%A4%87%E4%BB%BD%E7%AF%87/image-20220715161842703.png" class=""><h3 id="5-1-æŸ¥çœ‹é»˜è®¤æƒ…å†µ"><a href="#5-1-æŸ¥çœ‹é»˜è®¤æƒ…å†µ" class="headerlink" title="5.1 æŸ¥çœ‹é»˜è®¤æƒ…å†µ"></a>5.1 æŸ¥çœ‹é»˜è®¤æƒ…å†µ</h3><p>æŸ¥çœ‹è®°å½•äºŒè¿›åˆ¶æ—¥å¿—æ˜¯å¦å¼€å¯ï¼šåœ¨MySQL8ä¸­é»˜è®¤æƒ…å†µä¸‹ï¼ŒäºŒè¿›åˆ¶æ–‡ä»¶æ˜¯å¼€å¯çš„ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like &#x27;%log_bin%&#x27;;</span><br><span class="line">+---------------------------------+----------------------------------+</span><br><span class="line">| Variable_name                   | Value                            |</span><br><span class="line">+---------------------------------+----------------------------------+</span><br><span class="line">| log_bin                         | ON                               |</span><br><span class="line">| log_bin_basename                | /var/lib/mysql/binlog            |</span><br><span class="line">| log_bin_index                   | /var/lib/mysql/binlog.index      |</span><br><span class="line">| log_bin_trust_function_creators | OFF                              |</span><br><span class="line">| log_bin_use_v1_row_events       | OFF                              |</span><br><span class="line">| sql_log_bin                     | ON                               |</span><br><span class="line">+---------------------------------+----------------------------------+</span><br><span class="line">6 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><img src="/2023/03/04/04-%E6%97%A5%E5%BF%97%E4%B8%8E%E5%A4%87%E4%BB%BD%E7%AF%87/image-20220715163520596.png" class=""><h3 id="5-2-æ—¥å¿—å‚æ•°è®¾ç½®"><a href="#5-2-æ—¥å¿—å‚æ•°è®¾ç½®" class="headerlink" title="5.2 æ—¥å¿—å‚æ•°è®¾ç½®"></a>5.2 æ—¥å¿—å‚æ•°è®¾ç½®</h3><p><strong>æ–¹å¼1ï¼šæ°¸ä¹…æ€§æ–¹å¼</strong></p><p>ä¿®æ”¹MySQLçš„ <code>my.cnf</code> æˆ– <code>my.ini</code> æ–‡ä»¶å¯ä»¥è®¾ç½®äºŒè¿›åˆ¶æ—¥å¿—çš„ç›¸å…³å‚æ•°ï¼š</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[mysqld]</span></span><br><span class="line"><span class="comment">#å¯ç”¨äºŒè¿›åˆ¶æ—¥å¿—</span></span><br><span class="line"><span class="attr">log-bin</span>=<span class="string">atguigu-bin</span></span><br><span class="line"><span class="attr">binlog_expire_logs_seconds</span>=<span class="string">600</span></span><br><span class="line"><span class="attr">max_binlog_size</span>=<span class="string">100M</span></span><br></pre></td></tr></table></figure><img src="/2023/03/04/04-%E6%97%A5%E5%BF%97%E4%B8%8E%E5%A4%87%E4%BB%BD%E7%AF%87/image-20220715163811664.png" class=""><p>é‡æ–°å¯åŠ¨MySQLæœåŠ¡ï¼ŒæŸ¥è¯¢äºŒè¿›åˆ¶æ—¥å¿—çš„ä¿¡æ¯ï¼Œæ‰§è¡Œç»“æœï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like &#x27;%log_bin%&#x27;;</span><br><span class="line">+---------------------------------+----------------------------------+</span><br><span class="line">| Variable_name                   | Value                            |</span><br><span class="line">+---------------------------------+----------------------------------+</span><br><span class="line">| log_bin                         | ON                               |</span><br><span class="line">| log_bin_basename                | /var/lib/mysql/atguigu-bin       |</span><br><span class="line">| log_bin_index                   | /var/lib/mysql/atguigu-bin.index |</span><br><span class="line">| log_bin_trust_function_creators | OFF                              |</span><br><span class="line">| log_bin_use_v1_row_events       | OFF                              |</span><br><span class="line">| sql_log_bin                     | ON                               |</span><br><span class="line">+---------------------------------+----------------------------------+</span><br><span class="line">6 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><p><strong>è®¾ç½®å¸¦æ–‡ä»¶å¤¹çš„bin-logæ—¥å¿—å­˜æ”¾ç›®å½•</strong></p><p>å¦‚æœæƒ³æ”¹å˜æ—¥å¿—æ–‡ä»¶çš„ç›®å½•å’Œåç§°ï¼Œå¯ä»¥å¯¹my.cnfæˆ–my.iniä¸­çš„log_binå‚æ•°ä¿®æ”¹å¦‚ä¸‹ï¼š</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[mysqld]</span></span><br><span class="line"><span class="attr">log-bin</span>=<span class="string">&quot;/var/lib/mysql/binlog/atguigu-bin&quot;</span></span><br></pre></td></tr></table></figure><p>æ³¨æ„ï¼šæ–°å»ºçš„æ–‡ä»¶å¤¹éœ€è¦ä½¿ç”¨mysqlç”¨æˆ·ï¼Œä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤å³å¯ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chown -R -v mysql:mysql binlog</span><br></pre></td></tr></table></figure><img src="/2023/03/04/04-%E6%97%A5%E5%BF%97%E4%B8%8E%E5%A4%87%E4%BB%BD%E7%AF%87/image-20220715164107352.png" class=""><p><strong>æ–¹å¼2ï¼šä¸´æ—¶æ€§æ–¹å¼</strong></p><p>å¦‚æœä¸å¸Œæœ›é€šè¿‡ä¿®æ”¹é…ç½®æ–‡ä»¶å¹¶é‡å¯çš„æ–¹å¼è®¾ç½®äºŒè¿›åˆ¶æ—¥å¿—çš„è¯ï¼Œè¿˜å¯ä»¥ä½¿ç”¨å¦‚ä¸‹æŒ‡ä»¤ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ åœ¨mysql8ä¸­åªæœ‰ <code>ä¼šè¯çº§åˆ«</code> çš„è®¾ç½®ï¼Œæ²¡æœ‰äº†globalçº§åˆ«çš„è®¾ç½®ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># global çº§åˆ«</span><br><span class="line">mysql&gt; set global sql_log_bin=0;</span><br><span class="line">ERROR 1228 (HY000): Variable &#x27;sql_log_bin&#x27; is a SESSION variable and can`t be used</span><br><span class="line">with SET GLOBAL</span><br><span class="line"></span><br><span class="line"># sessionçº§åˆ«</span><br><span class="line">mysql&gt; SET sql_log_bin=0;</span><br><span class="line">Query OK, 0 rows affected (0.01 ç§’)</span><br></pre></td></tr></table></figure><h3 id="5-3-æŸ¥çœ‹æ—¥å¿—"><a href="#5-3-æŸ¥çœ‹æ—¥å¿—" class="headerlink" title="5.3 æŸ¥çœ‹æ—¥å¿—"></a>5.3 æŸ¥çœ‹æ—¥å¿—</h3><p>å½“MySQLåˆ›å»ºäºŒè¿›åˆ¶æ—¥å¿—æ–‡ä»¶æ—¶ï¼Œå…ˆåˆ›å»ºä¸€ä¸ªä»¥â€œfilenameâ€ä¸ºåç§°ã€ä»¥â€œ.indexâ€ä¸ºåç¼€çš„æ–‡ä»¶ï¼Œå†åˆ›å»ºä¸€ ä¸ªä»¥â€œfilenameâ€ä¸ºåç§°ã€ä»¥â€œ.000001â€ä¸ºåç¼€çš„æ–‡ä»¶ã€‚</p><p>MySQLæœåŠ¡ <code>é‡æ–°å¯åŠ¨ä¸€æ¬¡</code> ï¼Œä»¥â€œ.000001â€ä¸ºåç¼€çš„æ–‡ä»¶å°±ä¼šå¢åŠ ä¸€ä¸ªï¼Œå¹¶ä¸”åç¼€åæŒ‰1é€’å¢ã€‚å³æ—¥å¿—æ–‡ä»¶çš„ ä¸ªæ•°ä¸MySQLæœåŠ¡å¯åŠ¨çš„æ¬¡æ•°ç›¸åŒï¼›å¦‚æœæ—¥å¿—é•¿åº¦è¶…è¿‡äº† <code>max_binlog_size</code> çš„ä¸Šé™ï¼ˆé»˜è®¤æ˜¯1GBï¼‰ï¼Œå°±ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„æ—¥å¿—æ–‡ä»¶ã€‚</p><p>æŸ¥çœ‹å½“å‰çš„äºŒè¿›åˆ¶æ—¥å¿—æ–‡ä»¶åˆ—è¡¨åŠå¤§å°ã€‚æŒ‡ä»¤å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SHOW BINARY LOGS;</span><br><span class="line">+--------------------+-----------+-----------+</span><br><span class="line">| Log_name           | File_size | Encrypted |</span><br><span class="line">+--------------------+-----------+-----------+</span><br><span class="line">| atguigu-bin.000001 | 156       | No        |</span><br><span class="line">+--------------------+-----------+-----------+</span><br><span class="line">1 è¡Œäºæ•°æ®é›† (0.02 ç§’)</span><br></pre></td></tr></table></figure><p>æ‰€æœ‰å¯¹æ•°æ®åº“çš„ä¿®æ”¹éƒ½ä¼šè®°å½•åœ¨binlogä¸­ã€‚ä½†binlogæ˜¯äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæ— æ³•ç›´æ¥æŸ¥çœ‹ï¼Œæƒ³è¦æ›´ç›´è§‚çš„è§‚æµ‹å®ƒå°±è¦å€ŸåŠ©<code>mysqlbinlog</code>å‘½ä»¤å·¥å…·äº†ã€‚æŒ‡ä»¤å¦‚ä¸‹ï¼šåœ¨æŸ¥çœ‹æ‰§è¡Œï¼Œå…ˆæ‰§è¡Œä¸€æ¡SQLè¯­å¥ï¼Œå¦‚ä¸‹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">update student set name=&#x27;å¼ ä¸‰_back&#x27; where id=1;</span><br></pre></td></tr></table></figure><p>å¼€å§‹æŸ¥çœ‹binlog</p><img src="/2023/03/04/04-%E6%97%A5%E5%BF%97%E4%B8%8E%E5%A4%87%E4%BB%BD%E7%AF%87/image-20220715164718970.png" class=""><img src="/2023/03/04/04-%E6%97%A5%E5%BF%97%E4%B8%8E%E5%A4%87%E4%BB%BD%E7%AF%87/image-20220715164743351.png" class=""><img src="/2023/03/04/04-%E6%97%A5%E5%BF%97%E4%B8%8E%E5%A4%87%E4%BB%BD%E7%AF%87/image-20220715164809401.png" class=""><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">mysqlbinlog -v &quot;/var/lib/mysql/binlog/atguigu-bin.000002&quot;</span><br><span class="line">#220105 9:16:37 server id 1 end_log_pos 324 CRC32 0x6b31978b Query thread_id=10</span><br><span class="line">exec_time=0 error_code=0</span><br><span class="line">SET TIMESTAMP=1641345397/*!*/;</span><br><span class="line">SET @@session.pseudo_thread_id=10/*!*/;</span><br><span class="line">SET @@session.foreign_key_checks=1, @@session.sql_auto_is_null=0,</span><br><span class="line">@@session.unique_checks=1, @@session.autocommit=1/*!*/;</span><br><span class="line">SET @@session.sql_mode=1168113696/*!*/;</span><br><span class="line">SET @@session.auto_increment_increment=1, @@session.auto_increment_offset=1/*!*/;</span><br><span class="line">/*!\C utf8mb3 *//*!*/;</span><br><span class="line">SET</span><br><span class="line">@@session.character_set_client=33,@@session.collation_connection=33,@@session.collatio</span><br><span class="line">n_server=255/*!*/;</span><br><span class="line">SET @@session.lc_time_names=0/*!*/;</span><br><span class="line">SET @@session.collation_database=DEFAULT/*!*/;</span><br><span class="line">/*!80011 SET @@session.default_collation_for_utf8mb4=255*//*!*/;</span><br><span class="line">BEGIN</span><br><span class="line">/*!*/;</span><br><span class="line"># at 324</span><br><span class="line">#220105 9:16:37 server id 1 end_log_pos 391 CRC32 0x74f89890 Table_map:</span><br><span class="line">`atguigu14`.`student` mapped to number 85</span><br><span class="line"># at 391</span><br><span class="line">#220105 9:16:37 server id 1 end_log_pos 470 CRC32 0xc9920491 Update_rows: table id</span><br><span class="line">85 flags: STMT_END_F</span><br><span class="line"></span><br><span class="line">BINLOG &#x27;</span><br><span class="line">dfHUYRMBAAAAQwAAAIcBAAAAAFUAAAAAAAEACWF0Z3VpZ3UxNAAHc3R1ZGVudAADAw8PBDwAHgAG</span><br><span class="line">AQEAAgEhkJj4dA==</span><br><span class="line">dfHUYR8BAAAATwAAANYBAAAAAFUAAAAAAAEAAgAD//8AAQAAAAblvKDkuIkG5LiA54+tAAEAAAAL</span><br><span class="line">5byg5LiJX2JhY2sG5LiA54+tkQSSyQ==</span><br><span class="line">&#x27;/*!*/;</span><br><span class="line">### UPDATE `atguigu`.`student`</span><br><span class="line">### WHERE</span><br><span class="line">### @1=1</span><br><span class="line">### @2=&#x27;å¼ ä¸‰&#x27;</span><br><span class="line">### @3=&#x27;ä¸€ç­&#x27;</span><br><span class="line">### SET</span><br><span class="line">### @1=1</span><br><span class="line">### @2=&#x27;å¼ ä¸‰_back&#x27;</span><br><span class="line">### @3=&#x27;ä¸€ç­&#x27;</span><br><span class="line"># at 470</span><br><span class="line">#220105 9:16:37 server id 1 end_log_pos 501 CRC32 0xca01d30f Xid = 15</span><br><span class="line">COMMIT/*!*/;</span><br></pre></td></tr></table></figure><p>å‰é¢çš„å‘½ä»¤åŒæ—¶æ˜¾ç¤ºbinlogæ ¼å¼çš„è¯­å¥ï¼Œä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ä¸æ˜¾ç¤ºå®ƒ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">mysqlbinlog -v --base64-output=DECODE-ROWS &quot;/var/lib/mysql/binlog/atguigu-bin.000002&quot;</span><br><span class="line">#220105 9:16:37 server id 1 end_log_pos 324 CRC32 0x6b31978b Query thread_id=10</span><br><span class="line">exec_time=0 error_code=0</span><br><span class="line">SET TIMESTAMP=1641345397/*!*/;</span><br><span class="line">SET @@session.pseudo_thread_id=10/*!*/;</span><br><span class="line">SET @@session.foreign_key_checks=1, @@session.sql_auto_is_null=0,</span><br><span class="line">@@session.unique_checks=1, @@session.autocommit=1/*!*/;</span><br><span class="line">SET @@session.sql_mode=1168113696/*!*/;</span><br><span class="line">SET @@session.auto_increment_increment=1, @@session.auto_increment_offset=1/*!*/;</span><br><span class="line">/*!\C utf8mb3 *//*!*/;</span><br><span class="line">SET</span><br><span class="line">@@session.character_set_client=33,@@session.collation_connection=33,@@session.collatio</span><br><span class="line">n_server=255/*!*/;</span><br><span class="line">SET @@session.lc_time_names=0/*!*/;</span><br><span class="line">SET @@session.collation_database=DEFAULT/*!*/;</span><br><span class="line">/*!80011 SET @@session.default_collation_for_utf8mb4=255*//*!*/;</span><br><span class="line">BEGIN</span><br><span class="line">/*!*/;</span><br><span class="line"># at 324</span><br><span class="line">#220105 9:16:37 server id 1 end_log_pos 391 CRC32 0x74f89890 Table_map:</span><br><span class="line">`atguigu14`.`student` mapped to number 85</span><br><span class="line"># at 391</span><br><span class="line">#220105 9:16:37 server id 1 end_log_pos 470 CRC32 0xc9920491 Update_rows: table id</span><br><span class="line">85 flags: STMT_END_F</span><br><span class="line">### UPDATE `atguigu14`.`student`</span><br><span class="line">### WHERE</span><br><span class="line">### @1=1</span><br><span class="line">### @2=&#x27;å¼ ä¸‰&#x27;</span><br><span class="line">### @3=&#x27;ä¸€ç­&#x27;</span><br><span class="line">### SET</span><br><span class="line">### @1=1</span><br><span class="line">### @2=&#x27;å¼ ä¸‰_back&#x27;</span><br><span class="line">### @3=&#x27;ä¸€ç­&#x27;</span><br><span class="line"># at 470</span><br><span class="line">#220105 9:16:37 server id 1 end_log_pos 501 CRC32 0xca01d30f Xid = 15</span><br></pre></td></tr></table></figure><p>å…³äºmysqlbinlogå·¥å…·çš„ä½¿ç”¨æŠ€å·§è¿˜æœ‰å¾ˆå¤šï¼Œä¾‹å¦‚åªè§£æå¯¹æŸä¸ªåº“çš„æ“ä½œæˆ–è€…æŸä¸ªæ—¶é—´æ®µå†…çš„æ“ä½œç­‰ã€‚ç®€å•åˆ†äº«å‡ ä¸ªå¸¸ç”¨çš„è¯­å¥ï¼Œæ›´å¤šæ“ä½œå¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># å¯æŸ¥çœ‹å‚æ•°å¸®åŠ©</span><br><span class="line">mysqlbinlog --no-defaults --help</span><br><span class="line"># æŸ¥çœ‹æœ€å100è¡Œ</span><br><span class="line">mysqlbinlog --no-defaults --base64-output=decode-rows -vv atguigu-bin.000002 |tail</span><br><span class="line">-100</span><br><span class="line"># æ ¹æ®positionæŸ¥æ‰¾</span><br><span class="line">mysqlbinlog --no-defaults --base64-output=decode-rows -vv atguigu-bin.000002 |grep -A</span><br><span class="line">20 &#x27;4939002&#x27;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢è¿™ç§åŠæ³•è¯»å–å‡ºbinlogæ—¥å¿—çš„å…¨æ–‡å†…å®¹æ¯”è¾ƒå¤šï¼Œä¸å®¹æ˜“åˆ†è¾¨æŸ¥çœ‹åˆ°posç‚¹ä¿¡æ¯ï¼Œä¸‹é¢ä»‹ç»ä¸€ç§æ›´ä¸ºæ–¹ä¾¿çš„æŸ¥è¯¢å‘½ä»¤ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show binlog events [IN &#x27;log_name&#x27;] [FROM pos] [LIMIT [offset,] row_count];</span><br></pre></td></tr></table></figure><ul><li><code>IN &#39;log_name&#39;</code> ï¼šæŒ‡å®šè¦æŸ¥è¯¢çš„binlogæ–‡ä»¶åï¼ˆä¸æŒ‡å®šå°±æ˜¯ç¬¬ä¸€ä¸ªbinlogæ–‡ä»¶ï¼‰ã€€ </li><li><code>FROM pos</code> ï¼šæŒ‡å®šä»å“ªä¸ªposèµ·å§‹ç‚¹å¼€å§‹æŸ¥èµ·ï¼ˆä¸æŒ‡å®šå°±æ˜¯ä»æ•´ä¸ªæ–‡ä»¶é¦–ä¸ªposç‚¹å¼€å§‹ç®—ï¼‰ </li><li><code>LIMIT [offset]</code> ï¼šåç§»é‡(ä¸æŒ‡å®šå°±æ˜¯0) </li><li><code>row_count</code> :æŸ¥è¯¢æ€»æ¡æ•°ï¼ˆä¸æŒ‡å®šå°±æ˜¯æ‰€æœ‰è¡Œï¼‰</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show binlog events in &#x27;atguigu-bin.000002&#x27;;</span><br><span class="line">+--------------------+-----+----------------+-----------+-------------+--------------------------------------------------------+</span><br><span class="line">| Log_name           | Pos | Event_type     | Server_id | End_log_pos | Info                                                   |</span><br><span class="line">+--------------------+-----+----------------+-----------+-------------+--------------------------------------------------------+</span><br><span class="line">| atguigu-bin.000002 | 4   | Format_desc    | 1         | 125         | Server ver: 8.0.26, Binlog ver: 4                      |</span><br><span class="line">| atguigu-bin.000002 | 125 | Previous_gtids | 1         | 156         |                                                        |</span><br><span class="line">| atguigu-bin.000002 | 156 | Anonymous_Gtid | 1         | 235         | SET @@SESSION.GTID_NEXT= &#x27;ANONYMOUS&#x27;                   |</span><br><span class="line">| atguigu-bin.000002 | 235 | Query          | 1         | 324         | BEGIN                                                  |</span><br><span class="line">| atguigu-bin.000002 | 324 | Table_map      | 1         | 391         | table_id: 85(atguigu14.student)                        |</span><br><span class="line">| atguigu-bin.000002 | 391 | Update_rows    | 1         | 470         | table_id: 85flags: STMT_END_F                          |</span><br><span class="line">| atguigu-bin.000002 | 470 | Xid            | 1         | 501         | COMMIT /*xid=15 */                                     |</span><br><span class="line">| atguigu-bin.000002 | 501 | Anonymous_Gtid | 1         | 578         | SET @@SESSION.GTID_NEXT= &#x27;ANONYMOUS&#x27;                   |</span><br><span class="line">| atguigu-bin.000002 | 578 | Query     | 1 | 721 | use `atguigu14`; create table test(id int, title varchar(100)) /* xid=19 */ |</span><br><span class="line">| atguigu-bin.000002 | 721 | Anonymous_Gtid | 1         | 800         | SET @@SESSION.GTID_NEXT= &#x27;ANONYMOUS&#x27;                   |</span><br><span class="line">| atguigu-bin.000002 | 800 | Query          | 1         | 880         | BEGIN                                                  |</span><br><span class="line">| atguigu-bin.000002 | 880 | Table_map      | 1         | 943         | table_id: 89(atguigu14.test)                           |</span><br><span class="line">| atguigu-bin.000002 | 943 | Write_rows     | 1         | 992         | table_id: 89 flags: STMT_END_F                         |</span><br><span class="line">| atguigu-bin.000002 | 992 | Xid            | 1         | 1023        | COMMIT /*xid=21 */                                     |</span><br><span class="line">+--------------------+-----+----------------+-----------+-------------+--------------------------------------------------------+</span><br><span class="line">14 è¡Œäºæ•°æ®é›† (0.02 ç§’)</span><br></pre></td></tr></table></figure><img src="/2023/03/04/04-%E6%97%A5%E5%BF%97%E4%B8%8E%E5%A4%87%E4%BB%BD%E7%AF%87/image-20220715165603879.png" class=""><p>ä¸Šé¢æˆ‘ä»¬è®²äº†è¿™ä¹ˆå¤šéƒ½æ˜¯åŸºäºbinlogçš„é»˜è®¤æ ¼å¼ï¼Œbinlogæ ¼å¼æŸ¥çœ‹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like &#x27;binlog_format&#x27;;</span><br><span class="line">+---------------+-------+</span><br><span class="line">| Variable_name | Value |</span><br><span class="line">+---------------+-------+</span><br><span class="line">| binlog_format | ROW   |</span><br><span class="line">+---------------+-------+</span><br><span class="line">1 è¡Œäºæ•°æ®é›† (0.02 ç§’)</span><br></pre></td></tr></table></figure><p>é™¤æ­¤ä¹‹å¤–ï¼Œbinlogè¿˜æœ‰2ç§æ ¼å¼ï¼Œåˆ†åˆ«æ˜¯<code>Statement</code>å’Œ<code>Mixed</code></p><ul><li><p>Statement</p><p>æ¯ä¸€æ¡ä¼šä¿®æ”¹æ•°æ®çš„sqléƒ½ä¼šè®°å½•åœ¨binlogä¸­ã€‚</p><p>ä¼˜ç‚¹ï¼šä¸éœ€è¦è®°å½•æ¯ä¸€è¡Œçš„å˜åŒ–ï¼Œå‡å°‘äº†binlogæ—¥å¿—é‡ï¼ŒèŠ‚çº¦äº†IOï¼Œæé«˜æ€§èƒ½ã€‚</p></li><li><p>Row</p><p>5.1.5ç‰ˆæœ¬çš„MySQLæ‰å¼€å§‹æ”¯æŒrow level çš„å¤åˆ¶ï¼Œå®ƒä¸è®°å½•sqlè¯­å¥ä¸Šä¸‹æ–‡ç›¸å…³ä¿¡æ¯ï¼Œä»…ä¿å­˜å“ªæ¡è®°å½•è¢«ä¿®æ”¹ã€‚</p><p>ä¼˜ç‚¹ï¼šrow level çš„æ—¥å¿—å†…å®¹ä¼šéå¸¸æ¸…æ¥šçš„è®°å½•ä¸‹æ¯ä¸€è¡Œæ•°æ®ä¿®æ”¹çš„ç»†èŠ‚ã€‚è€Œä¸”ä¸ä¼šå‡ºç°æŸäº›ç‰¹å®šæƒ…å†µä¸‹ çš„å­˜å‚¨è¿‡ç¨‹ï¼Œæˆ–functionï¼Œä»¥åŠtriggerçš„è°ƒç”¨å’Œè§¦å‘æ— æ³•è¢«æ­£ç¡®å¤åˆ¶çš„é—®é¢˜ã€‚</p></li><li><p>Mixed</p><p>ä»5.1.8ç‰ˆæœ¬å¼€å§‹ï¼ŒMySQLæä¾›äº†Mixedæ ¼å¼ï¼Œå®é™…ä¸Šå°±æ˜¯Statementä¸Rowçš„ç»“åˆã€‚</p><p>è¯¦ç»†æƒ…å†µï¼Œä¸‹ç« è®²è§£ã€‚</p></li></ul><h3 id="5-4-ä½¿ç”¨æ—¥å¿—æ¢å¤æ•°æ®"><a href="#5-4-ä½¿ç”¨æ—¥å¿—æ¢å¤æ•°æ®" class="headerlink" title="5.4 ä½¿ç”¨æ—¥å¿—æ¢å¤æ•°æ®"></a>5.4 ä½¿ç”¨æ—¥å¿—æ¢å¤æ•°æ®</h3><p>å¦‚æœMySQLæœåŠ¡å™¨å¯ç”¨äº†äºŒè¿›åˆ¶æ—¥å¿—ï¼Œåœ¨æ•°æ®åº“å‡ºç°æ„å¤–ä¸¢å¤±æ•°æ®æ—¶ï¼Œå¯ä»¥ä½¿ç”¨MySQLbinlogå·¥å…·ä»æŒ‡å®šçš„æ—¶é—´ç‚¹å¼€å§‹ï¼ˆä¾‹å¦‚ï¼Œæœ€åä¸€æ¬¡å¤‡ä»½ï¼‰ç›´åˆ°ç°åœ¨æˆ–å¦ä¸€ä¸ªæŒ‡å®šçš„æ—¶é—´ç‚¹çš„æ—¥å¿—ä¸­å›å¤æ•°æ®ã€‚</p><p>mysqlbinlogæ¢å¤æ•°æ®çš„è¯­æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqlbinlog [option] filename|mysql â€“uuser -ppass;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªå‘½ä»¤å¯ä»¥è¿™æ ·ç†è§£ï¼šä½¿ç”¨mysqlbinlogå‘½ä»¤æ¥è¯»å–filenameä¸­çš„å†…å®¹ï¼Œç„¶åä½¿ç”¨mysqlå‘½ä»¤å°†è¿™äº›å†…å®¹æ¢å¤åˆ°æ•°æ®åº“ä¸­ã€‚</p><ul><li><p><code>filename</code> ï¼šæ˜¯æ—¥å¿—æ–‡ä»¶åã€‚</p></li><li><p><code>option</code> ï¼šå¯é€‰é¡¹ï¼Œæ¯”è¾ƒé‡è¦çš„ä¸¤å¯¹optionå‚æ•°æ˜¯â€“start-dateã€â€“stop-date å’Œ â€“start-positionã€â€“ stop-positionã€‚</p><ul><li><code>--start-date</code> å’Œ<code> --stop-date</code> ï¼šå¯ä»¥æŒ‡å®šæ¢å¤æ•°æ®åº“çš„èµ·å§‹æ—¶é—´ç‚¹å’Œç»“æŸæ—¶é—´ç‚¹ã€‚</li><li><code>--start-position</code>å’Œ<code>--stop-position</code> ï¼šå¯ä»¥æŒ‡å®šæ¢å¤æ•°æ®çš„å¼€å§‹ä½ç½®å’Œç»“æŸä½ç½®ã€‚</li></ul></li></ul><blockquote><p>æ³¨æ„ï¼šä½¿ç”¨mysqlbinlogå‘½ä»¤è¿›è¡Œæ¢å¤æ“ä½œæ—¶ï¼Œå¿…é¡»æ˜¯ç¼–å·å°çš„å…ˆæ¢å¤ï¼Œä¾‹å¦‚atguigu-bin.000001å¿…é¡»åœ¨atguigu-bin.000002ä¹‹å‰æ¢å¤ã€‚</p></blockquote><p>è¯¦è§p189ï¼Œç”±äºç¿»é¡µè¿‡å¿«ï¼Œè¿™éƒ¨åˆ†æ²¡åŠæ³•è®°å½•ã€‚</p><h3 id="5-5-åˆ é™¤äºŒè¿›åˆ¶æ—¥å¿—"><a href="#5-5-åˆ é™¤äºŒè¿›åˆ¶æ—¥å¿—" class="headerlink" title="5.5 åˆ é™¤äºŒè¿›åˆ¶æ—¥å¿—"></a>5.5 åˆ é™¤äºŒè¿›åˆ¶æ—¥å¿—</h3><p>MySQLçš„äºŒè¿›åˆ¶æ–‡ä»¶å¯ä»¥é…ç½®è‡ªåŠ¨åˆ é™¤ï¼ŒåŒæ—¶MySQLä¹Ÿæä¾›äº†å®‰å…¨çš„æ‰‹åŠ¨åˆ é™¤äºŒè¿›åˆ¶æ–‡ä»¶çš„æ–¹æ³•ã€‚ <code>PURGE MASTER LOGS</code> åªåˆ é™¤æŒ‡å®šéƒ¨åˆ†çš„äºŒè¿›åˆ¶æ—¥å¿—æ–‡ä»¶ï¼Œ <code>RESET MASTER</code> åˆ é™¤æ‰€æœ‰çš„äºŒè¿›åˆ¶æ—¥å¿—æ–‡ ä»¶ã€‚å…·ä½“å¦‚ä¸‹ï¼š</p><p><strong>1. PURGE MASTER LOGSï¼šåˆ é™¤æŒ‡å®šæ—¥å¿—æ–‡ä»¶</strong></p><p>PURGE MASTER LOGSè¯­æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PURGE &#123;MASTER | BINARY&#125; LOGS TO â€˜æŒ‡å®šæ—¥å¿—æ–‡ä»¶åâ€™</span><br><span class="line">PURGE &#123;MASTER | BINARY&#125; LOGS BEFORE â€˜æŒ‡å®šæ—¥æœŸâ€™</span><br></pre></td></tr></table></figure><img src="/2023/03/04/04-%E6%97%A5%E5%BF%97%E4%B8%8E%E5%A4%87%E4%BB%BD%E7%AF%87/image-20220715171712026.png" class=""><img src="/2023/03/04/04-%E6%97%A5%E5%BF%97%E4%B8%8E%E5%A4%87%E4%BB%BD%E7%AF%87/image-20220715172015185.png" class=""><p><strong>2. RESET MASTER: åˆ é™¤æ‰€æœ‰äºŒè¿›åˆ¶æ—¥å¿—æ–‡ä»¶</strong></p><img src="/2023/03/04/04-%E6%97%A5%E5%BF%97%E4%B8%8E%E5%A4%87%E4%BB%BD%E7%AF%87/image-20220715172104967.png" class=""><h3 id="5-6-å…¶å®ƒåœºæ™¯"><a href="#5-6-å…¶å®ƒåœºæ™¯" class="headerlink" title="5.6 å…¶å®ƒåœºæ™¯"></a>5.6 å…¶å®ƒåœºæ™¯</h3><p>äºŒè¿›åˆ¶æ—¥å¿—å¯ä»¥é€šè¿‡æ•°æ®åº“çš„ <code>å…¨é‡å¤‡ä»½</code> å’ŒäºŒè¿›åˆ¶æ—¥å¿—ä¸­ä¿å­˜çš„ <code>å¢é‡ä¿¡æ¯</code> ï¼Œå®Œæˆæ•°æ®åº“çš„ <code>æ— æŸå¤±æ¢å¤</code> ã€‚ ä½†æ˜¯ï¼Œå¦‚æœé‡åˆ°æ•°æ®é‡å¤§ã€æ•°æ®åº“å’Œæ•°æ®è¡¨å¾ˆå¤šï¼ˆæ¯”å¦‚åˆ†åº“åˆ†è¡¨çš„åº”ç”¨ï¼‰çš„åœºæ™¯ï¼Œç”¨äºŒè¿›åˆ¶æ—¥å¿—è¿›è¡Œæ•°æ®æ¢å¤ï¼Œæ˜¯å¾ˆæœ‰æŒ‘æˆ˜æ€§çš„ï¼Œå› ä¸ºèµ·æ­¢ä½ç½®ä¸å®¹æ˜“ç®¡ç†ã€‚</p><p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä¸€ä¸ªæœ‰æ•ˆçš„è§£å†³åŠæ³•æ˜¯ <code>é…ç½®ä¸»ä»æ•°æ®åº“æœåŠ¡å™¨</code> ï¼Œç”šè‡³æ˜¯ <code>ä¸€ä¸»å¤šä»</code> çš„æ¶æ„ï¼ŒæŠŠäºŒè¿›åˆ¶æ—¥å¿—æ–‡ä»¶çš„å†…å®¹é€šè¿‡ä¸­ç»§æ—¥å¿—ï¼ŒåŒæ­¥åˆ°ä»æ•°æ®åº“æœåŠ¡å™¨ä¸­ï¼Œè¿™æ ·å°±å¯ä»¥æœ‰æ•ˆé¿å…æ•°æ®åº“æ•…éšœå¯¼è‡´çš„æ•°æ®å¼‚å¸¸ç­‰é—®é¢˜ã€‚</p><h2 id="6-å†è°ˆäºŒè¿›åˆ¶æ—¥å¿—-binlog"><a href="#6-å†è°ˆäºŒè¿›åˆ¶æ—¥å¿—-binlog" class="headerlink" title="6. å†è°ˆäºŒè¿›åˆ¶æ—¥å¿—(binlog)"></a>6. å†è°ˆäºŒè¿›åˆ¶æ—¥å¿—(binlog)</h2><h3 id="6-1-å†™å…¥æœºåˆ¶"><a href="#6-1-å†™å…¥æœºåˆ¶" class="headerlink" title="6.1 å†™å…¥æœºåˆ¶"></a>6.1 å†™å…¥æœºåˆ¶</h3><p>binlogçš„å†™å…¥æ—¶æœºä¹Ÿéå¸¸ç®€å•ï¼Œäº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå…ˆæŠŠæ—¥å¿—å†™åˆ° <code>binlog cache</code> ï¼Œäº‹åŠ¡æäº¤çš„æ—¶å€™ï¼Œå†æŠŠbinlog cacheå†™åˆ°binlogæ–‡ä»¶ä¸­ã€‚å› ä¸ºä¸€ä¸ªäº‹åŠ¡çš„binlogä¸èƒ½è¢«æ‹†å¼€ï¼Œæ— è®ºè¿™ä¸ªäº‹åŠ¡å¤šå¤§ï¼Œä¹Ÿè¦ç¡®ä¿ä¸€æ¬¡æ€§å†™å…¥ï¼Œæ‰€ä»¥ç³»ç»Ÿä¼šç»™æ¯ä¸ªçº¿ç¨‹åˆ†é…ä¸€ä¸ªå—å†…å­˜ä½œä¸ºbinlog cacheã€‚</p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡<code>binlog_cache_size</code>å‚æ•°æ§åˆ¶å•ä¸ªçº¿ç¨‹ binlog cache å¤§å°ï¼Œå¦‚æœå­˜å‚¨å†…å®¹è¶…è¿‡äº†è¿™ä¸ªå‚æ•°ï¼Œå°±è¦æš‚å­˜åˆ°ç£ç›˜ï¼ˆSwapï¼‰ã€‚binlogæ—¥å¿—åˆ·ç›˜æµç¨‹å¦‚ä¸‹ï¼š</p><img src="/2023/03/04/04-%E6%97%A5%E5%BF%97%E4%B8%8E%E5%A4%87%E4%BB%BD%E7%AF%87/image-20220715172958729.png" class=""><blockquote><ul><li>ä¸Šå›¾çš„writeï¼Œæ˜¯æŒ‡æŠŠæ—¥å¿—å†™å…¥åˆ°æ–‡ä»¶ç³»ç»Ÿçš„page cacheï¼Œå¹¶æ²¡æœ‰æŠŠæ•°æ®æŒä¹…åŒ–åˆ°ç£ç›˜ï¼Œæ‰€ä»¥é€Ÿåº¦æ¯”è¾ƒå¿«</li><li>ä¸Šå›¾çš„fsyncï¼Œæ‰æ˜¯å°†æ•°æ®æŒä¹…åŒ–åˆ°ç£ç›˜çš„æ“ä½œ</li></ul></blockquote><p>writeå’Œfsyncçš„æ—¶æœºï¼Œå¯ä»¥ç”±å‚æ•° <code>sync_binlog</code> æ§åˆ¶ï¼Œé»˜è®¤æ˜¯ <code>0</code> ã€‚ä¸º0çš„æ—¶å€™ï¼Œè¡¨ç¤ºæ¯æ¬¡æäº¤äº‹åŠ¡éƒ½åª writeï¼Œç”±ç³»ç»Ÿè‡ªè¡Œåˆ¤æ–­ä»€ä¹ˆæ—¶å€™æ‰§è¡Œfsyncã€‚è™½ç„¶æ€§èƒ½å¾—åˆ°æå‡ï¼Œä½†æ˜¯æœºå™¨å®•æœºï¼Œpage cacheé‡Œé¢çš„ binglog ä¼šä¸¢å¤±ã€‚å¦‚ä¸‹å›¾ï¼š</p><img src="/2023/03/04/04-%E6%97%A5%E5%BF%97%E4%B8%8E%E5%A4%87%E4%BB%BD%E7%AF%87/image-20220715193749462.png" class=""><p>ä¸ºäº†å®‰å…¨èµ·è§ï¼Œå¯ä»¥è®¾ç½®ä¸º <code>1</code> ï¼Œè¡¨ç¤ºæ¯æ¬¡æäº¤äº‹åŠ¡éƒ½ä¼šæ‰§è¡Œfsyncï¼Œå°±å¦‚åŒ<strong>redo log åˆ·ç›˜æµç¨‹</strong>ä¸€æ ·ã€‚ æœ€åè¿˜æœ‰ä¸€ç§æŠ˜ä¸­æ–¹å¼ï¼Œå¯ä»¥è®¾ç½®ä¸ºN(N&gt;1)ï¼Œè¡¨ç¤ºæ¯æ¬¡æäº¤äº‹åŠ¡éƒ½writeï¼Œä½†ç´¯ç§¯Nä¸ªäº‹åŠ¡åæ‰fsyncã€‚</p><img src="/2023/03/04/04-%E6%97%A5%E5%BF%97%E4%B8%8E%E5%A4%87%E4%BB%BD%E7%AF%87/image-20220715194624080.png" class=""><p>åœ¨å‡ºç°IOç“¶é¢ˆçš„åœºæ™¯é‡Œï¼Œå°†sync_binlogè®¾ç½®æˆä¸€ä¸ªæ¯”è¾ƒå¤§çš„å€¼ï¼Œå¯ä»¥æå‡æ€§èƒ½ã€‚åŒæ ·çš„ï¼Œå¦‚æœæœºå™¨å®•æœºï¼Œä¼šä¸¢å¤±æœ€è¿‘Nä¸ªäº‹åŠ¡çš„binlogæ—¥å¿—ã€‚</p><h3 id="6-2-binlogä¸redologå¯¹æ¯”"><a href="#6-2-binlogä¸redologå¯¹æ¯”" class="headerlink" title="6.2 binlogä¸redologå¯¹æ¯”"></a>6.2 binlogä¸redologå¯¹æ¯”</h3><ul><li>redo log å®ƒæ˜¯ <code>ç‰©ç†æ—¥å¿—</code> ï¼Œè®°å½•å†…å®¹æ˜¯â€œåœ¨æŸä¸ªæ•°æ®é¡µä¸Šåšäº†ä»€ä¹ˆä¿®æ”¹â€ï¼Œå±äº InnoDB å­˜å‚¨å¼•æ“å±‚äº§ç”Ÿçš„ã€‚</li><li>è€Œ binlog æ˜¯ <code>é€»è¾‘æ—¥å¿—</code> ï¼Œè®°å½•å†…å®¹æ˜¯è¯­å¥çš„åŸå§‹é€»è¾‘ï¼Œç±»ä¼¼äºâ€œç»™ ID&#x3D;2 è¿™ä¸€è¡Œçš„ c å­—æ®µåŠ  1â€ï¼Œå±äº MySQL Server å±‚ã€‚</li><li>è™½ç„¶å®ƒä»¬éƒ½å±äºæŒä¹…åŒ–çš„ä¿è¯ï¼Œä½†æ˜¯ä¾§é‡ç‚¹ä¸åŒã€‚<ul><li>redo logè®©InnoDBå­˜å‚¨å¼•æ“æ‹¥æœ‰äº†å´©æºƒæ¢å¤èƒ½åŠ›ã€‚</li><li>binlogä¿è¯äº†MySQLé›†ç¾¤æ¶æ„çš„æ•°æ®ä¸€è‡´æ€§ã€‚</li></ul></li></ul><h3 id="6-3-ä¸¤é˜¶æ®µæäº¤"><a href="#6-3-ä¸¤é˜¶æ®µæäº¤" class="headerlink" title="6.3 ä¸¤é˜¶æ®µæäº¤"></a>6.3 ä¸¤é˜¶æ®µæäº¤</h3><p>åœ¨æ‰§è¡Œæ›´æ–°è¯­å¥è¿‡ç¨‹ï¼Œä¼šè®°å½•redo logä¸binlogä¸¤å—æ—¥å¿—ï¼Œä»¥åŸºæœ¬çš„äº‹åŠ¡ä¸ºå•ä½ï¼Œredo logåœ¨äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­å¯ä»¥ä¸æ–­å†™å…¥ï¼Œè€Œbinlogåªæœ‰åœ¨æäº¤äº‹åŠ¡æ—¶æ‰å†™å…¥ï¼Œæ‰€ä»¥redo logä¸binlogçš„ <code>å†™å…¥æ—¶æœº</code> ä¸ä¸€æ ·ã€‚</p><img src="/2023/03/04/04-%E6%97%A5%E5%BF%97%E4%B8%8E%E5%A4%87%E4%BB%BD%E7%AF%87/image-20220715194959405.png" class=""><p><strong>redo logä¸binlogä¸¤ä»½æ—¥å¿—ä¹‹é—´çš„é€»è¾‘ä¸ä¸€è‡´ï¼Œä¼šå‡ºç°ä»€ä¹ˆé—®é¢˜ï¼Ÿ</strong></p><p>ä»¥updateè¯­å¥ä¸ºä¾‹ï¼Œå‡è®¾<code>id=2</code>çš„è®°å½•ï¼Œå­—æ®µ<code>c</code>å€¼æ˜¯<code>0</code>ï¼ŒæŠŠå­—æ®µcå€¼æ›´æ–°ä¸º<code>1</code>ï¼ŒSQLè¯­å¥ä¸ºupdate T set c &#x3D; 1 where id &#x3D; 2ã€‚</p><p>å‡è®¾æ‰§è¡Œè¿‡ç¨‹ä¸­å†™å®Œredo logæ—¥å¿—åï¼Œbinlogæ—¥å¿—å†™æœŸé—´å‘ç”Ÿäº†å¼‚å¸¸ï¼Œä¼šå‡ºç°ä»€ä¹ˆæƒ…å†µå‘¢ï¼Ÿ</p><img src="/2023/03/04/04-%E6%97%A5%E5%BF%97%E4%B8%8E%E5%A4%87%E4%BB%BD%E7%AF%87/image-20220715195016492.png" class=""><p>ç”±äºbinlogæ²¡å†™å®Œå°±å¼‚å¸¸ï¼Œè¿™æ—¶å€™binlogé‡Œé¢æ²¡æœ‰å¯¹åº”çš„ä¿®æ”¹è®°å½•ã€‚å› æ­¤ï¼Œä¹‹åç”¨binlogæ—¥å¿—æ¢å¤æ•°æ®æ—¶ï¼Œå°±ä¼šå°‘è¿™ä¸€æ¬¡æ›´æ–°ï¼Œæ¢å¤å‡ºæ¥çš„è¿™ä¸€è¡Œcå€¼ä¸º0ï¼Œè€ŒåŸåº“å› ä¸ºredo logæ—¥å¿—æ¢å¤ï¼Œè¿™ä¸€è¡Œcçš„å€¼æ˜¯1ï¼Œæœ€ç»ˆæ•°æ®ä¸ä¸€è‡´ã€‚</p><img src="/2023/03/04/04-%E6%97%A5%E5%BF%97%E4%B8%8E%E5%A4%87%E4%BB%BD%E7%AF%87/image-20220715195521986.png" class=""><p>ä¸ºäº†è§£å†³ä¸¤ä»½æ—¥å¿—ä¹‹é—´çš„é€»è¾‘ä¸€è‡´é—®é¢˜ï¼ŒInnoDBå­˜å‚¨å¼•æ“ä½¿ç”¨<strong>ä¸¤é˜¶æ®µæäº¤</strong>æ–¹æ¡ˆã€‚åŸç†å¾ˆç®€å•ï¼Œå°†redo logçš„å†™å…¥æ‹†æˆäº†ä¸¤ä¸ªæ­¥éª¤prepareå’Œcommitï¼Œè¿™å°±æ˜¯<strong>ä¸¤é˜¶æ®µæäº¤</strong>ã€‚</p><img src="/2023/03/04/04-%E6%97%A5%E5%BF%97%E4%B8%8E%E5%A4%87%E4%BB%BD%E7%AF%87/image-20220715195635196.png" class=""><p>ä½¿ç”¨ä¸¤é˜¶æ®µæäº¤åï¼Œå†™å…¥binlogæ—¶å‘ç”Ÿå¼‚å¸¸ä¹Ÿä¸ä¼šæœ‰å½±å“ï¼Œå› ä¸ºMySQLæ ¹æ®redo logæ—¥å¿—æ¢å¤æ•°æ®æ—¶ï¼Œå‘ç°redo logè¿˜å¤„äºprepareé˜¶æ®µï¼Œå¹¶ä¸”æ²¡æœ‰å¯¹åº”binlogæ—¥å¿—ï¼Œå°±ä¼šå›æ»šè¯¥äº‹åŠ¡ã€‚</p><img src="/2023/03/04/04-%E6%97%A5%E5%BF%97%E4%B8%8E%E5%A4%87%E4%BB%BD%E7%AF%87/image-20220715200248193.png" class=""><p>å¦ä¸€ä¸ªåœºæ™¯ï¼Œredo logè®¾ç½®commité˜¶æ®µå‘ç”Ÿå¼‚å¸¸ï¼Œé‚£ä¼šä¸ä¼šå›æ»šäº‹åŠ¡å‘¢ï¼Ÿ</p><img src="/2023/03/04/04-%E6%97%A5%E5%BF%97%E4%B8%8E%E5%A4%87%E4%BB%BD%E7%AF%87/image-20220715200321717.png" class=""><p>å¹¶ä¸ä¼šå›æ»šäº‹åŠ¡ï¼Œå®ƒä¼šæ‰§è¡Œä¸Šå›¾æ¡†ä½çš„é€»è¾‘ï¼Œè™½ç„¶redo logæ˜¯å¤„äºprepareé˜¶æ®µï¼Œä½†æ˜¯èƒ½é€šè¿‡äº‹åŠ¡idæ‰¾åˆ°å¯¹åº”çš„binlogæ—¥å¿—ï¼Œæ‰€ä»¥MySQLè®¤ä¸ºæ˜¯å®Œæ•´çš„ï¼Œå°±ä¼šæäº¤äº‹åŠ¡æ¢å¤æ•°æ®ã€‚</p><h2 id="7-ä¸­ç»§æ—¥å¿—-relay-log"><a href="#7-ä¸­ç»§æ—¥å¿—-relay-log" class="headerlink" title="7. ä¸­ç»§æ—¥å¿—(relay log)"></a>7. ä¸­ç»§æ—¥å¿—(relay log)</h2><h3 id="7-1-ä»‹ç»"><a href="#7-1-ä»‹ç»" class="headerlink" title="7.1 ä»‹ç»"></a>7.1 ä»‹ç»</h3><p><strong>ä¸­ç»§æ—¥å¿—åªåœ¨ä¸»ä»æœåŠ¡å™¨æ¶æ„çš„ä»æœåŠ¡å™¨ä¸Šå­˜åœ¨</strong>ã€‚ä»æœåŠ¡å™¨ä¸ºäº†ä¸ä¸»æœåŠ¡å™¨ä¿æŒä¸€è‡´ï¼Œè¦ä»ä¸»æœåŠ¡å™¨è¯»å–äºŒè¿›åˆ¶æ—¥å¿—çš„å†…å®¹ï¼Œå¹¶ä¸”æŠŠè¯»å–åˆ°çš„ä¿¡æ¯å†™å…¥ <code>æœ¬åœ°çš„æ—¥å¿—æ–‡ä»¶</code> ä¸­ï¼Œè¿™ä¸ªä»æœåŠ¡å™¨æœ¬åœ°çš„æ—¥å¿—æ–‡ä»¶å°±å« <code>ä¸­ç»§æ—¥å¿—</code> ã€‚ç„¶åï¼Œä»æœåŠ¡å™¨è¯»å–ä¸­ç»§æ—¥å¿—ï¼Œå¹¶æ ¹æ®ä¸­ç»§æ—¥å¿—çš„å†…å®¹å¯¹ä»æœåŠ¡å™¨çš„æ•°æ®è¿›è¡Œæ›´æ–°ï¼Œå®Œæˆä¸» ä»æœåŠ¡å™¨çš„ æ•°æ®åŒæ­¥ ã€‚</p><p>æ­å»ºå¥½ä¸»ä»æœåŠ¡å™¨ä¹‹åï¼Œä¸­ç»§æ—¥å¿—é»˜è®¤ä¼šä¿å­˜åœ¨ä»æœåŠ¡å™¨çš„æ•°æ®ç›®å½•ä¸‹ã€‚</p><p>æ–‡ä»¶åçš„æ ¼å¼æ˜¯ï¼š<code> ä»æœåŠ¡å™¨å -relay-bin.åºå·</code> ã€‚ä¸­ç»§æ—¥å¿—è¿˜æœ‰ä¸€ä¸ªç´¢å¼•æ–‡ä»¶ï¼š<code>ä»æœåŠ¡å™¨å -relaybin.index</code> ï¼Œç”¨æ¥å®šä½å½“å‰æ­£åœ¨ä½¿ç”¨çš„ä¸­ç»§æ—¥å¿—ã€‚</p><h3 id="7-2-æŸ¥çœ‹ä¸­ç»§æ—¥å¿—"><a href="#7-2-æŸ¥çœ‹ä¸­ç»§æ—¥å¿—" class="headerlink" title="7.2 æŸ¥çœ‹ä¸­ç»§æ—¥å¿—"></a>7.2 æŸ¥çœ‹ä¸­ç»§æ—¥å¿—</h3><p>ä¸­ç»§æ—¥å¿—ä¸äºŒè¿›åˆ¶æ—¥å¿—çš„æ ¼å¼ç›¸åŒï¼Œå¯ä»¥ç”¨ <code>mysqlbinlog</code> å·¥å…·è¿›è¡ŒæŸ¥çœ‹ã€‚ä¸‹é¢æ˜¯ä¸­ç»§æ—¥å¿—çš„ä¸€ä¸ªç‰‡æ®µï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">SET TIMESTAMP=1618558728/*!*/;</span><br><span class="line">BEGIN</span><br><span class="line">/*!*/;</span><br><span class="line"># at 950</span><br><span class="line">#210416 15:38:48 server id 1 end_log_pos 832 CRC32 0xcc16d651 Table_map:</span><br><span class="line">`atguigu`.`test` mapped to number 91</span><br><span class="line"># at 1000</span><br><span class="line">#210416 15:38:48 server id 1 end_log_pos 872 CRC32 0x07e4047c Delete_rows: table id</span><br><span class="line">91 flags: STMT_END_F -- server id 1 æ˜¯ä¸»æœåŠ¡å™¨ï¼Œæ„æ€æ˜¯ä¸»æœåŠ¡å™¨åˆ äº†ä¸€è¡Œæ•°æ®</span><br><span class="line">BINLOG &#x27;</span><br><span class="line">CD95YBMBAAAAMgAAAEADAAAAAFsAAAAAAAEABGRlbW8ABHRlc3QAAQMAAQEBAFHWFsw=</span><br><span class="line">CD95YCABAAAAKAAAAGgDAAAAAFsAAAAAAAEAAgAB/wABAAAAfATkBw==</span><br><span class="line">&#x27;/*!*/;</span><br><span class="line"># at 1040</span><br></pre></td></tr></table></figure><p>è¿™ä¸€æ®µçš„æ„æ€æ˜¯ï¼Œä¸»æœåŠ¡å™¨ï¼ˆâ€œserver id 1â€ï¼‰å¯¹è¡¨ atguigu.test è¿›è¡Œäº† 2 æ­¥æ“ä½œï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">å®šä½åˆ°è¡¨ atguigu.test ç¼–å·æ˜¯ 91 çš„è®°å½•ï¼Œæ—¥å¿—ä½ç½®æ˜¯ 832ï¼›</span><br><span class="line">åˆ é™¤ç¼–å·æ˜¯ 91 çš„è®°å½•ï¼Œæ—¥å¿—ä½ç½®æ˜¯ 872</span><br></pre></td></tr></table></figure><h3 id="7-3-æ¢å¤çš„å…¸å‹é”™è¯¯"><a href="#7-3-æ¢å¤çš„å…¸å‹é”™è¯¯" class="headerlink" title="7.3 æ¢å¤çš„å…¸å‹é”™è¯¯"></a>7.3 æ¢å¤çš„å…¸å‹é”™è¯¯</h3><p>å¦‚æœä»æœåŠ¡å™¨å®•æœºï¼Œæœ‰çš„æ—¶å€™ä¸ºäº†ç³»ç»Ÿæ¢å¤ï¼Œè¦é‡è£…æ“ä½œç³»ç»Ÿï¼Œè¿™æ ·å°±å¯èƒ½ä¼šå¯¼è‡´ä½ çš„ <code>æœåŠ¡å™¨åç§°</code> ä¸ä¹‹å‰ <code>ä¸åŒ</code> ã€‚è€Œä¸­ç»§æ—¥å¿—é‡Œæ˜¯ <code>åŒ…å«ä»æœåŠ¡å™¨å</code> çš„ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå°±å¯èƒ½å¯¼è‡´ä½ æ¢å¤ä»æœåŠ¡å™¨çš„æ—¶å€™ï¼Œæ— æ³• ä»å®•æœºå‰çš„ä¸­ç»§æ—¥å¿—é‡Œè¯»å–æ•°æ®ï¼Œä»¥ä¸ºæ˜¯æ—¥å¿—æ–‡ä»¶æŸåäº†ï¼Œå…¶å®æ˜¯åç§°ä¸å¯¹äº†ã€‚</p><p>è§£å†³çš„æ–¹æ³•ä¹Ÿå¾ˆç®€å•ï¼ŒæŠŠä»æœåŠ¡å™¨çš„åç§°æ”¹å›ä¹‹å‰çš„åç§°ã€‚</p><h1 id="ç¬¬18ç« -ä¸»ä»å¤åˆ¶"><a href="#ç¬¬18ç« -ä¸»ä»å¤åˆ¶" class="headerlink" title="ç¬¬18ç« _ä¸»ä»å¤åˆ¶"></a>ç¬¬18ç« _ä¸»ä»å¤åˆ¶</h1><h2 id="1-ä¸»ä»å¤åˆ¶æ¦‚è¿°"><a href="#1-ä¸»ä»å¤åˆ¶æ¦‚è¿°" class="headerlink" title="1. ä¸»ä»å¤åˆ¶æ¦‚è¿°"></a>1. ä¸»ä»å¤åˆ¶æ¦‚è¿°</h2><h3 id="1-1-å¦‚ä½•æå‡æ•°æ®åº“å¹¶å‘èƒ½åŠ›"><a href="#1-1-å¦‚ä½•æå‡æ•°æ®åº“å¹¶å‘èƒ½åŠ›" class="headerlink" title="1.1 å¦‚ä½•æå‡æ•°æ®åº“å¹¶å‘èƒ½åŠ›"></a>1.1 å¦‚ä½•æå‡æ•°æ®åº“å¹¶å‘èƒ½åŠ›</h3><p>åœ¨å®é™…å·¥ä½œä¸­ï¼Œæˆ‘ä»¬å¸¸å¸¸å°†<code>Redis</code>ä½œä¸ºç¼“å­˜ä¸<code>MySQL</code>é…åˆæ¥ä½¿ç”¨ï¼Œå½“æœ‰è¯·æ±‚çš„æ—¶å€™ï¼Œé¦–å…ˆä¼šä»ç¼“å­˜ä¸­è¿›è¡ŒæŸ¥æ‰¾ï¼Œå¦‚æœå­˜åœ¨å°±ç›´æ¥å–å‡ºã€‚å¦‚æœä¸å­˜åœ¨å†è®¿é—®æ•°æ®åº“ï¼Œè¿™æ ·å°±<code>æå‡äº†è¯»å–çš„æ•ˆç‡</code>ï¼Œä¹Ÿå‡å°‘äº†å¯¹åç«¯æ•°æ®åº“çš„<code>è®¿é—®å‹åŠ›</code>ã€‚Redisçš„ç¼“å­˜æ¶æ„æ˜¯<code>é«˜å¹¶å‘æ¶æ„</code>ä¸­éå¸¸é‡è¦çš„ä¸€ç¯ã€‚</p><img src="/2023/03/04/04-%E6%97%A5%E5%BF%97%E4%B8%8E%E5%A4%87%E4%BB%BD%E7%AF%87/image-20220715202237535.png" class=""><p>æ­¤å¤–ï¼Œä¸€èˆ¬åº”ç”¨å¯¹æ•°æ®åº“è€Œè¨€éƒ½æ˜¯â€œ <code>è¯»å¤šå†™å°‘</code> â€ï¼Œä¹Ÿå°±è¯´å¯¹æ•°æ®åº“è¯»å–æ•°æ®çš„å‹åŠ›æ¯”è¾ƒå¤§ï¼Œæœ‰ä¸€ä¸ªæ€è·¯å°±æ˜¯é‡‡ç”¨æ•°æ®åº“é›†ç¾¤çš„æ–¹æ¡ˆï¼Œåš <code>ä¸»ä»æ¶æ„</code> ã€è¿›è¡Œ <code>è¯»å†™åˆ†ç¦»</code> ï¼Œè¿™æ ·åŒæ ·å¯ä»¥æå‡æ•°æ®åº“çš„å¹¶å‘å¤„ç†èƒ½åŠ›ã€‚ä½†å¹¶ä¸æ˜¯æ‰€æœ‰çš„åº”ç”¨éƒ½éœ€è¦å¯¹æ•°æ®åº“è¿›è¡Œä¸»ä»æ¶æ„çš„è®¾ç½®ï¼Œæ¯•ç«Ÿè®¾ç½®æ¶æ„æœ¬èº«æ˜¯æœ‰æˆæœ¬çš„ã€‚</p><p>å¦‚æœæˆ‘ä»¬çš„ç›®çš„åœ¨äºæå‡æ•°æ®åº“é«˜å¹¶å‘è®¿é—®çš„æ•ˆç‡ï¼Œé‚£ä¹ˆé¦–å…ˆè€ƒè™‘çš„æ˜¯å¦‚ä½• <code>ä¼˜åŒ–SQLå’Œç´¢å¼•</code> ï¼Œè¿™ç§æ–¹å¼ ç®€å•æœ‰æ•ˆï¼›å…¶æ¬¡æ‰æ˜¯é‡‡ç”¨ <code>ç¼“å­˜çš„ç­–ç•¥</code> ï¼Œæ¯”å¦‚ä½¿ç”¨ Rediså°†çƒ­ç‚¹æ•°æ®ä¿å­˜åœ¨å†…å­˜æ•°æ®åº“ä¸­ï¼Œæå‡è¯»å–çš„æ•ˆç‡ï¼›æœ€åæ‰æ˜¯å¯¹æ•°æ®åº“é‡‡ç”¨ <code>ä¸»ä»æ¶æ„</code> ï¼Œè¿›è¡Œè¯»å†™åˆ†ç¦»ã€‚</p><p>æŒ‰ç…§ä¸Šé¢çš„æ–¹å¼è¿›è¡Œä¼˜åŒ–ï¼Œä½¿ç”¨å’Œç»´æŠ¤çš„æˆæœ¬æ˜¯ç”±ä½åˆ°é«˜çš„ã€‚</p><h3 id="1-2-ä¸»ä»å¤åˆ¶çš„ä½œç”¨"><a href="#1-2-ä¸»ä»å¤åˆ¶çš„ä½œç”¨" class="headerlink" title="1.2 ä¸»ä»å¤åˆ¶çš„ä½œç”¨"></a>1.2 ä¸»ä»å¤åˆ¶çš„ä½œç”¨</h3><p>ä¸»ä»åŒæ­¥è®¾è®¡ä¸ä»…å¯ä»¥æé«˜æ•°æ®åº“çš„ååé‡ï¼Œè¿˜æœ‰ä»¥ä¸‹ 3 ä¸ªæ–¹é¢çš„ä½œç”¨ã€‚</p><p><strong>ç¬¬1ä¸ªä½œç”¨ï¼šè¯»å†™åˆ†ç¦»ã€‚</strong>æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸»ä»å¤åˆ¶çš„æ–¹å¼æ¥<code>åŒæ­¥æ•°æ®</code>ï¼Œç„¶åé€šè¿‡è¯»å†™åˆ†ç¦»æé«˜æ•°æ®åº“å¹¶å‘å¤„ç†èƒ½åŠ›ã€‚</p><img src="/2023/03/04/04-%E6%97%A5%E5%BF%97%E4%B8%8E%E5%A4%87%E4%BB%BD%E7%AF%87/image-20220715212521601.png" class=""><p>å…¶ä¸­ä¸€ä¸ªæ˜¯Masterä¸»åº“ï¼Œè´Ÿè´£å†™å…¥æ•°æ®ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºï¼šå†™åº“ã€‚</p><p>å…¶ä»–éƒ½æ˜¯Slaveä»åº“ï¼Œè´Ÿè´£è¯»å–æ•°æ®ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºï¼šè¯»åº“ã€‚</p><p>å½“ä¸»åº“è¿›è¡Œæ›´æ–°çš„æ—¶å€™ï¼Œä¼šè‡ªåŠ¨å°†æ•°æ®å¤åˆ¶åˆ°ä»åº“ä¸­ï¼Œè€Œæˆ‘ä»¬åœ¨å®¢æˆ·ç«¯è¯»å–æ•°æ®çš„æ—¶å€™ï¼Œä¼šä»ä»åº“è¿›è¡Œè¯»å–ã€‚</p><p>é¢å¯¹â€œè¯»å¤šå†™å°‘â€çš„éœ€æ±‚ï¼Œé‡‡ç”¨è¯»å†™åˆ†ç¦»çš„æ–¹å¼ï¼Œå¯ä»¥å®ç°<code>æ›´é«˜çš„å¹¶å‘è®¿é—®</code>ã€‚åŒæ—¶ï¼Œæˆ‘ä»¬è¿˜èƒ½å¯¹ä»æœåŠ¡å™¨è¿›è¡Œ<code>è´Ÿè½½å‡è¡¡</code>ï¼Œè®©ä¸åŒçš„è¯»è¯·æ±‚æŒ‰ç…§ç­–ç•¥å‡åŒ€åœ°åˆ†å‘åˆ°ä¸åŒçš„ä»æœåŠ¡å™¨ä¸Šï¼Œè®©<code>è¯»å–æ›´åŠ é¡ºç•…</code>ã€‚è¯»å–é¡ºç•…çš„å¦ä¸€ä¸ªåŸå› ï¼Œå°±æ˜¯<code>å‡å°‘äº†é”è¡¨</code>çš„å½±å“ï¼Œæ¯”å¦‚æˆ‘ä»¬è®©ä¸»åº“è´Ÿè´£å†™ï¼Œå½“ä¸»åº“å‡ºç°å†™é”çš„æ—¶å€™ï¼Œä¸ä¼šå½±å“åˆ°ä»åº“è¿›è¡ŒSELECTçš„è¯»å–ã€‚</p><p><strong>ç¬¬2ä¸ªä½œç”¨å°±æ˜¯æ•°æ®å¤‡ä»½ã€‚</strong>æˆ‘ä»¬é€šè¿‡ä¸»ä»å¤åˆ¶å°†ä¸»åº“ä¸Šçš„æ•°æ®å¤åˆ¶åˆ°ä»åº“ä¸Šï¼Œç›¸å½“äºä¸€ç§<code>çƒ­å¤‡ä»½æœºåˆ¶</code>ï¼Œä¹Ÿå°±æ˜¯åœ¨ä¸»åº“æ­£å¸¸è¿è¡Œçš„æƒ…å†µä¸‹è¿›è¡Œçš„å¤‡ä»½ï¼Œä¸ä¼šå½±å“åˆ°æœåŠ¡ã€‚</p><p><strong>ç¬¬3ä¸ªä½œç”¨æ˜¯å…·æœ‰é«˜å¯ç”¨æ€§ã€‚</strong>æ•°æ®å¤‡ä»½å®é™…ä¸Šæ˜¯ä¸€ç§å†—ä½™çš„æœºåˆ¶ï¼Œé€šè¿‡è¿™ç§å†—ä½™çš„æ–¹å¼å¯ä»¥æ¢å–æ•°æ®åº“çš„é«˜å¯ç”¨æ€§ï¼Œä¹Ÿå°±æ˜¯å½“æœåŠ¡å™¨å‡ºç°æ•…éšœæˆ–å®•æœºçš„æƒ…å†µä¸‹ï¼Œå¯ä»¥åˆ‡æ¢åˆ°ä»æœåŠ¡å™¨ä¸Šï¼Œä¿è¯æœåŠ¡çš„æ­£å¸¸è¿è¡Œã€‚</p><img src="/2023/03/04/04-%E6%97%A5%E5%BF%97%E4%B8%8E%E5%A4%87%E4%BB%BD%E7%AF%87/image-20220715214055057.png" class=""><h2 id="2-ä¸»ä»å¤åˆ¶çš„åŸç†"><a href="#2-ä¸»ä»å¤åˆ¶çš„åŸç†" class="headerlink" title="2. ä¸»ä»å¤åˆ¶çš„åŸç†"></a>2. ä¸»ä»å¤åˆ¶çš„åŸç†</h2><p><code>Slave</code> ä¼šä» <code>Master</code> è¯»å– <code>binlog</code> æ¥è¿›è¡Œæ•°æ®åŒæ­¥ã€‚</p><h3 id="2-1-åŸç†å‰–æ"><a href="#2-1-åŸç†å‰–æ" class="headerlink" title="2.1 åŸç†å‰–æ"></a>2.1 åŸç†å‰–æ</h3><p><strong>ä¸‰ä¸ªçº¿ç¨‹</strong></p><p>å®é™…ä¸Šä¸»ä»åŒæ­¥çš„åŸç†å°±æ˜¯åŸºäº binlog è¿›è¡Œæ•°æ®åŒæ­¥çš„ã€‚åœ¨ä¸»ä»å¤åˆ¶è¿‡ç¨‹ä¸­ï¼Œä¼šåŸºäº <code>3 ä¸ªçº¿ç¨‹</code> æ¥æ“ ä½œï¼Œä¸€ä¸ªä¸»åº“çº¿ç¨‹ï¼Œä¸¤ä¸ªä»åº“çº¿ç¨‹ã€‚</p><img src="/2023/03/04/04-%E6%97%A5%E5%BF%97%E4%B8%8E%E5%A4%87%E4%BB%BD%E7%AF%87/image-20220715215944767.png" class=""><p><code>äºŒè¿›åˆ¶æ—¥å¿—è½¬å‚¨çº¿ç¨‹</code> ï¼ˆBinlog dump threadï¼‰æ˜¯ä¸€ä¸ªä¸»åº“çº¿ç¨‹ã€‚å½“ä»åº“çº¿ç¨‹è¿æ¥çš„æ—¶å€™ï¼Œ ä¸»åº“å¯ä»¥å°†äºŒè¿› åˆ¶æ—¥å¿—å‘é€ç»™ä»åº“ï¼Œå½“ä¸»åº“è¯»å–äº‹ä»¶ï¼ˆEventï¼‰çš„æ—¶å€™ï¼Œä¼šåœ¨ Binlog ä¸Š <code>åŠ é”</code> ï¼Œè¯»å–å®Œæˆä¹‹åï¼Œå†å°†é”é‡Šæ”¾æ‰ã€‚</p><p><code>ä»åº“ I/O çº¿ç¨‹</code> ä¼šè¿æ¥åˆ°ä¸»åº“ï¼Œå‘ä¸»åº“å‘é€è¯·æ±‚æ›´æ–° Binlogã€‚è¿™æ—¶ä»åº“çš„ I&#x2F;O çº¿ç¨‹å°±å¯ä»¥è¯»å–åˆ°ä¸»åº“çš„äºŒè¿›åˆ¶æ—¥å¿—è½¬å‚¨çº¿ç¨‹å‘é€çš„ Binlog æ›´æ–°éƒ¨åˆ†ï¼Œå¹¶ä¸”æ‹·è´åˆ°æœ¬åœ°çš„ä¸­ç»§æ—¥å¿— ï¼ˆRelay logï¼‰ã€‚</p><p><code>ä»åº“ SQL çº¿ç¨‹</code> ä¼šè¯»å–ä»åº“ä¸­çš„ä¸­ç»§æ—¥å¿—ï¼Œå¹¶ä¸”æ‰§è¡Œæ—¥å¿—ä¸­çš„äº‹ä»¶ï¼Œå°†ä»åº“ä¸­çš„æ•°æ®ä¸ä¸»åº“ä¿æŒåŒæ­¥ã€‚</p><img src="/2023/03/04/04-%E6%97%A5%E5%BF%97%E4%B8%8E%E5%A4%87%E4%BB%BD%E7%AF%87/image-20220715220037213.png" class=""><blockquote><p>æ³¨æ„ï¼š</p><p>ä¸æ˜¯æ‰€æœ‰ç‰ˆæœ¬çš„MySQLéƒ½é»˜è®¤å¼€å¯æœåŠ¡å™¨çš„äºŒè¿›åˆ¶æ—¥å¿—ã€‚åœ¨è¿›è¡Œä¸»ä»åŒæ­¥çš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦å…ˆæ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦å·²ç»å¼€å¯äº†äºŒè¿›åˆ¶æ—¥å¿—ã€‚</p><p>é™¤éç‰¹æ®ŠæŒ‡å®šï¼Œé»˜è®¤æƒ…å†µä¸‹ä»æœåŠ¡å™¨ä¼šæ‰§è¡Œæ‰€æœ‰ä¸»æœåŠ¡å™¨ä¸­ä¿å­˜çš„äº‹ä»¶ã€‚ä¹Ÿå¯ä»¥é€šè¿‡é…ç½®ï¼Œä½¿ä»æœåŠ¡å™¨æ‰§è¡Œç‰¹å®šçš„äº‹ä»¶ã€‚</p></blockquote><p><strong>å¤åˆ¶ä¸‰æ­¥éª¤</strong></p><p>æ­¥éª¤1ï¼š <code>Master</code> å°†å†™æ“ä½œè®°å½•åˆ°äºŒè¿›åˆ¶æ—¥å¿—ï¼ˆ <code>binlog</code> ï¼‰ã€‚</p><p>æ­¥éª¤2ï¼š <code>Slave</code> å°† <code>Master</code> çš„binary log eventsæ‹·è´åˆ°å®ƒçš„ä¸­ç»§æ—¥å¿—ï¼ˆ <code>relay log</code> ï¼‰ï¼›</p><p>æ­¥éª¤3ï¼š <code>Slave</code> é‡åšä¸­ç»§æ—¥å¿—ä¸­çš„äº‹ä»¶ï¼Œå°†æ”¹å˜åº”ç”¨åˆ°è‡ªå·±çš„æ•°æ®åº“ä¸­ã€‚ MySQLå¤åˆ¶æ˜¯å¼‚æ­¥çš„ä¸”ä¸²è¡ŒåŒ–çš„ï¼Œè€Œä¸”é‡å¯åä» <code>æ¥å…¥ç‚¹</code> å¼€å§‹å¤åˆ¶ã€‚</p><p><strong>å¤åˆ¶çš„é—®é¢˜</strong></p><p>å¤åˆ¶çš„æœ€å¤§é—®é¢˜ï¼š <code>å»¶æ—¶</code></p><h3 id="2-2-å¤åˆ¶çš„åŸºæœ¬åŸåˆ™"><a href="#2-2-å¤åˆ¶çš„åŸºæœ¬åŸåˆ™" class="headerlink" title="2.2 å¤åˆ¶çš„åŸºæœ¬åŸåˆ™"></a>2.2 å¤åˆ¶çš„åŸºæœ¬åŸåˆ™</h3><ul><li>æ¯ä¸ª <code>Slave</code> åªæœ‰ä¸€ä¸ª <code>Master</code></li><li>æ¯ä¸ª <code>Slave</code> åªèƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„æœåŠ¡å™¨ID</li><li>æ¯ä¸ª <code>Master</code> å¯ä»¥æœ‰å¤šä¸ª <code>Slave</code></li></ul><h2 id="3-ä¸€ä¸»ä¸€ä»æ¶æ„æ­å»º"><a href="#3-ä¸€ä¸»ä¸€ä»æ¶æ„æ­å»º" class="headerlink" title="3. ä¸€ä¸»ä¸€ä»æ¶æ„æ­å»º"></a>3. ä¸€ä¸»ä¸€ä»æ¶æ„æ­å»º</h2><p>ä¸€å° <code>ä¸»æœº</code> ç”¨äºå¤„ç†æ‰€æœ‰ <code>å†™è¯·æ±‚</code> ï¼Œä¸€å° <code>ä»æœº</code> è´Ÿè´£æ‰€æœ‰ <code>è¯»è¯·æ±‚</code> ï¼Œæ¶æ„å›¾å¦‚ä¸‹:</p><img src="/2023/03/04/04-%E6%97%A5%E5%BF%97%E4%B8%8E%E5%A4%87%E4%BB%BD%E7%AF%87/image-20220715220852836.png" class=""><h3 id="3-1-å‡†å¤‡å·¥ä½œ"><a href="#3-1-å‡†å¤‡å·¥ä½œ" class="headerlink" title="3.1 å‡†å¤‡å·¥ä½œ"></a>3.1 å‡†å¤‡å·¥ä½œ</h3><p>1ã€å‡†å¤‡ 2å° CentOS è™šæ‹Ÿæœº ï¼ˆå…·ä½“è®¾ç½®å†…å®¹åœ¨P192ï¼‰</p><p>2ã€æ¯å°è™šæ‹Ÿæœºä¸Šéœ€è¦å®‰è£…å¥½MySQL (å¯ä»¥æ˜¯MySQL8.0 )</p><p>è¯´æ˜ï¼šå‰é¢æˆ‘ä»¬è®²è¿‡å¦‚ä½•å…‹éš†ä¸€å°CentOSã€‚å¤§å®¶å¯ä»¥åœ¨ä¸€å°CentOSä¸Šå®‰è£…å¥½MySQLï¼Œè¿›è€Œé€šè¿‡å…‹éš†çš„æ–¹å¼å¤åˆ¶å‡º1å°åŒ…å«MySQLçš„è™šæ‹Ÿæœºã€‚</p><p>æ³¨æ„ï¼šå…‹éš†çš„æ–¹å¼éœ€è¦ä¿®æ”¹æ–°å…‹éš†å‡ºæ¥ä¸»æœºçš„ï¼šâ‘  <code>MACåœ°å€</code> â‘¡ <code>hostname</code> â‘¢<code> IP åœ°å€</code> â‘£ <code>UUID</code> ã€‚</p><p>æ­¤å¤–ï¼Œå…‹éš†çš„æ–¹å¼ç”Ÿæˆçš„è™šæ‹Ÿæœºï¼ˆåŒ…å«MySQL Serverï¼‰ï¼Œåˆ™å…‹éš†çš„è™šæ‹ŸæœºMySQL Serverçš„UUIDç›¸åŒï¼Œå¿…é¡»ä¿®æ”¹ï¼Œå¦åˆ™åœ¨æœ‰äº›åœºæ™¯ä¼šæŠ¥é”™ã€‚æ¯”å¦‚ï¼š <code>show slave status\G</code> ï¼ŒæŠ¥å¦‚ä¸‹çš„é”™è¯¯ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Last_IO_Error: Fatal error: The slave I/O thread stops because master and slave have</span><br><span class="line">equal MySQL server UUIDs; these UUIDs must be different for replication to work.</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹MySQL Server çš„UUIDæ–¹å¼ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim /var/lib/mysql/auto.cnf</span><br><span class="line"></span><br><span class="line">systemctl restart mysqld</span><br></pre></td></tr></table></figure><h3 id="3-2-ä¸»æœºé…ç½®æ–‡ä»¶"><a href="#3-2-ä¸»æœºé…ç½®æ–‡ä»¶" class="headerlink" title="3.2 ä¸»æœºé…ç½®æ–‡ä»¶"></a>3.2 ä¸»æœºé…ç½®æ–‡ä»¶</h3><p>å»ºè®®mysqlç‰ˆæœ¬ä¸€è‡´ä¸”åå°ä»¥æœåŠ¡è¿è¡Œï¼Œä¸»ä»æ‰€æœ‰é…ç½®é¡¹éƒ½é…ç½®åœ¨ <code>[mysqld]</code> èŠ‚ç‚¹ä¸‹ï¼Œä¸”éƒ½æ˜¯å°å†™å­—æ¯ã€‚</p><p>å…·ä½“å‚æ•°é…ç½®å¦‚ä¸‹ï¼š</p><ul><li>å¿…é€‰</li></ul><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#[å¿…é¡»]ä¸»æœåŠ¡å™¨å”¯ä¸€ID</span></span><br><span class="line"><span class="attr">server-id</span>=<span class="string">1</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#[å¿…é¡»]å¯ç”¨äºŒè¿›åˆ¶æ—¥å¿—,æŒ‡åè·¯å¾„ã€‚æ¯”å¦‚ï¼šè‡ªå·±æœ¬åœ°çš„è·¯å¾„/log/mysqlbin</span></span><br><span class="line"><span class="attr">log-bin</span>=<span class="string">atguigu-bin</span></span><br></pre></td></tr></table></figure><ul><li>å¯é€‰</li></ul><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#[å¯é€‰] 0ï¼ˆé»˜è®¤ï¼‰è¡¨ç¤ºè¯»å†™ï¼ˆä¸»æœºï¼‰ï¼Œ1è¡¨ç¤ºåªè¯»ï¼ˆä»æœºï¼‰</span></span><br><span class="line"><span class="attr">read-only</span>=<span class="string">0</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#è®¾ç½®æ—¥å¿—æ–‡ä»¶ä¿ç•™çš„æ—¶é•¿ï¼Œå•ä½æ˜¯ç§’</span></span><br><span class="line"><span class="attr">binlog_expire_logs_seconds</span>=<span class="string">6000</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#æ§åˆ¶å•ä¸ªäºŒè¿›åˆ¶æ—¥å¿—å¤§å°ã€‚æ­¤å‚æ•°çš„æœ€å¤§å’Œé»˜è®¤å€¼æ˜¯1GB</span></span><br><span class="line"><span class="attr">max_binlog_size</span>=<span class="string">200M</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#[å¯é€‰]è®¾ç½®ä¸è¦å¤åˆ¶çš„æ•°æ®åº“</span></span><br><span class="line"><span class="attr">binlog-ignore-db</span>=<span class="string">test</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#[å¯é€‰]è®¾ç½®éœ€è¦å¤åˆ¶çš„æ•°æ®åº“,é»˜è®¤å…¨éƒ¨è®°å½•ã€‚æ¯”å¦‚ï¼šbinlog-do-db=atguigu_master_slave</span></span><br><span class="line"><span class="attr">binlog-do-db</span>=<span class="string">éœ€è¦å¤åˆ¶çš„ä¸»æ•°æ®åº“åå­—</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#[å¯é€‰]è®¾ç½®binlogæ ¼å¼</span></span><br><span class="line"><span class="attr">binlog_format</span>=<span class="string">STATEMENT</span></span><br></pre></td></tr></table></figure><p>é‡å¯åå°mysqlæœåŠ¡ï¼Œä½¿é…ç½®ç”Ÿæ•ˆã€‚</p><blockquote><p>æ³¨æ„ï¼š</p><p>å…ˆæ­å»ºå®Œä¸»ä»å¤åˆ¶ï¼Œå†åˆ›å»ºæ•°æ®åº“ã€‚</p><p>MySQLä¸»ä»å¤åˆ¶èµ·å§‹æ—¶ï¼Œä»æœºä¸ç»§æ‰¿ä¸»æœºæ•°æ®ã€‚</p></blockquote><p><strong>â‘  binlogæ ¼å¼è®¾ç½®ï¼š</strong></p><p>æ ¼å¼1ï¼š <code>STATEMENTæ¨¡å¼</code> ï¼ˆåŸºäºSQLè¯­å¥çš„å¤åˆ¶(statement-based replication, SBR)ï¼‰</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">binlog_format</span>=<span class="string">STATEMENT</span></span><br></pre></td></tr></table></figure><p>æ¯ä¸€æ¡ä¼šä¿®æ”¹æ•°æ®çš„sqlè¯­å¥ä¼šè®°å½•åˆ°binlogä¸­ã€‚è¿™æ˜¯é»˜è®¤çš„binlogæ ¼å¼ã€‚</p><ul><li>SBR çš„ä¼˜ç‚¹ï¼š<ul><li>å†å²æ‚ ä¹…ï¼ŒæŠ€æœ¯æˆç†Ÿ </li><li>ä¸éœ€è¦è®°å½•æ¯ä¸€è¡Œçš„å˜åŒ–ï¼Œå‡å°‘äº†binlogæ—¥å¿—é‡ï¼Œæ–‡ä»¶è¾ƒå° </li><li>binlogä¸­åŒ…å«äº†æ‰€æœ‰æ•°æ®åº“æ›´æ”¹ä¿¡æ¯ï¼Œå¯ä»¥æ®æ­¤æ¥å®¡æ ¸æ•°æ®åº“çš„å®‰å…¨ç­‰æƒ…å†µ </li><li>binlogå¯ä»¥ç”¨äºå®æ—¶çš„è¿˜åŸï¼Œè€Œä¸ä»…ä»…ç”¨äºå¤åˆ¶ </li><li>ä¸»ä»ç‰ˆæœ¬å¯ä»¥ä¸ä¸€æ ·ï¼Œä»æœåŠ¡å™¨ç‰ˆæœ¬å¯ä»¥æ¯”ä¸»æœåŠ¡å™¨ç‰ˆæœ¬é«˜</li></ul></li><li>SBR çš„ç¼ºç‚¹ï¼š<ul><li>ä¸æ˜¯æ‰€æœ‰çš„UPDATEè¯­å¥éƒ½èƒ½è¢«å¤åˆ¶ï¼Œå°¤å…¶æ˜¯åŒ…å«ä¸ç¡®å®šæ“ä½œçš„æ—¶å€™</li></ul></li><li>ä½¿ç”¨ä»¥ä¸‹å‡½æ•°çš„è¯­å¥ä¹Ÿæ— æ³•è¢«å¤åˆ¶ï¼šLOAD_FILE()ã€UUID()ã€USER()ã€FOUND_ROWS()ã€SYSDATE() (é™¤éå¯åŠ¨æ—¶å¯ç”¨äº† â€“sysdate-is-now é€‰é¡¹)<ul><li>INSERT â€¦ SELECT ä¼šäº§ç”Ÿæ¯” RBR æ›´å¤šçš„è¡Œçº§é” </li><li>å¤åˆ¶éœ€è¦è¿›è¡Œå…¨è¡¨æ‰«æ(WHERE è¯­å¥ä¸­æ²¡æœ‰ä½¿ç”¨åˆ°ç´¢å¼•)çš„ UPDATE æ—¶ï¼Œéœ€è¦æ¯” RBR è¯·æ±‚æ›´å¤šçš„è¡Œçº§é” </li><li>å¯¹äºæœ‰ AUTO_INCREMENT å­—æ®µçš„ InnoDBè¡¨è€Œè¨€ï¼ŒINSERT è¯­å¥ä¼šé˜»å¡å…¶ä»– INSERT è¯­å¥ </li><li>å¯¹äºä¸€äº›å¤æ‚çš„è¯­å¥ï¼Œåœ¨ä»æœåŠ¡å™¨ä¸Šçš„è€—èµ„æºæƒ…å†µä¼šæ›´ä¸¥é‡ï¼Œè€Œ RBR æ¨¡å¼ä¸‹ï¼Œåªä¼šå¯¹é‚£ä¸ªå‘ ç”Ÿå˜åŒ–çš„è®°å½•äº§ç”Ÿå½±å“ </li><li>æ‰§è¡Œå¤æ‚è¯­å¥å¦‚æœå‡ºé”™çš„è¯ï¼Œä¼šæ¶ˆè€—æ›´å¤šèµ„æº</li><li>æ•°æ®è¡¨å¿…é¡»å‡ ä¹å’Œä¸»æœåŠ¡å™¨ä¿æŒä¸€è‡´æ‰è¡Œï¼Œå¦åˆ™å¯èƒ½ä¼šå¯¼è‡´å¤åˆ¶å‡ºé”™</li></ul></li></ul><p><strong>â‘¡ ROWæ¨¡å¼ï¼ˆåŸºäºè¡Œçš„å¤åˆ¶(row-based replication, RBR)ï¼‰</strong></p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">binlog_format</span>=<span class="string">ROW</span></span><br></pre></td></tr></table></figure><p>5.1.5ç‰ˆæœ¬çš„MySQLæ‰å¼€å§‹æ”¯æŒï¼Œä¸è®°å½•æ¯æ¡sqlè¯­å¥çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œä»…è®°å½•å“ªæ¡æ•°æ®è¢«ä¿®æ”¹äº†ï¼Œä¿®æ”¹æˆä»€ä¹ˆæ ·äº†ã€‚</p><ul><li>RBR çš„ä¼˜ç‚¹ï¼š<ul><li>ä»»ä½•æƒ…å†µéƒ½å¯ä»¥è¢«å¤åˆ¶ï¼Œè¿™å¯¹å¤åˆ¶æ¥è¯´æ˜¯æœ€ <code>å®‰å…¨å¯é </code> çš„ã€‚ï¼ˆæ¯”å¦‚ï¼šä¸ä¼šå‡ºç°æŸäº›ç‰¹å®šæƒ…å†µä¸‹ çš„å­˜å‚¨è¿‡ç¨‹ã€functionã€triggerçš„è°ƒç”¨å’Œè§¦å‘æ— æ³•è¢«æ­£ç¡®å¤åˆ¶çš„é—®é¢˜ï¼‰ </li><li>å¤šæ•°æƒ…å†µä¸‹ï¼Œä»æœåŠ¡å™¨ä¸Šçš„è¡¨å¦‚æœæœ‰ä¸»é”®çš„è¯ï¼Œå¤åˆ¶å°±ä¼šå¿«äº†å¾ˆå¤š </li><li>å¤åˆ¶ä»¥ä¸‹å‡ ç§è¯­å¥æ—¶çš„è¡Œé”æ›´å°‘ï¼šINSERT â€¦ SELECTã€åŒ…å« AUTO_INCREMENT å­—æ®µçš„ INSERTã€ æ²¡æœ‰é™„å¸¦æ¡ä»¶æˆ–è€…å¹¶æ²¡æœ‰ä¿®æ”¹å¾ˆå¤šè®°å½•çš„ UPDATE æˆ– DELETE è¯­å¥ </li><li>æ‰§è¡Œ INSERTï¼ŒUPDATEï¼ŒDELETE è¯­å¥æ—¶é”æ›´å°‘ </li><li>ä»æœåŠ¡å™¨ä¸Šé‡‡ç”¨ å¤šçº¿ç¨‹ æ¥æ‰§è¡Œå¤åˆ¶æˆä¸ºå¯èƒ½</li></ul></li><li>RBR çš„ç¼ºç‚¹ï¼š<ul><li>binlog å¤§äº†å¾ˆå¤š </li><li>å¤æ‚çš„å›æ»šæ—¶ binlog ä¸­ä¼šåŒ…å«å¤§é‡çš„æ•°æ® </li><li>ä¸»æœåŠ¡å™¨ä¸Šæ‰§è¡Œ UPDATE è¯­å¥æ—¶ï¼Œæ‰€æœ‰å‘ç”Ÿå˜åŒ–çš„è®°å½•éƒ½ä¼šå†™åˆ° binlog ä¸­ï¼Œè€Œ SBR åªä¼šå†™ä¸€æ¬¡ï¼Œè¿™ä¼šå¯¼è‡´é¢‘ç¹å‘ç”Ÿ binlog çš„å¹¶å‘å†™é—®é¢˜ </li><li>æ— æ³•ä» binlog ä¸­çœ‹åˆ°éƒ½å¤åˆ¶äº†äº›ä»€ä¹ˆè¯­å¥</li></ul></li></ul><p><strong>â‘¢ MIXEDæ¨¡å¼ï¼ˆæ··åˆæ¨¡å¼å¤åˆ¶(mixed-based replication, MBR)ï¼‰</strong></p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">binlog_format</span>=<span class="string">MIXED</span></span><br></pre></td></tr></table></figure><p>ä»5.1.8ç‰ˆæœ¬å¼€å§‹ï¼ŒMySQLæä¾›äº†Mixedæ ¼å¼ï¼Œå®é™…ä¸Šå°±æ˜¯Statementä¸Rowçš„ç»“åˆã€‚</p><p>åœ¨Mixedæ¨¡å¼ä¸‹ï¼Œä¸€èˆ¬çš„è¯­å¥ä¿®æ”¹ä½¿ç”¨statmentæ ¼å¼ä¿å­˜binlogã€‚å¦‚ä¸€äº›å‡½æ•°ï¼Œstatementæ— æ³•å®Œæˆä¸»ä»å¤åˆ¶çš„æ“ä½œï¼Œåˆ™é‡‡ç”¨rowæ ¼å¼ä¿å­˜binlogã€‚</p><p>MySQLä¼šæ ¹æ®æ‰§è¡Œçš„æ¯ä¸€æ¡å…·ä½“çš„sqlè¯­å¥æ¥åŒºåˆ†å¯¹å¾…è®°å½•çš„æ—¥å¿—å½¢å¼ï¼Œä¹Ÿå°±æ˜¯åœ¨Statementå’ŒRowä¹‹é—´é€‰æ‹©ä¸€ç§ã€‚</p><h3 id="3-3-ä»æœºé…ç½®æ–‡ä»¶"><a href="#3-3-ä»æœºé…ç½®æ–‡ä»¶" class="headerlink" title="3.3 ä»æœºé…ç½®æ–‡ä»¶"></a>3.3 ä»æœºé…ç½®æ–‡ä»¶</h3><p>è¦æ±‚ä¸»ä»æ‰€æœ‰é…ç½®é¡¹éƒ½é…ç½®åœ¨ <code>my.cnf</code> çš„ <code>[mysqld]</code> æ ä½ä¸‹ï¼Œä¸”éƒ½æ˜¯å°å†™å­—æ¯ã€‚</p><ul><li><p>å¿…é€‰</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#[å¿…é¡»]ä»æœåŠ¡å™¨å”¯ä¸€ID</span><br><span class="line">server-id=2</span><br></pre></td></tr></table></figure></li><li><p>å¯é€‰</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#[å¯é€‰]å¯ç”¨ä¸­ç»§æ—¥å¿—</span><br><span class="line">relay-log=mysql-relay</span><br></pre></td></tr></table></figure></li></ul><p>é‡å¯åå°mysqlæœåŠ¡ï¼Œä½¿é…ç½®ç”Ÿæ•ˆã€‚</p><blockquote><p>æ³¨æ„ï¼šä¸»ä»æœºéƒ½å…³é—­é˜²ç«å¢™<br>service iptables stop #CentOS 6<br>systemctl stop firewalld.service #CentOS 7</p></blockquote><h3 id="3-4-ä¸»æœºï¼šå»ºç«‹è´¦æˆ·å¹¶æˆæƒ"><a href="#3-4-ä¸»æœºï¼šå»ºç«‹è´¦æˆ·å¹¶æˆæƒ" class="headerlink" title="3.4 ä¸»æœºï¼šå»ºç«‹è´¦æˆ·å¹¶æˆæƒ"></a>3.4 ä¸»æœºï¼šå»ºç«‹è´¦æˆ·å¹¶æˆæƒ</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#åœ¨ä¸»æœºMySQLé‡Œæ‰§è¡Œæˆæƒä¸»ä»å¤åˆ¶çš„å‘½ä»¤</span><br><span class="line">GRANT REPLICATION SLAVE ON *.* TO &#x27;slave1&#x27;@&#x27;ä»æœºå™¨æ•°æ®åº“IP&#x27; IDENTIFIED BY &#x27;abc123&#x27;; #5.5,5.7</span><br></pre></td></tr></table></figure><p><strong>æ³¨æ„ï¼šå¦‚æœä½¿ç”¨çš„æ˜¯MySQL8ï¼Œéœ€è¦å¦‚ä¸‹çš„æ–¹å¼å»ºç«‹è´¦æˆ·ï¼Œå¹¶æˆæƒslave:</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">CREATE USER &#x27;slave1&#x27;@&#x27;%&#x27; IDENTIFIED BY &#x27;123456&#x27;;</span><br><span class="line"></span><br><span class="line">GRANT REPLICATION SLAVE ON *.* TO &#x27;slave1&#x27;@&#x27;%&#x27;;</span><br><span class="line"></span><br><span class="line">#æ­¤è¯­å¥å¿…é¡»æ‰§è¡Œã€‚å¦åˆ™è§ä¸‹é¢ã€‚</span><br><span class="line">ALTER USER &#x27;slave1&#x27;@&#x27;%&#x27; IDENTIFIED WITH mysql_native_password BY &#x27;123456&#x27;;</span><br><span class="line"></span><br><span class="line">flush privileges;</span><br></pre></td></tr></table></figure><blockquote><p>æ³¨æ„ï¼šåœ¨ä»æœºæ‰§è¡Œshow slave status\Gæ—¶æŠ¥é”™ï¼š </p><p>Last_IO_Error: error connecting to master â€˜<a href="mailto:&#115;&#108;&#97;&#x76;&#101;&#49;&#x40;&#x31;&#x39;&#x32;&#46;&#x31;&#x36;&#x38;&#x2e;&#49;&#x2e;&#x31;&#53;&#48;">&#115;&#108;&#97;&#x76;&#101;&#49;&#x40;&#x31;&#x39;&#x32;&#46;&#x31;&#x36;&#x38;&#x2e;&#49;&#x2e;&#x31;&#53;&#48;</a>:3306â€™ - retry-time: 60 retries: 1 message: </p><p>Authentication plugin â€˜caching_sha2_passwordâ€™ reported error: Authentication requires secure connection.</p></blockquote><p>æŸ¥è¯¢Masterçš„çŠ¶æ€ï¼Œå¹¶è®°å½•ä¸‹Fileå’ŒPositionçš„å€¼ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show master status;</span><br></pre></td></tr></table></figure><img src="/2023/03/04/04-%E6%97%A5%E5%BF%97%E4%B8%8E%E5%A4%87%E4%BB%BD%E7%AF%87/image-20220718140722740.png" class=""><ul><li>è®°å½•ä¸‹Fileå’ŒPositionçš„å€¼</li></ul><blockquote><p>æ³¨æ„ï¼šæ‰§è¡Œå®Œæ­¤æ­¥éª¤å<strong>ä¸è¦å†æ“ä½œä¸»æœåŠ¡å™¨MySQL</strong>ï¼Œé˜²æ­¢ä¸»æœåŠ¡å™¨çŠ¶æ€å€¼å˜åŒ–ã€‚</p></blockquote><h3 id="3-5-ä»æœºï¼šé…ç½®éœ€è¦å¤åˆ¶çš„ä¸»æœº"><a href="#3-5-ä»æœºï¼šé…ç½®éœ€è¦å¤åˆ¶çš„ä¸»æœº" class="headerlink" title="3.5 ä»æœºï¼šé…ç½®éœ€è¦å¤åˆ¶çš„ä¸»æœº"></a>3.5 ä»æœºï¼šé…ç½®éœ€è¦å¤åˆ¶çš„ä¸»æœº</h3><p><strong>æ­¥éª¤1ï¼š</strong>ä»æœºä¸Šå¤åˆ¶ä¸»æœºçš„å‘½ä»¤</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CHANGE MASTER TO</span><br><span class="line">MASTER_HOST=&#x27;ä¸»æœºçš„IPåœ°å€&#x27;,</span><br><span class="line">MASTER_USER=&#x27;ä¸»æœºç”¨æˆ·å&#x27;,</span><br><span class="line">MASTER_PASSWORD=&#x27;ä¸»æœºç”¨æˆ·åçš„å¯†ç &#x27;,</span><br><span class="line">MASTER_LOG_FILE=&#x27;mysql-bin.å…·ä½“æ•°å­—&#x27;,</span><br><span class="line">MASTER_LOG_POS=å…·ä½“å€¼;</span><br></pre></td></tr></table></figure><p>ä¸¾ä¾‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CHANGE MASTER TO</span><br><span class="line">MASTER_HOST=&#x27;192.168.1.150&#x27;,MASTER_USER=&#x27;slave1&#x27;,MASTER_PASSWORD=&#x27;123456&#x27;,MASTER_LOG_F</span><br><span class="line">ILE=&#x27;atguigu-bin.000007&#x27;,MASTER_LOG_POS=154;</span><br></pre></td></tr></table></figure><img src="/2023/03/04/04-%E6%97%A5%E5%BF%97%E4%B8%8E%E5%A4%87%E4%BB%BD%E7%AF%87/image-20220718140946747.png" class=""><p><strong>æ­¥éª¤2ï¼š</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#å¯åŠ¨slaveåŒæ­¥</span><br><span class="line">START SLAVE;</span><br></pre></td></tr></table></figure><img src="/2023/03/04/04-%E6%97%A5%E5%BF%97%E4%B8%8E%E5%A4%87%E4%BB%BD%E7%AF%87/image-20220718141825228.png" class=""><p>å¦‚æœæŠ¥é”™ï¼š</p><img src="/2023/03/04/04-%E6%97%A5%E5%BF%97%E4%B8%8E%E5%A4%87%E4%BB%BD%E7%AF%87/image-20220718141841862.png" class=""><p>å¯ä»¥æ‰§è¡Œå¦‚ä¸‹æ“ä½œï¼Œåˆ é™¤ä¹‹å‰çš„relay_logä¿¡æ¯ã€‚ç„¶åé‡æ–°æ‰§è¡Œ CHANGE MASTER TO â€¦è¯­å¥å³å¯ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; reset slave; #åˆ é™¤SLAVEæ•°æ®åº“çš„relaylogæ—¥å¿—æ–‡ä»¶ï¼Œå¹¶é‡æ–°å¯ç”¨æ–°çš„relaylogæ–‡ä»¶</span><br></pre></td></tr></table></figure><p>æ¥ç€ï¼ŒæŸ¥çœ‹åŒæ­¥çŠ¶æ€ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHOW SLAVE STATUS\G;</span><br></pre></td></tr></table></figure><img src="/2023/03/04/04-%E6%97%A5%E5%BF%97%E4%B8%8E%E5%A4%87%E4%BB%BD%E7%AF%87/image-20220718141951374.png" class=""><blockquote><p>ä¸Šé¢ä¸¤ä¸ªå‚æ•°éƒ½æ˜¯Yesï¼Œåˆ™è¯´æ˜ä¸»ä»é…ç½®æˆåŠŸï¼</p></blockquote><p>æ˜¾å¼å¦‚ä¸‹çš„æƒ…å†µï¼Œå°±æ˜¯ä¸æ­£ç¡®çš„ã€‚å¯èƒ½é”™è¯¯çš„åŸå› æœ‰ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1. ç½‘ç»œä¸é€š</span><br><span class="line">2. è´¦æˆ·å¯†ç é”™è¯¯</span><br><span class="line">3. é˜²ç«å¢™</span><br><span class="line">4. mysqlé…ç½®æ–‡ä»¶é—®é¢˜</span><br><span class="line">5. è¿æ¥æœåŠ¡å™¨æ—¶è¯­æ³•</span><br><span class="line">6. ä¸»æœåŠ¡å™¨mysqlæƒé™</span><br></pre></td></tr></table></figure><img src="/2023/03/04/04-%E6%97%A5%E5%BF%97%E4%B8%8E%E5%A4%87%E4%BB%BD%E7%AF%87/image-20220718142045114.png" class=""><h3 id="3-6-æµ‹è¯•"><a href="#3-6-æµ‹è¯•" class="headerlink" title="3.6 æµ‹è¯•"></a>3.6 æµ‹è¯•</h3><p>ä¸»æœºæ–°å»ºåº“ã€æ–°å»ºè¡¨ã€insertè®°å½•ï¼Œä»æœºå¤åˆ¶ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">CREATE DATABASE atguigu_master_slave;</span><br><span class="line"></span><br><span class="line">CREATE TABLE mytbl(id INT,NAME VARCHAR(16));</span><br><span class="line"></span><br><span class="line">INSERT INTO mytbl VALUES(1, &#x27;zhang3&#x27;);</span><br><span class="line"></span><br><span class="line">INSERT INTO mytbl VALUES(2,@@hostname);</span><br></pre></td></tr></table></figure><h3 id="3-7-åœæ­¢ä¸»ä»åŒæ­¥"><a href="#3-7-åœæ­¢ä¸»ä»åŒæ­¥" class="headerlink" title="3.7 åœæ­¢ä¸»ä»åŒæ­¥"></a>3.7 åœæ­¢ä¸»ä»åŒæ­¥</h3><ul><li><p>åœæ­¢ä¸»ä»åŒæ­¥å‘½ä»¤ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stop slave;</span><br></pre></td></tr></table></figure></li><li><p>å¦‚ä½•é‡æ–°é…ç½®ä¸»ä»</p><p>å¦‚æœåœæ­¢ä»æœåŠ¡å™¨å¤åˆ¶åŠŸèƒ½ï¼Œå†ä½¿ç”¨éœ€è¦é‡æ–°é…ç½®ä¸»ä»ã€‚å¦åˆ™ä¼šæŠ¥é”™å¦‚ä¸‹ï¼š</p></li></ul><img src="/2023/03/04/04-%E6%97%A5%E5%BF%97%E4%B8%8E%E5%A4%87%E4%BB%BD%E7%AF%87/image-20220718142549168.png" class=""><p>é‡æ–°é…ç½®ä¸»ä»ï¼Œéœ€è¦åœ¨ä»æœºä¸Šæ‰§è¡Œï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">stop slave;</span><br><span class="line"></span><br><span class="line">reset master; #åˆ é™¤Masterä¸­æ‰€æœ‰çš„binglogæ–‡ä»¶ï¼Œå¹¶å°†æ—¥å¿—ç´¢å¼•æ–‡ä»¶æ¸…ç©ºï¼Œé‡æ–°å¼€å§‹æ‰€æœ‰æ–°çš„æ—¥å¿—æ–‡ä»¶(æ…ç”¨)</span><br></pre></td></tr></table></figure><h3 id="3-8-åç»­"><a href="#3-8-åç»­" class="headerlink" title="3.8 åç»­"></a>3.8 åç»­</h3><p><strong>æ­å»ºä¸»ä»å¤åˆ¶ï¼šåŒä¸»åŒä»</strong></p><p>ä¸€ä¸ªä¸»æœºm1ç”¨äºå¤„ç†æ‰€æœ‰å†™è¯·æ±‚ï¼Œå®ƒçš„ä»æœºs1å’Œå¦ä¸€å°ä¸»æœºm2è¿˜æœ‰å®ƒçš„ä»æœºs2è´Ÿè´£æ‰€æœ‰è¯»è¯·æ±‚ã€‚å½“m1ä¸»æœºå®•æœºåï¼Œm2ä¸»æœºè´Ÿè´£å†™è¯·æ±‚ï¼Œm1ã€m2äº’ä¸ºå¤‡æœºã€‚ç»“æ„å›¾å¦‚ä¸‹ï¼š</p><img src="/2023/03/04/04-%E6%97%A5%E5%BF%97%E4%B8%8E%E5%A4%87%E4%BB%BD%E7%AF%87/image-20220718143705843.png" class=""><img src="/2023/03/04/04-%E6%97%A5%E5%BF%97%E4%B8%8E%E5%A4%87%E4%BB%BD%E7%AF%87/image-20220718143716620.png" class=""><h2 id="4-åŒæ­¥æ•°æ®ä¸€è‡´æ€§é—®é¢˜"><a href="#4-åŒæ­¥æ•°æ®ä¸€è‡´æ€§é—®é¢˜" class="headerlink" title="4. åŒæ­¥æ•°æ®ä¸€è‡´æ€§é—®é¢˜"></a>4. åŒæ­¥æ•°æ®ä¸€è‡´æ€§é—®é¢˜</h2><p><strong>ä¸»ä»åŒæ­¥çš„è¦æ±‚ï¼š</strong></p><ul><li>è¯»åº“å’Œå†™åº“çš„æ•°æ®ä¸€è‡´(æœ€ç»ˆä¸€è‡´)ï¼› </li><li>å†™æ•°æ®å¿…é¡»å†™åˆ°å†™åº“ï¼› </li><li>è¯»æ•°æ®å¿…é¡»åˆ°è¯»åº“(ä¸ä¸€å®š)ï¼›</li></ul><h3 id="4-1-ç†è§£ä¸»ä»å»¶è¿Ÿé—®é¢˜"><a href="#4-1-ç†è§£ä¸»ä»å»¶è¿Ÿé—®é¢˜" class="headerlink" title="4.1 ç†è§£ä¸»ä»å»¶è¿Ÿé—®é¢˜"></a>4.1 ç†è§£ä¸»ä»å»¶è¿Ÿé—®é¢˜</h3><p>è¿›è¡Œä¸»ä»åŒæ­¥çš„å†…å®¹æ˜¯äºŒè¿›åˆ¶æ—¥å¿—ï¼Œå®ƒæ˜¯ä¸€ä¸ªæ–‡ä»¶ï¼Œåœ¨è¿›è¡Œ <code>ç½‘ç»œä¼ è¾“</code> çš„è¿‡ç¨‹ä¸­å°±ä¸€å®šä¼š <code>å­˜åœ¨ä¸»ä»å»¶è¿Ÿ</code> ï¼ˆæ¯”å¦‚ 500msï¼‰ï¼Œè¿™æ ·å°±å¯èƒ½é€ æˆç”¨æˆ·åœ¨ä»åº“ä¸Šè¯»å–çš„æ•°æ®ä¸æ˜¯æœ€æ–°çš„æ•°æ®ï¼Œä¹Ÿå°±æ˜¯ä¸»ä»åŒæ­¥ä¸­çš„ <code>æ•°æ®ä¸ä¸€è‡´æ€§</code> é—®é¢˜ã€‚</p><img src="/2023/03/04/04-%E6%97%A5%E5%BF%97%E4%B8%8E%E5%A4%87%E4%BB%BD%E7%AF%87/image-20220718144051094.png" class=""><h3 id="4-2-ä¸»ä»å»¶è¿Ÿé—®é¢˜åŸå› "><a href="#4-2-ä¸»ä»å»¶è¿Ÿé—®é¢˜åŸå› " class="headerlink" title="4.2 ä¸»ä»å»¶è¿Ÿé—®é¢˜åŸå› "></a>4.2 ä¸»ä»å»¶è¿Ÿé—®é¢˜åŸå› </h3><p>åœ¨ç½‘ç»œæ­£å¸¸çš„æ—¶å€™ï¼Œæ—¥å¿—ä»ä¸»åº“ä¼ ç»™ä»åº“æ‰€éœ€çš„æ—¶é—´æ˜¯å¾ˆçŸ­çš„ï¼Œå³T2-T1çš„å€¼æ˜¯éå¸¸å°çš„ã€‚å³ï¼Œç½‘ç»œæ­£å¸¸æƒ…å†µä¸‹ï¼Œä¸»å¤‡å»¶è¿Ÿçš„ä¸»è¦æ¥æºæ˜¯å¤‡åº“æ¥æ”¶å®Œbinlogå’Œæ‰§è¡Œå®Œè¿™ä¸ªäº‹åŠ¡ä¹‹é—´çš„æ—¶é—´å·®ã€‚</p><p><strong>ä¸»å¤‡å»¶è¿Ÿæœ€ç›´æ¥çš„è¡¨ç°æ˜¯ï¼Œä»åº“æ¶ˆè´¹ä¸­ç»§æ—¥å¿—ï¼ˆrelay logï¼‰çš„é€Ÿåº¦ï¼Œæ¯”ä¸»åº“ç”Ÿäº§binlogçš„é€Ÿåº¦è¦æ…¢ã€‚</strong>é€ æˆåŸå› ï¼š</p><p>1ã€ä»åº“çš„æœºå™¨æ€§èƒ½æ¯”ä¸»åº“è¦å·® </p><p>2ã€ä»åº“çš„å‹åŠ›å¤§ </p><p>3ã€å¤§äº‹åŠ¡çš„æ‰§è¡Œ</p><p><strong>ä¸¾ä¾‹1ï¼š</strong>ä¸€æ¬¡æ€§ç”¨deleteè¯­å¥åˆ é™¤å¤ªå¤šæ•°æ® </p><p>ç»“è®ºï¼šåç»­å†åˆ é™¤æ•°æ®çš„æ—¶å€™ï¼Œè¦æ§åˆ¶æ¯ä¸ªäº‹åŠ¡åˆ é™¤çš„æ•°æ®é‡ï¼Œåˆ†æˆå¤šæ¬¡åˆ é™¤ã€‚ </p><p><strong>ä¸¾ä¾‹2ï¼š</strong>ä¸€æ¬¡æ€§ç”¨insertâ€¦selectæ’å…¥å¤ªå¤šæ•°æ® </p><p><strong>ä¸¾ä¾‹3ï¼š</strong>å¤§è¡¨DDL </p><p>æ¯”å¦‚åœ¨ä¸»åº“å¯¹ä¸€å¼ 500Wçš„è¡¨æ·»åŠ ä¸€ä¸ªå­—æ®µè€—è´¹äº†10åˆ†é’Ÿï¼Œé‚£ä¹ˆä»èŠ‚ç‚¹ä¸Šä¹Ÿä¼šè€—è´¹10åˆ†é’Ÿã€‚</p><h3 id="4-3-å¦‚ä½•å‡å°‘ä¸»ä»å»¶è¿Ÿ"><a href="#4-3-å¦‚ä½•å‡å°‘ä¸»ä»å»¶è¿Ÿ" class="headerlink" title="4.3 å¦‚ä½•å‡å°‘ä¸»ä»å»¶è¿Ÿ"></a>4.3 å¦‚ä½•å‡å°‘ä¸»ä»å»¶è¿Ÿ</h3><p>è‹¥æƒ³è¦å‡å°‘ä¸»ä»å»¶è¿Ÿçš„æ—¶é—´ï¼Œå¯ä»¥é‡‡å–ä¸‹é¢çš„åŠæ³•ï¼š</p><ol><li>é™ä½å¤šçº¿ç¨‹å¤§äº‹åŠ¡å¹¶å‘çš„æ¦‚ç‡ï¼Œä¼˜åŒ–ä¸šåŠ¡é€»è¾‘ </li><li>ä¼˜åŒ–SQLï¼Œé¿å…æ…¢SQLï¼Œ <code>å‡å°‘æ‰¹é‡æ“ä½œ</code> ï¼Œå»ºè®®å†™è„šæœ¬ä»¥update-sleepè¿™æ ·çš„å½¢å¼å®Œæˆã€‚ </li><li><code>æé«˜ä»åº“æœºå™¨çš„é…ç½®</code> ï¼Œå‡å°‘ä¸»åº“å†™binlogå’Œä»åº“è¯»binlogçš„æ•ˆç‡å·®ã€‚ </li><li>å°½é‡é‡‡ç”¨ <code>çŸ­çš„é“¾è·¯</code> ï¼Œä¹Ÿå°±æ˜¯ä¸»åº“å’Œä»åº“æœåŠ¡å™¨çš„è·ç¦»å°½é‡è¦çŸ­ï¼Œæå‡ç«¯å£å¸¦å®½ï¼Œå‡å°‘binlogä¼ è¾“çš„ç½‘ç»œå»¶æ—¶ã€‚ </li><li>å®æ—¶æ€§è¦æ±‚çš„ä¸šåŠ¡è¯»å¼ºåˆ¶èµ°ä¸»åº“ï¼Œä»åº“åªåšç¾å¤‡ï¼Œå¤‡ä»½ã€‚</li></ol><h3 id="4-4-å¦‚ä½•è§£å†³ä¸€è‡´æ€§é—®é¢˜"><a href="#4-4-å¦‚ä½•è§£å†³ä¸€è‡´æ€§é—®é¢˜" class="headerlink" title="4.4 å¦‚ä½•è§£å†³ä¸€è‡´æ€§é—®é¢˜"></a>4.4 å¦‚ä½•è§£å†³ä¸€è‡´æ€§é—®é¢˜</h3><p>å¦‚æœæ“ä½œçš„æ•°æ®å­˜å‚¨åœ¨åŒä¸€ä¸ªæ•°æ®åº“ä¸­ï¼Œé‚£ä¹ˆå¯¹æ•°æ®è¿›è¡Œæ›´æ–°çš„æ—¶å€™ï¼Œå¯ä»¥å¯¹è®°å½•åŠ å†™é”ï¼Œè¿™æ ·åœ¨è¯»å–çš„æ—¶å€™å°±ä¸ä¼šå‘ç”Ÿæ•°æ®ä¸ä¸€è‡´çš„æƒ…å†µã€‚ä½†è¿™æ—¶ä»åº“çš„ä½œç”¨å°±æ˜¯ <code>å¤‡ä»½</code> ï¼Œå¹¶æ²¡æœ‰èµ·åˆ° <code>è¯»å†™åˆ†ç¦»</code> ï¼Œåˆ†æ‹…ä¸»åº“ <code>è¯»å‹åŠ›</code> çš„ä½œç”¨ã€‚</p><img src="/2023/03/04/04-%E6%97%A5%E5%BF%97%E4%B8%8E%E5%A4%87%E4%BB%BD%E7%AF%87/image-20220718144341584.png" class=""><p>è¯»å†™åˆ†ç¦»æƒ…å†µä¸‹ï¼Œè§£å†³ä¸»ä»åŒæ­¥ä¸­æ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ï¼Œ å°±æ˜¯è§£å†³ä¸»ä»ä¹‹é—´ <code>æ•°æ®å¤åˆ¶æ–¹å¼</code> çš„é—®é¢˜ï¼Œå¦‚æœæŒ‰ç…§æ•°æ®ä¸€è‡´æ€§ <code>ä»å¼±åˆ°å¼º</code> æ¥è¿›è¡Œåˆ’åˆ†ï¼Œæœ‰ä»¥ä¸‹ 3 ç§å¤åˆ¶æ–¹å¼ã€‚</p><h4 id="æ–¹æ³•-1ï¼šå¼‚æ­¥å¤åˆ¶"><a href="#æ–¹æ³•-1ï¼šå¼‚æ­¥å¤åˆ¶" class="headerlink" title="æ–¹æ³• 1ï¼šå¼‚æ­¥å¤åˆ¶"></a>æ–¹æ³• 1ï¼šå¼‚æ­¥å¤åˆ¶</h4><p>å¼‚æ­¥æ¨¡å¼å°±æ˜¯å®¢æˆ·ç«¯æäº¤ COMMIT ä¹‹åä¸éœ€è¦ç­‰ä»åº“è¿”å›ä»»ä½•ç»“æœï¼Œè€Œæ˜¯ç›´æ¥å°†ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ï¼Œè¿™æ ·åšçš„å¥½å¤„æ˜¯ä¸ä¼šå½±å“ä¸»åº“å†™çš„æ•ˆç‡ï¼Œä½†å¯èƒ½ä¼šå­˜åœ¨ä¸»åº“å®•æœºï¼Œè€ŒBinlogè¿˜æ²¡æœ‰åŒæ­¥åˆ°ä»åº“çš„æƒ…å†µï¼Œä¹Ÿå°±æ˜¯æ­¤æ—¶çš„ä¸»åº“å’Œä»åº“æ•°æ®ä¸ä¸€è‡´ã€‚è¿™æ—¶å€™ä»ä»åº“ä¸­é€‰æ‹©ä¸€ä¸ªä½œä¸ºæ–°ä¸»ï¼Œé‚£ä¹ˆæ–°ä¸»åˆ™å¯èƒ½ç¼ºå°‘åŸæ¥ä¸»æœåŠ¡å™¨ä¸­å·²æäº¤çš„äº‹åŠ¡ã€‚æ‰€ä»¥ï¼Œè¿™ç§å¤åˆ¶æ¨¡å¼ä¸‹çš„æ•°æ®ä¸€è‡´æ€§æ˜¯æœ€å¼±çš„ã€‚</p><img src="/2023/03/04/04-%E6%97%A5%E5%BF%97%E4%B8%8E%E5%A4%87%E4%BB%BD%E7%AF%87/image-20220718144410731.png" class=""><h4 id="æ–¹æ³•-2ï¼šåŠåŒæ­¥å¤åˆ¶"><a href="#æ–¹æ³•-2ï¼šåŠåŒæ­¥å¤åˆ¶" class="headerlink" title="æ–¹æ³• 2ï¼šåŠåŒæ­¥å¤åˆ¶"></a>æ–¹æ³• 2ï¼šåŠåŒæ­¥å¤åˆ¶</h4><img src="/2023/03/04/04-%E6%97%A5%E5%BF%97%E4%B8%8E%E5%A4%87%E4%BB%BD%E7%AF%87/image-20220718144926758.png" class=""><img src="/2023/03/04/04-%E6%97%A5%E5%BF%97%E4%B8%8E%E5%A4%87%E4%BB%BD%E7%AF%87/image-20220718144958357.png" class=""><h4 id="æ–¹æ³•-3ï¼šç»„å¤åˆ¶"><a href="#æ–¹æ³•-3ï¼šç»„å¤åˆ¶" class="headerlink" title="æ–¹æ³• 3ï¼šç»„å¤åˆ¶"></a>æ–¹æ³• 3ï¼šç»„å¤åˆ¶</h4><p>å¼‚æ­¥å¤åˆ¶å’ŒåŠåŒæ­¥å¤åˆ¶éƒ½æ— æ³•æœ€ç»ˆä¿è¯æ•°æ®çš„ä¸€è‡´æ€§é—®é¢˜ï¼ŒåŠåŒæ­¥å¤åˆ¶æ˜¯é€šè¿‡åˆ¤æ–­ä»åº“å“åº”çš„ä¸ªæ•°æ¥å†³å®šæ˜¯å¦è¿”å›ç»™å®¢æˆ·ç«¯ï¼Œè™½ç„¶æ•°æ®ä¸€è‡´æ€§ç›¸æ¯”äºå¼‚æ­¥å¤åˆ¶æœ‰æå‡ï¼Œä½†ä»ç„¶æ— æ³•æ»¡è¶³å¯¹æ•°æ®ä¸€è‡´æ€§è¦æ±‚é«˜çš„åœºæ™¯ï¼Œæ¯”å¦‚é‡‘èé¢†åŸŸã€‚MGR å¾ˆå¥½åœ°å¼¥è¡¥äº†è¿™ä¸¤ç§å¤åˆ¶æ¨¡å¼çš„ä¸è¶³ã€‚</p><p>ç»„å¤åˆ¶æŠ€æœ¯ï¼Œç®€ç§° MGRï¼ˆMySQL Group Replicationï¼‰ã€‚æ˜¯ MySQL åœ¨ 5.7.17 ç‰ˆæœ¬ä¸­æ¨å‡ºçš„ä¸€ç§æ–°çš„æ•°æ®å¤åˆ¶æŠ€æœ¯ï¼Œè¿™ç§å¤åˆ¶æŠ€æœ¯æ˜¯åŸºäº Paxos åè®®çš„çŠ¶æ€æœºå¤åˆ¶ã€‚</p><p><strong>MGR æ˜¯å¦‚ä½•å·¥ä½œçš„</strong></p><p>é¦–å…ˆæˆ‘ä»¬å°†å¤šä¸ªèŠ‚ç‚¹å…±åŒç»„æˆä¸€ä¸ªå¤åˆ¶ç»„ï¼Œåœ¨ <code>æ‰§è¡Œè¯»å†™ï¼ˆRWï¼‰äº‹åŠ¡</code> çš„æ—¶å€™ï¼Œéœ€è¦é€šè¿‡ä¸€è‡´æ€§åè®®å±‚ ï¼ˆConsensus å±‚ï¼‰çš„åŒæ„ï¼Œä¹Ÿå°±æ˜¯è¯»å†™äº‹åŠ¡æƒ³è¦è¿›è¡Œæäº¤ï¼Œå¿…é¡»è¦ç»è¿‡ç»„é‡Œâ€œå¤§å¤šæ•°äººâ€ï¼ˆå¯¹åº” Node èŠ‚ ç‚¹ï¼‰çš„åŒæ„ï¼Œå¤§å¤šæ•°æŒ‡çš„æ˜¯åŒæ„çš„èŠ‚ç‚¹æ•°é‡éœ€è¦å¤§äº ï¼ˆN&#x2F;2+1ï¼‰ï¼Œè¿™æ ·æ‰å¯ä»¥è¿›è¡Œæäº¤ï¼Œè€Œä¸æ˜¯åŸå‘èµ·æ–¹ä¸€ä¸ªè¯´äº†ç®—ã€‚è€Œé’ˆå¯¹ <code>åªè¯»ï¼ˆROï¼‰äº‹åŠ¡</code> åˆ™ä¸éœ€è¦ç»è¿‡ç»„å†…åŒæ„ï¼Œç›´æ¥ COMMIT å³å¯ã€‚</p><p>åœ¨ä¸€ä¸ªå¤åˆ¶ç»„å†…æœ‰å¤šä¸ªèŠ‚ç‚¹ç»„æˆï¼Œå®ƒä»¬å„è‡ªç»´æŠ¤äº†è‡ªå·±çš„æ•°æ®å‰¯æœ¬ï¼Œå¹¶ä¸”åœ¨ä¸€è‡´æ€§åè®®å±‚å®ç°äº†åŸå­æ¶ˆ æ¯å’Œå…¨å±€æœ‰åºæ¶ˆæ¯ï¼Œä»è€Œä¿è¯ç»„å†…æ•°æ®çš„ä¸€è‡´æ€§ã€‚</p><img src="/2023/03/04/04-%E6%97%A5%E5%BF%97%E4%B8%8E%E5%A4%87%E4%BB%BD%E7%AF%87/image-20220718145235499.png" class=""><p>MGR å°† MySQL å¸¦å…¥äº†æ•°æ®å¼ºä¸€è‡´æ€§çš„æ—¶ä»£ï¼Œæ˜¯ä¸€ä¸ªåˆ’æ—¶ä»£çš„åˆ›æ–°ï¼Œå…¶ä¸­ä¸€ä¸ªé‡è¦çš„åŸå› å°±æ˜¯MGR æ˜¯åŸº äº Paxos åè®®çš„ã€‚Paxos ç®—æ³•æ˜¯ç”± 2013 å¹´çš„å›¾çµå¥–è·å¾—è€… Leslie Lamport äº 1990 å¹´æå‡ºçš„ï¼Œæœ‰å…³è¿™ä¸ªç®—æ³•çš„å†³ç­–æœºåˆ¶å¯ä»¥æœä¸€ä¸‹ã€‚äº‹å®ä¸Šï¼ŒPaxos ç®—æ³•æå‡ºæ¥ä¹‹åå°±ä½œä¸º <code>åˆ†å¸ƒå¼ä¸€è‡´æ€§ç®—æ³•</code> è¢«å¹¿æ³›åº”ç”¨ï¼Œæ¯”å¦‚ Apache çš„ ZooKeeper ä¹Ÿæ˜¯åŸºäº Paxos å®ç°çš„ã€‚</p><h2 id="5-çŸ¥è¯†å»¶ä¼¸"><a href="#5-çŸ¥è¯†å»¶ä¼¸" class="headerlink" title="5. çŸ¥è¯†å»¶ä¼¸"></a>5. çŸ¥è¯†å»¶ä¼¸</h2><p>åœ¨ä¸»ä»æ¶æ„çš„é…ç½®ä¸­ï¼Œå¦‚æœæƒ³è¦é‡‡å–è¯»å†™åˆ†ç¦»çš„ç­–ç•¥ï¼Œæˆ‘ä»¬å¯ä»¥<code> è‡ªå·±ç¼–å†™ç¨‹åº</code> ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ <code>ç¬¬ä¸‰æ–¹çš„ä¸­é—´ä»¶</code> æ¥å®ç°ã€‚</p><ul><li>è‡ªå·±ç¼–å†™ç¨‹åºçš„å¥½å¤„å°±åœ¨äºæ¯”è¾ƒè‡ªä¸»ï¼Œæˆ‘ä»¬å¯ä»¥è‡ªå·±åˆ¤æ–­å“ªäº›æŸ¥è¯¢åœ¨ä»åº“ä¸Šæ¥æ‰§è¡Œï¼Œé’ˆå¯¹å®æ—¶æ€§è¦ æ±‚é«˜çš„éœ€æ±‚ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥è€ƒè™‘å“ªäº›æŸ¥è¯¢å¯ä»¥åœ¨ä¸»åº“ä¸Šæ‰§è¡Œã€‚åŒæ—¶ï¼Œç¨‹åºç›´æ¥è¿æ¥æ•°æ®åº“ï¼Œå‡å°‘äº†ä¸­é—´ä»¶å±‚ï¼Œç›¸å½“äºå‡å°‘äº†æ€§èƒ½æŸè€—ã€‚</li><li>é‡‡ç”¨ä¸­é—´ä»¶çš„æ–¹æ³•æœ‰å¾ˆæ˜æ˜¾çš„ä¼˜åŠ¿ï¼Œ<code> åŠŸèƒ½å¼ºå¤§</code> ï¼Œ <code>ä½¿ç”¨ç®€å•</code> ã€‚ä½†å› ä¸ºåœ¨å®¢æˆ·ç«¯å’Œæ•°æ®åº“ä¹‹é—´å¢åŠ äº† ä¸­é—´ä»¶å±‚ä¼šæœ‰ä¸€äº› <code>æ€§èƒ½æŸè€—</code> ï¼ŒåŒæ—¶å•†ä¸šä¸­é—´ä»¶ä¹Ÿæ˜¯æœ‰ä½¿ç”¨æˆæœ¬çš„ã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥è€ƒè™‘é‡‡å–ä¸€äº›ä¼˜ç§€çš„å¼€æºå·¥å…·ã€‚</li></ul><img src="/2023/03/04/04-%E6%97%A5%E5%BF%97%E4%B8%8E%E5%A4%87%E4%BB%BD%E7%AF%87/image-20220718145428456.png" class=""><p>â‘  <code>Cobar</code> å±äºé˜¿é‡ŒB2Bäº‹ä¸šç¾¤ï¼Œå§‹äº2008å¹´ï¼Œåœ¨é˜¿é‡Œæœå½¹3å¹´å¤šï¼Œæ¥ç®¡3000+ä¸ªMySQLæ•°æ®åº“çš„ schema,é›†ç¾¤æ—¥å¤„ç†åœ¨çº¿SQLè¯·æ±‚50äº¿æ¬¡ä»¥ä¸Šã€‚ç”±äºCobarå‘èµ·äººçš„ç¦»èŒï¼ŒCobaråœæ­¢ç»´æŠ¤ã€‚ </p><p>â‘¡ <code>Mycat</code> æ˜¯å¼€æºç¤¾åŒºåœ¨é˜¿é‡ŒcobaråŸºç¡€ä¸Šè¿›è¡ŒäºŒæ¬¡å¼€å‘ï¼Œè§£å†³äº†cobarå­˜åœ¨çš„é—®é¢˜ï¼Œå¹¶ä¸”åŠ å…¥äº†è®¸ å¤šæ–°çš„åŠŸèƒ½åœ¨å…¶ä¸­ã€‚é’å‡ºäºè“è€Œèƒœäºè“ã€‚</p><p>â‘¢ <code>OneProxy</code> åŸºäºMySQLå®˜æ–¹çš„proxyæ€æƒ³åˆ©ç”¨cè¯­è¨€è¿›è¡Œå¼€å‘çš„ï¼ŒOneProxyæ˜¯ä¸€æ¬¾å•†ä¸š æ”¶è´¹ çš„ä¸­ é—´ä»¶ã€‚èˆå¼ƒäº†ä¸€äº›åŠŸèƒ½ï¼Œä¸“æ³¨åœ¨ æ€§èƒ½å’Œç¨³å®šæ€§ä¸Š ã€‚ </p><p>â‘£ <code>kingshard</code> ç”±å°å›¢é˜Ÿç”¨goè¯­è¨€å¼€å‘ï¼Œè¿˜éœ€è¦å‘å±•ï¼Œéœ€è¦ä¸æ–­å®Œå–„ã€‚ </p><p>â‘¤ <code>Vitess</code> æ˜¯Youtubeç”Ÿäº§åœ¨ä½¿ç”¨ï¼Œæ¶æ„å¾ˆå¤æ‚ã€‚ä¸æ”¯æŒMySQLåŸç”Ÿåè®®ï¼Œä½¿ç”¨ éœ€è¦å¤§é‡æ”¹é€ æˆ æœ¬ ã€‚ </p><p>â‘¥ <code>Atlas</code> æ˜¯360å›¢é˜ŸåŸºäºmysql proxyæ”¹å†™ï¼ŒåŠŸèƒ½è¿˜éœ€å®Œå–„ï¼Œé«˜å¹¶å‘ä¸‹ä¸ç¨³å®šã€‚ </p><p>â‘¦ <code>MaxScale</code> æ˜¯mariadbï¼ˆMySQLåŸä½œè€…ç»´æŠ¤çš„ä¸€ä¸ªç‰ˆæœ¬ï¼‰ ç ”å‘çš„ä¸­é—´ä»¶ </p><p>â‘§ <code>MySQLRoute</code> æ˜¯MySQLå®˜æ–¹Oracleå…¬å¸å‘å¸ƒçš„ä¸­é—´ä»¶</p><img src="/2023/03/04/04-%E6%97%A5%E5%BF%97%E4%B8%8E%E5%A4%87%E4%BB%BD%E7%AF%87/image-20220718145523643.png" class=""><img src="/2023/03/04/04-%E6%97%A5%E5%BF%97%E4%B8%8E%E5%A4%87%E4%BB%BD%E7%AF%87/image-20220718145534856.png" class=""><p>ä¸»å¤‡åˆ‡æ¢ï¼š</p><img src="/2023/03/04/04-%E6%97%A5%E5%BF%97%E4%B8%8E%E5%A4%87%E4%BB%BD%E7%AF%87/image-20220718145548526.png" class=""><ul><li>ä¸»åŠ¨åˆ‡æ¢ </li><li>è¢«åŠ¨åˆ‡æ¢</li><li>å¦‚ä½•åˆ¤æ–­ä¸»åº“å‡ºé—®é¢˜äº†ï¼Ÿå¦‚ä½•è§£å†³è¿‡ç¨‹ä¸­çš„æ•°æ®ä¸ä¸€è‡´æ€§é—®é¢˜ ?</li></ul><h1 id="ç¬¬19ç« -æ•°æ®åº“å¤‡ä»½ä¸æ¢å¤"><a href="#ç¬¬19ç« -æ•°æ®åº“å¤‡ä»½ä¸æ¢å¤" class="headerlink" title="ç¬¬19ç« _æ•°æ®åº“å¤‡ä»½ä¸æ¢å¤"></a>ç¬¬19ç« _æ•°æ®åº“å¤‡ä»½ä¸æ¢å¤</h1><img src="/2023/03/04/04-%E6%97%A5%E5%BF%97%E4%B8%8E%E5%A4%87%E4%BB%BD%E7%AF%87/image-20220718145936444.png" class=""><h2 id="1-ç‰©ç†å¤‡ä»½ä¸é€»è¾‘å¤‡ä»½"><a href="#1-ç‰©ç†å¤‡ä»½ä¸é€»è¾‘å¤‡ä»½" class="headerlink" title="1. ç‰©ç†å¤‡ä»½ä¸é€»è¾‘å¤‡ä»½"></a>1. ç‰©ç†å¤‡ä»½ä¸é€»è¾‘å¤‡ä»½</h2><p><strong>ç‰©ç†å¤‡ä»½ï¼š</strong>å¤‡ä»½æ•°æ®æ–‡ä»¶ï¼Œè½¬å‚¨æ•°æ®åº“ç‰©ç†æ–‡ä»¶åˆ°æŸä¸€ç›®å½•ã€‚ç‰©ç†å¤‡ä»½æ¢å¤é€Ÿåº¦æ¯”è¾ƒå¿«ï¼Œä½†å ç”¨ç©ºé—´æ¯”è¾ƒå¤§ï¼ŒMySQLä¸­å¯ä»¥ç”¨ <code>xtrabackup</code> å·¥å…·æ¥è¿›è¡Œç‰©ç†å¤‡ä»½ã€‚</p><p><strong>é€»è¾‘å¤‡ä»½ï¼š</strong>å¯¹æ•°æ®åº“å¯¹è±¡åˆ©ç”¨å·¥å…·è¿›è¡Œå¯¼å‡ºå·¥ä½œï¼Œæ±‡æ€»å…¥å¤‡ä»½æ–‡ä»¶å†…ã€‚é€»è¾‘å¤‡ä»½æ¢å¤é€Ÿåº¦æ…¢ï¼Œä½†å ç”¨ç©ºé—´å°ï¼Œæ›´çµæ´»ã€‚MySQL ä¸­å¸¸ç”¨çš„é€»è¾‘å¤‡ä»½å·¥å…·ä¸º <code>mysqldump</code> ã€‚é€»è¾‘å¤‡ä»½å°±æ˜¯ <code>å¤‡ä»½sqlè¯­å¥</code> ï¼Œåœ¨æ¢å¤çš„ æ—¶å€™æ‰§è¡Œå¤‡ä»½çš„sqlè¯­å¥å®ç°æ•°æ®åº“æ•°æ®çš„é‡ç°ã€‚</p><h2 id="2-mysqldumpå®ç°é€»è¾‘å¤‡ä»½"><a href="#2-mysqldumpå®ç°é€»è¾‘å¤‡ä»½" class="headerlink" title="2. mysqldumpå®ç°é€»è¾‘å¤‡ä»½"></a>2. mysqldumpå®ç°é€»è¾‘å¤‡ä»½</h2><p>mysqldumpæ˜¯MySQLæä¾›çš„ä¸€ä¸ªéå¸¸æœ‰ç”¨çš„æ•°æ®åº“å¤‡ä»½å·¥å…·ã€‚</p><h3 id="2-1-å¤‡ä»½ä¸€ä¸ªæ•°æ®åº“"><a href="#2-1-å¤‡ä»½ä¸€ä¸ªæ•°æ®åº“" class="headerlink" title="2.1 å¤‡ä»½ä¸€ä¸ªæ•°æ®åº“"></a>2.1 å¤‡ä»½ä¸€ä¸ªæ•°æ®åº“</h3><p>mysqldumpå‘½ä»¤æ‰§è¡Œæ—¶ï¼Œå¯ä»¥å°†æ•°æ®åº“å¤‡ä»½æˆä¸€ä¸ª<code>æ–‡æœ¬æ–‡ä»¶</code>ï¼Œè¯¥æ–‡ä»¶ä¸­å®é™…ä¸ŠåŒ…å«å¤šä¸ª<code>CREATE</code>å’Œ<code>INSERT</code>è¯­å¥ï¼Œä½¿ç”¨è¿™äº›è¯­å¥å¯ä»¥é‡æ–°åˆ›å»ºè¡¨å’Œæ’å…¥æ•°æ®ã€‚</p><ul><li>æŸ¥å‡ºéœ€è¦å¤‡ä»½çš„è¡¨çš„ç»“æ„ï¼Œåœ¨æ–‡æœ¬æ–‡ä»¶ä¸­ç”Ÿæˆä¸€ä¸ªCREATEè¯­å¥</li><li>å°†è¡¨ä¸­çš„æ‰€æœ‰è®°å½•è½¬æ¢ä¸ºä¸€æ¡INSERTè¯­å¥ã€‚</li></ul><p><strong>åŸºæœ¬è¯­æ³•ï¼š</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldump â€“u ç”¨æˆ·åç§° â€“h ä¸»æœºåç§° â€“på¯†ç  å¾…å¤‡ä»½çš„æ•°æ®åº“åç§°[tbname, [tbname...]]&gt; å¤‡ä»½æ–‡ä»¶åç§°.sql</span><br></pre></td></tr></table></figure><blockquote><p>è¯´æ˜ï¼š å¤‡ä»½çš„æ–‡ä»¶å¹¶éä¸€å®šè¦æ±‚åç¼€åä¸º.sqlï¼Œä¾‹å¦‚åç¼€åä¸º.txtçš„æ–‡ä»¶ä¹Ÿæ˜¯å¯ä»¥çš„ã€‚</p></blockquote><p>ä¸¾ä¾‹ï¼šä½¿ç”¨rootç”¨æˆ·å¤‡ä»½atguiguæ•°æ®åº“ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldump -uroot -p atguigu&gt;atguigu.sql #å¤‡ä»½æ–‡ä»¶å­˜å‚¨åœ¨å½“å‰ç›®å½•ä¸‹</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldump -uroot -p atguigudb1 &gt; /var/lib/mysql/atguigu.sql</span><br></pre></td></tr></table></figure><p>å¤‡ä»½æ–‡ä»¶å‰–æï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">-- MySQL dump 10.13 Distrib 8.0.26, for Linux (x86_64)</span><br><span class="line">--</span><br><span class="line">-- Host: localhost Database: atguigu</span><br><span class="line">-- ------------------------------------------------------</span><br><span class="line">-- Server version 8.0.26</span><br><span class="line"></span><br><span class="line">/*!40101 SET @OLD_CHARACTER_SET_CLIENT=@@CHARACTER_SET_CLIENT */;</span><br><span class="line">/*!40101 SET @OLD_CHARACTER_SET_RESULTS=@@CHARACTER_SET_RESULTS */;</span><br><span class="line">/*!40101 SET @OLD_COLLATION_CONNECTION=@@COLLATION_CONNECTION */;</span><br><span class="line">/*!50503 SET NAMES utf8mb4 */;</span><br><span class="line">/*!40103 SET @OLD_TIME_ZONE=@@TIME_ZONE */;</span><br><span class="line">/*!40103 SET TIME_ZONE=&#x27;+00:00&#x27; */;</span><br><span class="line">/*!40014 SET @OLD_UNIQUE_CHECKS=@@UNIQUE_CHECKS, UNIQUE_CHECKS=0 */;</span><br><span class="line">/*!40014 SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=0 */;</span><br><span class="line">/*!40101 SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE=&#x27;NO_AUTO_VALUE_ON_ZERO&#x27; */;</span><br><span class="line">/*!40111 SET @OLD_SQL_NOTES=@@SQL_NOTES, SQL_NOTES=0 */;</span><br><span class="line"></span><br><span class="line">--</span><br><span class="line">-- Current Database: `atguigu`</span><br><span class="line">--</span><br><span class="line"></span><br><span class="line">CREATE DATABASE /*!32312 IF NOT EXISTS*/ `atguigu` /*!40100 DEFAULT CHARACTER SET</span><br><span class="line">utf8mb4 COLLATE utf8mb4_0900_ai_ci */ /*!80016 DEFAULT ENCRYPTION=&#x27;N&#x27; */;</span><br><span class="line"></span><br><span class="line">USE `atguigu`;</span><br><span class="line"></span><br><span class="line">--</span><br><span class="line">-- Table structure for table `student`</span><br><span class="line">--</span><br><span class="line"></span><br><span class="line">DROP TABLE IF EXISTS `student`;</span><br><span class="line">/*!40101 SET @saved_cs_client = @@character_set_client */;</span><br><span class="line">/*!50503 SET character_set_client = utf8mb4 */;</span><br><span class="line">CREATE TABLE `student` (</span><br><span class="line">`studentno` int NOT NULL,</span><br><span class="line">`name` varchar(20) DEFAULT NULL,</span><br><span class="line">`class` varchar(20) DEFAULT NULL,</span><br><span class="line">PRIMARY KEY (`studentno`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb3;</span><br><span class="line">/*!40101 SET character_set_client = @saved_cs_client */;</span><br><span class="line">INSERT INTO `student` VALUES (1,&#x27;å¼ ä¸‰_back&#x27;,&#x27;ä¸€ç­&#x27;),(3,&#x27;æå››&#x27;,&#x27;ä¸€ç­&#x27;),(8,&#x27;ç‹äº”&#x27;,&#x27;äºŒç­&#x27;),</span><br><span class="line">(15,&#x27;èµµå…­&#x27;,&#x27;äºŒç­&#x27;),(20,&#x27;é’±ä¸ƒ&#x27;,&#x27;&gt;ä¸‰ç­&#x27;),(22,&#x27;zhang3_update&#x27;,&#x27;1ban&#x27;),(24,&#x27;wang5&#x27;,&#x27;2ban&#x27;);</span><br><span class="line">/*!40000 ALTER TABLE `student` ENABLE KEYS */;</span><br><span class="line">UNLOCK TABLES;</span><br><span class="line">        .</span><br><span class="line">        .</span><br><span class="line">        .</span><br><span class="line">        .</span><br><span class="line">/*!40101 SET SQL_MODE=@OLD_SQL_MODE */;</span><br><span class="line">/*!40014 SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS */;</span><br><span class="line">/*!40014 SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS */;</span><br><span class="line">/*!40101 SET CHARACTER_SET_CLIENT=@OLD_CHARACTER_SET_CLIENT */;</span><br><span class="line">/*!40101 SET CHARACTER_SET_RESULTS=@OLD_CHARACTER_SET_RESULTS */;</span><br><span class="line">/*!40101 SET COLLATION_CONNECTION=@OLD_COLLATION_CONNECTION */;</span><br><span class="line">/*!40111 SET SQL_NOTES=@OLD_SQL_NOTES */;</span><br><span class="line">-- Dump completed on 2022-01-07 9:58:23</span><br></pre></td></tr></table></figure><h3 id="2-2-å¤‡ä»½å…¨éƒ¨æ•°æ®åº“"><a href="#2-2-å¤‡ä»½å…¨éƒ¨æ•°æ®åº“" class="headerlink" title="2.2 å¤‡ä»½å…¨éƒ¨æ•°æ®åº“"></a>2.2 å¤‡ä»½å…¨éƒ¨æ•°æ®åº“</h3><p>è‹¥æƒ³ç”¨mysqldumpå¤‡ä»½æ•´ä¸ªå®ä¾‹ï¼Œå¯ä»¥ä½¿ç”¨ â€“all-databases æˆ– -A å‚æ•°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysqldump -uroot -pxxxxxx --all-databases &gt; all_database.sql</span><br><span class="line">mysqldump -uroot -pxxxxxx -A &gt; all_database.sql</span><br></pre></td></tr></table></figure><h3 id="2-3-å¤‡ä»½éƒ¨åˆ†æ•°æ®åº“"><a href="#2-3-å¤‡ä»½éƒ¨åˆ†æ•°æ®åº“" class="headerlink" title="2.3 å¤‡ä»½éƒ¨åˆ†æ•°æ®åº“"></a>2.3 å¤‡ä»½éƒ¨åˆ†æ•°æ®åº“</h3><p>ä½¿ç”¨ <code>--databases</code> æˆ– <code>-B</code> å‚æ•°äº†ï¼Œè¯¥å‚æ•°åé¢è·Ÿæ•°æ®åº“åç§°ï¼Œå¤šä¸ªæ•°æ®åº“é—´ç”¨ç©ºæ ¼éš”å¼€ã€‚å¦‚æœæŒ‡å®š databaseså‚æ•°ï¼Œå¤‡ä»½æ–‡ä»¶ä¸­ä¼šå­˜åœ¨åˆ›å»ºæ•°æ®åº“çš„è¯­å¥ï¼Œå¦‚æœä¸æŒ‡å®šå‚æ•°ï¼Œåˆ™ä¸å­˜åœ¨ã€‚è¯­æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldump â€“u user â€“h host â€“p --databases [æ•°æ®åº“çš„åç§°1 [æ•°æ®åº“çš„åç§°2...]] &gt; å¤‡ä»½æ–‡ä»¶åç§°.sql</span><br></pre></td></tr></table></figure><p>ä¸¾ä¾‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldump -uroot -p --databases atguigu atguigu12 &gt;two_database.sql</span><br></pre></td></tr></table></figure><p>æˆ–</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldump -uroot -p -B atguigu atguigu12 &gt; two_database.sql</span><br></pre></td></tr></table></figure><h3 id="2-4-å¤‡ä»½éƒ¨åˆ†è¡¨"><a href="#2-4-å¤‡ä»½éƒ¨åˆ†è¡¨" class="headerlink" title="2.4 å¤‡ä»½éƒ¨åˆ†è¡¨"></a>2.4 å¤‡ä»½éƒ¨åˆ†è¡¨</h3><p>æ¯”å¦‚ï¼Œåœ¨è¡¨å˜æ›´å‰åšä¸ªå¤‡ä»½ã€‚è¯­æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldump â€“u user â€“h host â€“p æ•°æ®åº“çš„åç§° [è¡¨å1 [è¡¨å2...]] &gt; å¤‡ä»½æ–‡ä»¶åç§°.sql</span><br></pre></td></tr></table></figure><p>ä¸¾ä¾‹ï¼šå¤‡ä»½atguiguæ•°æ®åº“ä¸‹çš„bookè¡¨</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldump -uroot -p atguigu book&gt; book.sql</span><br></pre></td></tr></table></figure><p>book.sqlæ–‡ä»¶å†…å®¹å¦‚ä¸‹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">mysqldump -uroot -p atguigu book&gt; book.sql^C</span><br><span class="line">[root@node1 ~]# ls</span><br><span class="line">kk kubekey kubekey-v1.1.1-linux-amd64.tar.gz README.md test1.sql two_database.sql</span><br><span class="line">[root@node1 ~]# mysqldump -uroot -p atguigu book&gt; book.sql</span><br><span class="line">Enter password:</span><br><span class="line">[root@node1 ~]# ls</span><br><span class="line">book.sql kk kubekey kubekey-v1.1.1-linux-amd64.tar.gz README.md test1.sql</span><br><span class="line">two_database.sql</span><br><span class="line">[root@node1 ~]# vi book.sql</span><br><span class="line">-- MySQL dump 10.13 Distrib 8.0.26, for Linux (x86_64)</span><br><span class="line">--</span><br><span class="line">-- Host: localhost Database: atguigu</span><br><span class="line">-- ------------------------------------------------------</span><br><span class="line">-- Server version 8.0.26</span><br><span class="line"></span><br><span class="line">/*!40101 SET @OLD_CHARACTER_SET_CLIENT=@@CHARACTER_SET_CLIENT */;</span><br><span class="line">/*!40101 SET @OLD_CHARACTER_SET_RESULTS=@@CHARACTER_SET_RESULTS */;</span><br><span class="line">/*!40101 SET @OLD_COLLATION_CONNECTION=@@COLLATION_CONNECTION */;</span><br><span class="line">/*!50503 SET NAMES utf8mb4 */;</span><br><span class="line">/*!40103 SET @OLD_TIME_ZONE=@@TIME_ZONE */;</span><br><span class="line">/*!40103 SET TIME_ZONE=&#x27;+00:00&#x27; */;</span><br><span class="line">/*!40014 SET @OLD_UNIQUE_CHECKS=@@UNIQUE_CHECKS, UNIQUE_CHECKS=0 */;</span><br><span class="line">/*!40014 SET @OLD_FOREIGN_KEY_CHECKS=@@FOREIGN_KEY_CHECKS, FOREIGN_KEY_CHECKS=0 */;</span><br><span class="line">/*!40101 SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE=&#x27;NO_AUTO_VALUE_ON_ZERO&#x27; */;</span><br><span class="line">/*!40111 SET @OLD_SQL_NOTES=@@SQL_NOTES, SQL_NOTES=0 */;</span><br><span class="line"></span><br><span class="line">--</span><br><span class="line">-- Table structure for table `book`</span><br><span class="line">--</span><br><span class="line"></span><br><span class="line">DROP TABLE IF EXISTS `book`;</span><br><span class="line">/*!40101 SET @saved_cs_client = @@character_set_client */;</span><br><span class="line">/*!50503 SET character_set_client = utf8mb4 */;</span><br><span class="line">CREATE TABLE `book` (</span><br><span class="line">`bookid` int unsigned NOT NULL AUTO_INCREMENT,</span><br><span class="line">`card` int unsigned NOT NULL,</span><br><span class="line">`test` varchar(255) COLLATE utf8_bin DEFAULT NULL,</span><br><span class="line">PRIMARY KEY (`bookid`),</span><br><span class="line">KEY `Y` (`card`)</span><br><span class="line">) ENGINE=InnoDB AUTO_INCREMENT=101 DEFAULT CHARSET=utf8mb3 COLLATE=utf8_bin;</span><br><span class="line">/*!40101 SET character_set_client = @saved_cs_client */;</span><br><span class="line"></span><br><span class="line">--</span><br><span class="line">-- Dumping data for table `book`</span><br><span class="line">--</span><br><span class="line"></span><br><span class="line">LOCK TABLES `book` WRITE;</span><br><span class="line">/*!40000 ALTER TABLE `book` DISABLE KEYS */;</span><br><span class="line">INSERT INTO `book` VALUES (1,9,NULL),(2,10,NULL),(3,4,NULL),(4,8,NULL),(5,7,NULL),</span><br><span class="line">(6,10,NULL),(7,11,NULL),(8,3,NULL),(9,1,NULL),(10,17,NULL),(11,19,NULL),(12,4,NULL),</span><br><span class="line">(13,1,NULL),(14,14,NULL),(15,5,NULL),(16,5,NULL),(17,8,NULL),(18,3,NULL),(19,12,NULL),</span><br><span class="line">(20,11,NULL),(21,9,NULL),(22,20,NULL),(23,13,NULL),(24,3,NULL),(25,18,NULL),</span><br><span class="line">(26,20,NULL),(27,5,NULL),(28,6,NULL),(29,15,NULL),(30,15,NULL),(31,12,NULL),</span><br><span class="line">(32,11,NULL),(33,20,NULL),(34,5,NULL),(35,4,NULL),(36,6,NULL),(37,17,NULL),</span><br><span class="line">(38,5,NULL),(39,16,NULL),(40,6,NULL),(41,18,NULL),(42,12,NULL),(43,6,NULL),</span><br><span class="line">(44,12,NULL),(45,2,NULL),(46,12,NULL),(47,15,NULL),(48,17,NULL),(49,2,NULL),</span><br><span class="line">(50,16,NULL),(51,13,NULL),(52,17,NULL),(53,7,NULL),(54,2,NULL),(55,9,NULL),</span><br><span class="line">(56,1,NULL),(57,14,NULL),(58,7,NULL),(59,15,NULL),(60,12,NULL),(61,13,NULL),</span><br><span class="line">(62,8,NULL),(63,2,NULL),(64,6,NULL),(65,2,NULL),(66,12,NULL),(67,12,NULL),(68,4,NULL),</span><br><span class="line">(69,5,NULL),(70,10,NULL),(71,16,NULL),(72,8,NULL),(73,14,NULL),(74,5,NULL),</span><br><span class="line">(75,4,NULL),(76,3,NULL),(77,2,NULL),(78,2,NULL),(79,2,NULL),(80,3,NULL),(81,8,NULL),</span><br><span class="line">(82,14,NULL),(83,5,NULL),(84,4,NULL),(85,2,NULL),(86,20,NULL),(87,12,NULL),</span><br><span class="line">(88,1,NULL),(89,8,NULL),(90,18,NULL),(91,3,NULL),(92,3,NULL),(93,6,NULL),(94,1,NULL),</span><br><span class="line">(95,4,NULL),(96,17,NULL),(97,15,NULL),(98,1,NULL),(99,20,NULL),(100,15,NULL);</span><br><span class="line">/*!40000 ALTER TABLE `book` ENABLE KEYS */;</span><br><span class="line">UNLOCK TABLES;</span><br><span class="line">/*!40103 SET TIME_ZONE=@OLD_TIME_ZONE */;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œbookæ–‡ä»¶å’Œå¤‡ä»½çš„åº“æ–‡ä»¶ç±»ä¼¼ã€‚ä¸åŒçš„æ˜¯ï¼Œbookæ–‡ä»¶åªåŒ…å«bookè¡¨çš„DROPã€CREATEå’Œ INSERTè¯­å¥ã€‚</p><p>å¤‡ä»½å¤šå¼ è¡¨ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤ï¼Œæ¯”å¦‚å¤‡ä»½bookå’Œaccountè¡¨ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#å¤‡ä»½å¤šå¼ è¡¨</span><br><span class="line">mysqldump -uroot -p atguigu book account &gt; 2_tables_bak.sql</span><br></pre></td></tr></table></figure><h3 id="2-5-å¤‡ä»½å•è¡¨çš„éƒ¨åˆ†æ•°æ®"><a href="#2-5-å¤‡ä»½å•è¡¨çš„éƒ¨åˆ†æ•°æ®" class="headerlink" title="2.5 å¤‡ä»½å•è¡¨çš„éƒ¨åˆ†æ•°æ®"></a>2.5 å¤‡ä»½å•è¡¨çš„éƒ¨åˆ†æ•°æ®</h3><p>æœ‰äº›æ—¶å€™ä¸€å¼ è¡¨çš„æ•°æ®é‡å¾ˆå¤§ï¼Œæˆ‘ä»¬åªéœ€è¦éƒ¨åˆ†æ•°æ®ã€‚è¿™æ—¶å°±å¯ä»¥ä½¿ç”¨ â€“where é€‰é¡¹äº†ã€‚whereåé¢é™„å¸¦éœ€è¦æ»¡è¶³çš„æ¡ä»¶ã€‚</p><p>ä¸¾ä¾‹ï¼šå¤‡ä»½studentè¡¨ä¸­idå°äº10çš„æ•°æ®ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldump -uroot -p atguigu student --where=&quot;id &lt; 10 &quot; &gt; student_part_id10_low_bak.sql</span><br></pre></td></tr></table></figure><p>å†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼Œinsertè¯­å¥åªæœ‰idå°äº10çš„éƒ¨åˆ†</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">LOCK TABLES `student` WRITE;</span><br><span class="line">/*!40000 ALTER TABLE `student` DISABLE KEYS */;</span><br><span class="line">INSERT INTO `student` VALUES (1,100002,&#x27;JugxTY&#x27;,157,280),(2,100003,&#x27;QyUcCJ&#x27;,251,277),</span><br><span class="line">(3,100004,&#x27;lATUPp&#x27;,80,404),(4,100005,&#x27;BmFsXI&#x27;,240,171),(5,100006,&#x27;mkpSwJ&#x27;,388,476),</span><br><span class="line">(6,100007,&#x27;ujMgwN&#x27;,259,124),(7,100008,&#x27;HBJTqX&#x27;,429,168),(8,100009,&#x27;dvQSQA&#x27;,61,504),</span><br><span class="line">(9,100010,&#x27;HljpVJ&#x27;,234,185);</span><br></pre></td></tr></table></figure><h3 id="2-6-æ’é™¤æŸäº›è¡¨çš„å¤‡ä»½"><a href="#2-6-æ’é™¤æŸäº›è¡¨çš„å¤‡ä»½" class="headerlink" title="2.6 æ’é™¤æŸäº›è¡¨çš„å¤‡ä»½"></a>2.6 æ’é™¤æŸäº›è¡¨çš„å¤‡ä»½</h3><p>å¦‚æœæˆ‘ä»¬æƒ³å¤‡ä»½æŸä¸ªåº“ï¼Œä½†æ˜¯æŸäº›è¡¨æ•°æ®é‡å¾ˆå¤§æˆ–è€…ä¸ä¸šåŠ¡å…³è”ä¸å¤§ï¼Œè¿™ä¸ªæ—¶å€™å¯ä»¥è€ƒè™‘æ’é™¤æ‰è¿™äº›è¡¨ï¼ŒåŒæ ·çš„ï¼Œé€‰é¡¹ <code>--ignore-table</code> å¯ä»¥å®Œæˆè¿™ä¸ªåŠŸèƒ½ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldump -uroot -p atguigu --ignore-table=atguigu.student &gt; no_stu_bak.sql</span><br></pre></td></tr></table></figure><p>é€šè¿‡å¦‚ä¸‹æŒ‡å®šåˆ¤å®šæ–‡ä»¶ä¸­æ²¡æœ‰studentè¡¨ç»“æ„ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep &quot;student&quot; no_stu_bak.sql</span><br></pre></td></tr></table></figure><h3 id="2-7-åªå¤‡ä»½ç»“æ„æˆ–åªå¤‡ä»½æ•°æ®"><a href="#2-7-åªå¤‡ä»½ç»“æ„æˆ–åªå¤‡ä»½æ•°æ®" class="headerlink" title="2.7 åªå¤‡ä»½ç»“æ„æˆ–åªå¤‡ä»½æ•°æ®"></a>2.7 åªå¤‡ä»½ç»“æ„æˆ–åªå¤‡ä»½æ•°æ®</h3><p>åªå¤‡ä»½ç»“æ„çš„è¯å¯ä»¥ä½¿ç”¨ <code>--no-data</code> ç®€å†™ä¸º <code>-d</code> é€‰é¡¹ï¼›åªå¤‡ä»½æ•°æ®å¯ä»¥ä½¿ç”¨ <code>--no-create-info</code> ç®€å†™ä¸º <code>-t</code>é€‰é¡¹ã€‚</p><ul><li><p>åªå¤‡ä»½ç»“æ„</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysqldump -uroot -p atguigu --no-data &gt; atguigu_no_data_bak.sql</span><br><span class="line">#ä½¿ç”¨grepå‘½ä»¤ï¼Œæ²¡æœ‰æ‰¾åˆ°insertç›¸å…³è¯­å¥ï¼Œè¡¨ç¤ºæ²¡æœ‰æ•°æ®å¤‡ä»½ã€‚</span><br><span class="line">[root@node1 ~]# grep &quot;INSERT&quot; atguigu_no_data_bak.sql</span><br><span class="line">[root@node1 ~]#</span><br></pre></td></tr></table></figure></li><li><p>åªå¤‡ä»½æ•°æ®</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysqldump -uroot -p atguigu --no-create-info &gt; atguigu_no_create_info_bak.sql</span><br><span class="line">#ä½¿ç”¨grepå‘½ä»¤ï¼Œæ²¡æœ‰æ‰¾åˆ°createç›¸å…³è¯­å¥ï¼Œè¡¨ç¤ºæ²¡æœ‰æ•°æ®ç»“æ„ã€‚</span><br><span class="line">[root@node1 ~]# grep &quot;CREATE&quot; atguigu_no_create_info_bak.sql</span><br><span class="line">[root@node1 ~]#</span><br></pre></td></tr></table></figure></li></ul><h3 id="2-8-å¤‡ä»½ä¸­åŒ…å«å­˜å‚¨è¿‡ç¨‹ã€å‡½æ•°ã€äº‹ä»¶"><a href="#2-8-å¤‡ä»½ä¸­åŒ…å«å­˜å‚¨è¿‡ç¨‹ã€å‡½æ•°ã€äº‹ä»¶" class="headerlink" title="2.8 å¤‡ä»½ä¸­åŒ…å«å­˜å‚¨è¿‡ç¨‹ã€å‡½æ•°ã€äº‹ä»¶"></a>2.8 å¤‡ä»½ä¸­åŒ…å«å­˜å‚¨è¿‡ç¨‹ã€å‡½æ•°ã€äº‹ä»¶</h3><p>mysqldumpå¤‡ä»½é»˜è®¤æ˜¯ä¸åŒ…å«å­˜å‚¨è¿‡ç¨‹ï¼Œè‡ªå®šä¹‰å‡½æ•°åŠäº‹ä»¶çš„ã€‚å¯ä»¥ä½¿ç”¨ <code>--routines</code> æˆ– <code>-R</code> é€‰é¡¹æ¥å¤‡ä»½å­˜å‚¨è¿‡ç¨‹åŠå‡½æ•°ï¼Œä½¿ç”¨ <code>--events</code> æˆ– <code>-E</code> å‚æ•°æ¥å¤‡ä»½äº‹ä»¶ã€‚</p><p>ä¸¾ä¾‹ï¼šå¤‡ä»½æ•´ä¸ªatguiguåº“ï¼ŒåŒ…å«å­˜å‚¨è¿‡ç¨‹åŠäº‹ä»¶ï¼š</p><ul><li>ä½¿ç”¨ä¸‹é¢çš„SQLå¯ä»¥æŸ¥çœ‹å½“å‰åº“æœ‰å“ªäº›å­˜å‚¨è¿‡ç¨‹æˆ–è€…å‡½æ•°</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT SPECIFIC_NAME,ROUTINE_TYPE ,ROUTINE_SCHEMA FROM</span><br><span class="line">information_schema.Routines WHERE ROUTINE_SCHEMA=&quot;atguigu&quot;;</span><br><span class="line">+---------------+--------------+----------------+</span><br><span class="line">| SPECIFIC_NAME | ROUTINE_TYPE | ROUTINE_SCHEMA |</span><br><span class="line">+---------------+--------------+----------------+</span><br><span class="line">| rand_num      | FUNCTION     | atguigu        |</span><br><span class="line">| rand_string   | FUNCTION     | atguigu        |</span><br><span class="line">| BatchInsert   | PROCEDURE    | atguigu        |</span><br><span class="line">| insert_class  | PROCEDURE    | atguigu        |</span><br><span class="line">| insert_order  | PROCEDURE    | atguigu        |</span><br><span class="line">| insert_stu    | PROCEDURE    | atguigu        |</span><br><span class="line">| insert_user   | PROCEDURE    | atguigu        |</span><br><span class="line">| ts_insert     | PROCEDURE    | atguigu        |</span><br><span class="line">+---------------+--------------+----------------+</span><br><span class="line">9 rows in set (0.02 sec)</span><br></pre></td></tr></table></figure><p>ä¸‹é¢å¤‡ä»½atguiguåº“çš„æ•°æ®ï¼Œå‡½æ•°ä»¥åŠå­˜å‚¨è¿‡ç¨‹ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldump -uroot -p -R -E --databases atguigu &gt; fun_atguigu_bak.sql</span><br></pre></td></tr></table></figure><p>æŸ¥è¯¢å¤‡ä»½æ–‡ä»¶ä¸­æ˜¯å¦å­˜åœ¨å‡½æ•°ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼Œå¯ä»¥çœ‹åˆ°ç¡®å®åŒ…å«äº†å‡½æ•°ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">grep -C 5 &quot;rand_num&quot; fun_atguigu_bak.sql</span><br><span class="line">--</span><br><span class="line">--</span><br><span class="line">-- Dumping routines for database &#x27;atguigu&#x27;</span><br><span class="line">--</span><br><span class="line">/*!50003 DROP FUNCTION IF EXISTS `rand_num` */;</span><br><span class="line">/*!50003 SET @saved_cs_client = @@character_set_client */ ;</span><br><span class="line">/*!50003 SET @saved_cs_results = @@character_set_results */ ;</span><br><span class="line">/*!50003 SET @saved_col_connection = @@collation_connection */ ;</span><br><span class="line">/*!50003 SET character_set_client = utf8mb3 */ ;</span><br><span class="line">/*!50003 SET character_set_results = utf8mb3 */ ;</span><br><span class="line">/*!50003 SET collation_connection = utf8_general_ci */ ;</span><br><span class="line">/*!50003 SET @saved_sql_mode = @@sql_mode */ ;</span><br><span class="line">/*!50003 SET sql_mode =</span><br><span class="line">&#x27;ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISIO</span><br><span class="line">N_BY_ZERO,NO_ENGINE_SUBSTITUTION&#x27; */ ;</span><br><span class="line">DELIMITER ;;</span><br><span class="line">CREATE DEFINER=`root`@`%` FUNCTION `rand_num`(from_num BIGINT ,to_num BIGINT) RETURNS</span><br><span class="line">bigint</span><br><span class="line">BEGIN</span><br><span class="line">DECLARE i BIGINT DEFAULT 0;</span><br><span class="line">SET i = FLOOR(from_num +RAND()*(to_num - from_num+1)) ;</span><br><span class="line">RETURN i;</span><br><span class="line">END ;;</span><br><span class="line">--</span><br><span class="line">BEGIN</span><br><span class="line">DECLARE i INT DEFAULT 0;</span><br><span class="line">    SET autocommit = 0;</span><br><span class="line">    REPEAT</span><br><span class="line">    SET i = i + 1;</span><br><span class="line">    INSERT INTO class ( classname,address,monitor ) VALUES</span><br><span class="line">    (rand_string(8),rand_string(10),rand_num());</span><br><span class="line">    UNTIL i = max_num</span><br><span class="line">    END REPEAT;</span><br><span class="line">    COMMIT;</span><br><span class="line">END ;;</span><br><span class="line">DELIMITER ;</span><br><span class="line">--</span><br><span class="line">BEGIN</span><br><span class="line">DECLARE i INT DEFAULT 0;</span><br><span class="line">    SET autocommit = 0; #è®¾ç½®æ‰‹åŠ¨æäº¤äº‹åŠ¡</span><br><span class="line">    REPEAT #å¾ªç¯</span><br><span class="line">    SET i = i + 1; #èµ‹å€¼</span><br><span class="line">    INSERT INTO order_test (order_id, trans_id ) VALUES</span><br><span class="line">    (rand_num(1,7000000),rand_num(100000000000000000,700000000000000000));</span><br><span class="line">    UNTIL i = max_num</span><br><span class="line">    END REPEAT;</span><br><span class="line">    COMMIT; #æäº¤äº‹åŠ¡</span><br><span class="line">END ;;</span><br><span class="line">DELIMITER ;</span><br><span class="line">--</span><br><span class="line">BEGIN</span><br><span class="line">DECLARE i INT DEFAULT 0;</span><br><span class="line">    SET autocommit = 0; #è®¾ç½®æ‰‹åŠ¨æäº¤äº‹åŠ¡</span><br><span class="line">    REPEAT #å¾ªç¯</span><br><span class="line">    SET i = i + 1; #èµ‹å€¼</span><br><span class="line">    INSERT INTO student (stuno, name ,age ,classId ) VALUES</span><br><span class="line">    ((START+i),rand_string(6),rand_num(),rand_num());</span><br><span class="line">    UNTIL i = max_num</span><br><span class="line">    END REPEAT;</span><br><span class="line">    COMMIT; #æäº¤äº‹åŠ¡</span><br><span class="line">END ;;</span><br><span class="line">DELIMITER ;</span><br><span class="line">--</span><br><span class="line">BEGIN</span><br><span class="line">DECLARE i INT DEFAULT 0;</span><br><span class="line">    SET autocommit = 0;</span><br><span class="line">    REPEAT</span><br><span class="line">    SET i = i + 1;</span><br><span class="line">    INSERT INTO `user` ( name,age,sex ) VALUES (&quot;atguigu&quot;,rand_num(1,20),&quot;male&quot;);</span><br><span class="line">    UNTIL i = max_num</span><br><span class="line">    END REPEAT;</span><br><span class="line">    COMMIT;</span><br><span class="line">END ;;</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure><h3 id="2-9-mysqldumpå¸¸ç”¨é€‰é¡¹"><a href="#2-9-mysqldumpå¸¸ç”¨é€‰é¡¹" class="headerlink" title="2.9 mysqldumpå¸¸ç”¨é€‰é¡¹"></a>2.9 mysqldumpå¸¸ç”¨é€‰é¡¹</h3><p>mysqldumpå…¶ä»–å¸¸ç”¨é€‰é¡¹å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">--add-drop-databaseï¼šåœ¨æ¯ä¸ªCREATE DATABASEè¯­å¥å‰æ·»åŠ DROP DATABASEè¯­å¥ã€‚</span><br><span class="line"></span><br><span class="line">--add-drop-tablesï¼šåœ¨æ¯ä¸ªCREATE TABLEè¯­å¥å‰æ·»åŠ DROP TABLEè¯­å¥ã€‚</span><br><span class="line"></span><br><span class="line">--add-lockingï¼šç”¨LOCK TABLESå’ŒUNLOCK TABLESè¯­å¥å¼•ç”¨æ¯ä¸ªè¡¨è½¬å‚¨ã€‚é‡è½½è½¬å‚¨æ–‡ä»¶æ—¶æ’å…¥å¾—æ›´å¿«ã€‚</span><br><span class="line"></span><br><span class="line">--all-database, -Aï¼šè½¬å‚¨æ‰€æœ‰æ•°æ®åº“ä¸­çš„æ‰€æœ‰è¡¨ã€‚ä¸ä½¿ç”¨--databaseé€‰é¡¹ç›¸åŒï¼Œåœ¨å‘½ä»¤è¡Œä¸­å‘½åæ‰€æœ‰æ•°æ®åº“ã€‚</span><br><span class="line"></span><br><span class="line">--comment[=0|1]ï¼šå¦‚æœè®¾ç½®ä¸º0ï¼Œç¦æ­¢è½¬å‚¨æ–‡ä»¶ä¸­çš„å…¶ä»–ä¿¡æ¯ï¼Œä¾‹å¦‚ç¨‹åºç‰ˆæœ¬ã€æœåŠ¡å™¨ç‰ˆæœ¬å’Œä¸»æœºã€‚--skipcommentsä¸--comments=0çš„ç»“æœç›¸åŒã€‚é»˜è®¤å€¼ä¸º1ï¼Œå³åŒ…æ‹¬é¢å¤–ä¿¡æ¯ã€‚</span><br><span class="line"></span><br><span class="line">--compactï¼šäº§ç”Ÿå°‘é‡è¾“å‡ºã€‚è¯¥é€‰é¡¹ç¦ç”¨æ³¨é‡Šå¹¶å¯ç”¨--skip-add-drop-tablesã€--no-set-namesã€--skipdisable-keyså’Œ--skip-add-lockingé€‰é¡¹ã€‚</span><br><span class="line"></span><br><span class="line">--compatible=nameï¼šäº§ç”Ÿä¸å…¶ä»–æ•°æ®åº“ç³»ç»Ÿæˆ–æ—§çš„MySQLæœåŠ¡å™¨æ›´å…¼å®¹çš„è¾“å‡ºï¼Œå€¼å¯ä»¥ä¸ºansiã€MySQL323ã€MySQL40ã€postgresqlã€oracleã€mssqlã€db2ã€maxdbã€no_key_optionsã€no_table_optionsæˆ–è€…no_field_optionsã€‚</span><br><span class="line"></span><br><span class="line">--complete_insert, -cï¼šä½¿ç”¨åŒ…æ‹¬åˆ—åçš„å®Œæ•´çš„INSERTè¯­å¥ã€‚</span><br><span class="line"></span><br><span class="line">--debug[=debug_options], -#[debug_options]ï¼šå†™è°ƒè¯•æ—¥å¿—ã€‚</span><br><span class="line"></span><br><span class="line">--deleteï¼Œ-Dï¼šå¯¼å…¥æ–‡æœ¬æ–‡ä»¶å‰æ¸…ç©ºè¡¨ã€‚</span><br><span class="line"></span><br><span class="line">--default-character-set=charsetï¼šä½¿ç”¨charsetsé»˜è®¤å­—ç¬¦é›†ã€‚å¦‚æœæ²¡æœ‰æŒ‡å®šï¼Œå°±ä½¿ç”¨utf8ã€‚</span><br><span class="line"></span><br><span class="line">--delete--master-logsï¼šåœ¨ä¸»å¤åˆ¶æœåŠ¡å™¨ä¸Šï¼Œå®Œæˆè½¬å‚¨æ“ä½œååˆ é™¤äºŒè¿›åˆ¶æ—¥å¿—ã€‚è¯¥é€‰é¡¹è‡ªåŠ¨å¯ç”¨-masterdataã€‚</span><br><span class="line"></span><br><span class="line">--extended-insertï¼Œ-eï¼šä½¿ç”¨åŒ…æ‹¬å‡ ä¸ªVALUESåˆ—è¡¨çš„å¤šè¡ŒINSERTè¯­æ³•ã€‚è¿™æ ·ä½¿å¾—è½¬å‚¨æ–‡ä»¶æ›´å°ï¼Œé‡è½½æ–‡ä»¶æ—¶å¯ä»¥åŠ é€Ÿæ’å…¥ã€‚</span><br><span class="line"></span><br><span class="line">--flush-logsï¼Œ-Fï¼šå¼€å§‹è½¬å‚¨å‰åˆ·æ–°MySQLæœåŠ¡å™¨æ—¥å¿—æ–‡ä»¶ã€‚è¯¥é€‰é¡¹è¦æ±‚RELOADæƒé™ã€‚</span><br><span class="line"></span><br><span class="line">--forceï¼Œ-fï¼šåœ¨è¡¨è½¬å‚¨è¿‡ç¨‹ä¸­ï¼Œå³ä½¿å‡ºç°SQLé”™è¯¯ä¹Ÿç»§ç»­ã€‚</span><br><span class="line"></span><br><span class="line">--lock-all-tablesï¼Œ-xï¼šå¯¹æ‰€æœ‰æ•°æ®åº“ä¸­çš„æ‰€æœ‰è¡¨åŠ é”ã€‚åœ¨æ•´ä½“è½¬å‚¨è¿‡ç¨‹ä¸­é€šè¿‡å…¨å±€é”å®šæ¥å®ç°ã€‚è¯¥é€‰é¡¹è‡ªåŠ¨å…³é—­--single-transactionå’Œ--lock-tablesã€‚</span><br><span class="line"></span><br><span class="line">--lock-tablesï¼Œ-lï¼šå¼€å§‹è½¬å‚¨å‰é”å®šæ‰€æœ‰è¡¨ã€‚ç”¨READ LOCALé”å®šè¡¨ä»¥å…è®¸å¹¶è¡Œæ’å…¥MyISAMè¡¨ã€‚å¯¹äºäº‹åŠ¡è¡¨ï¼ˆä¾‹å¦‚InnoDBå’ŒBDBï¼‰ï¼Œ--single-transactionæ˜¯ä¸€ä¸ªæ›´å¥½çš„é€‰é¡¹ï¼Œå› ä¸ºå®ƒæ ¹æœ¬ä¸éœ€è¦é”å®šè¡¨ã€‚</span><br><span class="line"></span><br><span class="line">--no-create-dbï¼Œ-nï¼šè¯¥é€‰é¡¹ç¦ç”¨CREATE DATABASE /*!32312 IF NOT EXIST*/db_nameè¯­å¥ï¼Œå¦‚æœç»™å‡º--databaseæˆ–--all-databaseé€‰é¡¹ï¼Œå°±åŒ…å«åˆ°è¾“å‡ºä¸­ã€‚</span><br><span class="line"></span><br><span class="line">--no-create-infoï¼Œ-tï¼šåªå¯¼å‡ºæ•°æ®ï¼Œè€Œä¸æ·»åŠ CREATE TABLEè¯­å¥ã€‚</span><br><span class="line"></span><br><span class="line">--no-dataï¼Œ-dï¼šä¸å†™è¡¨çš„ä»»ä½•è¡Œä¿¡æ¯ï¼Œåªè½¬å‚¨è¡¨çš„ç»“æ„ã€‚</span><br><span class="line"></span><br><span class="line">--optï¼šè¯¥é€‰é¡¹æ˜¯é€Ÿè®°ï¼Œå®ƒå¯ä»¥å¿«é€Ÿè¿›è¡Œè½¬å‚¨æ“ä½œå¹¶äº§ç”Ÿä¸€ä¸ªèƒ½å¾ˆå¿«è£…å…¥MySQLæœåŠ¡å™¨çš„è½¬å‚¨æ–‡ä»¶ã€‚è¯¥é€‰é¡¹é»˜è®¤å¼€å¯ï¼Œä½†å¯ä»¥ç”¨--skip-optç¦ç”¨ã€‚</span><br><span class="line"></span><br><span class="line">--password[=password]ï¼Œ-p[password]ï¼šå½“è¿æ¥æœåŠ¡å™¨æ—¶ä½¿ç”¨çš„å¯†ç ã€‚</span><br><span class="line"></span><br><span class="line">-port=port_numï¼Œ-P port_numï¼šç”¨äºè¿æ¥çš„TCP/IPç«¯å£å·ã€‚</span><br><span class="line"></span><br><span class="line">--protocol=&#123;TCP|SOCKET|PIPE|MEMORY&#125;ï¼šä½¿ç”¨çš„è¿æ¥åè®®ã€‚</span><br><span class="line"></span><br><span class="line">--replaceï¼Œ-r â€“replaceå’Œ--ignoreï¼šæ§åˆ¶æ›¿æ¢æˆ–å¤åˆ¶å”¯ä¸€é”®å€¼å·²æœ‰è®°å½•çš„è¾“å…¥è®°å½•çš„å¤„ç†ã€‚å¦‚æœæŒ‡å®š--replaceï¼Œæ–°è¡Œæ›¿æ¢æœ‰ç›¸åŒçš„å”¯ä¸€é”®å€¼çš„å·²æœ‰è¡Œï¼›å¦‚æœæŒ‡å®š--ignoreï¼Œå¤åˆ¶å·²æœ‰çš„å”¯ä¸€é”®å€¼çš„è¾“å…¥è¡Œè¢«è·³è¿‡ã€‚å¦‚æœä¸æŒ‡å®šè¿™ä¸¤ä¸ªé€‰é¡¹ï¼Œå½“å‘ç°ä¸€ä¸ªå¤åˆ¶é”®å€¼æ—¶ä¼šå‡ºç°ä¸€ä¸ªé”™è¯¯ï¼Œå¹¶ä¸”å¿½è§†æ–‡æœ¬æ–‡ä»¶çš„å‰©ä½™éƒ¨åˆ†ã€‚</span><br><span class="line"></span><br><span class="line">--silentï¼Œ-sï¼šæ²‰é»˜æ¨¡å¼ã€‚åªæœ‰å‡ºç°é”™è¯¯æ—¶æ‰è¾“å‡ºã€‚</span><br><span class="line"></span><br><span class="line">--socket=pathï¼Œ-S pathï¼šå½“è¿æ¥localhostæ—¶ä½¿ç”¨çš„å¥—æ¥å­—æ–‡ä»¶ï¼ˆä¸ºé»˜è®¤ä¸»æœºï¼‰ã€‚</span><br><span class="line"></span><br><span class="line">--user=user_nameï¼Œ-u user_nameï¼šå½“è¿æ¥æœåŠ¡å™¨æ—¶MySQLä½¿ç”¨çš„ç”¨æˆ·åã€‚</span><br><span class="line"></span><br><span class="line">--verboseï¼Œ-vï¼šå†—é•¿æ¨¡å¼ï¼Œæ‰“å°å‡ºç¨‹åºæ“ä½œçš„è¯¦ç»†ä¿¡æ¯ã€‚</span><br><span class="line"></span><br><span class="line">--xmlï¼Œ-Xï¼šäº§ç”ŸXMLè¾“å‡ºã€‚</span><br></pre></td></tr></table></figure><p>è¿è¡Œå¸®åŠ©å‘½ä»¤ <code>mysqldump --help</code> ï¼Œå¯ä»¥è·å¾—ç‰¹å®šç‰ˆæœ¬çš„å®Œæ•´é€‰é¡¹åˆ—è¡¨ã€‚</p><blockquote><p>æç¤º å¦‚æœè¿è¡Œmysqldumpæ²¡æœ‰â€“quickæˆ–â€“opté€‰é¡¹ï¼Œmysqldumpåœ¨è½¬å‚¨ç»“æœå‰å°†æ•´ä¸ªç»“æœé›†è£…å…¥å†… å­˜ã€‚å¦‚æœè½¬å‚¨å¤§æ•°æ®åº“å¯èƒ½ä¼šå‡ºç°é—®é¢˜ï¼Œè¯¥é€‰é¡¹é»˜è®¤å¯ç”¨ï¼Œä½†å¯ä»¥ç”¨â€“skip-optç¦ç”¨ã€‚å¦‚æœä½¿ç”¨æœ€ æ–°ç‰ˆæœ¬çš„mysqldumpç¨‹åºå¤‡ä»½æ•°æ®ï¼Œå¹¶ç”¨äºæ¢å¤åˆ°æ¯”è¾ƒæ—§ç‰ˆæœ¬çš„MySQLæœåŠ¡å™¨ä¸­ï¼Œåˆ™ä¸è¦ä½¿ç”¨â€“opt æˆ–-eé€‰é¡¹ã€‚</p></blockquote><h2 id="3-mysqlå‘½ä»¤æ¢å¤æ•°æ®"><a href="#3-mysqlå‘½ä»¤æ¢å¤æ•°æ®" class="headerlink" title="3. mysqlå‘½ä»¤æ¢å¤æ•°æ®"></a>3. mysqlå‘½ä»¤æ¢å¤æ•°æ®</h2><p>ä½¿ç”¨mysqldumpå‘½ä»¤å°†æ•°æ®åº“ä¸­çš„æ•°æ®å¤‡ä»½æˆä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ã€‚éœ€è¦æ¢å¤æ—¶ï¼Œå¯ä»¥ä½¿ç”¨<code>mysqlå‘½ä»¤</code>æ¥æ¢å¤å¤‡ä»½çš„æ•°æ®ã€‚</p><p>mysqlå‘½ä»¤å¯ä»¥æ‰§è¡Œå¤‡ä»½æ–‡ä»¶ä¸­çš„<code>CREATEè¯­å¥</code>å’Œ<code>INSERTè¯­å¥</code>ã€‚é€šè¿‡CREATEè¯­å¥æ¥åˆ›å»ºæ•°æ®åº“å’Œè¡¨ã€‚é€šè¿‡INSERTè¯­å¥æ¥æ’å…¥å¤‡ä»½çš„æ•°æ®ã€‚</p><p>åŸºæœ¬è¯­æ³•ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql â€“u root â€“p [dbname] &lt; backup.sql</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ï¼Œdbnameå‚æ•°è¡¨ç¤ºæ•°æ®åº“åç§°ã€‚è¯¥å‚æ•°æ˜¯å¯é€‰å‚æ•°ï¼Œå¯ä»¥æŒ‡å®šæ•°æ®åº“åï¼Œä¹Ÿå¯ä»¥ä¸æŒ‡å®šã€‚æŒ‡å®šæ•°æ®åº“åæ—¶ï¼Œè¡¨ç¤ºè¿˜åŸè¯¥æ•°æ®åº“ä¸‹çš„è¡¨ã€‚æ­¤æ—¶éœ€è¦ç¡®ä¿MySQLæœåŠ¡å™¨ä¸­å·²ç»åˆ›å»ºäº†è¯¥åçš„æ•°æ®åº“ã€‚ä¸æŒ‡å®šæ•°æ®åº“åï¼Œè¡¨ç¤ºè¿˜åŸæ–‡ä»¶ä¸­æ‰€æœ‰çš„æ•°æ®åº“ã€‚æ­¤æ—¶sqlæ–‡ä»¶ä¸­åŒ…å«æœ‰CREATE DATABASEè¯­å¥ï¼Œä¸éœ€è¦MySQLæœåŠ¡å™¨ä¸­å·²å­˜åœ¨çš„è¿™äº›æ•°æ®åº“ã€‚</p><h3 id="3-1-å•åº“å¤‡ä»½ä¸­æ¢å¤å•åº“"><a href="#3-1-å•åº“å¤‡ä»½ä¸­æ¢å¤å•åº“" class="headerlink" title="3.1 å•åº“å¤‡ä»½ä¸­æ¢å¤å•åº“"></a>3.1 å•åº“å¤‡ä»½ä¸­æ¢å¤å•åº“</h3><p>ä½¿ç”¨rootç”¨æˆ·ï¼Œå°†ä¹‹å‰ç»ƒä¹ ä¸­å¤‡ä»½çš„atguigu.sqlæ–‡ä»¶ä¸­çš„å¤‡ä»½å¯¼å…¥æ•°æ®åº“ä¸­ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š</p><p>å¦‚æœå¤‡ä»½æ–‡ä»¶ä¸­åŒ…å«äº†åˆ›å»ºæ•°æ®åº“çš„è¯­å¥ï¼Œåˆ™æ¢å¤çš„æ—¶å€™ä¸éœ€è¦æŒ‡å®šæ•°æ®åº“åç§°ï¼Œå¦‚ä¸‹æ‰€ç¤º</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -p &lt; atguigu.sql</span><br></pre></td></tr></table></figure><p>å¦åˆ™éœ€è¦æŒ‡å®šæ•°æ®åº“åç§°ï¼Œå¦‚ä¸‹æ‰€ç¤º</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -p atguigu4&lt; atguigu.sql</span><br></pre></td></tr></table></figure><h3 id="3-2-å…¨é‡å¤‡ä»½æ¢å¤"><a href="#3-2-å…¨é‡å¤‡ä»½æ¢å¤" class="headerlink" title="3.2 å…¨é‡å¤‡ä»½æ¢å¤"></a>3.2 å…¨é‡å¤‡ä»½æ¢å¤</h3><p>å¦‚æœæˆ‘ä»¬ç°åœ¨æœ‰æ˜¨å¤©çš„å…¨é‡å¤‡ä»½ï¼Œç°åœ¨æƒ³æ•´ä¸ªæ¢å¤ï¼Œåˆ™å¯ä»¥è¿™æ ·æ“ä½œï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql â€“u root â€“p &lt; all.sql</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -pxxxxxx &lt; all.sql</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œå®Œåï¼ŒMySQLæ•°æ®åº“ä¸­å°±å·²ç»æ¢å¤äº†all.sqlæ–‡ä»¶ä¸­çš„æ‰€æœ‰æ•°æ®åº“ã€‚</p><h3 id="3-3-å…¨é‡å¤‡ä»½æ¢å¤"><a href="#3-3-å…¨é‡å¤‡ä»½æ¢å¤" class="headerlink" title="3.3 å…¨é‡å¤‡ä»½æ¢å¤"></a>3.3 å…¨é‡å¤‡ä»½æ¢å¤</h3><p>å¯èƒ½æœ‰è¿™æ ·çš„éœ€æ±‚ï¼Œæ¯”å¦‚è¯´æˆ‘ä»¬åªæƒ³æ¢å¤æŸä¸€ä¸ªåº“ï¼Œä½†æ˜¯æˆ‘ä»¬æœ‰çš„æ˜¯æ•´ä¸ªå®ä¾‹çš„å¤‡ä»½ï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬å¯ä»¥ä»å…¨é‡å¤‡ä»½ä¸­åˆ†ç¦»å‡ºå•ä¸ªåº“çš„å¤‡ä»½ã€‚</p><p>ä¸¾ä¾‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sed -n &#x27;/^-- Current Database: `atguigu`/,/^-- Current Database: `/p&#x27; all_database.sql &gt; atguigu.sql</span><br><span class="line">#åˆ†ç¦»å®Œæˆåæˆ‘ä»¬å†å¯¼å…¥atguigu.sqlå³å¯æ¢å¤å•ä¸ªåº“</span><br></pre></td></tr></table></figure><h3 id="3-4-ä»å•åº“å¤‡ä»½ä¸­æ¢å¤å•è¡¨"><a href="#3-4-ä»å•åº“å¤‡ä»½ä¸­æ¢å¤å•è¡¨" class="headerlink" title="3.4 ä»å•åº“å¤‡ä»½ä¸­æ¢å¤å•è¡¨"></a>3.4 ä»å•åº“å¤‡ä»½ä¸­æ¢å¤å•è¡¨</h3><p>è¿™ä¸ªéœ€æ±‚è¿˜æ˜¯æ¯”è¾ƒå¸¸è§çš„ã€‚æ¯”å¦‚è¯´æˆ‘ä»¬çŸ¥é“å“ªä¸ªè¡¨è¯¯æ“ä½œäº†ï¼Œé‚£ä¹ˆå°±å¯ä»¥ç”¨å•è¡¨æ¢å¤çš„æ–¹å¼æ¥æ¢å¤ã€‚</p><p>ä¸¾ä¾‹ï¼šæˆ‘ä»¬æœ‰atguiguæ•´åº“çš„å¤‡ä»½ï¼Œä½†æ˜¯ç”±äºclassè¡¨è¯¯æ“ä½œï¼Œéœ€è¦å•ç‹¬æ¢å¤å‡ºè¿™å¼ è¡¨ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cat atguigu.sql | sed -e &#x27;/./&#123;H;$!d;&#125;&#x27; -e &#x27;x;/CREATE TABLE `class`/!d;q&#x27; &gt; class_structure.sql</span><br><span class="line">cat atguigu.sql | grep --ignore-case &#x27;insert into `class`&#x27; &gt; class_data.sql</span><br><span class="line">#ç”¨shellè¯­æ³•åˆ†ç¦»å‡ºåˆ›å»ºè¡¨çš„è¯­å¥åŠæ’å…¥æ•°æ®çš„è¯­å¥å å†ä¾æ¬¡å¯¼å‡ºå³å¯å®Œæˆæ¢å¤</span><br><span class="line"></span><br><span class="line">use atguigu;</span><br><span class="line">mysql&gt; source class_structure.sql;</span><br><span class="line">Query OK, 0 rows affected, 1 warning (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; source class_data.sql;</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br></pre></td></tr></table></figure><h2 id="4-ç‰©ç†å¤‡ä»½ï¼šç›´æ¥å¤åˆ¶æ•´ä¸ªæ•°æ®åº“"><a href="#4-ç‰©ç†å¤‡ä»½ï¼šç›´æ¥å¤åˆ¶æ•´ä¸ªæ•°æ®åº“" class="headerlink" title="4. ç‰©ç†å¤‡ä»½ï¼šç›´æ¥å¤åˆ¶æ•´ä¸ªæ•°æ®åº“"></a>4. ç‰©ç†å¤‡ä»½ï¼šç›´æ¥å¤åˆ¶æ•´ä¸ªæ•°æ®åº“</h2><p>ç›´æ¥å°†MySQLä¸­çš„æ•°æ®åº“æ–‡ä»¶å¤åˆ¶å‡ºæ¥ã€‚è¿™ç§æ–¹æ³•æœ€ç®€å•ï¼Œé€Ÿåº¦ä¹Ÿæœ€å¿«ã€‚MySQLçš„æ•°æ®åº“ç›®å½•ä½ç½®ä¸ä¸€ å®šç›¸åŒï¼š</p><ul><li>åœ¨Windowså¹³å°ä¸‹ï¼ŒMySQL 8.0å­˜æ”¾æ•°æ®åº“çš„ç›®å½•é€šå¸¸é»˜è®¤ä¸º â€œ C:\ProgramData\MySQL\MySQL Server 8.0\Data â€æˆ–è€…å…¶ä»–ç”¨æˆ·è‡ªå®šä¹‰ç›®å½•ï¼› </li><li>åœ¨Linuxå¹³å°ä¸‹ï¼Œæ•°æ®åº“ç›®å½•ä½ç½®é€šå¸¸ä¸º&#x2F;var&#x2F;lib&#x2F;mysql&#x2F;ï¼› </li><li>åœ¨MAC OSXå¹³å°ä¸‹ï¼Œæ•°æ®åº“ç›®å½•ä½ç½®é€šå¸¸ä¸ºâ€œ&#x2F;usr&#x2F;local&#x2F;mysql&#x2F;dataâ€</li></ul><p>ä½†ä¸ºäº†ä¿è¯å¤‡ä»½çš„ä¸€è‡´æ€§ã€‚éœ€è¦ä¿è¯ï¼š</p><ul><li>æ–¹å¼1ï¼šå¤‡ä»½å‰ï¼Œå°†æœåŠ¡å™¨åœæ­¢ã€‚</li><li>æ–¹å¼2ï¼šå¤‡ä»½å‰ï¼Œå¯¹ç›¸å…³è¡¨æ‰§è¡Œ FLUSH TABLES WITH READ LOCK æ“ä½œã€‚è¿™æ ·å½“å¤åˆ¶æ•°æ®åº“ç›®å½•ä¸­ çš„æ–‡ä»¶æ—¶ï¼Œå…è®¸å…¶ä»–å®¢æˆ·ç»§ç»­æŸ¥è¯¢è¡¨ã€‚åŒæ—¶ï¼ŒFLUSH TABLESè¯­å¥æ¥ç¡®ä¿å¼€å§‹å¤‡ä»½å‰å°†æ‰€æœ‰æ¿€æ´»çš„ç´¢ å¼•é¡µå†™å…¥ç¡¬ç›˜ã€‚</li></ul><p>è¿™ç§æ–¹å¼æ–¹ä¾¿ã€å¿«é€Ÿï¼Œä½†ä¸æ˜¯æœ€å¥½çš„å¤‡ä»½æ–¹æ³•ï¼Œå› ä¸ºå®é™…æƒ…å†µå¯èƒ½ <code>ä¸å…è®¸åœæ­¢MySQLæœåŠ¡å™¨</code> æˆ–è€… <code>é”ä½è¡¨</code> ï¼Œè€Œä¸”è¿™ç§æ–¹æ³• å¯¹InnoDBå­˜å‚¨å¼•æ“ çš„è¡¨ä¸é€‚ç”¨ã€‚å¯¹äºMyISAMå­˜å‚¨å¼•æ“çš„è¡¨ï¼Œè¿™æ ·å¤‡ä»½å’Œè¿˜åŸå¾ˆæ–¹ä¾¿ï¼Œä½†æ˜¯è¿˜åŸæ—¶æœ€å¥½æ˜¯ç›¸åŒç‰ˆæœ¬çš„MySQLæ•°æ®åº“ï¼Œå¦åˆ™å¯èƒ½ä¼šå­˜åœ¨æ–‡ä»¶ç±»å‹ä¸åŒçš„æƒ…å†µã€‚</p><p>æ³¨æ„ï¼Œç‰©ç†å¤‡ä»½å®Œæ¯•åï¼Œæ‰§è¡Œ UNLOCK TABLES æ¥ç»“ç®—å…¶ä»–å®¢æˆ·å¯¹è¡¨çš„ä¿®æ”¹è¡Œä¸ºã€‚</p><blockquote><p>è¯´æ˜ï¼š åœ¨MySQLç‰ˆæœ¬å·ä¸­ï¼Œç¬¬ä¸€ä¸ªæ•°å­—è¡¨ç¤ºä¸»ç‰ˆæœ¬å·ï¼Œä¸»ç‰ˆæœ¬å·ç›¸åŒçš„MySQLæ•°æ®åº“æ–‡ä»¶æ ¼å¼ç›¸åŒã€‚</p></blockquote><p>æ­¤å¤–ï¼Œè¿˜å¯ä»¥è€ƒè™‘ä½¿ç”¨ç›¸å…³å·¥å…·å®ç°å¤‡ä»½ã€‚æ¯”å¦‚ï¼Œ <code>MySQLhotcopy</code> å·¥å…·ã€‚MySQLhotcopyæ˜¯ä¸€ä¸ªPerlè„šæœ¬ï¼Œå®ƒä½¿ç”¨LOCK TABLESã€FLUSH TABLESå’Œcpæˆ–scpæ¥å¿«é€Ÿå¤‡ä»½æ•°æ®åº“ã€‚å®ƒæ˜¯å¤‡ä»½æ•°æ®åº“æˆ–å•ä¸ªè¡¨æœ€å¿«çš„é€”å¾„ï¼Œä½†å®ƒåªèƒ½è¿è¡Œåœ¨æ•°æ®åº“ç›®å½•æ‰€åœ¨çš„æœºå™¨ä¸Šï¼Œå¹¶ä¸”åªèƒ½å¤‡ä»½MyISAMç±»å‹çš„è¡¨ã€‚å¤šç”¨äºmysql5.5ä¹‹å‰ã€‚</p><h2 id="5-ç‰©ç†æ¢å¤ï¼šç›´æ¥å¤åˆ¶åˆ°æ•°æ®åº“ç›®å½•"><a href="#5-ç‰©ç†æ¢å¤ï¼šç›´æ¥å¤åˆ¶åˆ°æ•°æ®åº“ç›®å½•" class="headerlink" title="5. ç‰©ç†æ¢å¤ï¼šç›´æ¥å¤åˆ¶åˆ°æ•°æ®åº“ç›®å½•"></a>5. ç‰©ç†æ¢å¤ï¼šç›´æ¥å¤åˆ¶åˆ°æ•°æ®åº“ç›®å½•</h2><p><strong>æ­¥éª¤ï¼š</strong></p><p>1ï¼‰æ¼”ç¤ºåˆ é™¤å¤‡ä»½çš„æ•°æ®åº“ä¸­æŒ‡å®šè¡¨çš„æ•°æ® </p><p>2ï¼‰å°†å¤‡ä»½çš„æ•°æ®åº“æ•°æ®æ‹·è´åˆ°æ•°æ®ç›®å½•ä¸‹ï¼Œå¹¶é‡å¯MySQLæœåŠ¡å™¨</p><p>3ï¼‰æŸ¥è¯¢ç›¸å…³è¡¨çš„æ•°æ®æ˜¯å¦æ¢å¤ã€‚éœ€è¦ä½¿ç”¨ä¸‹é¢çš„<code> chown</code> æ“ä½œã€‚</p><p><strong>è¦æ±‚ï¼š</strong></p><ul><li>å¿…é¡»ç¡®ä¿å¤‡ä»½æ•°æ®çš„æ•°æ®åº“å’Œå¾…æ¢å¤çš„æ•°æ®åº“æœåŠ¡å™¨çš„ä¸»ç‰ˆæœ¬å·ç›¸åŒã€‚<ul><li>å› ä¸ºåªæœ‰MySQLæ•°æ®åº“ä¸»ç‰ˆæœ¬å·ç›¸åŒæ—¶ï¼Œæ‰èƒ½ä¿è¯è¿™ä¸¤ä¸ªMySQLæ•°æ®åº“æ–‡ä»¶ç±»å‹æ˜¯ç›¸åŒçš„ã€‚</li></ul></li><li>è¿™ç§æ–¹å¼å¯¹ <code>MyISAMç±»å‹çš„è¡¨æ¯”è¾ƒæœ‰æ•ˆ</code> ï¼Œå¯¹äºInnoDBç±»å‹çš„è¡¨åˆ™ä¸å¯ç”¨ã€‚<ul><li>å› ä¸ºInnoDBè¡¨çš„è¡¨ç©ºé—´ä¸èƒ½ç›´æ¥å¤åˆ¶ã€‚</li></ul></li><li>åœ¨Linuxæ“ä½œç³»ç»Ÿä¸‹ï¼Œå¤åˆ¶åˆ°æ•°æ®åº“ç›®å½•åï¼Œä¸€å®šè¦å°†æ•°æ®åº“çš„ç”¨æˆ·å’Œç»„å˜æˆmysqlï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chown -R mysql.mysql /var/lib/mysql/dbname</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ï¼Œä¸¤ä¸ªmysqlåˆ†åˆ«è¡¨ç¤ºç»„å’Œç”¨æˆ·ï¼›â€œ-Râ€å‚æ•°å¯ä»¥æ”¹å˜æ–‡ä»¶å¤¹ä¸‹çš„æ‰€æœ‰å­æ–‡ä»¶çš„ç”¨æˆ·å’Œç»„ï¼›â€œdbnameâ€å‚æ•°è¡¨ç¤ºæ•°æ®åº“ç›®å½•ã€‚</p><blockquote><p>æç¤º Linuxæ“ä½œç³»ç»Ÿä¸‹çš„æƒé™è®¾ç½®éå¸¸ä¸¥æ ¼ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼ŒMySQLæ•°æ®åº“åªæœ‰rootç”¨æˆ·å’Œmysqlç”¨æˆ· ç»„ä¸‹çš„mysqlç”¨æˆ·æ‰å¯ä»¥è®¿é—®ï¼Œå› æ­¤å°†æ•°æ®åº“ç›®å½•å¤åˆ¶åˆ°æŒ‡å®šæ–‡ä»¶å¤¹åï¼Œä¸€å®šè¦ä½¿ç”¨chownå‘½ä»¤å°† æ–‡ä»¶å¤¹çš„ç”¨æˆ·ç»„å˜ä¸ºmysqlï¼Œå°†ç”¨æˆ·å˜ä¸ºmysqlã€‚</p></blockquote><h2 id="6-è¡¨çš„å¯¼å‡ºä¸å¯¼å…¥"><a href="#6-è¡¨çš„å¯¼å‡ºä¸å¯¼å…¥" class="headerlink" title="6. è¡¨çš„å¯¼å‡ºä¸å¯¼å…¥"></a>6. è¡¨çš„å¯¼å‡ºä¸å¯¼å…¥</h2><h3 id="6-1-è¡¨çš„å¯¼å‡º"><a href="#6-1-è¡¨çš„å¯¼å‡º" class="headerlink" title="6.1 è¡¨çš„å¯¼å‡º"></a>6.1 è¡¨çš„å¯¼å‡º</h3><h4 id="1-ä½¿ç”¨SELECTâ€¦INTO-OUTFILEå¯¼å‡ºæ–‡æœ¬æ–‡ä»¶"><a href="#1-ä½¿ç”¨SELECTâ€¦INTO-OUTFILEå¯¼å‡ºæ–‡æœ¬æ–‡ä»¶" class="headerlink" title="1. ä½¿ç”¨SELECTâ€¦INTO OUTFILEå¯¼å‡ºæ–‡æœ¬æ–‡ä»¶"></a>1. ä½¿ç”¨SELECTâ€¦INTO OUTFILEå¯¼å‡ºæ–‡æœ¬æ–‡ä»¶</h4><p>åœ¨MySQLä¸­ï¼Œå¯ä»¥ä½¿ç”¨SELECTâ€¦INTO OUTFILEè¯­å¥å°†è¡¨çš„å†…å®¹å¯¼å‡ºæˆä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ã€‚</p><p><strong>ä¸¾ä¾‹ï¼š</strong>ä½¿ç”¨SELECTâ€¦INTO OUTFILEå°†atguiguæ•°æ®åº“ä¸­accountè¡¨ä¸­çš„è®°å½•å¯¼å‡ºåˆ°æ–‡æœ¬æ–‡ä»¶ã€‚ </p><p>ï¼ˆ1ï¼‰é€‰æ‹©æ•°æ®åº“atguiguï¼Œå¹¶æŸ¥è¯¢accountè¡¨ï¼Œæ‰§è¡Œç»“æœå¦‚ä¸‹æ‰€ç¤ºã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">use atguigu;</span><br><span class="line">select * from account;</span><br><span class="line">mysql&gt; select * from account;</span><br><span class="line">+----+--------+---------+</span><br><span class="line">| id | name | balance |</span><br><span class="line">+----+--------+---------+</span><br><span class="line">| 1 | å¼ ä¸‰ | 90 |</span><br><span class="line">| 2 | æå›› | 100 |</span><br><span class="line">| 3 | ç‹äº” | 0 |</span><br><span class="line">+----+--------+---------+</span><br><span class="line">3 rows in set (0.01 sec)</span><br></pre></td></tr></table></figure><p>ï¼ˆ2ï¼‰mysqlé»˜è®¤å¯¹å¯¼å‡ºçš„ç›®å½•æœ‰æƒé™é™åˆ¶ï¼Œä¹Ÿå°±æ˜¯è¯´ä½¿ç”¨å‘½ä»¤è¡Œè¿›è¡Œå¯¼å‡ºçš„æ—¶å€™ï¼Œéœ€è¦æŒ‡å®šç›®å½•è¿›è¡Œæ“ä½œã€‚</p><p>æŸ¥è¯¢secure_file_privå€¼ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SHOW GLOBAL VARIABLES LIKE &#x27;%secure%&#x27;;</span><br><span class="line">+--------------------------+-----------------------+</span><br><span class="line">| Variable_name            | Value                 |</span><br><span class="line">+--------------------------+-----------------------+</span><br><span class="line">| require_secure_transport | OFF                   |</span><br><span class="line">| secure_file_priv         | /var/lib/mysql-files/ |</span><br><span class="line">+--------------------------+-----------------------+</span><br><span class="line">2 rows in set (0.02 sec)</span><br></pre></td></tr></table></figure><img src="/2023/03/04/04-%E6%97%A5%E5%BF%97%E4%B8%8E%E5%A4%87%E4%BB%BD%E7%AF%87/image-20220718163627669.png" class=""><p>ï¼ˆ3ï¼‰ä¸Šé¢ç»“æœä¸­æ˜¾ç¤ºï¼Œsecure_file_privå˜é‡çš„å€¼ä¸º&#x2F;var&#x2F;lib&#x2F;mysql-files&#x2F;ï¼Œå¯¼å‡ºç›®å½•è®¾ç½®ä¸ºè¯¥ç›®å½•ï¼ŒSQLè¯­å¥å¦‚ä¸‹ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM account INTO OUTFILE &quot;/var/lib/mysql-files/account.txt&quot;;</span><br></pre></td></tr></table></figure><p>ï¼ˆ4ï¼‰æŸ¥çœ‹ &#x2F;var&#x2F;lib&#x2F;mysql-files&#x2F;account.txt&#96;æ–‡ä»¶ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1 å¼ ä¸‰ 90</span><br><span class="line">2 æå›› 100</span><br><span class="line">3 ç‹äº” 0</span><br></pre></td></tr></table></figure><h4 id="2-ä½¿ç”¨mysqldumpå‘½ä»¤å¯¼å‡ºæ–‡æœ¬æ–‡ä»¶"><a href="#2-ä½¿ç”¨mysqldumpå‘½ä»¤å¯¼å‡ºæ–‡æœ¬æ–‡ä»¶" class="headerlink" title="2. ä½¿ç”¨mysqldumpå‘½ä»¤å¯¼å‡ºæ–‡æœ¬æ–‡ä»¶"></a>2. ä½¿ç”¨mysqldumpå‘½ä»¤å¯¼å‡ºæ–‡æœ¬æ–‡ä»¶</h4><p><strong>ä¸¾ä¾‹1ï¼š</strong>ä½¿ç”¨mysqldumpå‘½ä»¤å°†å°†atguiguæ•°æ®åº“ä¸­accountè¡¨ä¸­çš„è®°å½•å¯¼å‡ºåˆ°æ–‡æœ¬æ–‡ä»¶ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldump -uroot -p -T &quot;/var/lib/mysql-files/&quot; atguigu account</span><br></pre></td></tr></table></figure><p>mysqldumpå‘½ä»¤æ‰§è¡Œå®Œæ¯•åï¼Œåœ¨æŒ‡å®šçš„ç›®å½•&#x2F;var&#x2F;lib&#x2F;mysql-files&#x2F;ä¸‹ç”Ÿæˆäº†account.sqlå’Œaccount.txtæ–‡ä»¶ã€‚</p><p>æ‰“å¼€account.sqlæ–‡ä»¶ï¼Œå…¶å†…å®¹åŒ…å«åˆ›å»ºaccountè¡¨çš„CREATEè¯­å¥ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 mysql-files]# cat account.sql</span><br><span class="line">-- MySQL dump 10.13 Distrib 8.0.26, for Linux (x86_64)</span><br><span class="line">--</span><br><span class="line">-- Host: localhost Database: atguigu</span><br><span class="line">-- ------------------------------------------------------</span><br><span class="line">-- Server version 8.0.26</span><br><span class="line">/*!40101 SET @OLD_CHARACTER_SET_CLIENT=@@CHARACTER_SET_CLIENT */;</span><br><span class="line">/*!40101 SET @OLD_CHARACTER_SET_RESULTS=@@CHARACTER_SET_RESULTS */;</span><br><span class="line">/*!40101 SET @OLD_COLLATION_CONNECTION=@@COLLATION_CONNECTION */;</span><br><span class="line">/*!50503 SET NAMES utf8mb4 */;</span><br><span class="line">/*!40103 SET @OLD_TIME_ZONE=@@TIME_ZONE */;</span><br><span class="line">/*!40103 SET TIME_ZONE=&#x27;+00:00&#x27; */;</span><br><span class="line">/*!40101 SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE=&#x27;&#x27; */;</span><br><span class="line">/*!40111 SET @OLD_SQL_NOTES=@@SQL_NOTES, SQL_NOTES=0 */;</span><br><span class="line"></span><br><span class="line">--</span><br><span class="line">-- Table structure for table `account`</span><br><span class="line">--</span><br><span class="line"></span><br><span class="line">DROP TABLE IF EXISTS `account`;</span><br><span class="line">/*!40101 SET @saved_cs_client = @@character_set_client */;</span><br><span class="line">/*!50503 SET character_set_client = utf8mb4 */;</span><br><span class="line">CREATE TABLE `account` (</span><br><span class="line">`id` int NOT NULL AUTO_INCREMENT,</span><br><span class="line">`name` varchar(255) NOT NULL,</span><br><span class="line">`balance` int NOT NULL,</span><br><span class="line">PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=InnoDB AUTO_INCREMENT=4 DEFAULT CHARSET=utf8mb3;</span><br><span class="line">/*!40101 SET character_set_client = @saved_cs_client */;</span><br><span class="line"></span><br><span class="line">/*!40103 SET TIME_ZONE=@OLD_TIME_ZONE */;</span><br><span class="line"></span><br><span class="line">/*!40101 SET SQL_MODE=@OLD_SQL_MODE */;</span><br><span class="line">/*!40101 SET CHARACTER_SET_CLIENT=@OLD_CHARACTER_SET_CLIENT */;</span><br><span class="line">/*!40101 SET CHARACTER_SET_RESULTS=@OLD_CHARACTER_SET_RESULTS */;</span><br><span class="line">/*!40101 SET COLLATION_CONNECTION=@OLD_COLLATION_CONNECTION */;</span><br><span class="line">/*!40111 SET SQL_NOTES=@OLD_SQL_NOTES */;</span><br><span class="line"></span><br><span class="line">-- Dump completed on 2022-01-07 23:19:27</span><br></pre></td></tr></table></figure><p>æ‰“å¼€account.txtæ–‡ä»¶ï¼Œå…¶å†…å®¹åªåŒ…å«accountè¡¨ä¸­çš„æ•°æ®ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 mysql-files]# cat account.txt</span><br><span class="line">1 å¼ ä¸‰ 90</span><br><span class="line">2 æå›› 100</span><br><span class="line">3 ç‹äº” 0</span><br></pre></td></tr></table></figure><p><strong>ä¸¾ä¾‹2ï¼š</strong>ä½¿ç”¨mysqldumpå°†atguiguæ•°æ®åº“ä¸­çš„accountè¡¨å¯¼å‡ºåˆ°æ–‡æœ¬æ–‡ä»¶ï¼Œä½¿ç”¨FIELDSé€‰é¡¹ï¼Œè¦æ±‚å­—æ®µä¹‹ é—´ä½¿ç”¨é€—å·â€œï¼Œâ€é—´éš”ï¼Œæ‰€æœ‰å­—ç¬¦ç±»å‹å­—æ®µå€¼ç”¨åŒå¼•å·æ‹¬èµ·æ¥ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqldump -uroot -p -T &quot;/var/lib/mysql-files/&quot; atguigu account --fields-terminatedby=&#x27;,&#x27; --fields-optionally-enclosed-by=&#x27;\&quot;&#x27;</span><br></pre></td></tr></table></figure><p>è¯­å¥mysqldumpè¯­å¥æ‰§è¡ŒæˆåŠŸä¹‹åï¼ŒæŒ‡å®šç›®å½•ä¸‹ä¼šå‡ºç°ä¸¤ä¸ªæ–‡ä»¶account.sqlå’Œaccount.txtã€‚</p><p>æ‰“å¼€account.sqlæ–‡ä»¶ï¼Œå…¶å†…å®¹åŒ…å«åˆ›å»ºaccountè¡¨çš„CREATEè¯­å¥ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 mysql-files]# cat account.sql</span><br><span class="line">-- MySQL dump 10.13 Distrib 8.0.26, for Linux (x86_64)</span><br><span class="line">--</span><br><span class="line">-- Host: localhost Database: atguigu</span><br><span class="line">-- ------------------------------------------------------</span><br><span class="line">-- Server version 8.0.26</span><br><span class="line">/*!40101 SET @OLD_CHARACTER_SET_CLIENT=@@CHARACTER_SET_CLIENT */;</span><br><span class="line">/*!40101 SET @OLD_CHARACTER_SET_RESULTS=@@CHARACTER_SET_RESULTS */;</span><br><span class="line">/*!40101 SET @OLD_COLLATION_CONNECTION=@@COLLATION_CONNECTION */;</span><br><span class="line">/*!50503 SET NAMES utf8mb4 */;</span><br><span class="line">/*!40103 SET @OLD_TIME_ZONE=@@TIME_ZONE */;</span><br><span class="line">/*!40103 SET TIME_ZONE=&#x27;+00:00&#x27; */;</span><br><span class="line">/*!40101 SET @OLD_SQL_MODE=@@SQL_MODE, SQL_MODE=&#x27;&#x27; */;</span><br><span class="line">/*!40111 SET @OLD_SQL_NOTES=@@SQL_NOTES, SQL_NOTES=0 */;</span><br><span class="line">--</span><br><span class="line">-- Table structure for table `account`</span><br><span class="line">--</span><br><span class="line">DROP TABLE IF EXISTS `account`;</span><br><span class="line">/*!40101 SET @saved_cs_client = @@character_set_client */;</span><br><span class="line">/*!50503 SET character_set_client = utf8mb4 */;</span><br><span class="line">CREATE TABLE `account` (</span><br><span class="line">`id` int NOT NULL AUTO_INCREMENT,</span><br><span class="line">`name` varchar(255) NOT NULL,</span><br><span class="line">`balance` int NOT NULL,</span><br><span class="line">PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=InnoDB AUTO_INCREMENT=4 DEFAULT CHARSET=utf8mb3;</span><br><span class="line">/*!40101 SET character_set_client = @saved_cs_client */;</span><br><span class="line">/*!40103 SET TIME_ZONE=@OLD_TIME_ZONE */;</span><br><span class="line">/*!40101 SET SQL_MODE=@OLD_SQL_MODE */;</span><br><span class="line">/*!40101 SET CHARACTER_SET_CLIENT=@OLD_CHARACTER_SET_CLIENT */;</span><br><span class="line">/*!40101 SET CHARACTER_SET_RESULTS=@OLD_CHARACTER_SET_RESULTS */;</span><br><span class="line">/*!40101 SET COLLATION_CONNECTION=@OLD_COLLATION_CONNECTION */;</span><br><span class="line">/*!40111 SET SQL_NOTES=@OLD_SQL_NOTES */;</span><br><span class="line">-- Dump completed on 2022-01-07 23:36:39</span><br></pre></td></tr></table></figure><p>æ‰“å¼€account.txtæ–‡ä»¶ï¼Œå…¶å†…å®¹åŒ…å«åˆ›å»ºaccountè¡¨çš„æ•°æ®ã€‚ä»æ–‡ä»¶ä¸­å¯ä»¥çœ‹å‡ºï¼Œå­—æ®µä¹‹é—´ç”¨é€—å·éš”å¼€ï¼Œå­— ç¬¦ç±»å‹çš„å€¼è¢«åŒå¼•å·æ‹¬èµ·æ¥ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 mysql-files]# cat account.txt</span><br><span class="line">1,&quot;å¼ ä¸‰&quot;,90</span><br><span class="line">2,&quot;æå››&quot;,100</span><br><span class="line">3,&quot;ç‹äº”&quot;,0</span><br></pre></td></tr></table></figure><h4 id="3-ä½¿ç”¨mysqlå‘½ä»¤å¯¼å‡ºæ–‡æœ¬æ–‡ä»¶"><a href="#3-ä½¿ç”¨mysqlå‘½ä»¤å¯¼å‡ºæ–‡æœ¬æ–‡ä»¶" class="headerlink" title="3. ä½¿ç”¨mysqlå‘½ä»¤å¯¼å‡ºæ–‡æœ¬æ–‡ä»¶"></a>3. ä½¿ç”¨mysqlå‘½ä»¤å¯¼å‡ºæ–‡æœ¬æ–‡ä»¶</h4><p><strong>ä¸¾ä¾‹1ï¼š</strong>ä½¿ç”¨mysqlè¯­å¥å¯¼å‡ºatguiguæ•°æ®ä¸­accountè¡¨ä¸­çš„è®°å½•åˆ°æ–‡æœ¬æ–‡ä»¶ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -p --execute=&quot;SELECT * FROM account;&quot; atguigu&gt; &quot;/var/lib/mysql-files/account.txt&quot;</span><br></pre></td></tr></table></figure><p>æ‰“å¼€account.txtæ–‡ä»¶ï¼Œå…¶å†…å®¹åŒ…å«åˆ›å»ºaccountè¡¨çš„æ•°æ®ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 mysql-files]# cat account.txt</span><br><span class="line">id name balance</span><br><span class="line">1 å¼ ä¸‰ 90</span><br><span class="line">2 æå›› 100</span><br><span class="line">3 ç‹äº” 0</span><br></pre></td></tr></table></figure><p><strong>ä¸¾ä¾‹2ï¼š</strong>å°†atguiguæ•°æ®åº“accountè¡¨ä¸­çš„è®°å½•å¯¼å‡ºåˆ°æ–‡æœ¬æ–‡ä»¶ï¼Œä½¿ç”¨â€“veritcalå‚æ•°å°†è¯¥æ¡ä»¶è®°å½•åˆ†ä¸ºå¤šè¡Œæ˜¾ç¤ºï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -p --vertical --execute=&quot;SELECT * FROM account;&quot; atguigu &gt; &quot;/var/lib/mysql-files/account_1.txt&quot;</span><br></pre></td></tr></table></figure><p>æ‰“å¼€account_1.txtæ–‡ä»¶ï¼Œå…¶å†…å®¹åŒ…å«åˆ›å»ºaccountè¡¨çš„æ•°æ®ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 mysql-files]# cat account_1.txt</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">id: 1</span><br><span class="line">name: å¼ ä¸‰</span><br><span class="line">balance: 90</span><br><span class="line">*************************** 2. row ***************************</span><br><span class="line">id: 2</span><br><span class="line">name: æå››</span><br><span class="line">balance: 100</span><br><span class="line">*************************** 3. row ***************************</span><br><span class="line">id: 3</span><br><span class="line">name: ç‹äº”</span><br><span class="line">balance: 0</span><br></pre></td></tr></table></figure><p><strong>ä¸¾ä¾‹3ï¼š</strong>å°†atguiguæ•°æ®åº“accountè¡¨ä¸­çš„è®°å½•å¯¼å‡ºåˆ°xmlæ–‡ä»¶ï¼Œä½¿ç”¨â€“xmlå‚æ•°ï¼Œå…·ä½“è¯­å¥å¦‚ä¸‹ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql -uroot -p --xml --execute=&quot;SELECT * FROM account;&quot; atguigu&gt;&quot;/var/lib/mysqlfiles/account_3.xml&quot;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 mysql-files]# cat account_3.xml</span><br><span class="line">&lt;?xml version=&quot;1.0&quot;?&gt;</span><br><span class="line">&lt;resultset statement=&quot;SELECT * FROM account&quot;</span><br><span class="line">xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;&gt;</span><br><span class="line">&lt;row&gt;</span><br><span class="line">&lt;field name=&quot;id&quot;&gt;1&lt;/field&gt;</span><br><span class="line">&lt;field name=&quot;name&quot;&gt;å¼ ä¸‰&lt;/field&gt;</span><br><span class="line">&lt;field name=&quot;balance&quot;&gt;90&lt;/field&gt;</span><br><span class="line">&lt;/row&gt;</span><br><span class="line">&lt;row&gt;</span><br><span class="line">&lt;field name=&quot;id&quot;&gt;2&lt;/field&gt;</span><br><span class="line">&lt;field name=&quot;name&quot;&gt;æå››&lt;/field&gt;</span><br><span class="line">&lt;field name=&quot;balance&quot;&gt;100&lt;/field&gt;</span><br><span class="line">&lt;/row&gt;</span><br><span class="line">&lt;row&gt;</span><br><span class="line">&lt;field name=&quot;id&quot;&gt;3&lt;/field&gt;</span><br><span class="line">&lt;field name=&quot;name&quot;&gt;ç‹äº”&lt;/field&gt;</span><br><span class="line">&lt;field name=&quot;balance&quot;&gt;0&lt;/field&gt;</span><br><span class="line">&lt;/row&gt;</span><br><span class="line">&lt;/resultset&gt;</span><br></pre></td></tr></table></figure><p>è¯´æ˜ï¼šå¦‚æœè¦å°†è¡¨æ•°æ®å¯¼å‡ºåˆ°htmlæ–‡ä»¶ä¸­ï¼Œå¯ä»¥ä½¿ç”¨ <code>--html</code> é€‰é¡¹ã€‚ç„¶åå¯ä»¥ä½¿ç”¨æµè§ˆå™¨æ‰“å¼€ã€‚</p><h3 id="6-2-è¡¨çš„å¯¼å…¥"><a href="#6-2-è¡¨çš„å¯¼å…¥" class="headerlink" title="6.2 è¡¨çš„å¯¼å…¥"></a>6.2 è¡¨çš„å¯¼å…¥</h3><h4 id="1-ä½¿ç”¨LOAD-DATA-INFILEæ–¹å¼å¯¼å…¥æ–‡æœ¬æ–‡ä»¶"><a href="#1-ä½¿ç”¨LOAD-DATA-INFILEæ–¹å¼å¯¼å…¥æ–‡æœ¬æ–‡ä»¶" class="headerlink" title="1. ä½¿ç”¨LOAD DATA INFILEæ–¹å¼å¯¼å…¥æ–‡æœ¬æ–‡ä»¶"></a>1. ä½¿ç”¨LOAD DATA INFILEæ–¹å¼å¯¼å…¥æ–‡æœ¬æ–‡ä»¶</h4><p><strong>ä¸¾ä¾‹1ï¼š</strong></p><p>ä½¿ç”¨SELECTâ€¦INTO OUTFILEå°†atguiguæ•°æ®åº“ä¸­accountè¡¨çš„è®°å½•å¯¼å‡ºåˆ°æ–‡æœ¬æ–‡ä»¶</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM atguigu.account INTO OUTFILE &#x27;/var/lib/mysql-files/account_0.txt&#x27;;</span><br></pre></td></tr></table></figure><p>åˆ é™¤accountè¡¨ä¸­çš„æ•°æ®ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DELETE FROM atguigu.account;</span><br></pre></td></tr></table></figure><p>ä»æ–‡æœ¬æ–‡ä»¶account.txtä¸­æ¢å¤æ•°æ®ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LOAD DATA INFILE &#x27;/var/lib/mysql-files/account_0.txt&#x27; INTO TABLE atguigu.account;</span><br></pre></td></tr></table></figure><p>æŸ¥è¯¢accountè¡¨ä¸­çš„æ•°æ®ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from account;</span><br><span class="line">+----+--------+---------+</span><br><span class="line">| id | name   | balance |</span><br><span class="line">+----+--------+---------+</span><br><span class="line">| 1 | å¼ ä¸‰     | 90      |</span><br><span class="line">| 2 | æå››     | 100     |</span><br><span class="line">| 3 | ç‹äº”     | 0       |</span><br><span class="line">+----+--------+---------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><p><strong>ä¸¾ä¾‹2ï¼š</strong> é€‰æ‹©æ•°æ®åº“atguiguï¼Œä½¿ç”¨SELECTâ€¦INTO OUTFILEå°†atguiguæ•°æ®åº“accountè¡¨ä¸­çš„è®°å½•å¯¼å‡ºåˆ°æ–‡æœ¬æ–‡ä»¶ï¼Œä½¿ç”¨FIELDSé€‰é¡¹å’ŒLINESé€‰é¡¹ï¼Œè¦æ±‚å­—æ®µä¹‹é—´ä½¿ç”¨é€—å·â€ï¼Œâ€é—´éš”ï¼Œæ‰€æœ‰å­—æ®µå€¼ç”¨åŒå¼•å·æ‹¬èµ·æ¥ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM atguigu.account INTO OUTFILE &#x27;/var/lib/mysql-files/account_1.txt&#x27; FIELDS TERMINATED BY &#x27;,&#x27; ENCLOSED BY &#x27;\&quot;&#x27;;</span><br></pre></td></tr></table></figure><p>åˆ é™¤accountè¡¨ä¸­çš„æ•°æ®ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DELETE FROM atguigu.account;</span><br></pre></td></tr></table></figure><p>ä»&#x2F;var&#x2F;lib&#x2F;mysql-files&#x2F;account.txtä¸­å¯¼å…¥æ•°æ®åˆ°accountè¡¨ä¸­ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LOAD DATA INFILE &#x27;/var/lib/mysql-files/account_1.txt&#x27; INTO TABLE atguigu.account FIELDS TERMINATED BY &#x27;,&#x27; ENCLOSED BY &#x27;\&quot;&#x27;;</span><br></pre></td></tr></table></figure><p>æŸ¥è¯¢accountè¡¨ä¸­çš„æ•°æ®ï¼Œå…·ä½“SQLå¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">select * from account;</span><br><span class="line">mysql&gt; select * from account;</span><br><span class="line">+----+--------+---------+</span><br><span class="line">| id | name   | balance |</span><br><span class="line">+----+--------+---------+</span><br><span class="line">| 1 | å¼ ä¸‰     | 90      |</span><br><span class="line">| 2 | æå››     | 100     |</span><br><span class="line">| 3 | ç‹äº”     | 0       |</span><br><span class="line">+----+--------+---------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><h4 id="2-ä½¿ç”¨mysqlimportæ–¹å¼å¯¼å…¥æ–‡æœ¬æ–‡ä»¶"><a href="#2-ä½¿ç”¨mysqlimportæ–¹å¼å¯¼å…¥æ–‡æœ¬æ–‡ä»¶" class="headerlink" title="2. ä½¿ç”¨mysqlimportæ–¹å¼å¯¼å…¥æ–‡æœ¬æ–‡ä»¶"></a>2. ä½¿ç”¨mysqlimportæ–¹å¼å¯¼å…¥æ–‡æœ¬æ–‡ä»¶</h4><p><strong>ä¸¾ä¾‹ï¼š</strong></p><p>å¯¼å‡ºæ–‡ä»¶account.txtï¼Œå­—æ®µä¹‹é—´ä½¿ç”¨é€—å·â€ï¼Œâ€é—´éš”ï¼Œå­—æ®µå€¼ç”¨åŒå¼•å·æ‹¬èµ·æ¥ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM atguigu.account INTO OUTFILE &#x27;/var/lib/mysql-files/account.txt&#x27; FIELDS TERMINATED BY &#x27;,&#x27; ENCLOSED BY &#x27;\&quot;&#x27;;</span><br></pre></td></tr></table></figure><p>åˆ é™¤accountè¡¨ä¸­çš„æ•°æ®ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DELETE FROM atguigu.account;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨mysqlimportå‘½ä»¤å°†account.txtæ–‡ä»¶å†…å®¹å¯¼å…¥åˆ°æ•°æ®åº“atguiguçš„accountè¡¨ä¸­ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysqlimport -uroot -p atguigu &#x27;/var/lib/mysql-files/account.txt&#x27; --fields-terminated-by=&#x27;,&#x27; --fields-optionally-enclosed-by=&#x27;\&quot;&#x27;</span><br></pre></td></tr></table></figure><p>æŸ¥è¯¢accountè¡¨ä¸­çš„æ•°æ®ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">select * from account;</span><br><span class="line">mysql&gt; select * from account;</span><br><span class="line">+----+--------+---------+</span><br><span class="line">| id | name   | balance |</span><br><span class="line">+----+--------+---------+</span><br><span class="line">| 1 | å¼ ä¸‰     | 90      |</span><br><span class="line">| 2 | æå››     | 100     |</span><br><span class="line">| 3 | ç‹äº”     | 0       |</span><br><span class="line">+----+--------+---------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><h2 id="7-æ•°æ®åº“è¿ç§»"><a href="#7-æ•°æ®åº“è¿ç§»" class="headerlink" title="7. æ•°æ®åº“è¿ç§»"></a>7. æ•°æ®åº“è¿ç§»</h2><h3 id="7-1-æ¦‚è¿°"><a href="#7-1-æ¦‚è¿°" class="headerlink" title="7.1 æ¦‚è¿°"></a>7.1 æ¦‚è¿°</h3><p>æ•°æ®è¿ç§»ï¼ˆdata migrationï¼‰æ˜¯æŒ‡é€‰æ‹©ã€å‡†å¤‡ã€æå–å’Œè½¬æ¢æ•°æ®ï¼Œå¹¶<strong>å°†æ•°æ®ä»ä¸€ä¸ªè®¡ç®—æœºå­˜å‚¨ç³»ç»Ÿæ°¸ä¹…åœ°ä¼ è¾“åˆ°å¦ä¸€ä¸ªè®¡ç®—æœºå­˜å‚¨ç³»ç»Ÿçš„è¿‡ç¨‹</strong>ã€‚æ­¤å¤–ï¼Œ<code> éªŒè¯è¿ç§»æ•°æ®çš„å®Œæ•´æ€§</code> å’Œ <code>é€€å½¹åŸæ¥æ—§çš„æ•°æ®å­˜å‚¨</code> ï¼Œä¹Ÿè¢«è®¤ä¸ºæ˜¯æ•´ä¸ªæ•°æ®è¿ç§»è¿‡ç¨‹çš„ä¸€éƒ¨åˆ†ã€‚</p><p>æ•°æ®åº“è¿ç§»çš„åŸå› æ˜¯å¤šæ ·çš„ï¼ŒåŒ…æ‹¬æœåŠ¡å™¨æˆ–å­˜å‚¨è®¾å¤‡æ›´æ¢ã€ç»´æŠ¤æˆ–å‡çº§ï¼Œåº”ç”¨ç¨‹åºè¿ç§»ï¼Œç½‘ç«™é›†æˆï¼Œç¾éš¾æ¢å¤å’Œæ•°æ®ä¸­å¿ƒè¿ç§»ã€‚</p><p>æ ¹æ®ä¸åŒçš„éœ€æ±‚å¯èƒ½è¦é‡‡å–ä¸åŒçš„è¿ç§»æ–¹æ¡ˆï¼Œä½†æ€»ä½“æ¥è®²ï¼ŒMySQL æ•°æ®è¿ç§»æ–¹æ¡ˆå¤§è‡´å¯ä»¥åˆ†ä¸º<code>ç‰©ç†è¿ç§»</code>å’Œ <code>é€»è¾‘è¿ç§»</code> ä¸¤ç±»ã€‚é€šå¸¸ä»¥å°½å¯èƒ½ <code>è‡ªåŠ¨åŒ–</code> çš„æ–¹å¼æ‰§è¡Œï¼Œä»è€Œå°†äººåŠ›èµ„æºä»ç¹ççš„ä»»åŠ¡ä¸­è§£æ”¾å‡ºæ¥ã€‚</p><h3 id="7-2-è¿ç§»æ–¹æ¡ˆ"><a href="#7-2-è¿ç§»æ–¹æ¡ˆ" class="headerlink" title="7.2 è¿ç§»æ–¹æ¡ˆ"></a>7.2 è¿ç§»æ–¹æ¡ˆ</h3><ul><li>ç‰©ç†è¿ç§»</li></ul><p>ç‰©ç†è¿ç§»é€‚ç”¨äºå¤§æ•°æ®é‡ä¸‹çš„æ•´ä½“è¿ç§»ã€‚ä½¿ç”¨ç‰©ç†è¿ç§»æ–¹æ¡ˆçš„ä¼˜ç‚¹æ˜¯æ¯”è¾ƒå¿«é€Ÿï¼Œä½†éœ€è¦åœæœºè¿ç§»å¹¶ä¸”è¦ æ±‚ MySQL ç‰ˆæœ¬åŠé…ç½®å¿…é¡»å’ŒåŸæœåŠ¡å™¨ç›¸åŒï¼Œä¹Ÿå¯èƒ½å¼•èµ·æœªçŸ¥é—®é¢˜ã€‚</p><p>ç‰©ç†è¿ç§»åŒ…æ‹¬æ‹·è´æ•°æ®æ–‡ä»¶å’Œä½¿ç”¨ XtraBackup å¤‡ä»½å·¥å…·ä¸¤ç§ã€‚</p><p>ä¸åŒæœåŠ¡å™¨ä¹‹é—´å¯ä»¥é‡‡ç”¨ç‰©ç†è¿ç§»ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æ–°çš„æœåŠ¡å™¨ä¸Šå®‰è£…å¥½åŒç‰ˆæœ¬çš„æ•°æ®åº“è½¯ä»¶ï¼Œåˆ›å»ºå¥½ç›¸åŒç›®å½•ï¼Œå»ºè®®é…ç½®æ–‡ä»¶ä¹Ÿè¦å’ŒåŸæ•°æ®åº“ç›¸åŒï¼Œç„¶åä»åŸæ•°æ®åº“æ–¹æ‹·è´æ¥æ•°æ®æ–‡ä»¶åŠæ—¥å¿—æ–‡ä»¶ï¼Œé…ç½®å¥½æ–‡ä»¶ç»„æƒé™ï¼Œä¹‹ååœ¨æ–°æœåŠ¡å™¨è¿™è¾¹ä½¿ç”¨ mysqld å‘½ä»¤å¯åŠ¨æ•°æ®åº“ã€‚</p><ul><li>é€»è¾‘è¿ç§»</li></ul><p>é€»è¾‘è¿ç§»é€‚ç”¨èŒƒå›´æ›´å¹¿ï¼Œæ— è®ºæ˜¯ <code>éƒ¨åˆ†è¿ç§»</code> è¿˜æ˜¯ <code>å…¨é‡è¿ç§»</code> ï¼Œéƒ½å¯ä»¥ä½¿ç”¨é€»è¾‘è¿ç§»ã€‚é€»è¾‘è¿ç§»ä¸­ä½¿ç”¨æœ€å¤šçš„å°±æ˜¯é€šè¿‡ mysqldump ç­‰å¤‡ä»½å·¥å…·ã€‚</p><h3 id="7-3-è¿ç§»æ³¨æ„ç‚¹"><a href="#7-3-è¿ç§»æ³¨æ„ç‚¹" class="headerlink" title="7.3 è¿ç§»æ³¨æ„ç‚¹"></a>7.3 è¿ç§»æ³¨æ„ç‚¹</h3><p><strong>1. ç›¸åŒç‰ˆæœ¬çš„æ•°æ®åº“ä¹‹é—´è¿ç§»æ³¨æ„ç‚¹</strong></p><p>æŒ‡çš„æ˜¯åœ¨ä¸»ç‰ˆæœ¬å·ç›¸åŒçš„MySQLæ•°æ®åº“ä¹‹é—´è¿›è¡Œæ•°æ®åº“ç§»åŠ¨ã€‚</p><p><code>æ–¹å¼1</code>ï¼š å› ä¸ºè¿ç§»å‰åMySQLæ•°æ®åº“çš„ <code>ä¸»ç‰ˆæœ¬å·ç›¸åŒ</code> ï¼Œæ‰€ä»¥å¯ä»¥é€šè¿‡å¤åˆ¶æ•°æ®åº“ç›®å½•æ¥å®ç°æ•°æ®åº“è¿ç§»ï¼Œä½†æ˜¯ç‰©ç†è¿ç§»æ–¹å¼åªé€‚ç”¨äºMyISAMå¼•æ“çš„è¡¨ã€‚å¯¹äºInnoDBè¡¨ï¼Œä¸èƒ½ç”¨ç›´æ¥å¤åˆ¶æ–‡ä»¶çš„æ–¹å¼å¤‡ä»½æ•°æ®åº“ã€‚</p><p><code>æ–¹å¼2</code>ï¼š æœ€å¸¸è§å’Œæœ€å®‰å…¨çš„æ–¹å¼æ˜¯ä½¿ç”¨ <code>mysqldumpå‘½ä»¤</code> å¯¼å‡ºæ•°æ®ï¼Œç„¶ååœ¨ç›®æ ‡æ•°æ®åº“æœåŠ¡å™¨ä¸­ä½¿ç”¨ MySQLå‘½ä»¤å¯¼å…¥ã€‚</p><p>ä¸¾ä¾‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#host1çš„æœºå™¨ä¸­å¤‡ä»½æ‰€æœ‰æ•°æ®åº“,å¹¶å°†æ•°æ®åº“è¿ç§»åˆ°åä¸ºhost2çš„æœºå™¨ä¸Š</span><br><span class="line">mysqldump â€“h host1 â€“uroot â€“p â€“-all-databases|</span><br><span class="line">mysql â€“h host2 â€“uroot â€“p</span><br></pre></td></tr></table></figure><p>åœ¨ä¸Šè¿°è¯­å¥ä¸­ï¼Œâ€œ|â€ç¬¦å·è¡¨ç¤ºç®¡é“ï¼Œå…¶ä½œç”¨æ˜¯å°†mysqldumpå¤‡ä»½çš„æ–‡ä»¶ç»™mysqlå‘½ä»¤ï¼›â€œâ€“all-databasesâ€è¡¨ç¤ºè¦è¿ç§»æ‰€æœ‰çš„æ•°æ®åº“ã€‚é€šè¿‡è¿™ç§æ–¹å¼å¯ä»¥ç›´æ¥å®ç°è¿ç§»ã€‚</p><p><strong>2. ä¸åŒç‰ˆæœ¬çš„æ•°æ®åº“ä¹‹é—´è¿ç§»æ³¨æ„ç‚¹</strong></p><p>ä¾‹å¦‚ï¼ŒåŸæ¥å¾ˆå¤šæœåŠ¡å™¨ä½¿ç”¨5.7ç‰ˆæœ¬çš„MySQLæ•°æ®åº“ï¼Œåœ¨8.0ç‰ˆæœ¬æ¨å‡ºæ¥ä»¥åï¼Œæ”¹è¿›äº†5.7ç‰ˆæœ¬çš„å¾ˆå¤šç¼ºé™·ï¼Œ å› æ­¤éœ€è¦æŠŠæ•°æ®åº“å‡çº§åˆ°8.0ç‰ˆæœ¬</p><p>æ—§ç‰ˆæœ¬ä¸æ–°ç‰ˆæœ¬çš„MySQLå¯èƒ½ä½¿ç”¨ä¸åŒçš„é»˜è®¤å­—ç¬¦é›†ï¼Œä¾‹å¦‚æœ‰çš„æ—§ç‰ˆæœ¬ä¸­ä½¿ç”¨latin1ä½œä¸ºé»˜è®¤å­—ç¬¦é›†ï¼Œè€Œæœ€æ–°ç‰ˆæœ¬çš„MySQLé»˜è®¤å­—ç¬¦é›†ä¸ºutf8mb4ã€‚å¦‚æœæ•°æ®åº“ä¸­æœ‰ä¸­æ–‡æ•°æ®ï¼Œé‚£ä¹ˆè¿ç§»è¿‡ç¨‹ä¸­éœ€è¦å¯¹ <code>é»˜è®¤å­—ç¬¦é›†</code> è¿›è¡Œä¿®æ”¹ ï¼Œä¸ç„¶å¯èƒ½æ— æ³•æ­£å¸¸æ˜¾ç¤ºæ•°æ®ã€‚</p><p>é«˜ç‰ˆæœ¬çš„MySQLæ•°æ®åº“é€šå¸¸éƒ½ä¼š <code>å…¼å®¹ä½ç‰ˆæœ¬</code> ï¼Œå› æ­¤å¯ä»¥ä»ä½ç‰ˆæœ¬çš„MySQLæ•°æ®åº“è¿ç§»åˆ°é«˜ç‰ˆæœ¬çš„MySQL æ•°æ®åº“ã€‚</p><p><strong>3. ä¸åŒæ•°æ®åº“ä¹‹é—´è¿ç§»æ³¨æ„ç‚¹</strong></p><p>ä¸åŒæ•°æ®åº“ä¹‹é—´è¿ç§»æ˜¯æŒ‡ä»å…¶ä»–ç±»å‹çš„æ•°æ®åº“è¿ç§»åˆ°MySQLæ•°æ®åº“ï¼Œæˆ–è€…ä»MySQLæ•°æ®åº“è¿ç§»åˆ°å…¶ä»–ç±» å‹çš„æ•°æ®åº“ã€‚è¿™ç§è¿ç§»æ²¡æœ‰æ™®é€‚çš„è§£å†³æ–¹æ³•ã€‚</p><p>è¿ç§»ä¹‹å‰ï¼Œéœ€è¦äº†è§£ä¸åŒæ•°æ®åº“çš„æ¶æ„ï¼Œ <code>æ¯”è¾ƒå®ƒä»¬ä¹‹é—´çš„å·®å¼‚</code> ã€‚ä¸åŒæ•°æ®åº“ä¸­å®šä¹‰ç›¸åŒç±»å‹çš„æ•°æ®çš„ <code>å…³é”®å­—å¯èƒ½ä¼šä¸åŒ</code> ã€‚ä¾‹å¦‚ï¼ŒMySQLä¸­æ—¥æœŸå­—æ®µåˆ†ä¸ºDATEå’ŒTIMEä¸¤ç§ï¼Œè€ŒORACLEæ—¥æœŸå­—æ®µåªæœ‰DATEï¼›SQL Serveræ•°æ®åº“ä¸­æœ‰ntextã€Imageç­‰æ•°æ®ç±»å‹ï¼ŒMySQLæ•°æ®åº“æ²¡æœ‰è¿™äº›æ•°æ®ç±»å‹ï¼›MySQLæ”¯æŒçš„ENUMå’ŒSET ç±»å‹ï¼Œè¿™äº›SQL Serveræ•°æ®åº“ä¸æ”¯æŒã€‚</p><p>å¦å¤–ï¼Œæ•°æ®åº“å‚å•†å¹¶æ²¡æœ‰å®Œå…¨æŒ‰ç…§SQLæ ‡å‡†æ¥è®¾è®¡æ•°æ®åº“ç³»ç»Ÿï¼Œå¯¼è‡´ä¸åŒçš„æ•°æ®åº“ç³»ç»Ÿçš„ <code>SQLè¯­å¥</code> æœ‰å·®åˆ«ã€‚ä¾‹å¦‚ï¼Œå¾®è½¯çš„SQL Serverè½¯ä»¶ä½¿ç”¨çš„æ˜¯T-SQLè¯­å¥ï¼ŒT-SQLä¸­åŒ…å«äº†éæ ‡å‡†çš„SQLè¯­å¥ï¼Œä¸èƒ½å’ŒMySQLçš„SQLè¯­å¥å…¼å®¹ã€‚</p><p>ä¸åŒç±»å‹æ•°æ®åº“ä¹‹é—´çš„å·®å¼‚é€ æˆäº†äº’ç›¸ <code>è¿ç§»çš„å›°éš¾</code> ï¼Œè¿™äº›å·®å¼‚å…¶å®æ˜¯å•†ä¸šå…¬å¸æ•…æ„é€ æˆçš„æŠ€æœ¯å£å’ã€‚ä½† æ˜¯ä¸åŒç±»å‹çš„æ•°æ®åº“ä¹‹é—´çš„è¿ç§»å¹¶ <code>ä¸æ˜¯å®Œå…¨ä¸å¯èƒ½</code> ã€‚ä¾‹å¦‚ï¼Œå¯ä»¥ä½¿ç”¨<code> MyODBC</code> å®ç°MySQLå’ŒSQL Serverä¹‹ é—´çš„è¿ç§»ã€‚MySQLå®˜æ–¹æä¾›çš„å·¥å…· <code>MySQL Migration Toolkit</code> ä¹Ÿå¯ä»¥åœ¨ä¸åŒæ•°æ®ä¹‹é—´è¿›è¡Œæ•°æ®è¿ç§»ã€‚ MySQLè¿ç§»åˆ°Oracleæ—¶ï¼Œéœ€è¦ä½¿ç”¨mysqldumpå‘½ä»¤å¯¼å‡ºsqlæ–‡ä»¶ï¼Œç„¶åï¼Œ <code>æ‰‹åŠ¨æ›´æ”¹</code> sqlæ–‡ä»¶ä¸­çš„CREATEè¯­å¥ã€‚</p><h3 id="7-4-è¿ç§»å°ç»“"><a href="#7-4-è¿ç§»å°ç»“" class="headerlink" title="7.4 è¿ç§»å°ç»“"></a>7.4 è¿ç§»å°ç»“</h3><img src="/2023/03/04/04-%E6%97%A5%E5%BF%97%E4%B8%8E%E5%A4%87%E4%BB%BD%E7%AF%87/image-20220718165515965.png" class=""><h2 id="8-åˆ åº“äº†ä¸æ•¢è·‘ï¼Œèƒ½å¹²ç‚¹å•¥ï¼Ÿ"><a href="#8-åˆ åº“äº†ä¸æ•¢è·‘ï¼Œèƒ½å¹²ç‚¹å•¥ï¼Ÿ" class="headerlink" title="8. åˆ åº“äº†ä¸æ•¢è·‘ï¼Œèƒ½å¹²ç‚¹å•¥ï¼Ÿ"></a>8. åˆ åº“äº†ä¸æ•¢è·‘ï¼Œèƒ½å¹²ç‚¹å•¥ï¼Ÿ</h2><img src="/2023/03/04/04-%E6%97%A5%E5%BF%97%E4%B8%8E%E5%A4%87%E4%BB%BD%E7%AF%87/image-20220718165738367.png" class=""><h3 id="8-1-deleteï¼šè¯¯åˆ è¡Œ"><a href="#8-1-deleteï¼šè¯¯åˆ è¡Œ" class="headerlink" title="8.1 deleteï¼šè¯¯åˆ è¡Œ"></a>8.1 deleteï¼šè¯¯åˆ è¡Œ</h3><img src="/2023/03/04/04-%E6%97%A5%E5%BF%97%E4%B8%8E%E5%A4%87%E4%BB%BD%E7%AF%87/image-20220718165909464.png" class=""><h3 id="8-2-truncate-x2F-drop-ï¼šè¯¯åˆ åº“-x2F-è¡¨"><a href="#8-2-truncate-x2F-drop-ï¼šè¯¯åˆ åº“-x2F-è¡¨" class="headerlink" title="8.2 truncate&#x2F;drop ï¼šè¯¯åˆ åº“&#x2F;è¡¨"></a>8.2 truncate&#x2F;drop ï¼šè¯¯åˆ åº“&#x2F;è¡¨</h3><img src="/2023/03/04/04-%E6%97%A5%E5%BF%97%E4%B8%8E%E5%A4%87%E4%BB%BD%E7%AF%87/image-20220718170026929.png" class=""><h3 id="8-3-é¢„é˜²ä½¿ç”¨truncate-x2F-dropè¯¯åˆ åº“-x2F-è¡¨"><a href="#8-3-é¢„é˜²ä½¿ç”¨truncate-x2F-dropè¯¯åˆ åº“-x2F-è¡¨" class="headerlink" title="8.3 é¢„é˜²ä½¿ç”¨truncate&#x2F;dropè¯¯åˆ åº“&#x2F;è¡¨"></a>8.3 é¢„é˜²ä½¿ç”¨truncate&#x2F;dropè¯¯åˆ åº“&#x2F;è¡¨</h3><img src="/2023/03/04/04-%E6%97%A5%E5%BF%97%E4%B8%8E%E5%A4%87%E4%BB%BD%E7%AF%87/image-20220718170132339.png" class=""><img src="/2023/03/04/04-%E6%97%A5%E5%BF%97%E4%B8%8E%E5%A4%87%E4%BB%BD%E7%AF%87/image-20220718170215247.png" class=""><h3 id="8-4-rmï¼šè¯¯åˆ MySQLå®ä¾‹"><a href="#8-4-rmï¼šè¯¯åˆ MySQLå®ä¾‹" class="headerlink" title="8.4 rmï¼šè¯¯åˆ MySQLå®ä¾‹"></a>8.4 rmï¼šè¯¯åˆ MySQLå®ä¾‹</h3><p>å¯¹äºä¸€ä¸ªæœ‰é«˜å¯ç”¨æœºåˆ¶çš„MySQLé›†ç¾¤æ¥è¯´ï¼Œä¸ç”¨æ‹…å¿ƒ rmåˆ é™¤æ•°æ® äº†ã€‚åªæ˜¯åˆ æ‰äº†å…¶ä¸­æŸä¸€ä¸ªèŠ‚ç‚¹çš„æ•°æ®çš„è¯ï¼ŒHAç³»ç»Ÿå°±ä¼šå¼€å§‹å·¥ä½œï¼Œé€‰å‡ºä¸€ä¸ªæ–°çš„ä¸»åº“ï¼Œä»è€Œä¿è¯æ•´ä¸ªé›†ç¾¤çš„æ­£å¸¸å·¥ä½œã€‚æˆ‘ä»¬è¦åšçš„å°±æ˜¯åœ¨è¿™ä¸ªèŠ‚ç‚¹ä¸ŠæŠŠæ•°æ®æ¢å¤å›æ¥ï¼Œå†æ¥å…¥æ•´ä¸ªé›†ç¾¤ã€‚</p><p>ä½†å¦‚æœæ˜¯æ¶æ„åœ°æŠŠæ•´ä¸ªé›†ç¾¤åˆ é™¤ï¼Œé‚£å°±éœ€è¦è€ƒè™‘è·¨æœºæˆ¿å¤‡ä»½ï¼Œè·¨åŸå¸‚å¤‡ä»½ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Mysql </category>
          
          <category> Mysqlé«˜çº§ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Mysqlé«˜çº§ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>03_äº‹åŠ¡ç¯‡</title>
      <link href="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/"/>
      <url>/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/</url>
      
        <content type="html"><![CDATA[<h1 id="ç¬¬13ç« -äº‹åŠ¡åŸºç¡€çŸ¥è¯†"><a href="#ç¬¬13ç« -äº‹åŠ¡åŸºç¡€çŸ¥è¯†" class="headerlink" title="ç¬¬13ç« _äº‹åŠ¡åŸºç¡€çŸ¥è¯†"></a>ç¬¬13ç« _äº‹åŠ¡åŸºç¡€çŸ¥è¯†</h1><h2 id="1-æ•°æ®åº“äº‹åŠ¡æ¦‚è¿°"><a href="#1-æ•°æ®åº“äº‹åŠ¡æ¦‚è¿°" class="headerlink" title="1. æ•°æ®åº“äº‹åŠ¡æ¦‚è¿°"></a>1. æ•°æ®åº“äº‹åŠ¡æ¦‚è¿°</h2><h3 id="1-1-å­˜å‚¨å¼•æ“æ”¯æŒæƒ…å†µ"><a href="#1-1-å­˜å‚¨å¼•æ“æ”¯æŒæƒ…å†µ" class="headerlink" title="1.1 å­˜å‚¨å¼•æ“æ”¯æŒæƒ…å†µ"></a>1.1 å­˜å‚¨å¼•æ“æ”¯æŒæƒ…å†µ</h3><p><code>SHOW ENGINES</code> å‘½ä»¤æ¥æŸ¥çœ‹å½“å‰ MySQL æ”¯æŒçš„å­˜å‚¨å¼•æ“éƒ½æœ‰å“ªäº›ï¼Œä»¥åŠè¿™äº›å­˜å‚¨å¼•æ“æ˜¯å¦æ”¯æŒäº‹åŠ¡ã€‚</p><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220708124306444.png" class=""><p>èƒ½çœ‹å‡ºåœ¨ MySQL ä¸­ï¼Œåªæœ‰InnoDB æ˜¯æ”¯æŒäº‹åŠ¡çš„ã€‚</p><h3 id="1-2-åŸºæœ¬æ¦‚å¿µ"><a href="#1-2-åŸºæœ¬æ¦‚å¿µ" class="headerlink" title="1.2 åŸºæœ¬æ¦‚å¿µ"></a>1.2 åŸºæœ¬æ¦‚å¿µ</h3><p><strong>äº‹åŠ¡ï¼š</strong>ä¸€ç»„é€»è¾‘æ“ä½œå•å…ƒï¼Œä½¿æ•°æ®ä»ä¸€ç§çŠ¶æ€å˜æ¢åˆ°å¦ä¸€ç§çŠ¶æ€ã€‚</p><p><strong>äº‹åŠ¡å¤„ç†çš„åŸåˆ™ï¼š</strong>ä¿è¯æ‰€æœ‰äº‹åŠ¡éƒ½ä½œä¸º <code>ä¸€ä¸ªå·¥ä½œå•å…ƒ</code> æ¥æ‰§è¡Œï¼Œå³ä½¿å‡ºç°äº†æ•…éšœï¼Œéƒ½ä¸èƒ½æ”¹å˜è¿™ç§æ‰§è¡Œæ–¹ å¼ã€‚å½“åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­æ‰§è¡Œå¤šä¸ªæ“ä½œæ—¶ï¼Œè¦ä¹ˆæ‰€æœ‰çš„äº‹åŠ¡éƒ½è¢«æäº¤( <code>commit</code> )ï¼Œé‚£ä¹ˆè¿™äº›ä¿®æ”¹å°± <code>æ°¸ä¹…</code> åœ°ä¿ <code>å­˜ä¸‹æ¥</code>ï¼›è¦ä¹ˆæ•°æ®åº“ç®¡ç†ç³»ç»Ÿå°† <code>æ”¾å¼ƒ</code> æ‰€ä½œçš„æ‰€æœ‰ <code>ä¿®æ”¹</code> ï¼Œæ•´ä¸ªäº‹åŠ¡å›æ»š( rollback )åˆ°æœ€åˆçŠ¶æ€ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># æ¡ˆä¾‹ï¼šAAç”¨æˆ·ç»™BBç”¨æˆ·è½¬è´¦100</span><br><span class="line">update account set money = money - 100 where name = &#x27;AA&#x27;;</span><br><span class="line"># æœåŠ¡å™¨å®•æœº</span><br><span class="line">update account set money = money + 100 where name = &#x27;BB&#x27;;</span><br></pre></td></tr></table></figure><h3 id="1-3-äº‹ç‰©çš„ACIDç‰¹æ€§"><a href="#1-3-äº‹ç‰©çš„ACIDç‰¹æ€§" class="headerlink" title="1.3 äº‹ç‰©çš„ACIDç‰¹æ€§"></a>1.3 äº‹ç‰©çš„ACIDç‰¹æ€§</h3><ul><li><strong>åŸå­æ€§ï¼ˆatomicityï¼‰ï¼š</strong></li></ul><p>åŸå­æ€§æ˜¯æŒ‡äº‹åŠ¡æ˜¯ä¸€ä¸ªä¸å¯åˆ†å‰²çš„å·¥ä½œå•ä½ï¼Œè¦ä¹ˆå…¨éƒ¨æäº¤ï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥å›æ»šã€‚å³è¦ä¹ˆè½¬è´¦æˆåŠŸï¼Œè¦ä¹ˆè½¬è´¦å¤±è´¥ï¼Œæ˜¯ä¸å­˜åœ¨ä¸­é—´çš„çŠ¶æ€ã€‚å¦‚æœæ— æ³•ä¿è¯åŸå­æ€§ä¼šæ€ä¹ˆæ ·ï¼Ÿå°±ä¼šå‡ºç°æ•°æ®ä¸ä¸€è‡´çš„æƒ…å½¢ï¼ŒAè´¦æˆ·å‡å»100å…ƒï¼Œè€ŒBè´¦æˆ·å¢åŠ 100å…ƒæ“ä½œå¤±è´¥ï¼Œç³»ç»Ÿå°†æ— æ•…ä¸¢å¤±100å…ƒã€‚</p><ul><li><strong>ä¸€è‡´æ€§ï¼ˆconsistencyï¼‰ï¼š</strong></li></ul><p>ï¼ˆå›½å†…å¾ˆå¤šç½‘ç«™ä¸Šå¯¹ä¸€è‡´æ€§çš„é˜è¿°æœ‰è¯¯ï¼Œå…·ä½“ä½ å¯ä»¥å‚è€ƒ Wikipedia å¯¹Consistencyçš„é˜è¿°ï¼‰</p><p>æ ¹æ®å®šä¹‰ï¼Œä¸€è‡´æ€§æ˜¯æŒ‡äº‹åŠ¡æ‰§è¡Œå‰åï¼Œæ•°æ®ä»ä¸€ä¸ª <code>åˆæ³•æ€§çŠ¶æ€</code> å˜æ¢åˆ°å¦å¤–ä¸€ä¸ª <code>åˆæ³•æ€§çŠ¶æ€</code> ã€‚è¿™ç§çŠ¶æ€æ˜¯ <code>è¯­ä¹‰ä¸Š</code> çš„è€Œä¸æ˜¯è¯­æ³•ä¸Šçš„ï¼Œè·Ÿå…·ä½“çš„ä¸šåŠ¡æœ‰å…³ã€‚</p><p>é‚£ä»€ä¹ˆæ˜¯åˆæ³•çš„æ•°æ®çŠ¶æ€å‘¢ï¼Ÿæ»¡è¶³ <code>é¢„å®šçš„çº¦æŸ</code> çš„çŠ¶æ€å°±å«åšåˆæ³•çš„çŠ¶æ€ã€‚é€šä¿—ä¸€ç‚¹ï¼Œè¿™çŠ¶æ€æ˜¯ç”±ä½ è‡ªå·±æ¥å®šä¹‰çš„ï¼ˆæ¯”å¦‚æ»¡è¶³ç°å®ä¸–ç•Œä¸­çš„çº¦æŸï¼‰ã€‚æ»¡è¶³è¿™ä¸ªçŠ¶æ€ï¼Œæ•°æ®å°±æ˜¯ä¸€è‡´çš„ï¼Œä¸æ»¡è¶³è¿™ä¸ªçŠ¶æ€ï¼Œæ•°æ®å°± æ˜¯ä¸ä¸€è‡´çš„ï¼å¦‚æœäº‹åŠ¡ä¸­çš„æŸä¸ªæ“ä½œå¤±è´¥äº†ï¼Œç³»ç»Ÿå°±ä¼šè‡ªåŠ¨æ’¤é”€å½“å‰æ­£åœ¨æ‰§è¡Œçš„äº‹åŠ¡ï¼Œè¿”å›åˆ°äº‹åŠ¡æ“ä½œ ä¹‹å‰çš„çŠ¶æ€ã€‚</p><p><strong>ä¸¾ä¾‹1ï¼š</strong>Aè´¦æˆ·æœ‰200å…ƒï¼Œè½¬è´¦300å…ƒå‡ºå»ï¼Œæ­¤æ—¶Aè´¦æˆ·ä½™é¢ä¸º-100å…ƒã€‚ä½ è‡ªç„¶å°±å‘ç°æ­¤æ—¶æ•°æ®æ˜¯ä¸ä¸€è‡´çš„ï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿå› ä¸ºä½ å®šä¹‰äº†ä¸€ä¸ªçŠ¶æ€ï¼Œä½™é¢è¿™åˆ—å¿…é¡»&gt;&#x3D;0ã€‚</p><p><strong>ä¸¾ä¾‹2ï¼š</strong>Aè´¦æˆ·æœ‰200å…ƒï¼Œè½¬è´¦50å…ƒç»™Bè´¦æˆ·ï¼ŒAè´¦æˆ·çš„é’±æ‰£äº†ï¼Œä½†æ˜¯Bè´¦æˆ·å› ä¸ºå„ç§æ„å¤–ï¼Œä½™é¢å¹¶æ²¡æœ‰å¢åŠ ã€‚ä½ ä¹ŸçŸ¥é“æ­¤æ—¶çš„æ•°æ®æ˜¯ä¸ä¸€è‡´çš„ï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿå› ä¸ºä½ å®šä¹‰äº†ä¸€ä¸ªçŠ¶æ€ï¼Œè¦æ±‚A+Bçš„æ€»ä½™é¢å¿…é¡»ä¸å˜ã€‚</p><p><strong>ä¸¾ä¾‹3ï¼š</strong>åœ¨æ•°æ®è¡¨ä¸­æˆ‘ä»¬å°†<code>å§“å</code>å­—æ®µè®¾ç½®ä¸º<code>å”¯ä¸€æ€§çº¦æŸ</code>ï¼Œè¿™æ—¶å½“äº‹åŠ¡è¿›è¡Œæäº¤æˆ–è€…äº‹åŠ¡å‘ç”Ÿå›æ»šçš„æ—¶å€™ï¼Œå¦‚æœæ•°æ®è¡¨çš„å§“åä¸å”¯ä¸€ï¼Œå°±ç ´åäº†äº‹ç‰©çš„ä¸€è‡´æ€§è¦æ±‚ã€‚</p><ul><li><strong>éš”ç¦»å‹ï¼ˆisolationï¼‰ï¼š</strong></li></ul><p>äº‹åŠ¡çš„éš”ç¦»æ€§æ˜¯æŒ‡ä¸€ä¸ªäº‹åŠ¡çš„æ‰§è¡Œ<code>ä¸èƒ½è¢«å…¶ä»–äº‹åŠ¡å¹²æ‰°</code>ï¼Œå³ä¸€ä¸ªäº‹åŠ¡å†…éƒ¨çš„æ“ä½œåŠä½¿ç”¨çš„æ•°æ®å¯¹<code>å¹¶å‘</code>çš„å…¶ä»–äº‹åŠ¡æ˜¯éš”ç¦»çš„ï¼Œå¹¶å‘æ‰§è¡Œçš„å„ä¸ªäº‹åŠ¡ä¹‹é—´ä¸èƒ½ç›¸äº’å¹²æ‰°ã€‚</p><p>å¦‚æœæ— æ³•ä¿è¯éš”ç¦»æ€§ä¼šæ€ä¹ˆæ ·ï¼Ÿå‡è®¾Aè´¦æˆ·æœ‰200å…ƒï¼ŒBè´¦æˆ·0å…ƒã€‚Aè´¦æˆ·å¾€Bè´¦æˆ·è½¬è´¦ä¸¤æ¬¡ï¼Œæ¯æ¬¡é‡‘é¢ä¸º50 å…ƒï¼Œåˆ†åˆ«åœ¨ä¸¤ä¸ªäº‹åŠ¡ä¸­æ‰§è¡Œã€‚å¦‚æœæ— æ³•ä¿è¯éš”ç¦»æ€§ï¼Œä¼šå‡ºç°ä¸‹é¢çš„æƒ…å½¢ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">UPDATE accounts SET money = money - 50 WHERE NAME = &#x27;AA&#x27;;</span><br><span class="line">UPDATE accounts SET money = money + 50 WHERE NAME = &#x27;BB&#x27;;</span><br></pre></td></tr></table></figure><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220708164610193.png" class=""> <p><strong>æŒä¹…æ€§ï¼ˆdurabilityï¼‰ï¼š</strong></p><p>æŒä¹…æ€§æ˜¯æŒ‡ä¸€ä¸ªäº‹åŠ¡ä¸€æ—¦è¢«æäº¤ï¼Œå®ƒå¯¹æ•°æ®åº“ä¸­æ•°æ®çš„æ”¹å˜å°±æ˜¯ æ°¸ä¹…æ€§çš„ ï¼Œæ¥ä¸‹æ¥çš„å…¶ä»–æ“ä½œå’Œæ•°æ®åº“ æ•…éšœä¸åº”è¯¥å¯¹å…¶æœ‰ä»»ä½•å½±å“ã€‚</p><p>æŒä¹…æ€§æ˜¯é€šè¿‡ <code>äº‹åŠ¡æ—¥å¿—</code> æ¥ä¿è¯çš„ã€‚æ—¥å¿—åŒ…æ‹¬äº† <code>é‡åšæ—¥å¿—</code> å’Œ <code>å›æ»šæ—¥å¿—</code> ã€‚å½“æˆ‘ä»¬é€šè¿‡äº‹åŠ¡å¯¹æ•°æ®è¿›è¡Œä¿®æ”¹ çš„æ—¶å€™ï¼Œé¦–å…ˆä¼šå°†æ•°æ®åº“çš„å˜åŒ–ä¿¡æ¯è®°å½•åˆ°é‡åšæ—¥å¿—ä¸­ï¼Œç„¶åå†å¯¹æ•°æ®åº“ä¸­å¯¹åº”çš„è¡Œè¿›è¡Œä¿®æ”¹ã€‚è¿™æ ·åš çš„å¥½å¤„æ˜¯ï¼Œå³ä½¿æ•°æ®åº“ç³»ç»Ÿå´©æºƒï¼Œæ•°æ®åº“é‡å¯åä¹Ÿèƒ½æ‰¾åˆ°æ²¡æœ‰æ›´æ–°åˆ°æ•°æ®åº“ç³»ç»Ÿä¸­çš„é‡åšæ—¥å¿—ï¼Œé‡æ–°æ‰§ è¡Œï¼Œä»è€Œä½¿äº‹åŠ¡å…·æœ‰æŒä¹…æ€§ã€‚</p><blockquote><p>æ€»ç»“</p><p>ACIDæ˜¯äº‹åŠ¡çš„å››å¤§ç‰¹å¾ï¼Œåœ¨è¿™å››ä¸ªç‰¹æ€§ä¸­ï¼ŒåŸå­æ€§æ˜¯åŸºç¡€ï¼Œéš”ç¦»æ€§æ˜¯æ‰‹æ®µï¼Œä¸€è‡´æ€§æ˜¯çº¦æŸæ¡ä»¶ï¼Œ è€ŒæŒä¹…æ€§æ˜¯æˆ‘ä»¬çš„ç›®çš„ã€‚</p><p>æ•°æ®åº“äº‹åŠ¡ï¼Œå…¶å®å°±æ˜¯æ•°æ®åº“è®¾è®¡è€…ä¸ºäº†æ–¹ä¾¿èµ·è§ï¼ŒæŠŠéœ€è¦ä¿è¯<code>åŸå­æ€§</code>ã€<code>éš”ç¦»æ€§</code>ã€<code>ä¸€è‡´æ€§</code>å’Œ<code>æŒä¹…æ€§</code>çš„ä¸€ä¸ªæˆ–å¤šä¸ªæ•°æ®åº“æ“ä½œç§°ä¸ºä¸€ä¸ªäº‹åŠ¡ã€‚</p></blockquote><h3 id="1-4-äº‹åŠ¡çš„çŠ¶æ€"><a href="#1-4-äº‹åŠ¡çš„çŠ¶æ€" class="headerlink" title="1.4 äº‹åŠ¡çš„çŠ¶æ€"></a>1.4 äº‹åŠ¡çš„çŠ¶æ€</h3><p>æˆ‘ä»¬ç°åœ¨çŸ¥é“ <code>äº‹åŠ¡</code> æ˜¯ä¸€ä¸ªæŠ½è±¡çš„æ¦‚å¿µï¼Œå®ƒå…¶å®å¯¹åº”ç€ä¸€ä¸ªæˆ–å¤šä¸ªæ•°æ®åº“æ“ä½œï¼ŒMySQLæ ¹æ®è¿™äº›æ“ä½œæ‰€æ‰§ è¡Œçš„ä¸åŒé˜¶æ®µæŠŠ <code>äº‹åŠ¡</code> å¤§è‡´åˆ’åˆ†æˆå‡ ä¸ªçŠ¶æ€ï¼š</p><ul><li><p><strong>æ´»åŠ¨çš„ï¼ˆactiveï¼‰</strong></p><p>äº‹åŠ¡å¯¹åº”çš„æ•°æ®åº“æ“ä½œæ­£åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­æ—¶ï¼Œæˆ‘ä»¬å°±è¯´è¯¥äº‹åŠ¡å¤„åœ¨ <code>æ´»åŠ¨çš„</code> çŠ¶æ€ã€‚</p></li><li><p><strong>éƒ¨åˆ†æäº¤çš„ï¼ˆpartially committedï¼‰</strong></p><p>å½“äº‹åŠ¡ä¸­çš„æœ€åä¸€ä¸ªæ“ä½œæ‰§è¡Œå®Œæˆï¼Œä½†ç”±äºæ“ä½œéƒ½åœ¨å†…å­˜ä¸­æ‰§è¡Œï¼Œæ‰€é€ æˆçš„å½±å“å¹¶ <code>æ²¡æœ‰åˆ·æ–°åˆ°ç£ç›˜</code> æ—¶ï¼Œæˆ‘ä»¬å°±è¯´è¯¥äº‹åŠ¡å¤„åœ¨ <code>éƒ¨åˆ†æäº¤çš„</code> çŠ¶æ€ã€‚</p></li><li><p><strong>å¤±è´¥çš„ï¼ˆfailedï¼‰</strong></p><p>å½“äº‹åŠ¡å¤„åœ¨ <code>æ´»åŠ¨çš„</code> æˆ–è€… éƒ¨åˆ†æäº¤çš„ çŠ¶æ€æ—¶ï¼Œå¯èƒ½é‡åˆ°äº†æŸäº›é”™è¯¯ï¼ˆæ•°æ®åº“è‡ªèº«çš„é”™è¯¯ã€æ“ä½œç³»ç»Ÿ é”™è¯¯æˆ–è€…ç›´æ¥æ–­ç”µç­‰ï¼‰è€Œæ— æ³•ç»§ç»­æ‰§è¡Œï¼Œæˆ–è€…äººä¸ºçš„åœæ­¢å½“å‰äº‹åŠ¡çš„æ‰§è¡Œï¼Œæˆ‘ä»¬å°±è¯´è¯¥äº‹åŠ¡å¤„åœ¨ å¤± è´¥çš„ çŠ¶æ€ã€‚</p></li><li><p><strong>ä¸­æ­¢çš„ï¼ˆabortedï¼‰</strong></p><p>å¦‚æœäº‹åŠ¡æ‰§è¡Œäº†ä¸€éƒ¨åˆ†è€Œå˜ä¸º <code>å¤±è´¥çš„</code> çŠ¶æ€ï¼Œé‚£ä¹ˆå°±éœ€è¦æŠŠå·²ç»ä¿®æ”¹çš„äº‹åŠ¡ä¸­çš„æ“ä½œè¿˜åŸåˆ°äº‹åŠ¡æ‰§ è¡Œå‰çš„çŠ¶æ€ã€‚æ¢å¥è¯è¯´ï¼Œå°±æ˜¯è¦æ’¤é”€å¤±è´¥äº‹åŠ¡å¯¹å½“å‰æ•°æ®åº“é€ æˆçš„å½±å“ã€‚æˆ‘ä»¬æŠŠè¿™ä¸ªæ’¤é”€çš„è¿‡ç¨‹ç§°ä¹‹ä¸º <code>å›æ»š</code> ã€‚å½“ <code>å›æ»š</code> æ“ä½œæ‰§è¡Œå®Œæ¯•æ—¶ï¼Œä¹Ÿå°±æ˜¯æ•°æ®åº“æ¢å¤åˆ°äº†æ‰§è¡Œäº‹åŠ¡ä¹‹å‰çš„çŠ¶æ€ï¼Œæˆ‘ä»¬å°±è¯´è¯¥äº‹ åŠ¡å¤„åœ¨äº† <code>ä¸­æ­¢çš„</code> çŠ¶æ€ã€‚</p><p>ä¸¾ä¾‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">UPDATE accounts SET money = money - 50 WHERE NAME = &#x27;AA&#x27;;</span><br><span class="line"></span><br><span class="line">UPDATE accounts SET money = money + 50 WHERE NAME = &#x27;BB&#x27;;</span><br></pre></td></tr></table></figure></li><li><p><strong>æäº¤çš„ï¼ˆcommittedï¼‰</strong></p><p>å½“ä¸€ä¸ªå¤„åœ¨ <code>éƒ¨åˆ†æäº¤çš„</code> çŠ¶æ€çš„äº‹åŠ¡å°†ä¿®æ”¹è¿‡çš„æ•°æ®éƒ½ <code>åŒæ­¥åˆ°ç£ç›˜</code> ä¸Šä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥è¯´è¯¥äº‹åŠ¡å¤„åœ¨äº† <code>æäº¤çš„</code> çŠ¶æ€ã€‚</p><p>ä¸€ä¸ªåŸºæœ¬çš„çŠ¶æ€è½¬æ¢å›¾å¦‚ä¸‹æ‰€ç¤ºï¼š</p></li></ul><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220708171859055.png" class=""><p>  å›¾ä¸­å¯è§ï¼Œåªæœ‰å½“äº‹ç‰©å¤„äº<code>æäº¤çš„</code>æˆ–è€…<code>ä¸­æ­¢çš„</code>çŠ¶æ€æ—¶ï¼Œä¸€ä¸ªäº‹åŠ¡çš„ç”Ÿå‘½å‘¨æœŸæ‰ç®—æ˜¯ç»“æŸäº†ã€‚å¯¹äºå·²ç»æäº¤çš„äº‹åŠ¡æ¥è¯´ï¼Œè¯¥äº‹åŠ¡å¯¹æ•°æ®åº“æ‰€åšçš„ä¿®æ”¹å°†æ°¸ä¹…ç”Ÿæ•ˆï¼Œå¯¹äºå¤„äºä¸­æ­¢çŠ¶æ€çš„äº‹ç‰©ï¼Œè¯¥äº‹åŠ¡å¯¹æ•°æ®åº“æ‰€åšçš„æ‰€æœ‰ä¿®æ”¹éƒ½ä¼šè¢«å›æ»šåˆ°æ²¡æ‰§è¡Œè¯¥äº‹ç‰©ä¹‹å‰çš„çŠ¶æ€ã€‚</p><h2 id="2-å¦‚ä½•ä½¿ç”¨äº‹åŠ¡"><a href="#2-å¦‚ä½•ä½¿ç”¨äº‹åŠ¡" class="headerlink" title="2. å¦‚ä½•ä½¿ç”¨äº‹åŠ¡"></a>2. å¦‚ä½•ä½¿ç”¨äº‹åŠ¡</h2><p>ä½¿ç”¨äº‹åŠ¡æœ‰ä¸¤ç§æ–¹å¼ï¼Œåˆ†åˆ«ä¸º <code>æ˜¾å¼äº‹åŠ¡</code> å’Œ <code>éšå¼äº‹åŠ¡</code> ã€‚</p><h3 id="2-1-æ˜¾å¼äº‹åŠ¡"><a href="#2-1-æ˜¾å¼äº‹åŠ¡" class="headerlink" title="2.1 æ˜¾å¼äº‹åŠ¡"></a>2.1 æ˜¾å¼äº‹åŠ¡</h3><p><strong>æ­¥éª¤1ï¼š</strong> START TRANSACTION æˆ–è€… BEGIN ï¼Œä½œç”¨æ˜¯æ˜¾å¼å¼€å¯ä¸€ä¸ªäº‹åŠ¡ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; BEGIN;</span><br><span class="line">#æˆ–è€…</span><br><span class="line">mysql&gt; START TRANSACTION;</span><br></pre></td></tr></table></figure><p><code>START TRANSACTION</code> è¯­å¥ç›¸è¾ƒäº <code>BEGIN</code> ç‰¹åˆ«ä¹‹å¤„åœ¨äºï¼Œåè¾¹èƒ½è·Ÿéšå‡ ä¸ª <code>ä¿®é¥°ç¬¦</code> ï¼š</p><p>â‘  <code>READ ONLY</code> ï¼šæ ‡è¯†å½“å‰äº‹åŠ¡æ˜¯ä¸€ä¸ª <code>åªè¯»äº‹åŠ¡</code> ï¼Œä¹Ÿå°±æ˜¯å±äºè¯¥äº‹åŠ¡çš„æ•°æ®åº“æ“ä½œåªèƒ½è¯»å–æ•°æ®ï¼Œè€Œä¸èƒ½ä¿®æ”¹æ•°æ®ã€‚</p><blockquote><p>è¡¥å……ï¼šåªè¯»äº‹åŠ¡ä¸­åªæ˜¯ä¸å…è®¸ä¿®æ”¹é‚£äº›å…¶ä»–äº‹åŠ¡ä¹Ÿèƒ½è®¿é—®åˆ°çš„è¡¨ä¸­çš„æ•°æ®ï¼Œå¯¹äºä¸´æ—¶è¡¨æ¥è¯´ï¼ˆæˆ‘ä»¬ä½¿ç”¨ CREATE TMEPORARY TABLE åˆ›å»ºçš„è¡¨ï¼‰ï¼Œç”±äºå®ƒä»¬åªèƒ½å†å½“å‰ä¼šè¯ä¸­å¯è§ï¼Œæ‰€æœ‰åªè¯»äº‹åŠ¡å…¶å®ä¹Ÿæ˜¯å¯ä»¥å¯¹ä¸´æ—¶è¡¨è¿›è¡Œå¢ã€åˆ ã€æ”¹æ“ä½œçš„ã€‚</p></blockquote><p>â‘¡ <code>READ WRITE</code> ï¼šæ ‡è¯†å½“å‰äº‹åŠ¡æ˜¯ä¸€ä¸ª <code>è¯»å†™äº‹åŠ¡</code> ï¼Œä¹Ÿå°±æ˜¯å±äºè¯¥äº‹åŠ¡çš„æ•°æ®åº“æ“ä½œæ—¢å¯ä»¥è¯»å–æ•°æ®ï¼Œ ä¹Ÿå¯ä»¥ä¿®æ”¹æ•°æ®ã€‚</p><p>â‘¢ <code>WITH CONSISTENT SNAPSHOT</code> ï¼šå¯åŠ¨ä¸€è‡´æ€§è¯»ã€‚</p><p>æ¯”å¦‚ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">START TRANSACTION READ ONLY; # å¼€å¯ä¸€ä¸ªåªè¯»äº‹åŠ¡</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">START TRANSACTION READ ONLY, WITH CONSISTENT SNAPSHOT # å¼€å¯åªè¯»äº‹åŠ¡å’Œä¸€è‡´æ€§è¯»</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">START TRANSACTION READ WRITE, WITH CONSISTENT SNAPSHOT # å¼€å¯è¯»å†™äº‹åŠ¡å’Œä¸€è‡´æ€§è¯»</span><br></pre></td></tr></table></figure><p>æ³¨æ„ï¼š</p><ul><li><code>READ ONLY</code>å’Œ<code>READ WRITE</code>æ˜¯ç”¨æ¥è®¾ç½®æ‰€è°“çš„äº‹ç‰©<code>è®¿é—®æ¨¡å¼</code>çš„ï¼Œå°±æ˜¯ä»¥åªè¯»è¿˜æ˜¯è¯»å†™çš„æ–¹å¼æ¥è®¿é—®æ•°æ®åº“ä¸­çš„æ•°æ®ï¼Œä¸€ä¸ªäº‹åŠ¡çš„è®¿é—®æ¨¡å¼ä¸èƒ½åŒæ—¶å³è®¾ç½®ä¸º<code>åªè¯»</code>çš„ä¹Ÿè®¾ç½®ä¸º<code>è¯»å†™</code>çš„ï¼Œæ‰€ä»¥ä¸èƒ½åŒæ—¶æŠŠ<code>READ ONLY</code>å’Œ<code>READ WRITE</code>æ”¾åˆ°<code>START TRANSACTION</code>è¯­å¥åè¾¹ã€‚</li><li>å¦‚æœæˆ‘ä»¬ä¸æ˜¾å¼æŒ‡å®šäº‹åŠ¡çš„è®¿é—®æ¨¡å¼ï¼Œé‚£ä¹ˆè¯¥äº‹åŠ¡çš„è®¿é—®æ¨¡å¼å°±æ˜¯<code>è¯»å†™</code>æ¨¡å¼</li></ul><p><strong>æ­¥éª¤2ï¼š</strong>ä¸€ç³»åˆ—äº‹åŠ¡ä¸­çš„æ“ä½œï¼ˆä¸»è¦æ˜¯DMLï¼Œä¸å«DDLï¼‰</p><p><strong>æ­¥éª¤3ï¼š</strong>æäº¤äº‹åŠ¡ æˆ– ä¸­æ­¢äº‹åŠ¡ï¼ˆå³å›æ»šäº‹åŠ¡ï¼‰</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># æäº¤äº‹åŠ¡ã€‚å½“æäº¤äº‹åŠ¡åï¼Œå¯¹æ•°æ®åº“çš„ä¿®æ”¹æ˜¯æ°¸ä¹…æ€§çš„ã€‚</span><br><span class="line">mysql&gt; COMMIT;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># å›æ»šäº‹åŠ¡ã€‚å³æ’¤é”€æ­£åœ¨è¿›è¡Œçš„æ‰€æœ‰æ²¡æœ‰æäº¤çš„ä¿®æ”¹</span><br><span class="line">mysql&gt; ROLLBACK;</span><br><span class="line"></span><br><span class="line"># å°†äº‹åŠ¡å›æ»šåˆ°æŸä¸ªä¿å­˜ç‚¹ã€‚</span><br><span class="line">mysql&gt; ROLLBACK TO [SAVEPOINT]</span><br></pre></td></tr></table></figure><p>å…¶ä¸­å…³äºSAVEPOINTç›¸å…³æ“ä½œæœ‰ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># åœ¨äº‹åŠ¡ä¸­åˆ›å»ºä¿å­˜ç‚¹ï¼Œæ–¹ä¾¿åç»­é’ˆå¯¹ä¿å­˜ç‚¹è¿›è¡Œå›æ»šã€‚ä¸€ä¸ªäº‹åŠ¡ä¸­å¯ä»¥å­˜åœ¨å¤šä¸ªä¿å­˜ç‚¹ã€‚</span><br><span class="line">SAVEPOINT ä¿å­˜ç‚¹åç§°;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># åˆ é™¤æŸä¸ªä¿å­˜ç‚¹</span><br><span class="line">RELEASE SAVEPOINT ä¿å­˜ç‚¹åç§°;</span><br></pre></td></tr></table></figure><h3 id="2-2-éšå¼äº‹åŠ¡"><a href="#2-2-éšå¼äº‹åŠ¡" class="headerlink" title="2.2 éšå¼äº‹åŠ¡"></a>2.2 éšå¼äº‹åŠ¡</h3><p>MySQLä¸­æœ‰ä¸€ä¸ªç³»ç»Ÿå˜é‡ <code>autocommit</code> ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SHOW VARIABLES LIKE &#x27;autocommit&#x27;;</span><br><span class="line">+---------------+-------+</span><br><span class="line">| Variable_name | Value |</span><br><span class="line">+---------------+-------+</span><br><span class="line">| autocommit    |  ON   |</span><br><span class="line">+---------------+-------+</span><br><span class="line">1 row in set (0.01 sec)</span><br></pre></td></tr></table></figure><p>å½“ç„¶ï¼Œå¦‚æœæˆ‘ä»¬æƒ³å…³é—­è¿™ç§ <code>è‡ªåŠ¨æäº¤</code> çš„åŠŸèƒ½ï¼Œå¯ä»¥ä½¿ç”¨ä¸‹è¾¹ä¸¤ç§æ–¹æ³•ä¹‹ä¸€ï¼š</p><ul><li><p>æ˜¾å¼çš„çš„ä½¿ç”¨ <code>START TRANSACTION</code> æˆ–è€… <code>BEGIN</code> è¯­å¥å¼€å¯ä¸€ä¸ªäº‹åŠ¡ã€‚è¿™æ ·åœ¨æœ¬æ¬¡äº‹åŠ¡æäº¤æˆ–è€…å›æ»šå‰ä¼šæš‚æ—¶å…³é—­æ‰è‡ªåŠ¨æäº¤çš„åŠŸèƒ½ã€‚</p></li><li><p>æŠŠç³»ç»Ÿå˜é‡ <code>autocommit</code> çš„å€¼è®¾ç½®ä¸º <code>OFF</code> ï¼Œå°±åƒè¿™æ ·ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SET autocommit = OFF;</span><br><span class="line">#æˆ–</span><br><span class="line">SET autocommit = 0;</span><br></pre></td></tr></table></figure></li></ul><h3 id="2-3-éšå¼æäº¤æ•°æ®çš„æƒ…å†µ"><a href="#2-3-éšå¼æäº¤æ•°æ®çš„æƒ…å†µ" class="headerlink" title="2.3 éšå¼æäº¤æ•°æ®çš„æƒ…å†µ"></a>2.3 éšå¼æäº¤æ•°æ®çš„æƒ…å†µ</h3><ul><li><p>æ•°æ®å®šä¹‰è¯­è¨€ï¼ˆData definition languageï¼Œç¼©å†™ä¸ºï¼šDDLï¼‰</p><p>æ•°æ®åº“å¯¹è±¡ï¼ŒæŒ‡çš„å°±æ˜¯<code>æ•°æ®åº“ã€è¡¨ã€è§†å›¾ã€å­˜å‚¨è¿‡ç¨‹</code>ç­‰ç»“æ„ã€‚å½“æˆ‘ä»¬<code>CREATEã€ALTERã€DROP</code>ç­‰è¯­å¥å»ä¿®æ”¹æ•°æ®åº“å¯¹è±¡æ—¶ï¼Œå°±ä¼šéšå¼çš„æäº¤å‰è¾¹è¯­å¥æ‰€å±äºçš„äº‹ç‰©ã€‚å³ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">BEGIN;</span><br><span class="line"></span><br><span class="line">SELECT ... # äº‹åŠ¡ä¸­çš„ä¸€æ¡è¯­å¥</span><br><span class="line">UPDATE ... # äº‹åŠ¡ä¸­çš„ä¸€æ¡è¯­å¥</span><br><span class="line">... # äº‹åŠ¡ä¸­çš„å…¶ä»–è¯­å¥</span><br><span class="line"></span><br><span class="line">CREATE TABLE ... # æ­¤è¯­å¥ä¼šéšå¼çš„æäº¤å‰è¾¹è¯­å¥æ‰€å±äºçš„äº‹åŠ¡</span><br></pre></td></tr></table></figure></li><li><p>éšå¼ä½¿ç”¨æˆ–ä¿®æ”¹mysqlæ•°æ®åº“ä¸­çš„è¡¨</p><p>å½“æˆ‘ä»¬ä½¿ç”¨<code>ALTER USER</code>ã€<code>CREATE USER</code>ã€<code>DROP USER</code>ã€<code>GRANT</code>ã€<code>RENAME USER</code>ã€<code>REVOKE</code>ã€<code>SET PASSWORD</code>ç­‰è¯­å¥æ—¶ä¹Ÿä¼šéšå¼çš„æäº¤å‰è¾¹è¯­å¥æ‰€å±äºçš„äº‹åŠ¡ã€‚</p></li><li><p>äº‹åŠ¡æ§åˆ¶æˆ–å…³äºé”å®šçš„è¯­å¥</p><p>â‘  å½“æˆ‘ä»¬åœ¨ä¸€ä¸ªäº‹åŠ¡è¿˜æ²¡æäº¤æˆ–è€…å›æ»šæ—¶å°±åˆä½¿ç”¨ START TRANSACTION æˆ–è€… BEGIN è¯­å¥å¼€å¯äº†å¦ä¸€ä¸ªäº‹åŠ¡æ—¶ï¼Œä¼šéšå¼çš„æäº¤ä¸Šä¸€ä¸ªäº‹åŠ¡ã€‚å³ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">BEGIN;</span><br><span class="line"></span><br><span class="line">SELECT ... # äº‹åŠ¡ä¸­çš„ä¸€æ¡è¯­å¥</span><br><span class="line">UPDATE ... # äº‹åŠ¡ä¸­çš„ä¸€æ¡è¯­å¥</span><br><span class="line">... # äº‹åŠ¡ä¸­çš„å…¶ä»–è¯­å¥</span><br><span class="line"></span><br><span class="line">BEGIN; # æ­¤è¯­å¥ä¼šéšå¼çš„æäº¤å‰è¾¹è¯­å¥æ‰€å±äºçš„äº‹åŠ¡</span><br></pre></td></tr></table></figure><p>â‘¡ å½“å‰çš„ autocommit ç³»ç»Ÿå˜é‡çš„å€¼ä¸º OFF ï¼Œæˆ‘ä»¬æ‰‹åŠ¨æŠŠå®ƒè°ƒä¸º ON æ—¶ï¼Œä¹Ÿä¼š éšå¼çš„æäº¤å‰è¾¹è¯­å¥æ‰€å±çš„äº‹åŠ¡ã€‚</p><p>â‘¢ ä½¿ç”¨ LOCK TABLES ã€ UNLOCK TABLES ç­‰å…³äºé”å®šçš„è¯­å¥ä¹Ÿä¼š éšå¼çš„æäº¤ å‰è¾¹è¯­å¥æ‰€å±çš„äº‹åŠ¡ã€‚</p></li><li><p>åŠ è½½æ•°æ®çš„è¯­å¥</p><p>ä½¿ç”¨<code>LOAD DATA</code>è¯­å¥æ¥æ‰¹é‡å¾€æ•°æ®åº“ä¸­å¯¼å…¥æ•°æ®æ—¶ï¼Œä¹Ÿä¼š<code>éšå¼çš„æäº¤</code>å‰è¾¹è¯­å¥æ‰€å±çš„äº‹åŠ¡ã€‚</p></li><li><p>å…³äºMySQLå¤åˆ¶çš„ä¸€äº›è¯­å¥</p><p>ä½¿ç”¨<code>START SLAVEã€STOP SLAVEã€RESET SLAVEã€CHANGE MASTER TO</code>ç­‰è¯­å¥ä¼šéšå¼çš„æäº¤å‰è¾¹è¯­å¥æ‰€å±çš„äº‹åŠ¡</p></li><li><p>å…¶ä»–çš„ä¸€äº›è¯­å¥</p><p>ä½¿ç”¨<code>ANALYZE TABLEã€CACHE INDEXã€CAECK TABLEã€FLUSHã€LOAD INDEX INTO CACHEã€OPTIMIZE TABLEã€REPAIR TABLEã€RESET</code>ç­‰è¯­å¥ä¹Ÿä¼šéšå¼çš„æäº¤å‰è¾¹è¯­å¥æ‰€å±çš„äº‹åŠ¡ã€‚</p></li></ul><h3 id="2-4-ä½¿ç”¨ä¸¾ä¾‹1ï¼šæäº¤ä¸å›æ»š"><a href="#2-4-ä½¿ç”¨ä¸¾ä¾‹1ï¼šæäº¤ä¸å›æ»š" class="headerlink" title="2.4 ä½¿ç”¨ä¸¾ä¾‹1ï¼šæäº¤ä¸å›æ»š"></a>2.4 ä½¿ç”¨ä¸¾ä¾‹1ï¼šæäº¤ä¸å›æ»š</h3><p>æˆ‘ä»¬çœ‹ä¸‹åœ¨ MySQL çš„é»˜è®¤çŠ¶æ€ä¸‹ï¼Œä¸‹é¢è¿™ä¸ªäº‹åŠ¡æœ€åçš„å¤„ç†ç»“æœæ˜¯ä»€ä¹ˆã€‚</p><p><strong>æƒ…å†µ1ï¼š</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE user(name varchar(20), PRIMARY KEY (name)) ENGINE=InnoDB;</span><br><span class="line"></span><br><span class="line">BEGIN;</span><br><span class="line">INSERT INTO user SELECT &#x27;å¼ ä¸‰&#x27;;</span><br><span class="line">COMMIT;</span><br><span class="line"></span><br><span class="line">BEGIN;</span><br><span class="line">INSERT INTO user SELECT &#x27;æå››&#x27;;</span><br><span class="line">INSERT INTO user SELECT &#x27;æå››&#x27;;</span><br><span class="line">ROLLBACK;</span><br><span class="line"></span><br><span class="line">SELECT * FROM user;</span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœï¼ˆ1 è¡Œæ•°æ®ï¼‰ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; commit;</span><br><span class="line">Query OK, 0 rows affected (0.00 ç§’)</span><br><span class="line"></span><br><span class="line">mysql&gt; BEGIN;</span><br><span class="line">Query OK, 0 rows affected (0.00 ç§’)</span><br><span class="line"></span><br><span class="line">mysql&gt; INSERT INTO user SELECT &#x27;æå››&#x27;;</span><br><span class="line">Query OK, 1 rows affected (0.00 ç§’)</span><br><span class="line"></span><br><span class="line">mysql&gt; INSERT INTO user SELECT &#x27;æå››&#x27;;</span><br><span class="line">Duplicate entry &#x27;æå››&#x27; for key &#x27;user.PRIMARY&#x27;</span><br><span class="line">mysql&gt; ROLLBACK;</span><br><span class="line">Query OK, 0 rows affected (0.01 ç§’)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from user;</span><br><span class="line">+--------+</span><br><span class="line">| name   |</span><br><span class="line">+--------+</span><br><span class="line">| å¼ ä¸‰    |</span><br><span class="line">+--------+</span><br><span class="line">1 è¡Œäºæ•°æ®é›† (0.01 ç§’)</span><br></pre></td></tr></table></figure><p><strong>æƒ…å†µ2ï¼š</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE user (name varchar(20), PRIMARY KEY (name)) ENGINE=InnoDB;</span><br><span class="line"></span><br><span class="line">BEGIN;</span><br><span class="line">INSERT INTO user SELECT &#x27;å¼ ä¸‰&#x27;;</span><br><span class="line">COMMIT;</span><br><span class="line"></span><br><span class="line">INSERT INTO user SELECT &#x27;æå››&#x27;;</span><br><span class="line">INSERT INTO user SELECT &#x27;æå››&#x27;;</span><br><span class="line">ROLLBACK;</span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœï¼ˆ2 è¡Œæ•°æ®ï¼‰ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT * FROM user;</span><br><span class="line">+--------+</span><br><span class="line">| name   |</span><br><span class="line">+--------+</span><br><span class="line">| å¼ ä¸‰    |</span><br><span class="line">| æå››    |</span><br><span class="line">+--------+</span><br><span class="line">2 è¡Œäºæ•°æ®é›† (0.01 ç§’)</span><br></pre></td></tr></table></figure><p><strong>æƒ…å†µ3ï¼š</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE user(name varchar(255), PRIMARY KEY (name)) ENGINE=InnoDB;</span><br><span class="line"></span><br><span class="line">SET @@completion_type = 1;</span><br><span class="line">BEGIN;</span><br><span class="line">INSERT INTO user SELECT &#x27;å¼ ä¸‰&#x27;;</span><br><span class="line">COMMIT;</span><br><span class="line"></span><br><span class="line">INSERT INTO user SELECT &#x27;æå››&#x27;;</span><br><span class="line">INSERT INTO user SELECT &#x27;æå››&#x27;;</span><br><span class="line">ROLLBACK;</span><br><span class="line"></span><br><span class="line">SELECT * FROM user;</span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœï¼ˆ1 è¡Œæ•°æ®ï¼‰ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT * FROM user;</span><br><span class="line">+--------+</span><br><span class="line">| name   |</span><br><span class="line">+--------+</span><br><span class="line">| å¼ ä¸‰    |</span><br><span class="line">+--------+</span><br><span class="line">1 è¡Œäºæ•°æ®é›† (0.01 ç§’)</span><br></pre></td></tr></table></figure><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220708201221316.png" class=""><blockquote><p>å½“æˆ‘ä»¬è®¾ç½® autocommit&#x3D;0 æ—¶ï¼Œä¸è®ºæ˜¯å¦é‡‡ç”¨ START TRANSACTION æˆ–è€… BEGIN çš„æ–¹å¼æ¥å¼€å¯äº‹ åŠ¡ï¼Œéƒ½éœ€è¦ç”¨ COMMIT è¿›è¡Œæäº¤ï¼Œè®©äº‹åŠ¡ç”Ÿæ•ˆï¼Œä½¿ç”¨ ROLLBACK å¯¹äº‹åŠ¡è¿›è¡Œå›æ»šã€‚</p><p>å½“æˆ‘ä»¬è®¾ç½® autocommit&#x3D;1 æ—¶ï¼Œæ¯æ¡ SQL è¯­å¥éƒ½ä¼šè‡ªåŠ¨è¿›è¡Œæäº¤ã€‚ ä¸è¿‡è¿™æ—¶ï¼Œå¦‚æœä½ é‡‡ç”¨ START TRANSACTION æˆ–è€… BEGIN çš„æ–¹å¼æ¥æ˜¾å¼åœ°å¼€å¯äº‹åŠ¡ï¼Œé‚£ä¹ˆè¿™ä¸ªäº‹åŠ¡åªæœ‰åœ¨ COMMIT æ—¶æ‰ä¼šç”Ÿæ•ˆï¼Œ åœ¨ ROLLBACK æ—¶æ‰ä¼šå›æ»šã€‚</p></blockquote><h3 id="2-5-ä½¿ç”¨ä¸¾ä¾‹2ï¼šæµ‹è¯•ä¸æ”¯æŒäº‹åŠ¡çš„engine"><a href="#2-5-ä½¿ç”¨ä¸¾ä¾‹2ï¼šæµ‹è¯•ä¸æ”¯æŒäº‹åŠ¡çš„engine" class="headerlink" title="2.5 ä½¿ç”¨ä¸¾ä¾‹2ï¼šæµ‹è¯•ä¸æ”¯æŒäº‹åŠ¡çš„engine"></a>2.5 ä½¿ç”¨ä¸¾ä¾‹2ï¼šæµ‹è¯•ä¸æ”¯æŒäº‹åŠ¡çš„engine</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE test1(i INT) ENGINE=InnoDB;</span><br><span class="line"></span><br><span class="line">CREATE TABLE test2(i INT) ENGINE=MYISAM;</span><br></pre></td></tr></table></figure><p>é’ˆå¯¹äºInnoDBè¡¨</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">BEGIN;</span><br><span class="line">INSERT INTO test1 VALUES(1);</span><br><span class="line">ROLLBACK;</span><br><span class="line"></span><br><span class="line">SELECT * FROM test1;</span><br></pre></td></tr></table></figure><p>ç»“æœï¼šæ²¡æœ‰æ•°æ®</p><p>é’ˆå¯¹äºMYISAMè¡¨ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">BEGIN;</span><br><span class="line">INSERT INTO test1 VALUES(1);</span><br><span class="line">ROLLBACK;</span><br><span class="line"></span><br><span class="line">SELECT * FROM test2;</span><br></pre></td></tr></table></figure><p>ç»“æœï¼šæœ‰ä¸€æ¡æ•°æ®</p><h3 id="2-6-ä½¿ç”¨ä¸¾ä¾‹3ï¼šSAVEPOINT"><a href="#2-6-ä½¿ç”¨ä¸¾ä¾‹3ï¼šSAVEPOINT" class="headerlink" title="2.6 ä½¿ç”¨ä¸¾ä¾‹3ï¼šSAVEPOINT"></a>2.6 ä½¿ç”¨ä¸¾ä¾‹3ï¼šSAVEPOINT</h3><p>åˆ›å»ºè¡¨å¹¶æ·»åŠ æ•°æ®ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE account(</span><br><span class="line">id INT PRIMARY KEY AUTO_INCREMENT,</span><br><span class="line">NAME VARCHAR(15),</span><br><span class="line">balance DECIMAL(10,2)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">INSERT INTO account(NAME,balance)</span><br><span class="line">VALUES</span><br><span class="line">(&#x27;å¼ ä¸‰&#x27;,1000),</span><br><span class="line">(&#x27;æå››&#x27;,1000);</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">BEGIN;</span><br><span class="line">UPDATE account SET balance = balance - 100 WHERE NAME = &#x27;å¼ ä¸‰&#x27;;</span><br><span class="line">UPDATE account SET balance = balance - 100 WHERE NAME = &#x27;å¼ ä¸‰&#x27;;</span><br><span class="line">SAVEPOINT s1; # è®¾ç½®ä¿å­˜ç‚¹</span><br><span class="line">UPDATE account SET balance = balance + 1 WHERE NAME = &#x27;å¼ ä¸‰&#x27;;</span><br><span class="line">ROLLBACK TO s1; # å›æ»šåˆ°ä¿å­˜ç‚¹</span><br></pre></td></tr></table></figure><p>ç»“æœï¼šå¼ ä¸‰ï¼š800.00</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ROLLBACK;</span><br></pre></td></tr></table></figure><p>ç»“æœï¼šå¼ ä¸‰ï¼š1000.00</p><h2 id="3-äº‹åŠ¡éš”ç¦»çº§åˆ«"><a href="#3-äº‹åŠ¡éš”ç¦»çº§åˆ«" class="headerlink" title="3. äº‹åŠ¡éš”ç¦»çº§åˆ«"></a>3. äº‹åŠ¡éš”ç¦»çº§åˆ«</h2><p>MySQLæ˜¯ä¸€ä¸ª <code>å®¢æˆ·ç«¯ï¼æœåŠ¡å™¨</code> æ¶æ„çš„è½¯ä»¶ï¼Œå¯¹äºåŒä¸€ä¸ªæœåŠ¡å™¨æ¥è¯´ï¼Œå¯ä»¥æœ‰è‹¥å¹²ä¸ªå®¢æˆ·ç«¯ä¸ä¹‹è¿æ¥ï¼Œæ¯ ä¸ªå®¢æˆ·ç«¯ä¸æœåŠ¡å™¨è¿æ¥ä¸Šä¹‹åï¼Œå°±å¯ä»¥ç§°ä¸ºä¸€ä¸ªä¼šè¯ï¼ˆ <code>Session</code> ï¼‰ã€‚æ¯ä¸ªå®¢æˆ·ç«¯éƒ½å¯ä»¥åœ¨è‡ªå·±çš„ä¼šè¯ä¸­ å‘æœåŠ¡å™¨å‘å‡ºè¯·æ±‚è¯­å¥ï¼Œä¸€ä¸ªè¯·æ±‚è¯­å¥å¯èƒ½æ˜¯æŸä¸ªäº‹åŠ¡çš„ä¸€éƒ¨åˆ†ï¼Œä¹Ÿå°±æ˜¯å¯¹äºæœåŠ¡å™¨æ¥è¯´å¯èƒ½åŒæ—¶å¤„ç†å¤šä¸ªäº‹åŠ¡ã€‚äº‹åŠ¡æœ‰ <code>éš”ç¦»æ€§</code> çš„ç‰¹æ€§ï¼Œç†è®ºä¸Šåœ¨æŸä¸ªäº‹åŠ¡ <code>å¯¹æŸä¸ªæ•°æ®è¿›è¡Œè®¿é—®</code> æ—¶ï¼Œå…¶ä»–äº‹åŠ¡åº”è¯¥è¿›è¡Œ<code>æ’é˜Ÿ</code> ï¼Œå½“è¯¥äº‹åŠ¡æäº¤ä¹‹åï¼Œå…¶ä»–äº‹åŠ¡æ‰å¯ä»¥ç»§ç»­è®¿é—®è¿™ä¸ªæ•°æ®ã€‚ä½†æ˜¯è¿™æ ·å¯¹ <code>æ€§èƒ½å½±å“å¤ªå¤§</code> ï¼Œæˆ‘ä»¬æ—¢æƒ³ä¿æŒäº‹åŠ¡çš„éš”ç¦»æ€§ï¼Œåˆæƒ³è®©æœåŠ¡å™¨åœ¨å¤„ç†è®¿é—®åŒä¸€æ•°æ®çš„å¤šä¸ªäº‹åŠ¡æ—¶ <code>æ€§èƒ½å°½é‡é«˜äº›</code> ï¼Œé‚£å°±çœ‹äºŒè€…å¦‚ä½•æƒè¡¡å– èˆäº†ã€‚</p><h3 id="3-1-æ•°æ®å‡†å¤‡"><a href="#3-1-æ•°æ®å‡†å¤‡" class="headerlink" title="3.1 æ•°æ®å‡†å¤‡"></a>3.1 æ•°æ®å‡†å¤‡</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE student (</span><br><span class="line">    studentno INT,</span><br><span class="line">    name VARCHAR(20),</span><br><span class="line">    class varchar(20),</span><br><span class="line">    PRIMARY KEY (studentno)</span><br><span class="line">) Engine=InnoDB CHARSET=utf8;</span><br></pre></td></tr></table></figure><p>ç„¶åå‘è¿™ä¸ªè¡¨é‡Œæ’å…¥ä¸€æ¡æ•°æ®ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO student VALUES(1, &#x27;å°è°·&#x27;, &#x27;1ç­&#x27;);</span><br></pre></td></tr></table></figure><p>ç°åœ¨è¡¨é‡Œçš„æ•°æ®å°±æ˜¯è¿™æ ·çš„ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from student;</span><br><span class="line">+-----------+--------+-------+</span><br><span class="line">| studentno | name   | class |</span><br><span class="line">+-----------+--------+-------+</span><br><span class="line">|      1    |   å°è°·  | 1ç­   |</span><br><span class="line">+-----------+--------+-------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure><h3 id="3-2-æ•°æ®å¹¶å‘é—®é¢˜"><a href="#3-2-æ•°æ®å¹¶å‘é—®é¢˜" class="headerlink" title="3.2 æ•°æ®å¹¶å‘é—®é¢˜"></a>3.2 æ•°æ®å¹¶å‘é—®é¢˜</h3><p>é’ˆå¯¹äº‹åŠ¡çš„éš”ç¦»æ€§å’Œå¹¶å‘æ€§ï¼Œæˆ‘ä»¬æ€ä¹ˆåšå–èˆå‘¢ï¼Ÿå…ˆçœ‹ä¸€ä¸‹è®¿é—®ç›¸åŒæ•°æ®çš„äº‹åŠ¡åœ¨ ä¸ä¿è¯ä¸²è¡Œæ‰§è¡Œ ï¼ˆä¹Ÿ å°±æ˜¯æ‰§è¡Œå®Œä¸€ä¸ªå†æ‰§è¡Œå¦ä¸€ä¸ªï¼‰çš„æƒ…å†µä¸‹å¯èƒ½ä¼šå‡ºç°å“ªäº›é—®é¢˜ï¼š</p><p><strong>1. è„å†™ï¼ˆ Dirty Write ï¼‰</strong></p><p>å¯¹äºä¸¤ä¸ªäº‹åŠ¡ Session Aã€Session Bï¼Œå¦‚æœäº‹åŠ¡Session A <code>ä¿®æ”¹äº†</code> å¦ä¸€ä¸ª <code>æœªæäº¤</code> äº‹åŠ¡Session B <code>ä¿®æ”¹è¿‡</code> çš„æ•°æ®ï¼Œé‚£å°±æ„å‘³ç€å‘ç”Ÿäº† <code>è„å†™</code>ï¼Œç¤ºæ„å›¾å¦‚ä¸‹ï¼š</p><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220708214453902.png" class=""> <p>Session A å’Œ Session B å„å¼€å¯äº†ä¸€ä¸ªäº‹åŠ¡ï¼ŒSesssion B ä¸­çš„äº‹åŠ¡å…ˆå°†studentnoåˆ—ä¸º1çš„è®°å½•çš„nameåˆ—æ›´æ–°ä¸ºâ€™æå››â€™ï¼Œç„¶åSession Aä¸­çš„äº‹åŠ¡æ¥ç€åˆæŠŠè¿™æ¡studentnoåˆ—ä¸º1çš„è®°å½•çš„nameåˆ—æ›´æ–°ä¸ºâ€™å¼ ä¸‰â€™ã€‚å¦‚æœä¹‹åSession Bä¸­çš„äº‹åŠ¡è¿›è¡Œäº†å›æ»šï¼Œé‚£ä¹ˆSession Aä¸­çš„æ›´æ–°ä¹Ÿå°†ä¸å¤å­˜åœ¨ï¼Œè¿™ç§ç°è±¡ç§°ä¹‹ä¸ºè„å†™ã€‚è¿™æ—¶Session Aä¸­çš„äº‹åŠ¡å°±æ²¡æœ‰æ•ˆæœäº†ï¼Œæ˜æ˜æŠŠæ•°æ®æ›´æ–°äº†ï¼Œæœ€åä¹Ÿæäº¤äº‹åŠ¡äº†ï¼Œæœ€åçœ‹åˆ°çš„æ•°æ®ä»€ä¹ˆå˜åŒ–ä¹Ÿæ²¡æœ‰ã€‚è¿™é‡Œå¤§å®¶å¯¹äº‹åŠ¡çš„éš”ç¦»æ€§æ¯”è¾ƒäº†è§£çš„è¯ï¼Œä¼šå‘ç°é»˜è®¤éš”ç¦»çº§åˆ«ä¸‹ï¼Œä¸Šé¢Session Aä¸­çš„æ›´æ–°è¯­å¥ä¼šå¤„äºç­‰å¾…çŠ¶æ€ï¼Œè¿™é‡Œåªæ˜¯è·Ÿå¤§å®¶è¯´æ˜ä¸€ä¸‹ä¼šå‡ºç°è¿™æ ·çš„ç°è±¡ã€‚</p><p><strong>2. è„è¯»ï¼ˆ Dirty Read ï¼‰</strong></p><p> å¯¹äºä¸¤ä¸ªäº‹åŠ¡ Session Aã€Session Bï¼ŒSession A <code>è¯»å–</code> äº†å·²ç»è¢« Session B <code>æ›´æ–°</code> ä½†è¿˜ <code>æ²¡æœ‰è¢«æäº¤</code> çš„å­—æ®µã€‚ ä¹‹åè‹¥ Session B <code>å›æ»š</code> ï¼ŒSession A <code>è¯»å– </code>çš„å†…å®¹å°±æ˜¯ <code>ä¸´æ—¶ä¸”æ— æ•ˆ</code> çš„ã€‚</p><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220708215109480.png" class=""> <p>Session Aå’ŒSession Bå„å¼€å¯äº†ä¸€ä¸ªäº‹åŠ¡ï¼ŒSession Bä¸­çš„äº‹åŠ¡å…ˆå°†studentnoåˆ—ä¸º1çš„è®°å½•çš„nameåˆ—æ›´æ–° ä¸ºâ€™å¼ ä¸‰â€™ï¼Œç„¶åSession Aä¸­çš„äº‹åŠ¡å†å»æŸ¥è¯¢è¿™æ¡studentnoä¸º1çš„è®°å½•ï¼Œå¦‚æœè¯»åˆ°åˆ—nameçš„å€¼ä¸ºâ€™å¼ ä¸‰â€™ï¼Œè€Œ Session Bä¸­çš„äº‹åŠ¡ç¨åè¿›è¡Œäº†å›æ»šï¼Œé‚£ä¹ˆSession Aä¸­çš„äº‹åŠ¡ç›¸å½“äºè¯»åˆ°äº†ä¸€ä¸ªä¸å­˜åœ¨çš„æ•°æ®ï¼Œè¿™ç§ç°è±¡å°±ç§°ä¹‹ä¸º <code>è„è¯»</code> ã€‚</p><p><strong>3. ä¸å¯é‡å¤è¯»ï¼ˆ Non-Repeatable Read ï¼‰</strong></p><p>å¯¹äºä¸¤ä¸ªäº‹åŠ¡Session Aã€Session Bï¼ŒSession A <code>è¯»å–</code>äº†ä¸€ä¸ªå­—æ®µï¼Œç„¶å Session B <code>æ›´æ–°</code>äº†è¯¥å­—æ®µã€‚ ä¹‹å Session A <code>å†æ¬¡è¯»å–</code> åŒä¸€ä¸ªå­—æ®µï¼Œ <code>å€¼å°±ä¸åŒ</code> äº†ã€‚é‚£å°±æ„å‘³ç€å‘ç”Ÿäº†ä¸å¯é‡å¤è¯»ã€‚</p><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220708215626435.png" class=""> <p>æˆ‘ä»¬åœ¨Session Bä¸­æäº¤äº†å‡ ä¸ª <code>éšå¼äº‹åŠ¡</code> ï¼ˆæ³¨æ„æ˜¯éšå¼äº‹åŠ¡ï¼Œæ„å‘³ç€è¯­å¥ç»“æŸäº‹åŠ¡å°±æäº¤äº†ï¼‰ï¼Œè¿™äº›äº‹åŠ¡ éƒ½ä¿®æ”¹äº†studentnoåˆ—ä¸º1çš„è®°å½•çš„åˆ—nameçš„å€¼ï¼Œæ¯æ¬¡äº‹åŠ¡æäº¤ä¹‹åï¼Œå¦‚æœSession Aä¸­çš„äº‹åŠ¡éƒ½å¯ä»¥æŸ¥çœ‹åˆ°æœ€æ–°çš„å€¼ï¼Œè¿™ç§ç°è±¡ä¹Ÿè¢«ç§°ä¹‹ä¸º <code>ä¸å¯é‡å¤è¯» </code>ã€‚</p><p><strong>4. å¹»è¯»ï¼ˆ Phantom ï¼‰</strong></p><p>å¯¹äºä¸¤ä¸ªäº‹åŠ¡Session Aã€Session B, Session A ä»ä¸€ä¸ªè¡¨ä¸­ <code>è¯»å–</code> äº†ä¸€ä¸ªå­—æ®µ, ç„¶å Session B åœ¨è¯¥è¡¨ä¸­ æ’ å…¥ äº†ä¸€äº›æ–°çš„è¡Œã€‚ ä¹‹å, å¦‚æœ Session A <code>å†æ¬¡è¯»å–</code> åŒä¸€ä¸ªè¡¨, å°±ä¼šå¤šå‡ºå‡ è¡Œã€‚é‚£å°±æ„å‘³ç€å‘ç”Ÿäº†<code>å¹»è¯»</code>ã€‚</p><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220708220102342.png" class=""> <p>Session Aä¸­çš„äº‹åŠ¡å…ˆæ ¹æ®æ¡ä»¶ studentno &gt; 0è¿™ä¸ªæ¡ä»¶æŸ¥è¯¢è¡¨studentï¼Œå¾—åˆ°äº†nameåˆ—å€¼ä¸ºâ€™å¼ ä¸‰â€™çš„è®°å½•ï¼› ä¹‹åSession Bä¸­æäº¤äº†ä¸€ä¸ª <code>éšå¼äº‹åŠ¡</code> ï¼Œè¯¥äº‹åŠ¡å‘è¡¨studentä¸­æ’å…¥äº†ä¸€æ¡æ–°è®°å½•ï¼›ä¹‹åSession Aä¸­çš„äº‹åŠ¡ å†æ ¹æ®ç›¸åŒçš„æ¡ä»¶ studentno &gt; 0æŸ¥è¯¢è¡¨studentï¼Œå¾—åˆ°çš„ç»“æœé›†ä¸­åŒ…å«Session Bä¸­çš„äº‹åŠ¡æ–°æ’å…¥çš„é‚£æ¡è®° å½•ï¼Œè¿™ç§ç°è±¡ä¹Ÿè¢«ç§°ä¹‹ä¸º å¹»è¯» ã€‚æˆ‘ä»¬æŠŠæ–°æ’å…¥çš„é‚£äº›è®°å½•ç§°ä¹‹ä¸º <code>å¹»å½±è®°å½•</code> ã€‚</p><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220708220228436.png" class=""><h3 id="3-3-SQLä¸­çš„å››ç§éš”ç¦»çº§åˆ«"><a href="#3-3-SQLä¸­çš„å››ç§éš”ç¦»çº§åˆ«" class="headerlink" title="3.3 SQLä¸­çš„å››ç§éš”ç¦»çº§åˆ«"></a>3.3 SQLä¸­çš„å››ç§éš”ç¦»çº§åˆ«</h3><p>ä¸Šé¢ä»‹ç»äº†å‡ ç§å¹¶å‘äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­å¯èƒ½é‡åˆ°çš„ä¸€äº›é—®é¢˜ï¼Œè¿™äº›é—®é¢˜æœ‰è½»é‡ç¼“æ€¥ä¹‹åˆ†ï¼Œæˆ‘ä»¬ç»™è¿™äº›é—®é¢˜ æŒ‰ç…§ä¸¥é‡æ€§æ¥æ’ä¸€ä¸‹åºï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">è„å†™ &gt; è„è¯» &gt; ä¸å¯é‡å¤è¯» &gt; å¹»è¯»</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬æ„¿æ„èˆå¼ƒä¸€éƒ¨åˆ†éš”ç¦»æ€§æ¥æ¢å–ä¸€éƒ¨åˆ†æ€§èƒ½åœ¨è¿™é‡Œå°±ä½“ç°åœ¨ï¼šè®¾ç«‹ä¸€äº›éš”ç¦»çº§åˆ«ï¼Œéš”ç¦»çº§åˆ«è¶Šä½ï¼Œå¹¶å‘é—®é¢˜å‘ç”Ÿçš„å°±è¶Šå¤šã€‚ <code>SQLæ ‡å‡†</code> ä¸­è®¾ç«‹äº†4ä¸ª <code>éš”ç¦»çº§åˆ«</code> ï¼š</p><ul><li><code>READ UNCOMMITTED</code> ï¼šè¯»æœªæäº¤ï¼Œåœ¨è¯¥éš”ç¦»çº§åˆ«ï¼Œæ‰€æœ‰äº‹åŠ¡éƒ½å¯ä»¥çœ‹åˆ°å…¶ä»–æœªæäº¤äº‹åŠ¡çš„æ‰§è¡Œç»“ æœã€‚ä¸èƒ½é¿å…è„è¯»ã€ä¸å¯é‡å¤è¯»ã€å¹»è¯»ã€‚ </li><li><code>READ COMMITTED</code> ï¼šè¯»å·²æäº¤ï¼Œå®ƒæ»¡è¶³äº†éš”ç¦»çš„ç®€å•å®šä¹‰ï¼šä¸€ä¸ªäº‹åŠ¡åªèƒ½çœ‹è§å·²ç»æäº¤äº‹åŠ¡æ‰€åš çš„æ”¹å˜ã€‚è¿™æ˜¯å¤§å¤šæ•°æ•°æ®åº“ç³»ç»Ÿçš„é»˜è®¤éš”ç¦»çº§åˆ«ï¼ˆä½†ä¸æ˜¯MySQLé»˜è®¤çš„ï¼‰ã€‚å¯ä»¥é¿å…è„è¯»ï¼Œä½†ä¸å¯ é‡å¤è¯»ã€å¹»è¯»é—®é¢˜ä»ç„¶å­˜åœ¨ã€‚ </li><li><code>REPEATABLE READ</code> ï¼šå¯é‡å¤è¯»ï¼Œäº‹åŠ¡Aåœ¨è¯»åˆ°ä¸€æ¡æ•°æ®ä¹‹åï¼Œæ­¤æ—¶äº‹åŠ¡Bå¯¹è¯¥æ•°æ®è¿›è¡Œäº†ä¿®æ”¹å¹¶æ äº¤ï¼Œé‚£ä¹ˆäº‹åŠ¡Aå†è¯»è¯¥æ•°æ®ï¼Œè¯»åˆ°çš„è¿˜æ˜¯åŸæ¥çš„å†…å®¹ã€‚å¯ä»¥é¿å…è„è¯»ã€ä¸å¯é‡å¤è¯»ï¼Œä½†å¹»è¯»é—®é¢˜ä» ç„¶å­˜åœ¨ã€‚è¿™æ˜¯MySQLçš„é»˜è®¤éš”ç¦»çº§åˆ«ã€‚ </li><li><code>SERIALIZABLE</code> ï¼šå¯ä¸²è¡ŒåŒ–ï¼Œç¡®ä¿äº‹åŠ¡å¯ä»¥ä»ä¸€ä¸ªè¡¨ä¸­è¯»å–ç›¸åŒçš„è¡Œã€‚åœ¨è¿™ä¸ªäº‹åŠ¡æŒç»­æœŸé—´ï¼Œç¦æ­¢ å…¶ä»–äº‹åŠ¡å¯¹è¯¥è¡¨æ‰§è¡Œæ’å…¥ã€æ›´æ–°å’Œåˆ é™¤æ“ä½œã€‚æ‰€æœ‰çš„å¹¶å‘é—®é¢˜éƒ½å¯ä»¥é¿å…ï¼Œä½†æ€§èƒ½ååˆ†ä½ä¸‹ã€‚èƒ½é¿ å…è„è¯»ã€ä¸å¯é‡å¤è¯»å’Œå¹»è¯»ã€‚</li></ul><p><code>SQLæ ‡å‡†</code> ä¸­è§„å®šï¼Œé’ˆå¯¹ä¸åŒçš„éš”ç¦»çº§åˆ«ï¼Œå¹¶å‘äº‹åŠ¡å¯ä»¥å‘ç”Ÿä¸åŒä¸¥é‡ç¨‹åº¦çš„é—®é¢˜ï¼Œå…·ä½“æƒ…å†µå¦‚ä¸‹ï¼š</p><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220708220917267.png" class=""> <p><code>è„å†™ </code>æ€ä¹ˆæ²¡æ¶‰åŠåˆ°ï¼Ÿå› ä¸ºè„å†™è¿™ä¸ªé—®é¢˜å¤ªä¸¥é‡äº†ï¼Œä¸è®ºæ˜¯å“ªç§éš”ç¦»çº§åˆ«ï¼Œéƒ½ä¸å…è®¸è„å†™çš„æƒ…å†µå‘ç”Ÿã€‚</p><p>ä¸åŒçš„éš”ç¦»çº§åˆ«æœ‰ä¸åŒçš„ç°è±¡ï¼Œå¹¶æœ‰ä¸åŒçš„é”å’Œå¹¶å‘æœºåˆ¶ï¼Œéš”ç¦»çº§åˆ«è¶Šé«˜ï¼Œæ•°æ®åº“çš„å¹¶å‘æ€§èƒ½å°±è¶Šå·®ï¼Œ4 ç§äº‹åŠ¡éš”ç¦»çº§åˆ«ä¸å¹¶å‘æ€§èƒ½çš„å…³ç³»å¦‚ä¸‹ï¼š</p><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220708220957108.png" class=""><h3 id="3-4-MySQLæ”¯æŒçš„å››ç§éš”ç¦»çº§åˆ«"><a href="#3-4-MySQLæ”¯æŒçš„å››ç§éš”ç¦»çº§åˆ«" class="headerlink" title="3.4 MySQLæ”¯æŒçš„å››ç§éš”ç¦»çº§åˆ«"></a>3.4 MySQLæ”¯æŒçš„å››ç§éš”ç¦»çº§åˆ«</h3><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220708221639979.png" class=""><p>MySQLçš„é»˜è®¤éš”ç¦»çº§åˆ«ä¸ºREPEATABLE READï¼Œæˆ‘ä»¬å¯ä»¥æ‰‹åŠ¨ä¿®æ”¹ä¸€ä¸‹äº‹åŠ¡çš„éš”ç¦»çº§åˆ«ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"># æŸ¥çœ‹éš”ç¦»çº§åˆ«ï¼ŒMySQL 5.7.20çš„ç‰ˆæœ¬ä¹‹å‰ï¼š</span><br><span class="line">mysql&gt; SHOW VARIABLES LIKE &#x27;tx_isolation&#x27;;</span><br><span class="line">+---------------+-----------------+</span><br><span class="line">| Variable_name | Value           |</span><br><span class="line">+---------------+-----------------+</span><br><span class="line">| tx_isolation  | REPEATABLE-READ |</span><br><span class="line">+---------------+-----------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"># MySQL 5.7.20ç‰ˆæœ¬ä¹‹åï¼Œå¼•å…¥transaction_isolationæ¥æ›¿æ¢tx_isolation</span><br><span class="line"></span><br><span class="line"># æŸ¥çœ‹éš”ç¦»çº§åˆ«ï¼ŒMySQL 5.7.20çš„ç‰ˆæœ¬åŠä¹‹åï¼š</span><br><span class="line">mysql&gt; SHOW VARIABLES LIKE &#x27;transaction_isolation&#x27;;</span><br><span class="line">+-----------------------+-----------------+</span><br><span class="line">| Variable_name         | Value           |</span><br><span class="line">+-----------------------+-----------------+</span><br><span class="line">| transaction_isolation | REPEATABLE-READ |</span><br><span class="line">+-----------------------+-----------------+</span><br><span class="line">1 row in set (0.02 sec)</span><br><span class="line"></span><br><span class="line">#æˆ–è€…ä¸åŒMySQLç‰ˆæœ¬ä¸­éƒ½å¯ä»¥ä½¿ç”¨çš„ï¼š</span><br><span class="line">SELECT @@transaction_isolation;</span><br></pre></td></tr></table></figure><h3 id="3-5-å¦‚ä½•è®¾ç½®äº‹åŠ¡çš„éš”ç¦»çº§åˆ«"><a href="#3-5-å¦‚ä½•è®¾ç½®äº‹åŠ¡çš„éš”ç¦»çº§åˆ«" class="headerlink" title="3.5 å¦‚ä½•è®¾ç½®äº‹åŠ¡çš„éš”ç¦»çº§åˆ«"></a>3.5 å¦‚ä½•è®¾ç½®äº‹åŠ¡çš„éš”ç¦»çº§åˆ«</h3><p><strong>é€šè¿‡ä¸‹é¢çš„è¯­å¥ä¿®æ”¹äº‹åŠ¡çš„éš”ç¦»çº§åˆ«ï¼š</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SET [GLOBAL|SESSION] TRANSACTION ISOLATION LEVEL éš”ç¦»çº§åˆ«;</span><br><span class="line">#å…¶ä¸­ï¼Œéš”ç¦»çº§åˆ«æ ¼å¼ï¼š</span><br><span class="line">&gt; READ UNCOMMITTED</span><br><span class="line">&gt; READ COMMITTED</span><br><span class="line">&gt; REPEATABLE READ</span><br><span class="line">&gt; SERIALIZABLE</span><br></pre></td></tr></table></figure><p>æˆ–è€…ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SET [GLOBAL|SESSION] TRANSACTION_ISOLATION = &#x27;éš”ç¦»çº§åˆ«&#x27;</span><br><span class="line">#å…¶ä¸­ï¼Œéš”ç¦»çº§åˆ«æ ¼å¼ï¼š</span><br><span class="line">&gt; READ-UNCOMMITTED</span><br><span class="line">&gt; READ-COMMITTED</span><br><span class="line">&gt; REPEATABLE-READ</span><br><span class="line">&gt; SERIALIZABLE</span><br></pre></td></tr></table></figure><p><strong>å…³äºè®¾ç½®æ—¶ä½¿ç”¨GLOBALæˆ–SESSIONçš„å½±å“ï¼š</strong></p><ul><li><p>ä½¿ç”¨ GLOBAL å…³é”®å­—ï¼ˆåœ¨å…¨å±€èŒƒå›´å½±å“ï¼‰ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SET GLOBAL TRANSACTION ISOLATION LEVEL SERIALIZABLE;</span><br><span class="line">#æˆ–</span><br><span class="line">SET GLOBAL TRANSACTION_ISOLATION = &#x27;SERIALIZABLE&#x27;;</span><br></pre></td></tr></table></figure><p>åˆ™ï¼š</p><ul><li>å½“å‰å·²ç»å­˜åœ¨çš„ä¼šè¯æ— æ•ˆ</li><li>åªå¯¹æ‰§è¡Œå®Œè¯¥è¯­å¥ä¹‹åäº§ç”Ÿçš„ä¼šè¯èµ·ä½œç”¨</li></ul></li><li><p>ä½¿ç”¨ <code>SESSION</code> å…³é”®å­—ï¼ˆåœ¨ä¼šè¯èŒƒå›´å½±å“ï¼‰ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SET SESSION TRANSACTION ISOLATION LEVEL SERIALIZABLE;</span><br><span class="line">#æˆ–</span><br><span class="line">SET SESSION TRANSACTION_ISOLATION = &#x27;SERIALIZABLE&#x27;;</span><br></pre></td></tr></table></figure><p>åˆ™ï¼š</p><ul><li>å¯¹å½“å‰ä¼šè¯çš„æ‰€æœ‰åç»­çš„äº‹åŠ¡æœ‰æ•ˆ</li><li>å¦‚æœåœ¨äº‹åŠ¡ä¹‹é—´æ‰§è¡Œï¼Œåˆ™å¯¹åç»­çš„äº‹åŠ¡æœ‰æ•ˆ</li><li>è¯¥è¯­å¥å¯ä»¥åœ¨å·²ç»å¼€å¯çš„äº‹åŠ¡ä¸­é—´æ‰§è¡Œï¼Œä½†ä¸ä¼šå½±å“å½“å‰æ­£åœ¨æ‰§è¡Œçš„äº‹åŠ¡</li></ul></li></ul><p>å¦‚æœåœ¨æœåŠ¡å™¨å¯åŠ¨æ—¶æƒ³æ”¹å˜äº‹åŠ¡çš„é»˜è®¤éš”ç¦»çº§åˆ«ï¼Œå¯ä»¥ä¿®æ”¹å¯åŠ¨å‚æ•°<code>transaction_isolation</code>çš„å€¼ã€‚æ¯”å¦‚ï¼Œåœ¨å¯åŠ¨æœåŠ¡å™¨æ—¶æŒ‡å®šäº†<code>transaction_isolation=SERIALIZABLE</code>ï¼Œé‚£ä¹ˆäº‹åŠ¡çš„é»˜è®¤éš”ç¦»ç•Œåˆ«å°±ä»åŸæ¥çš„<code>REPEATABLE-READ</code>å˜æˆäº†<code>SERIALIZABLE</code>ã€‚</p><blockquote><p>å°ç»“ï¼š </p><p>æ•°æ®åº“è§„å®šäº†å¤šç§äº‹åŠ¡éš”ç¦»çº§åˆ«ï¼Œä¸åŒéš”ç¦»çº§åˆ«å¯¹åº”ä¸åŒçš„å¹²æ‰°ç¨‹åº¦ï¼Œéš”ç¦»çº§åˆ«è¶Šé«˜ï¼Œæ•°æ®ä¸€è‡´æ€§å°±è¶Šå¥½ï¼Œä½†å¹¶å‘æ€§è¶Šå¼±ã€‚</p></blockquote><h3 id="3-6-ä¸åŒéš”ç¦»çº§åˆ«ä¸¾ä¾‹"><a href="#3-6-ä¸åŒéš”ç¦»çº§åˆ«ä¸¾ä¾‹" class="headerlink" title="3.6 ä¸åŒéš”ç¦»çº§åˆ«ä¸¾ä¾‹"></a>3.6 ä¸åŒéš”ç¦»çº§åˆ«ä¸¾ä¾‹</h3><p>åˆå§‹åŒ–æ•°æ®ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">TRUNCATE TABLE account;</span><br><span class="line">INSERT INTO account VALUES (1,&#x27;å¼ ä¸‰&#x27;,&#x27;100&#x27;), (2,&#x27;æå››&#x27;,&#x27;0&#x27;);</span><br></pre></td></tr></table></figure><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220708223250773.png" class=""><p><strong>æ¼”ç¤º1. è¯»æœªæäº¤ä¹‹è„è¯»</strong></p><p>è®¾ç½®éš”ç¦»çº§åˆ«ä¸ºæœªæäº¤è¯»ï¼š</p><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220710193920008.png" class=""> <p>è„è¯»å°±æ˜¯æŒ‡å½“å‰äº‹åŠ¡å°±åœ¨è®¿é—®æ•°æ®ï¼Œå¹¶ä¸”å¯¹æ•°æ®è¿›è¡Œäº†ä¿®æ”¹ï¼Œè€Œè¿™ç§ä¿®æ”¹è¿˜æ²¡æœ‰æäº¤åˆ°æ•°æ®åº“ä¸­ï¼Œè¿™æ—¶ï¼Œå¦å¤–ä¸€ä¸ªäº‹åŠ¡ä¹Ÿè®¿é—®äº†è¿™ä¸ªæ•°æ®ï¼Œç„¶åä½¿ç”¨äº†è¿™ä¸ªæ•°æ®ã€‚</p><p><strong>æ¼”ç¤º2ï¼šè¯»å·²æäº¤</strong></p><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220710194440101.png" class=""> <p><strong>æ¼”ç¤º3. ä¸å¯é‡å¤è¯»</strong></p><p>è®¾ç½®éš”ç¦»çº§åˆ«ä¸ºå¯é‡å¤è¯»ï¼Œäº‹åŠ¡çš„æ‰§è¡Œæµç¨‹å¦‚ä¸‹ï¼š</p><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220710194144826.png" class=""> <p>å½“æˆ‘ä»¬å°†å½“å‰ä¼šè¯çš„éš”ç¦»çº§åˆ«è®¾ç½®ä¸ºå¯é‡å¤è¯»çš„æ—¶å€™ï¼Œå½“å‰ä¼šè¯å¯ä»¥é‡å¤è¯»ï¼Œå°±æ˜¯æ¯æ¬¡è¯»å–çš„ç»“æœé›†éƒ½ç›¸åŒï¼Œè€Œä¸ç®¡å…¶ä»–äº‹åŠ¡æœ‰æ²¡æœ‰æäº¤ã€‚ä½†æ˜¯åœ¨å¯é‡å¤è¯»çš„éš”ç¦»çº§åˆ«ä¸Šä¼šå‡ºç°å¹»è¯»çš„é—®é¢˜ã€‚</p><p><strong>æ¼”ç¤º4ï¼šå¹»è¯»</strong></p><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220710194042096.png" class=""> <img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220710194612317.png" class=""><h2 id="4-äº‹åŠ¡çš„å¸¸è§åˆ†ç±»"><a href="#4-äº‹åŠ¡çš„å¸¸è§åˆ†ç±»" class="headerlink" title="4. äº‹åŠ¡çš„å¸¸è§åˆ†ç±»"></a>4. äº‹åŠ¡çš„å¸¸è§åˆ†ç±»</h2><p>ä»äº‹åŠ¡ç†è®ºçš„è§’åº¦æ¥çœ‹ï¼Œå¯ä»¥æŠŠäº‹åŠ¡åˆ†ä¸ºä»¥ä¸‹å‡ ç§ç±»å‹ï¼š</p><ul><li>æ‰å¹³äº‹åŠ¡ï¼ˆFlat Transactionsï¼‰ </li><li>å¸¦æœ‰ä¿å­˜ç‚¹çš„æ‰å¹³äº‹åŠ¡ï¼ˆFlat Transactions with Savepointsï¼‰ </li><li>é“¾äº‹åŠ¡ï¼ˆChained Transactionsï¼‰ </li><li>åµŒå¥—äº‹åŠ¡ï¼ˆNested Transactionsï¼‰ </li><li>åˆ†å¸ƒå¼äº‹åŠ¡ï¼ˆDistributed Transactionsï¼‰</li></ul><h1 id="ç¬¬14ç« -MySQLäº‹åŠ¡æ—¥å¿—"><a href="#ç¬¬14ç« -MySQLäº‹åŠ¡æ—¥å¿—" class="headerlink" title="ç¬¬14ç« _MySQLäº‹åŠ¡æ—¥å¿—"></a>ç¬¬14ç« _MySQLäº‹åŠ¡æ—¥å¿—</h1><p>äº‹åŠ¡æœ‰4ç§ç‰¹æ€§ï¼šåŸå­æ€§ã€ä¸€è‡´æ€§ã€éš”ç¦»æ€§å’ŒæŒä¹…æ€§ã€‚é‚£ä¹ˆäº‹åŠ¡çš„å››ç§ç‰¹æ€§åˆ°åº•æ˜¯åŸºäºä»€ä¹ˆæœºåˆ¶å®ç°å‘¢ï¼Ÿ</p><ul><li>äº‹åŠ¡çš„éš”ç¦»æ€§ç”± <code>é”æœºåˆ¶</code> å®ç°ã€‚</li><li>è€Œäº‹åŠ¡çš„åŸå­æ€§ã€ä¸€è‡´æ€§å’ŒæŒä¹…æ€§ç”±äº‹åŠ¡çš„ redo æ—¥å¿—å’Œundo æ—¥å¿—æ¥ä¿è¯ã€‚<ul><li>REDO LOG ç§°ä¸º <code>é‡åšæ—¥å¿— </code>ï¼Œæä¾›å†å†™å…¥æ“ä½œï¼Œæ¢å¤æäº¤äº‹åŠ¡ä¿®æ”¹çš„é¡µæ“ä½œï¼Œç”¨æ¥ä¿è¯äº‹åŠ¡çš„æŒä¹…æ€§ã€‚</li><li>UNDO LOG ç§°ä¸º <code>å›æ»šæ—¥å¿—</code> ï¼Œå›æ»šè¡Œè®°å½•åˆ°æŸä¸ªç‰¹å®šç‰ˆæœ¬ï¼Œç”¨æ¥ä¿è¯äº‹åŠ¡çš„åŸå­æ€§ã€ä¸€è‡´æ€§ã€‚</li></ul></li></ul><p>æœ‰çš„DBAæˆ–è®¸ä¼šè®¤ä¸º UNDO æ˜¯ REDO çš„é€†è¿‡ç¨‹ï¼Œå…¶å®ä¸ç„¶ã€‚REDO å’Œ UNDOéƒ½å¯ä»¥è§†ä¸ºæ˜¯ä¸€ç§ <code>æ¢å¤æ“ä½œ</code>ï¼Œä½†æ˜¯ï¼š</p><ul><li>redo log: æ˜¯å­˜å‚¨å¼•æ“å±‚ (innodb) ç”Ÿæˆçš„æ—¥å¿—ï¼Œè®°å½•çš„æ˜¯<code>&quot;ç‰©ç†çº§åˆ«&quot;</code>ä¸Šçš„é¡µä¿®æ”¹æ“ä½œï¼Œæ¯”å¦‚é¡µå·xxxï¼Œåç§»é‡yyyå†™å…¥äº†â€™zzzâ€™æ•°æ®ã€‚ä¸»è¦ä¸ºäº†ä¿è¯æ•°æ®çš„å¯é æ€§ã€‚</li><li>undo log: æ˜¯å­˜å‚¨å¼•æ“å±‚ (innodb) ç”Ÿæˆçš„æ—¥å¿—ï¼Œè®°å½•çš„æ˜¯ <code>é€»è¾‘æ“ä½œ</code> æ—¥å¿—ï¼Œæ¯”å¦‚å¯¹æŸä¸€è¡Œæ•°æ®è¿›è¡Œäº†INSERTè¯­å¥æ“ä½œï¼Œé‚£ä¹ˆundo logå°±è®°å½•ä¸€æ¡ä¸ä¹‹ç›¸åçš„DELETEæ“ä½œã€‚ä¸»è¦ç”¨äº <code>äº‹åŠ¡çš„å›æ»š</code> (undo log è®°å½•çš„æ˜¯æ¯ä¸ªä¿®æ”¹æ“ä½œçš„ <code>é€†æ“ä½œ</code>) å’Œ <code>ä¸€è‡´æ€§éé”å®šè¯»</code> (undo log å›æ»šè¡Œè®°å½•åˆ°æŸç§ç‰¹å®šçš„ç‰ˆæœ¬â€”â€”MVCCï¼Œå³å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶)ã€‚</li></ul><h2 id="1-redoæ—¥å¿—"><a href="#1-redoæ—¥å¿—" class="headerlink" title="1. redoæ—¥å¿—"></a>1. redoæ—¥å¿—</h2><p>InnoDBå­˜å‚¨å¼•æ“æ˜¯ä»¥<code>é¡µä¸ºå•ä½</code>æ¥ç®¡ç†å­˜å‚¨ç©ºé—´çš„ã€‚åœ¨çœŸæ­£è®¿é—®é¡µé¢ä¹‹å‰ï¼Œéœ€è¦æŠŠåœ¨<code>ç£ç›˜ä¸Š</code>çš„é¡µç¼“å­˜åˆ°å†…å­˜ä¸­çš„<code>Buffer Pool</code>ä¹‹åæ‰å¯ä»¥è®¿é—®ã€‚æ‰€æœ‰çš„å˜æ›´éƒ½å¿…é¡»<code>å…ˆæ›´æ–°ç¼“å†²æ± </code>ä¸­çš„æ•°æ®ï¼Œç„¶åç¼“å†²æ± ä¸­çš„<code>è„é¡µ</code>ä¼šä»¥ä¸€å®šçš„é¢‘ç‡è¢«åˆ·å…¥ç£ç›˜ (<code>checkPoint</code>æœºåˆ¶)ï¼Œé€šè¿‡ç¼“å†²æ± æ¥ä¼˜åŒ–CPUå’Œç£ç›˜ä¹‹é—´çš„é¸¿æ²Ÿï¼Œè¿™æ ·å°±å¯ä»¥ä¿è¯æ•´ä½“çš„æ€§èƒ½ä¸ä¼šä¸‹é™å¤ªå¿«ã€‚</p><h3 id="1-1-ä¸ºä»€ä¹ˆéœ€è¦REDOæ—¥å¿—"><a href="#1-1-ä¸ºä»€ä¹ˆéœ€è¦REDOæ—¥å¿—" class="headerlink" title="1.1 ä¸ºä»€ä¹ˆéœ€è¦REDOæ—¥å¿—"></a>1.1 ä¸ºä»€ä¹ˆéœ€è¦REDOæ—¥å¿—</h3><p>ä¸€æ–¹é¢ï¼Œç¼“å†²æ± å¯ä»¥å¸®åŠ©æˆ‘ä»¬æ¶ˆé™¤CPUå’Œç£ç›˜ä¹‹é—´çš„é¸¿æ²Ÿï¼Œcheckpointæœºåˆ¶å¯ä»¥ä¿è¯æ•°æ®çš„æœ€ç»ˆè½ç›˜ï¼Œç„¶ è€Œç”±äºcheckpoint <code>å¹¶ä¸æ˜¯æ¯æ¬¡å˜æ›´çš„æ—¶å€™å°±è§¦å‘</code> çš„ï¼Œè€Œæ˜¯masterçº¿ç¨‹éš”ä¸€æ®µæ—¶é—´å»å¤„ç†çš„ã€‚æ‰€ä»¥æœ€åçš„æƒ… å†µå°±æ˜¯äº‹åŠ¡æäº¤åï¼Œåˆšå†™å®Œç¼“å†²æ± ï¼Œæ•°æ®åº“å®•æœºäº†ï¼Œé‚£ä¹ˆè¿™æ®µæ•°æ®å°±æ˜¯ä¸¢å¤±çš„ï¼Œæ— æ³•æ¢å¤ã€‚</p><p>å¦ä¸€æ–¹é¢ï¼Œäº‹åŠ¡åŒ…å« <code>æŒä¹…æ€§</code> çš„ç‰¹æ€§ï¼Œå°±æ˜¯è¯´å¯¹äºä¸€ä¸ªå·²ç»æäº¤çš„äº‹åŠ¡ï¼Œåœ¨äº‹åŠ¡æäº¤åå³ä½¿ç³»ç»Ÿå‘ç”Ÿäº†å´©æºƒï¼Œè¿™ä¸ªäº‹åŠ¡å¯¹æ•°æ®åº“ä¸­æ‰€åšçš„æ›´æ”¹ä¹Ÿä¸èƒ½ä¸¢å¤±ã€‚</p><p>é‚£ä¹ˆå¦‚ä½•ä¿è¯è¿™ä¸ªæŒä¹…æ€§å‘¢ï¼Ÿ <code>ä¸€ä¸ªç®€å•çš„åšæ³•</code> ï¼šåœ¨äº‹åŠ¡æäº¤å®Œæˆä¹‹å‰æŠŠè¯¥äº‹åŠ¡æ‰€ä¿®æ”¹çš„æ‰€æœ‰é¡µé¢éƒ½åˆ·æ–° åˆ°ç£ç›˜ï¼Œä½†æ˜¯è¿™ä¸ªç®€å•ç²—æš´çš„åšæ³•æœ‰äº›é—®é¢˜:</p><ul><li><p><strong>ä¿®æ”¹é‡ä¸åˆ·æ–°ç£ç›˜å·¥ä½œé‡ä¸¥é‡ä¸æˆæ¯”ä¾‹</strong></p><p>æœ‰æ—¶å€™æˆ‘ä»¬ä»…ä»…ä¿®æ”¹äº†æŸä¸ªé¡µé¢ä¸­çš„ä¸€ä¸ªå­—èŠ‚ï¼Œä½†æ˜¯æˆ‘ä»¬çŸ¥é“åœ¨InnoDBä¸­æ˜¯ä»¥é¡µä¸ºå•ä½æ¥è¿›è¡Œç£ç›˜IOçš„ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬åœ¨è¯¥äº‹åŠ¡æäº¤æ—¶ä¸å¾—ä¸å°†ä¸€ä¸ªå®Œæ•´çš„é¡µé¢ä»å†…å­˜ä¸­åˆ·æ–°åˆ°ç£ç›˜ï¼Œæˆ‘ä»¬åˆçŸ¥é“ä¸€ä¸ªé»˜è®¤é¡µé¢æ—¶16KBå¤§å°ï¼Œåªä¿®æ”¹ä¸€ä¸ªå­—èŠ‚å°±è¦åˆ·æ–°16KBçš„æ•°æ®åˆ°ç£ç›˜ä¸Šæ˜¾ç„¶æ˜¯å°é¢˜å¤§åšäº†ã€‚</p></li><li><p><strong>éšæœºIOåˆ·æ–°è¾ƒæ…¢</strong></p><p>ä¸€ä¸ªäº‹åŠ¡å¯èƒ½åŒ…å«å¾ˆå¤šè¯­å¥ï¼Œå³ä½¿æ˜¯ä¸€æ¡è¯­å¥ä¹Ÿå¯èƒ½ä¿®æ”¹è®¸å¤šé¡µé¢ï¼Œå‡å¦‚è¯¥äº‹åŠ¡ä¿®æ”¹çš„è¿™äº›é¡µé¢å¯èƒ½å¹¶ä¸ç›¸é‚»ï¼Œè¿™å°±æ„å‘³ç€åœ¨å°†æŸä¸ªäº‹åŠ¡ä¿®æ”¹çš„Buffer Poolä¸­çš„é¡µé¢<code>åˆ·æ–°åˆ°ç£ç›˜</code>æ—¶ï¼Œéœ€è¦è¿›è¡Œå¾ˆå¤šçš„<code>éšæœºIO</code>ï¼ŒéšæœºIOæ¯”é¡ºåºIOè¦æ…¢ï¼Œå°¤å…¶å¯¹äºä¼ ç»Ÿçš„æœºæ¢°ç¡¬ç›˜æ¥è¯´ã€‚</p></li></ul><p><code>å¦ä¸€ä¸ªè§£å†³çš„æ€è·¯</code> ï¼šæˆ‘ä»¬åªæ˜¯æƒ³è®©å·²ç»æäº¤äº†çš„äº‹åŠ¡å¯¹æ•°æ®åº“ä¸­æ•°æ®æ‰€åšçš„ä¿®æ”¹æ°¸ä¹…ç”Ÿæ•ˆï¼Œå³ä½¿åæ¥ç³» ç»Ÿå´©æºƒï¼Œåœ¨é‡å¯åä¹Ÿèƒ½æŠŠè¿™ç§ä¿®æ”¹æ¢å¤å‡ºæ¥ã€‚æ‰€ä»¥æˆ‘ä»¬å…¶å®æ²¡æœ‰å¿…è¦åœ¨æ¯æ¬¡äº‹åŠ¡æäº¤æ—¶å°±æŠŠè¯¥äº‹åŠ¡åœ¨å†… å­˜ä¸­ä¿®æ”¹è¿‡çš„å…¨éƒ¨é¡µé¢åˆ·æ–°åˆ°ç£ç›˜ï¼Œåªéœ€è¦æŠŠ ä¿®æ”¹ äº†å“ªäº›ä¸œè¥¿ è®°å½•ä¸€ä¸‹ å°±å¥½ã€‚æ¯”å¦‚ï¼ŒæŸä¸ªäº‹åŠ¡å°†ç³»ç»Ÿ è¡¨ç©ºé—´ä¸­ ç¬¬10å· é¡µé¢ä¸­åç§»é‡ä¸º 100 å¤„çš„é‚£ä¸ªå­—èŠ‚çš„å€¼ 1 æ”¹æˆ 2 ã€‚æˆ‘ä»¬åªéœ€è¦è®°å½•ä¸€ä¸‹ï¼šå°†ç¬¬0å·è¡¨ ç©ºé—´çš„10å·é¡µé¢çš„åç§»é‡ä¸º100å¤„çš„å€¼æ›´æ–°ä¸º 2 </p><p>InnoDBå¼•æ“çš„äº‹åŠ¡é‡‡ç”¨äº†WALæŠ€æœ¯ (<code>Write-Ahead Logging</code>)ï¼Œè¿™ç§æŠ€æœ¯çš„æ€æƒ³å°±æ˜¯å…ˆå†™æ—¥å¿—ï¼Œå†å†™ç£ç›˜ï¼Œåªæœ‰æ—¥å¿—å†™å…¥æˆåŠŸï¼Œæ‰ç®—äº‹åŠ¡æäº¤æˆåŠŸï¼Œè¿™é‡Œçš„æ—¥å¿—å°±æ˜¯redo logã€‚å½“å‘ç”Ÿå®•æœºä¸”æ•°æ®æœªåˆ·åˆ°ç£ç›˜çš„æ—¶å€™ï¼Œå¯ä»¥é€šè¿‡redo logæ¥æ¢å¤ï¼Œä¿è¯ACIDä¸­çš„Dï¼Œè¿™å°±æ˜¯redo logçš„ä½œç”¨ã€‚</p><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220710202517977.png" class=""> <h3 id="1-2-REDOæ—¥å¿—çš„å¥½å¤„ã€ç‰¹ç‚¹"><a href="#1-2-REDOæ—¥å¿—çš„å¥½å¤„ã€ç‰¹ç‚¹" class="headerlink" title="1.2 REDOæ—¥å¿—çš„å¥½å¤„ã€ç‰¹ç‚¹"></a>1.2 REDOæ—¥å¿—çš„å¥½å¤„ã€ç‰¹ç‚¹</h3><h4 id="1-å¥½å¤„"><a href="#1-å¥½å¤„" class="headerlink" title="1. å¥½å¤„"></a>1. å¥½å¤„</h4><ul><li>redoæ—¥å¿—é™ä½äº†åˆ·ç›˜é¢‘ç‡ </li><li>redoæ—¥å¿—å ç”¨çš„ç©ºé—´éå¸¸å°</li></ul><p>å­˜å‚¨è¡¨ç©ºé—´IDã€é¡µå·ã€åç§»é‡ä»¥åŠéœ€è¦æ›´æ–°çš„å€¼ï¼Œæ‰€éœ€çš„å­˜å‚¨ç©ºé—´æ˜¯å¾ˆå°çš„ï¼Œåˆ·ç›˜å¿«ã€‚</p><h4 id="2-ç‰¹ç‚¹"><a href="#2-ç‰¹ç‚¹" class="headerlink" title="2. ç‰¹ç‚¹"></a>2. ç‰¹ç‚¹</h4><ul><li><p><strong>redoæ—¥å¿—æ˜¯é¡ºåºå†™å…¥ç£ç›˜çš„</strong></p><p>åœ¨æ‰§è¡Œäº‹åŠ¡çš„è¿‡ç¨‹ä¸­ï¼Œæ¯æ‰§è¡Œä¸€æ¡è¯­å¥ï¼Œå°±å¯èƒ½äº§ç”Ÿè‹¥å¹²æ¡redoæ—¥å¿—ï¼Œè¿™äº›æ—¥å¿—æ˜¯æŒ‰ç…§<code>äº§ç”Ÿçš„é¡ºåºå†™å…¥ç£ç›˜çš„</code>ï¼Œä¹Ÿå°±æ˜¯ä½¿ç”¨é¡ºåºIDï¼Œæ•ˆç‡æ¯”éšæœºIOå¿«ã€‚</p></li><li><p><strong>äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œredo logä¸æ–­è®°å½•</strong></p><p>redo logè·Ÿbin logçš„åŒºåˆ«ï¼Œredo logæ˜¯<code>å­˜å‚¨å¼•æ“å±‚</code>äº§ç”Ÿçš„ï¼Œè€Œbin logæ˜¯<code>æ•°æ®åº“å±‚</code>äº§ç”Ÿçš„ã€‚å‡è®¾ä¸€ä¸ªäº‹åŠ¡ï¼Œå¯¹è¡¨åš10ä¸‡è¡Œçš„è®°å½•æ’å…¥ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œä¸€ç›´ä¸æ–­çš„å¾€redo logé¡ºåºè®°å½•ï¼Œè€Œbin logä¸ä¼šè®°å½•ï¼Œç›´åˆ°è¿™ä¸ªäº‹åŠ¡æäº¤ï¼Œæ‰ä¼šä¸€æ¬¡å†™å…¥åˆ°bin logæ–‡ä»¶ä¸­ã€‚</p></li></ul><h3 id="1-3-redoçš„ç»„æˆ"><a href="#1-3-redoçš„ç»„æˆ" class="headerlink" title="1.3 redoçš„ç»„æˆ"></a>1.3 redoçš„ç»„æˆ</h3><p>Redo logå¯ä»¥ç®€å•åˆ†ä¸ºä»¥ä¸‹ä¸¤ä¸ªéƒ¨åˆ†ï¼š</p><ul><li><code>é‡åšæ—¥å¿—çš„ç¼“å†² (redo log buffer)</code> ï¼Œä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œæ˜¯æ˜“å¤±çš„ã€‚</li></ul><p>åœ¨æœåŠ¡å™¨å¯åŠ¨æ—¶å°±ä¼šå‘æ“ä½œç³»ç»Ÿç”³è¯·äº†ä¸€å¤§ç‰‡ç§°ä¹‹ä¸º redo log buffer çš„ <code>è¿ç»­å†…å­˜</code> ç©ºé—´ï¼Œç¿»è¯‘æˆä¸­æ–‡å°±æ˜¯redoæ—¥å¿—ç¼“å†²åŒºã€‚è¿™ç‰‡å†…å­˜ç©ºé—´è¢«åˆ’åˆ†ä¸ºè‹¥å¹²ä¸ªè¿ç»­çš„<code>redo log block</code>ã€‚ä¸€ä¸ªredo log blockå ç”¨<code>512å­—èŠ‚</code>å¤§å°ã€‚</p><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220710204114543.png" class=""> <p><strong>å‚æ•°è®¾ç½®ï¼šinnodb_log_buffer_sizeï¼š</strong></p><p>redo log buffer å¤§å°ï¼Œé»˜è®¤ <code>16M</code> ï¼Œæœ€å¤§å€¼æ˜¯4096Mï¼Œæœ€å°å€¼ä¸º1Mã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like &#x27;%innodb_log_buffer_size%&#x27;;</span><br><span class="line">+------------------------+----------+</span><br><span class="line">| Variable_name          | Value    |</span><br><span class="line">+------------------------+----------+</span><br><span class="line">| innodb_log_buffer_size | 16777216 |</span><br><span class="line">+------------------------+----------+</span><br></pre></td></tr></table></figure><ul><li><code>é‡åšæ—¥å¿—æ–‡ä»¶ (redo log file) </code>ï¼Œä¿å­˜åœ¨ç¡¬ç›˜ä¸­ï¼Œæ˜¯æŒä¹…çš„ã€‚</li></ul><p>REDOæ—¥å¿—æ–‡ä»¶å¦‚å›¾æ‰€ç¤ºï¼Œå…¶ä¸­<code>ib_logfile0</code>å’Œ<code>ib_logfile1</code>å³ä¸ºREDOæ—¥å¿—ã€‚</p><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220710204427616.png" class=""> <h3 id="1-4-redoçš„æ•´ä½“æµç¨‹"><a href="#1-4-redoçš„æ•´ä½“æµç¨‹" class="headerlink" title="1.4 redoçš„æ•´ä½“æµç¨‹"></a>1.4 redoçš„æ•´ä½“æµç¨‹</h3><p>ä»¥ä¸€ä¸ªæ›´æ–°äº‹åŠ¡ä¸ºä¾‹ï¼Œredo log æµè½¬è¿‡ç¨‹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220710204810264-16574572910841.png" class=""> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ç¬¬1æ­¥ï¼šå…ˆå°†åŸå§‹æ•°æ®ä»ç£ç›˜ä¸­è¯»å…¥å†…å­˜ä¸­æ¥ï¼Œä¿®æ”¹æ•°æ®çš„å†…å­˜æ‹·è´</span><br><span class="line">ç¬¬2æ­¥ï¼šç”Ÿæˆä¸€æ¡é‡åšæ—¥å¿—å¹¶å†™å…¥redo log bufferï¼Œè®°å½•çš„æ˜¯æ•°æ®è¢«ä¿®æ”¹åçš„å€¼</span><br><span class="line">ç¬¬3æ­¥ï¼šå½“äº‹åŠ¡commitæ—¶ï¼Œå°†redo log bufferä¸­çš„å†…å®¹åˆ·æ–°åˆ° redo log fileï¼Œå¯¹ redo log fileé‡‡ç”¨è¿½åŠ å†™çš„æ–¹å¼</span><br><span class="line">ç¬¬4æ­¥ï¼šå®šæœŸå°†å†…å­˜ä¸­ä¿®æ”¹çš„æ•°æ®åˆ·æ–°åˆ°ç£ç›˜ä¸­</span><br></pre></td></tr></table></figure><blockquote><p>ä½“ä¼šï¼š Write-Ahead Log(é¢„å…ˆæ—¥å¿—æŒä¹…åŒ–)ï¼šåœ¨æŒä¹…åŒ–ä¸€ä¸ªæ•°æ®é¡µä¹‹å‰ï¼Œå…ˆå°†å†…å­˜ä¸­ç›¸åº”çš„æ—¥å¿—é¡µæŒä¹…åŒ–ã€‚</p></blockquote><h3 id="1-5-redo-logçš„åˆ·ç›˜ç­–ç•¥"><a href="#1-5-redo-logçš„åˆ·ç›˜ç­–ç•¥" class="headerlink" title="1.5 redo logçš„åˆ·ç›˜ç­–ç•¥"></a>1.5 redo logçš„åˆ·ç›˜ç­–ç•¥</h3><p>redo logçš„å†™å…¥å¹¶ä¸æ˜¯ç›´æ¥å†™å…¥ç£ç›˜çš„ï¼ŒInnoDBå¼•æ“ä¼šåœ¨å†™redo logçš„æ—¶å€™å…ˆå†™redo log bufferï¼Œä¹‹åä»¥<code>ä¸€ å®šçš„é¢‘ç‡</code>åˆ·å…¥åˆ°çœŸæ­£çš„redo log file ä¸­ã€‚è¿™é‡Œçš„ä¸€å®šé¢‘ç‡æ€ä¹ˆçœ‹å¾…å‘¢ï¼Ÿè¿™å°±æ˜¯æˆ‘ä»¬è¦è¯´çš„åˆ·ç›˜ç­–ç•¥ã€‚</p><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220710205015302.png" class=""> <p>æ³¨æ„ï¼Œredo log bufferåˆ·ç›˜åˆ°redo log fileçš„è¿‡ç¨‹å¹¶ä¸æ˜¯çœŸæ­£çš„åˆ·åˆ°ç£ç›˜ä¸­å»ï¼Œåªæ˜¯åˆ·å…¥åˆ° <code>æ–‡ä»¶ç³»ç»Ÿç¼“å­˜ ï¼ˆpage cacheï¼‰</code>ä¸­å»ï¼ˆè¿™æ˜¯ç°ä»£æ“ä½œç³»ç»Ÿä¸ºäº†æé«˜æ–‡ä»¶å†™å…¥æ•ˆç‡åšçš„ä¸€ä¸ªä¼˜åŒ–ï¼‰ï¼ŒçœŸæ­£çš„å†™å…¥ä¼šäº¤ç»™ç³»ç»Ÿè‡ªå·±æ¥å†³å®šï¼ˆæ¯”å¦‚page cacheè¶³å¤Ÿå¤§äº†ï¼‰ã€‚é‚£ä¹ˆå¯¹äºInnoDBæ¥è¯´å°±å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œå¦‚æœäº¤ç»™ç³»ç»Ÿæ¥åŒ æ­¥ï¼ŒåŒæ ·å¦‚æœç³»ç»Ÿå®•æœºï¼Œé‚£ä¹ˆæ•°æ®ä¹Ÿä¸¢å¤±äº†ï¼ˆè™½ç„¶æ•´ä¸ªç³»ç»Ÿå®•æœºçš„æ¦‚ç‡è¿˜æ˜¯æ¯”è¾ƒå°çš„ï¼‰ã€‚</p><p>é’ˆå¯¹è¿™ç§æƒ…å†µï¼ŒInnoDBç»™å‡º <code>innodb_flush_log_at_trx_commit</code> å‚æ•°ï¼Œè¯¥å‚æ•°æ§åˆ¶ commitæäº¤äº‹åŠ¡ æ—¶ï¼Œå¦‚ä½•å°† redo log buffer ä¸­çš„æ—¥å¿—åˆ·æ–°åˆ° redo log file ä¸­ã€‚å®ƒæ”¯æŒä¸‰ç§ç­–ç•¥ï¼š</p><ul><li><code>è®¾ç½®ä¸º0</code> ï¼šè¡¨ç¤ºæ¯æ¬¡äº‹åŠ¡æäº¤æ—¶ä¸è¿›è¡Œåˆ·ç›˜æ“ä½œã€‚ï¼ˆç³»ç»Ÿé»˜è®¤master threadæ¯éš”1sè¿›è¡Œä¸€æ¬¡é‡åšæ—¥ å¿—çš„åŒæ­¥ï¼‰ ç¬¬1æ­¥ï¼šå…ˆå°†åŸå§‹æ•°æ®ä»ç£ç›˜ä¸­è¯»å…¥å†…å­˜ä¸­æ¥ï¼Œä¿®æ”¹æ•°æ®çš„å†…å­˜æ‹·è´ ç¬¬2æ­¥ï¼šç”Ÿæˆä¸€æ¡é‡åšæ—¥å¿—å¹¶å†™å…¥redo log bufferï¼Œè®°å½•çš„æ˜¯æ•°æ®è¢«ä¿®æ”¹åçš„å€¼ ç¬¬3æ­¥ï¼šå½“äº‹åŠ¡commitæ—¶ï¼Œå°†redo log bufferä¸­çš„å†…å®¹åˆ·æ–°åˆ° redo log fileï¼Œå¯¹ redo log fileé‡‡ç”¨è¿½åŠ  å†™çš„æ–¹å¼ ç¬¬4æ­¥ï¼šå®šæœŸå°†å†…å­˜ä¸­ä¿®æ”¹çš„æ•°æ®åˆ·æ–°åˆ°ç£ç›˜ä¸­ </li><li><code>è®¾ç½®ä¸º1</code> ï¼šè¡¨ç¤ºæ¯æ¬¡äº‹åŠ¡æäº¤æ—¶éƒ½å°†è¿›è¡ŒåŒæ­¥ï¼Œåˆ·ç›˜æ“ä½œï¼ˆ é»˜è®¤å€¼ ï¼‰ </li><li><code>è®¾ç½®ä¸º2</code> ï¼šè¡¨ç¤ºæ¯æ¬¡äº‹åŠ¡æäº¤æ—¶éƒ½åªæŠŠ redo log buffer å†…å®¹å†™å…¥ page cacheï¼Œä¸è¿›è¡ŒåŒæ­¥ã€‚ç”±osè‡ª å·±å†³å®šä»€ä¹ˆæ—¶å€™åŒæ­¥åˆ°ç£ç›˜æ–‡ä»¶ã€‚</li></ul><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220710205948156.png" class=""><p>å¦å¤–ï¼ŒInnoDBå­˜å‚¨å¼•æ“æœ‰ä¸€ä¸ªåå°çº¿ç¨‹ï¼Œæ¯éš”<code>1ç§’</code>ï¼Œå°±ä¼šæŠŠ<code>redo log buffer</code>ä¸­çš„å†…å®¹å†™åˆ°æ–‡ä»¶ç³»ç»Ÿç¼“å­˜(<code>page cache</code>)ï¼Œç„¶åè°ƒç”¨åˆ·ç›˜æ“ä½œã€‚</p><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220710210339724.png" class=""> <p>ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€ä¸ªæ²¡æœ‰æäº¤äº‹åŠ¡çš„<code>redo log</code>è®°å½•ï¼Œä¹Ÿå¯èƒ½ä¼šåˆ·ç›˜ã€‚å› ä¸ºåœ¨äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ redo log è®°å½•æ˜¯ä¼šå†™å…¥ <code>redo log buffer</code>ä¸­ï¼Œè¿™äº›redo log è®°å½•ä¼šè¢«<code>åå°çº¿ç¨‹</code>åˆ·ç›˜ã€‚</p><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220710210532805.png" class=""> <p>é™¤äº†åå°çº¿ç¨‹æ¯ç§’<code>1æ¬¡</code>çš„è½®è¯¢æ“ä½œï¼Œè¿˜æœ‰ä¸€ç§æƒ…å†µï¼Œå½“<code>redo log buffer</code>å ç”¨çš„ç©ºé—´å³å°†è¾¾åˆ°<code>innodb_log_buffer_size</code>ï¼ˆè¿™ä¸ªå‚æ•°é»˜è®¤æ˜¯16Mï¼‰çš„ä¸€åŠçš„æ—¶å€™ï¼Œåå°çº¿ç¨‹ä¼šä¸»åŠ¨åˆ·ç›˜ã€‚</p><h3 id="1-6-ä¸åŒåˆ·ç›˜ç­–ç•¥æ¼”ç¤º"><a href="#1-6-ä¸åŒåˆ·ç›˜ç­–ç•¥æ¼”ç¤º" class="headerlink" title="1.6 ä¸åŒåˆ·ç›˜ç­–ç•¥æ¼”ç¤º"></a>1.6 ä¸åŒåˆ·ç›˜ç­–ç•¥æ¼”ç¤º</h3><h4 id="1-æµç¨‹å›¾"><a href="#1-æµç¨‹å›¾" class="headerlink" title="1. æµç¨‹å›¾"></a>1. æµç¨‹å›¾</h4><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220710210751414.png" class=""><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220710211318120.png" class=""><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220710211335379.png" class=""><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220710211618789.png" class=""><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220710211831675.png" class=""><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220710212041563.png" class=""><h4 id="2-ä¸¾ä¾‹"><a href="#2-ä¸¾ä¾‹" class="headerlink" title="2. ä¸¾ä¾‹"></a>2. ä¸¾ä¾‹</h4><p>æ¯”è¾ƒinnodb_flush_log_at_trx_commitå¯¹äº‹åŠ¡çš„å½±å“ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE test_load(</span><br><span class="line">a INT,</span><br><span class="line">b CHAR(80)</span><br><span class="line">)ENGINE=INNODB;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER//</span><br><span class="line">CREATE PROCEDURE p_load(COUNT INT UNSIGNED)</span><br><span class="line">BEGIN</span><br><span class="line">DECLARE s INT UNSIGNED DEFAULT 1;</span><br><span class="line">DECLARE c CHAR(80) DEFAULT REPEAT(&#x27;a&#x27;,80);</span><br><span class="line">WHILE s&lt;=COUNT DO</span><br><span class="line">INSERT INTO test_load SELECT NULL, c;</span><br><span class="line">COMMIT;</span><br><span class="line">SET s=s+1;</span><br><span class="line">END WHILE;</span><br><span class="line">END //</span><br><span class="line">DELIMITER;</span><br></pre></td></tr></table></figure><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220710215001482.png" class=""><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; CALL p_load(30000);</span><br><span class="line">Query OK, 0 rows affected(1 min 23 sec)</span><br></pre></td></tr></table></figure><p><code>1 min 23 sec</code>çš„æ—¶é—´æ˜¾ç„¶æ˜¯ä¸èƒ½æ¥å—çš„ã€‚è€Œé€ æˆæ—¶é—´æ¯”è¾ƒé•¿çš„åŸå› å°±åœ¨äºfsyncæ“ä½œæ‰€éœ€è¦çš„æ—¶é—´ã€‚</p><p>ä¿®æ”¹å‚æ•°innodb_flush_log_at_trx_commitï¼Œè®¾ç½®ä¸º0ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; set global innodb_flush_log_at_trx_commit = 0;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; CALL p_load(30000);</span><br><span class="line">Query OK, 0 rows affected(38 sec)</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹å‚æ•°innodb_flush_log_at_trx_commitï¼Œè®¾ç½®ä¸º2ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; set global innodb_flush_log_at_trx_commit = 2;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; CALL p_load(30000);</span><br><span class="line">Query OK, 0 rows affected(46 sec)</span><br></pre></td></tr></table></figure><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220710215353893.png" class=""><h3 id="1-7-å†™å…¥redo-log-buffer-è¿‡ç¨‹"><a href="#1-7-å†™å…¥redo-log-buffer-è¿‡ç¨‹" class="headerlink" title="1.7 å†™å…¥redo log buffer è¿‡ç¨‹"></a>1.7 å†™å…¥redo log buffer è¿‡ç¨‹</h3><h4 id="1-è¡¥å……æ¦‚å¿µï¼šMini-Transaction"><a href="#1-è¡¥å……æ¦‚å¿µï¼šMini-Transaction" class="headerlink" title="1. è¡¥å……æ¦‚å¿µï¼šMini-Transaction"></a>1. è¡¥å……æ¦‚å¿µï¼šMini-Transaction</h4><p>MySQLæŠŠå¯¹åº•å±‚é¡µé¢ä¸­çš„ä¸€æ¬¡åŸå­è®¿é—®è¿‡ç¨‹ç§°ä¹‹ä¸ºä¸€ä¸ª<code>Mini-Transaction</code>ï¼Œç®€ç§°<code>mtr</code>ï¼Œæ¯”å¦‚ï¼Œå‘æŸä¸ªç´¢å¼•å¯¹åº”çš„B+æ ‘ä¸­æ’å…¥ä¸€æ¡è®°å½•çš„è¿‡ç¨‹å°±æ˜¯ä¸€ä¸ª<code>Mini-Transaction</code>ã€‚ä¸€ä¸ªæ‰€è°“çš„<code>mtr</code>å¯ä»¥åŒ…å«ä¸€ç»„redoæ—¥å¿—ï¼Œåœ¨è¿›è¡Œå´©æºƒæ¢å¤æ—¶è¿™ä¸€ç»„<code>redo</code>æ—¥å¿—å¯ä»¥ä½œä¸ºä¸€ä¸ªä¸å¯åˆ†å‰²çš„æ•´ä½“ã€‚</p><p>ä¸€ä¸ªäº‹åŠ¡å¯ä»¥åŒ…å«è‹¥å¹²æ¡è¯­å¥ï¼Œæ¯ä¸€æ¡è¯­å¥å…¶å®æ˜¯ç”±è‹¥å¹²ä¸ª <code>mtr</code> ç»„æˆï¼Œæ¯ä¸€ä¸ª <code>mtr</code> åˆå¯ä»¥åŒ…å«è‹¥å¹²æ¡ redoæ—¥å¿—ï¼Œç”»ä¸ªå›¾è¡¨ç¤ºå®ƒä»¬çš„å…³ç³»å°±æ˜¯è¿™æ ·ï¼š</p><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220710220653131.png" class=""> <h4 id="2-redo-æ—¥å¿—å†™å…¥log-buffer"><a href="#2-redo-æ—¥å¿—å†™å…¥log-buffer" class="headerlink" title="2. redo æ—¥å¿—å†™å…¥log buffer"></a>2. redo æ—¥å¿—å†™å…¥log buffer</h4><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220710220838744.png" class=""><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220710220919271.png" class=""> <img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220710221221981.png" class=""><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220710221318271.png" class=""> <p>ä¸åŒçš„äº‹åŠ¡å¯èƒ½æ˜¯ <code>å¹¶å‘</code> æ‰§è¡Œçš„ï¼Œæ‰€ä»¥ T1 ã€ T2 ä¹‹é—´çš„ mtr å¯èƒ½æ˜¯ <code>äº¤æ›¿æ‰§è¡Œ</code> çš„ã€‚æ²¡å½“ä¸€ä¸ªmtræ‰§è¡Œå®Œæˆæ—¶ï¼Œä¼´éšè¯¥mtrç”Ÿæˆçš„ä¸€ç»„redoæ—¥å¿—å°±éœ€è¦è¢«å¤åˆ¶åˆ°log bufferä¸­ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸åŒäº‹åŠ¡çš„mtrå¯èƒ½æ˜¯äº¤æ›¿å†™å…¥log bufferçš„ï¼Œæˆ‘ä»¬ç”»ä¸ªç¤ºæ„å›¾ï¼ˆä¸ºäº†ç¾è§‚ï¼Œæˆ‘ä»¬æŠŠä¸€ä¸ªmträ¸­äº§ç”Ÿçš„æ‰€æœ‰redoæ—¥å¿—å½“åšä¸€ä¸ªæ•´ä½“æ¥ç”»ï¼‰ï¼š</p><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220710221620291.png" class=""> <p>æœ‰çš„mträº§ç”Ÿçš„redoæ—¥å¿—é‡éå¸¸å¤§ï¼Œæ¯”å¦‚<code>mtr_t1_2</code>äº§ç”Ÿçš„redoæ—¥å¿—å ç”¨ç©ºé—´æ¯”è¾ƒå¤§ï¼Œå ç”¨äº†3ä¸ªblockæ¥å­˜å‚¨ã€‚</p><h4 id="3-redo-log-blockçš„ç»“æ„å›¾"><a href="#3-redo-log-blockçš„ç»“æ„å›¾" class="headerlink" title="3. redo log blockçš„ç»“æ„å›¾"></a>3. redo log blockçš„ç»“æ„å›¾</h4><p>ä¸€ä¸ªredo log blockæ˜¯ç”±<code>æ—¥å¿—å¤´ã€æ—¥å¿—ä½“ã€æ—¥å¿—å°¾</code>ç»„æˆã€‚æ—¥å¿—å¤´å ç”¨12å­—èŠ‚ï¼Œæ—¥å¿—å°¾å ç”¨8å­—èŠ‚ï¼Œæ‰€ä»¥ä¸€ä¸ªblockçœŸæ­£èƒ½å­˜å‚¨çš„æ•°æ®æ˜¯512-12-8&#x3D;492å­—èŠ‚ã€‚</p><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220710223117420.png" class=""><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220710223135374.png" class=""> <p>çœŸæ­£çš„redoæ—¥å¿—éƒ½æ˜¯å­˜å‚¨åˆ°å ç”¨<code>496</code>å­—èŠ‚å¤§å°çš„<code>log block body</code>ä¸­ï¼Œå›¾ä¸­çš„<code>log block header</code>å’Œ<code>log block trailer</code>å­˜å‚¨çš„æ˜¯ä¸€äº›ç®¡ç†ä¿¡æ¯ã€‚æˆ‘ä»¬æ¥çœ‹çœ‹è¿™äº›æ‰€è°“<code>ç®¡ç†ä¿¡æ¯</code>éƒ½æœ‰ä»€ä¹ˆã€‚</p><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220711144546439.png" class=""> <img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220711144608223.png" class=""><h3 id="1-8-redo-log-file"><a href="#1-8-redo-log-file" class="headerlink" title="1.8 redo log file"></a>1.8 redo log file</h3><h4 id="1-ç›¸å…³å‚æ•°è®¾ç½®"><a href="#1-ç›¸å…³å‚æ•°è®¾ç½®" class="headerlink" title="1. ç›¸å…³å‚æ•°è®¾ç½®"></a>1. ç›¸å…³å‚æ•°è®¾ç½®</h4><ul><li><p><code>innodb_log_group_home_dir</code> ï¼šæŒ‡å®š redo log æ–‡ä»¶ç»„æ‰€åœ¨çš„è·¯å¾„ï¼Œé»˜è®¤å€¼ä¸º <code>./</code> ï¼Œè¡¨ç¤ºåœ¨æ•°æ®åº“ çš„æ•°æ®ç›®å½•ä¸‹ã€‚MySQLçš„é»˜è®¤æ•°æ®ç›®å½•ï¼ˆ <code>var/lib/mysql</code>ï¼‰ä¸‹é»˜è®¤æœ‰ä¸¤ä¸ªåä¸º <code>ib_logfile0</code> å’Œ <code>ib_logfile1</code> çš„æ–‡ä»¶ï¼Œlog bufferä¸­çš„æ—¥å¿—é»˜è®¤æƒ…å†µä¸‹å°±æ˜¯åˆ·æ–°åˆ°è¿™ä¸¤ä¸ªç£ç›˜æ–‡ä»¶ä¸­ã€‚æ­¤redoæ—¥å¿— æ–‡ä»¶ä½ç½®è¿˜å¯ä»¥ä¿®æ”¹ã€‚</p></li><li><p><code>innodb_log_files_in_group</code>ï¼šæŒ‡æ˜redo log fileçš„ä¸ªæ•°ï¼Œå‘½åæ–¹å¼å¦‚ï¼šib_logfile0ï¼Œiblogfile1â€¦ iblogfilenã€‚é»˜è®¤2ä¸ªï¼Œæœ€å¤§100ä¸ªã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like &#x27;innodb_log_files_in_group&#x27;;</span><br><span class="line">+---------------------------+-------+</span><br><span class="line">| Variable_name             | Value |</span><br><span class="line">+---------------------------+-------+</span><br><span class="line">| innodb_log_files_in_group | 2     |</span><br><span class="line">+---------------------------+-------+</span><br><span class="line">#ib_logfile0</span><br><span class="line">#ib_logfile1</span><br></pre></td></tr></table></figure></li><li><p><code>innodb_flush_log_at_trx_commit</code>ï¼šæ§åˆ¶ redo log åˆ·æ–°åˆ°ç£ç›˜çš„ç­–ç•¥ï¼Œé»˜è®¤ä¸º1ã€‚</p></li><li><p><code>innodb_log_file_size</code>ï¼šå•ä¸ª redo log æ–‡ä»¶è®¾ç½®å¤§å°ï¼Œé»˜è®¤å€¼ä¸º <code>48M</code> ã€‚æœ€å¤§å€¼ä¸º512Gï¼Œæ³¨æ„æœ€å¤§å€¼ æŒ‡çš„æ˜¯æ•´ä¸ª redo log ç³»åˆ—æ–‡ä»¶ä¹‹å’Œï¼Œå³ï¼ˆinnodb_log_files_in_group * innodb_log_file_size ï¼‰ä¸èƒ½å¤§ äºæœ€å¤§å€¼512Gã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like &#x27;innodb_log_file_size&#x27;;</span><br><span class="line">+----------------------+----------+</span><br><span class="line">| Variable_name        | Value    |</span><br><span class="line">+----------------------+----------+</span><br><span class="line">| innodb_log_file_size | 50331648 |</span><br><span class="line">+----------------------+----------+</span><br></pre></td></tr></table></figure></li></ul><p>æ ¹æ®ä¸šåŠ¡ä¿®æ”¹å…¶å¤§å°ï¼Œä»¥ä¾¿å®¹çº³è¾ƒå¤§çš„äº‹åŠ¡ã€‚ç¼–è¾‘my.cnfæ–‡ä»¶å¹¶é‡å¯æ•°æ®åº“ç”Ÿæ•ˆï¼Œå¦‚ä¸‹æ‰€ç¤º</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# vim /etc/my.cnf</span><br><span class="line">innodb_log_file_size=200M</span><br></pre></td></tr></table></figure><blockquote><p>åœ¨æ•°æ®åº“å®ä¾‹æ›´æ–°æ¯”è¾ƒé¢‘ç¹çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥é€‚å½“åŠ å¤§ redo log æ•°ç»„å’Œå¤§å°ã€‚ä½†ä¹Ÿä¸æ¨è redo log è®¾ç½®è¿‡å¤§ï¼Œåœ¨MySQLå´©æºƒæ—¶ä¼šé‡æ–°æ‰§è¡ŒREDOæ—¥å¿—ä¸­çš„è®°å½•ã€‚</p></blockquote><h4 id="2-æ—¥å¿—æ–‡ä»¶ç»„"><a href="#2-æ—¥å¿—æ–‡ä»¶ç»„" class="headerlink" title="2. æ—¥å¿—æ–‡ä»¶ç»„"></a>2. æ—¥å¿—æ–‡ä»¶ç»„</h4><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220711152137012.png" class=""><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220711152242300.png" class=""> <p>æ€»å…±çš„redoæ—¥å¿—æ–‡ä»¶å¤§å°å…¶å®å°±æ˜¯ï¼š <code>innodb_log_file_size Ã— innodb_log_files_in_group</code> ã€‚</p><p>é‡‡ç”¨å¾ªç¯ä½¿ç”¨çš„æ–¹å¼å‘redoæ—¥å¿—æ–‡ä»¶ç»„é‡Œå†™æ•°æ®çš„è¯ï¼Œä¼šå¯¼è‡´åå†™å…¥çš„redoæ—¥å¿—è¦†ç›–æ‰å‰è¾¹å†™çš„redoæ—¥å¿—ï¼Ÿå½“ç„¶ï¼æ‰€ä»¥InnoDBçš„è®¾è®¡è€…æå‡ºäº†checkpointçš„æ¦‚å¿µã€‚</p><h4 id="3-checkpoint"><a href="#3-checkpoint" class="headerlink" title="3. checkpoint"></a>3. checkpoint</h4><p>åœ¨æ•´ä¸ªæ—¥å¿—æ–‡ä»¶ç»„ä¸­è¿˜æœ‰ä¸¤ä¸ªé‡è¦çš„å±æ€§ï¼Œåˆ†åˆ«æ˜¯ write posã€checkpoint</p><ul><li><code>write pos</code>æ˜¯å½“å‰è®°å½•çš„ä½ç½®ï¼Œä¸€è¾¹å†™ä¸€è¾¹åç§»</li><li><code>checkpoint</code>æ˜¯å½“å‰è¦æ“¦é™¤çš„ä½ç½®ï¼Œä¹Ÿæ˜¯å¾€åæ¨ç§»</li></ul><p>æ¯æ¬¡åˆ·ç›˜ redo log è®°å½•åˆ°æ—¥å¿—æ–‡ä»¶ç»„ä¸­ï¼Œwrite pos ä½ç½®å°±ä¼šåç§»æ›´æ–°ã€‚æ¯æ¬¡MySQLåŠ è½½æ—¥å¿—æ–‡ä»¶ç»„æ¢å¤æ•°æ®æ—¶ï¼Œä¼šæ¸…ç©ºåŠ è½½è¿‡çš„ redo log è®°å½•ï¼Œå¹¶æŠŠcheck pointåç§»æ›´æ–°ã€‚write pos å’Œ checkpoint ä¹‹é—´çš„è¿˜ç©ºç€çš„éƒ¨åˆ†å¯ä»¥ç”¨æ¥å†™å…¥æ–°çš„ redo log è®°å½•ã€‚</p><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220711152631108.png" class=""><p>å¦‚æœ write pos è¿½ä¸Š checkpoint ï¼Œè¡¨ç¤º<code>æ—¥å¿—æ–‡ä»¶ç»„</code>æ»¡äº†ï¼Œè¿™æ—¶å€™ä¸èƒ½å†å†™å…¥æ–°çš„ redo logè®°å½•ï¼ŒMySQL å¾— åœä¸‹æ¥ï¼Œæ¸…ç©ºä¸€äº›è®°å½•ï¼ŒæŠŠ checkpoint æ¨è¿›ä¸€ä¸‹ã€‚</p><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220711152802294.png" class=""><h3 id="1-9-redo-log-å°ç»“"><a href="#1-9-redo-log-å°ç»“" class="headerlink" title="1.9 redo log å°ç»“"></a>1.9 redo log å°ç»“</h3><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220711152930911.png" class=""><h2 id="2-Undoæ—¥å¿—"><a href="#2-Undoæ—¥å¿—" class="headerlink" title="2. Undoæ—¥å¿—"></a>2. Undoæ—¥å¿—</h2><p>redo logæ˜¯äº‹åŠ¡æŒä¹…æ€§çš„ä¿è¯ï¼Œundo logæ˜¯äº‹åŠ¡åŸå­æ€§çš„ä¿è¯ã€‚åœ¨äº‹åŠ¡ä¸­ <code>æ›´æ–°æ•°æ®</code> çš„ <code>å‰ç½®æ“ä½œ</code> å…¶å®æ˜¯è¦å…ˆå†™å…¥ä¸€ä¸ª <code>undo log</code> ã€‚</p><h3 id="2-1-å¦‚ä½•ç†è§£Undoæ—¥å¿—"><a href="#2-1-å¦‚ä½•ç†è§£Undoæ—¥å¿—" class="headerlink" title="2.1 å¦‚ä½•ç†è§£Undoæ—¥å¿—"></a>2.1 å¦‚ä½•ç†è§£Undoæ—¥å¿—</h3><p>äº‹åŠ¡éœ€è¦ä¿è¯ <code>åŸå­æ€§ </code>ï¼Œä¹Ÿå°±æ˜¯äº‹åŠ¡ä¸­çš„æ“ä½œè¦ä¹ˆå…¨éƒ¨å®Œæˆï¼Œè¦ä¹ˆä»€ä¹ˆä¹Ÿä¸åšã€‚ä½†æœ‰æ—¶å€™äº‹åŠ¡æ‰§è¡Œåˆ°ä¸€åŠä¼šå‡ºç°ä¸€äº›æƒ…å†µï¼Œæ¯”å¦‚ï¼š</p><ul><li>æƒ…å†µä¸€ï¼šäº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­å¯èƒ½é‡åˆ°å„ç§é”™è¯¯ï¼Œæ¯”å¦‚<code> æœåŠ¡å™¨æœ¬èº«çš„é”™è¯¯</code> ï¼Œ <code>æ“ä½œç³»ç»Ÿé”™è¯¯</code> ï¼Œç”šè‡³æ˜¯çªç„¶ <code>æ–­ç”µ</code> å¯¼è‡´çš„é”™è¯¯ã€‚</li><li>æƒ…å†µäºŒï¼šç¨‹åºå‘˜å¯ä»¥åœ¨äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­æ‰‹åŠ¨è¾“å…¥ <code>ROLLBACK</code> è¯­å¥ç»“æŸå½“å‰äº‹åŠ¡çš„æ‰§è¡Œã€‚</li></ul><p>ä»¥ä¸Šæƒ…å†µå‡ºç°ï¼Œæˆ‘ä»¬éœ€è¦æŠŠæ•°æ®æ”¹å›åŸå…ˆçš„æ ·å­ï¼Œè¿™ä¸ªè¿‡ç¨‹ç§°ä¹‹ä¸º <code>å›æ»š</code> ï¼Œè¿™æ ·å°±å¯ä»¥é€ æˆä¸€ä¸ªå‡è±¡ï¼šè¿™ ä¸ªäº‹åŠ¡çœ‹èµ·æ¥ä»€ä¹ˆéƒ½æ²¡åšï¼Œæ‰€ä»¥ç¬¦åˆ <code>åŸå­æ€§</code> è¦æ±‚ã€‚</p><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220711153523704.png" class=""><h3 id="2-2-Undoæ—¥å¿—çš„ä½œç”¨"><a href="#2-2-Undoæ—¥å¿—çš„ä½œç”¨" class="headerlink" title="2.2 Undoæ—¥å¿—çš„ä½œç”¨"></a>2.2 Undoæ—¥å¿—çš„ä½œç”¨</h3><ul><li><strong>ä½œç”¨1ï¼šå›æ»šæ•°æ®</strong></li></ul><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220711153645204.png" class=""><ul><li><strong>ä½œç”¨2ï¼šMVCC</strong></li></ul><p>undoçš„å¦ä¸€ä¸ªä½œç”¨æ˜¯MVCCï¼Œå³åœ¨InnoDBå­˜å‚¨å¼•æ“ä¸­MVCCçš„å®ç°æ˜¯é€šè¿‡undoæ¥å®Œæˆã€‚å½“ç”¨æˆ·è¯»å–ä¸€è¡Œè®°å½•æ—¶ï¼Œè‹¥è¯¥è®°å½•ä»¥åŠè¢«å…¶ä»–äº‹åŠ¡å ç”¨ï¼Œå½“å‰äº‹åŠ¡å¯ä»¥é€šè¿‡undoè¯»å–ä¹‹å‰çš„è¡Œç‰ˆæœ¬ä¿¡æ¯ï¼Œä»¥æ­¤å®ç°éé”å®šè¯»å–ã€‚</p><h3 id="2-3-undoçš„å­˜å‚¨ç»“æ„"><a href="#2-3-undoçš„å­˜å‚¨ç»“æ„" class="headerlink" title="2.3 undoçš„å­˜å‚¨ç»“æ„"></a>2.3 undoçš„å­˜å‚¨ç»“æ„</h3><h4 id="1-å›æ»šæ®µä¸undoé¡µ"><a href="#1-å›æ»šæ®µä¸undoé¡µ" class="headerlink" title="1. å›æ»šæ®µä¸undoé¡µ"></a>1. å›æ»šæ®µä¸undoé¡µ</h4><p>InnoDBå¯¹undo logçš„ç®¡ç†é‡‡ç”¨æ®µçš„æ–¹å¼ï¼Œä¹Ÿå°±æ˜¯ <code>å›æ»šæ®µï¼ˆrollback segmentï¼‰</code> ã€‚æ¯ä¸ªå›æ»šæ®µè®°å½•äº† <code>1024</code> ä¸ª <code>undo log segment</code> ï¼Œè€Œåœ¨æ¯ä¸ªundo log segmentæ®µä¸­è¿›è¡Œ <code>undoé¡µ</code> çš„ç”³è¯·ã€‚</p><ul><li>åœ¨<code> InnoDB1.1ç‰ˆæœ¬ä¹‹å‰</code> ï¼ˆä¸åŒ…æ‹¬1.1ç‰ˆæœ¬ï¼‰ï¼Œåªæœ‰ä¸€ä¸ªrollback segmentï¼Œå› æ­¤æ”¯æŒåŒæ—¶åœ¨çº¿çš„äº‹åŠ¡é™åˆ¶ä¸º <code>1024</code> ã€‚è™½ç„¶å¯¹ç»å¤§å¤šæ•°çš„åº”ç”¨æ¥è¯´éƒ½å·²ç»å¤Ÿç”¨ã€‚ </li><li>ä»1.1ç‰ˆæœ¬å¼€å§‹InnoDBæ”¯æŒæœ€å¤§ <code>128ä¸ªrollback segment</code> ï¼Œæ•…å…¶æ”¯æŒåŒæ—¶åœ¨çº¿çš„äº‹åŠ¡é™åˆ¶æé«˜åˆ° äº† <code>128*1024</code> ã€‚</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like &#x27;innodb_undo_logs&#x27;;</span><br><span class="line">+------------------+-------+</span><br><span class="line">| Variable_name    | Value |</span><br><span class="line">+------------------+-------+</span><br><span class="line">| innodb_undo_logs | 128   |</span><br><span class="line">+------------------+-------+</span><br></pre></td></tr></table></figure><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220711154936382.png" class=""><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220711155044078.png" class=""><h4 id="2-å›æ»šæ®µä¸äº‹åŠ¡"><a href="#2-å›æ»šæ®µä¸äº‹åŠ¡" class="headerlink" title="2. å›æ»šæ®µä¸äº‹åŠ¡"></a>2. å›æ»šæ®µä¸äº‹åŠ¡</h4><ol><li><p>æ¯ä¸ªäº‹åŠ¡åªä¼šä½¿ç”¨ä¸€ä¸ªå›æ»šæ®µï¼Œä¸€ä¸ªå›æ»šæ®µåœ¨åŒä¸€æ—¶åˆ»å¯èƒ½ä¼šæœåŠ¡äºå¤šä¸ªäº‹åŠ¡ã€‚</p></li><li><p>å½“ä¸€ä¸ªäº‹åŠ¡å¼€å§‹çš„æ—¶å€™ï¼Œä¼šåˆ¶å®šä¸€ä¸ªå›æ»šæ®µï¼Œåœ¨äº‹åŠ¡è¿›è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œå½“æ•°æ®è¢«ä¿®æ”¹æ—¶ï¼ŒåŸå§‹çš„æ•° æ®ä¼šè¢«å¤åˆ¶åˆ°å›æ»šæ®µã€‚</p></li><li><p>åœ¨å›æ»šæ®µä¸­ï¼Œäº‹åŠ¡ä¼šä¸æ–­å¡«å……ç›˜åŒºï¼Œç›´åˆ°äº‹åŠ¡ç»“æŸæˆ–æ‰€æœ‰çš„ç©ºé—´è¢«ç”¨å®Œã€‚å¦‚æœå½“å‰çš„ç›˜åŒºä¸å¤Ÿ ç”¨ï¼Œäº‹åŠ¡ä¼šåœ¨æ®µä¸­è¯·æ±‚æ‰©å±•ä¸‹ä¸€ä¸ªç›˜åŒºï¼Œå¦‚æœæ‰€æœ‰å·²åˆ†é…çš„ç›˜åŒºéƒ½è¢«ç”¨å®Œï¼Œäº‹åŠ¡ä¼šè¦†ç›–æœ€åˆçš„ç›˜ åŒºæˆ–è€…åœ¨å›æ»šæ®µå…è®¸çš„æƒ…å†µä¸‹æ‰©å±•æ–°çš„ç›˜åŒºæ¥ä½¿ç”¨ã€‚</p></li><li><p>å›æ»šæ®µå­˜åœ¨äºundoè¡¨ç©ºé—´ä¸­ï¼Œåœ¨æ•°æ®åº“ä¸­å¯ä»¥å­˜åœ¨å¤šä¸ªundoè¡¨ç©ºé—´ï¼Œä½†åŒä¸€æ—¶åˆ»åªèƒ½ä½¿ç”¨ä¸€ä¸ª undoè¡¨ç©ºé—´ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like &#x27;innodb_undo_tablespaces&#x27;;</span><br><span class="line">+-------------------------+-------+</span><br><span class="line">| Variable_name           | Value |</span><br><span class="line">+-------------------------+-------+</span><br><span class="line">| innodb_undo_tablespaces | 2     |</span><br><span class="line">+-------------------------+-------+</span><br><span class="line"># undo logçš„æ•°é‡ï¼Œæœ€å°‘ä¸º2. undo logçš„truncateæ“ä½œæœ‰purgeåè°ƒçº¿ç¨‹å‘èµ·ã€‚åœ¨truncateæŸä¸ªundo logè¡¨ç©ºé—´çš„è¿‡ç¨‹ä¸­ï¼Œä¿è¯æœ‰ä¸€ä¸ªå¯ç”¨çš„undo logå¯ç”¨ã€‚</span><br></pre></td></tr></table></figure></li><li><p>å½“äº‹åŠ¡æäº¤æ—¶ï¼ŒInnoDBå­˜å‚¨å¼•æ“ä¼šåšä»¥ä¸‹ä¸¤ä»¶äº‹æƒ…ï¼š</p><ul><li>å°†undo logæ”¾å…¥åˆ—è¡¨ä¸­ï¼Œä»¥ä¾›ä¹‹åçš„purgeæ“ä½œ </li><li>åˆ¤æ–­undo logæ‰€åœ¨çš„é¡µæ˜¯å¦å¯ä»¥é‡ç”¨ï¼Œè‹¥å¯ä»¥åˆ†é…ç»™ä¸‹ä¸ªäº‹åŠ¡ä½¿ç”¨</li></ul></li></ol><h4 id="3-å›æ»šæ®µä¸­çš„æ•°æ®åˆ†ç±»"><a href="#3-å›æ»šæ®µä¸­çš„æ•°æ®åˆ†ç±»" class="headerlink" title="3. å›æ»šæ®µä¸­çš„æ•°æ®åˆ†ç±»"></a>3. å›æ»šæ®µä¸­çš„æ•°æ®åˆ†ç±»</h4><ol><li><code>æœªæäº¤çš„å›æ»šæ•°æ®(uncommitted undo information)</code>ï¼šè¯¥æ•°æ®æ‰€å…³è”çš„äº‹åŠ¡å¹¶æœªæäº¤ï¼Œç”¨äºå®ç°è¯»ä¸€è‡´æ€§ï¼Œæ‰€ä»¥è¯¥æ•°æ®ä¸èƒ½è¢«å…¶ä»–äº‹åŠ¡çš„æ•°æ®è¦†ç›–ã€‚</li><li><code>å·²ç»æäº¤ä½†æœªè¿‡æœŸçš„å›æ»šæ•°æ®(committed undo information)</code>ï¼šè¯¥æ•°æ®å…³è”çš„äº‹åŠ¡å·²ç»æäº¤ï¼Œä½†æ˜¯ä»å—åˆ°undo retentionå‚æ•°çš„ä¿æŒæ—¶é—´çš„å½±å“ã€‚</li><li><code>äº‹åŠ¡å·²ç»æäº¤å¹¶è¿‡æœŸçš„æ•°æ®(expired undo information)</code>ï¼šäº‹åŠ¡å·²ç»æäº¤ï¼Œè€Œä¸”æ•°æ®ä¿å­˜æ—¶é—´å·²ç»è¶…è¿‡ undo retentionå‚æ•°æŒ‡å®šçš„æ—¶é—´ï¼Œå±äºå·²ç»è¿‡æœŸçš„æ•°æ®ã€‚å½“å›æ»šæ®µæ»¡äº†ä¹‹åï¼Œå°±ä¼˜å…ˆè¦†ç›–â€œäº‹åŠ¡å·²ç»æäº¤å¹¶è¿‡æœŸçš„æ•°æ®â€ã€‚</li></ol><p>äº‹åŠ¡æäº¤åä¸èƒ½é©¬ä¸Šåˆ é™¤undo logåŠundo logæ‰€åœ¨çš„é¡µã€‚è¿™æ˜¯å› ä¸ºå¯èƒ½è¿˜æœ‰å…¶ä»–äº‹åŠ¡éœ€è¦é€šè¿‡undo logæ¥å¾—åˆ°è¡Œè®°å½•ä¹‹å‰çš„ç‰ˆæœ¬ã€‚æ•…äº‹åŠ¡æäº¤æ—¶å°†undo logæ”¾å…¥ä¸€ä¸ªé“¾è¡¨ä¸­ï¼Œæ˜¯å¦å¯ä»¥æœ€ç»ˆåˆ é™¤undo logä»¥undo logæ‰€åœ¨é¡µç”±purgeçº¿ç¨‹æ¥åˆ¤æ–­ã€‚</p><h3 id="2-4-undoçš„ç±»å‹"><a href="#2-4-undoçš„ç±»å‹" class="headerlink" title="2.4 undoçš„ç±»å‹"></a>2.4 undoçš„ç±»å‹</h3><p>åœ¨InnoDBå­˜å‚¨å¼•æ“ä¸­ï¼Œundo logåˆ†ä¸ºï¼š</p><ul><li><p>insert undo log</p><p>insert undo logæ˜¯æŒ‡insertæ“ä½œä¸­äº§ç”Ÿçš„undo logã€‚å› ä¸ºinsertæ“ä½œçš„è®°å½•ï¼Œåªå¯¹äº‹åŠ¡æœ¬èº«å¯è§ï¼Œå¯¹å…¶ä»–äº‹åŠ¡ä¸å¯è§ï¼ˆè¿™æ˜¯äº‹åŠ¡éš”ç¦»æ€§çš„è¦æ±‚ï¼‰ï¼Œæ•…è¯¥undo logå¯ä»¥åœ¨äº‹åŠ¡æäº¤åç›´æ¥åˆ é™¤ã€‚ä¸éœ€è¦è¿›è¡Œpurgeæ“ä½œã€‚</p></li><li><p>update undo log</p><p>update undo logè®°å½•çš„æ˜¯å¯¹deleteå’Œupdateæ“ä½œäº§ç”Ÿçš„undo logã€‚è¯¥undo logå¯èƒ½éœ€è¦æä¾›MVCCæœºåˆ¶ï¼Œå› æ­¤ä¸èƒ½åœ¨äº‹åŠ¡æäº¤æ—¶å°±è¿›è¡Œåˆ é™¤ã€‚æäº¤æ—¶æ”¾å…¥undo logé“¾è¡¨ï¼Œç­‰å¾…purgeçº¿ç¨‹è¿›è¡Œæœ€åçš„åˆ é™¤ã€‚</p></li></ul><h3 id="2-5-undo-logçš„ç”Ÿå‘½å‘¨æœŸ"><a href="#2-5-undo-logçš„ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="2.5 undo logçš„ç”Ÿå‘½å‘¨æœŸ"></a>2.5 undo logçš„ç”Ÿå‘½å‘¨æœŸ</h3><h4 id="1-ç®€è¦ç”Ÿæˆè¿‡ç¨‹"><a href="#1-ç®€è¦ç”Ÿæˆè¿‡ç¨‹" class="headerlink" title="1. ç®€è¦ç”Ÿæˆè¿‡ç¨‹"></a>1. ç®€è¦ç”Ÿæˆè¿‡ç¨‹</h4><p>ä»¥ä¸‹æ˜¯undo+redoäº‹åŠ¡çš„ç®€åŒ–è¿‡ç¨‹</p><p>å‡è®¾æœ‰ä¸¤ä¸ªæ•°å€¼ï¼Œåˆ†åˆ«ä¸ºA&#x3D;1å’ŒB&#x3D;2ï¼Œç„¶åå°†Aä¿®æ”¹ä¸º3ï¼ŒBä¿®æ”¹ä¸º4</p><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220711162414928.png" class=""><p><strong>åªæœ‰Buffer Poolçš„æµç¨‹ï¼š</strong></p><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220711162505008.png" class=""> <p><strong>æœ‰äº†Redo Logå’ŒUndo Logä¹‹åï¼š</strong></p><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220711162642305.png" class=""> <p>åœ¨æ›´æ–°Buffer Poolä¸­çš„æ•°æ®ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆå°†è¯¥æ•°æ®äº‹åŠ¡å¼€å§‹ä¹‹å‰çš„çŠ¶æ€å†™å…¥Undo Logä¸­ã€‚å‡è®¾æ›´æ–°åˆ°ä¸€åŠå‡ºé”™äº†ï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡Undo Logæ¥å›æ»šåˆ°äº‹åŠ¡å¼€å§‹å‰ã€‚</p><h4 id="2-è¯¦ç»†ç”Ÿæˆè¿‡ç¨‹"><a href="#2-è¯¦ç»†ç”Ÿæˆè¿‡ç¨‹" class="headerlink" title="2. è¯¦ç»†ç”Ÿæˆè¿‡ç¨‹"></a>2. è¯¦ç»†ç”Ÿæˆè¿‡ç¨‹</h4><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220711162919157.png" class=""><p><strong>å½“æˆ‘ä»¬æ‰§è¡ŒINSERTæ—¶ï¼š</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">begin;</span><br><span class="line">INSERT INTO user (name) VALUES (&quot;tom&quot;);</span><br></pre></td></tr></table></figure><p>æ’å…¥çš„æ•°æ®éƒ½ä¼šç”Ÿæˆä¸€æ¡insert undo logï¼Œå¹¶ä¸”æ•°æ®çš„å›æ»šæŒ‡é’ˆä¼šæŒ‡å‘å®ƒã€‚undo logä¼šè®°å½•undo logçš„åºå·ã€æ’å…¥ä¸»é”®çš„åˆ—å’Œå€¼â€¦ï¼Œé‚£ä¹ˆåœ¨è¿›è¡Œrollbackçš„æ—¶å€™ï¼Œé€šè¿‡ä¸»é”®ç›´æ¥æŠŠå¯¹åº”çš„æ•°æ®åˆ é™¤å³å¯ã€‚</p><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220711163725129.png" class=""> <p><strong>å½“æˆ‘ä»¬æ‰§è¡ŒUPDATEæ—¶ï¼š</strong></p><p>å¯¹åº”æ›´æ–°çš„æ“ä½œä¼šäº§ç”Ÿupdate undo logï¼Œå¹¶ä¸”ä¼šåˆ†æ›´æ–°ä¸»é”®å’Œä¸æ›´æ–°ä¸»é”®çš„ï¼Œå‡è®¾ç°åœ¨æ‰§è¡Œï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UPDATE user SET name=&quot;Sun&quot; WHERE id=1;</span><br></pre></td></tr></table></figure><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220711164138414.png" class=""> <p>è¿™æ—¶ä¼šæŠŠè€çš„è®°å½•å†™å…¥æ–°çš„undo logï¼Œè®©å›æ»šæŒ‡é’ˆæŒ‡å‘æ–°çš„undo logï¼Œå®ƒçš„undo noæ˜¯1ï¼Œå¹¶ä¸”æ–°çš„undo logä¼šæŒ‡å‘è€çš„undo logï¼ˆundo no&#x3D;0ï¼‰ã€‚</p><p>å‡è®¾ç°åœ¨æ‰§è¡Œï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UPDATE user SET id=2 WHERE id=1;</span><br></pre></td></tr></table></figure><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220711164421494.png" class=""> <p>å¯¹äºæ›´æ–°ä¸»é”®çš„æ“ä½œï¼Œä¼šå…ˆæŠŠåŸæ¥çš„æ•°æ®deletemarkæ ‡è¯†æ‰“å¼€ï¼Œè¿™æ—¶å¹¶æ²¡æœ‰çœŸæ­£çš„åˆ é™¤æ•°æ®ï¼ŒçœŸæ­£çš„åˆ é™¤ä¼šäº¤ç»™æ¸…ç†çº¿ç¨‹å»åˆ¤æ–­ï¼Œç„¶ååœ¨åé¢æ’å…¥ä¸€æ¡æ–°çš„æ•°æ®ï¼Œæ–°çš„æ•°æ®ä¹Ÿä¼šäº§ç”Ÿundo logï¼Œå¹¶ä¸”undo logçš„åºå·ä¼šé€’å¢ã€‚</p><p>å¯ä»¥å‘ç°æ¯æ¬¡å¯¹æ•°æ®çš„å˜æ›´éƒ½ä¼šäº§ç”Ÿä¸€ä¸ªundo logï¼Œå½“ä¸€æ¡è®°å½•è¢«å˜æ›´å¤šæ¬¡æ—¶ï¼Œé‚£ä¹ˆå°±ä¼šäº§ç”Ÿå¤šæ¡undo logï¼Œundo logè®°å½•çš„æ˜¯å˜æ›´å‰çš„æ—¥å¿—ï¼Œå¹¶ä¸”æ¯ä¸ªundo logçš„åºå·æ˜¯é€’å¢çš„ï¼Œé‚£ä¹ˆå½“è¦å›æ»šçš„æ—¶å€™ï¼ŒæŒ‰ç…§åºå·<code>ä¾æ¬¡å‘å‰æ¨</code>ï¼Œå°±å¯ä»¥æ‰¾åˆ°æˆ‘ä»¬çš„åŸå§‹æ•°æ®äº†ã€‚</p><h4 id="3-undo-logæ˜¯å¦‚ä½•å›æ»šçš„"><a href="#3-undo-logæ˜¯å¦‚ä½•å›æ»šçš„" class="headerlink" title="3. undo logæ˜¯å¦‚ä½•å›æ»šçš„"></a>3. undo logæ˜¯å¦‚ä½•å›æ»šçš„</h4><p>ä»¥ä¸Šé¢çš„ä¾‹å­æ¥è¯´ï¼Œå‡è®¾æ‰§è¡Œrollbackï¼Œé‚£ä¹ˆå¯¹åº”çš„æµç¨‹åº”è¯¥æ˜¯è¿™æ ·ï¼š</p><ol><li>é€šè¿‡undo no&#x3D;3çš„æ—¥å¿—æŠŠid&#x3D;2çš„æ•°æ®åˆ é™¤ </li><li>é€šè¿‡undo no&#x3D;2çš„æ—¥å¿—æŠŠid&#x3D;1çš„æ•°æ®çš„deletemarkè¿˜åŸæˆ0 </li><li>é€šè¿‡undo no&#x3D;1çš„æ—¥å¿—æŠŠid&#x3D;1çš„æ•°æ®çš„nameè¿˜åŸæˆTom </li><li>é€šè¿‡undo no&#x3D;0çš„æ—¥å¿—æŠŠid&#x3D;1çš„æ•°æ®åˆ é™¤</li></ol><h4 id="4-undo-logçš„åˆ é™¤"><a href="#4-undo-logçš„åˆ é™¤" class="headerlink" title="4. undo logçš„åˆ é™¤"></a>4. undo logçš„åˆ é™¤</h4><ul><li><p>é’ˆå¯¹äºinsert undo log</p><p>å› ä¸ºinsertæ“ä½œçš„è®°å½•ï¼Œåªå¯¹äº‹åŠ¡æœ¬èº«å¯è§ï¼Œå¯¹å…¶ä»–äº‹åŠ¡ä¸å¯è§ã€‚æ•…è¯¥undo logå¯ä»¥åœ¨äº‹åŠ¡æäº¤åç›´æ¥åˆ é™¤ï¼Œä¸éœ€è¦è¿›è¡Œpurgeæ“ä½œã€‚</p></li><li><p>é’ˆå¯¹äºupdate undo log</p><p>è¯¥undo logå¯èƒ½éœ€è¦æä¾›MVCCæœºåˆ¶ï¼Œå› æ­¤ä¸èƒ½åœ¨äº‹åŠ¡æäº¤æ—¶å°±è¿›è¡Œåˆ é™¤ã€‚æäº¤æ—¶æ”¾å…¥undo logé“¾è¡¨ï¼Œç­‰å¾…purgeçº¿ç¨‹è¿›è¡Œæœ€åçš„åˆ é™¤ã€‚</p></li></ul><blockquote><p>è¡¥å……ï¼š</p><p>purgeçº¿ç¨‹ä¸¤ä¸ªä¸»è¦ä½œç”¨æ˜¯ï¼š<code>æ¸…ç†undoé¡µ</code>å’Œ<code>æ¸…ç†pageé‡Œé¢å¸¦æœ‰Delete_Bitæ ‡è¯†çš„æ•°æ®è¡Œ</code>ã€‚åœ¨InnoDBä¸­ï¼Œäº‹åŠ¡ä¸­çš„Deleteæ“ä½œå®é™…ä¸Šå¹¶ä¸æ˜¯çœŸæ­£çš„åˆ é™¤æ‰æ•°æ®è¡Œï¼Œè€Œæ˜¯ä¸€ç§Delete Markæ“ä½œï¼Œåœ¨è®°å½•ä¸Šæ ‡è¯†Delete_Bitï¼Œè€Œä¸åˆ é™¤è®°å½•ã€‚æ˜¯ä¸€ç§â€œå‡åˆ é™¤â€ï¼Œåªæ˜¯åšäº†ä¸ªæ ‡è®°ï¼ŒçœŸæ­£çš„åˆ é™¤å·¥ä½œéœ€è¦åå°purgeçº¿ç¨‹å»å®Œæˆã€‚</p></blockquote><h3 id="2-6-å°ç»“"><a href="#2-6-å°ç»“" class="headerlink" title="2.6 å°ç»“"></a>2.6 å°ç»“</h3><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220711165612956.png" class=""> <p>undo logæ˜¯é€»è¾‘æ—¥å¿—ï¼Œå¯¹äº‹åŠ¡å›æ»šæ—¶ï¼Œåªæ˜¯å°†æ•°æ®åº“é€»è¾‘åœ°æ¢å¤åˆ°åŸæ¥çš„æ ·å­ã€‚</p><p>redo logæ˜¯ç‰©ç†æ—¥å¿—ï¼Œè®°å½•çš„æ˜¯æ•°æ®é¡µçš„ç‰©ç†å˜åŒ–ï¼Œundo logä¸æ˜¯redo logçš„é€†è¿‡ç¨‹ã€‚</p><h1 id="ç¬¬15ç« -é”"><a href="#ç¬¬15ç« -é”" class="headerlink" title="ç¬¬15ç« _é”"></a>ç¬¬15ç« _é”</h1><h2 id="1-æ¦‚è¿°"><a href="#1-æ¦‚è¿°" class="headerlink" title="1. æ¦‚è¿°"></a>1. æ¦‚è¿°</h2><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220711165954976.png" class=""><p>åœ¨æ•°æ®åº“ä¸­ï¼Œé™¤ä¼ ç»Ÿçš„è®¡ç®—èµ„æºï¼ˆå¦‚CPUã€RAMã€I&#x2F;Oç­‰ï¼‰çš„äº‰ç”¨ä»¥å¤–ï¼Œæ•°æ®ä¹Ÿæ˜¯ä¸€ç§ä¾›è®¸å¤šç”¨æˆ·å…±äº«çš„ èµ„æºã€‚ä¸ºä¿è¯æ•°æ®çš„ä¸€è‡´æ€§ï¼Œéœ€è¦å¯¹ <code>å¹¶å‘æ“ä½œè¿›è¡Œæ§åˆ¶</code> ï¼Œå› æ­¤äº§ç”Ÿäº† <code>é”</code> ã€‚åŒæ—¶ <code>é”æœºåˆ¶</code> ä¹Ÿä¸ºå®ç°MySQL çš„å„ä¸ªéš”ç¦»çº§åˆ«æä¾›äº†ä¿è¯ã€‚ <code>é”å†²çª</code> ä¹Ÿæ˜¯å½±å“æ•°æ®åº“ <code>å¹¶å‘è®¿é—®æ€§èƒ½</code> çš„ä¸€ä¸ªé‡è¦å› ç´ ã€‚æ‰€ä»¥é”å¯¹æ•°æ®åº“è€Œè¨€æ˜¾å¾—å°¤å…¶é‡è¦ï¼Œä¹Ÿæ›´åŠ å¤æ‚ã€‚</p><h2 id="2-MySQLå¹¶å‘äº‹åŠ¡è®¿é—®ç›¸åŒè®°å½•"><a href="#2-MySQLå¹¶å‘äº‹åŠ¡è®¿é—®ç›¸åŒè®°å½•" class="headerlink" title="2. MySQLå¹¶å‘äº‹åŠ¡è®¿é—®ç›¸åŒè®°å½•"></a>2. MySQLå¹¶å‘äº‹åŠ¡è®¿é—®ç›¸åŒè®°å½•</h2><p>å¹¶å‘äº‹åŠ¡è®¿é—®ç›¸åŒè®°å½•çš„æƒ…å†µå¤§è‡´å¯ä»¥åˆ’åˆ†ä¸º3ç§ï¼š</p><h3 id="2-1-è¯»-è¯»æƒ…å†µ"><a href="#2-1-è¯»-è¯»æƒ…å†µ" class="headerlink" title="2.1 è¯»-è¯»æƒ…å†µ"></a>2.1 è¯»-è¯»æƒ…å†µ</h3><p><code>è¯»-è¯»</code>æƒ…å†µï¼Œå³å¹¶å‘äº‹åŠ¡ç›¸ç»§<code>è¯»å–ç›¸åŒçš„è®°å½•</code>ã€‚è¯»å–æ“ä½œæœ¬èº«ä¸ä¼šå¯¹è®°å½•æœ‰ä»»ä½•å½±å“ï¼Œå¹¶ä¸ä¼šå¼•èµ·ä»€ä¹ˆé—®é¢˜ï¼Œæ‰€ä»¥å…è®¸è¿™ç§æƒ…å†µçš„å‘ç”Ÿã€‚</p><h3 id="2-2-å†™-å†™æƒ…å†µ"><a href="#2-2-å†™-å†™æƒ…å†µ" class="headerlink" title="2.2 å†™-å†™æƒ…å†µ"></a>2.2 å†™-å†™æƒ…å†µ</h3><p><code>å†™-å†™</code> æƒ…å†µï¼Œå³å¹¶å‘äº‹åŠ¡ç›¸ç»§å¯¹ç›¸åŒçš„è®°å½•åšå‡ºæ”¹åŠ¨ã€‚</p><p>åœ¨è¿™ç§æƒ…å†µä¸‹ä¼šå‘ç”Ÿ <code>è„å†™</code> çš„é—®é¢˜ï¼Œä»»ä½•ä¸€ç§éš”ç¦»çº§åˆ«éƒ½ä¸å…è®¸è¿™ç§é—®é¢˜çš„å‘ç”Ÿã€‚æ‰€ä»¥åœ¨å¤šä¸ªæœªæäº¤äº‹åŠ¡ç›¸ç»§å¯¹ä¸€æ¡è®°å½•åšæ”¹åŠ¨æ—¶ï¼Œéœ€è¦è®©å®ƒä»¬ <code>æ’é˜Ÿæ‰§è¡Œ</code> ï¼Œè¿™ä¸ªæ’é˜Ÿçš„è¿‡ç¨‹å…¶å®æ˜¯é€šè¿‡ <code>é”</code> æ¥å®ç°çš„ã€‚è¿™ä¸ªæ‰€è°“çš„é”å…¶å®æ˜¯ä¸€ä¸ªå†…å­˜ä¸­çš„ç»“æ„ ï¼Œåœ¨äº‹åŠ¡æ‰§è¡Œå‰æœ¬æ¥æ˜¯æ²¡æœ‰é”çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸€å¼€å§‹æ˜¯æ²¡æœ‰ é”ç»“æ„ å’Œè®°å½•è¿› è¡Œå…³è”çš„ï¼Œå¦‚å›¾æ‰€ç¤ºï¼š</p><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220711181120639.png" class=""> <p>å½“ä¸€ä¸ªäº‹åŠ¡æƒ³å¯¹è¿™æ¡è®°å½•åšæ”¹åŠ¨æ—¶ï¼Œé¦–å…ˆä¼šçœ‹çœ‹å†…å­˜ä¸­æœ‰æ²¡æœ‰ä¸è¿™æ¡è®°å½•å…³è”çš„ <code>é”ç»“æ„</code> ï¼Œå½“æ²¡æœ‰çš„æ—¶å€™ å°±ä¼šåœ¨å†…å­˜ä¸­ç”Ÿæˆä¸€ä¸ª <code>é”ç»“æ„</code> ä¸ä¹‹å…³è”ã€‚æ¯”å¦‚ï¼Œäº‹åŠ¡<code> T1</code> è¦å¯¹è¿™æ¡è®°å½•åšæ”¹åŠ¨ï¼Œå°±éœ€è¦ç”Ÿæˆä¸€ä¸ª <code>é”ç»“æ„</code> ä¸ä¹‹å…³è”ï¼š</p><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220711192633239.png" class=""> <p>åœ¨<code>é”ç»“æ„</code>é‡Œæœ‰å¾ˆå¤šä¿¡æ¯ï¼Œä¸ºäº†ç®€åŒ–ç†è§£ï¼ŒåªæŠŠä¸¤ä¸ªæ¯”è¾ƒé‡è¦çš„å±æ€§æ‹¿äº†å‡ºæ¥ï¼š</p><ul><li><code>trxä¿¡æ¯</code>ï¼šä»£è¡¨è¿™ä¸ªé”ç»“æ„æ˜¯å“ªä¸ªäº‹åŠ¡ç”Ÿæˆçš„ã€‚</li><li><code>is_waiting</code>ï¼šä»£è¡¨å½“å‰äº‹åŠ¡æ˜¯å¦åœ¨ç­‰å¾…ã€‚</li></ul><p>åœ¨äº‹åŠ¡<code>T1</code>æ”¹åŠ¨äº†è¿™æ¡è®°å½•åï¼Œå°±ç”Ÿæˆäº†ä¸€ä¸ª<code>é”ç»“æ„</code>ä¸è¯¥è®°å½•å…³è”ï¼Œå› ä¸ºä¹‹å‰æ²¡æœ‰åˆ«çš„äº‹åŠ¡ä¸ºè¿™æ¡è®°å½•åŠ é”ï¼Œæ‰€ä»¥<code>is_waiting</code>å±æ€§å°±æ˜¯<code>false</code>ï¼Œæˆ‘ä»¬æŠŠè¿™ä¸ªåœºæ™¯å°±ç§°å€¼ä¸º<code>è·å–é”æˆåŠŸ</code>ï¼Œæˆ–è€…<code>åŠ é”æˆåŠŸ</code>ï¼Œç„¶åå°±å¯ä»¥ç»§ç»­æ‰§è¡Œæ“ä½œäº†ã€‚</p><p>åœ¨äº‹åŠ¡<code>T1</code>æäº¤ä¹‹å‰ï¼Œå¦ä¸€ä¸ªäº‹åŠ¡<code>T2</code>ä¹Ÿæƒ³å¯¹è¯¥è®°å½•åšæ”¹åŠ¨ï¼Œé‚£ä¹ˆå…ˆçœ‹çœ‹æœ‰æ²¡æœ‰<code>é”ç»“æ„</code>ä¸è¿™æ¡è®°å½•å…³è”ï¼Œå‘ç°æœ‰ä¸€ä¸ª<code>é”ç»“æ„</code>ä¸ä¹‹å…³è”åï¼Œç„¶åä¹Ÿç”Ÿæˆäº†ä¸€ä¸ªé”ç»“æ„ä¸è¿™æ¡è®°å½•å…³è”ï¼Œä¸è¿‡é”ç»“æ„çš„<code>is_waiting</code>å±æ€§å€¼ä¸º<code>true</code>ï¼Œè¡¨ç¤ºå½“å‰äº‹åŠ¡éœ€è¦ç­‰å¾…ï¼Œæˆ‘ä»¬æŠŠè¿™ä¸ªåœºæ™¯å°±ç§°ä¹‹ä¸º<code>è·å–é”å¤±è´¥</code>ï¼Œæˆ–è€…<code>åŠ é”å¤±è´¥</code>ï¼Œå›¾ç¤ºï¼š</p><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220711193732567.png" class=""> <p>åœ¨äº‹åŠ¡T1æäº¤ä¹‹åï¼Œå°±ä¼šæŠŠè¯¥äº‹åŠ¡ç”Ÿæˆçš„<code>é”ç»“æ„é‡Šæ”¾</code>æ‰ï¼Œç„¶åçœ‹çœ‹è¿˜æœ‰æ²¡æœ‰åˆ«çš„äº‹åŠ¡åœ¨ç­‰å¾…è·å–é”ï¼Œå‘ç°äº†äº‹åŠ¡T2è¿˜åœ¨ç­‰å¾…è·å–é”ï¼Œæ‰€ä»¥æŠŠäº‹åŠ¡T2å¯¹åº”çš„é”ç»“æ„çš„<code>is_waiting</code>å±æ€§è®¾ç½®ä¸º<code>false</code>ï¼Œç„¶åæŠŠè¯¥äº‹åŠ¡å¯¹åº”çš„çº¿ç¨‹å”¤é†’ï¼Œè®©å®ƒç»§ç»­æ‰§è¡Œï¼Œæ­¤æ—¶äº‹åŠ¡T2å°±ç®—è·å–åˆ°é”äº†ã€‚æ•ˆæœå°±æ˜¯è¿™æ ·ã€‚</p><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220711194904328.png" class=""> <p>å°ç»“å‡ ç§è¯´æ³•ï¼š</p><ul><li><p>ä¸åŠ é”</p><p>æ„æ€å°±æ˜¯ä¸éœ€è¦åœ¨å†…å­˜ä¸­ç”Ÿæˆå¯¹åº”çš„ <code>é”ç»“æ„</code> ï¼Œå¯ä»¥ç›´æ¥æ‰§è¡Œæ“ä½œã€‚</p></li><li><p>è·å–é”æˆåŠŸï¼Œæˆ–è€…åŠ é”æˆåŠŸ</p><p>æ„æ€å°±æ˜¯åœ¨å†…å­˜ä¸­ç”Ÿæˆäº†å¯¹åº”çš„ <code>é”ç»“æ„</code> ï¼Œè€Œä¸”é”ç»“æ„çš„ <code>is_waiting</code> å±æ€§ä¸º <code>false</code> ï¼Œä¹Ÿå°±æ˜¯äº‹åŠ¡ å¯ä»¥ç»§ç»­æ‰§è¡Œæ“ä½œã€‚</p></li><li><p>è·å–é”å¤±è´¥ï¼Œæˆ–è€…åŠ é”å¤±è´¥ï¼Œæˆ–è€…æ²¡æœ‰è·å–åˆ°é”</p><p>æ„æ€å°±æ˜¯åœ¨å†…å­˜ä¸­ç”Ÿæˆäº†å¯¹åº”çš„ <code>é”ç»“æ„</code> ï¼Œä¸è¿‡é”ç»“æ„çš„ <code>is_waiting</code> å±æ€§ä¸º <code>true</code> ï¼Œä¹Ÿå°±æ˜¯äº‹åŠ¡ éœ€è¦ç­‰å¾…ï¼Œä¸å¯ä»¥ç»§ç»­æ‰§è¡Œæ“ä½œã€‚</p></li></ul><h3 id="2-3-è¯»-å†™æˆ–å†™-è¯»æƒ…å†µ"><a href="#2-3-è¯»-å†™æˆ–å†™-è¯»æƒ…å†µ" class="headerlink" title="2.3 è¯»-å†™æˆ–å†™-è¯»æƒ…å†µ"></a>2.3 è¯»-å†™æˆ–å†™-è¯»æƒ…å†µ</h3><p><code>è¯»-å†™</code> æˆ– <code>å†™-è¯» </code>ï¼Œå³ä¸€ä¸ªäº‹åŠ¡è¿›è¡Œè¯»å–æ“ä½œï¼Œå¦ä¸€ä¸ªè¿›è¡Œæ”¹åŠ¨æ“ä½œã€‚è¿™ç§æƒ…å†µä¸‹å¯èƒ½å‘ç”Ÿ <code>è„è¯» ã€ ä¸å¯é‡ å¤è¯» ã€ å¹»è¯»</code> çš„é—®é¢˜ã€‚</p><p>å„ä¸ªæ•°æ®åº“å‚å•†å¯¹ <code>SQLæ ‡å‡†</code> çš„æ”¯æŒéƒ½å¯èƒ½ä¸ä¸€æ ·ã€‚æ¯”å¦‚MySQLåœ¨ <code>REPEATABLE READ</code> éš”ç¦»çº§åˆ«ä¸Šå°±å·²ç»è§£å†³äº† <code>å¹»è¯»</code> é—®é¢˜ã€‚</p><h3 id="2-4-å¹¶å‘é—®é¢˜çš„è§£å†³æ–¹æ¡ˆ"><a href="#2-4-å¹¶å‘é—®é¢˜çš„è§£å†³æ–¹æ¡ˆ" class="headerlink" title="2.4 å¹¶å‘é—®é¢˜çš„è§£å†³æ–¹æ¡ˆ"></a>2.4 å¹¶å‘é—®é¢˜çš„è§£å†³æ–¹æ¡ˆ</h3><p>æ€ä¹ˆè§£å†³ <code>è„è¯» ã€ ä¸å¯é‡å¤è¯» ã€ å¹»è¯»</code> è¿™äº›é—®é¢˜å‘¢ï¼Ÿå…¶å®æœ‰ä¸¤ç§å¯é€‰çš„è§£å†³æ–¹æ¡ˆï¼š</p><ul><li>æ–¹æ¡ˆä¸€ï¼šè¯»æ“ä½œåˆ©ç”¨å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼ˆ <code>MVCC</code> ï¼Œä¸‹ç« è®²è§£ï¼‰ï¼Œå†™æ“ä½œè¿›è¡Œ <code>åŠ é”</code> ã€‚</li></ul><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220711202206405.png" class=""><blockquote><p>æ™®é€šçš„SELECTè¯­å¥åœ¨READ COMMITTEDå’ŒREPEATABLE READéš”ç¦»çº§åˆ«ä¸‹ä¼šä½¿ç”¨åˆ°MVCCè¯»å–è®°å½•ã€‚</p><ul><li>åœ¨ <code>READ COMMITTED</code> éš”ç¦»çº§åˆ«ä¸‹ï¼Œä¸€ä¸ªäº‹åŠ¡åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­æ¯æ¬¡æ‰§è¡ŒSELECTæ“ä½œæ—¶éƒ½ä¼šç”Ÿæˆä¸€ ä¸ªReadViewï¼ŒReadViewçš„å­˜åœ¨æœ¬èº«å°±ä¿è¯äº†<code>äº‹åŠ¡ä¸å¯ä»¥è¯»å–åˆ°æœªæäº¤çš„äº‹åŠ¡æ‰€åšçš„æ›´æ”¹</code> ï¼Œä¹Ÿå°±æ˜¯é¿å…äº†è„è¯»ç°è±¡ï¼›</li><li>åœ¨ <code>REPEATABLE READ</code> éš”ç¦»çº§åˆ«ä¸‹ï¼Œä¸€ä¸ªäº‹åŠ¡åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­åªæœ‰ <code>ç¬¬ä¸€æ¬¡æ‰§è¡ŒSELECTæ“ä½œ</code> æ‰ä¼šç”Ÿæˆä¸€ä¸ªReadViewï¼Œä¹‹åçš„SELECTæ“ä½œéƒ½ <code>å¤ç”¨</code> è¿™ä¸ªReadViewï¼Œè¿™æ ·ä¹Ÿå°±é¿å…äº†ä¸å¯é‡å¤è¯»å’Œå¹»è¯»çš„é—®é¢˜ã€‚</li></ul></blockquote><ul><li>æ–¹æ¡ˆäºŒï¼šè¯»ã€å†™æ“ä½œéƒ½é‡‡ç”¨ <code>åŠ é”</code> çš„æ–¹å¼ã€‚</li></ul><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220711203250284.png" class=""><ul><li><p>å°ç»“å¯¹æ¯”å‘ç°ï¼š</p><ul><li>é‡‡ç”¨ <code>MVCC</code> æ–¹å¼çš„è¯ï¼Œ è¯»-å†™ æ“ä½œå½¼æ­¤å¹¶ä¸å†²çªï¼Œ æ€§èƒ½æ›´é«˜ ã€‚</li><li>é‡‡ç”¨ <code>åŠ é”</code> æ–¹å¼çš„è¯ï¼Œ è¯»-å†™ æ“ä½œå½¼æ­¤éœ€è¦ <code>æ’é˜Ÿæ‰§è¡Œ</code> ï¼Œå½±å“æ€§èƒ½ã€‚</li></ul><p>ä¸€èˆ¬æƒ…å†µä¸‹æˆ‘ä»¬å½“ç„¶æ„¿æ„é‡‡ç”¨ <code>MVCC</code> æ¥è§£å†³ <code>è¯»-å†™</code> æ“ä½œå¹¶å‘æ‰§è¡Œçš„é—®é¢˜ï¼Œä½†æ˜¯ä¸šåŠ¡åœ¨æŸäº›ç‰¹æ®Šæƒ…å†µä¸‹ï¼Œè¦æ±‚å¿…é¡»é‡‡ç”¨ <code>åŠ é” </code>çš„æ–¹å¼æ‰§è¡Œã€‚ä¸‹é¢å°±è®²è§£ä¸‹MySQLä¸­ä¸åŒç±»åˆ«çš„é”ã€‚</p></li></ul><h2 id="3-é”çš„ä¸åŒè§’åº¦åˆ†ç±»"><a href="#3-é”çš„ä¸åŒè§’åº¦åˆ†ç±»" class="headerlink" title="3. é”çš„ä¸åŒè§’åº¦åˆ†ç±»"></a>3. é”çš„ä¸åŒè§’åº¦åˆ†ç±»</h2><p>é”çš„åˆ†ç±»å›¾ï¼Œå¦‚ä¸‹ï¼š</p><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220711203519162.png" class=""> <h3 id="3-1-ä»æ•°æ®æ“ä½œçš„ç±»å‹åˆ’åˆ†ï¼šè¯»é”ã€å†™é”"><a href="#3-1-ä»æ•°æ®æ“ä½œçš„ç±»å‹åˆ’åˆ†ï¼šè¯»é”ã€å†™é”" class="headerlink" title="3.1 ä»æ•°æ®æ“ä½œçš„ç±»å‹åˆ’åˆ†ï¼šè¯»é”ã€å†™é”"></a>3.1 ä»æ•°æ®æ“ä½œçš„ç±»å‹åˆ’åˆ†ï¼šè¯»é”ã€å†™é”</h3><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220711203723941.png" class=""><ul><li><code>è¯»é”</code> ï¼šä¹Ÿç§°ä¸º <code>å…±äº«é”</code> ã€è‹±æ–‡ç”¨ S è¡¨ç¤ºã€‚é’ˆå¯¹åŒä¸€ä»½æ•°æ®ï¼Œå¤šä¸ªäº‹åŠ¡çš„è¯»æ“ä½œå¯ä»¥åŒæ—¶è¿›è¡Œè€Œä¸ä¼šäº’ç›¸å½±å“ï¼Œç›¸äº’ä¸é˜»å¡çš„ã€‚</li><li><code>å†™é”</code> ï¼šä¹Ÿç§°ä¸º <code>æ’ä»–é”</code> ã€è‹±æ–‡ç”¨ X è¡¨ç¤ºã€‚å½“å‰å†™æ“ä½œæ²¡æœ‰å®Œæˆå‰ï¼Œå®ƒä¼šé˜»æ–­å…¶ä»–å†™é”å’Œè¯»é”ã€‚è¿™æ · å°±èƒ½ç¡®ä¿åœ¨ç»™å®šçš„æ—¶é—´é‡Œï¼Œåªæœ‰ä¸€ä¸ªäº‹åŠ¡èƒ½æ‰§è¡Œå†™å…¥ï¼Œå¹¶é˜²æ­¢å…¶ä»–ç”¨æˆ·è¯»å–æ­£åœ¨å†™å…¥çš„åŒä¸€èµ„æºã€‚</li></ul><p><strong>éœ€è¦æ³¨æ„çš„æ˜¯å¯¹äº InnoDB å¼•æ“æ¥è¯´ï¼Œè¯»é”å’Œå†™é”å¯ä»¥åŠ åœ¨è¡¨ä¸Šï¼Œä¹Ÿå¯ä»¥åŠ åœ¨è¡Œä¸Šã€‚</strong></p><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220711204843684.png" class=""><h4 id="1-é”å®šè¯»"><a href="#1-é”å®šè¯»" class="headerlink" title="1. é”å®šè¯»"></a>1. é”å®šè¯»</h4><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220711212931912.png" class=""><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220711213741630.png" class=""><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220711214013208.png" class=""><h4 id="2-å†™æ“ä½œ"><a href="#2-å†™æ“ä½œ" class="headerlink" title="2. å†™æ“ä½œ"></a>2. å†™æ“ä½œ</h4><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220711214412163.png" class=""><h3 id="3-2-ä»æ•°æ®æ“ä½œçš„ç²’åº¦åˆ’åˆ†ï¼šè¡¨çº§é”ã€é¡µçº§é”ã€è¡Œé”"><a href="#3-2-ä»æ•°æ®æ“ä½œçš„ç²’åº¦åˆ’åˆ†ï¼šè¡¨çº§é”ã€é¡µçº§é”ã€è¡Œé”" class="headerlink" title="3.2 ä»æ•°æ®æ“ä½œçš„ç²’åº¦åˆ’åˆ†ï¼šè¡¨çº§é”ã€é¡µçº§é”ã€è¡Œé”"></a>3.2 ä»æ•°æ®æ“ä½œçš„ç²’åº¦åˆ’åˆ†ï¼šè¡¨çº§é”ã€é¡µçº§é”ã€è¡Œé”</h3><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220711214719510.png" class=""><h4 id="1-è¡¨é”ï¼ˆTable-Lockï¼‰"><a href="#1-è¡¨é”ï¼ˆTable-Lockï¼‰" class="headerlink" title="1. è¡¨é”ï¼ˆTable Lockï¼‰"></a>1. è¡¨é”ï¼ˆTable Lockï¼‰</h4><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220711214805088.png" class=""><h5 id="â‘ -è¡¨çº§åˆ«çš„Sé”ã€Xé”"><a href="#â‘ -è¡¨çº§åˆ«çš„Sé”ã€Xé”" class="headerlink" title="â‘  è¡¨çº§åˆ«çš„Sé”ã€Xé”"></a>â‘  è¡¨çº§åˆ«çš„Sé”ã€Xé”</h5><p>åœ¨å¯¹æŸä¸ªè¡¨æ‰§è¡ŒSELECTã€INSERTã€DELETEã€UPDATEè¯­å¥æ—¶ï¼ŒInnoDBå­˜å‚¨å¼•æ“æ˜¯ä¸ä¼šä¸ºè¿™ä¸ªè¡¨æ·»åŠ è¡¨çº§åˆ«çš„ <code>Sé”</code> æˆ–è€… <code>Xé”</code> çš„ã€‚åœ¨å¯¹æŸä¸ªè¡¨æ‰§è¡Œä¸€äº›è¯¸å¦‚ <code>ALTER TABLE ã€ DROP TABLE</code> è¿™ç±»çš„ DDL è¯­å¥æ—¶ï¼Œå…¶ ä»–äº‹åŠ¡å¯¹è¿™ä¸ªè¡¨å¹¶å‘æ‰§è¡Œè¯¸å¦‚SELECTã€INSERTã€DELETEã€UPDATEçš„è¯­å¥ä¼šå‘ç”Ÿé˜»å¡ã€‚åŒç†ï¼ŒæŸä¸ªäº‹åŠ¡ä¸­å¯¹æŸä¸ªè¡¨æ‰§è¡ŒSELECTã€INSERTã€DELETEã€UPDATEè¯­å¥æ—¶ï¼Œåœ¨å…¶ä»–ä¼šè¯ä¸­å¯¹è¿™ä¸ªè¡¨æ‰§è¡Œ <code>DDL</code> è¯­å¥ä¹Ÿä¼š å‘ç”Ÿé˜»å¡ã€‚è¿™ä¸ªè¿‡ç¨‹å…¶å®æ˜¯é€šè¿‡åœ¨ serverå±‚ä½¿ç”¨ä¸€ç§ç§°ä¹‹ä¸º <code>å…ƒæ•°æ®é”</code> ï¼ˆè‹±æ–‡åï¼š Metadata Locks ï¼Œ ç®€ç§° MDL ï¼‰ç»“æ„æ¥å®ç°çš„ã€‚</p><p>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä¸ä¼šä½¿ç”¨InnoDBå­˜å‚¨å¼•æ“æä¾›çš„è¡¨çº§åˆ«çš„ <code>Sé”</code> å’Œ <code>Xé”</code> ã€‚åªä¼šåœ¨ä¸€äº›ç‰¹æ®Šæƒ…å†µä¸‹ï¼Œæ¯”æ–¹è¯´ <code>å´©æºƒæ¢å¤</code> è¿‡ç¨‹ä¸­ç”¨åˆ°ã€‚æ¯”å¦‚ï¼Œåœ¨ç³»ç»Ÿå˜é‡ <code>autocommit=0ï¼Œinnodb_table_locks = 1</code> æ—¶ï¼Œ æ‰‹åŠ¨ è·å– InnoDBå­˜å‚¨å¼•æ“æä¾›çš„è¡¨t çš„ <code>Sé”</code> æˆ–è€… <code>Xé”</code> å¯ä»¥è¿™ä¹ˆå†™ï¼š</p><ul><li><p><code>LOCK TABLES t READ</code> ï¼šInnoDBå­˜å‚¨å¼•æ“ä¼šå¯¹è¡¨ t åŠ è¡¨çº§åˆ«çš„ <code>Sé” </code>ã€‚</p></li><li><p><code>LOCK TABLES t WRITE</code> ï¼šInnoDBå­˜å‚¨å¼•æ“ä¼šå¯¹è¡¨ t åŠ è¡¨çº§åˆ«çš„ <code>Xé”</code> ã€‚</p></li></ul><p>ä¸è¿‡å°½é‡é¿å…åœ¨ä½¿ç”¨InnoDBå­˜å‚¨å¼•æ“çš„è¡¨ä¸Šä½¿ç”¨ <code>LOCK TABLES</code> è¿™æ ·çš„æ‰‹åŠ¨é”è¡¨è¯­å¥ï¼Œå®ƒä»¬å¹¶ä¸ä¼šæä¾› ä»€ä¹ˆé¢å¤–çš„ä¿æŠ¤ï¼Œåªæ˜¯ä¼šé™ä½å¹¶å‘èƒ½åŠ›è€Œå·²ã€‚InnoDBçš„å‰å®³ä¹‹å¤„è¿˜æ˜¯å®ç°äº†æ›´ç»†ç²’åº¦çš„ <code>è¡Œé”</code> ï¼Œå…³äº InnoDBè¡¨çº§åˆ«çš„ <code>Sé”</code> å’Œ<code> Xé”</code> å¤§å®¶äº†è§£ä¸€ä¸‹å°±å¯ä»¥äº†ã€‚</p><p><strong>ä¸¾ä¾‹ï¼š</strong>ä¸‹é¢æˆ‘ä»¬è®²è§£MyISAMå¼•æ“ä¸‹çš„è¡¨é”ã€‚</p><p>æ­¥éª¤1ï¼šåˆ›å»ºè¡¨å¹¶æ·»åŠ æ•°æ®</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE mylock(</span><br><span class="line">id INT NOT NULL PRIMARY KEY auto_increment,</span><br><span class="line">NAME VARCHAR(20)</span><br><span class="line">)ENGINE myisam;</span><br><span class="line"></span><br><span class="line"># æ’å…¥ä¸€æ¡æ•°æ®</span><br><span class="line">INSERT INTO mylock(NAME) VALUES(&#x27;a&#x27;);</span><br><span class="line"></span><br><span class="line"># æŸ¥è¯¢è¡¨ä¸­æ‰€æœ‰æ•°æ®</span><br><span class="line">SELECT * FROM mylock;</span><br><span class="line">+----+------+</span><br><span class="line">| id | Name |</span><br><span class="line">+----+------+</span><br><span class="line">| 1  | a    |</span><br><span class="line">+----+------+</span><br></pre></td></tr></table></figure><p>æ­¥éª¤äºŒï¼šæŸ¥çœ‹è¡¨ä¸ŠåŠ è¿‡çš„é”</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SHOW OPEN TABLES; # ä¸»è¦å…³æ³¨In_useå­—æ®µçš„å€¼</span><br><span class="line">æˆ–è€…</span><br><span class="line">SHOW OPEN TABLES where In_use &gt; 0;</span><br></pre></td></tr></table></figure><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220711220342251.png" class=""><p>æˆ–è€…</p><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220711220418859.png" class=""><p>ä¸Šé¢çš„ç»“æœè¡¨æ˜ï¼Œå½“å‰æ•°æ®åº“ä¸­æ²¡æœ‰è¢«é”å®šçš„è¡¨</p><p>æ­¥éª¤3ï¼šæ‰‹åŠ¨å¢åŠ è¡¨é”å‘½ä»¤</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">LOCK TABLES t READ; # å­˜å‚¨å¼•æ“ä¼šå¯¹è¡¨tåŠ è¡¨çº§åˆ«çš„å…±äº«é”ã€‚å…±äº«é”ä¹Ÿå«è¯»é”æˆ–Sé”ï¼ˆShareçš„ç¼©å†™ï¼‰</span><br><span class="line">LOCK TABLES t WRITE; # å­˜å‚¨å¼•æ“ä¼šå¯¹è¡¨tåŠ è¡¨çº§åˆ«çš„æ’ä»–é”ã€‚æ’ä»–é”ä¹Ÿå«ç‹¬å é”ã€å†™é”æˆ–Xé”ï¼ˆexclusiveçš„ç¼©å†™ï¼‰</span><br></pre></td></tr></table></figure><p>æ¯”å¦‚ï¼š</p><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220711220442269.png" class=""><p>æ­¥éª¤4ï¼šé‡Šæ”¾è¡¨é”</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UNLOCK TABLES; # ä½¿ç”¨æ­¤å‘½ä»¤è§£é”å½“å‰åŠ é”çš„è¡¨</span><br></pre></td></tr></table></figure><p>æ¯”å¦‚ï¼š</p><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220711220502141.png" class=""><p>æ­¥éª¤5ï¼šåŠ è¯»é”</p><p>æˆ‘ä»¬ä¸ºmylockè¡¨åŠ readé”ï¼ˆè¯»é˜»å¡å†™ï¼‰ï¼Œè§‚å¯Ÿé˜»å¡çš„æƒ…å†µï¼Œæµç¨‹å¦‚ä¸‹ï¼š</p><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220711220553225.png" class=""> <img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220711220616537.png" class=""> <p>æ­¥éª¤6ï¼šåŠ å†™é”</p><p>ä¸ºmylockè¡¨åŠ writeé”ï¼Œè§‚å¯Ÿé˜»å¡çš„æƒ…å†µï¼Œæµç¨‹å¦‚ä¸‹ï¼š</p><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220711220711630.png" class=""> <img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220711220730112.png" class=""> <p>æ€»ç»“ï¼š</p><p>MyISAMåœ¨æ‰§è¡ŒæŸ¥è¯¢è¯­å¥ï¼ˆSELECTï¼‰å‰ï¼Œä¼šç»™æ¶‰åŠçš„æ‰€æœ‰è¡¨åŠ è¯»é”ï¼Œåœ¨æ‰§è¡Œå¢åˆ æ”¹æ“ä½œå‰ï¼Œä¼šç»™æ¶‰åŠçš„è¡¨åŠ å†™é”ã€‚InnoDBå­˜å‚¨å¼•æ“æ˜¯ä¸ä¼šä¸ºè¿™ä¸ªè¡¨æ·»åŠ è¡¨çº§åˆ«çš„è¯»é”å’Œå†™é”çš„ã€‚</p><p>MySQLçš„è¡¨çº§é”æœ‰ä¸¤ç§æ¨¡å¼ï¼šï¼ˆä»¥MyISAMè¡¨è¿›è¡Œæ“ä½œçš„æ¼”ç¤ºï¼‰</p><ul><li><p>è¡¨å…±äº«è¯»é”ï¼ˆTable Read Lockï¼‰</p></li><li><p>è¡¨ç‹¬å å†™é”ï¼ˆTable Write Lockï¼‰</p></li></ul><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220711220929248.png" class=""> <h5 id="â‘¡-æ„å‘é”-ï¼ˆintention-lockï¼‰"><a href="#â‘¡-æ„å‘é”-ï¼ˆintention-lockï¼‰" class="headerlink" title="â‘¡ æ„å‘é” ï¼ˆintention lockï¼‰"></a>â‘¡ æ„å‘é” ï¼ˆintention lockï¼‰</h5><p>InnoDB æ”¯æŒ <code>å¤šç²’åº¦é”ï¼ˆmultiple granularity lockingï¼‰</code> ï¼Œå®ƒå…è®¸ <code>è¡Œçº§é”</code> ä¸ <code>è¡¨çº§é”</code> å…±å­˜ï¼Œè€Œ<code>æ„å‘é”</code>å°±æ˜¯å…¶ä¸­çš„ä¸€ç§ <code>è¡¨é”</code> ã€‚</p><ol><li>æ„å‘é”çš„å­˜åœ¨æ˜¯ä¸ºäº†åè°ƒè¡Œé”å’Œè¡¨é”çš„å…³ç³»ï¼Œæ”¯æŒå¤šç²’åº¦ï¼ˆè¡¨é”å’Œè¡Œé”ï¼‰çš„é”å¹¶å­˜ã€‚</li><li>æ„å‘é”æ˜¯ä¸€ç§<code>ä¸ä¸è¡Œçº§é”å†²çªè¡¨çº§é”</code>ï¼Œè¿™ä¸€ç‚¹éå¸¸é‡è¦ã€‚</li><li>è¡¨æ˜â€œæŸä¸ªäº‹åŠ¡æ­£åœ¨æŸäº›è¡ŒæŒæœ‰äº†é”æˆ–è¯¥äº‹åŠ¡å‡†å¤‡å»æŒæœ‰é”â€</li></ol><p>æ„å‘é”åˆ†ä¸ºä¸¤ç§ï¼š</p><ul><li><p><strong>æ„å‘å…±äº«é”</strong>ï¼ˆintention shared lock, ISï¼‰ï¼šäº‹åŠ¡æœ‰æ„å‘å¯¹è¡¨ä¸­çš„æŸäº›è¡ŒåŠ <strong>å…±äº«é”</strong>ï¼ˆSé”ï¼‰</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-- äº‹åŠ¡è¦è·å–æŸäº›è¡Œçš„ S é”ï¼Œå¿…é¡»å…ˆè·å¾—è¡¨çš„ IS é”ã€‚</span><br><span class="line">SELECT column FROM table ... LOCK IN SHARE MODE;</span><br></pre></td></tr></table></figure></li><li><p><strong>æ„å‘æ’ä»–é”</strong>ï¼ˆintention exclusive lock, IXï¼‰ï¼šäº‹åŠ¡æœ‰æ„å‘å¯¹è¡¨ä¸­çš„æŸäº›è¡ŒåŠ <strong>æ’ä»–é”</strong>ï¼ˆXé”ï¼‰</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-- äº‹åŠ¡è¦è·å–æŸäº›è¡Œçš„ X é”ï¼Œå¿…é¡»å…ˆè·å¾—è¡¨çš„ IX é”ã€‚</span><br><span class="line">SELECT column FROM table ... FOR UPDATE;</span><br></pre></td></tr></table></figure></li></ul><p>å³ï¼šæ„å‘é”æ˜¯ç”±å­˜å‚¨å¼•æ“ <code>è‡ªå·±ç»´æŠ¤çš„</code> ï¼Œç”¨æˆ·æ— æ³•æ‰‹åŠ¨æ“ä½œæ„å‘é”ï¼Œåœ¨ä¸ºæ•°æ®è¡ŒåŠ å…±äº« &#x2F; æ’ä»–é”ä¹‹å‰ï¼Œ InooDB ä¼šå…ˆè·å–è¯¥æ•°æ®è¡Œ <code>æ‰€åœ¨æ•°æ®è¡¨çš„å¯¹åº”æ„å‘é”</code> ã€‚</p><p><strong>1. æ„å‘é”è¦è§£å†³çš„é—®é¢˜</strong></p><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220711222132300.png" class=""><p><strong>ä¸¾ä¾‹ï¼š</strong>åˆ›å»ºè¡¨teacher,æ’å…¥6æ¡æ•°æ®ï¼Œäº‹åŠ¡çš„éš”ç¦»çº§åˆ«é»˜è®¤ä¸º<code>Repeatable-Read</code>ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE `teacher` (</span><br><span class="line">`id` int NOT NULL,</span><br><span class="line">    `name` varchar(255) NOT NULL,</span><br><span class="line">    PRIMARY KEY (`id`)</span><br><span class="line">)ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;</span><br><span class="line"></span><br><span class="line">INSERT INTO `teacher` VALUES</span><br><span class="line">(&#x27;1&#x27;, &#x27;zhangsan&#x27;),</span><br><span class="line">(&#x27;2&#x27;, &#x27;lisi&#x27;),</span><br><span class="line">(&#x27;3&#x27;, &#x27;wangwu&#x27;),</span><br><span class="line">(&#x27;4&#x27;, &#x27;zhaoliu&#x27;),</span><br><span class="line">(&#x27;5&#x27;, &#x27;songhongkang&#x27;),</span><br><span class="line">(&#x27;6&#x27;, &#x27;leifengyang&#x27;);</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT @@transaction_isolation;</span><br><span class="line">+-------------------------+</span><br><span class="line">| @@transaction_isolation |</span><br><span class="line">+-------------------------+</span><br><span class="line">| REPEATABLE-READ         |</span><br><span class="line">+-------------------------+</span><br></pre></td></tr></table></figure><p>å‡è®¾äº‹åŠ¡Aè·å–äº†æŸä¸€è¡Œçš„æ’ä»–é”ï¼Œå¹¶æœªæäº¤ï¼Œè¯­å¥å¦‚ä¸‹æ‰€ç¤º:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">BEGIN;</span><br><span class="line"></span><br><span class="line">SELECT * FROM teacher WHERE id = 6 FOR UPDATE;</span><br></pre></td></tr></table></figure><p>äº‹åŠ¡Bæƒ³è¦è·å–teacherè¡¨çš„è¡¨è¯»é”ï¼Œè¯­å¥å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">BEGIN;</span><br><span class="line"></span><br><span class="line">LOCK TABLES teacher READ;</span><br></pre></td></tr></table></figure><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220712124209006.png" class=""><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">BEGIN;</span><br><span class="line"></span><br><span class="line">SELECT * FROM teacher WHERE id = 6 FOR UPDATE;</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶teacherè¡¨å­˜åœ¨ä¸¤æŠŠé”ï¼šteacherè¡¨ä¸Šçš„æ„å‘æ’ä»–é”ä¸idæœª6çš„æ•°æ®è¡Œä¸Šçš„æ’ä»–é”ã€‚äº‹åŠ¡Bæƒ³è¦è·å–teacherè¡¨çš„å…±äº«é”ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">BEGIN;</span><br><span class="line"></span><br><span class="line">LOCK TABLES teacher READ;</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶äº‹åŠ¡Bæ£€æµ‹äº‹åŠ¡AæŒæœ‰teacherè¡¨çš„æ„å‘æ’ä»–é”ï¼Œå°±å¯ä»¥å¾—çŸ¥äº‹åŠ¡Aå¿…é¡»æŒæœ‰è¯¥è¡¨ä¸­æŸäº›æ•°æ®è¡Œçš„æ’ä»–é”ï¼Œé‚£ä¹ˆäº‹åŠ¡Bå¯¹teacherè¡¨çš„åŠ é”è¯·æ±‚å°±ä¼šè¢«æ’æ–¥ï¼ˆé˜»å¡ï¼‰ï¼Œè€Œæ— éœ€å»æ£€æµ‹è¡¨ä¸­çš„æ¯ä¸€è¡Œæ•°æ®æ˜¯å¦å­˜åœ¨æ’ä»–é”ã€‚</p><p><strong>æ„å‘é”çš„å¹¶å‘æ€§</strong></p><p>æ„å‘é”ä¸ä¼šä¸è¡Œçº§çš„å…±äº« &#x2F; æ’ä»–é”äº’æ–¥ï¼æ­£å› ä¸ºå¦‚æ­¤ï¼Œæ„å‘é”å¹¶ä¸ä¼šå½±å“åˆ°å¤šä¸ªäº‹åŠ¡å¯¹ä¸åŒæ•°æ®è¡ŒåŠ æ’ä»–é”æ—¶çš„å¹¶å‘æ€§ã€‚ï¼ˆä¸ç„¶æˆ‘ä»¬ç›´æ¥ç”¨æ™®é€šçš„è¡¨é”å°±è¡Œäº†ï¼‰</p><p>æˆ‘ä»¬æ‰©å±•ä¸€ä¸‹ä¸Šé¢ teacherè¡¨çš„ä¾‹å­æ¥æ¦‚æ‹¬ä¸€ä¸‹æ„å‘é”çš„ä½œç”¨ï¼ˆä¸€æ¡æ•°æ®ä»è¢«é”å®šåˆ°è¢«é‡Šæ”¾çš„è¿‡ç¨‹ä¸­ï¼Œå¯ èƒ½å­˜åœ¨å¤šç§ä¸åŒé”ï¼Œä½†æ˜¯è¿™é‡Œæˆ‘ä»¬åªç€é‡è¡¨ç°æ„å‘é”ï¼‰ã€‚</p><p>äº‹åŠ¡Aå…ˆè·å¾—äº†æŸä¸€è¡Œçš„æ’ä»–é”ï¼Œå¹¶æœªæäº¤ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">BEGIN;</span><br><span class="line"></span><br><span class="line">SELECT * FROM teacher WHERE id = 6 FOR UPDATE;</span><br></pre></td></tr></table></figure><p>äº‹åŠ¡Aè·å–äº†teacherè¡¨ä¸Šçš„æ„å‘æ’ä»–é”ã€‚äº‹åŠ¡Aè·å–äº†idä¸º6çš„æ•°æ®è¡Œä¸Šçš„æ’ä»–é”ã€‚ä¹‹åäº‹åŠ¡Bæƒ³è¦è·å–teacherè¡¨ä¸Šçš„å…±äº«é”ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">BEGIN;</span><br><span class="line"></span><br><span class="line">LOCK TABLES teacher READ;</span><br></pre></td></tr></table></figure><p>äº‹åŠ¡Bæ£€æµ‹åˆ°äº‹åŠ¡AæŒæœ‰teacherè¡¨çš„æ„å‘æ’ä»–é”ã€‚äº‹åŠ¡Bå¯¹teacherè¡¨çš„åŠ é”è¯·æ±‚è¢«é˜»å¡ï¼ˆæ’æ–¥ï¼‰ã€‚æœ€åäº‹åŠ¡Cä¹Ÿæƒ³è·å–teacherè¡¨ä¸­æŸä¸€è¡Œçš„æ’ä»–é”ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">BEGIN;</span><br><span class="line"></span><br><span class="line">SELECT * FROM teacher WHERE id = 5 FOR UPDATE;</span><br></pre></td></tr></table></figure><p>äº‹åŠ¡Cç”³è¯·teacherè¡¨çš„æ„å‘æ’ä»–é”ã€‚äº‹åŠ¡Cæ£€æµ‹åˆ°äº‹åŠ¡AæŒæœ‰teacherè¡¨çš„æ„å‘æ’ä»–é”ã€‚å› ä¸ºæ„å‘é”ä¹‹é—´å¹¶ä¸äº’æ–¥ï¼Œæ‰€ä»¥äº‹åŠ¡Cè·å–åˆ°äº†teacherè¡¨çš„æ„å‘æ’ä»–é”ã€‚å› ä¸ºidä¸º5çš„æ•°æ®è¡Œä¸Šä¸å­˜åœ¨ä»»ä½•æ’ä»–é”ï¼Œæœ€ç»ˆäº‹åŠ¡CæˆåŠŸè·å–åˆ°äº†è¯¥æ•°æ®è¡Œä¸Šçš„æ’ä»–é”ã€‚</p><p><strong>ä»ä¸Šé¢çš„æ¡ˆä¾‹å¯ä»¥å¾—åˆ°å¦‚ä¸‹ç»“è®ºï¼š</strong></p><ol><li>InnoDB æ”¯æŒ <code>å¤šç²’åº¦é”</code> ï¼Œç‰¹å®šåœºæ™¯ä¸‹ï¼Œè¡Œçº§é”å¯ä»¥ä¸è¡¨çº§é”å…±å­˜ã€‚ </li><li>æ„å‘é”ä¹‹é—´äº’ä¸æ’æ–¥ï¼Œä½†é™¤äº† IS ä¸ S å…¼å®¹å¤–ï¼Œ <code>æ„å‘é”ä¼šä¸ å…±äº«é” / æ’ä»–é” äº’æ–¥</code> ã€‚ </li><li>IXï¼ŒISæ˜¯è¡¨çº§é”ï¼Œä¸ä¼šå’Œè¡Œçº§çš„Xï¼ŒSé”å‘ç”Ÿå†²çªã€‚åªä¼šå’Œè¡¨çº§çš„Xï¼ŒSå‘ç”Ÿå†²çªã€‚ </li><li>æ„å‘é”åœ¨ä¿è¯å¹¶å‘æ€§çš„å‰æä¸‹ï¼Œå®ç°äº† <code>è¡Œé”å’Œè¡¨é”å…±å­˜</code> ä¸” <code>æ»¡è¶³äº‹åŠ¡éš”ç¦»æ€§</code> çš„è¦æ±‚ã€‚</li></ol><h5 id="â‘¢-è‡ªå¢é”ï¼ˆAUTO-INCé”ï¼‰"><a href="#â‘¢-è‡ªå¢é”ï¼ˆAUTO-INCé”ï¼‰" class="headerlink" title="â‘¢ è‡ªå¢é”ï¼ˆAUTO-INCé”ï¼‰"></a>â‘¢ è‡ªå¢é”ï¼ˆAUTO-INCé”ï¼‰</h5><p>åœ¨ä½¿ç”¨MySQLè¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ä¸ºè¡¨çš„æŸä¸ªåˆ—æ·»åŠ  <code>AUTO_INCREMENT</code> å±æ€§ã€‚ä¸¾ä¾‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE `teacher` (</span><br><span class="line">`id` int NOT NULL AUTO_INCREMENT,</span><br><span class="line">`name` varchar(255) NOT NULL,</span><br><span class="line">PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;</span><br></pre></td></tr></table></figure><p>ç”±äºè¿™ä¸ªè¡¨çš„idå­—æ®µå£°æ˜äº†AUTO_INCREMENTï¼Œæ„å‘³ç€åœ¨ä¹¦å†™æ’å…¥è¯­å¥æ—¶ä¸éœ€è¦ä¸ºå…¶èµ‹å€¼ï¼ŒSQLè¯­å¥ä¿®æ”¹ å¦‚ä¸‹æ‰€ç¤ºã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO `teacher` (name) VALUES (&#x27;zhangsan&#x27;), (&#x27;lisi&#x27;);</span><br></pre></td></tr></table></figure><p>ä¸Šè¾¹çš„æ’å…¥è¯­å¥å¹¶æ²¡æœ‰ä¸ºidåˆ—æ˜¾å¼èµ‹å€¼ï¼Œæ‰€ä»¥ç³»ç»Ÿä¼šè‡ªåŠ¨ä¸ºå®ƒèµ‹ä¸Šé€’å¢çš„å€¼ï¼Œç»“æœå¦‚ä¸‹æ‰€ç¤ºã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from teacher;</span><br><span class="line">+----+----------+</span><br><span class="line">| id | name     |</span><br><span class="line">+----+----------+</span><br><span class="line">| 1  | zhangsan |</span><br><span class="line">| 2  | lisi     |</span><br><span class="line">+----+----------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure><p>ç°åœ¨æˆ‘ä»¬çœ‹åˆ°çš„ä¸Šé¢æ’å…¥æ•°æ®åªæ˜¯ä¸€ç§ç®€å•çš„æ’å…¥æ¨¡å¼ï¼Œæ‰€æœ‰æ’å…¥æ•°æ®çš„æ–¹å¼æ€»å…±åˆ†ä¸ºä¸‰ç±»ï¼Œåˆ†åˆ«æ˜¯ â€œ <code>Simple inserts</code> â€ï¼Œâ€œ <code>Bulk inserts</code> â€å’Œâ€œ <code>Mixed-mode inserts </code>â€ã€‚</p><p><strong>1. â€œSimple insertsâ€ ï¼ˆç®€å•æ’å…¥ï¼‰</strong></p><p>å¯ä»¥ <code>é¢„å…ˆç¡®å®šè¦æ’å…¥çš„è¡Œæ•°</code> ï¼ˆå½“è¯­å¥è¢«åˆå§‹å¤„ç†æ—¶ï¼‰çš„è¯­å¥ã€‚åŒ…æ‹¬æ²¡æœ‰åµŒå¥—å­æŸ¥è¯¢çš„å•è¡Œå’Œå¤šè¡Œ<code>INSERT...VALUES()</code>å’Œ <code>REPLACE</code> è¯­å¥ã€‚æ¯”å¦‚æˆ‘ä»¬ä¸Šé¢ä¸¾çš„ä¾‹å­å°±å±äºè¯¥ç±»æ’å…¥ï¼Œå·²ç»ç¡®å®šè¦æ’å…¥çš„è¡Œ æ•°ã€‚</p><p><strong>2. â€œBulk insertsâ€ ï¼ˆæ‰¹é‡æ’å…¥ï¼‰</strong></p><p><code>äº‹å…ˆä¸çŸ¥é“è¦æ’å…¥çš„è¡Œæ•°</code> ï¼ˆå’Œæ‰€éœ€è‡ªåŠ¨é€’å¢å€¼çš„æ•°é‡ï¼‰çš„è¯­å¥ã€‚æ¯”å¦‚ <code>INSERT ... SELECT</code> ï¼Œ <code>REPLACE ... SELECT</code> å’Œ <code>LOAD DATA</code> è¯­å¥ï¼Œä½†ä¸åŒ…æ‹¬çº¯INSERTã€‚ InnoDBåœ¨æ¯å¤„ç†ä¸€è¡Œï¼Œä¸ºAUTO_INCREMENTåˆ—</p><p><strong>3. â€œMixed-mode insertsâ€ ï¼ˆæ··åˆæ¨¡å¼æ’å…¥ï¼‰</strong></p><p>è¿™äº›æ˜¯â€œSimple insertsâ€è¯­å¥ä½†æ˜¯æŒ‡å®šéƒ¨åˆ†æ–°è¡Œçš„è‡ªåŠ¨é€’å¢å€¼ã€‚ä¾‹å¦‚ <code>INSERT INTO teacher (id,name) VALUES (1,&#39;a&#39;), (NULL,&#39;b&#39;), (5,&#39;c&#39;), (NULL,&#39;d&#39;);</code> åªæ˜¯æŒ‡å®šäº†éƒ¨åˆ†idçš„å€¼ã€‚å¦ä¸€ç§ç±»å‹çš„â€œæ··åˆæ¨¡å¼æ’å…¥â€æ˜¯ <code>INSERT ... ON DUPLICATE KEY UPDATE</code> ã€‚</p><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220712175552985.png" class=""><p>innodb_autoinc_lock_modeæœ‰ä¸‰ç§å–å€¼ï¼Œåˆ†åˆ«å¯¹åº”ä¸ä¸åŒé”å®šæ¨¡å¼ï¼š</p><p><code>ï¼ˆ1ï¼‰innodb_autoinc_lock_mode = 0(â€œä¼ ç»Ÿâ€é”å®šæ¨¡å¼)</code></p><p>åœ¨æ­¤é”å®šæ¨¡å¼ä¸‹ï¼Œæ‰€æœ‰ç±»å‹çš„insertè¯­å¥éƒ½ä¼šè·å¾—ä¸€ä¸ªç‰¹æ®Šçš„è¡¨çº§AUTO-INCé”ï¼Œç”¨äºæ’å…¥å…·æœ‰ AUTO_INCREMENTåˆ—çš„è¡¨ã€‚è¿™ç§æ¨¡å¼å…¶å®å°±å¦‚æˆ‘ä»¬ä¸Šé¢çš„ä¾‹å­ï¼Œå³æ¯å½“æ‰§è¡Œinsertçš„æ—¶å€™ï¼Œéƒ½ä¼šå¾—åˆ°ä¸€ä¸ª è¡¨çº§é”(AUTO-INCé”)ï¼Œä½¿å¾—è¯­å¥ä¸­ç”Ÿæˆçš„auto_incrementä¸ºé¡ºåºï¼Œä¸”åœ¨binlogä¸­é‡æ”¾çš„æ—¶å€™ï¼Œå¯ä»¥ä¿è¯ masterä¸slaveä¸­æ•°æ®çš„auto_incrementæ˜¯ç›¸åŒçš„ã€‚å› ä¸ºæ˜¯è¡¨çº§é”ï¼Œå½“åœ¨åŒä¸€æ—¶é—´å¤šä¸ªäº‹åŠ¡ä¸­æ‰§è¡Œinsertçš„ æ—¶å€™ï¼Œå¯¹äºAUTO-INCé”çš„äº‰å¤ºä¼š <code>é™åˆ¶å¹¶å‘</code> èƒ½åŠ›ã€‚</p><p><code>ï¼ˆ2ï¼‰innodb_autoinc_lock_mode = 1(â€œè¿ç»­â€é”å®šæ¨¡å¼)</code></p><p>åœ¨ MySQL 8.0 ä¹‹å‰ï¼Œè¿ç»­é”å®šæ¨¡å¼æ˜¯ <code>é»˜è®¤</code> çš„ã€‚</p><p>åœ¨è¿™ä¸ªæ¨¡å¼ä¸‹ï¼Œâ€œbulk insertsâ€ä»ç„¶ä½¿ç”¨AUTO-INCè¡¨çº§é”ï¼Œå¹¶ä¿æŒåˆ°è¯­å¥ç»“æŸã€‚è¿™é€‚ç”¨äºæ‰€æœ‰INSERT â€¦ SELECTï¼ŒREPLACE â€¦ SELECTå’ŒLOAD DATAè¯­å¥ã€‚åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªè¯­å¥å¯ä»¥æŒæœ‰AUTO-INCé”ã€‚</p><p>å¯¹äºâ€œSimple insertsâ€ï¼ˆè¦æ’å…¥çš„è¡Œæ•°äº‹å…ˆå·²çŸ¥ï¼‰ï¼Œåˆ™é€šè¿‡åœ¨ <code>mutexï¼ˆè½»é‡é”ï¼‰</code> çš„æ§åˆ¶ä¸‹è·å¾—æ‰€éœ€æ•°é‡çš„è‡ªåŠ¨é€’å¢å€¼æ¥é¿å…è¡¨çº§AUTO-INCé”ï¼Œ å®ƒåªåœ¨åˆ†é…è¿‡ç¨‹çš„æŒç»­æ—¶é—´å†…ä¿æŒï¼Œè€Œä¸æ˜¯ç›´åˆ°è¯­å¥å®Œæˆã€‚ä¸ä½¿ç”¨è¡¨çº§AUTO-INCé”ï¼Œé™¤éAUTO-INCé”ç”±å¦ä¸€ä¸ªäº‹åŠ¡ä¿æŒã€‚å¦‚æœå¦ä¸€ä¸ªäº‹åŠ¡ä¿æŒAUTO-INCé”ï¼Œåˆ™â€œSimple insertsâ€ç­‰å¾…AUTO-INCé”ï¼Œå¦‚åŒå®ƒæ˜¯ä¸€ä¸ªâ€œbulk insertsâ€ã€‚</p><p><code>ï¼ˆ3ï¼‰innodb_autoinc_lock_mode = 2(â€œäº¤é”™â€é”å®šæ¨¡å¼)</code></p><p>ä» MySQL 8.0 å¼€å§‹ï¼Œäº¤é”™é”æ¨¡å¼æ˜¯ <code>é»˜è®¤</code> è®¾ç½®ã€‚</p><p>åœ¨æ­¤é”å®šæ¨¡å¼ä¸‹ï¼Œè‡ªåŠ¨é€’å¢å€¼ <code>ä¿è¯</code> åœ¨æ‰€æœ‰å¹¶å‘æ‰§è¡Œçš„æ‰€æœ‰ç±»å‹çš„insertè¯­å¥ä¸­æ˜¯ <code>å”¯ä¸€</code> ä¸” <code>å•è°ƒé€’å¢</code> çš„ã€‚ä½†æ˜¯ï¼Œç”±äºå¤šä¸ªè¯­å¥å¯ä»¥åŒæ—¶ç”Ÿæˆæ•°å­—ï¼ˆå³ï¼Œè·¨è¯­å¥äº¤å‰ç¼–å·ï¼‰ï¼Œ<strong>ä¸ºä»»ä½•ç»™å®šè¯­å¥æ’å…¥çš„è¡Œç”Ÿæˆçš„å€¼å¯èƒ½ä¸æ˜¯è¿ç»­çš„ã€‚</strong></p><p>å¦‚æœæ‰§è¡Œçš„è¯­å¥æ˜¯â€œsimple insertsâ€ï¼Œå…¶ä¸­è¦æ’å…¥çš„è¡Œæ•°å·²æå‰çŸ¥é“ï¼Œé™¤äº†â€Mixed-mode insertsâ€ä¹‹å¤–ï¼Œä¸ºå•ä¸ªè¯­å¥ç”Ÿæˆçš„æ•°å­—ä¸ä¼šæœ‰é—´éš™ã€‚ç„¶åï¼Œå½“æ‰§è¡Œâ€bulk insertsâ€æ—¶ï¼Œåœ¨ç”±ä»»ä½•ç»™å®šè¯­å¥åˆ†é…çš„è‡ªåŠ¨é€’å¢å€¼ä¸­å¯èƒ½å­˜åœ¨é—´éš™ã€‚</p><h5 id="â‘£-å…ƒæ•°æ®é”ï¼ˆMDLé”ï¼‰"><a href="#â‘£-å…ƒæ•°æ®é”ï¼ˆMDLé”ï¼‰" class="headerlink" title="â‘£ å…ƒæ•°æ®é”ï¼ˆMDLé”ï¼‰"></a>â‘£ å…ƒæ•°æ®é”ï¼ˆMDLé”ï¼‰</h5><p>MySQL5.5å¼•å…¥äº†meta data lockï¼Œç®€ç§°MDLé”ï¼Œå±äºè¡¨é”èŒƒç•´ã€‚MDL çš„ä½œç”¨æ˜¯ï¼Œä¿è¯è¯»å†™çš„æ­£ç¡®æ€§ã€‚æ¯” å¦‚ï¼Œå¦‚æœä¸€ä¸ªæŸ¥è¯¢æ­£åœ¨éå†ä¸€ä¸ªè¡¨ä¸­çš„æ•°æ®ï¼Œè€Œæ‰§è¡ŒæœŸé—´å¦ä¸€ä¸ªçº¿ç¨‹å¯¹è¿™ä¸ª <code>è¡¨ç»“æ„åšå˜æ›´</code> ï¼Œå¢åŠ äº†ä¸€ åˆ—ï¼Œé‚£ä¹ˆæŸ¥è¯¢çº¿ç¨‹æ‹¿åˆ°çš„ç»“æœè·Ÿè¡¨ç»“æ„å¯¹ä¸ä¸Šï¼Œè‚¯å®šæ˜¯ä¸è¡Œçš„ã€‚</p><p>å› æ­¤ï¼Œ<strong>å½“å¯¹ä¸€ä¸ªè¡¨åšå¢åˆ æ”¹æŸ¥æ“ä½œçš„æ—¶å€™ï¼ŒåŠ  MDLè¯»é”ï¼›å½“è¦å¯¹è¡¨åšç»“æ„å˜æ›´æ“ä½œçš„æ—¶å€™ï¼ŒåŠ  MDL å†™é”</strong>ã€‚</p><p>è¯»é”ä¹‹é—´ä¸äº’æ–¥ï¼Œå› æ­¤ä½ å¯ä»¥æœ‰å¤šä¸ªçº¿ç¨‹åŒæ—¶å¯¹ä¸€å¼ è¡¨å¢åˆ æŸ¥æ”¹ã€‚è¯»å†™é”ä¹‹é—´ã€å†™é”ä¹‹é—´éƒ½æ˜¯äº’æ–¥çš„ï¼Œç”¨æ¥ä¿è¯å˜æ›´è¡¨ç»“æ„æ“ä½œçš„å®‰å…¨æ€§ï¼Œè§£å†³äº†DMLå’ŒDDLæ“ä½œä¹‹é—´çš„ä¸€è‡´æ€§é—®é¢˜ã€‚<code>ä¸éœ€è¦æ˜¾å¼ä½¿ç”¨</code>ï¼Œåœ¨è®¿é—®ä¸€ä¸ªè¡¨çš„æ—¶å€™ä¼šè¢«è‡ªåŠ¨åŠ ä¸Šã€‚</p><p><strong>ä¸¾ä¾‹ï¼šå…ƒæ•°æ®é”çš„ä½¿ç”¨åœºæ™¯æ¨¡æ‹Ÿ</strong></p><p><strong>ä¼šè¯Aï¼š</strong>ä»è¡¨ä¸­æŸ¥è¯¢æ•°æ®</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; BEGIN;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line">mysql&gt; SELECT COUNT(1) FROM teacher;</span><br><span class="line">+----------+</span><br><span class="line">| COUNT(1) |</span><br><span class="line">+----------+</span><br><span class="line">| 2        |</span><br><span class="line">+----------+</span><br><span class="line">1 row int set (7.46 sec)</span><br></pre></td></tr></table></figure><p><strong>ä¼šè¯Bï¼š</strong>ä¿®æ”¹è¡¨ç»“æ„ï¼Œå¢åŠ æ–°åˆ—</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; BEGIN;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line">mysql&gt; alter table teacher add age int not null;</span><br></pre></td></tr></table></figure><p><strong>ä¼šè¯Cï¼š</strong>æŸ¥çœ‹å½“å‰MySQLçš„è¿›ç¨‹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show processlist;</span><br></pre></td></tr></table></figure><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220713142808924.png" class=""> <p>é€šè¿‡ä¼šè¯Cå¯ä»¥çœ‹å‡ºä¼šè¯Bè¢«é˜»å¡ï¼Œè¿™æ˜¯ç”±äºä¼šè¯Aæ‹¿åˆ°äº†teacherè¡¨çš„å…ƒæ•°æ®è¯»é”ï¼Œä¼šè¯Bæƒ³ç”³è¯·teacherè¡¨çš„å…ƒæ•°æ®å†™é”ï¼Œç”±äºè¯»å†™é”äº’æ–¥ï¼Œä¼šè¯Béœ€è¦ç­‰å¾…ä¼šè¯Aé‡Šæ”¾å…ƒæ•°æ®é”æ‰èƒ½æ‰§è¡Œã€‚</p><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220713143156759.png" class=""><h4 id="2-InnoDBä¸­çš„è¡Œé”"><a href="#2-InnoDBä¸­çš„è¡Œé”" class="headerlink" title="2. InnoDBä¸­çš„è¡Œé”"></a>2. InnoDBä¸­çš„è¡Œé”</h4><p>è¡Œé”ï¼ˆRow Lockï¼‰ä¹Ÿç§°ä¸ºè®°å½•é”ï¼Œé¡¾åæ€ä¹‰ï¼Œå°±æ˜¯é”ä½æŸä¸€è¡Œï¼ˆæŸæ¡è®°å½• rowï¼‰ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒMySQLæœåŠ¡å™¨å±‚å¹¶æ²¡æœ‰å®ç°è¡Œé”æœºåˆ¶ï¼Œ<strong>è¡Œçº§é”åªåœ¨å­˜å‚¨å¼•æ“å±‚å®ç°</strong>ã€‚</p><p><strong>ä¼˜ç‚¹ï¼š</strong>é”å®šåŠ›åº¦å°ï¼Œå‘ç”Ÿ<code>é”å†²çªæ¦‚ç‡ä½</code>ï¼Œå¯ä»¥å®ç°çš„<code>å¹¶å‘åº¦é«˜</code>ã€‚</p><p><strong>ç¼ºç‚¹ï¼š</strong>å¯¹äº<code>é”çš„å¼€é”€æ¯”è¾ƒå¤§</code>ï¼ŒåŠ é”ä¼šæ¯”è¾ƒæ…¢ï¼Œå®¹æ˜“å‡ºç°<code>æ­»é”</code>æƒ…å†µã€‚</p><p>InnoDBä¸MyISAMçš„æœ€å¤§ä¸åŒæœ‰ä¸¤ç‚¹ï¼šä¸€æ˜¯æ”¯æŒäº‹ç‰©ï¼ˆTRANSACTIONï¼‰ï¼›äºŒæ˜¯é‡‡ç”¨äº†è¡Œçº§é”ã€‚</p><p>é¦–å…ˆæˆ‘ä»¬åˆ›å»ºè¡¨å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE student (</span><br><span class="line">id INT,</span><br><span class="line">    name VARCHAR(20),</span><br><span class="line">    class VARCHAR(10),</span><br><span class="line">    PRIMARY KEY (id)</span><br><span class="line">) Engine=InnoDB CHARSET=utf8;</span><br></pre></td></tr></table></figure><p>å‘è¿™ä¸ªè¡¨é‡Œæ’å…¥å‡ æ¡è®°å½•ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO student VALUES</span><br><span class="line">(1, &#x27;å¼ ä¸‰&#x27;, &#x27;ä¸€ç­&#x27;),</span><br><span class="line">(3, &#x27;æå››&#x27;, &#x27;ä¸€ç­&#x27;),</span><br><span class="line">(8, &#x27;ç‹äº”&#x27;, &#x27;äºŒç­&#x27;),</span><br><span class="line">(15, &#x27;èµµå…­&#x27;, &#x27;äºŒç­&#x27;),</span><br><span class="line">(20, &#x27;é’±ä¸ƒ&#x27;, &#x27;ä¸‰ç­&#x27;);</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT * FROM student;</span><br></pre></td></tr></table></figure><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220713161549241.png" class=""><p>studentè¡¨ä¸­çš„èšç°‡ç´¢å¼•çš„ç®€å›¾å¦‚ä¸‹æ‰€ç¤ºã€‚</p><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220713163353648.png" class=""> <p>è¿™é‡ŒæŠŠB+æ ‘çš„ç´¢å¼•ç»“æ„åšäº†è¶…çº§ç®€åŒ–ï¼ŒåªæŠŠç´¢å¼•ä¸­çš„è®°å½•ç»™æ‹¿äº†å‡ºæ¥ï¼Œä¸‹é¢çœ‹çœ‹éƒ½æœ‰å“ªäº›å¸¸ç”¨çš„è¡Œé”ç±»å‹ã€‚</p><h5 id="â‘ -è®°å½•é”ï¼ˆRecord-Locksï¼‰"><a href="#â‘ -è®°å½•é”ï¼ˆRecord-Locksï¼‰" class="headerlink" title="â‘  è®°å½•é”ï¼ˆRecord Locksï¼‰"></a>â‘  è®°å½•é”ï¼ˆRecord Locksï¼‰</h5><p>è®°å½•é”ä¹Ÿå°±æ˜¯ä»…ä»…æŠŠä¸€æ¡è®°å½•é”ï¼Œå®˜æ–¹çš„ç±»å‹åç§°ä¸ºï¼š<code>LOCK_REC_NOT_GAP</code>ã€‚æ¯”å¦‚æˆ‘ä»¬æŠŠidå€¼ä¸º8çš„é‚£æ¡è®°å½•åŠ ä¸€ä¸ªè®°å½•é”çš„ç¤ºæ„å›¾å¦‚æœæ‰€ç¤ºã€‚ä»…ä»…æ˜¯é”ä½äº†idå€¼ä¸º8çš„è®°å½•ï¼Œå¯¹å‘¨å›´çš„æ•°æ®æ²¡æœ‰å½±å“ã€‚</p><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220713164811567.png" class=""> <p>ä¸¾ä¾‹å¦‚ä¸‹ï¼š</p><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220713164948405.png" class=""> <p>è®°å½•é”æ˜¯æœ‰Sé”å’ŒXé”ä¹‹åˆ†çš„ï¼Œç§°ä¹‹ä¸º <code>Så‹è®°å½•é”</code> å’Œ <code>Xå‹è®°å½•é”</code> ã€‚</p><ul><li>å½“ä¸€ä¸ªäº‹åŠ¡è·å–äº†ä¸€æ¡è®°å½•çš„Så‹è®°å½•é”åï¼Œå…¶ä»–äº‹åŠ¡ä¹Ÿå¯ä»¥ç»§ç»­è·å–è¯¥è®°å½•çš„Så‹è®°å½•é”ï¼Œä½†ä¸å¯ä»¥ç»§ç»­è·å–Xå‹è®°å½•é”ï¼›</li><li>å½“ä¸€ä¸ªäº‹åŠ¡è·å–äº†ä¸€æ¡è®°å½•çš„Xå‹è®°å½•é”åï¼Œå…¶ä»–äº‹åŠ¡æ—¢ä¸å¯ä»¥ç»§ç»­è·å–è¯¥è®°å½•çš„Så‹è®°å½•é”ï¼Œä¹Ÿä¸å¯ä»¥ç»§ç»­è·å–Xå‹è®°å½•é”ã€‚</li></ul><h5 id="â‘¡-é—´éš™é”ï¼ˆGap-Locksï¼‰"><a href="#â‘¡-é—´éš™é”ï¼ˆGap-Locksï¼‰" class="headerlink" title="â‘¡ é—´éš™é”ï¼ˆGap Locksï¼‰"></a>â‘¡ é—´éš™é”ï¼ˆGap Locksï¼‰</h5><p><code>MySQL</code> åœ¨ <code>REPEATABLE READ</code> éš”ç¦»çº§åˆ«ä¸‹æ˜¯å¯ä»¥è§£å†³å¹»è¯»é—®é¢˜çš„ï¼Œè§£å†³æ–¹æ¡ˆæœ‰ä¸¤ç§ï¼Œå¯ä»¥ä½¿ç”¨ <code>MVCC</code> æ–¹ æ¡ˆè§£å†³ï¼Œä¹Ÿå¯ä»¥é‡‡ç”¨ <code>åŠ é” </code>æ–¹æ¡ˆè§£å†³ã€‚ä½†æ˜¯åœ¨ä½¿ç”¨åŠ é”æ–¹æ¡ˆè§£å†³æ—¶æœ‰ä¸ªå¤§é—®é¢˜ï¼Œå°±æ˜¯äº‹åŠ¡åœ¨ç¬¬ä¸€æ¬¡æ‰§è¡Œè¯»å–æ“ä½œæ—¶ï¼Œé‚£äº›å¹»å½±è®°å½•å°šä¸å­˜åœ¨ï¼Œæˆ‘ä»¬æ— æ³•ç»™è¿™äº› <code>å¹»å½±è®°å½•</code> åŠ ä¸Š <code>è®°å½•é”</code> ã€‚InnoDBæå‡ºäº†ä¸€ç§ç§°ä¹‹ä¸º <code>Gap Locks</code> çš„é”ï¼Œå®˜æ–¹çš„ç±»å‹åç§°ä¸ºï¼š<code> LOCK_GAP</code> ï¼Œæˆ‘ä»¬å¯ä»¥ç®€ç§°ä¸º <code>gapé”</code> ã€‚æ¯”å¦‚ï¼ŒæŠŠidå€¼ä¸º8çš„é‚£æ¡ è®°å½•åŠ ä¸€ä¸ªgapé”çš„ç¤ºæ„å›¾å¦‚ä¸‹ã€‚</p><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220713171650888.png" class=""> <p>å›¾ä¸­idå€¼ä¸º8çš„è®°å½•åŠ äº†gapé”ï¼Œæ„å‘³ç€ <code>ä¸å…è®¸åˆ«çš„äº‹åŠ¡åœ¨idå€¼ä¸º8çš„è®°å½•å‰è¾¹çš„é—´éš™æ’å…¥æ–°è®°å½•</code> ï¼Œå…¶å®å°±æ˜¯ idåˆ—çš„å€¼(3, 8)è¿™ä¸ªåŒºé—´çš„æ–°è®°å½•æ˜¯ä¸å…è®¸ç«‹å³æ’å…¥çš„ã€‚æ¯”å¦‚ï¼Œæœ‰å¦å¤–ä¸€ä¸ªäº‹åŠ¡å†æƒ³æ’å…¥ä¸€æ¡idå€¼ä¸º4çš„æ–° è®°å½•ï¼Œå®ƒå®šä½åˆ°è¯¥æ¡æ–°è®°å½•çš„ä¸‹ä¸€æ¡è®°å½•çš„idå€¼ä¸º8ï¼Œè€Œè¿™æ¡è®°å½•ä¸Šåˆæœ‰ä¸€ä¸ªgapé”ï¼Œæ‰€ä»¥å°±ä¼šé˜»å¡æ’å…¥ æ“ä½œï¼Œç›´åˆ°æ‹¥æœ‰è¿™ä¸ªgapé”çš„äº‹åŠ¡æäº¤äº†ä¹‹åï¼Œidåˆ—çš„å€¼åœ¨åŒºé—´(3, 8)ä¸­çš„æ–°è®°å½•æ‰å¯ä»¥è¢«æ’å…¥ã€‚</p><p><strong>gapé”çš„æå‡ºä»…ä»…æ˜¯ä¸ºäº†é˜²æ­¢æ’å…¥å¹»å½±è®°å½•è€Œæå‡ºçš„ã€‚</strong>è™½ç„¶æœ‰<code>å…±äº«gapé”</code>å’Œ<code>ç‹¬å gapé”</code>è¿™æ ·çš„è¯´æ³•ï¼Œä½†æ˜¯å®ƒä»¬èµ·åˆ°çš„ä½œç”¨æ˜¯ç›¸åŒçš„ã€‚è€Œä¸”å¦‚æœå¯¹ä¸€æ¡è®°å½•åŠ äº†gapé”ï¼ˆä¸è®ºæ˜¯å…±äº«gapé”è¿˜æ˜¯ç‹¬å gapé”ï¼‰ï¼Œå¹¶ä¸ä¼šé™åˆ¶å…¶ä»–äº‹åŠ¡å¯¹è¿™æ¡è®°å½•åŠ è®°å½•é”æˆ–è€…ç»§ç»­åŠ gapé”ã€‚</p><p><strong>ä¸¾ä¾‹ï¼š</strong></p><table><thead><tr><th>Session1</th><th>Session2</th></tr></thead><tbody><tr><td>select * from student where id&#x3D;5 lock in share mode;</td><td></td></tr><tr><td></td><td>select * from student where id&#x3D;5 for update;</td></tr></tbody></table><p>è¿™é‡Œsession2å¹¶ä¸ä¼šè¢«å µä½ã€‚å› ä¸ºè¡¨é‡Œå¹¶æ²¡æœ‰id&#x3D;5è¿™æ¡è®°å½•ï¼Œå› æ­¤session1å˜‰çš„æ˜¯é—´éš™é”(3,8)ã€‚è€Œsession2ä¹Ÿæ˜¯åœ¨è¿™ä¸ªé—´éš™åŠ çš„é—´éš™é”ã€‚å®ƒä»¬æœ‰å…±åŒçš„ç›®æ ‡ï¼Œå³ï¼šä¿æŠ¤è¿™ä¸ªé—´éš™é”ï¼Œä¸å…è®¸æ’å…¥å€¼ã€‚ä½†ï¼Œå®ƒä»¬ä¹‹é—´æ˜¯ä¸å†²çªçš„ã€‚</p><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220713174726264.png" class=""><ul><li><code>Infimum</code>è®°å½•ï¼Œè¡¨ç¤ºè¯¥é¡µé¢ä¸­æœ€å°çš„è®°å½•ã€‚</li><li><code>Supremun</code>è®°å½•ï¼Œè¡¨ç¤ºè¯¥é¡µé¢ä¸­æœ€å¤§çš„è®°å½•ã€‚</li></ul><p>ä¸ºäº†å®ç°é˜»æ­¢å…¶ä»–äº‹åŠ¡æ’å…¥idå€¼å†(20,æ­£æ— ç©·)è¿™ä¸ªåŒºé—´çš„æ–°çºªå½•ï¼Œæˆ‘ä»¬å¯ä»¥ç»™ç´¢å¼•ä¸­çš„æœ€åä¸€æ¡è®°å½•ï¼Œä¹Ÿå°±æ˜¯idå€¼ä¸º20çš„é‚£æ¡è®°å½•æ‰€åœ¨é¡µé¢çš„Supremunè®°å½•åŠ ä¸Šä¸€ä¸ªgapé”ï¼Œå¦‚å›¾æ‰€ç¤ºã€‚</p><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220713174108634.png" class=""> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from student where id &gt; 20 lock in share mode;</span><br><span class="line">Empty set (0.01 sec)</span><br></pre></td></tr></table></figure><p>æ£€æµ‹ï¼š</p><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220713174551814.png" class=""> <img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220713174602102.png" class=""> <img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220713175032619.png" class=""><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220713192418730.png" class=""><h5 id="â‘¢-ä¸´é”®é”ï¼ˆNext-Key-Locksï¼‰"><a href="#â‘¢-ä¸´é”®é”ï¼ˆNext-Key-Locksï¼‰" class="headerlink" title="â‘¢ ä¸´é”®é”ï¼ˆNext-Key Locksï¼‰"></a>â‘¢ ä¸´é”®é”ï¼ˆNext-Key Locksï¼‰</h5><p>æœ‰æ—¶å€™æˆ‘ä»¬æ—¢æƒ³ <code>é”ä½æŸæ¡è®°å½•</code> ï¼Œåˆæƒ³ é˜»æ­¢ å…¶ä»–äº‹åŠ¡åœ¨è¯¥è®°å½•å‰è¾¹çš„ é—´éš™æ’å…¥æ–°è®°å½• ï¼Œæ‰€ä»¥InnoDBå°±æ å‡ºäº†ä¸€ç§ç§°ä¹‹ä¸º Next-Key Locks çš„é”ï¼Œå®˜æ–¹çš„ç±»å‹åç§°ä¸ºï¼š LOCK_ORDINARY ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ç®€ç§°ä¸º next-keyé” ã€‚Next-Key Locksæ˜¯åœ¨å­˜å‚¨å¼•æ“ innodb ã€äº‹åŠ¡çº§åˆ«åœ¨ å¯é‡å¤è¯» çš„æƒ…å†µä¸‹ä½¿ç”¨çš„æ•°æ®åº“é”ï¼Œ innodbé»˜è®¤çš„é”å°±æ˜¯Next-Key locksã€‚æ¯”å¦‚ï¼Œæˆ‘ä»¬æŠŠidå€¼ä¸º8çš„é‚£æ¡è®°å½•åŠ ä¸€ä¸ªnext-keyé”çš„ç¤ºæ„å›¾å¦‚ä¸‹ï¼š</p><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220713192549340.png" class=""> <p><code>next-keyé”</code>çš„æœ¬è´¨å°±æ˜¯ä¸€ä¸ª<code>è®°å½•é”</code>å’Œä¸€ä¸ª<code>gapé”</code>çš„åˆä½“ï¼Œå®ƒæ—¢èƒ½ä¿æŠ¤è¯¥æ¡è®°å½•ï¼Œåˆèƒ½é˜»æ­¢åˆ«çš„äº‹åŠ¡å°†æ–°è®°å½•æ’å…¥è¢«ä¿æŠ¤è®°å½•å‰è¾¹çš„<code>é—´éš™</code>ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">begin;</span><br><span class="line">select * from student where id &lt;=8 and id &gt; 3 for update;</span><br></pre></td></tr></table></figure><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220713203124889.png" class=""><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220713203532124.png" class=""><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220713203619704.png" class=""><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220713203714577.png" class=""><h4 id="3-é¡µé”"><a href="#3-é¡µé”" class="headerlink" title="3. é¡µé”"></a>3. é¡µé”</h4><p>é¡µé”å°±æ˜¯åœ¨ <code>é¡µçš„ç²’åº¦</code> ä¸Šè¿›è¡Œé”å®šï¼Œé”å®šçš„æ•°æ®èµ„æºæ¯”è¡Œé”è¦å¤šï¼Œå› ä¸ºä¸€ä¸ªé¡µä¸­å¯ä»¥æœ‰å¤šä¸ªè¡Œè®°å½•ã€‚å½“æˆ‘ ä»¬ä½¿ç”¨é¡µé”çš„æ—¶å€™ï¼Œä¼šå‡ºç°æ•°æ®æµªè´¹çš„ç°è±¡ï¼Œä½†è¿™æ ·çš„æµªè´¹æœ€å¤šä¹Ÿå°±æ˜¯ä¸€ä¸ªé¡µä¸Šçš„æ•°æ®è¡Œã€‚<strong>é¡µé”çš„å¼€é”€ä»‹äºè¡¨é”å’Œè¡Œé”ä¹‹é—´ï¼Œä¼šå‡ºç°æ­»é”ã€‚é”å®šç²’åº¦ä»‹äºè¡¨é”å’Œè¡Œé”ä¹‹é—´ï¼Œå¹¶å‘åº¦ä¸€èˆ¬ã€‚</strong></p><p>æ¯ä¸ªå±‚çº§çš„é”æ•°é‡æ˜¯æœ‰é™åˆ¶çš„ï¼Œå› ä¸ºé”ä¼šå ç”¨å†…å­˜ç©ºé—´ï¼Œ <code>é”ç©ºé—´çš„å¤§å°æ˜¯æœ‰é™çš„</code> ã€‚å½“æŸä¸ªå±‚çº§çš„é”æ•°é‡ è¶…è¿‡äº†è¿™ä¸ªå±‚çº§çš„é˜ˆå€¼æ—¶ï¼Œå°±ä¼šè¿›è¡Œ <code>é”å‡çº§</code> ã€‚é”å‡çº§å°±æ˜¯ç”¨æ›´å¤§ç²’åº¦çš„é”æ›¿ä»£å¤šä¸ªæ›´å°ç²’åº¦çš„é”ï¼Œæ¯”å¦‚ InnoDB ä¸­è¡Œé”å‡çº§ä¸ºè¡¨é”ï¼Œè¿™æ ·åšçš„å¥½å¤„æ˜¯å ç”¨çš„é”ç©ºé—´é™ä½äº†ï¼Œä½†åŒæ—¶æ•°æ®çš„å¹¶å‘åº¦ä¹Ÿä¸‹é™äº†ã€‚</p><h3 id="3-3-ä»å¯¹å¾…é”çš„æ€åº¦åˆ’åˆ†-ä¹è§‚é”ã€æ‚²è§‚é”"><a href="#3-3-ä»å¯¹å¾…é”çš„æ€åº¦åˆ’åˆ†-ä¹è§‚é”ã€æ‚²è§‚é”" class="headerlink" title="3.3 ä»å¯¹å¾…é”çš„æ€åº¦åˆ’åˆ†:ä¹è§‚é”ã€æ‚²è§‚é”"></a>3.3 ä»å¯¹å¾…é”çš„æ€åº¦åˆ’åˆ†:ä¹è§‚é”ã€æ‚²è§‚é”</h3><p>ä»å¯¹å¾…é”çš„æ€åº¦æ¥çœ‹é”çš„è¯ï¼Œå¯ä»¥å°†é”åˆ†æˆä¹è§‚é”å’Œæ‚²è§‚é”ï¼Œä»åå­—ä¸­ä¹Ÿå¯ä»¥çœ‹å‡ºè¿™ä¸¤ç§é”æ˜¯ä¸¤ç§çœ‹å¾… <code>æ•°æ®å¹¶å‘çš„æ€ç»´æ–¹å¼</code> ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¹è§‚é”å’Œæ‚²è§‚é”å¹¶ä¸æ˜¯é”ï¼Œè€Œæ˜¯é”çš„ <code>è®¾è®¡æ€æƒ³</code> ã€‚</p><h4 id="1-æ‚²è§‚é”ï¼ˆPessimistic-Lockingï¼‰"><a href="#1-æ‚²è§‚é”ï¼ˆPessimistic-Lockingï¼‰" class="headerlink" title="1. æ‚²è§‚é”ï¼ˆPessimistic Lockingï¼‰"></a>1. æ‚²è§‚é”ï¼ˆPessimistic Lockingï¼‰</h4><p>æ‚²è§‚é”æ˜¯ä¸€ç§æ€æƒ³ï¼Œé¡¾åæ€ä¹‰ï¼Œå°±æ˜¯å¾ˆæ‚²è§‚ï¼Œå¯¹æ•°æ®è¢«å…¶ä»–äº‹åŠ¡çš„ä¿®æ”¹æŒä¿å®ˆæ€åº¦ï¼Œä¼šé€šè¿‡æ•°æ®åº“è‡ªèº«çš„é”æœºåˆ¶æ¥å®ç°ï¼Œä»è€Œä¿è¯æ•°æ®æ“ä½œçš„æ’å®ƒæ€§ã€‚</p><p>æ‚²è§‚é”æ€»æ˜¯å‡è®¾æœ€åçš„æƒ…å†µï¼Œæ¯æ¬¡å»æ‹¿æ•°æ®çš„æ—¶å€™éƒ½è®¤ä¸ºåˆ«äººä¼šä¿®æ”¹ï¼Œæ‰€ä»¥æ¯æ¬¡åœ¨æ‹¿æ•°æ®çš„æ—¶å€™éƒ½ä¼šä¸Šé”ï¼Œè¿™æ ·åˆ«äººæƒ³æ‹¿è¿™ä¸ªæ•°æ®å°±ä¼š <code>é˜»å¡</code> ç›´åˆ°å®ƒæ‹¿åˆ°é”ï¼ˆ<strong>å…±äº«èµ„æºæ¯æ¬¡åªç»™ä¸€ä¸ªçº¿ç¨‹ä½¿ç”¨ï¼Œå…¶å®ƒçº¿ç¨‹é˜»å¡ï¼Œ ç”¨å®Œåå†æŠŠèµ„æºè½¬è®©ç»™å…¶å®ƒçº¿ç¨‹</strong>ï¼‰ã€‚æ¯”å¦‚è¡Œé”ï¼Œè¡¨é”ç­‰ï¼Œè¯»é”ï¼Œå†™é”ç­‰ï¼Œéƒ½æ˜¯åœ¨åšæ“ä½œä¹‹å‰å…ˆä¸Šé”ï¼Œå½“å…¶ä»–çº¿ç¨‹æƒ³è¦è®¿é—®æ•°æ®æ—¶ï¼Œéƒ½éœ€è¦é˜»å¡æŒ‚èµ·ã€‚Javaä¸­ <code>synchronized</code> å’Œ <code>ReentrantLock</code> ç­‰ç‹¬å é”å°±æ˜¯æ‚²è§‚é”æ€æƒ³çš„å®ç°ã€‚</p><p><strong>ç§’æ€æ¡ˆä¾‹1ï¼š</strong></p><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220713204544767.png" class=""><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220713205010502.png" class=""><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220713205135694.png" class=""><h4 id="2-ä¹è§‚é”ï¼ˆOptimistic-Lockingï¼‰"><a href="#2-ä¹è§‚é”ï¼ˆOptimistic-Lockingï¼‰" class="headerlink" title="2. ä¹è§‚é”ï¼ˆOptimistic Lockingï¼‰"></a>2. ä¹è§‚é”ï¼ˆOptimistic Lockingï¼‰</h4><p>ä¹è§‚é”è®¤ä¸ºå¯¹åŒä¸€æ•°æ®çš„å¹¶å‘æ“ä½œä¸ä¼šæ€»å‘ç”Ÿï¼Œå±äºå°æ¦‚ç‡äº‹ä»¶ï¼Œä¸ç”¨æ¯æ¬¡éƒ½å¯¹æ•°æ®ä¸Šé”ï¼Œä½†æ˜¯åœ¨æ›´æ–°çš„æ—¶å€™ä¼šåˆ¤æ–­ä¸€ä¸‹åœ¨æ­¤æœŸé—´åˆ«äººæœ‰æ²¡æœ‰å»æ›´æ–°è¿™ä¸ªæ•°æ®ï¼Œä¹Ÿå°±æ˜¯<strong>ä¸é‡‡ç”¨æ•°æ®åº“è‡ªèº«çš„é”æœºåˆ¶ï¼Œè€Œæ˜¯é€šè¿‡ç¨‹åºæ¥å®ç°</strong>ã€‚åœ¨ç¨‹åºä¸Šï¼Œæˆ‘ä»¬å¯ä»¥é‡‡ç”¨ <code>ç‰ˆæœ¬å·æœºåˆ¶</code> æˆ–è€… <code>CASæœºåˆ¶</code> å®ç°ã€‚<strong>ä¹è§‚é”é€‚ç”¨äºå¤šè¯»çš„åº”ç”¨ç±»å‹ï¼Œ è¿™æ ·å¯ä»¥æé«˜ååé‡</strong>ã€‚åœ¨Javaä¸­<code> java.util.concurrent.atomic</code> åŒ…ä¸‹çš„åŸå­å˜é‡ç±»å°±æ˜¯ä½¿ç”¨äº†ä¹è§‚é”çš„ä¸€ç§å®ç°æ–¹å¼ï¼šCASå®ç°çš„ã€‚</p><p><strong>1. ä¹è§‚é”çš„ç‰ˆæœ¬å·æœºåˆ¶</strong></p><p>åœ¨è¡¨ä¸­è®¾è®¡ä¸€ä¸ª <code>ç‰ˆæœ¬å­—æ®µ version</code> ï¼Œç¬¬ä¸€æ¬¡è¯»çš„æ—¶å€™ï¼Œä¼šè·å– version å­—æ®µçš„å–å€¼ã€‚ç„¶åå¯¹æ•°æ®è¿›è¡Œæ›´æ–°æˆ–åˆ é™¤æ“ä½œæ—¶ï¼Œä¼šæ‰§è¡Œ <code>UPDATE ... SET version=version+1 WHERE version=version</code> ã€‚æ­¤æ—¶ å¦‚æœå·²ç»æœ‰äº‹åŠ¡å¯¹è¿™æ¡æ•°æ®è¿›è¡Œäº†æ›´æ”¹ï¼Œä¿®æ”¹å°±ä¸ä¼šæˆåŠŸã€‚</p><p>è¿™ç§æ–¹å¼ç±»ä¼¼æˆ‘ä»¬ç†Ÿæ‚‰çš„SVNã€CVSç‰ˆæœ¬ç®¡ç†ç³»ç»Ÿï¼Œå½“æˆ‘ä»¬ä¿®æ”¹äº†ä»£ç è¿›è¡Œæäº¤æ—¶ï¼Œé¦–å…ˆä¼šæ£€æŸ¥å½“å‰ç‰ˆæœ¬å·ä¸æœåŠ¡å™¨ä¸Šçš„ç‰ˆæœ¬å·æ˜¯å¦ä¸€è‡´ï¼Œå¦‚æœä¸€è‡´å°±å¯ä»¥ç›´æ¥æäº¤ï¼Œå¦‚æœä¸ä¸€è‡´å°±éœ€è¦æ›´æ–°æœåŠ¡å™¨ä¸Šçš„æœ€æ–°ä»£ç ï¼Œç„¶åå†è¿›è¡Œæäº¤ã€‚</p><p><strong>2. ä¹è§‚é”çš„æ—¶é—´æˆ³æœºåˆ¶</strong></p><p>æ—¶é—´æˆ³å’Œç‰ˆæœ¬å·æœºåˆ¶ä¸€æ ·ï¼Œä¹Ÿæ˜¯åœ¨æ›´æ–°æäº¤çš„æ—¶å€™ï¼Œå°†å½“å‰æ•°æ®çš„æ—¶é—´æˆ³å’Œæ›´æ–°ä¹‹å‰å–å¾—çš„æ—¶é—´æˆ³è¿›è¡Œ æ¯”è¾ƒï¼Œå¦‚æœä¸¤è€…ä¸€è‡´åˆ™æ›´æ–°æˆåŠŸï¼Œå¦åˆ™å°±æ˜¯ç‰ˆæœ¬å†²çªã€‚</p><p>ä½ èƒ½çœ‹åˆ°ä¹è§‚é”å°±æ˜¯ç¨‹åºå‘˜è‡ªå·±æ§åˆ¶æ•°æ®å¹¶å‘æ“ä½œçš„æƒé™ï¼ŒåŸºæœ¬æ˜¯é€šè¿‡ç»™æ•°æ®è¡Œå¢åŠ ä¸€ä¸ªæˆ³ï¼ˆç‰ˆæœ¬å·æˆ– è€…æ—¶é—´æˆ³ï¼‰ï¼Œä»è€Œè¯æ˜å½“å‰æ‹¿åˆ°çš„æ•°æ®æ˜¯å¦æœ€æ–°ã€‚</p><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220713210951100.png" class=""><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220713211139670.png" class=""><h4 id="3-ä¸¤ç§é”çš„é€‚ç”¨åœºæ™¯"><a href="#3-ä¸¤ç§é”çš„é€‚ç”¨åœºæ™¯" class="headerlink" title="3. ä¸¤ç§é”çš„é€‚ç”¨åœºæ™¯"></a>3. ä¸¤ç§é”çš„é€‚ç”¨åœºæ™¯</h4><p>ä»è¿™ä¸¤ç§é”çš„è®¾è®¡æ€æƒ³ä¸­ï¼Œæˆ‘ä»¬æ€»ç»“ä¸€ä¸‹ä¹è§‚é”å’Œæ‚²è§‚é”çš„é€‚ç”¨åœºæ™¯ï¼š</p><ol><li><code>ä¹è§‚é”</code> é€‚åˆ <code>è¯»æ“ä½œå¤š</code> çš„åœºæ™¯ï¼Œç›¸å¯¹æ¥è¯´å†™çš„æ“ä½œæ¯”è¾ƒå°‘ã€‚å®ƒçš„ä¼˜ç‚¹åœ¨äº <code>ç¨‹åºå®ç°</code> ï¼Œ <code>ä¸å­˜åœ¨æ­»é”</code> é—®é¢˜ï¼Œä¸è¿‡é€‚ç”¨åœºæ™¯ä¹Ÿä¼šç›¸å¯¹ä¹è§‚ï¼Œå› ä¸ºå®ƒé˜»æ­¢ä¸äº†é™¤äº†ç¨‹åºä»¥å¤–çš„æ•°æ®åº“æ“ä½œã€‚</li><li><code>æ‚²è§‚é”</code> é€‚åˆ <code>å†™æ“ä½œå¤š</code> çš„åœºæ™¯ï¼Œå› ä¸ºå†™çš„æ“ä½œå…·æœ‰ <code>æ’å®ƒæ€§</code> ã€‚é‡‡ç”¨æ‚²è§‚é”çš„æ–¹å¼ï¼Œå¯ä»¥åœ¨æ•°æ®åº“å±‚ é¢é˜»æ­¢å…¶ä»–äº‹åŠ¡å¯¹è¯¥æ•°æ®çš„æ“ä½œæƒé™ï¼Œé˜²æ­¢ <code>è¯» - å†™</code> å’Œ <code>å†™ - å†™</code> çš„å†²çªã€‚</li></ol><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220713211417909.png" class=""><h3 id="3-4-æŒ‰åŠ é”çš„æ–¹å¼åˆ’åˆ†ï¼šæ˜¾å¼é”ã€éšå¼é”"><a href="#3-4-æŒ‰åŠ é”çš„æ–¹å¼åˆ’åˆ†ï¼šæ˜¾å¼é”ã€éšå¼é”" class="headerlink" title="3.4 æŒ‰åŠ é”çš„æ–¹å¼åˆ’åˆ†ï¼šæ˜¾å¼é”ã€éšå¼é”"></a>3.4 æŒ‰åŠ é”çš„æ–¹å¼åˆ’åˆ†ï¼šæ˜¾å¼é”ã€éšå¼é”</h3><h4 id="1-éšå¼é”"><a href="#1-éšå¼é”" class="headerlink" title="1. éšå¼é”"></a>1. éšå¼é”</h4><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220713211525845.png" class=""><ul><li><strong>æƒ…æ™¯ä¸€</strong>ï¼šå¯¹äºèšç°‡ç´¢å¼•è®°å½•æ¥è¯´ï¼Œæœ‰ä¸€ä¸ª <code>trx_id</code> éšè—åˆ—ï¼Œè¯¥éšè—åˆ—è®°å½•ç€æœ€åæ”¹åŠ¨è¯¥è®°å½•çš„ <code>äº‹åŠ¡ id</code> ã€‚é‚£ä¹ˆå¦‚æœåœ¨å½“å‰äº‹åŠ¡ä¸­æ–°æ’å…¥ä¸€æ¡èšç°‡ç´¢å¼•è®°å½•åï¼Œè¯¥è®°å½•çš„ trx_id éšè—åˆ—ä»£è¡¨çš„çš„å°±æ˜¯ å½“å‰äº‹åŠ¡çš„ äº‹åŠ¡id ï¼Œå¦‚æœå…¶ä»–äº‹åŠ¡æ­¤æ—¶æƒ³å¯¹è¯¥è®°å½•æ·»åŠ  Sé” æˆ–è€… Xé” æ—¶ï¼Œé¦–å…ˆä¼šçœ‹ä¸€ä¸‹è¯¥è®°å½•çš„ trx_id éšè—åˆ—ä»£è¡¨çš„äº‹åŠ¡æ˜¯å¦æ˜¯å½“å‰çš„æ´»è·ƒäº‹åŠ¡ï¼Œå¦‚æœæ˜¯çš„è¯ï¼Œé‚£ä¹ˆå°±å¸®åŠ©å½“å‰äº‹åŠ¡åˆ›å»ºä¸€ä¸ª X é” ï¼ˆä¹Ÿå°±æ˜¯ä¸ºå½“å‰äº‹åŠ¡åˆ›å»ºä¸€ä¸ªé”ç»“æ„ï¼Œ is_waiting å±æ€§æ˜¯ false ï¼‰ï¼Œç„¶åè‡ªå·±è¿›å…¥ç­‰å¾…çŠ¶æ€ ï¼ˆä¹Ÿå°±æ˜¯ä¸ºè‡ªå·±ä¹Ÿåˆ›å»ºä¸€ä¸ªé”ç»“æ„ï¼Œ is_waiting å±æ€§æ˜¯ true ï¼‰ã€‚</li><li><strong>æƒ…æ™¯äºŒ</strong>ï¼šå¯¹äºäºŒçº§ç´¢å¼•è®°å½•æ¥è¯´ï¼Œæœ¬èº«å¹¶æ²¡æœ‰ trx_id éšè—åˆ—ï¼Œä½†æ˜¯åœ¨äºŒçº§ç´¢å¼•é¡µé¢çš„ Page Header éƒ¨åˆ†æœ‰ä¸€ä¸ª <code>PAGE_MAX_TRX_ID</code> å±æ€§ï¼Œè¯¥å±æ€§ä»£è¡¨å¯¹è¯¥é¡µé¢åšæ”¹åŠ¨çš„æœ€å¤§çš„ <code>äº‹åŠ¡id</code> ï¼Œå¦‚ æœ PAGE_MAX_TRX_ID å±æ€§å€¼å°äºå½“å‰æœ€å°çš„æ´»è·ƒ äº‹åŠ¡id ï¼Œé‚£ä¹ˆè¯´æ˜å¯¹è¯¥é¡µé¢åšä¿®æ”¹çš„äº‹åŠ¡éƒ½å·² ç»æäº¤äº†ï¼Œå¦åˆ™å°±éœ€è¦åœ¨é¡µé¢ä¸­å®šä½åˆ°å¯¹åº”çš„äºŒçº§ç´¢å¼•è®°å½•ï¼Œç„¶åå›è¡¨æ‰¾åˆ°å®ƒå¯¹åº”çš„èšç°‡ç´¢å¼•è®° å½•ï¼Œç„¶åå†é‡å¤ æƒ…æ™¯ä¸€ çš„åšæ³•ã€‚</li></ul><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220713214522709.png" class=""><p><strong>session 1:</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; begin;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line">mysql&gt; insert INTO student VALUES(34,&quot;å‘¨å…«&quot;,&quot;äºŒç­&quot;);</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br></pre></td></tr></table></figure><p><strong>session 2:</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; begin;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line">mysql&gt; select * from student lock in share mode; #æ‰§è¡Œå®Œï¼Œå½“å‰äº‹åŠ¡è¢«é˜»å¡</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œä¸‹è¿°è¯­å¥ï¼Œè¾“å‡ºç»“æœï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT * FROM performance_schema.data_lock_waits\G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">ENGINE: INNODB</span><br><span class="line">REQUESTING_ENGINE_LOCK_ID: 140562531358232:7:4:9:140562535668584</span><br><span class="line">REQUESTING_ENGINE_TRANSACTION_ID: 422037508068888</span><br><span class="line">REQUESTING_THREAD_ID: 64</span><br><span class="line">REQUESTING_EVENT_ID: 6</span><br><span class="line">REQUESTING_OBJECT_INSTANCE_BEGIN: 140562535668584</span><br><span class="line">BLOCKING_ENGINE_LOCK_ID: 140562531351768:7:4:9:140562535619104</span><br><span class="line">BLOCKING_ENGINE_TRANSACTION_ID: 15902</span><br><span class="line">BLOCKING_THREAD_ID: 64</span><br><span class="line">BLOCKING_EVENT_ID: 6</span><br><span class="line">BLOCKING_OBJECT_INSTANCE_BEGIN: 140562535619104</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure><p>éšå¼é”çš„é€»è¾‘è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><p>A. InnoDBçš„æ¯æ¡è®°å½•ä¸­éƒ½ä¸€ä¸ªéšå«çš„trx_idå­—æ®µï¼Œè¿™ä¸ªå­—æ®µå­˜åœ¨äºèšç°‡ç´¢å¼•çš„B+Treeä¸­ã€‚ </p><p>B. åœ¨æ“ä½œä¸€æ¡è®°å½•å‰ï¼Œé¦–å…ˆæ ¹æ®è®°å½•ä¸­çš„trx_idæ£€æŸ¥è¯¥äº‹åŠ¡æ˜¯å¦æ˜¯æ´»åŠ¨çš„äº‹åŠ¡(æœªæäº¤æˆ–å›æ»š)ã€‚å¦‚æœæ˜¯æ´»åŠ¨çš„äº‹åŠ¡ï¼Œé¦–å…ˆå°† <code>éšå¼é”</code> è½¬æ¢ä¸º <code>æ˜¾å¼é”</code> (å°±æ˜¯ä¸ºè¯¥äº‹åŠ¡æ·»åŠ ä¸€ä¸ªé”)ã€‚ </p><p>C. æ£€æŸ¥æ˜¯å¦æœ‰é”å†²çªï¼Œå¦‚æœæœ‰å†²çªï¼Œåˆ›å»ºé”ï¼Œå¹¶è®¾ç½®ä¸ºwaitingçŠ¶æ€ã€‚å¦‚æœæ²¡æœ‰å†²çªä¸åŠ é”ï¼Œè·³åˆ°Eã€‚ </p><p>D. ç­‰å¾…åŠ é”æˆåŠŸï¼Œè¢«å”¤é†’ï¼Œæˆ–è€…è¶…æ—¶ã€‚ </p><p>E. å†™æ•°æ®ï¼Œå¹¶å°†è‡ªå·±çš„trx_idå†™å…¥trx_idå­—æ®µã€‚</p><h4 id="2-æ˜¾å¼é”"><a href="#2-æ˜¾å¼é”" class="headerlink" title="2. æ˜¾å¼é”"></a>2. æ˜¾å¼é”</h4><p>é€šè¿‡ç‰¹å®šçš„è¯­å¥è¿›è¡ŒåŠ é”ï¼Œæˆ‘ä»¬ä¸€èˆ¬ç§°ä¹‹ä¸ºæ˜¾ç¤ºåŠ é”ï¼Œä¾‹å¦‚ï¼š</p><p>æ˜¾ç¤ºåŠ å…±äº«é”ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select .... lock in share mode</span><br></pre></td></tr></table></figure><p>æ˜¾ç¤ºåŠ æ’å®ƒé”ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select .... for update</span><br></pre></td></tr></table></figure><h3 id="3-5-å…¶å®ƒé”ä¹‹ï¼šå…¨å±€é”"><a href="#3-5-å…¶å®ƒé”ä¹‹ï¼šå…¨å±€é”" class="headerlink" title="3.5 å…¶å®ƒé”ä¹‹ï¼šå…¨å±€é”"></a>3.5 å…¶å®ƒé”ä¹‹ï¼šå…¨å±€é”</h3><p>å…¨å±€é”å°±æ˜¯å¯¹ <code>æ•´ä¸ªæ•°æ®åº“å®ä¾‹</code> åŠ é”ã€‚å½“ä½ éœ€è¦è®©æ•´ä¸ªåº“å¤„äº <code>åªè¯»çŠ¶æ€</code> çš„æ—¶å€™ï¼Œå¯ä»¥ä½¿ç”¨è¿™ä¸ªå‘½ä»¤ï¼Œä¹‹å å…¶ä»–çº¿ç¨‹çš„ä»¥ä¸‹è¯­å¥ä¼šè¢«é˜»å¡ï¼šæ•°æ®æ›´æ–°è¯­å¥ï¼ˆæ•°æ®çš„å¢åˆ æ”¹ï¼‰ã€æ•°æ®å®šä¹‰è¯­å¥ï¼ˆåŒ…æ‹¬å»ºè¡¨ã€ä¿®æ”¹è¡¨ç»“ æ„ç­‰ï¼‰å’Œæ›´æ–°ç±»äº‹åŠ¡çš„æäº¤è¯­å¥ã€‚å…¨å±€é”çš„å…¸å‹ä½¿ç”¨ <code>åœºæ™¯</code> æ˜¯ï¼šåš <code>å…¨åº“é€»è¾‘å¤‡ä»½</code> ã€‚</p><p>å…¨å±€é”çš„å‘½ä»¤ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Flush tables with read lock</span><br></pre></td></tr></table></figure><h3 id="3-6-å…¶å®ƒé”ä¹‹ï¼šæ­»é”"><a href="#3-6-å…¶å®ƒé”ä¹‹ï¼šæ­»é”" class="headerlink" title="3.6 å…¶å®ƒé”ä¹‹ï¼šæ­»é”"></a>3.6 å…¶å®ƒé”ä¹‹ï¼šæ­»é”</h3><h4 id="1-æ¦‚å¿µ"><a href="#1-æ¦‚å¿µ" class="headerlink" title="1. æ¦‚å¿µ"></a>1. æ¦‚å¿µ</h4><p>ä¸¤ä¸ªäº‹åŠ¡éƒ½æŒæœ‰å¯¹æ–¹éœ€è¦çš„é”ï¼Œå¹¶ä¸”åœ¨ç­‰å¾…å¯¹æ–¹é‡Šæ”¾ï¼Œå¹¶ä¸”åŒæ–¹éƒ½ä¸ä¼šé‡Šæ”¾è‡ªå·±çš„é”ã€‚</p><p><strong>ä¸¾ä¾‹1ï¼š</strong></p><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220713220714098.png" class=""> <p><strong>ä¸¾ä¾‹2ï¼š</strong></p><p>ç”¨æˆ·Aç»™ç”¨æˆ·Bè½¬è´¦100ï¼Œå†æ¬¡åŒæ—¶ï¼Œç”¨æˆ·Bä¹Ÿç»™ç”¨æˆ·Aè½¬è´¦100ã€‚è¿™ä¸ªè¿‡ç¨‹ï¼Œå¯èƒ½å¯¼è‡´æ­»é”ã€‚</p><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220713220936236.png" class=""><h4 id="2-äº§ç”Ÿæ­»é”çš„å¿…è¦æ¡ä»¶"><a href="#2-äº§ç”Ÿæ­»é”çš„å¿…è¦æ¡ä»¶" class="headerlink" title="2. äº§ç”Ÿæ­»é”çš„å¿…è¦æ¡ä»¶"></a>2. äº§ç”Ÿæ­»é”çš„å¿…è¦æ¡ä»¶</h4><ol><li>ä¸¤ä¸ªæˆ–è€…ä¸¤ä¸ªä»¥ä¸Šäº‹åŠ¡</li><li>æ¯ä¸ªäº‹åŠ¡éƒ½å·²ç»æŒæœ‰é”å¹¶ä¸”ç”³è¯·æ–°çš„é”</li><li>é”èµ„æºåŒæ—¶åªèƒ½è¢«åŒä¸€ä¸ªäº‹åŠ¡æŒæœ‰æˆ–è€…ä¸å…¼å®¹</li><li>äº‹åŠ¡ä¹‹é—´å› ä¸ºæŒæœ‰é”å’Œç”³è¯·é”å¯¼è‡´å½¼æ­¤å¾ªç¯ç­‰å¾…</li></ol><blockquote><p>æ­»é”çš„å…³é”®åœ¨äºï¼šä¸¤ä¸ªï¼ˆæˆ–ä»¥ä¸Šï¼‰çš„SessionåŠ é”çš„é¡ºåºä¸ä¸€è‡´ã€‚</p></blockquote><h4 id="3-å¦‚ä½•å¤„ç†æ­»é”"><a href="#3-å¦‚ä½•å¤„ç†æ­»é”" class="headerlink" title="3. å¦‚ä½•å¤„ç†æ­»é”"></a>3. å¦‚ä½•å¤„ç†æ­»é”</h4><p><strong>æ–¹å¼1ï¼š</strong>ç­‰å¾…ï¼Œç›´åˆ°è¶…æ—¶ï¼ˆinnodb_lock_wait_timeout&#x3D;50s)</p><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220713221418100.png" class=""><p><strong>æ–¹å¼2ï¼š</strong>ä½¿ç”¨æ­»é”æ£€æµ‹å¤„ç†æ­»é”ç¨‹åº</p><p>æ–¹å¼1æ£€æµ‹æ­»é”å¤ªè¿‡è¢«åŠ¨ï¼Œinnodbè¿˜æä¾›äº†<code>wait-for graphç®—æ³•</code>æ¥ä¸»åŠ¨è¿›è¡Œæ­»é”æ£€æµ‹ï¼Œæ¯å½“åŠ é”è¯·æ±‚æ— æ³•ç«‹å³æ»¡è¶³éœ€è¦å¹¶è¿›å…¥ç­‰å¾…æ—¶ï¼Œwait-for graphç®—æ³•éƒ½ä¼šè¢«è§¦å‘ã€‚</p><p>è¿™æ˜¯ä¸€ç§è¾ƒä¸º<code>ä¸»åŠ¨çš„æ­»é”æ£€æµ‹æœºåˆ¶</code>ï¼Œè¦æ±‚æ•°æ®åº“ä¿å­˜<code>é”çš„ä¿¡æ¯é“¾è¡¨</code>å’Œ<code>äº‹ç‰©ç­‰å¾…é“¾è¡¨</code>ä¸¤éƒ¨åˆ†ä¿¡æ¯ã€‚</p><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220713221758941.png" class=""> <p>åŸºäºè¿™ä¸¤ä¸ªä¿¡æ¯ï¼Œå¯ä»¥ç»˜åˆ¶wait-for graphï¼ˆç­‰å¾…å›¾ï¼‰</p><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220713221830455.png" class=""> <blockquote><p>æ­»é”æ£€æµ‹çš„åŸç†æ˜¯æ„å»ºä¸€ä¸ªä»¥äº‹åŠ¡ä¸ºé¡¶ç‚¹ï¼Œé”ä¸ºè¾¹çš„æœ‰å‘å›¾ï¼Œåˆ¤æ–­æœ‰å‘å›¾æ˜¯å¦å­˜åœ¨ç¯ï¼Œå­˜åœ¨æ—¢æœ‰æ­»é”ã€‚</p></blockquote><p>ä¸€æ—¦æ£€æµ‹åˆ°å›è·¯ã€æœ‰æ­»é”ï¼Œè¿™æ—¶å€™InnoDBå­˜å‚¨å¼•æ“ä¼šé€‰æ‹©<code>å›æ»šundoé‡æœ€å°çš„äº‹åŠ¡</code>ï¼Œè®©å…¶ä»–äº‹åŠ¡ç»§ç»­æ‰§è¡Œï¼ˆ<code>innodb_deadlock_detect=on</code>è¡¨ç¤ºå¼€å¯è¿™ä¸ªé€»è¾‘ï¼‰ã€‚</p><p>ç¼ºç‚¹ï¼šæ¯ä¸ªæ–°çš„è¢«é˜»å¡çš„çº¿ç¨‹ï¼Œéƒ½è¦åˆ¤æ–­æ˜¯ä¸æ˜¯ç”±äºè‡ªå·±çš„åŠ å…¥å¯¼è‡´äº†æ­»é”ï¼Œè¿™ä¸ªæ“ä½œæ—¶é—´å¤æ‚åº¦æ˜¯O(n)ã€‚å¦‚æœ100ä¸ªå¹¶å‘çº¿ç¨‹åŒæ—¶æ›´æ–°åŒä¸€è¡Œï¼Œæ„å‘³ç€è¦æ£€æµ‹100*100&#x3D;1ä¸‡æ¬¡ï¼Œ1ä¸‡ä¸ªçº¿ç¨‹å°±ä¼šæœ‰1åƒä¸‡æ¬¡æ£€æµ‹ã€‚</p><p><strong>å¦‚ä½•è§£å†³ï¼Ÿ</strong></p><ul><li>æ–¹å¼1ï¼šå…³é—­æ­»é”æ£€æµ‹ï¼Œä½†æ„å‘³ç€å¯èƒ½ä¼šå‡ºç°å¤§é‡çš„è¶…æ—¶ï¼Œä¼šå¯¼è‡´ä¸šåŠ¡æœ‰æŸã€‚</li><li>æ–¹å¼2ï¼šæ§åˆ¶å¹¶å‘è®¿é—®çš„æ•°é‡ã€‚æ¯”å¦‚åœ¨ä¸­é—´ä»¶ä¸­å®ç°å¯¹äºç›¸åŒè¡Œçš„æ›´æ–°ï¼Œåœ¨è¿›å…¥å¼•æ“ä¹‹å‰æ’é˜Ÿï¼Œè¿™æ ·åœ¨InnoDBå†…éƒ¨å°±ä¸ä¼šæœ‰å¤§é‡çš„æ­»é”æ£€æµ‹å·¥ä½œã€‚</li></ul><p><strong>è¿›ä¸€æ­¥çš„æ€è·¯ï¼š</strong></p><p>å¯ä»¥è€ƒè™‘é€šè¿‡å°†ä¸€è¡Œæ”¹æˆé€»è¾‘ä¸Šçš„å¤šè¡Œæ¥å‡å°‘<code>é”å†²çª</code>ã€‚æ¯”å¦‚ï¼Œè¿é”è¶…å¸‚è´¦æˆ·æ€»é¢çš„è®°å½•ï¼Œå¯ä»¥è€ƒè™‘æ”¾åˆ°å¤šæ¡è®°å½•ä¸Šã€‚è´¦æˆ·æ€»é¢ç­‰äºè¿™å¤šä¸ªè®°å½•çš„å€¼çš„æ€»å’Œã€‚</p><h4 id="4-å¦‚ä½•é¿å…æ­»é”"><a href="#4-å¦‚ä½•é¿å…æ­»é”" class="headerlink" title="4. å¦‚ä½•é¿å…æ­»é”"></a>4. å¦‚ä½•é¿å…æ­»é”</h4><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220714131008260.png" class=""><h2 id="4-é”çš„å†…éƒ¨ç»“æ„"><a href="#4-é”çš„å†…éƒ¨ç»“æ„" class="headerlink" title="4. é”çš„å†…éƒ¨ç»“æ„"></a>4. é”çš„å†…éƒ¨ç»“æ„</h2><p>æˆ‘ä»¬å‰è¾¹è¯´å¯¹ä¸€æ¡è®°å½•åŠ é”çš„æœ¬è´¨å°±æ˜¯åœ¨å†…å­˜ä¸­åˆ›å»ºä¸€ä¸ª<code>é”ç»“æ„</code>ä¸ä¹‹å…³è”ï¼Œé‚£ä¹ˆæ˜¯ä¸æ˜¯ä¸€ä¸ªäº‹åŠ¡å¯¹å¤šæ¡è®°å½•åŠ é”ï¼Œå°±è¦åˆ›å»ºå¤šä¸ª<code>é”ç»“æ„</code>å‘¢ï¼Ÿæ¯”å¦‚ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># äº‹åŠ¡T1</span><br><span class="line">SELECT * FROM user LOCK IN SHARE MODE;</span><br></pre></td></tr></table></figure><p>ç†è®ºä¸Šåˆ›å»ºå¤šä¸ª<code>é”ç»“æ„</code>æ²¡é—®é¢˜ï¼Œä½†æ˜¯å¦‚æœä¸€ä¸ªäº‹åŠ¡è¦è·å–10000æ¡è®°å½•çš„é”ï¼Œç”Ÿæˆ10000ä¸ªé”ç»“æ„ä¹Ÿå¤ªå´©æºƒäº†ï¼æ‰€ä»¥å†³å®šåœ¨å¯¹ä¸åŒè®°å½•åŠ é”æ—¶ï¼Œå¦‚æœç¬¦åˆä¸‹è¾¹è¿™äº›æ¡ä»¶çš„è®°å½•ä¼šæ”¾åœ¨ä¸€ä¸ª<code>é”ç»“æ„</code>ä¸­ã€‚</p><ul><li>åœ¨åŒä¸€ä¸ªäº‹åŠ¡ä¸­è¿›è¡ŒåŠ é”æ“ä½œ</li><li>è¢«åŠ é”çš„è®°å½•åœ¨åŒä¸€ä¸ªé¡µé¢ä¸­</li><li>åŠ é”çš„ç±»å‹æ˜¯ä¸€æ ·çš„</li><li>ç­‰å¾…çŠ¶æ€æ˜¯ä¸€æ ·çš„</li></ul><p><code>InnoDB</code> å­˜å‚¨å¼•æ“ä¸­çš„ <code>é”ç»“æ„</code> å¦‚ä¸‹ï¼š</p>  <img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220714132306208.png" class=""> <p>ç»“æ„è§£æï¼š</p><p><code>1. é”æ‰€åœ¨çš„äº‹åŠ¡ä¿¡æ¯ </code>ï¼š</p><p>ä¸è®ºæ˜¯ <code>è¡¨é”</code> è¿˜æ˜¯ <code>è¡Œé”</code> ï¼Œéƒ½æ˜¯åœ¨äº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­ç”Ÿæˆçš„ï¼Œå“ªä¸ªäº‹åŠ¡ç”Ÿæˆäº†è¿™ä¸ªé”ç»“æ„ ï¼Œè¿™é‡Œå°±è®°å½•è¿™ä¸ª äº‹åŠ¡çš„ä¿¡æ¯ã€‚</p><p>æ­¤ <code>é”æ‰€åœ¨çš„äº‹åŠ¡ä¿¡æ¯</code> åœ¨å†…å­˜ç»“æ„ä¸­åªæ˜¯ä¸€ä¸ªæŒ‡é’ˆï¼Œé€šè¿‡æŒ‡é’ˆå¯ä»¥æ‰¾åˆ°å†…å­˜ä¸­å…³äºè¯¥äº‹åŠ¡çš„æ›´å¤šä¿¡æ¯ï¼Œæ¯”æ–¹è¯´äº‹åŠ¡idç­‰ã€‚</p><p><code>2. ç´¢å¼•ä¿¡æ¯</code> ï¼š</p><p>å¯¹äº <code>è¡Œé”</code> æ¥è¯´ï¼Œéœ€è¦è®°å½•ä¸€ä¸‹åŠ é”çš„è®°å½•æ˜¯å±äºå“ªä¸ªç´¢å¼•çš„ã€‚è¿™é‡Œä¹Ÿæ˜¯ä¸€ä¸ªæŒ‡é’ˆã€‚</p><p><code>3. è¡¨é”ï¼è¡Œé”ä¿¡æ¯</code> ï¼š</p><p><code>è¡¨é”ç»“æ„</code> å’Œ <code>è¡Œé”ç»“æ„</code> åœ¨è¿™ä¸ªä½ç½®çš„å†…å®¹æ˜¯ä¸åŒçš„ï¼š</p><ul><li><p>è¡¨é”ï¼š</p><p>è®°è½½ç€æ˜¯å¯¹å“ªä¸ªè¡¨åŠ çš„é”ï¼Œè¿˜æœ‰å…¶ä»–çš„ä¸€äº›ä¿¡æ¯ã€‚</p></li><li><p>è¡Œé”ï¼š</p><p>è®°è½½äº†ä¸‰ä¸ªé‡è¦çš„ä¿¡æ¯ï¼š</p><ul><li><code>Space ID</code> ï¼šè®°å½•æ‰€åœ¨è¡¨ç©ºé—´ã€‚</li><li><code>Page Number</code> ï¼šè®°å½•æ‰€åœ¨é¡µå·ã€‚</li><li><code>n_bits </code>ï¼šå¯¹äºè¡Œé”æ¥è¯´ï¼Œä¸€æ¡è®°å½•å°±å¯¹åº”ç€ä¸€ä¸ªæ¯”ç‰¹ä½ï¼Œä¸€ä¸ªé¡µé¢ä¸­åŒ…å«å¾ˆå¤šè®°å½•ï¼Œç”¨ä¸åŒ çš„æ¯”ç‰¹ä½æ¥åŒºåˆ†åˆ°åº•æ˜¯å“ªä¸€æ¡è®°å½•åŠ äº†é”ã€‚ä¸ºæ­¤åœ¨è¡Œé”ç»“æ„çš„æœ«å°¾æ”¾ç½®äº†ä¸€å †æ¯”ç‰¹ä½ï¼Œè¿™ä¸ª<code>n_bis</code>å±æ€§ä»£è¡¨ä½¿ç”¨äº†å¤šå°‘æ¯”ç‰¹ä½ã€‚</li></ul><blockquote><p>n_bitsçš„å€¼ä¸€èˆ¬éƒ½æ¯”é¡µé¢ä¸­è®°å½•æ¡æ•°å¤šä¸€äº›ã€‚ä¸»è¦æ˜¯ä¸ºäº†ä¹‹ååœ¨é¡µé¢ä¸­æ’å…¥äº†æ–°è®°å½•å ä¹Ÿä¸è‡³äºé‡æ–°åˆ†é…é”ç»“æ„</p></blockquote></li></ul><p><code>4. type_mode</code> ï¼š</p><p>è¿™æ˜¯ä¸€ä¸ª32ä½çš„æ•°ï¼Œè¢«åˆ†æˆäº† <code>lock_mode</code> ã€ <code>lock_type</code> å’Œ <code>rec_lock_type</code> ä¸‰ä¸ªéƒ¨åˆ†ï¼Œå¦‚å›¾æ‰€ç¤ºï¼š</p> <img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220714133319666.png" class=""> <ul><li>é”çš„æ¨¡å¼ï¼ˆ <code>lock_mode</code> ï¼‰ï¼Œå ç”¨ä½4ä½ï¼Œå¯é€‰çš„å€¼å¦‚ä¸‹ï¼š<ul><li><code>LOCK_IS</code> ï¼ˆåè¿›åˆ¶çš„ 0 ï¼‰ï¼šè¡¨ç¤ºå…±äº«æ„å‘é”ï¼Œä¹Ÿå°±æ˜¯ <code>ISé”</code> ã€‚ </li><li><code>LOCK_IX</code> ï¼ˆåè¿›åˆ¶çš„ 1 ï¼‰ï¼šè¡¨ç¤ºç‹¬å æ„å‘é”ï¼Œä¹Ÿå°±æ˜¯ <code>IXé”</code> ã€‚ </li><li><code>LOCK_S</code> ï¼ˆåè¿›åˆ¶çš„ 2 ï¼‰ï¼šè¡¨ç¤ºå…±äº«é”ï¼Œä¹Ÿå°±æ˜¯ <code>Sé”</code> ã€‚ </li><li><code>LOCK_X</code> ï¼ˆåè¿›åˆ¶çš„ 3 ï¼‰ï¼šè¡¨ç¤ºç‹¬å é”ï¼Œä¹Ÿå°±æ˜¯ <code>Xé”</code> ã€‚ </li><li><code>LOCK_AUTO_INC</code> ï¼ˆåè¿›åˆ¶çš„ 4 ï¼‰ï¼šè¡¨ç¤º <code>AUTO-INCé”</code> ã€‚</li></ul></li></ul><p>åœ¨InnoDBå­˜å‚¨å¼•æ“ä¸­ï¼ŒLOCK_ISï¼ŒLOCK_IXï¼ŒLOCK_AUTO_INCéƒ½ç®—æ˜¯è¡¨çº§é”çš„æ¨¡å¼ï¼ŒLOCK_Så’Œ LOCK_Xæ—¢å¯ä»¥ç®—æ˜¯è¡¨çº§é”çš„æ¨¡å¼ï¼Œä¹Ÿå¯ä»¥æ˜¯è¡Œçº§é”çš„æ¨¡å¼ã€‚</p><ul><li>é”çš„ç±»å‹ï¼ˆ <code>lock_type</code> ï¼‰ï¼Œå ç”¨ç¬¬5ï½8ä½ï¼Œä¸è¿‡ç°é˜¶æ®µåªæœ‰ç¬¬5ä½å’Œç¬¬6ä½è¢«ä½¿ç”¨ï¼š<ul><li><code>LOCK_TABLE</code> ï¼ˆåè¿›åˆ¶çš„ 16 ï¼‰ï¼Œä¹Ÿå°±æ˜¯å½“ç¬¬5ä¸ªæ¯”ç‰¹ä½ç½®ä¸º1æ—¶ï¼Œè¡¨ç¤ºè¡¨çº§é”ã€‚</li><li><code>LOCK_REC </code>ï¼ˆåè¿›åˆ¶çš„ 32 ï¼‰ï¼Œä¹Ÿå°±æ˜¯å½“ç¬¬6ä¸ªæ¯”ç‰¹ä½ç½®ä¸º1æ—¶ï¼Œè¡¨ç¤ºè¡Œçº§é”ã€‚</li></ul></li><li>è¡Œé”çš„å…·ä½“ç±»å‹ï¼ˆ <code>rec_lock_type</code> ï¼‰ï¼Œä½¿ç”¨å…¶ä½™çš„ä½æ¥è¡¨ç¤ºã€‚åªæœ‰åœ¨ <code>lock_type</code> çš„å€¼ä¸º <code>LOCK_REC</code> æ—¶ï¼Œä¹Ÿå°±æ˜¯åªæœ‰åœ¨è¯¥é”ä¸ºè¡Œçº§é”æ—¶ï¼Œæ‰ä¼šè¢«ç»†åˆ†ä¸ºæ›´å¤šçš„ç±»å‹ï¼š<ul><li><code>LOCK_ORDINARY</code> ï¼ˆåè¿›åˆ¶çš„ 0 ï¼‰ï¼šè¡¨ç¤º <code>next-keyé”</code> ã€‚</li><li><code>LOCK_GAP</code> ï¼ˆåè¿›åˆ¶çš„ 512 ï¼‰ï¼šä¹Ÿå°±æ˜¯å½“ç¬¬10ä¸ªæ¯”ç‰¹ä½ç½®ä¸º1æ—¶ï¼Œè¡¨ç¤º <code>gapé”</code> ã€‚</li><li><code>LOCK_REC_NOT_GAP</code> ï¼ˆåè¿›åˆ¶çš„ 1024 ï¼‰ï¼šä¹Ÿå°±æ˜¯å½“ç¬¬11ä¸ªæ¯”ç‰¹ä½ç½®ä¸º1æ—¶ï¼Œè¡¨ç¤ºæ­£ç» <code>è®°å½•é”</code> ã€‚</li><li><code>LOCK_INSERT_INTENTION</code> ï¼ˆåè¿›åˆ¶çš„ 2048 ï¼‰ï¼šä¹Ÿå°±æ˜¯å½“ç¬¬12ä¸ªæ¯”ç‰¹ä½ç½®ä¸º1æ—¶ï¼Œè¡¨ç¤ºæ’å…¥æ„å‘é”ã€‚å…¶ä»–çš„ç±»å‹ï¼šè¿˜æœ‰ä¸€äº›ä¸å¸¸ç”¨çš„ç±»å‹æˆ‘ä»¬å°±ä¸å¤šè¯´äº†ã€‚</li></ul></li><li><code>is_waiting</code> å±æ€§å‘¢ï¼ŸåŸºäºå†…å­˜ç©ºé—´çš„èŠ‚çœï¼Œæ‰€ä»¥æŠŠ <code>is_waiting</code> å±æ€§æ”¾åˆ°äº† <code>type_mode</code> è¿™ä¸ª32 ä½çš„æ•°å­—ä¸­ï¼š<ul><li><code>LOCK_WAIT</code> ï¼ˆåè¿›åˆ¶çš„ 256 ï¼‰ ï¼šå½“ç¬¬9ä¸ªæ¯”ç‰¹ä½ç½®ä¸º 1 æ—¶ï¼Œè¡¨ç¤º <code>is_waiting</code> ä¸º <code>true</code> ï¼Œä¹Ÿ å°±æ˜¯å½“å‰äº‹åŠ¡å°šæœªè·å–åˆ°é”ï¼Œå¤„åœ¨ç­‰å¾…çŠ¶æ€ï¼›å½“è¿™ä¸ªæ¯”ç‰¹ä½ä¸º 0 æ—¶ï¼Œè¡¨ç¤º <code>is_waiting</code> ä¸º <code>false</code> ï¼Œä¹Ÿå°±æ˜¯å½“å‰äº‹åŠ¡è·å–é”æˆåŠŸã€‚</li></ul></li></ul><p><code>5. å…¶ä»–ä¿¡æ¯</code> ï¼š</p><p>ä¸ºäº†æ›´å¥½çš„ç®¡ç†ç³»ç»Ÿè¿è¡Œè¿‡ç¨‹ä¸­ç”Ÿæˆçš„å„ç§é”ç»“æ„è€Œè®¾è®¡äº†å„ç§å“ˆå¸Œè¡¨å’Œé“¾è¡¨ã€‚</p><p><code>6. ä¸€å †æ¯”ç‰¹ä½</code> ï¼š</p><p>å¦‚æœæ˜¯ <code>è¡Œé”ç»“æ„</code> çš„è¯ï¼Œåœ¨è¯¥ç»“æ„æœ«å°¾è¿˜æ”¾ç½®äº†ä¸€å †æ¯”ç‰¹ä½ï¼Œæ¯”ç‰¹ä½çš„æ•°é‡æ˜¯ç”±ä¸Šè¾¹æåˆ°çš„ <code>n_bits</code> å±æ€§ è¡¨ç¤ºçš„ã€‚InnoDBæ•°æ®é¡µä¸­çš„æ¯æ¡è®°å½•åœ¨ <code>è®°å½•å¤´ä¿¡æ¯</code> ä¸­éƒ½åŒ…å«ä¸€ä¸ª <code>heap_no</code> å±æ€§ï¼Œä¼ªè®°å½• <code>Infimum</code> çš„ <code>heap_no</code> å€¼ä¸º 0 ï¼Œ <code>Supremum</code> çš„ <code>heap_no</code> å€¼ä¸º 1 ï¼Œä¹‹åæ¯æ’å…¥ä¸€æ¡è®°å½•ï¼Œ <code>heap_no</code> å€¼å°±å¢1ã€‚ é”ç»“ æ„ æœ€åçš„ä¸€å †æ¯”ç‰¹ä½å°±å¯¹åº”ç€ä¸€ä¸ªé¡µé¢ä¸­çš„è®°å½•ï¼Œä¸€ä¸ªæ¯”ç‰¹ä½æ˜ å°„ä¸€ä¸ª <code>heap_no</code> ï¼Œå³ä¸€ä¸ªæ¯”ç‰¹ä½æ˜ å°„ åˆ°é¡µå†…çš„ä¸€æ¡è®°å½•ã€‚</p><h2 id="5-é”ç›‘æ§"><a href="#5-é”ç›‘æ§" class="headerlink" title="5. é”ç›‘æ§"></a>5. é”ç›‘æ§</h2><p>å…³äºMySQLé”çš„ç›‘æ§ï¼Œæˆ‘ä»¬ä¸€èˆ¬å¯ä»¥é€šè¿‡æ£€æŸ¥ InnoDB_row_lock ç­‰çŠ¶æ€å˜é‡æ¥åˆ†æç³»ç»Ÿä¸Šçš„è¡Œé”çš„äº‰å¤ºæƒ…å†µ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show status like &#x27;innodb_row_lock%&#x27;;</span><br><span class="line">+-------------------------------+-------+</span><br><span class="line">| Variable_name                 | Value |</span><br><span class="line">+-------------------------------+-------+</span><br><span class="line">| Innodb_row_lock_current_waits | 0     |</span><br><span class="line">| Innodb_row_lock_time          | 0     |</span><br><span class="line">| Innodb_row_lock_time_avg      | 0     |</span><br><span class="line">| Innodb_row_lock_time_max      | 0     |</span><br><span class="line">| Innodb_row_lock_waits         | 0     |</span><br><span class="line">+-------------------------------+-------+</span><br><span class="line">5 rows in set (0.01 sec)</span><br></pre></td></tr></table></figure><p>å¯¹å„ä¸ªçŠ¶æ€é‡çš„è¯´æ˜å¦‚ä¸‹ï¼š</p><ul><li>Innodb_row_lock_current_waitsï¼šå½“å‰æ­£åœ¨ç­‰å¾…é”å®šçš„æ•°é‡ï¼› </li><li><code>Innodb_row_lock_time</code> ï¼šä»ç³»ç»Ÿå¯åŠ¨åˆ°ç°åœ¨é”å®šæ€»æ—¶é—´é•¿åº¦ï¼›ï¼ˆç­‰å¾…æ€»æ—¶é•¿ï¼‰ </li><li><code>Innodb_row_lock_time_avg</code> ï¼šæ¯æ¬¡ç­‰å¾…æ‰€èŠ±å¹³å‡æ—¶é—´ï¼›ï¼ˆç­‰å¾…å¹³å‡æ—¶é•¿ï¼‰ </li><li>Innodb_row_lock_time_maxï¼šä»ç³»ç»Ÿå¯åŠ¨åˆ°ç°åœ¨ç­‰å¾…æœ€å¸¸çš„ä¸€æ¬¡æ‰€èŠ±çš„æ—¶é—´ï¼› </li><li><code>Innodb_row_lock_waits</code> ï¼šç³»ç»Ÿå¯åŠ¨ååˆ°ç°åœ¨æ€»å…±ç­‰å¾…çš„æ¬¡æ•°ï¼›ï¼ˆç­‰å¾…æ€»æ¬¡æ•°ï¼‰</li></ul><p>å¯¹äºè¿™5ä¸ªçŠ¶æ€å˜é‡ï¼Œæ¯”è¾ƒé‡è¦çš„3ä¸ªè§ä¸Šé¢ï¼ˆç°è‰²ï¼‰ã€‚</p><p>å°¤å…¶æ˜¯å½“ç­‰å¾…æ¬¡æ•°å¾ˆé«˜ï¼Œè€Œä¸”æ¯æ¬¡ç­‰å¾…æ—¶é•¿ä¹Ÿä¸å°çš„æ—¶å€™ï¼Œæˆ‘ä»¬å°±éœ€è¦åˆ†æç³»ç»Ÿä¸­ä¸ºä»€ä¹ˆä¼šæœ‰å¦‚æ­¤å¤šçš„ç­‰å¾…ï¼Œç„¶åæ ¹æ®åˆ†æç»“æœç€æ‰‹æŒ‡å®šä¼˜åŒ–è®¡åˆ’ã€‚</p><p><strong>å…¶ä»–ç›‘æ§æ–¹æ³•ï¼š</strong></p><p>MySQLæŠŠäº‹åŠ¡å’Œé”çš„ä¿¡æ¯è®°å½•åœ¨äº† <code>information_schema</code> åº“ä¸­ï¼Œæ¶‰åŠåˆ°çš„ä¸‰å¼ è¡¨åˆ†åˆ«æ˜¯ <code>INNODB_TRX</code> ã€ <code>INNODB_LOCKS</code> å’Œ <code>INNODB_LOCK_WAITS</code> ã€‚</p><p><code>MySQL5.7åŠä¹‹å‰</code> ï¼Œå¯ä»¥é€šè¿‡information_schema.INNODB_LOCKSæŸ¥çœ‹äº‹åŠ¡çš„é”æƒ…å†µï¼Œä½†åªèƒ½çœ‹åˆ°é˜»å¡äº‹ åŠ¡çš„é”ï¼›å¦‚æœäº‹åŠ¡å¹¶æœªè¢«é˜»å¡ï¼Œåˆ™åœ¨è¯¥è¡¨ä¸­çœ‹ä¸åˆ°è¯¥äº‹åŠ¡çš„é”æƒ…å†µã€‚</p><p>MySQL8.0åˆ é™¤äº†information_schema.INNODB_LOCKSï¼Œæ·»åŠ äº† <code>performance_schema.data_locks</code> ï¼Œå¯ä»¥é€šè¿‡performance_schema.data_locksæŸ¥çœ‹äº‹åŠ¡çš„é”æƒ…å†µï¼Œå’ŒMySQL5.7åŠä¹‹å‰ä¸åŒï¼Œ performance_schema.data_locksä¸ä½†å¯ä»¥çœ‹åˆ°é˜»å¡è¯¥äº‹åŠ¡çš„é”ï¼Œè¿˜å¯ä»¥çœ‹åˆ°è¯¥äº‹åŠ¡æ‰€æŒæœ‰çš„é”ã€‚</p><p>åŒæ—¶ï¼Œinformation_schema.INNODB_LOCK_WAITSä¹Ÿè¢« <code>performance_schema.data_lock_waits</code> æ‰€ä»£ æ›¿ã€‚</p><p>æˆ‘ä»¬æ¨¡æ‹Ÿä¸€ä¸ªé”ç­‰å¾…çš„åœºæ™¯ï¼Œä»¥ä¸‹æ˜¯ä»è¿™ä¸‰å¼ è¡¨æ”¶é›†çš„ä¿¡æ¯</p><p>é”ç­‰å¾…åœºæ™¯ï¼Œæˆ‘ä»¬ä¾ç„¶ä½¿ç”¨è®°å½•é”ä¸­çš„æ¡ˆä¾‹ï¼Œå½“äº‹åŠ¡2è¿›è¡Œç­‰å¾…æ—¶ï¼ŒæŸ¥è¯¢æƒ…å†µå¦‚ä¸‹ï¼š</p><p>ï¼ˆ1ï¼‰æŸ¥è¯¢æ­£åœ¨è¢«é”é˜»å¡çš„sqlè¯­å¥ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM information_schema.INNODB_TRX\G;</span><br></pre></td></tr></table></figure><p>é‡è¦å±æ€§ä»£è¡¨å«ä¹‰å·²åœ¨ä¸Šè¿°ä¸­æ ‡æ³¨ã€‚</p><p>ï¼ˆ2ï¼‰æŸ¥è¯¢é”ç­‰å¾…æƒ…å†µ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM data_lock_waits\G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">ENGINE: INNODB</span><br><span class="line">REQUESTING_ENGINE_LOCK_ID: 139750145405624:7:4:7:139747028690608</span><br><span class="line">REQUESTING_ENGINE_TRANSACTION_ID: 13845 #è¢«é˜»å¡çš„äº‹åŠ¡ID</span><br><span class="line">REQUESTING_THREAD_ID: 72</span><br><span class="line">REQUESTING_EVENT_ID: 26</span><br><span class="line">REQUESTING_OBJECT_INSTANCE_BEGIN: 139747028690608</span><br><span class="line">BLOCKING_ENGINE_LOCK_ID: 139750145406432:7:4:7:139747028813248</span><br><span class="line">BLOCKING_ENGINE_TRANSACTION_ID: 13844 #æ­£åœ¨æ‰§è¡Œçš„äº‹åŠ¡IDï¼Œé˜»å¡äº†13845</span><br><span class="line">BLOCKING_THREAD_ID: 71</span><br><span class="line">BLOCKING_EVENT_ID: 24</span><br><span class="line">BLOCKING_OBJECT_INSTANCE_BEGIN: 139747028813248</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure><p>ï¼ˆ3ï¼‰æŸ¥è¯¢é”çš„æƒ…å†µ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">mysql &gt; SELECT * from performance_schema.data_locks\G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">ENGINE: INNODB</span><br><span class="line">ENGINE_LOCK_ID: 139750145405624:1068:139747028693520</span><br><span class="line">ENGINE_TRANSACTION_ID: 13847</span><br><span class="line">THREAD_ID: 72</span><br><span class="line">EVENT_ID: 31</span><br><span class="line">OBJECT_SCHEMA: atguigu</span><br><span class="line">OBJECT_NAME: user</span><br><span class="line">PARTITION_NAME: NULL</span><br><span class="line">SUBPARTITION_NAME: NULL</span><br><span class="line">INDEX_NAME: NULL</span><br><span class="line">OBJECT_INSTANCE_BEGIN: 139747028693520</span><br><span class="line">LOCK_TYPE: TABLE</span><br><span class="line">LOCK_MODE: IX</span><br><span class="line">LOCK_STATUS: GRANTED</span><br><span class="line">LOCK_DATA: NULL</span><br><span class="line">*************************** 2. row ***************************</span><br><span class="line">ENGINE: INNODB</span><br><span class="line">ENGINE_LOCK_ID: 139750145405624:7:4:7:139747028690608</span><br><span class="line">ENGINE_TRANSACTION_ID: 13847</span><br><span class="line">THREAD_ID: 72</span><br><span class="line">EVENT_ID: 31</span><br><span class="line">OBJECT_SCHEMA: atguigu</span><br><span class="line">OBJECT_NAME: user</span><br><span class="line">PARTITION_NAME: NULL</span><br><span class="line">SUBPARTITION_NAME: NULL</span><br><span class="line">INDEX_NAME: PRIMARY</span><br><span class="line">OBJECT_INSTANCE_BEGIN: 139747028690608</span><br><span class="line">LOCK_TYPE: RECORD</span><br><span class="line">LOCK_MODE: X,REC_NOT_GAP</span><br><span class="line">LOCK_STATUS: WAITING</span><br><span class="line">LOCK_DATA: 1</span><br><span class="line">*************************** 3. row ***************************</span><br><span class="line">ENGINE: INNODB</span><br><span class="line">ENGINE_LOCK_ID: 139750145406432:1068:139747028816304</span><br><span class="line">ENGINE_TRANSACTION_ID: 13846</span><br><span class="line">THREAD_ID: 71</span><br><span class="line">EVENT_ID: 28</span><br><span class="line">OBJECT_SCHEMA: atguigu</span><br><span class="line">OBJECT_NAME: user</span><br><span class="line">PARTITION_NAME: NULL</span><br><span class="line">SUBPARTITION_NAME: NULL</span><br><span class="line">INDEX_NAME: NULL</span><br><span class="line">OBJECT_INSTANCE_BEGIN: 139747028816304</span><br><span class="line">LOCK_TYPE: TABLE</span><br><span class="line">LOCK_MODE: IX</span><br><span class="line">LOCK_STATUS: GRANTED</span><br><span class="line">LOCK_DATA: NULL</span><br><span class="line">*************************** 4. row ***************************</span><br><span class="line">ENGINE: INNODB</span><br><span class="line">ENGINE_LOCK_ID: 139750145406432:7:4:7:139747028813248</span><br><span class="line">ENGINE_TRANSACTION_ID: 13846</span><br><span class="line">THREAD_ID: 71</span><br><span class="line">EVENT_ID: 28</span><br><span class="line">OBJECT_SCHEMA: atguigu</span><br><span class="line">OBJECT_NAME: user</span><br><span class="line">PARTITION_NAME: NULL</span><br><span class="line">SUBPARTITION_NAME: NULL</span><br><span class="line">INDEX_NAME: PRIMARY</span><br><span class="line">OBJECT_INSTANCE_BEGIN: 139747028813248</span><br><span class="line">LOCK_TYPE: RECORD</span><br><span class="line">LOCK_MODE: X,REC_NOT_GAP</span><br><span class="line">LOCK_STATUS: GRANTED</span><br><span class="line">LOCK_DATA: 1</span><br><span class="line">4 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">ERROR:</span><br><span class="line">No query specified</span><br></pre></td></tr></table></figure><p>ä»é”çš„æƒ…å†µå¯ä»¥çœ‹å‡ºæ¥ï¼Œä¸¤ä¸ªäº‹åŠ¡åˆ†åˆ«è·å–äº†IXé”ï¼Œæˆ‘ä»¬ä»æ„å‘é”ç« èŠ‚å¯ä»¥çŸ¥é“ï¼ŒIXé”äº’ç›¸æ—¶å…¼å®¹çš„ã€‚æ‰€ ä»¥è¿™é‡Œä¸ä¼šç­‰å¾…ï¼Œä½†æ˜¯äº‹åŠ¡1åŒæ ·æŒæœ‰Xé”ï¼Œæ­¤æ—¶äº‹åŠ¡2ä¹Ÿè¦å»åŒä¸€è¡Œè®°å½•è·å–Xé”ï¼Œä»–ä»¬ä¹‹é—´ä¸å…¼å®¹ï¼Œå¯¼ è‡´ç­‰å¾…çš„æƒ…å†µå‘ç”Ÿã€‚</p><h2 id="6-é™„å½•"><a href="#6-é™„å½•" class="headerlink" title="6. é™„å½•"></a>6. é™„å½•</h2><p><strong>é—´éš™é”åŠ é”è§„åˆ™ï¼ˆå…±11ä¸ªæ¡ˆä¾‹ï¼‰</strong></p><p>é—´éš™é”æ˜¯åœ¨å¯é‡å¤è¯»éš”ç¦»çº§åˆ«ä¸‹æ‰ä¼šç”Ÿæ•ˆçš„ï¼š next-key lock å®é™…ä¸Šæ˜¯ç”±é—´éš™é”åŠ è¡Œé”å®ç°çš„ï¼Œå¦‚æœåˆ‡æ¢ åˆ°è¯»æäº¤éš”ç¦»çº§åˆ« (read-committed) çš„è¯ï¼Œå°±å¥½ç†è§£äº†ï¼Œè¿‡ç¨‹ä¸­å»æ‰é—´éš™é”çš„éƒ¨åˆ†ï¼Œä¹Ÿå°±æ˜¯åªå‰©ä¸‹è¡Œé” çš„éƒ¨åˆ†ã€‚è€Œåœ¨è¯»æäº¤éš”ç¦»çº§åˆ«ä¸‹é—´éš™é”å°±æ²¡æœ‰äº†ï¼Œä¸ºäº†è§£å†³å¯èƒ½å‡ºç°çš„æ•°æ®å’Œæ—¥å¿—ä¸ä¸€è‡´é—®é¢˜ï¼Œéœ€è¦æŠŠ binlog æ ¼å¼è®¾ç½®ä¸º row ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œè®¸å¤šå…¬å¸çš„é…ç½®ä¸ºï¼šè¯»æäº¤éš”ç¦»çº§åˆ«åŠ  binlog_format&#x3D;rowã€‚ä¸šåŠ¡ä¸ éœ€è¦å¯é‡å¤è¯»çš„ä¿è¯ï¼Œè¿™æ ·è€ƒè™‘åˆ°è¯»æäº¤ä¸‹æ“ä½œæ•°æ®çš„é”èŒƒå›´æ›´å°ï¼ˆæ²¡æœ‰é—´éš™é”ï¼‰ï¼Œè¿™ä¸ªé€‰æ‹©æ˜¯åˆç†çš„ã€‚</p><p>next-key lockçš„åŠ é”è§„åˆ™</p><p>æ€»ç»“çš„åŠ é”è§„åˆ™é‡Œé¢ï¼ŒåŒ…å«äº†ä¸¤ä¸ª â€œ â€œ åŸåˆ™ â€ â€ ã€ä¸¤ä¸ª â€œ â€œ ä¼˜åŒ– â€ â€ å’Œä¸€ä¸ª â€œbugâ€ ã€‚</p><ol><li>åŸåˆ™ 1 ï¼šåŠ é”çš„åŸºæœ¬å•ä½æ˜¯ next-key lock ã€‚ next-key lock æ˜¯å‰å¼€åé—­åŒºé—´ã€‚ </li><li>åŸåˆ™ 2 ï¼šæŸ¥æ‰¾è¿‡ç¨‹ä¸­è®¿é—®åˆ°çš„å¯¹è±¡æ‰ä¼šåŠ é”ã€‚ä»»ä½•è¾…åŠ©ç´¢å¼•ä¸Šçš„é”ï¼Œæˆ–è€…éç´¢å¼•åˆ—ä¸Šçš„é”ï¼Œæœ€ç»ˆ éƒ½è¦å›æº¯åˆ°ä¸»é”®ä¸Šï¼Œåœ¨ä¸»é”®ä¸Šä¹Ÿè¦åŠ ä¸€æŠŠé”ã€‚ </li><li>ä¼˜åŒ– 1 ï¼šç´¢å¼•ä¸Šçš„ç­‰å€¼æŸ¥è¯¢ï¼Œç»™å”¯ä¸€ç´¢å¼•åŠ é”çš„æ—¶å€™ï¼Œ next-key lock é€€åŒ–ä¸ºè¡Œé”ã€‚ä¹Ÿå°±æ˜¯è¯´å¦‚æœ InnoDBæ‰«æçš„æ˜¯ä¸€ä¸ªä¸»é”®ã€æˆ–æ˜¯ä¸€ä¸ªå”¯ä¸€ç´¢å¼•çš„è¯ï¼Œé‚£InnoDBåªä¼šé‡‡ç”¨è¡Œé”æ–¹å¼æ¥åŠ é” </li><li>ä¼˜åŒ– 2 ï¼šç´¢å¼•ä¸Šï¼ˆä¸ä¸€å®šæ˜¯å”¯ä¸€ç´¢å¼•ï¼‰çš„ç­‰å€¼æŸ¥è¯¢ï¼Œå‘å³éå†æ—¶ä¸”æœ€åä¸€ä¸ªå€¼ä¸æ»¡è¶³ç­‰å€¼æ¡ä»¶çš„ æ—¶å€™ï¼Œ next-keylock é€€åŒ–ä¸ºé—´éš™é”ã€‚ </li><li>ä¸€ä¸ª bug ï¼šå”¯ä¸€ç´¢å¼•ä¸Šçš„èŒƒå›´æŸ¥è¯¢ä¼šè®¿é—®åˆ°ä¸æ»¡è¶³æ¡ä»¶çš„ç¬¬ä¸€ä¸ªå€¼ä¸ºæ­¢ã€‚</li></ol><p>æˆ‘ä»¬ä»¥è¡¨testä½œä¸ºä¾‹å­ï¼Œå»ºè¡¨è¯­å¥å’Œåˆå§‹åŒ–è¯­å¥å¦‚ä¸‹ï¼šå…¶ä¸­idä¸ºä¸»é”®ç´¢å¼•</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE `test` (</span><br><span class="line">`id` int(11) NOT NULL,</span><br><span class="line">`col1` int(11) DEFAULT NULL,</span><br><span class="line">`col2` int(11) DEFAULT NULL,</span><br><span class="line">PRIMARY KEY (`id`),</span><br><span class="line">KEY `c` (`c`)</span><br><span class="line">) ENGINE=InnoDB;</span><br><span class="line">insert into test values(0,0,0),(5,5,5),</span><br><span class="line">(10,10,10),(15,15,15),(20,20,20),(25,25,25);</span><br></pre></td></tr></table></figure><p><strong>æ¡ˆä¾‹ä¸€ï¼šå”¯ä¸€ç´¢å¼•ç­‰å€¼æŸ¥è¯¢é—´éš™é”</strong></p><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220714134603698.png" class=""> <p>ç”±äºè¡¨ test ä¸­æ²¡æœ‰ id&#x3D;7 çš„è®°å½•</p><p>æ ¹æ®åŸåˆ™ 1 ï¼ŒåŠ é”å•ä½æ˜¯ next-key lock ï¼Œ session A åŠ é”èŒƒå›´å°±æ˜¯ (5,10] ï¼› åŒæ—¶æ ¹æ®ä¼˜åŒ– 2 ï¼Œè¿™æ˜¯ä¸€ä¸ªç­‰ å€¼æŸ¥è¯¢ (id&#x3D;7) ï¼Œè€Œ id&#x3D;10 ä¸æ»¡è¶³æŸ¥è¯¢æ¡ä»¶ï¼Œ next-key lock é€€åŒ–æˆé—´éš™é”ï¼Œå› æ­¤æœ€ç»ˆåŠ é”çš„èŒƒå›´æ˜¯ (5,10)</p><p><strong>æ¡ˆä¾‹äºŒï¼šéå”¯ä¸€ç´¢å¼•ç­‰å€¼æŸ¥è¯¢é”</strong></p><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220714134623052-16577775838551.png" class=""> <p>è¿™é‡Œ session A è¦ç»™ç´¢å¼• col1 ä¸Š col1&#x3D;5 çš„è¿™ä¸€è¡ŒåŠ ä¸Šè¯»é”ã€‚</p><ol><li>æ ¹æ®åŸåˆ™ 1 ï¼ŒåŠ é”å•ä½æ˜¯ next-key lock ï¼Œå·¦å¼€å³é—­ï¼Œ5æ˜¯é—­ä¸Šçš„ï¼Œå› æ­¤ä¼šç»™ (0,5] åŠ ä¸Š next-key lock ã€‚ </li><li>è¦æ³¨æ„ c æ˜¯æ™®é€šç´¢å¼•ï¼Œå› æ­¤ä»…è®¿é—® c&#x3D;5 è¿™ä¸€æ¡è®°å½•æ˜¯ä¸èƒ½é©¬ä¸Šåœä¸‹æ¥çš„ï¼ˆå¯èƒ½æœ‰col1&#x3D;5çš„å…¶ä»–è®° å½•ï¼‰ï¼Œéœ€è¦å‘å³éå†ï¼ŒæŸ¥åˆ°c&#x3D;10 æ‰æ”¾å¼ƒã€‚æ ¹æ®åŸåˆ™ 2 ï¼Œè®¿é—®åˆ°çš„éƒ½è¦åŠ é”ï¼Œå› æ­¤è¦ç»™ (5,10] åŠ  next-key lock ã€‚ </li><li>ä½†æ˜¯åŒæ—¶è¿™ä¸ªç¬¦åˆä¼˜åŒ– 2 ï¼šç­‰å€¼åˆ¤æ–­ï¼Œå‘å³éå†ï¼Œæœ€åä¸€ä¸ªå€¼ä¸æ»¡è¶³ col1&#x3D;5 è¿™ä¸ªç­‰å€¼æ¡ä»¶ï¼Œå› æ­¤é€€åŒ–æˆé—´éš™é” (5,10) ã€‚</li><li>æ ¹æ®åŸåˆ™ 2 ï¼Œ åªæœ‰è®¿é—®åˆ°çš„å¯¹è±¡æ‰ä¼šåŠ é”ï¼Œè¿™ä¸ªæŸ¥è¯¢ä½¿ç”¨è¦†ç›–ç´¢å¼•ï¼Œå¹¶ä¸éœ€è¦è®¿é—®ä¸»é”®ç´¢å¼•ï¼Œæ‰€ä»¥ä¸»é”®ç´¢å¼•ä¸Šæ²¡æœ‰åŠ ä»»ä½•é”ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆ session B çš„ update è¯­å¥å¯ä»¥æ‰§è¡Œå®Œæˆã€‚</li></ol><p>ä½† session C è¦æ’å…¥ä¸€ä¸ª (7,7,7) çš„è®°å½•ï¼Œå°±ä¼šè¢« session A çš„é—´éš™é” (5,10) é”ä½ è¿™ä¸ªä¾‹å­è¯´æ˜ï¼Œé”æ˜¯åŠ åœ¨ç´¢å¼•ä¸Šçš„ã€‚</p><p>æ‰§è¡Œ for update æ—¶ï¼Œç³»ç»Ÿä¼šè®¤ä¸ºä½ æ¥ä¸‹æ¥è¦æ›´æ–°æ•°æ®ï¼Œå› æ­¤ä¼šé¡ºä¾¿ç»™ä¸»é”®ç´¢å¼•ä¸Šæ»¡è¶³æ¡ä»¶çš„è¡ŒåŠ ä¸Šè¡Œé”ã€‚</p><p>å¦‚æœä½ è¦ç”¨ lock in share modeæ¥ç»™è¡ŒåŠ è¯»é”é¿å…æ•°æ®è¢«æ›´æ–°çš„è¯ï¼Œå°±å¿…é¡»å¾—ç»•è¿‡è¦†ç›–ç´¢å¼•çš„ä¼˜åŒ–ï¼Œå› ä¸ºè¦†ç›–ç´¢å¼•ä¸ä¼šè®¿é—®ä¸»é”®ç´¢å¼•ï¼Œä¸ä¼šç»™ä¸»é”®ç´¢å¼•ä¸ŠåŠ é”</p><p><strong>æ¡ˆä¾‹ä¸‰ï¼šä¸»é”®ç´¢å¼•èŒƒå›´æŸ¥è¯¢é”</strong></p><p>ä¸Šé¢ä¸¤ä¸ªä¾‹å­æ˜¯ç­‰å€¼æŸ¥è¯¢çš„ï¼Œè¿™ä¸ªä¾‹å­æ˜¯å…³äºèŒƒå›´æŸ¥è¯¢çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸‹é¢çš„è¯­å¥</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">select * from test where id=10 for update</span><br><span class="line">select * from tets where id&gt;=10 and id&lt;11 for update;</span><br></pre></td></tr></table></figure><p>è¿™ä¸¤æ¡æŸ¥è¯­å¥è‚¯å®šæ˜¯ç­‰ä»·çš„ï¼Œä½†æ˜¯å®ƒä»¬çš„åŠ é”è§„åˆ™ä¸å¤ªä¸€æ ·</p> <img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220714134742049.png" class=""> <ol><li>å¼€å§‹æ‰§è¡Œçš„æ—¶å€™ï¼Œè¦æ‰¾åˆ°ç¬¬ä¸€ä¸ª id&#x3D;10 çš„è¡Œï¼Œå› æ­¤æœ¬è¯¥æ˜¯ next-key lock(5,10] ã€‚ æ ¹æ®ä¼˜åŒ– 1 ï¼Œä¸»é”® id ä¸Šçš„ç­‰å€¼æ¡ä»¶ï¼Œé€€åŒ–æˆè¡Œé”ï¼ŒåªåŠ äº† id&#x3D;10 è¿™ä¸€è¡Œçš„è¡Œé”ã€‚ </li><li>å®ƒæ˜¯èŒƒå›´æŸ¥è¯¢ï¼Œ èŒƒå›´æŸ¥æ‰¾å°±å¾€åç»§ç»­æ‰¾ï¼Œæ‰¾åˆ° id&#x3D;15 è¿™ä¸€è¡Œåœä¸‹æ¥ï¼Œä¸æ»¡è¶³æ¡ä»¶ï¼Œå› æ­¤éœ€è¦åŠ  next-key lock(10,15] ã€‚</li></ol><p>session A è¿™æ—¶å€™é”çš„èŒƒå›´å°±æ˜¯ä¸»é”®ç´¢å¼•ä¸Šï¼Œè¡Œé” id&#x3D;10 å’Œ next-key lock(10,15] ã€‚<strong>é¦–æ¬¡ session A å®šä½æŸ¥æ‰¾ id&#x3D;10 çš„è¡Œçš„æ—¶å€™ï¼Œæ˜¯å½“åšç­‰å€¼æŸ¥è¯¢æ¥åˆ¤æ–­çš„ï¼Œè€Œå‘å³æ‰«æåˆ° id&#x3D;15 çš„æ—¶å€™ï¼Œç”¨çš„æ˜¯èŒƒå›´æŸ¥è¯¢åˆ¤æ–­ã€‚</strong></p><p><strong>æ¡ˆä¾‹å››ï¼šéå”¯ä¸€ç´¢å¼•èŒƒå›´æŸ¥è¯¢é”</strong></p><p>ä¸æ¡ˆä¾‹ä¸‰ä¸åŒçš„æ˜¯ï¼Œæ¡ˆä¾‹å››ä¸­æŸ¥è¯¢è¯­å¥çš„ where éƒ¨åˆ†ç”¨çš„æ˜¯å­—æ®µ c ï¼Œå®ƒæ˜¯æ™®é€šç´¢å¼•</p><p>è¿™ä¸¤æ¡æŸ¥è¯­å¥è‚¯å®šæ˜¯ç­‰ä»·çš„ï¼Œä½†æ˜¯å®ƒä»¬çš„åŠ é”è§„åˆ™ä¸å¤ªä¸€æ ·</p><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220714134822160.png" class=""> <p>åœ¨ç¬¬ä¸€æ¬¡ç”¨ col1&#x3D;10 å®šä½è®°å½•çš„æ—¶å€™ï¼Œç´¢å¼• c ä¸ŠåŠ äº† (5,10] è¿™ä¸ª next-key lock åï¼Œç”±äºç´¢å¼• col1 æ˜¯éå”¯ ä¸€ç´¢å¼•ï¼Œæ²¡æœ‰ä¼˜åŒ–è§„åˆ™ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸ä¼šèœ•å˜ä¸ºè¡Œé”ï¼Œå› æ­¤æœ€ç»ˆ sesion A åŠ çš„é”æ˜¯ï¼Œç´¢å¼• c ä¸Šçš„ (5,10] å’Œ (10,15] è¿™ä¸¤ä¸ª next-keylock ã€‚</p><p>è¿™é‡Œéœ€è¦æ‰«æåˆ° col1&#x3D;15 æ‰åœæ­¢æ‰«æï¼Œæ˜¯åˆç†çš„ï¼Œå› ä¸º InnoDB è¦æ‰«åˆ° col1&#x3D;15 ï¼Œæ‰çŸ¥é“ä¸éœ€è¦ç»§ç»­å¾€åæ‰¾äº†ã€‚</p><p><strong>æ¡ˆä¾‹äº”ï¼šå”¯ä¸€ç´¢å¼•èŒƒå›´æŸ¥è¯¢é” bug</strong></p><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220714134846740.png" class=""> <p>session A æ˜¯ä¸€ä¸ªèŒƒå›´æŸ¥è¯¢ï¼ŒæŒ‰ç…§åŸåˆ™ 1 çš„è¯ï¼Œåº”è¯¥æ˜¯ç´¢å¼• id ä¸ŠåªåŠ  (10,15] è¿™ä¸ª next-key lock ï¼Œå¹¶ä¸”å›  ä¸º id æ˜¯å”¯ä¸€é”®ï¼Œæ‰€ä»¥å¾ªç¯åˆ¤æ–­åˆ° id&#x3D;15 è¿™ä¸€è¡Œå°±åº”è¯¥åœæ­¢äº†ã€‚</p><p>ä½†æ˜¯å®ç°ä¸Šï¼Œ InnoDB ä¼šå¾€å‰æ‰«æåˆ°ç¬¬ä¸€ä¸ªä¸æ»¡è¶³æ¡ä»¶çš„è¡Œä¸ºæ­¢ï¼Œä¹Ÿå°±æ˜¯ id&#x3D;20 ã€‚è€Œä¸”ç”±äºè¿™æ˜¯ä¸ªèŒƒå›´æ‰«æï¼Œå› æ­¤ç´¢å¼• id ä¸Šçš„ (15,20] è¿™ä¸ª next-key lock ä¹Ÿä¼šè¢«é”ä¸Šã€‚ç…§ç†è¯´ï¼Œè¿™é‡Œé”ä½ id&#x3D;20 è¿™ä¸€è¡Œçš„è¡Œä¸ºï¼Œå…¶å®æ˜¯æ²¡æœ‰å¿…è¦çš„ã€‚å› ä¸ºæ‰«æåˆ° id&#x3D;15 ï¼Œå°±å¯ä»¥ç¡®å®šä¸ç”¨å¾€åå†æ‰¾äº†ã€‚</p><p><strong>æ¡ˆä¾‹å…­ï¼šéå”¯ä¸€ç´¢å¼•ä¸Šå­˜åœ¨ â€œ â€œ ç­‰å€¼ â€œ â€œ çš„ä¾‹å­</strong></p><p>è¿™é‡Œï¼Œæˆ‘ç»™è¡¨ t æ’å…¥ä¸€æ¡æ–°è®°å½•ï¼šinsert into t values(30,10,30);ä¹Ÿå°±æ˜¯è¯´ï¼Œç°åœ¨è¡¨é‡Œé¢æœ‰ä¸¤ä¸ªc&#x3D;10çš„è¡Œ</p><p><strong>ä½†æ˜¯å®ƒä»¬çš„ä¸»é”®å€¼ id æ˜¯ä¸åŒçš„ï¼ˆåˆ†åˆ«æ˜¯ 10 å’Œ 30 ï¼‰ï¼Œå› æ­¤è¿™ä¸¤ä¸ªc&#x3D;10 çš„è®°å½•ä¹‹é—´ï¼Œä¹Ÿæ˜¯æœ‰é—´éš™çš„ã€‚</strong></p><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220714134923414.png" class=""> <p>è¿™æ¬¡æˆ‘ä»¬ç”¨ delete è¯­å¥æ¥éªŒè¯ã€‚æ³¨æ„ï¼Œ delete è¯­å¥åŠ é”çš„é€»è¾‘ï¼Œå…¶å®è·Ÿ select â€¦ for update æ˜¯ç±»ä¼¼çš„ï¼Œ ä¹Ÿå°±æ˜¯æˆ‘åœ¨æ–‡ç« å¼€å§‹æ€»ç»“çš„ä¸¤ä¸ª â€œ åŸåˆ™ â€ ã€ä¸¤ä¸ª â€œ ä¼˜åŒ– â€ å’Œä¸€ä¸ª â€œbugâ€ ã€‚</p><p>è¿™æ—¶ï¼Œ session A åœ¨éå†çš„æ—¶å€™ï¼Œå…ˆè®¿é—®ç¬¬ä¸€ä¸ª col1&#x3D;10 çš„è®°å½•ã€‚åŒæ ·åœ°ï¼Œæ ¹æ®åŸåˆ™ 1 ï¼Œè¿™é‡ŒåŠ çš„æ˜¯ (col1&#x3D;5,id&#x3D;5) åˆ° (col1&#x3D;10,id&#x3D;10) è¿™ä¸ª next-key lock ã€‚</p><p>ç”±äºcæ˜¯æ™®é€šç´¢å¼•ï¼Œæ‰€ä»¥ç»§ç»­å‘å³æŸ¥æ‰¾ï¼Œç›´åˆ°ç¢°åˆ° (col1&#x3D;15,id&#x3D;15) è¿™ä¸€è¡Œå¾ªç¯æ‰ç»“æŸã€‚æ ¹æ®ä¼˜åŒ– 2 ï¼Œè¿™æ˜¯ ä¸€ä¸ªç­‰å€¼æŸ¥è¯¢ï¼Œå‘å³æŸ¥æ‰¾åˆ°äº†ä¸æ»¡è¶³æ¡ä»¶çš„è¡Œï¼Œæ‰€ä»¥ä¼šé€€åŒ–æˆ (col1&#x3D;10,id&#x3D;10) åˆ° (col1&#x3D;15,id&#x3D;15) çš„é—´éš™é”ã€‚</p><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220714134945012.png" class=""> <p>è¿™ä¸ª delete è¯­å¥åœ¨ç´¢å¼• c ä¸Šçš„åŠ é”èŒƒå›´ï¼Œå°±æ˜¯ä¸Šé¢å›¾ä¸­è“è‰²åŒºåŸŸè¦†ç›–çš„éƒ¨åˆ†ã€‚è¿™ä¸ªè“è‰²åŒºåŸŸå·¦å³ä¸¤è¾¹éƒ½ æ˜¯è™šçº¿ï¼Œè¡¨ç¤ºå¼€åŒºé—´ï¼Œå³ (col1&#x3D;5,id&#x3D;5) å’Œ (col1&#x3D;15,id&#x3D;15) è¿™ä¸¤è¡Œä¸Šéƒ½æ²¡æœ‰é”</p><p><strong>æ¡ˆä¾‹ä¸ƒï¼š limit è¯­å¥åŠ é”</strong></p><p>ä¾‹å­ 6 ä¹Ÿæœ‰ä¸€ä¸ªå¯¹ç…§æ¡ˆä¾‹ï¼Œåœºæ™¯å¦‚ä¸‹æ‰€ç¤ºï¼š</p><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220714135007118.png" class=""> <p>session A çš„ delete è¯­å¥åŠ äº† limit 2 ã€‚ä½ çŸ¥é“è¡¨ t é‡Œ c&#x3D;10 çš„è®°å½•å…¶å®åªæœ‰ä¸¤æ¡ï¼Œå› æ­¤åŠ ä¸åŠ  limit 2 ï¼Œåˆ é™¤çš„æ•ˆæœéƒ½æ˜¯ä¸€æ ·çš„ã€‚ä½†æ˜¯åŠ é”æ•ˆæœå´ä¸ä¸€æ ·</p><p>è¿™æ˜¯å› ä¸ºï¼Œæ¡ˆä¾‹ä¸ƒé‡Œçš„ delete è¯­å¥æ˜ç¡®åŠ äº† limit 2 çš„é™åˆ¶ï¼Œå› æ­¤åœ¨éå†åˆ° (col1&#x3D;10, id&#x3D;30) è¿™ä¸€è¡Œä¹‹åï¼Œ æ»¡è¶³æ¡ä»¶çš„è¯­å¥å·²ç»æœ‰ä¸¤æ¡ï¼Œå¾ªç¯å°±ç»“æŸäº†ã€‚å› æ­¤ï¼Œç´¢å¼• col1 ä¸Šçš„åŠ é”èŒƒå›´å°±å˜æˆäº†ä»ï¼ˆ col1&#x3D;5,id&#x3D;5) åˆ°ï¼ˆ col1&#x3D;10,id&#x3D;30) è¿™ä¸ªå‰å¼€åé—­åŒºé—´ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220714135025045-16577778257713.png" class=""> <p>è¿™ä¸ªä¾‹å­å¯¹æˆ‘ä»¬å®è·µçš„æŒ‡å¯¼æ„ä¹‰å°±æ˜¯ï¼Œ åœ¨åˆ é™¤æ•°æ®çš„æ—¶å€™å°½é‡åŠ  limit ã€‚</p><p>è¿™æ ·ä¸ä»…å¯ä»¥æ§åˆ¶åˆ é™¤æ•°æ®çš„æ¡æ•°ï¼Œè®©æ“ä½œæ›´å®‰å…¨ï¼Œè¿˜å¯ä»¥å‡å°åŠ é”çš„èŒƒå›´ã€‚</p><p><strong>æ¡ˆä¾‹å…«ï¼šä¸€ä¸ªæ­»é”çš„ä¾‹å­</strong></p><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220714135047760.png" class=""> <ol><li>session A å¯åŠ¨äº‹åŠ¡åæ‰§è¡ŒæŸ¥è¯¢è¯­å¥åŠ  lock in share mode ï¼Œåœ¨ç´¢å¼• col1 ä¸ŠåŠ äº† next-keylock(5,10] å’Œ é—´éš™é” (10,15) ï¼ˆç´¢å¼•å‘å³éå†é€€åŒ–ä¸ºé—´éš™é”ï¼‰ï¼› </li><li>session B çš„ update è¯­å¥ä¹Ÿè¦åœ¨ç´¢å¼• c ä¸ŠåŠ  next-key lock(5,10] ï¼Œè¿›å…¥é”ç­‰å¾…ï¼› å®é™…ä¸Šåˆ†æˆäº†ä¸¤æ­¥ï¼Œ å…ˆæ˜¯åŠ  (5,10) çš„é—´éš™é”ï¼ŒåŠ é”æˆåŠŸï¼›ç„¶ååŠ  col1&#x3D;10 çš„è¡Œé”ï¼Œå› ä¸ºsessionAä¸Šå·²ç»ç»™è¿™è¡ŒåŠ ä¸Šäº†è¯» é”ï¼Œæ­¤æ—¶ç”³è¯·æ­»é”æ—¶ä¼šè¢«é˜»å¡ </li><li>ç„¶å session A è¦å†æ’å…¥ (8,8,8) è¿™ä¸€è¡Œï¼Œè¢« session B çš„é—´éš™é”é”ä½ã€‚ç”±äºå‡ºç°äº†æ­»é”ï¼Œ InnoDB è®© session B å›æ»š</li></ol><p><strong>æ¡ˆä¾‹ä¹ï¼šorder byç´¢å¼•æ’åºçš„é—´éš™é”1</strong></p><p>å¦‚ä¸‹é¢ä¸€æ¡è¯­å¥</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">begin;</span><br><span class="line">select * from test where id&gt;9 and id&lt;12 order by id desc for update;</span><br></pre></td></tr></table></figure><p>ä¸‹å›¾ä¸ºè¿™ä¸ªè¡¨çš„ç´¢å¼•idçš„ç¤ºæ„å›¾ã€‚</p><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220714135130668.png" class=""> <ol><li>é¦–å…ˆè¿™ä¸ªæŸ¥è¯¢è¯­å¥çš„è¯­ä¹‰æ˜¯ order by id desc ï¼Œè¦æ‹¿åˆ°æ»¡è¶³æ¡ä»¶çš„æ‰€æœ‰è¡Œï¼Œä¼˜åŒ–å™¨å¿…é¡»å…ˆæ‰¾åˆ° â€œ ç¬¬ ä¸€ä¸ª id&lt;12 çš„å€¼ â€ ã€‚ </li><li>è¿™ä¸ªè¿‡ç¨‹æ˜¯é€šè¿‡ç´¢å¼•æ ‘çš„æœç´¢è¿‡ç¨‹å¾—åˆ°çš„ï¼Œåœ¨å¼•æ“å†…éƒ¨ï¼Œå…¶å®æ˜¯è¦æ‰¾åˆ° id&#x3D;12 çš„è¿™ä¸ªå€¼ï¼Œåªæ˜¯æœ€ç»ˆ æ²¡æ‰¾åˆ°ï¼Œä½†æ‰¾åˆ°äº† (10,15) è¿™ä¸ªé—´éš™ã€‚ï¼ˆ id&#x3D;15 ä¸æ»¡è¶³æ¡ä»¶ï¼Œæ‰€ä»¥ next-key lock é€€åŒ–ä¸ºäº†é—´éš™é” (10, 15) ã€‚ï¼‰</li><li>ç„¶åå‘å·¦éå†ï¼Œåœ¨éå†è¿‡ç¨‹ä¸­ï¼Œå°±ä¸æ˜¯ç­‰å€¼æŸ¥è¯¢äº†ï¼Œä¼šæ‰«æåˆ° id&#x3D;5 è¿™ä¸€è¡Œï¼Œåˆå› ä¸ºåŒºé—´æ˜¯å·¦å¼€å³ é—­çš„ï¼Œæ‰€ä»¥ä¼šåŠ ä¸€ä¸ªnext-key lock (0,5] ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œé€šè¿‡æ ‘æœç´¢çš„æ–¹å¼å®šä½è®°å½• çš„æ—¶å€™ï¼Œç”¨çš„æ˜¯ â€œ ç­‰å€¼æŸ¥è¯¢ â€ çš„æ–¹æ³•ã€‚</li></ol><p><strong>æ¡ˆä¾‹åï¼šorder byç´¢å¼•æ’åºçš„é—´éš™é”2</strong></p><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220714135206504.png" class=""> <ol><li><p>ç”±äºæ˜¯ order by col1 desc ï¼Œç¬¬ä¸€ä¸ªè¦å®šä½çš„æ˜¯ç´¢å¼• col1 ä¸Š â€œ æœ€å³è¾¹çš„ â€col1&#x3D;20 çš„è¡Œã€‚è¿™æ˜¯ä¸€ä¸ªéå”¯ä¸€ç´¢å¼•çš„ç­‰å€¼æŸ¥è¯¢ï¼š</p><p>å·¦å¼€å³é—­åŒºé—´ï¼Œé¦–å…ˆåŠ ä¸Š next-key lock (15,20] ã€‚ å‘å³éå†ï¼Œcol1&#x3D;25ä¸æ»¡è¶³æ¡ä»¶ï¼Œé€€åŒ–ä¸ºé—´éš™é” æ‰€ä»¥ä¼š åŠ ä¸Šé—´éš™é”(20,25) å’Œ next-key lock (15,20] ã€‚</p></li><li><p>åœ¨ç´¢å¼• col1 ä¸Šå‘å·¦éå†ï¼Œè¦æ‰«æåˆ° col1&#x3D;10 æ‰åœä¸‹æ¥ã€‚åŒæ—¶åˆå› ä¸ºå·¦å¼€å³é—­åŒºé—´ï¼Œæ‰€ä»¥ next-key lock ä¼šåŠ åˆ° (5,10] ï¼Œè¿™æ­£æ˜¯é˜»å¡session B çš„ insert è¯­å¥çš„åŸå› ã€‚</p></li><li><p>åœ¨æ‰«æè¿‡ç¨‹ä¸­ï¼Œ col1&#x3D;20 ã€ col1&#x3D;15 ã€ col1&#x3D;10 è¿™ä¸‰è¡Œéƒ½å­˜åœ¨å€¼ï¼Œç”±äºæ˜¯ select * ï¼Œæ‰€ä»¥ä¼šåœ¨ä¸»é”® id ä¸ŠåŠ ä¸‰ä¸ªè¡Œé”ã€‚ å› æ­¤ï¼Œ session A çš„ select è¯­å¥é”çš„èŒƒå›´å°±æ˜¯ï¼š</p><ol><li>ç´¢å¼• col1 ä¸Š (5, 25) ï¼›</li><li>ä¸»é”®ç´¢å¼•ä¸Š id&#x3D;15 ã€ 20 ä¸¤ä¸ªè¡Œé”ã€‚</li></ol></li></ol><p><strong>æ¡ˆä¾‹åä¸€ï¼šupdateä¿®æ”¹æ•°æ®çš„ä¾‹å­-å…ˆæ’å…¥ååˆ é™¤</strong></p><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220714135300189.png" class=""> <p>æ³¨æ„ï¼šæ ¹æ® col1&gt;5 æŸ¥åˆ°çš„ç¬¬ä¸€ä¸ªè®°å½•æ˜¯ col1&#x3D;10 ï¼Œå› æ­¤ä¸ä¼šåŠ  (0,5] è¿™ä¸ª next-key lock ã€‚</p><p>session A çš„åŠ é”èŒƒå›´æ˜¯ç´¢å¼• col1 ä¸Šçš„ (5,10] ã€ (10,15] ã€ (15,20] ã€ (20,25] å’Œ(25,supremum] ã€‚</p><p>ä¹‹å session B çš„ç¬¬ä¸€ä¸ª update è¯­å¥ï¼Œè¦æŠŠ col1&#x3D;5 æ”¹æˆ col1&#x3D;1 ï¼Œä½ å¯ä»¥ç†è§£ä¸ºä¸¤æ­¥ï¼š</p><ol><li>æ’å…¥ (col1&#x3D;1, id&#x3D;5) è¿™ä¸ªè®°å½•ï¼›</li><li>åˆ é™¤ (col1&#x3D;5, id&#x3D;5) è¿™ä¸ªè®°å½•ã€‚</li></ol><p>é€šè¿‡è¿™ä¸ªæ“ä½œï¼Œ session A çš„åŠ é”èŒƒå›´å˜æˆäº†å›¾ 7 æ‰€ç¤ºçš„æ ·å­:</p><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220714135333089.png" class=""> <p>å¥½ï¼Œæ¥ä¸‹æ¥ session B è¦æ‰§è¡Œ update t set col1 &#x3D; 5 where col1 &#x3D; 1 è¿™ä¸ªè¯­å¥äº†ï¼Œä¸€æ ·åœ°å¯ä»¥æ‹†æˆä¸¤æ­¥ï¼š</p><ol><li>æ’å…¥ (col1&#x3D;5, id&#x3D;5) è¿™ä¸ªè®°å½•ï¼›</li><li>åˆ é™¤ (col1&#x3D;1, id&#x3D;5) è¿™ä¸ªè®°å½•ã€‚ ç¬¬ä¸€æ­¥è¯•å›¾åœ¨å·²ç»åŠ äº†é—´éš™é”çš„ (1,10) ä¸­æ’å…¥æ•°æ®ï¼Œæ‰€ä»¥å°±è¢«å µä½äº†ã€‚</li></ol><h1 id="ç¬¬16ç« -å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶"><a href="#ç¬¬16ç« -å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶" class="headerlink" title="ç¬¬16ç« _å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶"></a>ç¬¬16ç« _å¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶</h1><h2 id="1-ä»€ä¹ˆæ˜¯MVCC"><a href="#1-ä»€ä¹ˆæ˜¯MVCC" class="headerlink" title="1. ä»€ä¹ˆæ˜¯MVCC"></a>1. ä»€ä¹ˆæ˜¯MVCC</h2><p>MVCC ï¼ˆMultiversion Concurrency Controlï¼‰ï¼Œå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ã€‚é¡¾åæ€ä¹‰ï¼ŒMVCC æ˜¯é€šè¿‡æ•°æ®è¡Œçš„å¤šä¸ªç‰ˆæœ¬ç®¡ç†æ¥å®ç°æ•°æ®åº“çš„ <code>å¹¶å‘æ§åˆ¶ </code>ã€‚è¿™é¡¹æŠ€æœ¯ä½¿å¾—åœ¨InnoDBçš„äº‹åŠ¡éš”ç¦»çº§åˆ«ä¸‹æ‰§è¡Œ <code>ä¸€è‡´æ€§è¯»</code> æ“ä½œæœ‰äº†ä¿è¯ã€‚æ¢è¨€ä¹‹ï¼Œå°±æ˜¯ä¸ºäº†æŸ¥è¯¢ä¸€äº›æ­£åœ¨è¢«å¦ä¸€ä¸ªäº‹åŠ¡æ›´æ–°çš„è¡Œï¼Œå¹¶ä¸”å¯ä»¥çœ‹åˆ°å®ƒä»¬è¢«æ›´æ–°ä¹‹å‰çš„å€¼ï¼Œè¿™æ · åœ¨åšæŸ¥è¯¢çš„æ—¶å€™å°±ä¸ç”¨ç­‰å¾…å¦ä¸€ä¸ªäº‹åŠ¡é‡Šæ”¾é”ã€‚</p><p>MVCCæ²¡æœ‰æ­£å¼çš„æ ‡å‡†ï¼Œåœ¨ä¸åŒçš„DBMSä¸­MVCCçš„å®ç°æ–¹å¼å¯èƒ½æ˜¯ä¸åŒçš„ï¼Œä¹Ÿä¸æ˜¯æ™®éä½¿ç”¨çš„ï¼ˆå¤§å®¶å¯ä»¥å‚è€ƒç›¸å…³çš„DBMSæ–‡æ¡£ï¼‰ã€‚è¿™é‡Œè®²è§£InnoDBä¸­MVCCçš„å®ç°æœºåˆ¶ï¼ˆMySQLå…¶ä»–çš„å­˜å‚¨å¼•æ“å¹¶ä¸æ”¯æŒå®ƒï¼‰ã€‚</p><h2 id="2-å¿«ç…§è¯»ä¸å½“å‰è¯»"><a href="#2-å¿«ç…§è¯»ä¸å½“å‰è¯»" class="headerlink" title="2. å¿«ç…§è¯»ä¸å½“å‰è¯»"></a>2. å¿«ç…§è¯»ä¸å½“å‰è¯»</h2><p>MVCCåœ¨MySQL InnoDBä¸­çš„å®ç°ä¸»è¦æ˜¯ä¸ºäº†æé«˜æ•°æ®åº“å¹¶å‘æ€§èƒ½ï¼Œç”¨æ›´å¥½çš„æ–¹å¼å»å¤„ç† <code>è¯»-å†™å†²çª</code> ï¼Œåšåˆ° å³ä½¿æœ‰è¯»å†™å†²çªæ—¶ï¼Œä¹Ÿèƒ½åšåˆ° <code>ä¸åŠ é”</code> ï¼Œ <code>éé˜»å¡å¹¶å‘è¯»</code> ï¼Œè€Œè¿™ä¸ªè¯»æŒ‡çš„å°±æ˜¯ <code>å¿«ç…§è¯»</code> , è€Œé <code>å½“å‰è¯»</code> ã€‚å½“å‰ è¯»å®é™…ä¸Šæ˜¯ä¸€ç§åŠ é”çš„æ“ä½œï¼Œæ˜¯æ‚²è§‚é”çš„å®ç°ã€‚è€ŒMVCCæœ¬è´¨æ˜¯é‡‡ç”¨ä¹è§‚é”æ€æƒ³çš„ä¸€ç§æ–¹å¼ã€‚</p><h3 id="2-1-å¿«ç…§è¯»"><a href="#2-1-å¿«ç…§è¯»" class="headerlink" title="2.1 å¿«ç…§è¯»"></a>2.1 å¿«ç…§è¯»</h3><p>å¿«ç…§è¯»åˆå«ä¸€è‡´æ€§è¯»ï¼Œè¯»å–çš„æ˜¯å¿«ç…§æ•°æ®ã€‚<strong>ä¸åŠ é”çš„ç®€å•çš„ SELECT éƒ½å±äºå¿«ç…§è¯»</strong>ï¼Œå³ä¸åŠ é”çš„éé˜»å¡ è¯»ï¼›æ¯”å¦‚è¿™æ ·ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM player WHERE ...</span><br></pre></td></tr></table></figure><p>ä¹‹æ‰€ä»¥å‡ºç°å¿«ç…§è¯»çš„æƒ…å†µï¼Œæ˜¯åŸºäºæé«˜å¹¶å‘æ€§èƒ½çš„è€ƒè™‘ï¼Œå¿«ç…§è¯»çš„å®ç°æ˜¯åŸºäºMVCCï¼Œå®ƒåœ¨å¾ˆå¤šæƒ…å†µä¸‹ï¼Œ é¿å…äº†åŠ é”æ“ä½œï¼Œé™ä½äº†å¼€é”€ã€‚</p><p>æ—¢ç„¶æ˜¯åŸºäºå¤šç‰ˆæœ¬ï¼Œé‚£ä¹ˆå¿«ç…§è¯»å¯èƒ½è¯»åˆ°çš„å¹¶ä¸ä¸€å®šæ˜¯æ•°æ®çš„æœ€æ–°ç‰ˆæœ¬ï¼Œè€Œæœ‰å¯èƒ½æ˜¯ä¹‹å‰çš„å†å²ç‰ˆæœ¬ã€‚ </p><p>å¿«ç…§è¯»çš„å‰ææ˜¯éš”ç¦»çº§åˆ«ä¸æ˜¯ä¸²è¡Œçº§åˆ«ï¼Œä¸²è¡Œçº§åˆ«ä¸‹çš„å¿«ç…§è¯»ä¼šé€€åŒ–æˆå½“å‰è¯»ã€‚</p><h3 id="2-2-å½“å‰è¯»"><a href="#2-2-å½“å‰è¯»" class="headerlink" title="2.2 å½“å‰è¯»"></a>2.2 å½“å‰è¯»</h3><p>å½“å‰è¯»è¯»å–çš„æ˜¯è®°å½•çš„æœ€æ–°ç‰ˆæœ¬ï¼ˆæœ€æ–°æ•°æ®ï¼Œè€Œä¸æ˜¯å†å²ç‰ˆæœ¬çš„æ•°æ®ï¼‰ï¼Œè¯»å–æ—¶è¿˜è¦ä¿è¯å…¶ä»–å¹¶å‘äº‹åŠ¡ ä¸èƒ½ä¿®æ”¹å½“å‰è®°å½•ï¼Œä¼šå¯¹è¯»å–çš„è®°å½•è¿›è¡ŒåŠ é”ã€‚åŠ é”çš„ SELECTï¼Œæˆ–è€…å¯¹æ•°æ®è¿›è¡Œå¢åˆ æ”¹éƒ½ä¼šè¿›è¡Œå½“å‰ è¯»ã€‚æ¯”å¦‚ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM student LOCK IN SHARE MODE; # å…±äº«é”</span><br><span class="line">SELECT * FROM student FOR UPDATE; # æ’ä»–é”</span><br><span class="line">INSERT INTO student values ... # æ’ä»–é”</span><br><span class="line">DELETE FROM student WHERE ... # æ’ä»–é”</span><br><span class="line">UPDATE student SET ... # æ’ä»–é”</span><br></pre></td></tr></table></figure><h2 id="3-å¤ä¹ "><a href="#3-å¤ä¹ " class="headerlink" title="3. å¤ä¹ "></a>3. å¤ä¹ </h2><h3 id="3-1-å†è°ˆéš”ç¦»çº§åˆ«"><a href="#3-1-å†è°ˆéš”ç¦»çº§åˆ«" class="headerlink" title="3.1 å†è°ˆéš”ç¦»çº§åˆ«"></a>3.1 å†è°ˆéš”ç¦»çº§åˆ«</h3><p>æˆ‘ä»¬çŸ¥é“äº‹åŠ¡æœ‰ 4 ä¸ªéš”ç¦»çº§åˆ«ï¼Œå¯èƒ½å­˜åœ¨ä¸‰ç§å¹¶å‘é—®é¢˜ï¼š</p><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220714140441064.png" class=""> <img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220714140510426.png" class=""><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220714140541555.png" class=""> <h3 id="3-2-éšè—å­—æ®µã€Undo-Logç‰ˆæœ¬é“¾"><a href="#3-2-éšè—å­—æ®µã€Undo-Logç‰ˆæœ¬é“¾" class="headerlink" title="3.2 éšè—å­—æ®µã€Undo Logç‰ˆæœ¬é“¾"></a>3.2 éšè—å­—æ®µã€Undo Logç‰ˆæœ¬é“¾</h3><p>å›é¡¾ä¸€ä¸‹undoæ—¥å¿—çš„ç‰ˆæœ¬é“¾ï¼Œå¯¹äºä½¿ç”¨ InnoDB å­˜å‚¨å¼•æ“çš„è¡¨æ¥è¯´ï¼Œå®ƒçš„èšç°‡ç´¢å¼•è®°å½•ä¸­éƒ½åŒ…å«ä¸¤ä¸ªå¿…è¦çš„éšè—åˆ—ã€‚</p><ul><li><code>trx_id</code> ï¼šæ¯æ¬¡ä¸€ä¸ªäº‹åŠ¡å¯¹æŸæ¡èšç°‡ç´¢å¼•è®°å½•è¿›è¡Œæ”¹åŠ¨æ—¶ï¼Œéƒ½ä¼šæŠŠè¯¥äº‹åŠ¡çš„ <code>äº‹åŠ¡id</code> èµ‹å€¼ç»™ <code>trx_id</code> éšè—åˆ—ã€‚ </li><li><code>roll_pointer</code> ï¼šæ¯æ¬¡å¯¹æŸæ¡èšç°‡ç´¢å¼•è®°å½•è¿›è¡Œæ”¹åŠ¨æ—¶ï¼Œéƒ½ä¼šæŠŠæ—§çš„ç‰ˆæœ¬å†™å…¥åˆ° <code>undoæ—¥å¿—</code> ä¸­ï¼Œç„¶ åè¿™ä¸ªéšè—åˆ—å°±ç›¸å½“äºä¸€ä¸ªæŒ‡é’ˆï¼Œå¯ä»¥é€šè¿‡å®ƒæ¥æ‰¾åˆ°è¯¥è®°å½•ä¿®æ”¹å‰çš„ä¿¡æ¯ã€‚</li></ul><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220714140716427.png" class=""><p>å‡è®¾æ’å…¥è¯¥è®°å½•çš„<code>äº‹åŠ¡id</code>ä¸º<code>8</code>ï¼Œé‚£ä¹ˆæ­¤åˆ»è¯¥æ¡è®°å½•çš„ç¤ºæ„å›¾å¦‚ä¸‹æ‰€ç¤ºï¼š</p> <img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220714140801595.png" class=""> <blockquote><p>insert undoåªåœ¨äº‹åŠ¡å›æ»šæ—¶èµ·ä½œç”¨ï¼Œå½“äº‹åŠ¡æäº¤åï¼Œè¯¥ç±»å‹çš„undoæ—¥å¿—å°±æ²¡ç”¨äº†ï¼Œå®ƒå ç”¨çš„Undo Log Segmentä¹Ÿä¼šè¢«ç³»ç»Ÿå›æ”¶ï¼ˆä¹Ÿå°±æ˜¯è¯¥undoæ—¥å¿—å ç”¨çš„Undoé¡µé¢é“¾è¡¨è¦ä¹ˆè¢«é‡ç”¨ï¼Œè¦ä¹ˆè¢«é‡Šæ”¾ï¼‰ã€‚</p></blockquote><p>å‡è®¾ä¹‹åä¸¤ä¸ªäº‹åŠ¡idåˆ†åˆ«ä¸º <code>10</code> ã€ <code>20</code> çš„äº‹åŠ¡å¯¹è¿™æ¡è®°å½•è¿›è¡Œ<code> UPDATE</code> æ“ä½œï¼Œæ“ä½œæµç¨‹å¦‚ä¸‹ï¼š</p><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220714140846658.png" class=""> <img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220714140908661.png" class=""><p>æ¯æ¬¡å¯¹è®°å½•è¿›è¡Œæ”¹åŠ¨ï¼Œéƒ½ä¼šè®°å½•ä¸€æ¡undoæ—¥å¿—ï¼Œæ¯æ¡undoæ—¥å¿—ä¹Ÿéƒ½æœ‰ä¸€ä¸ª <code>roll_pointer</code> å±æ€§ ï¼ˆ <code>INSERT</code> æ“ä½œå¯¹åº”çš„undoæ—¥å¿—æ²¡æœ‰è¯¥å±æ€§ï¼Œå› ä¸ºè¯¥è®°å½•å¹¶æ²¡æœ‰æ›´æ—©çš„ç‰ˆæœ¬ï¼‰ï¼Œå¯ä»¥å°†è¿™äº› <code>undoæ—¥å¿—</code> éƒ½è¿èµ·æ¥ï¼Œä¸²æˆä¸€ä¸ªé“¾è¡¨ï¼š</p><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220714141012874.png" class=""> <p>å¯¹è¯¥è®°å½•æ¯æ¬¡æ›´æ–°åï¼Œéƒ½ä¼šå°†æ—§å€¼æ”¾åˆ°ä¸€æ¡ <code>undoæ—¥å¿—</code> ä¸­ï¼Œå°±ç®—æ˜¯è¯¥è®°å½•çš„ä¸€ä¸ªæ—§ç‰ˆæœ¬ï¼Œéšç€æ›´æ–°æ¬¡æ•° çš„å¢å¤šï¼Œæ‰€æœ‰çš„ç‰ˆæœ¬éƒ½ä¼šè¢« <code>roll_pointer</code> å±æ€§è¿æ¥æˆä¸€ä¸ªé“¾è¡¨ï¼Œæˆ‘ä»¬æŠŠè¿™ä¸ªé“¾è¡¨ç§°ä¹‹ä¸º <code>ç‰ˆæœ¬é“¾</code> ï¼Œç‰ˆ æœ¬é“¾çš„å¤´èŠ‚ç‚¹å°±æ˜¯å½“å‰è®°å½•æœ€æ–°çš„å€¼ã€‚</p><p>æ¯ä¸ªç‰ˆæœ¬ä¸­è¿˜åŒ…å«ç”Ÿæˆè¯¥ç‰ˆæœ¬æ—¶å¯¹åº”çš„<code>äº‹åŠ¡id</code>ã€‚</p><h2 id="4-MVCCå®ç°åŸç†ä¹‹ReadView"><a href="#4-MVCCå®ç°åŸç†ä¹‹ReadView" class="headerlink" title="4. MVCCå®ç°åŸç†ä¹‹ReadView"></a>4. MVCCå®ç°åŸç†ä¹‹ReadView</h2><p>MVCC çš„å®ç°ä¾èµ–äºï¼š<code>éšè—å­—æ®µ</code>ã€<code>Undo Log</code>ã€<code>Read View</code>ã€‚</p><h3 id="4-1-ä»€ä¹ˆæ˜¯ReadView"><a href="#4-1-ä»€ä¹ˆæ˜¯ReadView" class="headerlink" title="4.1 ä»€ä¹ˆæ˜¯ReadView"></a>4.1 ä»€ä¹ˆæ˜¯ReadView</h3><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220714141154235.png" class=""><h3 id="4-2-è®¾è®¡æ€è·¯"><a href="#4-2-è®¾è®¡æ€è·¯" class="headerlink" title="4.2 è®¾è®¡æ€è·¯"></a>4.2 è®¾è®¡æ€è·¯</h3><p>ä½¿ç”¨ <code>READ UNCOMMITTED</code> éš”ç¦»çº§åˆ«çš„äº‹åŠ¡ï¼Œç”±äºå¯ä»¥è¯»åˆ°æœªæäº¤äº‹åŠ¡ä¿®æ”¹è¿‡çš„è®°å½•ï¼Œæ‰€ä»¥ç›´æ¥è¯»å–è®°å½•çš„æœ€æ–°ç‰ˆæœ¬å°±å¥½äº†ã€‚</p><p>ä½¿ç”¨ <code>SERIALIZABLE</code> éš”ç¦»çº§åˆ«çš„äº‹åŠ¡ï¼ŒInnoDBè§„å®šä½¿ç”¨åŠ é”çš„æ–¹å¼æ¥è®¿é—®è®°å½•ã€‚</p><p>ä½¿ç”¨ <code>READ COMMITTED</code> å’Œ <code>REPEATABLE READ</code> éš”ç¦»çº§åˆ«çš„äº‹åŠ¡ï¼Œéƒ½å¿…é¡»ä¿è¯è¯»åˆ° <code>å·²ç»æäº¤äº†çš„</code> äº‹åŠ¡ä¿®æ”¹è¿‡çš„è®°å½•ã€‚å‡å¦‚å¦ä¸€ä¸ªäº‹åŠ¡å·²ç»ä¿®æ”¹äº†è®°å½•ä½†æ˜¯å°šæœªæäº¤ï¼Œæ˜¯ä¸èƒ½ç›´æ¥è¯»å–æœ€æ–°ç‰ˆæœ¬çš„è®°å½•çš„ï¼Œæ ¸å¿ƒé—®é¢˜å°±æ˜¯éœ€è¦åˆ¤æ–­ä¸€ä¸‹ç‰ˆæœ¬é“¾ä¸­çš„å“ªä¸ªç‰ˆæœ¬æ˜¯å½“å‰äº‹åŠ¡å¯è§çš„ï¼Œè¿™æ˜¯ReadViewè¦è§£å†³çš„ä¸»è¦é—®é¢˜ã€‚</p><p>è¿™ä¸ªReadViewä¸­ä¸»è¦åŒ…å«4ä¸ªæ¯”è¾ƒé‡è¦çš„å†…å®¹ï¼Œåˆ†åˆ«å¦‚ä¸‹ï¼š</p><ol><li><p><code>creator_trx_id</code> ï¼Œåˆ›å»ºè¿™ä¸ª Read View çš„äº‹åŠ¡ IDã€‚</p><blockquote><p>è¯´æ˜ï¼šåªæœ‰åœ¨å¯¹è¡¨ä¸­çš„è®°å½•åšæ”¹åŠ¨æ—¶ï¼ˆæ‰§è¡ŒINSERTã€DELETEã€UPDATEè¿™äº›è¯­å¥æ—¶ï¼‰æ‰ä¼šä¸º äº‹åŠ¡åˆ†é…äº‹åŠ¡idï¼Œå¦åˆ™åœ¨ä¸€ä¸ªåªè¯»äº‹åŠ¡ä¸­çš„äº‹åŠ¡idå€¼éƒ½é»˜è®¤ä¸º0ã€‚</p></blockquote></li><li><p><code>trx_ids</code> ï¼Œè¡¨ç¤ºåœ¨ç”ŸæˆReadViewæ—¶å½“å‰ç³»ç»Ÿä¸­æ´»è·ƒçš„è¯»å†™äº‹åŠ¡çš„ <code>äº‹åŠ¡idåˆ—è¡¨</code> ã€‚</p></li><li><p><code>up_limit_id</code> ï¼Œæ´»è·ƒçš„äº‹åŠ¡ä¸­æœ€å°çš„äº‹åŠ¡ IDã€‚</p></li><li><p><code>low_limit_id</code> ï¼Œè¡¨ç¤ºç”ŸæˆReadViewæ—¶ç³»ç»Ÿä¸­åº”è¯¥åˆ†é…ç»™ä¸‹ä¸€ä¸ªäº‹åŠ¡çš„ id å€¼ã€‚low_limit_id æ˜¯ç³» ç»Ÿæœ€å¤§çš„äº‹åŠ¡idå€¼ï¼Œè¿™é‡Œè¦æ³¨æ„æ˜¯ç³»ç»Ÿä¸­çš„äº‹åŠ¡idï¼Œéœ€è¦åŒºåˆ«äºæ­£åœ¨æ´»è·ƒçš„äº‹åŠ¡IDã€‚</p></li></ol><blockquote><p>æ³¨æ„ï¼šlow_limit_idå¹¶ä¸æ˜¯trx_idsä¸­çš„æœ€å¤§å€¼ï¼Œäº‹åŠ¡idæ˜¯é€’å¢åˆ†é…çš„ã€‚æ¯”å¦‚ï¼Œç°åœ¨æœ‰idä¸º1ï¼Œ 2ï¼Œ3è¿™ä¸‰ä¸ªäº‹åŠ¡ï¼Œä¹‹åidä¸º3çš„äº‹åŠ¡æäº¤äº†ã€‚é‚£ä¹ˆä¸€ä¸ªæ–°çš„è¯»äº‹åŠ¡åœ¨ç”ŸæˆReadViewæ—¶ï¼Œ trx_idså°±åŒ…æ‹¬1å’Œ2ï¼Œup_limit_idçš„å€¼å°±æ˜¯1ï¼Œlow_limit_idçš„å€¼å°±æ˜¯4ã€‚</p></blockquote><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220714142254768.png" class=""><h3 id="4-3-ReadViewçš„è§„åˆ™"><a href="#4-3-ReadViewçš„è§„åˆ™" class="headerlink" title="4.3 ReadViewçš„è§„åˆ™"></a>4.3 ReadViewçš„è§„åˆ™</h3><p>æœ‰äº†è¿™ä¸ªReadViewï¼Œè¿™æ ·åœ¨è®¿é—®æŸæ¡è®°å½•æ—¶ï¼Œåªéœ€è¦æŒ‰ç…§ä¸‹è¾¹çš„æ­¥éª¤åˆ¤æ–­è®°å½•çš„æŸä¸ªç‰ˆæœ¬æ˜¯å¦å¯è§ã€‚</p><ul><li>å¦‚æœè¢«è®¿é—®ç‰ˆæœ¬çš„trx_idå±æ€§å€¼ä¸ReadViewä¸­çš„ creator_trx_id å€¼ç›¸åŒï¼Œæ„å‘³ç€å½“å‰äº‹åŠ¡åœ¨è®¿é—®å®ƒè‡ªå·±ä¿®æ”¹è¿‡çš„è®°å½•ï¼Œæ‰€ä»¥è¯¥ç‰ˆæœ¬å¯ä»¥è¢«å½“å‰äº‹åŠ¡è®¿é—®ã€‚ </li><li>å¦‚æœè¢«è®¿é—®ç‰ˆæœ¬çš„trx_idå±æ€§å€¼å°äºReadViewä¸­çš„ up_limit_id å€¼ï¼Œè¡¨æ˜ç”Ÿæˆè¯¥ç‰ˆæœ¬çš„äº‹åŠ¡åœ¨å½“å‰äº‹åŠ¡ç”ŸæˆReadViewå‰å·²ç»æäº¤ï¼Œæ‰€ä»¥è¯¥ç‰ˆæœ¬å¯ä»¥è¢«å½“å‰äº‹åŠ¡è®¿é—®ã€‚ </li><li>å¦‚æœè¢«è®¿é—®ç‰ˆæœ¬çš„trx_idå±æ€§å€¼å¤§äºæˆ–ç­‰äºReadViewä¸­çš„ low_limit_id å€¼ï¼Œè¡¨æ˜ç”Ÿæˆè¯¥ç‰ˆæœ¬çš„äº‹åŠ¡åœ¨å½“å‰äº‹åŠ¡ç”ŸæˆReadViewåæ‰å¼€å¯ï¼Œæ‰€ä»¥è¯¥ç‰ˆæœ¬ä¸å¯ä»¥è¢«å½“å‰äº‹åŠ¡è®¿é—®ã€‚ </li><li>å¦‚æœè¢«è®¿é—®ç‰ˆæœ¬çš„trx_idå±æ€§å€¼åœ¨ReadViewçš„ up_limit_id å’Œ low_limit_id ä¹‹é—´ï¼Œé‚£å°±éœ€è¦åˆ¤æ–­ä¸€ä¸‹trx_idå±æ€§å€¼æ˜¯ä¸æ˜¯åœ¨ trx_ids åˆ—è¡¨ä¸­ã€‚<ul><li>å¦‚æœåœ¨ï¼Œè¯´æ˜åˆ›å»ºReadViewæ—¶ç”Ÿæˆè¯¥ç‰ˆæœ¬çš„äº‹åŠ¡è¿˜æ˜¯æ´»è·ƒçš„ï¼Œè¯¥ç‰ˆæœ¬ä¸å¯ä»¥è¢«è®¿é—®ã€‚ </li><li>å¦‚æœä¸åœ¨ï¼Œè¯´æ˜åˆ›å»ºReadViewæ—¶ç”Ÿæˆè¯¥ç‰ˆæœ¬çš„äº‹åŠ¡å·²ç»è¢«æäº¤ï¼Œè¯¥ç‰ˆæœ¬å¯ä»¥è¢«è®¿é—®ã€‚</li></ul></li></ul><h3 id="4-4-MVCCæ•´ä½“æ“ä½œæµç¨‹"><a href="#4-4-MVCCæ•´ä½“æ“ä½œæµç¨‹" class="headerlink" title="4.4 MVCCæ•´ä½“æ“ä½œæµç¨‹"></a>4.4 MVCCæ•´ä½“æ“ä½œæµç¨‹</h3><p>äº†è§£äº†è¿™äº›æ¦‚å¿µä¹‹åï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹å½“æŸ¥è¯¢ä¸€æ¡è®°å½•çš„æ—¶å€™ï¼Œç³»ç»Ÿå¦‚ä½•é€šè¿‡MVCCæ‰¾åˆ°å®ƒï¼š</p><ol><li>é¦–å…ˆè·å–äº‹åŠ¡è‡ªå·±çš„ç‰ˆæœ¬å·ï¼Œä¹Ÿå°±æ˜¯äº‹åŠ¡ IDï¼› </li><li>è·å– ReadViewï¼› </li><li>æŸ¥è¯¢å¾—åˆ°çš„æ•°æ®ï¼Œç„¶åä¸ ReadView ä¸­çš„äº‹åŠ¡ç‰ˆæœ¬å·è¿›è¡Œæ¯”è¾ƒï¼›</li><li>å¦‚æœä¸ç¬¦åˆ ReadView è§„åˆ™ï¼Œå°±éœ€è¦ä» Undo Log ä¸­è·å–å†å²å¿«ç…§ï¼› </li><li>æœ€åè¿”å›ç¬¦åˆè§„åˆ™çš„æ•°æ®ã€‚</li></ol><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220715130639408.png" class=""><p>åœ¨éš”ç¦»çº§åˆ«ä¸ºè¯»å·²æäº¤ï¼ˆRead Committedï¼‰æ—¶ï¼Œä¸€ä¸ªäº‹åŠ¡ä¸­çš„æ¯ä¸€æ¬¡ SELECT æŸ¥è¯¢éƒ½ä¼šé‡æ–°è·å–ä¸€æ¬¡ Read Viewã€‚</p><p>å¦‚è¡¨æ‰€ç¤ºï¼š</p><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220715130843147.png" class=""> <blockquote><p>æ³¨æ„ï¼Œæ­¤æ—¶åŒæ ·çš„æŸ¥è¯¢è¯­å¥éƒ½ä¼šé‡æ–°è·å–ä¸€æ¬¡ Read Viewï¼Œè¿™æ—¶å¦‚æœ Read View ä¸åŒï¼Œå°±å¯èƒ½äº§ç”Ÿä¸å¯é‡å¤è¯»æˆ–è€…å¹»è¯»çš„æƒ…å†µã€‚</p></blockquote><p>å½“éš”ç¦»çº§åˆ«ä¸ºå¯é‡å¤è¯»çš„æ—¶å€™ï¼Œå°±é¿å…äº†ä¸å¯é‡å¤è¯»ï¼Œè¿™æ˜¯å› ä¸ºä¸€ä¸ªäº‹åŠ¡åªåœ¨ç¬¬ä¸€æ¬¡ SELECT çš„æ—¶å€™ä¼šè·å–ä¸€æ¬¡ Read Viewï¼Œè€Œåé¢æ‰€æœ‰çš„ SELECT éƒ½ä¼šå¤ç”¨è¿™ä¸ª Read Viewï¼Œå¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š</p><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220715130916437.png" class=""> <h2 id="5-ä¸¾ä¾‹è¯´æ˜"><a href="#5-ä¸¾ä¾‹è¯´æ˜" class="headerlink" title="5. ä¸¾ä¾‹è¯´æ˜"></a>5. ä¸¾ä¾‹è¯´æ˜</h2><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220715131200077.png" class=""><h3 id="5-1-READ-COMMITTEDéš”ç¦»çº§åˆ«ä¸‹"><a href="#5-1-READ-COMMITTEDéš”ç¦»çº§åˆ«ä¸‹" class="headerlink" title="5.1 READ COMMITTEDéš”ç¦»çº§åˆ«ä¸‹"></a>5.1 READ COMMITTEDéš”ç¦»çº§åˆ«ä¸‹</h3><p><strong>READ COMMITTED ï¼šæ¯æ¬¡è¯»å–æ•°æ®å‰éƒ½ç”Ÿæˆä¸€ä¸ªReadViewã€‚</strong></p><p>ç°åœ¨æœ‰ä¸¤ä¸ª <code>äº‹åŠ¡id</code> åˆ†åˆ«ä¸º <code>10</code> ã€ <code>20</code> çš„äº‹åŠ¡åœ¨æ‰§è¡Œ:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># Transaction 10</span><br><span class="line">BEGIN;</span><br><span class="line">UPDATE student SET name=&quot;æå››&quot; WHERE id=1;</span><br><span class="line">UPDATE student SET name=&quot;ç‹äº”&quot; WHERE id=1;</span><br><span class="line"># Transaction 20</span><br><span class="line">BEGIN;</span><br><span class="line"># æ›´æ–°äº†ä¸€äº›åˆ«çš„è¡¨çš„è®°å½•</span><br><span class="line">...</span><br></pre></td></tr></table></figure><blockquote><p>è¯´æ˜ï¼šäº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œåªæœ‰åœ¨ç¬¬ä¸€æ¬¡çœŸæ­£ä¿®æ”¹è®°å½•æ—¶ï¼ˆæ¯”å¦‚ä½¿ç”¨INSERTã€DELETEã€UPDATEè¯­å¥ï¼‰ï¼Œæ‰ä¼šè¢«åˆ†é…ä¸€ä¸ªå•ç‹¬çš„äº‹åŠ¡idï¼Œè¿™ä¸ªäº‹åŠ¡idæ˜¯é€’å¢çš„ã€‚æ‰€ä»¥æˆ‘ä»¬æ‰åœ¨äº‹åŠ¡2ä¸­æ›´æ–°ä¸€äº›åˆ«çš„è¡¨çš„è®°å½•ï¼Œç›®çš„æ˜¯è®©å®ƒåˆ†é…äº‹åŠ¡idã€‚</p></blockquote><p>æ­¤åˆ»ï¼Œè¡¨student ä¸­ id ä¸º 1 çš„è®°å½•å¾—åˆ°çš„ç‰ˆæœ¬é“¾è¡¨å¦‚ä¸‹æ‰€ç¤ºï¼š</p><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220715133640655.png" class=""> <p>å‡è®¾ç°åœ¨æœ‰ä¸€ä¸ªä½¿ç”¨ <code>READ COMMITTED</code> éš”ç¦»çº§åˆ«çš„äº‹åŠ¡å¼€å§‹æ‰§è¡Œï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># ä½¿ç”¨READ COMMITTEDéš”ç¦»çº§åˆ«çš„äº‹åŠ¡</span><br><span class="line">BEGIN;</span><br><span class="line"></span><br><span class="line"># SELECT1ï¼šTransaction 10ã€20æœªæäº¤</span><br><span class="line">SELECT * FROM student WHERE id = 1; # å¾—åˆ°çš„åˆ—nameçš„å€¼ä¸º&#x27;å¼ ä¸‰&#x27;</span><br></pre></td></tr></table></figure><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220715134540737.png" class=""><p>ä¹‹åï¼Œæˆ‘ä»¬æŠŠ <code>äº‹åŠ¡id</code> ä¸º <code>10</code> çš„äº‹åŠ¡æäº¤ä¸€ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># Transaction 10</span><br><span class="line">BEGIN;</span><br><span class="line">UPDATE student SET name=&quot;æå››&quot; WHERE id=1;</span><br><span class="line">UPDATE student SET name=&quot;ç‹äº”&quot; WHERE id=1;</span><br><span class="line">COMMIT;</span><br></pre></td></tr></table></figure><p>ç„¶åå†åˆ° <code>äº‹åŠ¡id</code> ä¸º <code>20</code> çš„äº‹åŠ¡ä¸­æ›´æ–°ä¸€ä¸‹è¡¨ <code>student</code> ä¸­ <code>id</code> ä¸º <code>1</code> çš„è®°å½•ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># Transaction 20</span><br><span class="line">BEGIN;</span><br><span class="line"># æ›´æ–°äº†ä¸€äº›åˆ«çš„è¡¨çš„è®°å½•</span><br><span class="line">...</span><br><span class="line">UPDATE student SET name=&quot;é’±ä¸ƒ&quot; WHERE id=1;</span><br><span class="line">UPDATE student SET name=&quot;å®‹å…«&quot; WHERE id=1;</span><br></pre></td></tr></table></figure><p>æ­¤åˆ»ï¼Œè¡¨studentä¸­ <code>id</code> ä¸º <code>1</code> çš„è®°å½•çš„ç‰ˆæœ¬é“¾å°±é•¿è¿™æ ·ï¼š</p> <img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220715134839081.png" class=""> <p>ç„¶åå†åˆ°åˆšæ‰ä½¿ç”¨ <code>READ COMMITTED</code> éš”ç¦»çº§åˆ«çš„äº‹åŠ¡ä¸­ç»§ç»­æŸ¥æ‰¾è¿™ä¸ª id ä¸º 1 çš„è®°å½•ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># ä½¿ç”¨READ COMMITTEDéš”ç¦»çº§åˆ«çš„äº‹åŠ¡</span><br><span class="line">BEGIN;</span><br><span class="line"></span><br><span class="line"># SELECT1ï¼šTransaction 10ã€20å‡æœªæäº¤</span><br><span class="line">SELECT * FROM student WHERE id = 1; # å¾—åˆ°çš„åˆ—nameçš„å€¼ä¸º&#x27;å¼ ä¸‰&#x27;</span><br><span class="line"></span><br><span class="line"># SELECT2ï¼šTransaction 10æäº¤ï¼ŒTransaction 20æœªæäº¤</span><br><span class="line">SELECT * FROM student WHERE id = 1; # å¾—åˆ°çš„åˆ—nameçš„å€¼ä¸º&#x27;ç‹äº”&#x27;</span><br></pre></td></tr></table></figure><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220715135017000.png" class=""><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220715135143939.png" class=""><h3 id="5-2-REPEATABLE-READéš”ç¦»çº§åˆ«ä¸‹"><a href="#5-2-REPEATABLE-READéš”ç¦»çº§åˆ«ä¸‹" class="headerlink" title="5.2 REPEATABLE READéš”ç¦»çº§åˆ«ä¸‹"></a>5.2 REPEATABLE READéš”ç¦»çº§åˆ«ä¸‹</h3><p>ä½¿ç”¨ <code>REPEATABLE READ</code> éš”ç¦»çº§åˆ«çš„äº‹åŠ¡æ¥è¯´ï¼Œåªä¼šåœ¨ç¬¬ä¸€æ¬¡æ‰§è¡ŒæŸ¥è¯¢è¯­å¥æ—¶ç”Ÿæˆä¸€ä¸ª <code>ReadView</code> ï¼Œä¹‹åçš„æŸ¥è¯¢å°±ä¸ä¼šé‡å¤ç”Ÿæˆäº†ã€‚</p><p>æ¯”å¦‚ï¼Œç³»ç»Ÿé‡Œæœ‰ä¸¤ä¸ª <code>äº‹åŠ¡id</code> åˆ†åˆ«ä¸º <code>10</code> ã€ <code>20</code> çš„äº‹åŠ¡åœ¨æ‰§è¡Œï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># Transaction 10</span><br><span class="line">BEGIN;</span><br><span class="line">UPDATE student SET name=&quot;æå››&quot; WHERE id=1;</span><br><span class="line">UPDATE student SET name=&quot;ç‹äº”&quot; WHERE id=1;</span><br><span class="line"># Transaction 20</span><br><span class="line">BEGIN;</span><br><span class="line"># æ›´æ–°äº†ä¸€äº›åˆ«çš„è¡¨çš„è®°å½•</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>æ­¤åˆ»ï¼Œè¡¨student ä¸­ id ä¸º 1 çš„è®°å½•å¾—åˆ°çš„ç‰ˆæœ¬é“¾è¡¨å¦‚ä¸‹æ‰€ç¤ºï¼š</p><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220715140006061.png" class=""> <p>å‡è®¾ç°åœ¨æœ‰ä¸€ä¸ªä½¿ç”¨ <code>REPEATABLE READ</code> éš”ç¦»çº§åˆ«çš„äº‹åŠ¡å¼€å§‹æ‰§è¡Œï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># ä½¿ç”¨REPEATABLE READéš”ç¦»çº§åˆ«çš„äº‹åŠ¡</span><br><span class="line">BEGIN;</span><br><span class="line"></span><br><span class="line"># SELECT1ï¼šTransaction 10ã€20æœªæäº¤</span><br><span class="line">SELECT * FROM student WHERE id = 1; # å¾—åˆ°çš„åˆ—nameçš„å€¼ä¸º&#x27;å¼ ä¸‰&#x27;</span><br></pre></td></tr></table></figure><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220715140155744.png" class=""><p>ä¹‹åï¼Œæˆ‘ä»¬æŠŠ <code>äº‹åŠ¡id</code> ä¸º <code>10</code> çš„äº‹åŠ¡æäº¤ä¸€ä¸‹ï¼Œå°±åƒè¿™æ ·ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># Transaction 10</span><br><span class="line">BEGIN;</span><br><span class="line"></span><br><span class="line">UPDATE student SET name=&quot;æå››&quot; WHERE id=1;</span><br><span class="line">UPDATE student SET name=&quot;ç‹äº”&quot; WHERE id=1;</span><br><span class="line"></span><br><span class="line">COMMIT;</span><br></pre></td></tr></table></figure><p>ç„¶åå†åˆ° <code>äº‹åŠ¡id</code> ä¸º <code>20</code> çš„äº‹åŠ¡ä¸­æ›´æ–°ä¸€ä¸‹è¡¨ <code>student</code> ä¸­ <code>id</code> ä¸º <code>1</code> çš„è®°å½•ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># Transaction 20</span><br><span class="line">BEGIN;</span><br><span class="line"># æ›´æ–°äº†ä¸€äº›åˆ«çš„è¡¨çš„è®°å½•</span><br><span class="line">...</span><br><span class="line">UPDATE student SET name=&quot;é’±ä¸ƒ&quot; WHERE id=1;</span><br><span class="line">UPDATE student SET name=&quot;å®‹å…«&quot; WHERE id=1;</span><br></pre></td></tr></table></figure><p>æ­¤åˆ»ï¼Œè¡¨student ä¸­ <code>id</code> ä¸º <code>1</code> çš„è®°å½•çš„ç‰ˆæœ¬é“¾é•¿è¿™æ ·ï¼š</p><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220715140354217.png" class=""> <p>ç„¶åå†åˆ°åˆšæ‰ä½¿ç”¨ <code>REPEATABLE READ</code> éš”ç¦»çº§åˆ«çš„äº‹åŠ¡ä¸­ç»§ç»­æŸ¥æ‰¾è¿™ä¸ª <code>id</code> ä¸º <code>1</code> çš„è®°å½•ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># ä½¿ç”¨REPEATABLE READéš”ç¦»çº§åˆ«çš„äº‹åŠ¡</span><br><span class="line">BEGIN;</span><br><span class="line"># SELECT1ï¼šTransaction 10ã€20å‡æœªæäº¤</span><br><span class="line">SELECT * FROM student WHERE id = 1; # å¾—åˆ°çš„åˆ—nameçš„å€¼ä¸º&#x27;å¼ ä¸‰&#x27;</span><br><span class="line"># SELECT2ï¼šTransaction 10æäº¤ï¼ŒTransaction 20æœªæäº¤</span><br><span class="line">SELECT * FROM student WHERE id = 1; # å¾—åˆ°çš„åˆ—nameçš„å€¼ä»ä¸º&#x27;å¼ ä¸‰&#x27;</span><br></pre></td></tr></table></figure><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220715140555172.png" class=""><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220715140620328.png" class=""><p>è¿™æ¬¡<code>SELECT</code>æŸ¥è¯¢å¾—åˆ°çš„ç»“æœæ˜¯é‡å¤çš„ï¼Œè®°å½•çš„åˆ—<code>c</code>å€¼éƒ½æ˜¯<code>å¼ ä¸‰</code>ï¼Œè¿™å°±æ˜¯<code>å¯é‡å¤è¯»</code>çš„å«ä¹‰ã€‚å¦‚æœæˆ‘ä»¬ä¹‹åå†æŠŠ<code>äº‹åŠ¡id</code>ä¸º<code>20</code>çš„è®°å½•æäº¤äº†ï¼Œç„¶åå†åˆ°åˆšæ‰ä½¿ç”¨<code>REPEATABLE READ</code>éš”ç¦»çº§åˆ«çš„äº‹åŠ¡ä¸­ç»§ç»­æŸ¥æ‰¾è¿™ä¸ª<code>id</code>ä¸º<code>1</code>çš„è®°å½•ï¼Œå¾—åˆ°çš„ç»“æœè¿˜æ˜¯<code>å¼ ä¸‰</code>ï¼Œå…·ä½“æ‰§è¡Œè¿‡ç¨‹å¤§å®¶å¯ä»¥è‡ªå·±åˆ†æä¸€ä¸‹ã€‚</p><h3 id="5-3-å¦‚ä½•è§£å†³å¹»è¯»"><a href="#5-3-å¦‚ä½•è§£å†³å¹»è¯»" class="headerlink" title="5.3 å¦‚ä½•è§£å†³å¹»è¯»"></a>5.3 å¦‚ä½•è§£å†³å¹»è¯»</h3><p>æ¥ä¸‹æ¥è¯´æ˜InnoDB æ˜¯å¦‚ä½•è§£å†³å¹»è¯»çš„ã€‚</p><p>å‡è®¾ç°åœ¨è¡¨ student ä¸­åªæœ‰ä¸€æ¡æ•°æ®ï¼Œæ•°æ®å†…å®¹ä¸­ï¼Œä¸»é”® id&#x3D;1ï¼Œéšè—çš„ trx_id&#x3D;10ï¼Œå®ƒçš„ undo log å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220715141002035.png" class=""><p>å‡è®¾ç°åœ¨æœ‰äº‹åŠ¡ A å’Œäº‹åŠ¡ B å¹¶å‘æ‰§è¡Œï¼Œ<code>äº‹åŠ¡ A</code> çš„äº‹åŠ¡ id ä¸º <code>20</code> ï¼Œ <code>äº‹åŠ¡ B</code> çš„äº‹åŠ¡ id ä¸º <code>30</code> ã€‚</p><p>æ­¥éª¤1ï¼šäº‹åŠ¡ A å¼€å§‹ç¬¬ä¸€æ¬¡æŸ¥è¯¢æ•°æ®ï¼ŒæŸ¥è¯¢çš„ SQL è¯­å¥å¦‚ä¸‹ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from student where id &gt;= 1;</span><br></pre></td></tr></table></figure><p>åœ¨å¼€å§‹æŸ¥è¯¢ä¹‹å‰ï¼ŒMySQL ä¼šä¸ºäº‹åŠ¡ A äº§ç”Ÿä¸€ä¸ª ReadViewï¼Œæ­¤æ—¶ ReadView çš„å†…å®¹å¦‚ä¸‹ï¼š <code>trx_ids= [20,30] ï¼Œ up_limit_id=20 ï¼Œ low_limit_id=31 ï¼Œ creator_trx_id=20</code> ã€‚</p><p>ç”±äºæ­¤æ—¶è¡¨ student ä¸­åªæœ‰ä¸€æ¡æ•°æ®ï¼Œä¸”ç¬¦åˆ where id&gt;&#x3D;1 æ¡ä»¶ï¼Œå› æ­¤ä¼šæŸ¥è¯¢å‡ºæ¥ã€‚ç„¶åæ ¹æ® ReadView æœºåˆ¶ï¼Œå‘ç°è¯¥è¡Œæ•°æ®çš„trx_id&#x3D;10ï¼Œå°äºäº‹åŠ¡ A çš„ ReadView é‡Œ up_limit_idï¼Œè¿™è¡¨ç¤ºè¿™æ¡æ•°æ®æ˜¯äº‹åŠ¡ A å¼€å¯ä¹‹å‰ï¼Œå…¶ä»–äº‹åŠ¡å°±å·²ç»æäº¤äº†çš„æ•°æ®ï¼Œå› æ­¤äº‹åŠ¡ A å¯ä»¥è¯»å–åˆ°ã€‚</p><p>ç»“è®ºï¼šäº‹åŠ¡ A çš„ç¬¬ä¸€æ¬¡æŸ¥è¯¢ï¼Œèƒ½è¯»å–åˆ°ä¸€æ¡æ•°æ®ï¼Œid&#x3D;1ã€‚</p><p>æ­¥éª¤2ï¼šæ¥ç€äº‹åŠ¡ B(trx_id&#x3D;30)ï¼Œå¾€è¡¨ student ä¸­æ–°æ’å…¥ä¸¤æ¡æ•°æ®ï¼Œå¹¶æäº¤äº‹åŠ¡ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">insert into student(id,name) values(2,&#x27;æå››&#x27;);</span><br><span class="line">insert into student(id,name) values(3,&#x27;ç‹äº”&#x27;);</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶è¡¨student ä¸­å°±æœ‰ä¸‰æ¡æ•°æ®äº†ï¼Œå¯¹åº”çš„ undo å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220715141208667.png" class=""> <p>æ­¥éª¤3ï¼šæ¥ç€äº‹åŠ¡ A å¼€å¯ç¬¬äºŒæ¬¡æŸ¥è¯¢ï¼Œæ ¹æ®å¯é‡å¤è¯»éš”ç¦»çº§åˆ«çš„è§„åˆ™ï¼Œæ­¤æ—¶äº‹åŠ¡ A å¹¶ä¸ä¼šå†é‡æ–°ç”Ÿæˆ ReadViewã€‚æ­¤æ—¶è¡¨ student ä¸­çš„ 3 æ¡æ•°æ®éƒ½æ»¡è¶³ where id&gt;&#x3D;1 çš„æ¡ä»¶ï¼Œå› æ­¤ä¼šå…ˆæŸ¥å‡ºæ¥ã€‚ç„¶åæ ¹æ® ReadView æœºåˆ¶ï¼Œåˆ¤æ–­æ¯æ¡æ•°æ®æ˜¯ä¸æ˜¯éƒ½å¯ä»¥è¢«äº‹åŠ¡ A çœ‹åˆ°ã€‚</p><p>1ï¼‰é¦–å…ˆ id&#x3D;1 çš„è¿™æ¡æ•°æ®ï¼Œå‰é¢å·²ç»è¯´è¿‡äº†ï¼Œå¯ä»¥è¢«äº‹åŠ¡ A çœ‹åˆ°ã€‚ </p><p>2ï¼‰ç„¶åæ˜¯ id&#x3D;2 çš„æ•°æ®ï¼Œå®ƒçš„ trx_id&#x3D;30ï¼Œæ­¤æ—¶äº‹åŠ¡ A å‘ç°ï¼Œè¿™ä¸ªå€¼å¤„äº up_limit_id å’Œ low_limit_id ä¹‹ é—´ï¼Œå› æ­¤è¿˜éœ€è¦å†åˆ¤æ–­ 30 æ˜¯å¦å¤„äº trx_ids æ•°ç»„å†…ã€‚ç”±äºäº‹åŠ¡ A çš„ trx_ids&#x3D;[20,30]ï¼Œå› æ­¤åœ¨æ•°ç»„å†…ï¼Œè¿™è¡¨ ç¤º id&#x3D;2 çš„è¿™æ¡æ•°æ®æ˜¯ä¸äº‹åŠ¡ A åœ¨åŒä¸€æ—¶åˆ»å¯åŠ¨çš„å…¶ä»–äº‹åŠ¡æäº¤çš„ï¼Œæ‰€ä»¥è¿™æ¡æ•°æ®ä¸èƒ½è®©äº‹åŠ¡ A çœ‹åˆ°ã€‚</p><p>3ï¼‰åŒç†ï¼Œid&#x3D;3 çš„è¿™æ¡æ•°æ®ï¼Œtrx_id ä¹Ÿä¸º 30ï¼Œå› æ­¤ä¹Ÿä¸èƒ½è¢«äº‹åŠ¡ A çœ‹è§ã€‚</p><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220715141243993.png" class=""> <p>ç»“è®ºï¼šæœ€ç»ˆäº‹åŠ¡ A çš„ç¬¬äºŒæ¬¡æŸ¥è¯¢ï¼Œåªèƒ½æŸ¥è¯¢å‡º id&#x3D;1 çš„è¿™æ¡æ•°æ®ã€‚è¿™å’Œäº‹åŠ¡ A çš„ç¬¬ä¸€æ¬¡æŸ¥è¯¢çš„ç»“æœæ˜¯ä¸€æ · çš„ï¼Œå› æ­¤æ²¡æœ‰å‡ºç°å¹»è¯»ç°è±¡ï¼Œæ‰€ä»¥è¯´åœ¨ MySQL çš„å¯é‡å¤è¯»éš”ç¦»çº§åˆ«ä¸‹ï¼Œä¸å­˜åœ¨å¹»è¯»é—®é¢˜ã€‚</p><h2 id="6-æ€»ç»“"><a href="#6-æ€»ç»“" class="headerlink" title="6. æ€»ç»“"></a>6. æ€»ç»“</h2><p>è¿™é‡Œä»‹ç»äº† MVCC åœ¨ <code>READ COMMITTD</code> ã€ <code>REPEATABLE READ</code> è¿™ä¸¤ç§éš”ç¦»çº§åˆ«çš„äº‹åŠ¡åœ¨æ‰§è¡Œå¿«ç…§è¯»æ“ä½œæ—¶ è®¿é—®è®°å½•çš„ç‰ˆæœ¬é“¾çš„è¿‡ç¨‹ã€‚è¿™æ ·ä½¿ä¸åŒäº‹åŠ¡çš„ <code>è¯»-å†™</code> ã€ <code>å†™-è¯»</code> æ“ä½œå¹¶å‘æ‰§è¡Œï¼Œä»è€Œæå‡ç³»ç»Ÿæ€§èƒ½ã€‚</p><p>æ ¸å¿ƒç‚¹åœ¨äº ReadView çš„åŸç†ï¼Œ <code>READ COMMITTD</code> ã€ <code>REPEATABLE READ</code> è¿™ä¸¤ä¸ªéš”ç¦»çº§åˆ«çš„ä¸€ä¸ªå¾ˆå¤§ä¸åŒ å°±æ˜¯ç”ŸæˆReadViewçš„æ—¶æœºä¸åŒï¼š</p><ul><li><code>READ COMMITTD</code> åœ¨æ¯ä¸€æ¬¡è¿›è¡Œæ™®é€šSELECTæ“ä½œå‰éƒ½ä¼šç”Ÿæˆä¸€ä¸ªReadView </li><li><code>REPEATABLE READ</code> åªåœ¨ç¬¬ä¸€æ¬¡è¿›è¡Œæ™®é€šSELECTæ“ä½œå‰ç”Ÿæˆä¸€ä¸ªReadViewï¼Œä¹‹åçš„æŸ¥è¯¢æ“ä½œéƒ½é‡å¤ ä½¿ç”¨è¿™ä¸ªReadViewå°±å¥½äº†ã€‚</li></ul><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220715141413135.png" class=""><p>é€šè¿‡MVCCæˆ‘ä»¬å¯ä»¥è§£å†³ï¼š</p><img src="/2023/03/04/03-%E4%BA%8B%E5%8A%A1%E7%AF%87/image-20220715141515370.png" class="">]]></content>
      
      
      <categories>
          
          <category> Mysql </category>
          
          <category> Mysqlé«˜çº§ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Mysqlé«˜çº§ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>02_MySQLç´¢å¼•åŠè°ƒä¼˜ç¯‡</title>
      <link href="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/"/>
      <url>/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/</url>
      
        <content type="html"><![CDATA[<h1 id="ç¬¬06ç« -ç´¢å¼•çš„æ•°æ®ç»“æ„"><a href="#ç¬¬06ç« -ç´¢å¼•çš„æ•°æ®ç»“æ„" class="headerlink" title="ç¬¬06ç« _ç´¢å¼•çš„æ•°æ®ç»“æ„"></a>ç¬¬06ç« _ç´¢å¼•çš„æ•°æ®ç»“æ„</h1><h2 id="1-ä¸ºä»€ä¹ˆä½¿ç”¨ç´¢å¼•"><a href="#1-ä¸ºä»€ä¹ˆä½¿ç”¨ç´¢å¼•" class="headerlink" title="1. ä¸ºä»€ä¹ˆä½¿ç”¨ç´¢å¼•"></a>1. ä¸ºä»€ä¹ˆä½¿ç”¨ç´¢å¼•</h2><p>ç´¢å¼•æ˜¯å­˜å‚¨å¼•æ“ç”¨äºå¿«é€Ÿæ‰¾åˆ°æ•°æ®è®°å½•çš„ä¸€ç§æ•°æ®ç»“æ„ï¼Œå°±å¥½æ¯”ä¸€æœ¬æ•™ç§‘ä¹¦çš„ç›®å½•éƒ¨åˆ†ï¼Œé€šè¿‡ç›®å½•ä¸­æ‰¾åˆ°å¯¹åº”æ–‡ç« çš„é¡µç ï¼Œä¾¿å¯å¿«é€Ÿå®šä½åˆ°éœ€è¦çš„æ–‡ç« ã€‚MySQLä¸­ä¹Ÿæ˜¯ä¸€æ ·çš„é“ç†ï¼Œè¿›è¡Œæ•°æ®æŸ¥æ‰¾æ—¶ï¼Œé¦–å…ˆæŸ¥çœ‹æŸ¥è¯¢æ¡ä»¶æ˜¯å¦å‘½ä¸­æŸæ¡ç´¢å¼•ï¼Œç¬¦åˆåˆ™<code>é€šè¿‡ç´¢å¼•æŸ¥æ‰¾</code>ç›¸å…³æ•°æ®ï¼Œå¦‚æœä¸ç¬¦åˆåˆ™éœ€è¦<code>å…¨è¡¨æ‰«æ</code>ï¼Œå³éœ€è¦ä¸€æ¡ä¸€æ¡åœ°æŸ¥æ‰¾è®°å½•ï¼Œç›´åˆ°æ‰¾åˆ°ä¸æ¡ä»¶ç¬¦åˆçš„è®°å½•ã€‚</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220616141351236.png" class=""><p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œæ•°æ®åº“æ²¡æœ‰ç´¢å¼•çš„æƒ…å†µä¸‹ï¼Œæ•°æ®<code>åˆ†å¸ƒåœ¨ç¡¬ç›˜ä¸åŒçš„ä½ç½®ä¸Šé¢</code>ï¼Œè¯»å–æ•°æ®æ—¶ï¼Œæ‘†è‡‚éœ€è¦å‰åæ‘†åŠ¨æŸ¥è¯¢æ•°æ®ï¼Œè¿™æ ·æ“ä½œéå¸¸æ¶ˆè€—æ—¶é—´ã€‚å¦‚æœ<code>æ•°æ®é¡ºåºæ‘†æ”¾</code>ï¼Œé‚£ä¹ˆä¹Ÿéœ€è¦ä»1åˆ°6è¡ŒæŒ‰é¡ºåºè¯»å–ï¼Œè¿™æ ·å°±ç›¸å½“äºè¿›è¡Œäº†6æ¬¡IOæ“ä½œï¼Œ<code>ä¾æ—§éå¸¸è€—æ—¶</code>ã€‚å¦‚æœæˆ‘ä»¬ä¸å€ŸåŠ©ä»»ä½•ç´¢å¼•ç»“æ„å¸®åŠ©æˆ‘ä»¬å¿«é€Ÿå®šä½æ•°æ®çš„è¯ï¼Œæˆ‘ä»¬æŸ¥æ‰¾ Col 2 &#x3D; 89 è¿™æ¡è®°å½•ï¼Œå°±è¦é€è¡Œå»æŸ¥æ‰¾ã€å»æ¯”è¾ƒã€‚ä»Col 2 &#x3D; 34 å¼€å§‹ï¼Œè¿›è¡Œæ¯”è¾ƒï¼Œå‘ç°ä¸æ˜¯ï¼Œç»§ç»­ä¸‹ä¸€è¡Œã€‚æˆ‘ä»¬å½“å‰çš„è¡¨åªæœ‰ä¸åˆ°10è¡Œæ•°æ®ï¼Œä½†å¦‚æœè¡¨å¾ˆå¤§çš„è¯ï¼Œæœ‰<code>ä¸Šåƒä¸‡æ¡æ•°æ®</code>ï¼Œå°±æ„å‘³ç€è¦åš<code>å¾ˆå¤šå¾ˆå¤šæ¬¡ç¡¬ç›˜I/0</code>æ‰èƒ½æ‰¾åˆ°ã€‚ç°åœ¨è¦æŸ¥æ‰¾ Col 2 &#x3D; 89 è¿™æ¡è®°å½•ã€‚CPUå¿…é¡»å…ˆå»ç£ç›˜æŸ¥æ‰¾è¿™æ¡è®°å½•ï¼Œæ‰¾åˆ°ä¹‹ååŠ è½½åˆ°å†…å­˜ï¼Œå†å¯¹æ•°æ®è¿›è¡Œå¤„ç†ã€‚è¿™ä¸ªè¿‡ç¨‹æœ€è€—æ—¶é—´å°±æ˜¯ç£ç›˜I&#x2F;Oï¼ˆæ¶‰åŠåˆ°ç£ç›˜çš„æ—‹è½¬æ—¶é—´ï¼ˆé€Ÿåº¦è¾ƒå¿«ï¼‰ï¼Œç£å¤´çš„å¯»é“æ—¶é—´(é€Ÿåº¦æ…¢ã€è´¹æ—¶)ï¼‰</p><p>å‡å¦‚ç»™æ•°æ®ä½¿ç”¨ <code>äºŒå‰æ ‘</code> è¿™æ ·çš„æ•°æ®ç»“æ„è¿›è¡Œå­˜å‚¨ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220616142723266.png" class=""><p>å¯¹å­—æ®µ Col 2 æ·»åŠ äº†ç´¢å¼•ï¼Œå°±ç›¸å½“äºåœ¨ç¡¬ç›˜ä¸Šä¸º Col 2 ç»´æŠ¤äº†ä¸€ä¸ªç´¢å¼•çš„æ•°æ®ç»“æ„ï¼Œå³è¿™ä¸ª <code>äºŒå‰æœç´¢æ ‘</code>ã€‚äºŒå‰æœç´¢æ ‘çš„æ¯ä¸ªç»“ç‚¹å­˜å‚¨çš„æ˜¯ <code>(K, V) ç»“æ„</code>ï¼Œkey æ˜¯ Col 2ï¼Œvalue æ˜¯è¯¥ key æ‰€åœ¨è¡Œçš„æ–‡ä»¶æŒ‡é’ˆï¼ˆåœ°å€ï¼‰ã€‚æ¯”å¦‚ï¼šè¯¥äºŒå‰æœç´¢æ ‘çš„æ ¹èŠ‚ç‚¹å°±æ˜¯ï¼š<code>(34, 0x07)</code>ã€‚ç°åœ¨å¯¹ Col 2 æ·»åŠ äº†ç´¢å¼•ï¼Œè¿™æ—¶å†å»æŸ¥æ‰¾ Col 2 &#x3D; 89 è¿™æ¡è®°å½•çš„æ—¶å€™ä¼šå…ˆå»æŸ¥æ‰¾è¯¥äºŒå‰æœç´¢æ ‘ï¼ˆäºŒå‰æ ‘çš„éå†æŸ¥æ‰¾ï¼‰ã€‚è¯» 34 åˆ°å†…å­˜ï¼Œ89 &gt; 34; ç»§ç»­å³ä¾§æ•°æ®ï¼Œè¯» 89 åˆ°å†…å­˜ï¼Œ89&#x3D;&#x3D;89ï¼›æ‰¾åˆ°æ•°æ®è¿”å›ã€‚æ‰¾åˆ°ä¹‹åå°±æ ¹æ®å½“å‰ç»“ç‚¹çš„ value å¿«é€Ÿå®šä½åˆ°è¦æŸ¥æ‰¾çš„è®°å½•å¯¹åº”çš„åœ°å€ã€‚æˆ‘ä»¬å¯ä»¥å‘ç°ï¼Œåªéœ€è¦ <code>æŸ¥æ‰¾ä¸¤æ¬¡</code> å°±å¯ä»¥å®šä½åˆ°è®°å½•çš„åœ°å€ï¼ŒæŸ¥è¯¢é€Ÿåº¦å°±æé«˜äº†ã€‚</p><p>è¿™å°±æ˜¯æˆ‘ä»¬ä¸ºä»€ä¹ˆè¦å»ºç´¢å¼•ï¼Œç›®çš„å°±æ˜¯ä¸ºäº† <code>å‡å°‘ç£ç›˜I/Oçš„æ¬¡æ•°</code>ï¼ŒåŠ å¿«æŸ¥è¯¢é€Ÿç‡ã€‚</p><h2 id="2-ç´¢å¼•åŠå…¶ä¼˜ç¼ºç‚¹"><a href="#2-ç´¢å¼•åŠå…¶ä¼˜ç¼ºç‚¹" class="headerlink" title="2. ç´¢å¼•åŠå…¶ä¼˜ç¼ºç‚¹"></a>2. ç´¢å¼•åŠå…¶ä¼˜ç¼ºç‚¹</h2><h3 id="2-1-ç´¢å¼•æ¦‚è¿°"><a href="#2-1-ç´¢å¼•æ¦‚è¿°" class="headerlink" title="2.1 ç´¢å¼•æ¦‚è¿°"></a>2.1 ç´¢å¼•æ¦‚è¿°</h3><p>MySQLå®˜æ–¹å¯¹ç´¢å¼•çš„å®šä¹‰ä¸ºï¼šç´¢å¼•ï¼ˆIndexï¼‰æ˜¯å¸®åŠ©MySQLé«˜æ•ˆè·å–æ•°æ®çš„æ•°æ®ç»“æ„ã€‚</p><p><strong>ç´¢å¼•çš„æœ¬è´¨</strong>ï¼šç´¢å¼•æ˜¯æ•°æ®ç»“æ„ã€‚ä½ å¯ä»¥ç®€å•ç†è§£ä¸ºâ€œæ’å¥½åºçš„å¿«é€ŸæŸ¥æ‰¾æ•°æ®ç»“æ„â€ï¼Œæ»¡è¶³ç‰¹å®šæŸ¥æ‰¾ç®—æ³•ã€‚ è¿™äº›æ•°æ®ç»“æ„ä»¥æŸç§æ–¹å¼æŒ‡å‘æ•°æ®ï¼Œ è¿™æ ·å°±å¯ä»¥åœ¨è¿™äº›æ•°æ®ç»“æ„çš„åŸºç¡€ä¸Šå®ç° <code>é«˜çº§æŸ¥æ‰¾ç®—æ³•</code> ã€‚</p><p><code>ç´¢å¼•æ˜¯åœ¨å­˜å‚¨å¼•æ“ä¸­å®ç°çš„</code>ï¼Œå› æ­¤æ¯ç§å­˜å‚¨å¼•æ“çš„ç´¢å¼•ä¸ä¸€å®šå®Œå…¨ç›¸åŒï¼Œå¹¶ä¸”æ¯ç§å­˜å‚¨å¼•æ“ä¸ä¸€å®šæ”¯æŒæ‰€æœ‰ç´¢å¼•ç±»å‹ã€‚åŒæ—¶ï¼Œå­˜å‚¨å¼•æ“å¯ä»¥å®šä¹‰æ¯ä¸ªè¡¨çš„ <code>æœ€å¤§ç´¢å¼•æ•°</code>å’Œ <code>æœ€å¤§ç´¢å¼•é•¿åº¦</code>ã€‚æ‰€æœ‰å­˜å‚¨å¼•æ“æ”¯æŒæ¯ä¸ªè¡¨è‡³å°‘16ä¸ªç´¢å¼•ï¼Œæ€»ç´¢å¼•é•¿åº¦è‡³å°‘ä¸º256å­—èŠ‚ã€‚æœ‰äº›å­˜å‚¨å¼•æ“æ”¯æŒæ›´å¤šçš„ç´¢å¼•æ•°å’Œæ›´å¤§çš„ç´¢å¼•é•¿åº¦ã€‚</p><h3 id="2-2-ä¼˜ç‚¹"><a href="#2-2-ä¼˜ç‚¹" class="headerlink" title="2.2 ä¼˜ç‚¹"></a>2.2 ä¼˜ç‚¹</h3><p>ï¼ˆ1ï¼‰ç±»ä¼¼å¤§å­¦å›¾ä¹¦é¦†å»ºä¹¦ç›®ç´¢å¼•ï¼Œæé«˜æ•°æ®æ£€ç´¢çš„æ•ˆç‡ï¼Œé™ä½ <strong>æ•°æ®åº“çš„IOæˆæœ¬</strong> ï¼Œè¿™ä¹Ÿæ˜¯åˆ›å»ºç´¢å¼•æœ€ä¸» è¦çš„åŸå› ã€‚ </p><p>ï¼ˆ2ï¼‰é€šè¿‡åˆ›å»ºå”¯ä¸€ç´¢å¼•ï¼Œå¯ä»¥ä¿è¯æ•°æ®åº“è¡¨ä¸­æ¯ä¸€è¡Œ <strong>æ•°æ®çš„å”¯ä¸€æ€§</strong> ã€‚ </p><p>ï¼ˆ3ï¼‰åœ¨å®ç°æ•°æ®çš„ å‚è€ƒå®Œæ•´æ€§æ–¹é¢ï¼Œå¯ä»¥ <strong>åŠ é€Ÿè¡¨å’Œè¡¨ä¹‹é—´çš„è¿æ¥</strong> ã€‚æ¢å¥è¯è¯´ï¼Œå¯¹äºæœ‰ä¾èµ–å…³ç³»çš„å­è¡¨å’Œçˆ¶è¡¨è”åˆæŸ¥è¯¢æ—¶ï¼Œ å¯ä»¥æé«˜æŸ¥è¯¢é€Ÿåº¦ã€‚ </p><p>ï¼ˆ4ï¼‰åœ¨ä½¿ç”¨åˆ†ç»„å’Œæ’åºå­å¥è¿›è¡Œæ•°æ®æŸ¥è¯¢æ—¶ï¼Œå¯ä»¥æ˜¾è‘— <strong>å‡å°‘æŸ¥è¯¢ä¸­åˆ†ç»„å’Œæ’åºçš„æ—¶é—´</strong> ï¼Œé™ä½äº†CPUçš„æ¶ˆè€—ã€‚</p><h3 id="2-3-ç¼ºç‚¹"><a href="#2-3-ç¼ºç‚¹" class="headerlink" title="2.3 ç¼ºç‚¹"></a>2.3 ç¼ºç‚¹</h3><p>å¢åŠ ç´¢å¼•ä¹Ÿæœ‰è®¸å¤šä¸åˆ©çš„æ–¹é¢ï¼Œä¸»è¦è¡¨ç°åœ¨å¦‚ä¸‹å‡ ä¸ªæ–¹é¢ï¼š </p><p>ï¼ˆ1ï¼‰åˆ›å»ºç´¢å¼•å’Œç»´æŠ¤ç´¢å¼•è¦ <strong>è€—è´¹æ—¶é—´</strong> ï¼Œå¹¶ ä¸”éšç€æ•°æ®é‡çš„å¢åŠ ï¼Œæ‰€è€—è´¹çš„æ—¶é—´ä¹Ÿä¼šå¢åŠ ã€‚ </p><p>ï¼ˆ2ï¼‰ç´¢å¼•éœ€è¦å  <strong>ç£ç›˜ç©ºé—´</strong> ï¼Œé™¤äº†æ•°æ®è¡¨å æ•°æ®ç©ºé—´ä¹‹ å¤–ï¼Œæ¯ä¸€ä¸ªç´¢å¼•è¿˜è¦å ä¸€å®šçš„ç‰©ç†ç©ºé—´ï¼Œ å­˜å‚¨åœ¨ç£ç›˜ä¸Š ï¼Œå¦‚æœæœ‰å¤§é‡çš„ç´¢å¼•ï¼Œç´¢å¼•æ–‡ä»¶å°±å¯èƒ½æ¯”æ•°æ®æ–‡ ä»¶æ›´å¿«è¾¾åˆ°æœ€å¤§æ–‡ä»¶å°ºå¯¸ã€‚ </p><p>ï¼ˆ3ï¼‰è™½ç„¶ç´¢å¼•å¤§å¤§æé«˜äº†æŸ¥è¯¢é€Ÿåº¦ï¼ŒåŒæ—¶å´ä¼š <strong>é™ä½æ›´æ–°è¡¨çš„é€Ÿåº¦</strong> ã€‚å½“å¯¹è¡¨ ä¸­çš„æ•°æ®è¿›è¡Œå¢åŠ ã€åˆ é™¤å’Œä¿®æ”¹çš„æ—¶å€™ï¼Œç´¢å¼•ä¹Ÿè¦åŠ¨æ€åœ°ç»´æŠ¤ï¼Œè¿™æ ·å°±é™ä½äº†æ•°æ®çš„ç»´æŠ¤é€Ÿåº¦ã€‚ å› æ­¤ï¼Œé€‰æ‹©ä½¿ç”¨ç´¢å¼•æ—¶ï¼Œéœ€è¦ç»¼åˆè€ƒè™‘ç´¢å¼•çš„ä¼˜ç‚¹å’Œç¼ºç‚¹ã€‚</p><p>å› æ­¤ï¼Œé€‰æ‹©ä½¿ç”¨ç´¢å¼•æ—¶ï¼Œéœ€è¦ç»¼åˆè€ƒè™‘ç´¢å¼•çš„ä¼˜ç‚¹å’Œç¼ºç‚¹ã€‚</p><blockquote><p>æç¤ºï¼š</p><p>ç´¢å¼•å¯ä»¥æé«˜æŸ¥è¯¢çš„é€Ÿåº¦ï¼Œä½†æ˜¯ä¼šå½±å“æ’å…¥è®°å½•çš„é€Ÿåº¦ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œæœ€å¥½çš„åŠæ³•æ˜¯å…ˆåˆ é™¤è¡¨ä¸­çš„ç´¢å¼•ï¼Œç„¶åæ’å…¥æ•°æ®ï¼Œæ’å…¥å®Œæˆåå†åˆ›å»ºç´¢å¼•ã€‚</p></blockquote><h2 id="3-InnoDBä¸­ç´¢å¼•çš„æ¨æ¼”"><a href="#3-InnoDBä¸­ç´¢å¼•çš„æ¨æ¼”" class="headerlink" title="3. InnoDBä¸­ç´¢å¼•çš„æ¨æ¼”"></a>3. InnoDBä¸­ç´¢å¼•çš„æ¨æ¼”</h2><h3 id="3-1-ç´¢å¼•ä¹‹å‰çš„æŸ¥æ‰¾"><a href="#3-1-ç´¢å¼•ä¹‹å‰çš„æŸ¥æ‰¾" class="headerlink" title="3.1 ç´¢å¼•ä¹‹å‰çš„æŸ¥æ‰¾"></a>3.1 ç´¢å¼•ä¹‹å‰çš„æŸ¥æ‰¾</h3><p>å…ˆæ¥çœ‹ä¸€ä¸ªç²¾ç¡®åŒ¹é…çš„ä¾‹å­ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT [åˆ—ååˆ—è¡¨] FROM è¡¨å WHERE åˆ—å = xxx;</span><br></pre></td></tr></table></figure><h4 id="1-åœ¨ä¸€ä¸ªé¡µä¸­çš„æŸ¥æ‰¾"><a href="#1-åœ¨ä¸€ä¸ªé¡µä¸­çš„æŸ¥æ‰¾" class="headerlink" title="1. åœ¨ä¸€ä¸ªé¡µä¸­çš„æŸ¥æ‰¾"></a>1. åœ¨ä¸€ä¸ªé¡µä¸­çš„æŸ¥æ‰¾</h4><p>å‡è®¾ç›®å‰è¡¨ä¸­çš„è®°å½•æ¯”è¾ƒå°‘ï¼Œæ‰€æœ‰çš„è®°å½•éƒ½å¯ä»¥è¢«å­˜æ”¾åˆ°ä¸€ä¸ªé¡µä¸­ï¼Œåœ¨æŸ¥æ‰¾è®°å½•çš„æ—¶å€™å¯ä»¥æ ¹æ®æœç´¢æ¡ä»¶çš„ä¸åŒåˆ†ä¸ºä¸¤ç§æƒ…å†µï¼š</p><ul><li><p>ä»¥ä¸»é”®ä¸ºæœç´¢æ¡ä»¶</p><p>å¯ä»¥åœ¨é¡µç›®å½•ä¸­ä½¿ç”¨ <code>äºŒåˆ†æ³•</code> å¿«é€Ÿå®šä½åˆ°å¯¹åº”çš„æ§½ï¼Œç„¶åå†éå†è¯¥æ§½å¯¹ç”¨åˆ†ç»„ä¸­çš„è®°å½•å³å¯å¿«é€Ÿæ‰¾åˆ°æŒ‡å®šè®°å½•ã€‚</p></li><li><p>ä»¥å…¶ä»–åˆ—ä½œä¸ºæœç´¢æ¡ä»¶</p><p>å› ä¸ºåœ¨æ•°æ®é¡µä¸­å¹¶æ²¡æœ‰å¯¹éä¸»é”®åˆ—ç®€å†æ‰€è°“çš„é¡µç›®å½•ï¼Œæ‰€ä»¥æˆ‘ä»¬æ— æ³•é€šè¿‡äºŒåˆ†æ³•å¿«é€Ÿå®šä½ç›¸åº”çš„æ§½ã€‚è¿™ç§æƒ…å†µä¸‹åªèƒ½ä» <code>æœ€å°è®°å½•</code> å¼€å§‹ <code>ä¾æ¬¡éå†å•é“¾è¡¨ä¸­çš„æ¯æ¡è®°å½•</code>ï¼Œ ç„¶åå¯¹æ¯”æ¯æ¡è®°å½•æ˜¯ä¸æ˜¯ç¬¦åˆæœç´¢æ¡ä»¶ã€‚å¾ˆæ˜¾ç„¶ï¼Œè¿™ç§æŸ¥æ‰¾çš„æ•ˆç‡æ˜¯éå¸¸ä½çš„ã€‚</p></li></ul><h4 id="2-åœ¨å¾ˆå¤šé¡µä¸­æŸ¥æ‰¾"><a href="#2-åœ¨å¾ˆå¤šé¡µä¸­æŸ¥æ‰¾" class="headerlink" title="2. åœ¨å¾ˆå¤šé¡µä¸­æŸ¥æ‰¾"></a>2. åœ¨å¾ˆå¤šé¡µä¸­æŸ¥æ‰¾</h4><p>åœ¨å¾ˆå¤šé¡µä¸­æŸ¥æ‰¾è®°å½•çš„æ´»åŠ¨å¯ä»¥åˆ†ä¸ºä¸¤ä¸ªæ­¥éª¤ï¼š</p><ol><li>å®šä½åˆ°è®°å½•æ‰€åœ¨çš„é¡µã€‚</li><li>ä»æ‰€åœ¨çš„é¡µå†…ä¸­æŸ¥æ‰¾ç›¸åº”çš„è®°å½•ã€‚</li></ol><p>åœ¨æ²¡æœ‰ç´¢å¼•çš„æƒ…å†µä¸‹ï¼Œä¸è®ºæ˜¯æ ¹æ®ä¸»é”®åˆ—æˆ–è€…å…¶ä»–åˆ—çš„å€¼è¿›è¡ŒæŸ¥æ‰¾ï¼Œç”±äºæˆ‘ä»¬å¹¶ä¸èƒ½å¿«é€Ÿçš„å®šä½åˆ°è®°å½•æ‰€åœ¨çš„é¡µï¼Œæ‰€ä»¥åªèƒ½ ä»ç¬¬ä¸€ä¸ªé¡µæ²¿ç€åŒå‘é“¾è¡¨ ä¸€ç›´å¾€ä¸‹æ‰¾ï¼Œåœ¨æ¯ä¸€ä¸ªé¡µä¸­æ ¹æ®æˆ‘ä»¬ä¸Šé¢çš„æŸ¥æ‰¾æ–¹å¼å»æŸ¥ æ‰¾æŒ‡å®šçš„è®°å½•ã€‚å› ä¸ºè¦éå†æ‰€æœ‰çš„æ•°æ®é¡µï¼Œæ‰€ä»¥è¿™ç§æ–¹å¼æ˜¾ç„¶æ˜¯ è¶…çº§è€—æ—¶ çš„ã€‚å¦‚æœä¸€ä¸ªè¡¨æœ‰ä¸€äº¿æ¡è®°å½•å‘¢ï¼Ÿæ­¤æ—¶ ç´¢å¼• åº”è¿è€Œç”Ÿã€‚</p><h3 id="3-2-è®¾è®¡ç´¢å¼•"><a href="#3-2-è®¾è®¡ç´¢å¼•" class="headerlink" title="3.2 è®¾è®¡ç´¢å¼•"></a>3.2 è®¾è®¡ç´¢å¼•</h3><p>å»ºä¸€ä¸ªè¡¨ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; CREATE TABLE index_demo(</span><br><span class="line">-&gt; c1 INT,</span><br><span class="line">-&gt; c2 INT,</span><br><span class="line">-&gt; c3 CHAR(1),</span><br><span class="line">-&gt; PRIMARY KEY(c1)</span><br><span class="line">-&gt; ) ROW_FORMAT = Compact;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ–°å»ºçš„ <strong>index_demo</strong> è¡¨ä¸­æœ‰2ä¸ªINTç±»å‹çš„åˆ—ï¼Œ1ä¸ªCHAR(1)ç±»å‹çš„åˆ—ï¼Œè€Œä¸”æˆ‘ä»¬è§„å®šäº†c1åˆ—ä¸ºä¸»é”®ï¼Œ è¿™ä¸ªè¡¨ä½¿ç”¨ <strong>Compact</strong> è¡Œæ ¼å¼æ¥å®é™…å­˜å‚¨è®°å½•çš„ã€‚è¿™é‡Œæˆ‘ä»¬ç®€åŒ–äº†index_demoè¡¨çš„è¡Œæ ¼å¼ç¤ºæ„å›¾ï¼š</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220616152453203.png" class=""><p>æˆ‘ä»¬åªåœ¨ç¤ºæ„å›¾é‡Œå±•ç¤ºè®°å½•çš„è¿™å‡ ä¸ªéƒ¨åˆ†ï¼š</p><ul><li>record_type ï¼šè®°å½•å¤´ä¿¡æ¯çš„ä¸€é¡¹å±æ€§ï¼Œè¡¨ç¤ºè®°å½•çš„ç±»å‹ï¼Œ 0 è¡¨ç¤ºæ™®é€šè®°å½•ã€ 2 è¡¨ç¤ºæœ€å°è®° å½•ã€ 3 è¡¨ç¤ºæœ€å¤§è®°å½•ã€ 1 æš‚æ—¶è¿˜æ²¡ç”¨è¿‡ï¼Œä¸‹é¢è®²ã€‚ </li><li>mysql&gt; CREATE TABLE index_demo( -&gt; c1 INT, -&gt; c2 INT, -&gt; c3 CHAR(1), -&gt; PRIMARY KEY(c1) -&gt; ) ROW_FORMAT &#x3D; Compact; next_record ï¼šè®°å½•å¤´ä¿¡æ¯çš„ä¸€é¡¹å±æ€§ï¼Œè¡¨ç¤ºä¸‹ä¸€æ¡åœ°å€ç›¸å¯¹äºæœ¬æ¡è®°å½•çš„åœ°å€åç§»é‡ï¼Œæˆ‘ä»¬ç”¨ ç®­å¤´æ¥è¡¨æ˜ä¸‹ä¸€æ¡è®°å½•æ˜¯è°ã€‚ </li><li>å„ä¸ªåˆ—çš„å€¼ ï¼šè¿™é‡Œåªè®°å½•åœ¨ index_demo è¡¨ä¸­çš„ä¸‰ä¸ªåˆ—ï¼Œåˆ†åˆ«æ˜¯ c1 ã€ c2 å’Œ c3 ã€‚ </li><li>å…¶ä»–ä¿¡æ¯ ï¼šé™¤äº†ä¸Šè¿°3ç§ä¿¡æ¯ä»¥å¤–çš„æ‰€æœ‰ä¿¡æ¯ï¼ŒåŒ…æ‹¬å…¶ä»–éšè—åˆ—çš„å€¼ä»¥åŠè®°å½•çš„é¢å¤–ä¿¡æ¯ã€‚</li></ul><p>å°†è®°å½•æ ¼å¼ç¤ºæ„å›¾çš„å…¶ä»–ä¿¡æ¯é¡¹æš‚æ—¶å»æ‰å¹¶æŠŠå®ƒç«–èµ·æ¥çš„æ•ˆæœå°±æ˜¯è¿™æ ·ï¼š</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220616152727234.png" class=""><p>æŠŠä¸€äº›è®°å½•æ”¾åˆ°é¡µé‡Œçš„ç¤ºæ„å›¾å°±æ˜¯ï¼š</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220616152651878.png" class=""><h4 id="1-ä¸€ä¸ªç®€å•çš„ç´¢å¼•è®¾è®¡æ–¹æ¡ˆ"><a href="#1-ä¸€ä¸ªç®€å•çš„ç´¢å¼•è®¾è®¡æ–¹æ¡ˆ" class="headerlink" title="1. ä¸€ä¸ªç®€å•çš„ç´¢å¼•è®¾è®¡æ–¹æ¡ˆ"></a>1. ä¸€ä¸ªç®€å•çš„ç´¢å¼•è®¾è®¡æ–¹æ¡ˆ</h4><p>æˆ‘ä»¬åœ¨æ ¹æ®æŸä¸ªæœç´¢æ¡ä»¶æŸ¥æ‰¾ä¸€äº›è®°å½•æ—¶ä¸ºä»€ä¹ˆè¦éå†æ‰€æœ‰çš„æ•°æ®é¡µå‘¢ï¼Ÿå› ä¸ºå„ä¸ªé¡µä¸­çš„è®°å½•å¹¶æ²¡æœ‰è§„å¾‹ï¼Œæˆ‘ä»¬å¹¶ä¸çŸ¥é“æˆ‘ä»¬çš„æœç´¢æ¡ä»¶åŒ¹é…å“ªäº›é¡µä¸­çš„è®°å½•ï¼Œæ‰€ä»¥ä¸å¾—ä¸ä¾æ¬¡éå†æ‰€æœ‰çš„æ•°æ®é¡µã€‚æ‰€ä»¥å¦‚æœæˆ‘ä»¬ <strong>æƒ³å¿«é€Ÿçš„å®šä½åˆ°éœ€è¦æŸ¥æ‰¾çš„è®°å½•åœ¨å“ªäº›æ•°æ®é¡µ</strong> ä¸­è¯¥å’‹åŠï¼Ÿæˆ‘ä»¬å¯ä»¥ä¸ºå¿«é€Ÿå®šä½è®°å½•æ‰€åœ¨çš„æ•°æ®é¡µè€Œå»ºç«‹ä¸€ä¸ªç›®å½• ï¼Œå»ºè¿™ä¸ªç›®å½•å¿…é¡»å®Œæˆä¸‹è¾¹è¿™äº›äº‹ï¼š</p><ul><li><p><strong>ä¸‹ä¸€ä¸ªæ•°æ®é¡µä¸­ç”¨æˆ·è®°å½•çš„ä¸»é”®å€¼å¿…é¡»å¤§äºä¸Šä¸€ä¸ªé¡µä¸­ç”¨æˆ·è®°å½•çš„ä¸»é”®å€¼ã€‚</strong></p><p>å‡è®¾ï¼šæ¯ä¸ªæ•°æ®ç»“æ„æœ€å¤šèƒ½å­˜æ”¾3æ¡è®°å½•ï¼ˆå®é™…ä¸Šä¸€ä¸ªæ•°æ®é¡µéå¸¸å¤§ï¼Œå¯ä»¥å­˜æ”¾ä¸‹å¥½å¤šè®°å½•ï¼‰ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO index_demo VALUES(1, 4, &#x27;u&#x27;), (3, 9, &#x27;d&#x27;), (5, 3, &#x27;y&#x27;);</span><br></pre></td></tr></table></figure></li></ul><p>â€‹       é‚£ä¹ˆè¿™äº›è®°å½•ä»¥åŠæŒ‰ç…§ä¸»é”®å€¼çš„å¤§å°ä¸²è”æˆä¸€ä¸ªå•å‘é“¾è¡¨äº†ï¼Œå¦‚å›¾æ‰€ç¤ºï¼š</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220616153518456.png" class=""><p>â€‹      ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºæ¥ï¼Œ index_demo è¡¨ä¸­çš„3æ¡è®°å½•éƒ½è¢«æ’å…¥åˆ°äº†ç¼–å·ä¸º10çš„æ•°æ®é¡µä¸­äº†ã€‚æ­¤æ—¶æˆ‘ä»¬å†æ¥æ’å…¥ä¸€æ¡è®°å½•</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">INSERT INTO index_demo VALUES(4, 4, &#x27;a&#x27;);</span><br></pre></td></tr></table></figure><p>å› ä¸º <strong>é¡µ10</strong> æœ€å¤šåªèƒ½æ”¾3æ¡è®°å½•ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸å¾—ä¸å†åˆ†é…ä¸€ä¸ªæ–°é¡µï¼š</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220616155306705.png" class=""><p>æ³¨æ„ï¼šæ–°åˆ†é…çš„ <strong>æ•°æ®é¡µç¼–å·å¯èƒ½å¹¶ä¸æ˜¯è¿ç»­çš„</strong>ã€‚å®ƒä»¬åªæ˜¯é€šè¿‡ç»´æŠ¤è€…ä¸Šä¸€ä¸ªé¡µå’Œä¸‹ä¸€ä¸ªé¡µçš„ç¼–å·è€Œå»ºç«‹äº† <strong>é“¾è¡¨</strong> å…³ç³»ã€‚å¦å¤–ï¼Œ<strong>é¡µ10</strong>ä¸­ç”¨æˆ·è®°å½•æœ€å¤§çš„ä¸»é”®å€¼æ˜¯5ï¼Œè€Œ<strong>é¡µ28</strong>ä¸­æœ‰ä¸€æ¡è®°å½•çš„ä¸»é”®å€¼æ˜¯4ï¼Œå› ä¸º5&gt;4ï¼Œæ‰€ä»¥è¿™å°±ä¸ç¬¦åˆä¸‹ä¸€ä¸ªæ•°æ®é¡µä¸­ç”¨æˆ·è®°å½•çš„ä¸»é”®å€¼å¿…é¡»å¤§äºä¸Šä¸€ä¸ªé¡µä¸­ç”¨æˆ·è®°å½•çš„ä¸»é”®å€¼çš„è¦æ±‚ï¼Œæ‰€ä»¥åœ¨æ’å…¥ä¸»é”®å€¼ä¸º4çš„è®°å½•çš„æ—¶å€™éœ€è¦ä¼´éšç€ä¸€æ¬¡ <strong>è®°å½•ç§»åŠ¨</strong>ï¼Œä¹Ÿå°±æ˜¯æŠŠä¸»é”®å€¼ä¸º5çš„è®°å½•ç§»åŠ¨åˆ°é¡µ28ä¸­ï¼Œç„¶åå†æŠŠä¸»é”®å€¼ä¸º4çš„è®°å½•æ’å…¥åˆ°é¡µ10ä¸­ï¼Œè¿™ä¸ªè¿‡ç¨‹çš„ç¤ºæ„å›¾å¦‚ä¸‹ï¼š</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220616160216525.png" class=""><p>è¿™ä¸ªè¿‡ç¨‹è¡¨æ˜äº†åœ¨å¯¹é¡µä¸­çš„è®°å½•è¿›è¡Œå¢åˆ æ”¹æŸ¥æ“ä½œçš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¿…é¡»é€šè¿‡ä¸€äº›è¯¸å¦‚ <strong>è®°å½•ç§»åŠ¨</strong> çš„æ“ä½œæ¥å§‹ç»ˆä¿è¯è¿™ä¸ªçŠ¶æ€ä¸€ç›´æˆç«‹ï¼šä¸‹ä¸€ä¸ªæ•°æ®é¡µä¸­ç”¨æˆ·è®°å½•çš„ä¸»é”®å€¼å¿…é¡»å¤§äºä¸Šä¸€ä¸ªé¡µä¸­ç”¨æˆ·è®°å½•çš„ä¸»é”®å€¼ã€‚è¿™ä¸ªè¿‡ç¨‹ç§°ä¸º <strong>é¡µåˆ†è£‚</strong>ã€‚</p><ul><li><strong>ç»™æ‰€æœ‰çš„é¡µå»ºç«‹ä¸€ä¸ªç›®å½•é¡¹ã€‚</strong></li></ul><p>ç”±äºæ•°æ®é¡µçš„ <strong>ç¼–å·å¯èƒ½æ˜¯ä¸è¿ç»­</strong> çš„ï¼Œæ‰€ä»¥åœ¨å‘ index_demo è¡¨ä¸­æ’å…¥è®¸å¤šæ¡è®°å½•åï¼Œå¯èƒ½æ˜¯è¿™æ ·çš„æ•ˆæœï¼š</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220616160619525.png" class=""><p>æˆ‘ä»¬éœ€è¦ç»™å®ƒä»¬åšä¸ª <strong>ç›®å½•</strong>ï¼Œæ¯ä¸ªé¡µå¯¹åº”ä¸€ä¸ªç›®å½•é¡¹ï¼Œæ¯ä¸ªç›®å½•é¡¹åŒ…æ‹¬ä¸‹è¾¹ä¸¤ä¸ªéƒ¨åˆ†ï¼š</p><p>1ï¼‰é¡µçš„ç”¨æˆ·è®°å½•ä¸­æœ€å°çš„ä¸»é”®å€¼ï¼Œæˆ‘ä»¬ç”¨ <strong>key</strong> æ¥è¡¨ç¤ºã€‚</p><p>2ï¼‰é¡µå·ï¼Œæˆ‘ä»¬ç”¨ <strong>page_on</strong> è¡¨ç¤ºã€‚</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220616160857381.png" class=""><p>ä»¥ é¡µ28 ä¸ºä¾‹ï¼Œå®ƒå¯¹åº” ç›®å½•é¡¹2 ï¼Œè¿™ä¸ªç›®å½•é¡¹ä¸­åŒ…å«ç€è¯¥é¡µçš„é¡µå· 28 ä»¥åŠè¯¥é¡µä¸­ç”¨æˆ·è®°å½•çš„æœ€å°ä¸» é”®å€¼ 5 ã€‚æˆ‘ä»¬åªéœ€è¦æŠŠå‡ ä¸ªç›®å½•é¡¹åœ¨ç‰©ç†å­˜å‚¨å™¨ä¸Šè¿ç»­å­˜å‚¨ï¼ˆæ¯”å¦‚ï¼šæ•°ç»„ï¼‰ï¼Œå°±å¯ä»¥å®ç°æ ¹æ®ä¸»é”® å€¼å¿«é€ŸæŸ¥æ‰¾æŸæ¡è®°å½•çš„åŠŸèƒ½äº†ã€‚æ¯”å¦‚ï¼šæŸ¥æ‰¾ä¸»é”®å€¼ä¸º 20 çš„è®°å½•ï¼Œå…·ä½“æŸ¥æ‰¾è¿‡ç¨‹åˆ†ä¸¤æ­¥ï¼š</p><ol><li>å…ˆä»ç›®å½•é¡¹ä¸­æ ¹æ® äºŒåˆ†æ³• å¿«é€Ÿç¡®å®šå‡ºä¸»é”®å€¼ä¸º 20 çš„è®°å½•åœ¨ ç›®å½•é¡¹3 ä¸­ï¼ˆå› ä¸º 12 &lt; 20 &lt; 209 ï¼‰ï¼Œå®ƒå¯¹åº”çš„é¡µæ˜¯ é¡µ9 ã€‚ </li><li>å†æ ¹æ®å‰è¾¹è¯´çš„åœ¨é¡µä¸­æŸ¥æ‰¾è®°å½•çš„æ–¹å¼å» é¡µ9 ä¸­å®šä½å…·ä½“çš„è®°å½•ã€‚</li></ol><p>è‡³æ­¤ï¼Œé’ˆå¯¹æ•°æ®é¡µåšçš„ç®€æ˜“ç›®å½•å°±æå®šäº†ã€‚è¿™ä¸ªç›®å½•æœ‰ä¸€ä¸ªåˆ«åï¼Œç§°ä¸º <strong>ç´¢å¼•</strong> ã€‚</p><h4 id="2-InnoDBä¸­çš„ç´¢å¼•æ–¹æ¡ˆ"><a href="#2-InnoDBä¸­çš„ç´¢å¼•æ–¹æ¡ˆ" class="headerlink" title="2. InnoDBä¸­çš„ç´¢å¼•æ–¹æ¡ˆ"></a>2. InnoDBä¸­çš„ç´¢å¼•æ–¹æ¡ˆ</h4><h5 id="â‘ -è¿­ä»£1æ¬¡ï¼šç›®å½•é¡¹çºªå½•çš„é¡µ"><a href="#â‘ -è¿­ä»£1æ¬¡ï¼šç›®å½•é¡¹çºªå½•çš„é¡µ" class="headerlink" title="â‘  è¿­ä»£1æ¬¡ï¼šç›®å½•é¡¹çºªå½•çš„é¡µ"></a>â‘  è¿­ä»£1æ¬¡ï¼šç›®å½•é¡¹çºªå½•çš„é¡µ</h5><p>InnoDBæ€ä¹ˆåŒºåˆ†ä¸€æ¡è®°å½•æ˜¯æ™®é€šçš„ <strong>ç”¨æˆ·è®°å½•</strong> è¿˜æ˜¯ <strong>ç›®å½•é¡¹è®°å½•</strong> å‘¢ï¼Ÿä½¿ç”¨è®°å½•å¤´ä¿¡æ¯é‡Œçš„ <strong>record_type</strong> å±æ€§ï¼Œå®ƒçš„å„è‡ªå–å€¼ä»£è¡¨çš„æ„æ€å¦‚ä¸‹ï¼š</p><ul><li>0ï¼šæ™®é€šçš„ç”¨æˆ·è®°å½•</li><li>1ï¼šç›®å½•é¡¹è®°å½•</li><li>2ï¼šæœ€å°è®°å½•</li><li>3ï¼šæœ€å¤§è®°å½•</li></ul><p>æˆ‘ä»¬æŠŠå‰è¾¹ä½¿ç”¨åˆ°çš„ç›®å½•é¡¹æ”¾åˆ°æ•°æ®é¡µä¸­çš„æ ·å­å°±æ˜¯è¿™æ ·ï¼š</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220616162944404.png" class=""><p>ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºæ¥ï¼Œæˆ‘ä»¬æ–°åˆ†é…äº†ä¸€ä¸ªç¼–å·ä¸º30çš„é¡µæ¥ä¸“é—¨å­˜å‚¨ç›®å½•é¡¹è®°å½•ã€‚è¿™é‡Œå†æ¬¡å¼ºè°ƒ <strong>ç›®å½•é¡¹è®°å½•</strong> å’Œæ™®é€šçš„ <strong>ç”¨æˆ·è®°å½•</strong> çš„ä¸åŒç‚¹ï¼š</p><ul><li><strong>ç›®å½•é¡¹è®°å½•</strong> çš„ record_type å€¼æ˜¯1ï¼Œè€Œ <strong>æ™®é€šç”¨æˆ·è®°å½•</strong> çš„ record_type å€¼æ˜¯0ã€‚ </li><li>ç›®å½•é¡¹è®°å½•åªæœ‰ <strong>ä¸»é”®å€¼å’Œé¡µçš„ç¼–å·</strong> ä¸¤ä¸ªåˆ—ï¼Œè€Œæ™®é€šçš„ç”¨æˆ·è®°å½•çš„åˆ—æ˜¯ç”¨æˆ·è‡ªå·±å®šä¹‰çš„ï¼Œå¯èƒ½åŒ…å« <strong>å¾ˆå¤šåˆ—</strong> ï¼Œå¦å¤–è¿˜æœ‰InnoDBè‡ªå·±æ·»åŠ çš„éšè—åˆ—ã€‚ </li><li>äº†è§£ï¼šè®°å½•å¤´ä¿¡æ¯é‡Œè¿˜æœ‰ä¸€ä¸ªå« <strong>min_rec_mask</strong> çš„å±æ€§ï¼Œåªæœ‰åœ¨å­˜å‚¨ <strong>ç›®å½•é¡¹è®°å½•</strong> çš„é¡µä¸­çš„ä¸»é”®å€¼æœ€å°çš„ <strong>ç›®å½•é¡¹è®°å½•</strong> çš„ <strong>min_rec_mask</strong> å€¼ä¸º <strong>1</strong> ï¼Œå…¶ä»–åˆ«çš„è®°å½•çš„ <strong>min_rec_mask</strong> å€¼éƒ½æ˜¯ <strong>0</strong> ã€‚</li></ul><p><strong>ç›¸åŒç‚¹</strong>ï¼šä¸¤è€…ç”¨çš„æ˜¯ä¸€æ ·çš„æ•°æ®é¡µï¼Œéƒ½ä¼šä¸ºä¸»é”®å€¼ç”Ÿæˆ <strong>Page Directory ï¼ˆé¡µç›®å½•ï¼‰</strong>ï¼Œä»è€Œåœ¨æŒ‰ç…§ä¸»é”®å€¼è¿›è¡ŒæŸ¥æ‰¾æ—¶å¯ä»¥ä½¿ç”¨ <strong>äºŒåˆ†æ³•</strong> æ¥åŠ å¿«æŸ¥è¯¢é€Ÿåº¦ã€‚</p><p>ç°åœ¨ä»¥æŸ¥æ‰¾ä¸»é”®ä¸º 20 çš„è®°å½•ä¸ºä¾‹ï¼Œæ ¹æ®æŸä¸ªä¸»é”®å€¼å»æŸ¥æ‰¾è®°å½•çš„æ­¥éª¤å°±å¯ä»¥å¤§è‡´æ‹†åˆ†æˆä¸‹è¾¹ä¸¤æ­¥ï¼š</p><ol><li>å…ˆåˆ°å­˜å‚¨ ç›®å½•é¡¹è®°å½• çš„é¡µï¼Œä¹Ÿå°±æ˜¯é¡µ30ä¸­é€šè¿‡ äºŒåˆ†æ³• å¿«é€Ÿå®šä½åˆ°å¯¹åº”ç›®å½•é¡¹ï¼Œå› ä¸º 12 &lt; 20 &lt; 209 ï¼Œæ‰€ä»¥å®šä½åˆ°å¯¹åº”çš„è®°å½•æ‰€åœ¨çš„é¡µå°±æ˜¯é¡µ9ã€‚ </li><li>å†åˆ°å­˜å‚¨ç”¨æˆ·è®°å½•çš„é¡µ9ä¸­æ ¹æ® äºŒåˆ†æ³• å¿«é€Ÿå®šä½åˆ°ä¸»é”®å€¼ä¸º 20 çš„ç”¨æˆ·è®°å½•ã€‚</li></ol><h5 id="â‘¡-è¿­ä»£2æ¬¡ï¼šå¤šä¸ªç›®å½•é¡¹çºªå½•çš„é¡µ"><a href="#â‘¡-è¿­ä»£2æ¬¡ï¼šå¤šä¸ªç›®å½•é¡¹çºªå½•çš„é¡µ" class="headerlink" title="â‘¡ è¿­ä»£2æ¬¡ï¼šå¤šä¸ªç›®å½•é¡¹çºªå½•çš„é¡µ"></a>â‘¡ è¿­ä»£2æ¬¡ï¼šå¤šä¸ªç›®å½•é¡¹çºªå½•çš„é¡µ</h5><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220616171135082.png" class=""><p>ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºï¼Œæˆ‘ä»¬æ’å…¥äº†ä¸€æ¡ä¸»é”®å€¼ä¸º320çš„ç”¨æˆ·è®°å½•ä¹‹åéœ€è¦ä¸¤ä¸ªæ–°çš„æ•°æ®é¡µï¼š</p><ul><li>ä¸ºå­˜å‚¨è¯¥ç”¨æˆ·è®°å½•è€Œæ–°ç”Ÿæˆäº† é¡µ31 ã€‚ </li><li>å› ä¸ºåŸå…ˆå­˜å‚¨ç›®å½•é¡¹è®°å½•çš„ é¡µ30çš„å®¹é‡å·²æ»¡ ï¼ˆæˆ‘ä»¬å‰è¾¹å‡è®¾åªèƒ½å­˜å‚¨4æ¡ç›®å½•é¡¹è®°å½•ï¼‰ï¼Œæ‰€ä»¥ä¸å¾— ä¸éœ€è¦ä¸€ä¸ªæ–°çš„ é¡µ32 æ¥å­˜æ”¾ é¡µ31 å¯¹åº”çš„ç›®å½•é¡¹ã€‚</li></ul><p>ç°åœ¨å› ä¸ºå­˜å‚¨ç›®å½•é¡¹è®°å½•çš„é¡µä¸æ­¢ä¸€ä¸ªï¼Œæ‰€ä»¥å¦‚æœæˆ‘ä»¬æƒ³æ ¹æ®ä¸»é”®å€¼æŸ¥æ‰¾ä¸€æ¡ç”¨æˆ·è®°å½•å¤§è‡´éœ€è¦3ä¸ªæ­¥éª¤ï¼Œä»¥æŸ¥æ‰¾ä¸»é”®å€¼ä¸º 20 çš„è®°å½•ä¸ºä¾‹ï¼š</p><ol><li>ç¡®å®š ç›®å½•é¡¹è®°å½•é¡µ æˆ‘ä»¬ç°åœ¨çš„å­˜å‚¨ç›®å½•é¡¹è®°å½•çš„é¡µæœ‰ä¸¤ä¸ªï¼Œå³ é¡µ30 å’Œ é¡µ32 ï¼Œåˆå› ä¸ºé¡µ30è¡¨ç¤ºçš„ç›®å½•é¡¹çš„ä¸»é”®å€¼çš„ èŒƒå›´æ˜¯ [1, 320) ï¼Œé¡µ32è¡¨ç¤ºçš„ç›®å½•é¡¹çš„ä¸»é”®å€¼ä¸å°äº 320 ï¼Œæ‰€ä»¥ä¸»é”®å€¼ä¸º 20 çš„è®°å½•å¯¹åº”çš„ç›® å½•é¡¹è®°å½•åœ¨ é¡µ30 ä¸­ã€‚ </li><li>é€šè¿‡ç›®å½•é¡¹è®°å½•é¡µ ç¡®å®šç”¨æˆ·è®°å½•çœŸå®æ‰€åœ¨çš„é¡µ ã€‚ åœ¨ä¸€ä¸ªå­˜å‚¨ ç›®å½•é¡¹è®°å½• çš„é¡µä¸­é€šè¿‡ä¸»é”®å€¼å®šä½ä¸€æ¡ç›®å½•é¡¹è®°å½•çš„æ–¹å¼è¯´è¿‡äº†ã€‚ </li><li>åœ¨çœŸå®å­˜å‚¨ç”¨æˆ·è®°å½•çš„é¡µä¸­å®šä½åˆ°å…·ä½“çš„è®°å½•ã€‚</li></ol><h5 id="â‘¢-è¿­ä»£3æ¬¡ï¼šç›®å½•é¡¹è®°å½•é¡µçš„ç›®å½•é¡µ"><a href="#â‘¢-è¿­ä»£3æ¬¡ï¼šç›®å½•é¡¹è®°å½•é¡µçš„ç›®å½•é¡µ" class="headerlink" title="â‘¢ è¿­ä»£3æ¬¡ï¼šç›®å½•é¡¹è®°å½•é¡µçš„ç›®å½•é¡µ"></a>â‘¢ è¿­ä»£3æ¬¡ï¼šç›®å½•é¡¹è®°å½•é¡µçš„ç›®å½•é¡µ</h5><p>å¦‚æœæˆ‘ä»¬è¡¨ä¸­çš„æ•°æ®éå¸¸å¤šåˆ™ä¼š<code>äº§ç”Ÿå¾ˆå¤šå­˜å‚¨ç›®å½•é¡¹è®°å½•çš„é¡µ</code>ï¼Œé‚£æˆ‘ä»¬æ€ä¹ˆæ ¹æ®ä¸»é”®å€¼å¿«é€Ÿå®šä½ä¸€ä¸ªå­˜å‚¨ç›®å½•é¡¹è®°å½•çš„é¡µå‘¢ï¼Ÿé‚£å°±ä¸ºè¿™äº›å­˜å‚¨ç›®å½•é¡¹è®°å½•çš„é¡µå†ç”Ÿæˆä¸€ä¸ª<code>æ›´é«˜çº§çš„ç›®å½•</code>ï¼Œå°±åƒæ˜¯ä¸€ä¸ªå¤šçº§ç›®å½•ä¸€æ ·ï¼Œ<code>å¤§ç›®å½•é‡ŒåµŒå¥—å°ç›®å½•</code>ï¼Œå°ç›®å½•é‡Œæ‰æ˜¯å®é™…çš„æ•°æ®ï¼Œæ‰€ä»¥ç°åœ¨å„ä¸ªé¡µçš„ç¤ºæ„å›¾å°±æ˜¯è¿™æ ·å­ï¼š</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220616173512780.png" class=""><p>å¦‚å›¾ï¼Œæˆ‘ä»¬ç”Ÿæˆäº†ä¸€ä¸ªå­˜å‚¨æ›´é«˜çº§ç›®å½•é¡¹çš„ é¡µ33 ï¼Œè¿™ä¸ªé¡µä¸­çš„ä¸¤æ¡è®°å½•åˆ†åˆ«ä»£è¡¨é¡µ30å’Œé¡µ32ï¼Œå¦‚æœç”¨ æˆ·è®°å½•çš„ä¸»é”®å€¼åœ¨ [1, 320) ä¹‹é—´ï¼Œåˆ™åˆ°é¡µ30ä¸­æŸ¥æ‰¾æ›´è¯¦ç»†çš„ç›®å½•é¡¹è®°å½•ï¼Œå¦‚æœä¸»é”®å€¼ ä¸å°äº320 çš„ è¯ï¼Œå°±åˆ°é¡µ32ä¸­æŸ¥æ‰¾æ›´è¯¦ç»†çš„ç›®å½•é¡¹è®°å½•ã€‚</p><p>æˆ‘ä»¬å¯ä»¥ç”¨ä¸‹è¾¹è¿™ä¸ªå›¾æ¥æè¿°å®ƒï¼š</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220616173717538.png" class=""><p>è¿™ä¸ªæ•°æ®ç»“æ„ï¼Œå®ƒçš„åç§°æ˜¯ B+æ ‘ ã€‚</p><h5 id="â‘£-B-Tree"><a href="#â‘£-B-Tree" class="headerlink" title="â‘£ B+Tree"></a>â‘£ B+Tree</h5><p>ä¸€ä¸ªB+æ ‘çš„èŠ‚ç‚¹å…¶å®å¯ä»¥åˆ†æˆå¥½å¤šå±‚ï¼Œè§„å®šæœ€ä¸‹è¾¹çš„é‚£å±‚ï¼Œä¹Ÿå°±æ˜¯å­˜æ”¾æˆ‘ä»¬ç”¨æˆ·è®°å½•çš„é‚£å±‚ä¸ºç¬¬ 0 å±‚ï¼Œ ä¹‹åä¾æ¬¡å¾€ä¸ŠåŠ ã€‚ä¹‹å‰æˆ‘ä»¬åšäº†ä¸€ä¸ªéå¸¸æç«¯çš„å‡è®¾ï¼šå­˜æ”¾ç”¨æˆ·è®°å½•çš„é¡µ æœ€å¤šå­˜æ”¾3æ¡è®°å½• ï¼Œå­˜æ”¾ç›®å½•é¡¹ è®°å½•çš„é¡µ æœ€å¤šå­˜æ”¾4æ¡è®°å½• ã€‚å…¶å®çœŸå®ç¯å¢ƒä¸­ä¸€ä¸ªé¡µå­˜æ”¾çš„è®°å½•æ•°é‡æ˜¯éå¸¸å¤§çš„ï¼Œå‡è®¾æ‰€æœ‰å­˜æ”¾ç”¨æˆ·è®°å½• çš„å¶å­èŠ‚ç‚¹ä»£è¡¨çš„æ•°æ®é¡µå¯ä»¥å­˜æ”¾ 100æ¡ç”¨æˆ·è®°å½• ï¼Œæ‰€æœ‰å­˜æ”¾ç›®å½•é¡¹è®°å½•çš„å†…èŠ‚ç‚¹ä»£è¡¨çš„æ•°æ®é¡µå¯ä»¥å­˜ æ”¾ 1000æ¡ç›®å½•é¡¹è®°å½• ï¼Œé‚£ä¹ˆï¼š</p><ul><li>å¦‚æœB+æ ‘åªæœ‰1å±‚ï¼Œä¹Ÿå°±æ˜¯åªæœ‰1ä¸ªç”¨äºå­˜æ”¾ç”¨æˆ·è®°å½•çš„èŠ‚ç‚¹ï¼Œæœ€å¤šèƒ½å­˜æ”¾ 100 æ¡è®°å½•ã€‚</li><li>å¦‚æœB+æ ‘æœ‰2å±‚ï¼Œæœ€å¤šèƒ½å­˜æ”¾ 1000Ã—100&#x3D;10,0000 æ¡è®°å½•ã€‚ </li><li>å¦‚æœB+æ ‘æœ‰3å±‚ï¼Œæœ€å¤šèƒ½å­˜æ”¾ 1000Ã—1000Ã—100&#x3D;1,0000,0000 æ¡è®°å½•ã€‚ </li><li>å¦‚æœB+æ ‘æœ‰4å±‚ï¼Œæœ€å¤šèƒ½å­˜æ”¾ 1000Ã—1000Ã—1000Ã—100&#x3D;1000,0000,0000 æ¡è®°å½•ã€‚ç›¸å½“å¤šçš„è®°å½•ï¼</li></ul><p>ä½ çš„è¡¨é‡Œèƒ½å­˜æ”¾ <strong>100000000000</strong> æ¡è®°å½•å—ï¼Ÿæ‰€ä»¥ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ç”¨åˆ°çš„ <strong>B+æ ‘éƒ½ä¸ä¼šè¶…è¿‡4å±‚</strong> ï¼Œé‚£æˆ‘ä»¬é€šè¿‡ä¸»é”®å€¼å»æŸ¥æ‰¾æŸæ¡è®°å½•æœ€å¤šåªéœ€è¦åš4ä¸ªé¡µé¢å†…çš„æŸ¥æ‰¾ï¼ˆæŸ¥æ‰¾3ä¸ªç›®å½•é¡¹é¡µå’Œä¸€ä¸ªç”¨æˆ·è®°å½•é¡µï¼‰ï¼Œåˆå› ä¸ºåœ¨æ¯ä¸ªé¡µé¢å†…æœ‰æ‰€è°“çš„ <strong>Page Directory</strong> ï¼ˆé¡µç›®å½•ï¼‰ï¼Œæ‰€ä»¥åœ¨é¡µé¢å†…ä¹Ÿå¯ä»¥é€šè¿‡ <strong>äºŒåˆ†æ³•</strong> å®ç°å¿«é€Ÿ å®šä½è®°å½•ã€‚</p><h3 id="3-3-å¸¸è§ç´¢å¼•æ¦‚å¿µ"><a href="#3-3-å¸¸è§ç´¢å¼•æ¦‚å¿µ" class="headerlink" title="3.3 å¸¸è§ç´¢å¼•æ¦‚å¿µ"></a>3.3 å¸¸è§ç´¢å¼•æ¦‚å¿µ</h3><p>ç´¢å¼•æŒ‰ç…§ç‰©ç†å®ç°æ–¹å¼ï¼Œç´¢å¼•å¯ä»¥åˆ†ä¸º 2 ç§ï¼šèšç°‡ï¼ˆèšé›†ï¼‰å’Œéèšç°‡ï¼ˆéèšé›†ï¼‰ç´¢å¼•ã€‚æˆ‘ä»¬ä¹ŸæŠŠéèšé›† ç´¢å¼•ç§°ä¸ºäºŒçº§ç´¢å¼•æˆ–è€…è¾…åŠ©ç´¢å¼•ã€‚</p><h4 id="1-èšç°‡ç´¢å¼•"><a href="#1-èšç°‡ç´¢å¼•" class="headerlink" title="1. èšç°‡ç´¢å¼•"></a>1. èšç°‡ç´¢å¼•</h4><p>èšç°‡ç´¢å¼•å¹¶ä¸æ˜¯ä¸€ç§å•ç‹¬çš„ç´¢å¼•ç±»å‹ï¼Œè€Œæ˜¯<strong>ä¸€ç§æ•°æ®å­˜å‚¨æ–¹å¼</strong>ï¼ˆæ‰€æœ‰çš„ç”¨æˆ·è®°å½•éƒ½å­˜å‚¨åœ¨äº†å¶å­ç»“ç‚¹ï¼‰ï¼Œä¹Ÿå°±æ˜¯æ‰€è°“çš„ <code>ç´¢å¼•å³æ•°æ®ï¼Œæ•°æ®å³ç´¢å¼•</code>ã€‚</p><blockquote><p>æœ¯è¯­â€èšç°‡â€è¡¨ç¤ºå½“å‰æ•°æ®è¡Œå’Œç›¸é‚»çš„é”®å€¼èšç°‡çš„å­˜å‚¨åœ¨ä¸€èµ·</p></blockquote><p><strong>ç‰¹ç‚¹ï¼š</strong></p><ul><li><p>ä½¿ç”¨è®°å½•ä¸»é”®å€¼çš„å¤§å°è¿›è¡Œè®°å½•å’Œé¡µçš„æ’åºï¼Œè¿™åŒ…æ‹¬ä¸‰ä¸ªæ–¹é¢çš„å«ä¹‰ï¼š </p><ul><li><code>é¡µå†…</code> çš„è®°å½•æ˜¯æŒ‰ç…§ä¸»é”®çš„å¤§å°é¡ºåºæ’æˆä¸€ä¸ª <code>å•å‘é“¾è¡¨</code> ã€‚ </li><li>å„ä¸ªå­˜æ”¾ <code>ç”¨æˆ·è®°å½•çš„é¡µ</code> ä¹Ÿæ˜¯æ ¹æ®é¡µä¸­ç”¨æˆ·è®°å½•çš„ä¸»é”®å¤§å°é¡ºåºæ’æˆä¸€ä¸ª <code>åŒå‘é“¾è¡¨</code> ã€‚ </li><li>å­˜æ”¾ <code>ç›®å½•é¡¹è®°å½•çš„é¡µ</code> åˆ†ä¸ºä¸åŒçš„å±‚æ¬¡ï¼Œåœ¨åŒä¸€å±‚æ¬¡ä¸­çš„é¡µä¹Ÿæ˜¯æ ¹æ®é¡µä¸­ç›®å½•é¡¹è®°å½•çš„ä¸»é”®å¤§å°é¡ºåºæ’æˆä¸€ä¸ª <code>åŒå‘é“¾è¡¨</code> ã€‚</li></ul></li><li><p>B+æ ‘çš„ å¶å­èŠ‚ç‚¹ å­˜å‚¨çš„æ˜¯å®Œæ•´çš„ç”¨æˆ·è®°å½•ã€‚ </p><p>æ‰€è°“å®Œæ•´çš„ç”¨æˆ·è®°å½•ï¼Œå°±æ˜¯æŒ‡è¿™ä¸ªè®°å½•ä¸­å­˜å‚¨äº†æ‰€æœ‰åˆ—çš„å€¼ï¼ˆåŒ…æ‹¬éšè—åˆ—ï¼‰ã€‚</p></li></ul><p>æˆ‘ä»¬æŠŠå…·æœ‰è¿™ä¸¤ç§ç‰¹æ€§çš„B+æ ‘ç§°ä¸ºèšç°‡ç´¢å¼•ï¼Œæ‰€æœ‰å®Œæ•´çš„ç”¨æˆ·è®°å½•éƒ½å­˜æ”¾åœ¨è¿™ä¸ª<code>èšç°‡ç´¢å¼•</code>çš„å¶å­èŠ‚ç‚¹å¤„ã€‚è¿™ç§èšç°‡ç´¢å¼•å¹¶ä¸éœ€è¦æˆ‘ä»¬åœ¨MySQLè¯­å¥ä¸­æ˜¾å¼çš„ä½¿ç”¨INDEX è¯­å¥å»åˆ›å»ºï¼Œ <code>InnDB</code> å­˜å‚¨å¼•æ“ä¼š <code>è‡ªåŠ¨</code> çš„ä¸ºæˆ‘ä»¬åˆ›å»ºèšç°‡ç´¢å¼•ã€‚</p><p><strong>ä¼˜ç‚¹ï¼š</strong></p><ul><li><code>æ•°æ®è®¿é—®æ›´å¿«</code> ï¼Œå› ä¸ºèšç°‡ç´¢å¼•å°†ç´¢å¼•å’Œæ•°æ®ä¿å­˜åœ¨åŒä¸€ä¸ªB+æ ‘ä¸­ï¼Œå› æ­¤ä»èšç°‡ç´¢å¼•ä¸­è·å–æ•°æ®æ¯”éèšç°‡ç´¢å¼•æ›´å¿« </li><li>èšç°‡ç´¢å¼•å¯¹äºä¸»é”®çš„ <code>æ’åºæŸ¥æ‰¾</code> å’Œ <code>èŒƒå›´æŸ¥æ‰¾</code> é€Ÿåº¦éå¸¸å¿« </li><li>æŒ‰ç…§èšç°‡ç´¢å¼•æ’åˆ—é¡ºåºï¼ŒæŸ¥è¯¢æ˜¾ç¤ºä¸€å®šèŒƒå›´æ•°æ®çš„æ—¶å€™ï¼Œç”±äºæ•°æ®éƒ½æ˜¯ç´§å¯†ç›¸è¿ï¼Œæ•°æ®åº“ä¸ç”¨ä»å¤š ä¸ªæ•°æ®å—ä¸­æå–æ•°æ®ï¼Œæ‰€ä»¥ <code>èŠ‚çœäº†å¤§é‡çš„ioæ“ä½œ</code> ã€‚</li></ul><p><strong>ç¼ºç‚¹ï¼š</strong></p><ul><li><code>æ’å…¥é€Ÿåº¦ä¸¥é‡ä¾èµ–äºæ’å…¥é¡ºåº</code> ï¼ŒæŒ‰ç…§ä¸»é”®çš„é¡ºåºæ’å…¥æ˜¯æœ€å¿«çš„æ–¹å¼ï¼Œå¦åˆ™å°†ä¼šå‡ºç°é¡µåˆ†è£‚ï¼Œä¸¥é‡å½±å“æ€§èƒ½ã€‚å› æ­¤ï¼Œå¯¹äºInnoDBè¡¨ï¼Œæˆ‘ä»¬ä¸€èˆ¬éƒ½ä¼šå®šä¹‰ä¸€ä¸ª<code>è‡ªå¢çš„IDåˆ—ä¸ºä¸»é”®</code></li><li><code>æ›´æ–°ä¸»é”®çš„ä»£ä»·å¾ˆé«˜</code> ï¼Œå› ä¸ºå°†ä¼šå¯¼è‡´è¢«æ›´æ–°çš„è¡Œç§»åŠ¨ã€‚å› æ­¤ï¼Œå¯¹äºInnoDBè¡¨ï¼Œæˆ‘ä»¬ä¸€èˆ¬å®šä¹‰<strong>ä¸»é”®ä¸ºä¸å¯æ›´æ–°</strong></li><li><code>äºŒçº§ç´¢å¼•è®¿é—®éœ€è¦ä¸¤æ¬¡ç´¢å¼•æŸ¥æ‰¾</code> ï¼Œç¬¬ä¸€æ¬¡æ‰¾åˆ°ä¸»é”®å€¼ï¼Œç¬¬äºŒæ¬¡æ ¹æ®ä¸»é”®å€¼æ‰¾åˆ°è¡Œæ•°æ®</li></ul><h4 id="2-äºŒçº§ç´¢å¼•ï¼ˆè¾…åŠ©ç´¢å¼•ã€éèšç°‡ç´¢å¼•ï¼‰"><a href="#2-äºŒçº§ç´¢å¼•ï¼ˆè¾…åŠ©ç´¢å¼•ã€éèšç°‡ç´¢å¼•ï¼‰" class="headerlink" title="2. äºŒçº§ç´¢å¼•ï¼ˆè¾…åŠ©ç´¢å¼•ã€éèšç°‡ç´¢å¼•ï¼‰"></a>2. äºŒçº§ç´¢å¼•ï¼ˆè¾…åŠ©ç´¢å¼•ã€éèšç°‡ç´¢å¼•ï¼‰</h4><p>å¦‚æœæˆ‘ä»¬æƒ³ä»¥åˆ«çš„åˆ—ä½œä¸ºæœç´¢æ¡ä»¶è¯¥æ€ä¹ˆåŠï¼Ÿè‚¯å®šä¸èƒ½æ˜¯ä»å¤´åˆ°å°¾æ²¿ç€é“¾è¡¨ä¾æ¬¡éå†è®°å½•ä¸€éã€‚</p><p>ç­”æ¡ˆï¼šæˆ‘ä»¬å¯ä»¥<code>å¤šå»ºå‡ é¢—B+æ ‘</code>ï¼Œä¸åŒçš„B+æ ‘ä¸­çš„æ•°æ®é‡‡ç”¨ä¸åŒçš„æ’åˆ—è§„åˆ™ã€‚æ¯”æ–¹è¯´æˆ‘ä»¬ç”¨<code>c2</code>åˆ—çš„å¤§å°ä½œä¸ºæ•°æ®é¡µã€é¡µä¸­è®°å½•çš„æ’åºè§„åˆ™ï¼Œå†å»ºä¸€è¯¾B+æ ‘ï¼Œæ•ˆæœå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220616203852043.png" class=""><p>è¿™ä¸ªB+æ ‘ä¸ä¸Šè¾¹ä»‹ç»çš„èšç°‡ç´¢å¼•æœ‰å‡ å¤„ä¸åŒï¼š</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220616210404733.png" class=""><p>**æ¦‚å¿µï¼šå›è¡¨ **</p><p>æˆ‘ä»¬æ ¹æ®è¿™ä¸ªä»¥c2åˆ—å¤§å°æ’åºçš„B+æ ‘åªèƒ½ç¡®å®šæˆ‘ä»¬è¦æŸ¥æ‰¾è®°å½•çš„ä¸»é”®å€¼ï¼Œæ‰€ä»¥å¦‚æœæˆ‘ä»¬æƒ³æ ¹ æ®c2åˆ—çš„å€¼æŸ¥æ‰¾åˆ°å®Œæ•´çš„ç”¨æˆ·è®°å½•çš„è¯ï¼Œä»ç„¶éœ€è¦åˆ° èšç°‡ç´¢å¼• ä¸­å†æŸ¥ä¸€éï¼Œè¿™ä¸ªè¿‡ç¨‹ç§°ä¸º å›è¡¨ ã€‚ä¹Ÿå°± æ˜¯æ ¹æ®c2åˆ—çš„å€¼æŸ¥è¯¢ä¸€æ¡å®Œæ•´çš„ç”¨æˆ·è®°å½•éœ€è¦ä½¿ç”¨åˆ° 2 æ£µB+æ ‘ï¼</p><p><strong>é—®é¢˜</strong>ï¼šä¸ºä»€ä¹ˆæˆ‘ä»¬è¿˜éœ€è¦ä¸€æ¬¡ å›è¡¨ æ“ä½œå‘¢ï¼Ÿç›´æ¥æŠŠå®Œæ•´çš„ç”¨æˆ·è®°å½•æ”¾åˆ°å¶å­èŠ‚ç‚¹ä¸OKå—ï¼Ÿ</p><p><strong>å›ç­”</strong>ï¼š</p><p>å¦‚æœæŠŠå®Œæ•´çš„ç”¨æˆ·è®°å½•æ”¾åˆ°å¶å­ç»“ç‚¹æ˜¯å¯ä»¥ä¸ç”¨å›è¡¨ã€‚ä½†æ˜¯<code>å¤ªå åœ°æ–¹</code>äº†ï¼Œç›¸å½“äºæ¯å»ºç«‹ä¸€è¯¾B+æ ‘éƒ½éœ€è¦æŠŠæ‰€æœ‰çš„ç”¨æˆ·è®°å½•å†éƒ½æ‹·è´ä¸€éï¼Œè¿™å°±æœ‰ç‚¹å¤ªæµªè´¹å­˜å‚¨ç©ºé—´äº†ã€‚</p><p>å› ä¸ºè¿™ç§æŒ‰ç…§<code>éä¸»é”®åˆ—</code>å»ºç«‹çš„B+æ ‘éœ€è¦ä¸€æ¬¡å›è¡¨æ“ä½œæ‰å¯ä»¥å®šä½åˆ°å®Œæ•´çš„ç”¨æˆ·è®°å½•ï¼Œæ‰€ä»¥è¿™ç§B+æ ‘ä¹Ÿè¢«ç§°ä¸º<code>äºŒçº§ç´¢å¼•</code>ï¼Œæˆ–è€…è¾…åŠ©ç´¢å¼•ã€‚ç”±äºä½¿ç”¨çš„æ˜¯c2åˆ—çš„å¤§å°ä½œä¸ºB+æ ‘çš„æ’åºè§„åˆ™ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿç§°è¿™ä¸ªB+æ ‘ä¸ºc2åˆ—ç®€å†çš„ç´¢å¼•ã€‚</p><p>éèšç°‡ç´¢å¼•çš„å­˜åœ¨ä¸å½±å“æ•°æ®åœ¨èšç°‡ç´¢å¼•ä¸­çš„ç»„ç»‡ï¼Œæ‰€ä»¥ä¸€å¼ è¡¨å¯ä»¥æœ‰å¤šä¸ªéèšç°‡ç´¢å¼•ã€‚</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220616213109383.png" class=""><p>å°ç»“ï¼šèšç°‡ç´¢å¼•ä¸éèšç°‡ç´¢å¼•çš„åŸç†ä¸åŒï¼Œåœ¨ä½¿ç”¨ä¸Šä¹Ÿæœ‰ä¸€äº›åŒºåˆ«ï¼š</p><ol><li>èšç°‡ç´¢å¼•çš„<code>å¶å­èŠ‚ç‚¹</code>å­˜å‚¨çš„å°±æ˜¯æˆ‘ä»¬çš„<code>æ•°æ®è®°å½•</code>, éèšç°‡ç´¢å¼•çš„å¶å­èŠ‚ç‚¹å­˜å‚¨çš„æ˜¯<code>æ•°æ®ä½ç½®</code>ã€‚éèšç°‡ç´¢å¼•ä¸ä¼šå½±å“æ•°æ®è¡¨çš„ç‰©ç†å­˜å‚¨é¡ºåºã€‚</li><li>ä¸€ä¸ªè¡¨<code>åªèƒ½æœ‰ä¸€ä¸ªèšç°‡ç´¢å¼•</code>ï¼Œå› ä¸ºåªèƒ½æœ‰ä¸€ç§æ’åºå­˜å‚¨çš„æ–¹å¼ï¼Œä½†å¯ä»¥æœ‰<code>å¤šä¸ªéèšç°‡ç´¢å¼•</code>ï¼Œä¹Ÿå°±æ˜¯å¤šä¸ªç´¢å¼•ç›®å½•æä¾›æ•°æ®æ£€ç´¢ã€‚</li><li>ä½¿ç”¨èšç°‡ç´¢å¼•çš„æ—¶å€™ï¼Œæ•°æ®çš„<code>æŸ¥è¯¢æ•ˆç‡é«˜</code>ï¼Œä½†å¦‚æœå¯¹æ•°æ®è¿›è¡Œæ’å…¥ï¼Œåˆ é™¤ï¼Œæ›´æ–°ç­‰æ“ä½œï¼Œæ•ˆç‡ä¼šæ¯”éèšç°‡ç´¢å¼•ä½ã€‚</li></ol><h4 id="3-è”åˆç´¢å¼•"><a href="#3-è”åˆç´¢å¼•" class="headerlink" title="3.è”åˆç´¢å¼•"></a>3.è”åˆç´¢å¼•</h4><p>æˆ‘ä»¬ä¹Ÿå¯ä»¥åŒæ—¶ä»¥å¤šä¸ªåˆ—çš„å¤§å°ä½œä¸ºæ’åºè§„åˆ™ï¼Œä¹Ÿå°±æ˜¯åŒæ—¶ä¸ºå¤šä¸ªåˆ—å»ºç«‹ç´¢å¼•ï¼Œæ¯”æ–¹è¯´æˆ‘ä»¬æƒ³è®©B+æ ‘æŒ‰ ç…§ c2å’Œc3åˆ— çš„å¤§å°è¿›è¡Œæ’åºï¼Œè¿™ä¸ªåŒ…å«ä¸¤å±‚å«ä¹‰ï¼š </p><ul><li>å…ˆæŠŠå„ä¸ªè®°å½•å’Œé¡µæŒ‰ç…§c2åˆ—è¿›è¡Œæ’åºã€‚ </li><li>åœ¨è®°å½•çš„c2åˆ—ç›¸åŒçš„æƒ…å†µä¸‹ï¼Œé‡‡ç”¨c3åˆ—è¿›è¡Œæ’åº</li></ul><p>ä¸ºc2å’Œc3å»ºç«‹çš„ç´¢å¼•çš„ç¤ºæ„å›¾å¦‚ä¸‹ï¼š</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220616215251172.png" class=""><p>å¦‚å›¾æ‰€ç¤ºï¼Œæˆ‘ä»¬éœ€è¦æ³¨æ„ä»¥ä¸‹å‡ ç‚¹ï¼š</p><ul><li>æ¯æ¡ç›®å½•é¡¹éƒ½æœ‰c2ã€c3ã€é¡µå·è¿™ä¸‰ä¸ªéƒ¨åˆ†ç»„æˆï¼Œå„æ¡è®°å½•å…ˆæŒ‰ç…§c2åˆ—çš„å€¼è¿›è¡Œæ’åºï¼Œå¦‚æœè®°å½•çš„c2åˆ—ç›¸åŒï¼Œåˆ™æŒ‰ç…§c3åˆ—çš„å€¼è¿›è¡Œæ’åº</li><li>B+æ ‘å¶å­èŠ‚ç‚¹å¤„çš„ç”¨æˆ·è®°å½•ç”±c2ã€c3å’Œä¸»é”®c1åˆ—ç»„æˆ</li></ul><p>æ³¨æ„ä¸€ç‚¹ï¼Œä»¥c2å’Œc3åˆ—çš„å¤§å°ä¸ºæ’åºè§„åˆ™å»ºç«‹çš„B+æ ‘ç§°ä¸º è”åˆç´¢å¼• ï¼Œæœ¬è´¨ä¸Šä¹Ÿæ˜¯ä¸€ä¸ªäºŒçº§ç´¢å¼•ã€‚å®ƒçš„æ„ æ€ä¸åˆ†åˆ«ä¸ºc2å’Œc3åˆ—åˆ†åˆ«å»ºç«‹ç´¢å¼•çš„è¡¨è¿°æ˜¯ä¸åŒçš„ï¼Œä¸åŒç‚¹å¦‚ä¸‹ï¼š </p><ul><li>å»ºç«‹ è”åˆç´¢å¼• åªä¼šå»ºç«‹å¦‚ä¸Šå›¾ä¸€æ ·çš„1æ£µB+æ ‘ã€‚ </li><li>ä¸ºc2å’Œc3åˆ—åˆ†åˆ«å»ºç«‹ç´¢å¼•ä¼šåˆ†åˆ«ä»¥c2å’Œc3åˆ—çš„å¤§å°ä¸ºæ’åºè§„åˆ™å»ºç«‹2æ£µB+æ ‘ã€‚</li></ul><h3 id="3-4-InnoDBçš„B-æ ‘ç´¢å¼•çš„æ³¨æ„äº‹é¡¹"><a href="#3-4-InnoDBçš„B-æ ‘ç´¢å¼•çš„æ³¨æ„äº‹é¡¹" class="headerlink" title="3.4 InnoDBçš„B+æ ‘ç´¢å¼•çš„æ³¨æ„äº‹é¡¹"></a>3.4 InnoDBçš„B+æ ‘ç´¢å¼•çš„æ³¨æ„äº‹é¡¹</h3><h4 id="1-æ ¹é¡µé¢ä½ç½®ä¸‡å¹´ä¸åŠ¨"><a href="#1-æ ¹é¡µé¢ä½ç½®ä¸‡å¹´ä¸åŠ¨" class="headerlink" title="1. æ ¹é¡µé¢ä½ç½®ä¸‡å¹´ä¸åŠ¨"></a>1. æ ¹é¡µé¢ä½ç½®ä¸‡å¹´ä¸åŠ¨</h4><p>å®é™…ä¸ŠB+æ ‘çš„å½¢æˆè¿‡ç¨‹æ˜¯è¿™æ ·çš„ï¼š</p><ul><li>æ¯å½“ä¸ºæŸä¸ªè¡¨åˆ›å»ºä¸€ä¸ªB+æ ‘ç´¢å¼•ï¼ˆèšç°‡ç´¢å¼•ä¸æ˜¯äººä¸ºåˆ›å»ºçš„ï¼Œé»˜è®¤å°±æœ‰ï¼‰çš„æ—¶å€™ï¼Œéƒ½ä¼šä¸ºè¿™ä¸ªç´¢å¼•åˆ›å»ºä¸€ä¸ª <code>æ ¹ç»“ç‚¹</code> é¡µé¢ã€‚æœ€å¼€å§‹è¡¨ä¸­æ²¡æœ‰æ•°æ®çš„æ—¶å€™ï¼Œæ¯ä¸ªB+æ ‘ç´¢å¼•å¯¹åº”çš„ <code>æ ¹ç»“ç‚¹</code> ä¸­å³æ²¡æœ‰ç”¨æˆ·è®°å½•ï¼Œä¹Ÿæ²¡æœ‰ç›®å½•é¡¹è®°å½•ã€‚</li><li>éšåå‘è¡¨ä¸­æ’å…¥ç”¨æˆ·è®°å½•æ—¶ï¼Œå…ˆæŠŠç”¨æˆ·è®°å½•å­˜å‚¨åˆ°è¿™ä¸ª<code>æ ¹èŠ‚ç‚¹</code> ä¸­ã€‚</li><li>å½“æ ¹èŠ‚ç‚¹ä¸­çš„å¯ç”¨ <code>ç©ºé—´ç”¨å®Œæ—¶</code> ç»§ç»­æ’å…¥è®°å½•ï¼Œæ­¤æ—¶ä¼šå°†æ ¹èŠ‚ç‚¹ä¸­çš„æ‰€æœ‰è®°å½•å¤åˆ¶åˆ°ä¸€ä¸ªæ–°åˆ†é…çš„é¡µï¼Œæ¯”å¦‚ <code>é¡µa</code> ä¸­ï¼Œç„¶åå¯¹è¿™ä¸ªæ–°é¡µè¿›è¡Œ <code>é¡µåˆ†è£‚</code> çš„æ“ä½œï¼Œå¾—åˆ°å¦ä¸€ä¸ªæ–°é¡µï¼Œæ¯”å¦‚<code>é¡µb</code> ã€‚è¿™æ—¶æ–°æ’å…¥çš„è®°å½•æ ¹æ®é”®å€¼ï¼ˆä¹Ÿå°±æ˜¯èšç°‡ç´¢å¼•ä¸­çš„ä¸»é”®å€¼ï¼ŒäºŒçº§ç´¢å¼•ä¸­å¯¹åº”çš„ç´¢å¼•åˆ—çš„å€¼ï¼‰çš„å¤§å°å°±ä¼šè¢«åˆ†é…åˆ° <code>é¡µa</code> æˆ–è€… <code>é¡µb</code> ä¸­ï¼Œè€Œ <code>æ ¹èŠ‚ç‚¹</code> ä¾¿å‡çº§ä¸ºå­˜å‚¨ç›®å½•é¡¹è®°å½•çš„é¡µã€‚</li></ul><p>è¿™ä¸ªè¿‡ç¨‹ç‰¹åˆ«æ³¨æ„çš„æ˜¯ï¼šä¸€ä¸ªB+æ ‘ç´¢å¼•çš„æ ¹èŠ‚ç‚¹è‡ªè¯ç”Ÿä¹‹æ—¥èµ·ï¼Œä¾¿ä¸ä¼šå†ç§»åŠ¨ã€‚è¿™æ ·åªè¦æˆ‘ä»¬å¯¹æŸä¸ªè¡¨å»ºè®®ä¸€ä¸ªç´¢å¼•ï¼Œé‚£ä¹ˆå®ƒçš„æ ¹èŠ‚ç‚¹çš„é¡µå·ä¾¿ä¼šè¢«è®°å½•åˆ°æŸä¸ªåœ°æ–¹ã€‚ç„¶åå‡¡æ˜¯ <code>InnoDB</code> å­˜å‚¨å¼•æ“éœ€è¦ç”¨åˆ°è¿™ä¸ªç´¢å¼•çš„æ—¶å€™ï¼Œéƒ½ä¼šä»å“ªä¸ªå›ºå®šçš„åœ°æ–¹å–å‡ºæ ¹èŠ‚ç‚¹çš„é¡µå·ï¼Œä»è€Œæ¥è®¿é—®è¿™ä¸ªç´¢å¼•ã€‚</p><h4 id="2-å†…èŠ‚ç‚¹ä¸­ç›®å½•é¡¹è®°å½•çš„å”¯ä¸€æ€§"><a href="#2-å†…èŠ‚ç‚¹ä¸­ç›®å½•é¡¹è®°å½•çš„å”¯ä¸€æ€§" class="headerlink" title="2. å†…èŠ‚ç‚¹ä¸­ç›®å½•é¡¹è®°å½•çš„å”¯ä¸€æ€§"></a>2. å†…èŠ‚ç‚¹ä¸­ç›®å½•é¡¹è®°å½•çš„å”¯ä¸€æ€§</h4><p>æˆ‘ä»¬çŸ¥é“B+æ ‘ç´¢å¼•çš„å†…èŠ‚ç‚¹ä¸­ç›®å½•é¡¹è®°å½•çš„å†…å®¹æ˜¯ <code>ç´¢å¼•åˆ— + é¡µå·</code> çš„æ­é…ï¼Œä½†æ˜¯è¿™ä¸ªæ­é…å¯¹äºäºŒçº§ç´¢å¼•æ¥è¯´æœ‰ç‚¹ä¸ä¸¥è°¨ã€‚è¿˜æ‹¿ index_demo è¡¨ä¸ºä¾‹ï¼Œå‡è®¾è¿™ä¸ªè¡¨ä¸­çš„æ•°æ®æ˜¯è¿™æ ·çš„ï¼š</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220617151918786.png" class=""><p>å¦‚æœäºŒçº§ç´¢å¼•ä¸­ç›®å½•é¡¹è®°å½•çš„å†…å®¹åªæ˜¯ <code>ç´¢å¼•åˆ— + é¡µå·</code> çš„æ­é…çš„è¯ï¼Œé‚£ä¹ˆä¸º <code>c2</code> åˆ—ç®€å†ç´¢å¼•åçš„B+æ ‘åº”è¯¥é•¿è¿™æ ·ï¼š</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220617152906690.png" class=""><p>å¦‚æœæˆ‘ä»¬æƒ³æ–°æ’å…¥ä¸€è¡Œè®°å½•ï¼Œå…¶ä¸­ <code>c1</code> ã€<code>c2</code> ã€<code>c3</code> çš„å€¼åˆ†åˆ«æ˜¯: <code>9</code>ã€<code>1</code>ã€<code>c</code>, é‚£ä¹ˆåœ¨ä¿®æ”¹è¿™ä¸ªä¸º c2 åˆ—å»ºç«‹çš„äºŒçº§ç´¢å¼•å¯¹åº”çš„ B+ æ ‘æ—¶ä¾¿ç¢°åˆ°äº†ä¸ªå¤§é—®é¢˜ï¼šç”±äº <code>é¡µ3</code> ä¸­å­˜å‚¨çš„ç›®å½•é¡¹è®°å½•æ˜¯ç”± <code>c2åˆ— + é¡µå·</code> çš„å€¼æ„æˆçš„ï¼Œ<code>é¡µ3</code> ä¸­çš„ä¸¤æ¡ç›®å½•é¡¹è®°å½•å¯¹åº”çš„ c2 åˆ—çš„å€¼éƒ½æ˜¯1ï¼Œè€Œæˆ‘ä»¬ <code>æ–°æ’å…¥çš„è¿™æ¡è®°å½•</code> çš„ c2 åˆ—çš„å€¼ä¹Ÿæ˜¯ <code>1</code>ï¼Œé‚£æˆ‘ä»¬è¿™æ¡æ–°æ’å…¥çš„è®°å½•åˆ°åº•åº”è¯¥æ”¾åœ¨ <code>é¡µ4</code> ä¸­ï¼Œè¿˜æ˜¯åº”è¯¥æ”¾åœ¨ <code>é¡µ5</code> ä¸­ï¼Ÿç­”æ¡ˆï¼šå¯¹ä¸èµ·ï¼Œæ‡µäº†</p><p>ä¸ºäº†è®©æ–°æ’å…¥è®°å½•æ‰¾åˆ°è‡ªå·±åœ¨é‚£ä¸ªé¡µé¢ï¼Œæˆ‘ä»¬éœ€è¦<strong>ä¿è¯åœ¨B+æ ‘çš„åŒä¸€å±‚é¡µèŠ‚ç‚¹çš„ç›®å½•é¡¹è®°å½•é™¤é¡µå·è¿™ä¸ªå­—æ®µä»¥å¤–æ˜¯å”¯ä¸€çš„</strong>ã€‚æ‰€ä»¥å¯¹äºäºŒçº§ç´¢å¼•çš„å†…èŠ‚ç‚¹çš„ç›®å½•é¡¹è®°å½•çš„å†…å®¹å®é™…ä¸Šæ˜¯ç”±ä¸‰ä¸ªéƒ¨åˆ†æ„æˆçš„ï¼š</p><ul><li>ç´¢å¼•åˆ—çš„å€¼</li><li>ä¸»é”®å€¼</li><li>é¡µå·</li></ul><p>ä¹Ÿå°±æ˜¯æˆ‘ä»¬æŠŠ<code>ä¸»é”®å€¼</code>ä¹Ÿæ·»åŠ åˆ°äºŒçº§ç´¢å¼•å†…èŠ‚ç‚¹ä¸­çš„ç›®å½•é¡¹è®°å½•ï¼Œè¿™æ ·å°±èƒ½ä¿ä½ B+ æ ‘æ¯ä¸€å±‚èŠ‚ç‚¹ä¸­å„æ¡ç›®å½•é¡¹è®°å½•é™¤é¡µå·è¿™ä¸ªå­—æ®µå¤–æ˜¯å”¯ä¸€çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸ºc2å»ºç«‹äºŒçº§ç´¢å¼•åçš„ç¤ºæ„å›¾å®é™…ä¸Šåº”è¯¥æ˜¯è¿™æ ·å­çš„ï¼š</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220617154135258.png" class=""><p>è¿™æ ·æˆ‘ä»¬å†æ’å…¥è®°å½•<code>(9, 1, &#39;c&#39;)</code> æ—¶ï¼Œç”±äº <code>é¡µ3</code> ä¸­å­˜å‚¨çš„ç›®å½•é¡¹è®°å½•æ˜¯ç”± <code>c2åˆ— + ä¸»é”® + é¡µå·</code> çš„å€¼æ„æˆçš„ï¼Œå¯ä»¥å…ˆæŠŠæ–°çºªå½•çš„ <code>c2</code> åˆ—çš„å€¼å’Œ <code>é¡µ3</code> ä¸­å„ç›®å½•é¡¹è®°å½•çš„ <code>c2</code> åˆ—çš„å€¼ä½œæ¯”è¾ƒï¼Œå¦‚æœ <code>c2</code> åˆ—çš„å€¼ç›¸åŒçš„è¯ï¼Œå¯ä»¥æ¥ç€æ¯”è¾ƒä¸»é”®å€¼ï¼Œå› ä¸ºB+æ ‘åŒä¸€å±‚ä¸­ä¸åŒç›®å½•é¡¹è®°å½•çš„ <code>c2åˆ— + ä¸»é”®</code>çš„å€¼è‚¯å®šæ˜¯ä¸ä¸€æ ·çš„ï¼Œæ‰€ä»¥æœ€åè‚¯å®šèƒ½å®šä½å”¯ä¸€çš„ä¸€æ¡ç›®å½•é¡¹è®°å½•ï¼Œåœ¨æœ¬ä¾‹ä¸­æœ€åç¡®å®šæ–°çºªå½•åº”è¯¥è¢«æ’å…¥åˆ° <code>é¡µ5</code> ä¸­ã€‚</p><h4 id="3-ä¸€ä¸ªé¡µé¢æœ€å°‘å­˜å‚¨-2-æ¡è®°å½•"><a href="#3-ä¸€ä¸ªé¡µé¢æœ€å°‘å­˜å‚¨-2-æ¡è®°å½•" class="headerlink" title="3. ä¸€ä¸ªé¡µé¢æœ€å°‘å­˜å‚¨ 2 æ¡è®°å½•"></a>3. ä¸€ä¸ªé¡µé¢æœ€å°‘å­˜å‚¨ 2 æ¡è®°å½•</h4><p>ä¸€ä¸ªB+æ ‘åªéœ€è¦å¾ˆå°‘çš„å±‚çº§å°±å¯ä»¥è½»æ¾å­˜å‚¨æ•°äº¿æ¡è®°å½•ï¼ŒæŸ¥è¯¢é€Ÿåº¦ç›¸å½“ä¸é”™ï¼è¿™æ˜¯å› ä¸ºB+æ ‘æœ¬è´¨ä¸Šå°±æ˜¯ä¸€ä¸ªå¤§çš„å¤šå±‚çº§ç›®å½•ï¼Œæ¯ç»è¿‡ä¸€ä¸ªç›®å½•æ—¶éƒ½ä¼šè¿‡æ»¤æ‰è®¸å¤šæ— æ•ˆçš„å­ç›®å½•ï¼Œç›´åˆ°æœ€åè®¿é—®åˆ°å­˜å‚¨çœŸå®æ•°æ®çš„ç›®å½•ã€‚é‚£å¦‚æœä¸€ä¸ªå¤§çš„ç›®å½•ä¸­åªå­˜æ”¾ä¸€ä¸ªå­ç›®å½•æ˜¯ä¸ªå•¥æ•ˆæœå‘¢ï¼Ÿé‚£å°±æ˜¯ç›®å½•å±‚çº§éå¸¸éå¸¸å¤šï¼Œè€Œä¸”æœ€åçš„é‚£ä¸ªå­˜æ”¾çœŸå®æ•°æ®çš„ç›®å½•ä¸­åªå­˜æ”¾ä¸€æ¡æ•°æ®ã€‚æ‰€ä»¥ <strong>InnoDB çš„ä¸€ä¸ªæ•°æ®é¡µè‡³å°‘å¯ä»¥å­˜æ”¾ä¸¤æ¡è®°å½•</strong>ã€‚</p><h2 id="4-MyISAMä¸­çš„ç´¢å¼•æ–¹æ¡ˆ"><a href="#4-MyISAMä¸­çš„ç´¢å¼•æ–¹æ¡ˆ" class="headerlink" title="4. MyISAMä¸­çš„ç´¢å¼•æ–¹æ¡ˆ"></a>4. MyISAMä¸­çš„ç´¢å¼•æ–¹æ¡ˆ</h2><p>Bæ ‘ç´¢å¼•ä½¿ç”¨å­˜å‚¨å¼•æ“å¦‚è¡¨æ‰€ç¤ºï¼š</p><table><thead><tr><th>ç´¢å¼• &#x2F; å­˜å‚¨å¼•æ“</th><th>MyISAM</th><th>InnoDB</th><th>Memory</th></tr></thead><tbody><tr><td>B-Treeç´¢å¼•</td><td>æ”¯æŒ</td><td>æ”¯æŒ</td><td>æ”¯æŒ</td></tr></tbody></table><p>å³ä½¿å¤šä¸ªå­˜å‚¨å¼•æ“æ”¯æŒåŒä¸€ç§ç±»å‹çš„ç´¢å¼•ï¼Œä½†æ˜¯ä»–ä»¬çš„å®ç°åŸç†ä¹Ÿæ˜¯ä¸åŒçš„ã€‚Innodbå’ŒMyISAMé»˜è®¤çš„ç´¢ å¼•æ˜¯Btreeç´¢å¼•ï¼›è€ŒMemoryé»˜è®¤çš„ç´¢å¼•æ˜¯Hashç´¢å¼•ã€‚</p><p>MyISAMå¼•æ“ä½¿ç”¨ B+Tree ä½œä¸ºç´¢å¼•ç»“æ„ï¼Œå¶å­èŠ‚ç‚¹çš„dataåŸŸå­˜æ”¾çš„æ˜¯ æ•°æ®è®°å½•çš„åœ°å€ ã€‚</p><h3 id="4-1-MyISAMç´¢å¼•çš„åŸç†"><a href="#4-1-MyISAMç´¢å¼•çš„åŸç†" class="headerlink" title="4.1 MyISAMç´¢å¼•çš„åŸç†"></a>4.1 MyISAMç´¢å¼•çš„åŸç†</h3><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220617160325201.png" class=""><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220617160413479.png" class=""><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220617160533122.png" class=""><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220617160625006.png" class=""><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220617160813548.png" class=""><h3 id="4-2-MyISAM-ä¸-InnoDBå¯¹æ¯”"><a href="#4-2-MyISAM-ä¸-InnoDBå¯¹æ¯”" class="headerlink" title="4.2 MyISAM ä¸ InnoDBå¯¹æ¯”"></a>4.2 MyISAM ä¸ InnoDBå¯¹æ¯”</h3><p><strong>MyISAMçš„ç´¢å¼•æ–¹å¼éƒ½æ˜¯â€œéèšç°‡â€çš„ï¼Œä¸InnoDBåŒ…å«1ä¸ªèšç°‡ç´¢å¼•æ˜¯ä¸åŒçš„ã€‚å°ç»“ä¸¤ç§å¼•æ“ä¸­ç´¢å¼•çš„åŒºåˆ«ï¼š</strong></p><p>â‘  åœ¨InnoDBå­˜å‚¨å¼•æ“ä¸­ï¼Œæˆ‘ä»¬åªéœ€è¦æ ¹æ®ä¸»é”®å€¼å¯¹ èšç°‡ç´¢å¼• è¿›è¡Œä¸€æ¬¡æŸ¥æ‰¾å°±èƒ½æ‰¾åˆ°å¯¹åº”çš„è®°å½•ï¼Œè€Œåœ¨ MyISAM ä¸­å´éœ€è¦è¿›è¡Œä¸€æ¬¡ å›è¡¨ æ“ä½œï¼Œæ„å‘³ç€MyISAMä¸­å»ºç«‹çš„ç´¢å¼•ç›¸å½“äºå…¨éƒ¨éƒ½æ˜¯ äºŒçº§ç´¢å¼• ã€‚</p><p> â‘¡ InnoDBçš„æ•°æ®æ–‡ä»¶æœ¬èº«å°±æ˜¯ç´¢å¼•æ–‡ä»¶ï¼Œè€ŒMyISAMç´¢å¼•æ–‡ä»¶å’Œæ•°æ®æ–‡ä»¶æ˜¯ åˆ†ç¦»çš„ ï¼Œç´¢å¼•æ–‡ä»¶ä»…ä¿å­˜æ•° æ®è®°å½•çš„åœ°å€ã€‚</p><p> â‘¢ InnoDBçš„éèšç°‡ç´¢å¼•dataåŸŸå­˜å‚¨ç›¸åº”è®°å½• ä¸»é”®çš„å€¼ ï¼Œè€ŒMyISAMç´¢å¼•è®°å½•çš„æ˜¯ åœ°å€ ã€‚æ¢å¥è¯è¯´ï¼Œ InnoDBçš„æ‰€æœ‰éèšç°‡ç´¢å¼•éƒ½å¼•ç”¨ä¸»é”®ä½œä¸ºdataåŸŸã€‚</p><p> â‘£ MyISAMçš„å›è¡¨æ“ä½œæ˜¯ååˆ† å¿«é€Ÿ çš„ï¼Œå› ä¸ºæ˜¯æ‹¿ç€åœ°å€åç§»é‡ç›´æ¥åˆ°æ–‡ä»¶ä¸­å–æ•°æ®çš„ï¼Œåè§‚InnoDBæ˜¯é€š è¿‡è·å–ä¸»é”®ä¹‹åå†å»èšç°‡ç´¢å¼•é‡Œæ‰¾è®°å½•ï¼Œè™½ç„¶è¯´ä¹Ÿä¸æ…¢ï¼Œä½†è¿˜æ˜¯æ¯”ä¸ä¸Šç›´æ¥ç”¨åœ°å€å»è®¿é—®ã€‚ </p><p>â‘¤ InnoDBè¦æ±‚è¡¨ å¿…é¡»æœ‰ä¸»é”® ï¼ˆ MyISAMå¯ä»¥æ²¡æœ‰ ï¼‰ã€‚å¦‚æœæ²¡æœ‰æ˜¾å¼æŒ‡å®šï¼Œåˆ™MySQLç³»ç»Ÿä¼šè‡ªåŠ¨é€‰æ‹©ä¸€ä¸ª å¯ä»¥éç©ºä¸”å”¯ä¸€æ ‡è¯†æ•°æ®è®°å½•çš„åˆ—ä½œä¸ºä¸»é”®ã€‚å¦‚æœä¸å­˜åœ¨è¿™ç§åˆ—ï¼Œåˆ™MySQLè‡ªåŠ¨ä¸ºInnoDBè¡¨ç”Ÿæˆä¸€ä¸ªéš å«å­—æ®µä½œä¸ºä¸»é”®ï¼Œè¿™ä¸ªå­—æ®µé•¿åº¦ä¸º6ä¸ªå­—èŠ‚ï¼Œç±»å‹ä¸ºé•¿æ•´å‹ã€‚</p><p><strong>å°ç»“ï¼š</strong></p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220617161126022.png" class=""><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220617161151125.png" class=""><h2 id="5-ç´¢å¼•çš„ä»£ä»·"><a href="#5-ç´¢å¼•çš„ä»£ä»·" class="headerlink" title="5. ç´¢å¼•çš„ä»£ä»·"></a>5. ç´¢å¼•çš„ä»£ä»·</h2><p>ç´¢å¼•æ˜¯ä¸ªå¥½ä¸œè¥¿ï¼Œå¯ä¸èƒ½ä¹±å»ºï¼Œå®ƒåœ¨ç©ºé—´å’Œæ—¶é—´ä¸Šéƒ½ä¼šæœ‰æ¶ˆè€—ï¼š</p><ul><li><p>ç©ºé—´ä¸Šçš„ä»£ä»·</p><p>æ¯å»ºç«‹ä¸€ä¸ªç´¢å¼•éƒ½è¦ä¸ºå®ƒå»ºç«‹ä¸€æ£µB+æ ‘ï¼Œæ¯ä¸€æ£µB+æ ‘çš„æ¯ä¸€ä¸ªèŠ‚ç‚¹éƒ½æ˜¯ä¸€ä¸ªæ•°æ®é¡µï¼Œä¸€ä¸ªé¡µé»˜è®¤ä¼š å ç”¨ 16KB çš„å­˜å‚¨ç©ºé—´ï¼Œä¸€æ£µå¾ˆå¤§çš„B+æ ‘ç”±è®¸å¤šæ•°æ®é¡µç»„æˆï¼Œé‚£å°±æ˜¯å¾ˆå¤§çš„ä¸€ç‰‡å­˜å‚¨ç©ºé—´ã€‚</p></li><li><p>æ—¶é—´ä¸Šçš„ä»£ä»·</p><p>æ¯æ¬¡å¯¹è¡¨ä¸­çš„æ•°æ®è¿›è¡Œ å¢ã€åˆ ã€æ”¹ æ“ä½œæ—¶ï¼Œéƒ½éœ€è¦å»ä¿®æ”¹å„ä¸ªB+æ ‘ç´¢å¼•ã€‚è€Œä¸”æˆ‘ä»¬è®²è¿‡ï¼ŒB+æ ‘æ¯ å±‚èŠ‚ç‚¹éƒ½æ˜¯æŒ‰ç…§ç´¢å¼•åˆ—çš„å€¼ ä»å°åˆ°å¤§çš„é¡ºåºæ’åº è€Œç»„æˆäº† åŒå‘é“¾è¡¨ ã€‚ä¸è®ºæ˜¯å¶å­èŠ‚ç‚¹ä¸­çš„è®°å½•ï¼Œè¿˜ æ˜¯å†…èŠ‚ç‚¹ä¸­çš„è®°å½•ï¼ˆä¹Ÿå°±æ˜¯ä¸è®ºæ˜¯ç”¨æˆ·è®°å½•è¿˜æ˜¯ç›®å½•é¡¹è®°å½•ï¼‰éƒ½æ˜¯æŒ‰ç…§ç´¢å¼•åˆ—çš„å€¼ä»å°åˆ°å¤§çš„é¡ºåº è€Œå½¢æˆäº†ä¸€ä¸ªå•å‘é“¾è¡¨ã€‚è€Œå¢ã€åˆ ã€æ”¹æ“ä½œå¯èƒ½ä¼šå¯¹èŠ‚ç‚¹å’Œè®°å½•çš„æ’åºé€ æˆç ´åï¼Œæ‰€ä»¥å­˜å‚¨å¼•æ“éœ€ è¦é¢å¤–çš„æ—¶é—´è¿›è¡Œä¸€äº› è®°å½•ç§»ä½ ï¼Œ é¡µé¢åˆ†è£‚ ã€ é¡µé¢å›æ”¶ ç­‰æ“ä½œæ¥ç»´æŠ¤å¥½èŠ‚ç‚¹å’Œè®°å½•çš„æ’åºã€‚å¦‚æœ æˆ‘ä»¬å»ºäº†è®¸å¤šç´¢å¼•ï¼Œæ¯ä¸ªç´¢å¼•å¯¹åº”çš„B+æ ‘éƒ½è¦è¿›è¡Œç›¸å…³çš„ç»´æŠ¤æ“ä½œï¼Œä¼šç»™æ€§èƒ½æ‹–åè…¿ã€‚</p></li></ul><blockquote><p>ä¸€ä¸ªè¡¨ä¸Šç´¢å¼•å»ºçš„è¶Šå¤šï¼Œå°±ä¼šå ç”¨è¶Šå¤šçš„å­˜å‚¨ç©ºé—´ï¼Œåœ¨å¢åˆ æ”¹è®°å½•çš„æ—¶å€™æ€§èƒ½å°±è¶Šå·®ã€‚ä¸ºäº†èƒ½å»ºç«‹åˆå¥½åˆå°‘çš„ç´¢å¼•ï¼Œæˆ‘ä»¬å¾—å­¦å­¦è¿™äº›ç´¢å¼•åœ¨å“ªäº›æ¡ä»¶ä¸‹èµ·ä½œç”¨çš„ã€‚</p></blockquote><h2 id="6-MySQLæ•°æ®ç»“æ„é€‰æ‹©çš„åˆç†æ€§"><a href="#6-MySQLæ•°æ®ç»“æ„é€‰æ‹©çš„åˆç†æ€§" class="headerlink" title="6. MySQLæ•°æ®ç»“æ„é€‰æ‹©çš„åˆç†æ€§"></a>6. MySQLæ•°æ®ç»“æ„é€‰æ‹©çš„åˆç†æ€§</h2><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220617161635521.png" class=""><h3 id="6-1-å…¨è¡¨æŸ¥è¯¢"><a href="#6-1-å…¨è¡¨æŸ¥è¯¢" class="headerlink" title="6.1 å…¨è¡¨æŸ¥è¯¢"></a>6.1 å…¨è¡¨æŸ¥è¯¢</h3><p>è¿™é‡Œéƒ½æ‡’å¾—è¯´äº†ã€‚</p><h3 id="6-2-HashæŸ¥è¯¢"><a href="#6-2-HashæŸ¥è¯¢" class="headerlink" title="6.2 HashæŸ¥è¯¢"></a>6.2 HashæŸ¥è¯¢</h3><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220617161946230.png" class=""><p><strong>åŠ å¿«æŸ¥æ‰¾é€Ÿåº¦çš„æ•°æ®ç»“æ„ï¼Œå¸¸è§çš„æœ‰ä¸¤ç±»ï¼š</strong></p><p>(1) æ ‘ï¼Œä¾‹å¦‚å¹³è¡¡äºŒå‰æœç´¢æ ‘ï¼ŒæŸ¥è¯¢&#x2F;æ’å…¥&#x2F;ä¿®æ”¹&#x2F;åˆ é™¤çš„å¹³å‡æ—¶é—´å¤æ‚åº¦éƒ½æ˜¯ <code>O(log2N)</code>;</p><p>(2)å“ˆå¸Œï¼Œä¾‹å¦‚HashMapï¼ŒæŸ¥è¯¢&#x2F;æ’å…¥&#x2F;ä¿®æ”¹&#x2F;åˆ é™¤çš„å¹³å‡æ—¶é—´å¤æ‚åº¦éƒ½æ˜¯ <code>O(1)</code>; (key, value)</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220617162153587.png" class=""><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220617162548697.png" class=""><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220617162604272.png" class=""><p>ä¸Šå›¾ä¸­å“ˆå¸Œå‡½æ•°hæœ‰å¯èƒ½å°†ä¸¤ä¸ªä¸åŒçš„å…³é”®å­—æ˜ å°„åˆ°ç›¸åŒçš„ä½ç½®ï¼Œè¿™å«åš ç¢°æ’ ï¼Œåœ¨æ•°æ®åº“ä¸­ä¸€èˆ¬é‡‡ç”¨ é“¾ æ¥æ³• æ¥è§£å†³ã€‚åœ¨é“¾æ¥æ³•ä¸­ï¼Œå°†æ•£åˆ—åˆ°åŒä¸€æ§½ä½çš„å…ƒç´ æ”¾åœ¨ä¸€ä¸ªé“¾è¡¨ä¸­ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220617162703006.png" class=""><p>å®éªŒï¼šä½“ä¼šæ•°ç»„å’Œhashè¡¨çš„æŸ¥æ‰¾æ–¹é¢çš„æ•ˆç‡åŒºåˆ«</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">// ç®—æ³•å¤æ‚åº¦ä¸º O(n)</span><br><span class="line">@Test</span><br><span class="line">public void test1()&#123;</span><br><span class="line">    int[] arr = new int[100000];</span><br><span class="line">    for(int i = 0;i &lt; arr.length;i++)&#123;</span><br><span class="line">        arr[i] = i + 1;</span><br><span class="line">    &#125;</span><br><span class="line">    long start = System.currentTimeMillis();</span><br><span class="line">    for(int j = 1; j&lt;=100000;j++)&#123;</span><br><span class="line">        int temp = j;</span><br><span class="line">        for(int i = 0;i &lt; arr.length;i++)&#123;</span><br><span class="line">            if(temp == arr[i])&#123;</span><br><span class="line">                break;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    long end = System.currentTimeMillis();</span><br><span class="line">    System.out.println(&quot;timeï¼š &quot; + (end - start)); //timeï¼š 823</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">// ç®—æ³•å¤æ‚åº¦ä¸º O(1)</span><br><span class="line">@Test</span><br><span class="line">public void test2()&#123;</span><br><span class="line">    HashSet&lt;Integer&gt; set = new HashSet&lt;&gt;(100000);</span><br><span class="line">    for(int i = 0;i &lt; 100000;i++)&#123;</span><br><span class="line">    set.add(i + 1);</span><br><span class="line">    &#125;</span><br><span class="line">    long start = System.currentTimeMillis();</span><br><span class="line">    for(int j = 1; j&lt;=100000;j++) &#123;</span><br><span class="line">        int temp = j;</span><br><span class="line">        boolean contains = set.contains(temp);</span><br><span class="line">    &#125;</span><br><span class="line">    long end = System.currentTimeMillis();</span><br><span class="line">    System.out.println(&quot;timeï¼š &quot; + (end - start)); //timeï¼š 5</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>Hashç»“æ„æ•ˆç‡é«˜ï¼Œé‚£ä¸ºä»€ä¹ˆç´¢å¼•ç»“æ„è¦è®¾è®¡æˆæ ‘å‹å‘¢ï¼Ÿ</strong></p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220617163202156.png" class=""><p><strong>Hashç´¢å¼•é€‚ç”¨å­˜å‚¨å¼•æ“å¦‚è¡¨æ‰€ç¤ºï¼š</strong></p><table><thead><tr><th>ç´¢å¼• &#x2F; å­˜å‚¨å¼•æ“</th><th>MyISAM</th><th>InnoDB</th><th>Memory</th></tr></thead><tbody><tr><td>HASHç´¢å¼•</td><td>ä¸æ”¯æŒ</td><td>ä¸æ”¯æŒ</td><td>æ”¯æŒ</td></tr></tbody></table><p><strong>Hashç´¢å¼•çš„é€‚ç”¨æ€§ï¼š</strong></p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220617163619721.png" class=""><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220617163657697.png" class=""><p>é‡‡ç”¨è‡ªé€‚åº” Hash ç´¢å¼•ç›®çš„æ˜¯æ–¹ä¾¿æ ¹æ® SQL çš„æŸ¥è¯¢æ¡ä»¶åŠ é€Ÿå®šä½åˆ°å¶å­èŠ‚ç‚¹ï¼Œç‰¹åˆ«æ˜¯å½“ B+ æ ‘æ¯”è¾ƒæ·±çš„æ—¶ å€™ï¼Œé€šè¿‡è‡ªé€‚åº” Hash ç´¢å¼•å¯ä»¥æ˜æ˜¾æé«˜æ•°æ®çš„æ£€ç´¢æ•ˆç‡ã€‚</p><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ innodb_adaptive_hash_index å˜é‡æ¥æŸ¥çœ‹æ˜¯å¦å¼€å¯äº†è‡ªé€‚åº” Hashï¼Œæ¯”å¦‚ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like &#x27;%adaptive_hash_index&#x27;;</span><br></pre></td></tr></table></figure><h3 id="6-3-äºŒå‰æœç´¢æ ‘"><a href="#6-3-äºŒå‰æœç´¢æ ‘" class="headerlink" title="6.3 äºŒå‰æœç´¢æ ‘"></a>6.3 äºŒå‰æœç´¢æ ‘</h3><p>å¦‚æœæˆ‘ä»¬åˆ©ç”¨äºŒå‰æ ‘ä½œä¸ºç´¢å¼•ç»“æ„ï¼Œé‚£ä¹ˆç£ç›˜çš„IOæ¬¡æ•°å’Œç´¢å¼•æ ‘çš„é«˜åº¦æ˜¯ç›¸å…³çš„ã€‚</p><p><strong>1. äºŒå‰æœç´¢æ ‘çš„ç‰¹ç‚¹</strong></p><ul><li>ä¸€ä¸ªèŠ‚ç‚¹åªèƒ½æœ‰ä¸¤ä¸ªå­èŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªèŠ‚ç‚¹åº¦ä¸èƒ½è¶…è¿‡2</li><li>å·¦å­èŠ‚ç‚¹ &lt; æœ¬èŠ‚ç‚¹; å³å­èŠ‚ç‚¹ &gt;&#x3D; æœ¬èŠ‚ç‚¹ï¼Œæ¯”æˆ‘å¤§çš„å‘å³ï¼Œæ¯”æˆ‘å°çš„å‘å·¦</li></ul><p><strong>2. æŸ¥æ‰¾è§„åˆ™</strong></p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220617163952166.png" class=""><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220617164022728.png" class=""><p>ä½†æ˜¯ç‰¹æ®Šæƒ…å†µï¼Œå°±æ˜¯æœ‰æ—¶å€™äºŒå‰æ ‘çš„æ·±åº¦éå¸¸å¤§ï¼Œæ¯”å¦‚ï¼š</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220617164053134.png" class=""><p>ä¸ºäº†æé«˜æŸ¥è¯¢æ•ˆç‡ï¼Œå°±éœ€è¦ å‡å°‘ç£ç›˜IOæ•° ã€‚ä¸ºäº†å‡å°‘ç£ç›˜IOçš„æ¬¡æ•°ï¼Œå°±éœ€è¦å°½é‡ é™ä½æ ‘çš„é«˜åº¦ ï¼Œéœ€è¦æŠŠ åŸæ¥â€œç˜¦é«˜â€çš„æ ‘ç»“æ„å˜çš„â€œçŸ®èƒ–â€ï¼Œæ ‘çš„æ¯å±‚çš„åˆ†å‰è¶Šå¤šè¶Šå¥½ã€‚</p><h3 id="6-4-AVLæ ‘"><a href="#6-4-AVLæ ‘" class="headerlink" title="6.4 AVLæ ‘"></a>6.4 AVLæ ‘</h3><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220617165045803.png" class=""><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220617165105005.png" class=""><p>&#96;æ¯è®¿é—®ä¸€æ¬¡èŠ‚ç‚¹å°±éœ€è¦è¿›è¡Œä¸€æ¬¡ç£ç›˜ I&#x2F;O æ“ä½œï¼Œå¯¹äºä¸Šé¢çš„æ ‘æ¥è¯´ï¼Œæˆ‘ä»¬éœ€è¦è¿›è¡Œ 5æ¬¡ I&#x2F;O æ“ä½œã€‚è™½ç„¶å¹³è¡¡äºŒå‰æ ‘çš„æ•ˆç‡é«˜ï¼Œä½†æ˜¯æ ‘çš„æ·±åº¦ä¹ŸåŒæ ·é«˜ï¼Œè¿™å°±æ„å‘³ç€ç£ç›˜ I&#x2F;O æ“ä½œæ¬¡æ•°å¤šï¼Œä¼šå½±å“æ•´ä½“æ•°æ®æŸ¥è¯¢çš„æ•ˆç‡ã€‚</p><p>é’ˆå¯¹åŒæ ·çš„æ•°æ®ï¼Œå¦‚æœæˆ‘ä»¬æŠŠäºŒå‰æ ‘æ”¹æˆ M å‰æ ‘ ï¼ˆM&gt;2ï¼‰å‘¢ï¼Ÿå½“ M&#x3D;3 æ—¶ï¼ŒåŒæ ·çš„ 31 ä¸ªèŠ‚ç‚¹å¯ä»¥ç”±ä¸‹é¢ çš„ä¸‰å‰æ ‘æ¥è¿›è¡Œå­˜å‚¨ï¼š</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220617165124685.png" class=""><p>ä½ èƒ½çœ‹åˆ°æ­¤æ—¶æ ‘çš„é«˜åº¦é™ä½äº†ï¼Œå½“æ•°æ®é‡ N å¤§çš„æ—¶å€™ï¼Œä»¥åŠæ ‘çš„åˆ†å‰æ ‘ M å¤§çš„æ—¶å€™ï¼ŒMå‰æ ‘çš„é«˜åº¦ä¼šè¿œå°äºäºŒå‰æ ‘çš„é«˜åº¦ (M &gt; 2)ã€‚æ‰€ä»¥ï¼Œæˆ‘ä»¬éœ€è¦æŠŠ &#96;æ ‘ä»â€œç˜¦é«˜â€ å˜ â€œçŸ®èƒ–â€ã€‚</p><h3 id="6-5-B-Tree"><a href="#6-5-B-Tree" class="headerlink" title="6.5 B-Tree"></a>6.5 B-Tree</h3><p>B æ ‘çš„è‹±æ–‡æ˜¯ Balance Treeï¼Œä¹Ÿå°±æ˜¯ <code>å¤šè·¯å¹³è¡¡æŸ¥æ‰¾æ ‘</code>ã€‚ç®€å†™ä¸º B-Treeã€‚å®ƒçš„é«˜åº¦è¿œå°äºå¹³è¡¡äºŒå‰æ ‘çš„é«˜åº¦ã€‚</p><p>B æ ‘çš„ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220617165937875.png" class=""><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220617170124200.png" class=""><p>ä¸€ä¸ª M é˜¶çš„ B æ ‘ï¼ˆM&gt;2ï¼‰æœ‰ä»¥ä¸‹çš„ç‰¹æ€§ï¼š</p><ol><li>æ ¹èŠ‚ç‚¹çš„å„¿å­æ•°çš„èŒƒå›´æ˜¯ [2,M]ã€‚ </li><li>æ¯ä¸ªä¸­é—´èŠ‚ç‚¹åŒ…å« k-1 ä¸ªå…³é”®å­—å’Œ k ä¸ªå­©å­ï¼Œå­©å­çš„æ•°é‡ &#x3D; å…³é”®å­—çš„æ•°é‡ +1ï¼Œk çš„å–å€¼èŒƒå›´ä¸º [ceil(M&#x2F;2), M]ã€‚ </li><li>å¶å­èŠ‚ç‚¹åŒ…æ‹¬ k-1 ä¸ªå…³é”®å­—ï¼ˆå¶å­èŠ‚ç‚¹æ²¡æœ‰å­©å­ï¼‰ï¼Œk çš„å–å€¼èŒƒå›´ä¸º [ceil(M&#x2F;2), M]ã€‚ </li><li>å‡è®¾ä¸­é—´èŠ‚ç‚¹èŠ‚ç‚¹çš„å…³é”®å­—ä¸ºï¼šKey[1], Key[2], â€¦, Key[k-1]ï¼Œä¸”å…³é”®å­—æŒ‰ç…§å‡åºæ’åºï¼Œå³ Key[i]&lt;Key[i+1]ã€‚æ­¤æ—¶ k-1 ä¸ªå…³é”®å­—ç›¸å½“äºåˆ’åˆ†äº† k ä¸ªèŒƒå›´ï¼Œä¹Ÿå°±æ˜¯å¯¹åº”ç€ k ä¸ªæŒ‡é’ˆï¼Œå³ä¸ºï¼šP[1], P[2], â€¦, P[k]ï¼Œå…¶ä¸­ P[1] æŒ‡å‘å…³é”®å­—å°äº Key[1] çš„å­æ ‘ï¼ŒP[i] æŒ‡å‘å…³é”®å­—å±äº (Key[i-1], Key[i]) çš„å­æ ‘ï¼ŒP[k] æŒ‡å‘å…³é”®å­—å¤§äº Key[k-1] çš„å­æ ‘ã€‚</li><li>æ‰€æœ‰å¶å­èŠ‚ç‚¹ä½äºåŒä¸€å±‚ã€‚</li></ol><p>ä¸Šé¢é‚£å¼ å›¾æ‰€è¡¨ç¤ºçš„ B æ ‘å°±æ˜¯ä¸€æ£µ 3 é˜¶çš„ B æ ‘ã€‚æˆ‘ä»¬å¯ä»¥çœ‹ä¸‹ç£ç›˜å— 2ï¼Œé‡Œé¢çš„å…³é”®å­—ä¸ºï¼ˆ8ï¼Œ12ï¼‰ï¼Œå®ƒ æœ‰ 3 ä¸ªå­©å­ (3ï¼Œ5)ï¼Œ(9ï¼Œ10) å’Œ (13ï¼Œ15)ï¼Œä½ èƒ½çœ‹åˆ° (3ï¼Œ5) å°äº 8ï¼Œ(9ï¼Œ10) åœ¨ 8 å’Œ 12 ä¹‹é—´ï¼Œè€Œ (13ï¼Œ15) å¤§äº 12ï¼Œåˆšå¥½ç¬¦åˆåˆšæ‰æˆ‘ä»¬ç»™å‡ºçš„ç‰¹å¾ã€‚</p><p>ç„¶åæˆ‘ä»¬æ¥çœ‹ä¸‹å¦‚ä½•ç”¨ B æ ‘è¿›è¡ŒæŸ¥æ‰¾ã€‚å‡è®¾æˆ‘ä»¬æƒ³è¦ æŸ¥æ‰¾çš„å…³é”®å­—æ˜¯ 9 ï¼Œé‚£ä¹ˆæ­¥éª¤å¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ æ­¥ï¼š</p><ol><li>æˆ‘ä»¬ä¸æ ¹èŠ‚ç‚¹çš„å…³é”®å­— (17ï¼Œ35ï¼‰è¿›è¡Œæ¯”è¾ƒï¼Œ9 å°äº 17 é‚£ä¹ˆå¾—åˆ°æŒ‡é’ˆ P1ï¼› </li><li>æŒ‰ç…§æŒ‡é’ˆ P1 æ‰¾åˆ°ç£ç›˜å— 2ï¼Œå…³é”®å­—ä¸ºï¼ˆ8ï¼Œ12ï¼‰ï¼Œå› ä¸º 9 åœ¨ 8 å’Œ 12 ä¹‹é—´ï¼Œæ‰€ä»¥æˆ‘ä»¬å¾—åˆ°æŒ‡é’ˆ P2ï¼› </li><li>æŒ‰ç…§æŒ‡é’ˆ P2 æ‰¾åˆ°ç£ç›˜å— 6ï¼Œå…³é”®å­—ä¸ºï¼ˆ9ï¼Œ10ï¼‰ï¼Œç„¶åæˆ‘ä»¬æ‰¾åˆ°äº†å…³é”®å­— 9ã€‚</li></ol><p>ä½ èƒ½çœ‹å‡ºæ¥åœ¨ B æ ‘çš„æœç´¢è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬æ¯”è¾ƒçš„æ¬¡æ•°å¹¶ä¸å°‘ï¼Œä½†å¦‚æœæŠŠæ•°æ®è¯»å–å‡ºæ¥ç„¶ååœ¨å†…å­˜ä¸­è¿›è¡Œæ¯” è¾ƒï¼Œè¿™ä¸ªæ—¶é—´å°±æ˜¯å¯ä»¥å¿½ç•¥ä¸è®¡çš„ã€‚è€Œè¯»å–ç£ç›˜å—æœ¬èº«éœ€è¦è¿›è¡Œ I&#x2F;O æ“ä½œï¼Œæ¶ˆè€—çš„æ—¶é—´æ¯”åœ¨å†…å­˜ä¸­è¿›è¡Œ æ¯”è¾ƒæ‰€éœ€è¦çš„æ—¶é—´è¦å¤šï¼Œæ˜¯æ•°æ®æŸ¥æ‰¾ç”¨æ—¶çš„é‡è¦å› ç´ ã€‚ B æ ‘ç›¸æ¯”äºå¹³è¡¡äºŒå‰æ ‘æ¥è¯´ç£ç›˜ I&#x2F;O æ“ä½œè¦å°‘ ï¼Œ åœ¨æ•°æ®æŸ¥è¯¢ä¸­æ¯”å¹³è¡¡äºŒå‰æ ‘æ•ˆç‡è¦é«˜ã€‚æ‰€ä»¥ åªè¦æ ‘çš„é«˜åº¦è¶³å¤Ÿä½ï¼ŒIOæ¬¡æ•°è¶³å¤Ÿå°‘ï¼Œå°±å¯ä»¥æé«˜æŸ¥è¯¢æ€§èƒ½ ã€‚</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220617170454023.png" class=""><p><strong>å†ä¸¾ä¾‹1ï¼š</strong></p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220617170526488.png" class=""><h3 id="6-6-B-Tree"><a href="#6-6-B-Tree" class="headerlink" title="6.6 B+Tree"></a>6.6 B+Tree</h3><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220617170628394.png" class=""><ul><li>MySQLå®˜ç½‘è¯´æ˜ï¼š</li></ul><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220617170710329.png" class=""><p><strong>B+ æ ‘å’Œ B æ ‘çš„å·®å¼‚åœ¨äºä»¥ä¸‹å‡ ç‚¹ï¼š</strong></p><ol><li>æœ‰ k ä¸ªå­©å­çš„èŠ‚ç‚¹å°±æœ‰ k ä¸ªå…³é”®å­—ã€‚ä¹Ÿå°±æ˜¯å­©å­æ•°é‡ &#x3D; å…³é”®å­—æ•°ï¼Œè€Œ B æ ‘ä¸­ï¼Œå­©å­æ•°é‡ &#x3D; å…³é”®å­—æ•° +1ã€‚</li><li>éå¶å­èŠ‚ç‚¹çš„å…³é”®å­—ä¹Ÿä¼šåŒæ—¶å­˜åœ¨åœ¨å­èŠ‚ç‚¹ä¸­ï¼Œå¹¶ä¸”æ˜¯åœ¨å­èŠ‚ç‚¹ä¸­æ‰€æœ‰å…³é”®å­—çš„æœ€å¤§ï¼ˆæˆ–æœ€ å°ï¼‰ã€‚ </li><li>éå¶å­èŠ‚ç‚¹ä»…ç”¨äºç´¢å¼•ï¼Œä¸ä¿å­˜æ•°æ®è®°å½•ï¼Œè·Ÿè®°å½•æœ‰å…³çš„ä¿¡æ¯éƒ½æ”¾åœ¨å¶å­èŠ‚ç‚¹ä¸­ã€‚è€Œ B æ ‘ä¸­ï¼Œ é å¶å­èŠ‚ç‚¹æ—¢ä¿å­˜ç´¢å¼•ï¼Œä¹Ÿä¿å­˜æ•°æ®è®°å½• ã€‚ </li><li>æ‰€æœ‰å…³é”®å­—éƒ½åœ¨å¶å­èŠ‚ç‚¹å‡ºç°ï¼Œå¶å­èŠ‚ç‚¹æ„æˆä¸€ä¸ªæœ‰åºé“¾è¡¨ï¼Œè€Œä¸”å¶å­èŠ‚ç‚¹æœ¬èº«æŒ‰ç…§å…³é”®å­—çš„å¤§ å°ä»å°åˆ°å¤§é¡ºåºé“¾æ¥ã€‚</li></ol><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220617171011102.png" class=""><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220617171106671.png" class=""><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220617171131747.png" class=""><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220617171331282.png" class=""><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220617171434206.png" class=""><blockquote><p>B æ ‘å’Œ B+ æ ‘éƒ½å¯ä»¥ä½œä¸ºç´¢å¼•çš„æ•°æ®ç»“æ„ï¼Œåœ¨ MySQL ä¸­é‡‡ç”¨çš„æ˜¯ B+ æ ‘ã€‚ ä½†Bæ ‘å’ŒB+æ ‘å„æœ‰è‡ªå·±çš„åº”ç”¨åœºæ™¯ï¼Œä¸èƒ½è¯´B+æ ‘å®Œå…¨æ¯”Bæ ‘å¥½ï¼Œåä¹‹äº¦ç„¶ã€‚</p></blockquote><p><strong>æ€è€ƒé¢˜ï¼šä¸ºäº†å‡å°‘IOï¼Œç´¢å¼•æ ‘ä¼šä¸€æ¬¡æ€§åŠ è½½å—ï¼Ÿ</strong></p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220617171614460.png" class=""><p><strong>æ€è€ƒé¢˜ï¼šB+æ ‘çš„å­˜å‚¨èƒ½åŠ›å¦‚ä½•ï¼Ÿä¸ºä½•è¯´ä¸€èˆ¬æŸ¥æ‰¾è¡Œè®°å½•ï¼Œæœ€å¤šåªéœ€1~3æ¬¡ç£ç›˜IO</strong></p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220617172426725.png" class=""><p><strong>æ€è€ƒé¢˜ï¼šä¸ºä»€ä¹ˆè¯´B+æ ‘æ¯”B-æ ‘æ›´é€‚åˆå®é™…åº”ç”¨ä¸­æ“ä½œç³»ç»Ÿçš„æ–‡ä»¶ç´¢å¼•å’Œæ•°æ®åº“ç´¢å¼•ï¼Ÿ</strong></p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220617175142810.png" class=""><p><strong>æ€è€ƒé¢˜ï¼šHash ç´¢å¼•ä¸ B+ æ ‘ç´¢å¼•çš„åŒºåˆ«</strong></p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220617175230327.png" class=""><p><strong>æ€è€ƒé¢˜ï¼šHash ç´¢å¼•ä¸ B+ æ ‘ç´¢å¼•æ˜¯åœ¨å»ºç´¢å¼•çš„æ—¶å€™æ‰‹åŠ¨æŒ‡å®šçš„å—ï¼Ÿ</strong></p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220617175309115.png" class=""><h3 id="6-7-Ræ ‘"><a href="#6-7-Ræ ‘" class="headerlink" title="6.7 Ræ ‘"></a>6.7 Ræ ‘</h3><p>R-Treeåœ¨MySQLå¾ˆå°‘ä½¿ç”¨ï¼Œä»…æ”¯æŒ geometryæ•°æ®ç±»å‹ ï¼Œæ”¯æŒè¯¥ç±»å‹çš„å­˜å‚¨å¼•æ“åªæœ‰myisamã€bdbã€ innodbã€ndbã€archiveå‡ ç§ã€‚ä¸¾ä¸ªRæ ‘åœ¨ç°å®é¢†åŸŸä¸­èƒ½å¤Ÿè§£å†³çš„ä¾‹å­ï¼šæŸ¥æ‰¾20è‹±é‡Œä»¥å†…æ‰€æœ‰çš„é¤å…ã€‚å¦‚æœ æ²¡æœ‰Ræ ‘ä½ ä¼šæ€ä¹ˆè§£å†³ï¼Ÿä¸€èˆ¬æƒ…å†µä¸‹æˆ‘ä»¬ä¼šæŠŠé¤å…çš„åæ ‡(x,y)åˆ†ä¸ºä¸¤ä¸ªå­—æ®µå­˜æ”¾åœ¨æ•°æ®åº“ä¸­ï¼Œä¸€ä¸ªå­—æ®µè®° å½•ç»åº¦ï¼Œå¦ä¸€ä¸ªå­—æ®µè®°å½•çº¬åº¦ã€‚è¿™æ ·çš„è¯æˆ‘ä»¬å°±éœ€è¦éå†æ‰€æœ‰çš„é¤å…è·å–å…¶ä½ç½®ä¿¡æ¯ï¼Œç„¶åè®¡ç®—æ˜¯å¦æ»¡ è¶³è¦æ±‚ã€‚å¦‚æœä¸€ä¸ªåœ°åŒºæœ‰100å®¶é¤å…çš„è¯ï¼Œæˆ‘ä»¬å°±è¦è¿›è¡Œ100æ¬¡ä½ç½®è®¡ç®—æ“ä½œäº†ï¼Œå¦‚æœåº”ç”¨åˆ°è°·æ­Œã€ç™¾åº¦ åœ°å›¾è¿™ç§è¶…å¤§æ•°æ®åº“ä¸­ï¼Œè¿™ç§æ–¹æ³•ä¾¿å¿…å®šä¸å¯è¡Œäº†ã€‚Ræ ‘å°±å¾ˆå¥½çš„ è§£å†³äº†è¿™ç§é«˜ç»´ç©ºé—´æœç´¢é—®é¢˜ ã€‚å®ƒæŠŠB æ ‘çš„æ€æƒ³å¾ˆå¥½çš„æ‰©å±•åˆ°äº†å¤šç»´ç©ºé—´ï¼Œé‡‡ç”¨äº†Bæ ‘åˆ†å‰²ç©ºé—´çš„æ€æƒ³ï¼Œå¹¶åœ¨æ·»åŠ ã€åˆ é™¤æ“ä½œæ—¶é‡‡ç”¨åˆå¹¶ã€åˆ†è§£ ç»“ç‚¹çš„æ–¹æ³•ï¼Œä¿è¯æ ‘çš„å¹³è¡¡æ€§ã€‚å› æ­¤ï¼ŒRæ ‘å°±æ˜¯ä¸€æ£µç”¨æ¥ å­˜å‚¨é«˜ç»´æ•°æ®çš„å¹³è¡¡æ ‘ ã€‚ç›¸å¯¹äºB-Treeï¼ŒR-Tree çš„ä¼˜åŠ¿åœ¨äºèŒƒå›´æŸ¥æ‰¾ã€‚</p><table><thead><tr><th>ç´¢å¼• &#x2F; å­˜å‚¨å¼•æ“</th><th>MyISAM</th><th>InnoDB</th><th>Memory</th></tr></thead><tbody><tr><td>R-Treeç´¢å¼•</td><td>æ”¯æŒ</td><td>æ”¯æŒ</td><td>ä¸æ”¯æŒ</td></tr></tbody></table><h3 id="6-8-å°ç»“"><a href="#6-8-å°ç»“" class="headerlink" title="6.8 å°ç»“"></a>6.8 å°ç»“</h3><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220617175440527.png" class=""><h3 id="é™„å½•ï¼šç®—æ³•çš„æ—¶é—´å¤æ‚åº¦"><a href="#é™„å½•ï¼šç®—æ³•çš„æ—¶é—´å¤æ‚åº¦" class="headerlink" title="é™„å½•ï¼šç®—æ³•çš„æ—¶é—´å¤æ‚åº¦"></a>é™„å½•ï¼šç®—æ³•çš„æ—¶é—´å¤æ‚åº¦</h3><p>åŒä¸€é—®é¢˜å¯ç”¨ä¸åŒç®—æ³•è§£å†³ï¼Œè€Œä¸€ä¸ªç®—æ³•çš„è´¨é‡ä¼˜åŠ£å°†å½±å“åˆ°ç®—æ³•ä¹ƒè‡³ç¨‹åºçš„æ•ˆç‡ã€‚ç®—æ³•åˆ†æçš„ç›®çš„åœ¨ äºé€‰æ‹©åˆé€‚ç®—æ³•å’Œæ”¹è¿›ç®—æ³•ã€‚</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220617175516191.png" class=""><h1 id="ç¬¬7ç« -InnoDBæ•°æ®å­˜å‚¨ç»“æ„"><a href="#ç¬¬7ç« -InnoDBæ•°æ®å­˜å‚¨ç»“æ„" class="headerlink" title="ç¬¬7ç« _InnoDBæ•°æ®å­˜å‚¨ç»“æ„"></a>ç¬¬7ç« _InnoDBæ•°æ®å­˜å‚¨ç»“æ„</h1><h2 id="1-æ•°æ®åº“çš„å­˜å‚¨ç»“æ„ï¼šé¡µ"><a href="#1-æ•°æ®åº“çš„å­˜å‚¨ç»“æ„ï¼šé¡µ" class="headerlink" title="1. æ•°æ®åº“çš„å­˜å‚¨ç»“æ„ï¼šé¡µ"></a>1. æ•°æ®åº“çš„å­˜å‚¨ç»“æ„ï¼šé¡µ</h2><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220617175755324.png" class=""><h3 id="1-1-ç£ç›˜ä¸å†…å­˜äº¤äº’åŸºæœ¬å•ä½ï¼šé¡µ"><a href="#1-1-ç£ç›˜ä¸å†…å­˜äº¤äº’åŸºæœ¬å•ä½ï¼šé¡µ" class="headerlink" title="1.1 ç£ç›˜ä¸å†…å­˜äº¤äº’åŸºæœ¬å•ä½ï¼šé¡µ"></a>1.1 ç£ç›˜ä¸å†…å­˜äº¤äº’åŸºæœ¬å•ä½ï¼šé¡µ</h3><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220617193033971.png" class=""><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220617193939742.png" class=""><h3 id="1-2-é¡µç»“æ„æ¦‚è¿°"><a href="#1-2-é¡µç»“æ„æ¦‚è¿°" class="headerlink" title="1.2 é¡µç»“æ„æ¦‚è¿°"></a>1.2 é¡µç»“æ„æ¦‚è¿°</h3><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220617193218557.png" class=""><h3 id="1-3-é¡µçš„å¤§å°"><a href="#1-3-é¡µçš„å¤§å°" class="headerlink" title="1.3 é¡µçš„å¤§å°"></a>1.3 é¡µçš„å¤§å°</h3><p>ä¸åŒçš„æ•°æ®åº“ç®¡ç†ç³»ç»Ÿï¼ˆç®€ç§°DBMSï¼‰çš„é¡µå¤§å°ä¸åŒã€‚æ¯”å¦‚åœ¨ MySQL çš„ InnoDB å­˜å‚¨å¼•æ“ä¸­ï¼Œé»˜è®¤é¡µçš„å¤§å°æ˜¯ <code>16KB</code>ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸‹é¢çš„å‘½ä»¤æ¥è¿›è¡ŒæŸ¥çœ‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show variables like &#x27;%innodb_page_size%&#x27;</span><br></pre></td></tr></table></figure><p>SQL Server ä¸­é¡µçš„å¤§å°ä¸º <code>8KB</code>ï¼Œè€Œåœ¨ Oracle ä¸­æˆ‘ä»¬ç”¨æœ¯è¯­ â€œ<code>å—</code>â€œ ï¼ˆBlockï¼‰æ¥è¡¨ç¤º â€œé¡µâ€ï¼ŒOracle æ”¯æŒçš„å¿«å¤§å°ä¸º2KB, 4KB, 8KB, 16KB, 32KB å’Œ 64KBã€‚</p><h3 id="1-4-é¡µçš„ä¸Šå±‚ç»“æ„"><a href="#1-4-é¡µçš„ä¸Šå±‚ç»“æ„" class="headerlink" title="1.4 é¡µçš„ä¸Šå±‚ç»“æ„"></a>1.4 é¡µçš„ä¸Šå±‚ç»“æ„</h3><p>å¦å¤–åœ¨æ•°æ®åº“ä¸­ï¼Œè¿˜å­˜åœ¨ç€åŒºï¼ˆExtentï¼‰ã€æ®µï¼ˆSegmentï¼‰å’Œè¡¨ç©ºé—´ï¼ˆTablespaceï¼‰çš„æ¦‚å¿µã€‚è¡Œã€é¡µã€åŒºã€æ®µã€è¡¨ç©ºé—´çš„å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220617194256988.png" class=""><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220617194529699.png" class=""><h2 id="2-é¡µçš„å†…éƒ¨ç»“æ„"><a href="#2-é¡µçš„å†…éƒ¨ç»“æ„" class="headerlink" title="2. é¡µçš„å†…éƒ¨ç»“æ„"></a>2. é¡µçš„å†…éƒ¨ç»“æ„</h2><p>é¡µå¦‚æœæŒ‰ç±»å‹åˆ’åˆ†çš„è¯ï¼Œå¸¸è§çš„æœ‰ <code>æ•°æ®é¡µï¼ˆä¿å­˜B+æ ‘èŠ‚ç‚¹ï¼‰ã€ç³»ç»Ÿè¡¨ã€Undo é¡µ å’Œ äº‹ç‰©æ•°æ®é¡µ</code> ç­‰ã€‚æ•°æ®é¡µæ˜¯æˆ‘ä»¬æœ€å¸¸ä½¿ç”¨çš„é¡µã€‚</p><p>æ•°æ®é¡µçš„ <code>16KB</code> å¤§å°çš„å­˜å‚¨ç©ºé—´è¢«åˆ’åˆ†ä¸ºä¸ƒä¸ªéƒ¨åˆ†ï¼Œåˆ†åˆ«æ˜¯æ–‡ä»¶å¤´ï¼ˆFile Headerï¼‰ã€é¡µå¤´ï¼ˆPage Headerï¼‰ã€æœ€å¤§æœ€å°è®°å½•ï¼ˆInfimum + supremumï¼‰ã€ç”¨æˆ·è®°å½•ï¼ˆUser Recordsï¼‰ã€ç©ºé—²ç©ºé—´ï¼ˆFree Spaceï¼‰ã€é¡µç›®å½•ï¼ˆPage Directoryï¼‰å’Œæ–‡ä»¶å°¾ï¼ˆFile Tailerï¼‰ã€‚</p><p>é¡µç»“æ„çš„ç¤ºæ„å›¾å¦‚ä¸‹æ‰€ç¤ºï¼š</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220617195012446.png" class=""><p>å¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220617195148164.png" class=""><p>æˆ‘ä»¬å¯ä»¥æŠŠè¿™7ä¸ªç»“æ„åˆ†ä¸º3ä¸ªéƒ¨åˆ†ã€‚</p><h3 id="ç¬¬ä¸€éƒ¨åˆ†ï¼šFile-Header-æ–‡ä»¶å¤´éƒ¨-å’Œ-File-Trailer-æ–‡ä»¶å°¾éƒ¨"><a href="#ç¬¬ä¸€éƒ¨åˆ†ï¼šFile-Header-æ–‡ä»¶å¤´éƒ¨-å’Œ-File-Trailer-æ–‡ä»¶å°¾éƒ¨" class="headerlink" title="ç¬¬ä¸€éƒ¨åˆ†ï¼šFile Header (æ–‡ä»¶å¤´éƒ¨) å’Œ File Trailer (æ–‡ä»¶å°¾éƒ¨)"></a>ç¬¬ä¸€éƒ¨åˆ†ï¼šFile Header (æ–‡ä»¶å¤´éƒ¨) å’Œ File Trailer (æ–‡ä»¶å°¾éƒ¨)</h3><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/8.jpg" class=""><h4 id="File-Headerï¼ˆæ–‡ä»¶å¤´éƒ¨ï¼‰ï¼ˆ38å­—èŠ‚ï¼‰"><a href="#File-Headerï¼ˆæ–‡ä»¶å¤´éƒ¨ï¼‰ï¼ˆ38å­—èŠ‚ï¼‰" class="headerlink" title="File Headerï¼ˆæ–‡ä»¶å¤´éƒ¨ï¼‰ï¼ˆ38å­—èŠ‚ï¼‰"></a>File Headerï¼ˆæ–‡ä»¶å¤´éƒ¨ï¼‰ï¼ˆ38å­—èŠ‚ï¼‰</h4><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/1.jpg" class=""><h5 id="FIL-PAGE-OFFSETï¼ˆ4å­—èŠ‚ï¼‰"><a href="#FIL-PAGE-OFFSETï¼ˆ4å­—èŠ‚ï¼‰" class="headerlink" title="FIL_PAGE_OFFSETï¼ˆ4å­—èŠ‚ï¼‰"></a>FIL_PAGE_OFFSETï¼ˆ4å­—èŠ‚ï¼‰</h5><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/2.jpg" class=""><h5 id="FIL-PAGE-TYPEï¼ˆ2å­—èŠ‚ï¼‰"><a href="#FIL-PAGE-TYPEï¼ˆ2å­—èŠ‚ï¼‰" class="headerlink" title="FIL_PAGE_TYPEï¼ˆ2å­—èŠ‚ï¼‰"></a>FIL_PAGE_TYPEï¼ˆ2å­—èŠ‚ï¼‰</h5><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/3.jpg" class=""><h5 id="FIL-PAGE-PREVï¼ˆ4å­—èŠ‚ï¼‰å’ŒFIL-PAGE-NEXTï¼ˆ4å­—èŠ‚ï¼‰"><a href="#FIL-PAGE-PREVï¼ˆ4å­—èŠ‚ï¼‰å’ŒFIL-PAGE-NEXTï¼ˆ4å­—èŠ‚ï¼‰" class="headerlink" title="FIL_PAGE_PREVï¼ˆ4å­—èŠ‚ï¼‰å’ŒFIL_PAGE_NEXTï¼ˆ4å­—èŠ‚ï¼‰"></a>FIL_PAGE_PREVï¼ˆ4å­—èŠ‚ï¼‰å’ŒFIL_PAGE_NEXTï¼ˆ4å­—èŠ‚ï¼‰</h5><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/4.jpg" class=""><h5 id="FIL-PAGE-SPACE-OR-CHKSUMï¼ˆ4å­—èŠ‚ï¼‰"><a href="#FIL-PAGE-SPACE-OR-CHKSUMï¼ˆ4å­—èŠ‚ï¼‰" class="headerlink" title="FIL_PAGE_SPACE_OR_CHKSUMï¼ˆ4å­—èŠ‚ï¼‰"></a>FIL_PAGE_SPACE_OR_CHKSUMï¼ˆ4å­—èŠ‚ï¼‰</h5><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/5.jpg" class=""><h5 id="FIL-PAGE-LSNï¼ˆ8å­—èŠ‚ï¼‰"><a href="#FIL-PAGE-LSNï¼ˆ8å­—èŠ‚ï¼‰" class="headerlink" title="FIL_PAGE_LSNï¼ˆ8å­—èŠ‚ï¼‰"></a>FIL_PAGE_LSNï¼ˆ8å­—èŠ‚ï¼‰</h5><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/6.jpg" class=""><h4 id="File-Trailerï¼ˆæ–‡ä»¶å°¾éƒ¨ï¼‰ï¼ˆ8å­—èŠ‚ï¼‰"><a href="#File-Trailerï¼ˆæ–‡ä»¶å°¾éƒ¨ï¼‰ï¼ˆ8å­—èŠ‚ï¼‰" class="headerlink" title="File Trailerï¼ˆæ–‡ä»¶å°¾éƒ¨ï¼‰ï¼ˆ8å­—èŠ‚ï¼‰"></a>File Trailerï¼ˆæ–‡ä»¶å°¾éƒ¨ï¼‰ï¼ˆ8å­—èŠ‚ï¼‰</h4><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/7.jpg" class=""><h3 id="ç¬¬äºŒéƒ¨åˆ†ï¼šUser-Records-ç”¨æˆ·è®°å½•-ã€æœ€å¤§æœ€å°è®°å½•ã€Free-Space-ç©ºé—²ç©ºé—´"><a href="#ç¬¬äºŒéƒ¨åˆ†ï¼šUser-Records-ç”¨æˆ·è®°å½•-ã€æœ€å¤§æœ€å°è®°å½•ã€Free-Space-ç©ºé—²ç©ºé—´" class="headerlink" title="ç¬¬äºŒéƒ¨åˆ†ï¼šUser Records (ç”¨æˆ·è®°å½•)ã€æœ€å¤§æœ€å°è®°å½•ã€Free Space (ç©ºé—²ç©ºé—´)"></a>ç¬¬äºŒéƒ¨åˆ†ï¼šUser Records (ç”¨æˆ·è®°å½•)ã€æœ€å¤§æœ€å°è®°å½•ã€Free Space (ç©ºé—²ç©ºé—´)</h3><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/9.jpg" class=""><h4 id="Free-Space-ç©ºé—²ç©ºé—´"><a href="#Free-Space-ç©ºé—²ç©ºé—´" class="headerlink" title="Free Space (ç©ºé—²ç©ºé—´)"></a>Free Space (ç©ºé—²ç©ºé—´)</h4><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/10.jpg" class=""><h4 id="User-Records-ç”¨æˆ·è®°å½•"><a href="#User-Records-ç”¨æˆ·è®°å½•" class="headerlink" title="User Records (ç”¨æˆ·è®°å½•)"></a>User Records (ç”¨æˆ·è®°å½•)</h4><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/11.jpg" class=""><h4 id="Infimum-Supremumï¼ˆæœ€å°æœ€å¤§è®°å½•ï¼‰"><a href="#Infimum-Supremumï¼ˆæœ€å°æœ€å¤§è®°å½•ï¼‰" class="headerlink" title="Infimum + Supremumï¼ˆæœ€å°æœ€å¤§è®°å½•ï¼‰"></a>Infimum + Supremumï¼ˆæœ€å°æœ€å¤§è®°å½•ï¼‰</h4><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/12.jpg" class=""><h3 id="ç¬¬ä¸‰éƒ¨åˆ†ï¼šPage-Directory-é¡µç›®å½•-å’Œ-Page-Header-é¡µé¢å¤´éƒ¨"><a href="#ç¬¬ä¸‰éƒ¨åˆ†ï¼šPage-Directory-é¡µç›®å½•-å’Œ-Page-Header-é¡µé¢å¤´éƒ¨" class="headerlink" title="ç¬¬ä¸‰éƒ¨åˆ†ï¼šPage Directory (é¡µç›®å½•) å’Œ Page Header (é¡µé¢å¤´éƒ¨)"></a>ç¬¬ä¸‰éƒ¨åˆ†ï¼šPage Directory (é¡µç›®å½•) å’Œ Page Header (é¡µé¢å¤´éƒ¨)</h3><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/13.jpg" class=""><h4 id="Page-Directoryï¼ˆé¡µç›®å½•ï¼‰"><a href="#Page-Directoryï¼ˆé¡µç›®å½•ï¼‰" class="headerlink" title="Page Directoryï¼ˆé¡µç›®å½•ï¼‰"></a>Page Directoryï¼ˆé¡µç›®å½•ï¼‰</h4><h4 id="Page-Headerï¼ˆé¡µé¢å¤´éƒ¨ï¼‰"><a href="#Page-Headerï¼ˆé¡µé¢å¤´éƒ¨ï¼‰" class="headerlink" title="Page Headerï¼ˆé¡µé¢å¤´éƒ¨ï¼‰"></a>Page Headerï¼ˆé¡µé¢å¤´éƒ¨ï¼‰</h4><h3 id="2-3-ä»æ•°æ®åº“é¡µçš„è§’åº¦çœ‹B-æ ‘å¦‚ä½•æŸ¥è¯¢"><a href="#2-3-ä»æ•°æ®åº“é¡µçš„è§’åº¦çœ‹B-æ ‘å¦‚ä½•æŸ¥è¯¢" class="headerlink" title="2.3 ä»æ•°æ®åº“é¡µçš„è§’åº¦çœ‹B+æ ‘å¦‚ä½•æŸ¥è¯¢"></a>2.3 ä»æ•°æ®åº“é¡µçš„è§’åº¦çœ‹B+æ ‘å¦‚ä½•æŸ¥è¯¢</h3><p>ä¸€é¢—B+æ ‘æŒ‰ç…§å­—èŠ‚ç±»å‹å¯ä»¥åˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼š</p><ol><li>å¶å­èŠ‚ç‚¹ï¼ŒB+ æ ‘æœ€åº•å±‚çš„èŠ‚ç‚¹ï¼ŒèŠ‚ç‚¹çš„é«˜åº¦ä¸º0ï¼Œå­˜å‚¨è¡Œè®°å½•ã€‚</li><li>éå¶å­èŠ‚ç‚¹ï¼ŒèŠ‚ç‚¹çš„é«˜åº¦å¤§äº0ï¼Œå­˜å‚¨ç´¢å¼•é”®å’Œé¡µé¢æŒ‡é’ˆï¼Œå¹¶ä¸å­˜å‚¨è¡Œè®°å½•æœ¬èº«ã€‚</li></ol><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220620221112635.png" class=""><p>å½“æˆ‘ä»¬ä»é¡µç»“æ„æ¥ç†è§£ B+ æ ‘çš„ç»“æ„çš„æ—¶å€™ï¼Œå¯ä»¥å¸®æˆ‘ä»¬ç†è§£ä¸€äº›é€šè¿‡ç´¢å¼•è¿›è¡Œæ£€ç´¢çš„åŸç†ï¼š</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220620221242561.png" class=""><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220620221442954.png" class=""><h2 id="3-InnoDBè¡Œæ ¼å¼-æˆ–è®°å½•æ ¼å¼"><a href="#3-InnoDBè¡Œæ ¼å¼-æˆ–è®°å½•æ ¼å¼" class="headerlink" title="3. InnoDBè¡Œæ ¼å¼ (æˆ–è®°å½•æ ¼å¼)"></a>3. InnoDBè¡Œæ ¼å¼ (æˆ–è®°å½•æ ¼å¼)</h2><p>è§æ–‡ä»¶InnoDBæ•°æ®åº“å­˜å‚¨ç»“æ„.mmap</p><h2 id="4-åŒºã€æ®µä¸ç¢ç‰‡åŒº"><a href="#4-åŒºã€æ®µä¸ç¢ç‰‡åŒº" class="headerlink" title="4. åŒºã€æ®µä¸ç¢ç‰‡åŒº"></a>4. åŒºã€æ®µä¸ç¢ç‰‡åŒº</h2><h3 id="4-1-ä¸ºä»€ä¹ˆè¦æœ‰åŒºï¼Ÿ"><a href="#4-1-ä¸ºä»€ä¹ˆè¦æœ‰åŒºï¼Ÿ" class="headerlink" title="4.1 ä¸ºä»€ä¹ˆè¦æœ‰åŒºï¼Ÿ"></a>4.1 ä¸ºä»€ä¹ˆè¦æœ‰åŒºï¼Ÿ</h3><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220621134226624.png" class=""><h3 id="4-2-ä¸ºä»€ä¹ˆè¦æœ‰æ®µï¼Ÿ"><a href="#4-2-ä¸ºä»€ä¹ˆè¦æœ‰æ®µï¼Ÿ" class="headerlink" title="4.2 ä¸ºä»€ä¹ˆè¦æœ‰æ®µï¼Ÿ"></a>4.2 ä¸ºä»€ä¹ˆè¦æœ‰æ®µï¼Ÿ</h3><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220621140802887.png" class=""><h3 id="4-3-ä¸ºä»€ä¹ˆè¦æœ‰ç¢ç‰‡åŒºï¼Ÿ"><a href="#4-3-ä¸ºä»€ä¹ˆè¦æœ‰ç¢ç‰‡åŒºï¼Ÿ" class="headerlink" title="4.3 ä¸ºä»€ä¹ˆè¦æœ‰ç¢ç‰‡åŒºï¼Ÿ"></a>4.3 ä¸ºä»€ä¹ˆè¦æœ‰ç¢ç‰‡åŒºï¼Ÿ</h3><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220621141225223.png" class=""><h3 id="4-4-åŒºçš„åˆ†ç±»"><a href="#4-4-åŒºçš„åˆ†ç±»" class="headerlink" title="4.4 åŒºçš„åˆ†ç±»"></a>4.4 åŒºçš„åˆ†ç±»</h3><p>åŒºå¤§ä½“ä¸Šå¯ä»¥åˆ†ä¸º4ç§ç±»å‹ï¼š</p><ul><li>ç©ºé—²çš„åŒº (FREE) : ç°åœ¨è¿˜æ²¡æœ‰ç”¨åˆ°è¿™ä¸ªåŒºä¸­çš„ä»»ä½•é¡µé¢ã€‚</li><li>æœ‰å‰©ä½™ç©ºé—´çš„ç¢ç‰‡åŒº (FREE_FRAG)ï¼šè¡¨ç¤ºç¢ç‰‡åŒºä¸­è¿˜æœ‰å¯ç”¨çš„é¡µé¢ã€‚</li><li>æ²¡æœ‰å‰©ä½™ç©ºé—´çš„ç¢ç‰‡åŒº (FULL_FRAG)ï¼šè¡¨ç¤ºç¢ç‰‡åŒºä¸­çš„æ‰€æœ‰é¡µé¢éƒ½è¢«ä½¿ç”¨ï¼Œæ²¡æœ‰ç©ºé—²é¡µé¢ã€‚</li><li>é™„å±äºæŸä¸ªæ®µçš„åŒº (FSEG)ï¼šæ¯ä¸€ä¸ªç´¢å¼•éƒ½å¯ä»¥åˆ†ä¸ºå¶å­èŠ‚ç‚¹æ®µå’Œéå¶å­èŠ‚ç‚¹æ®µã€‚</li></ul><p>å¤„äºFREEã€FREE_FRAG ä»¥åŠ FULL_FRAG è¿™ä¸‰ç§çŠ¶æ€çš„åŒºéƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œç›´å±äºè¡¨ç©ºé—´ã€‚è€Œå¤„äº FSEG çŠ¶æ€çš„åŒºæ˜¯é™„å±äºæŸä¸ªæ®µçš„ã€‚</p><blockquote><p>å¦‚æœæŠŠè¡¨ç©ºé—´æ¯”ä½œæ˜¯ä¸€ä¸ªé›†å›¢å†›ï¼Œæ®µå°±ç›¸å½“äºå¸ˆï¼ŒåŒºå°±ç›¸å½“äºå›¢ã€‚ä¸€èˆ¬çš„å›¢éƒ½æ˜¯éš¶å±äºæŸä¸ªå¸ˆçš„ï¼Œå°±åƒæ˜¯å¤„äº FSEG çš„åŒºå…¨éƒ¨éš¶å±äºæŸä¸ªæ®µï¼Œè€Œå¤„äº FREEã€FREE_FRAG ä»¥åŠ FULL_FRAG è¿™ä¸‰ç§çŠ¶æ€çš„åŒºå´ç›´æ¥éš¶å±äºè¡¨ç©ºé—´ï¼Œå°±åƒç‹¬ç«‹å›¢ç›´æ¥å¬å‘½äºå†›éƒ¨ä¸€æ ·ã€‚</p></blockquote><h2 id="5-è¡¨ç©ºé—´"><a href="#5-è¡¨ç©ºé—´" class="headerlink" title="5. è¡¨ç©ºé—´"></a>5. è¡¨ç©ºé—´</h2><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220621142910222.png" class=""><h3 id="5-1-ç‹¬ç«‹è¡¨ç©ºé—´"><a href="#5-1-ç‹¬ç«‹è¡¨ç©ºé—´" class="headerlink" title="5.1 ç‹¬ç«‹è¡¨ç©ºé—´"></a>5.1 ç‹¬ç«‹è¡¨ç©ºé—´</h3><p>ç‹¬ç«‹è¡¨ç©ºé—´ï¼Œå³æ¯å¼ è¡¨æœ‰ä¸€ä¸ªç‹¬ç«‹çš„è¡¨ç©ºé—´ï¼Œä¹Ÿå°±æ˜¯æ•°æ®å’Œç´¢å¼•ä¿¡æ¯éƒ½ä¼šä¿å­˜åœ¨è‡ªå·±çš„è¡¨ç©ºé—´ä¸­ã€‚ç‹¬ç«‹çš„è¡¨ç©ºé—´ (å³ï¼šå•è¡¨) å¯ä»¥åœ¨ä¸åŒçš„æ•°æ®åº“ä¹‹é—´è¿›è¡Œ <code>è¿ç§»</code>ã€‚</p><p>ç©ºé—´å¯ä»¥å›æ”¶ (DROP TABLE æ“ä½œå¯è‡ªåŠ¨å›æ”¶è¡¨ç©ºé—´ï¼›å…¶ä»–æƒ…å†µï¼Œè¡¨ç©ºé—´ä¸èƒ½è‡ªå·±å›æ”¶) ã€‚å¦‚æœå¯¹äºç»Ÿè®¡åˆ†ææˆ–æ˜¯æ—¥å¿—è¡¨ï¼Œåˆ é™¤å¤§é‡æ•°æ®åå¯ä»¥é€šè¿‡ï¼šalter table TableName engine&#x3D;innodb; å›æ”¶ä¸ç”¨çš„ç©ºé—´ã€‚å¯¹äºä½¿ç”¨ç‹¬ç«‹è¡¨ç©ºé—´çš„è¡¨ï¼Œä¸ç®¡æ€ä¹ˆåˆ é™¤ï¼Œè¡¨ç©ºé—´çš„ç¢ç‰‡ä¸ä¼šå¤ªä¸¥é‡çš„å½±å“æ€§èƒ½ï¼Œè€Œä¸”è¿˜æœ‰æœºä¼šå¤„ç†ã€‚</p><p><strong>ç‹¬ç«‹è¡¨ç©ºé—´ç»“æ„</strong></p><p>ç‹¬ç«‹è¡¨ç©ºé—´ç”±æ®µã€åŒºã€é¡µç»„æˆã€‚</p><p><strong>çœŸå®è¡¨ç©ºé—´å¯¹åº”çš„æ–‡ä»¶å¤§å°</strong></p><p>æˆ‘ä»¬åˆ°æ•°æ®ç›®å½•é‡Œçœ‹ï¼Œä¼šå‘ç°ä¸€ä¸ªæ–°å»ºçš„è¡¨å¯¹åº”çš„ .ibd æ–‡ä»¶åªå ç”¨äº† 96Kï¼Œæ‰6ä¸ªé¡µé¢å¤§å° (MySQL5.7ä¸­)ï¼Œè¿™æ˜¯å› ä¸ºä¸€å¼€å§‹è¡¨ç©ºé—´å ç”¨çš„ç©ºé—´å¾ˆå°ï¼Œå› ä¸ºè¡¨é‡Œè¾¹éƒ½æ²¡æœ‰æ•°æ®ã€‚ä¸è¿‡åˆ«å¿˜äº†è¿™äº› .ibd æ–‡ä»¶æ˜¯è‡ªæ‰©å±•çš„ï¼Œéšç€è¡¨ä¸­æ•°æ®çš„å¢å¤šï¼Œè¡¨ç©ºé—´å¯¹åº”çš„æ–‡ä»¶ä¹Ÿé€æ¸å¢å¤§ã€‚</p><p><strong>æŸ¥çœ‹ InnoDB çš„è¡¨ç©ºé—´ç±»å‹ï¼š</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show variables like &#x27;innodb_file_per_table&#x27;</span><br></pre></td></tr></table></figure><p>ä½ èƒ½çœ‹åˆ° innodb_file_per_table&#x3D;ON, è¿™å°±æ„å‘³ç€æ¯å¼ è¡¨éƒ½ä¼šå•è¯ä¿å­˜ä¸€ä¸ª .ibd æ–‡ä»¶ã€‚</p><h3 id="5-2-ç³»ç»Ÿè¡¨ç©ºé—´"><a href="#5-2-ç³»ç»Ÿè¡¨ç©ºé—´" class="headerlink" title="5.2 ç³»ç»Ÿè¡¨ç©ºé—´"></a>5.2 ç³»ç»Ÿè¡¨ç©ºé—´</h3><p>ç³»ç»Ÿè¡¨ç©ºé—´çš„ç»“æ„å’Œç‹¬ç«‹è¡¨ç©ºé—´åŸºæœ¬ç±»ä¼¼ï¼Œåªä¸è¿‡ç”±äºæ•´ä¸ªMySQLè¿›ç¨‹åªæœ‰ä¸€ä¸ªç³»ç»Ÿè¡¨ç©ºé—´ï¼Œåœ¨ç³»ç»Ÿè¡¨ç©ºé—´ä¸­ä¼šé¢å¤–è®°å½•ä¸€äº›æœ‰å…³æ•´ä¸ªç³»ç»Ÿä¿¡æ¯çš„é¡µé¢ï¼Œè¿™éƒ¨åˆ†æ˜¯ç‹¬ç«‹è¡¨ç©ºé—´ä¸­æ²¡æœ‰çš„ã€‚</p><p><strong>InnoDBæ•°æ®å­—å…¸</strong></p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220621150648770.png" class=""><p>åˆ é™¤è¿™äº›æ•°æ®å¹¶ä¸æ˜¯æˆ‘ä»¬ä½¿ç”¨ INSERT è¯­å¥æ’å…¥çš„ç”¨æˆ·æ•°æ®ï¼Œå®é™…ä¸Šæ˜¯ä¸ºäº†æ›´å¥½çš„ç®¡ç†æˆ‘ä»¬è¿™äº›ç”¨æˆ·æ•°æ®è€Œä¸å¾—ä»¥å¼•å…¥çš„ä¸€äº›é¢å¤–æ•°æ®ï¼Œè¿™äº›æ•°æ®é¡µç§°ä¸º å…ƒæ•°æ®ã€‚InnoDB å­˜å‚¨å¼•æ“ç‰¹æ„å®šä¹‰äº†ä¸€äº›åˆ—çš„ å†…éƒ¨ç³»ç»Ÿè¡¨ (internal system table) æ¥è®°å½•è¿™äº›å…ƒæ•°æ®ï¼š</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220621150924922.png" class=""><p>è¿™äº›ç³»ç»Ÿè¡¨ä¹Ÿç§°ä¸º <code>æ•°æ®å­—å…¸</code>ï¼Œå®ƒä»¬éƒ½æ˜¯ä»¥ B+ æ ‘çš„å½¢å¼ä¿å­˜åœ¨ç³»ç»Ÿè¡¨ç©ºé—´çš„æŸä¸ªé¡µé¢ä¸­ã€‚å…¶ä¸­ <code>SYS_TABLESã€SYS_COLUMNSã€SYS_INDEXESã€SYS_FIELDS</code> è¿™å››ä¸ªè¡¨å°¤å…¶é‡è¦ï¼Œç§°ä¹‹ä¸ºåŸºæœ¬ç³»ç»Ÿè¡¨ (basic system tables) ï¼Œæˆ‘ä»¬å…ˆçœ‹çœ‹è¿™4ä¸ªè¡¨çš„ç»“æ„ï¼š</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220621151139759.png" class=""><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220621151158361.png" class=""><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220621151215274.png" class=""><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220621151238157.png" class=""><p>æ³¨æ„ï¼šç”¨æˆ·ä¸èƒ½ç›´æ¥è®¿é—® InnoDB çš„è¿™äº›å†…éƒ¨ç³»ç»Ÿè¡¨ï¼Œé™¤éä½ ç›´æ¥å»è§£æç³»ç»Ÿè¡¨ç©ºé—´å¯¹åº”æ–‡ä»¶ç³»ç»Ÿä¸Šçš„æ–‡ä»¶ã€‚ä¸è¿‡è€ƒè™‘åˆ°æŸ¥çœ‹è¿™äº›è¡¨çš„å†…å®¹å¯èƒ½æœ‰åŠ©äºå¤§å®¶åˆ†æé—®é¢˜ï¼Œæ‰€ä»¥åœ¨ç³»ç»Ÿæ•°æ®åº“ <code>information_schema</code> ä¸­æä¾›äº†ä¸€äº›ä»¥ <code>innodb_sys</code> å¼€å¤´çš„è¡¨:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">USE information_schema;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHOW TABLES LIKE &#x27;innodb_sys%&#x27;;</span><br></pre></td></tr></table></figure><p>åœ¨ <code>information_scheme</code> æ•°æ®åº“ä¸­çš„è¿™äº›ä»¥ <code>INNODB_SYS</code> å¼€å¤´çš„è¡¨å¹¶ä¸æ˜¯çœŸæ­£çš„å†…éƒ¨ç³»ç»Ÿè¡¨ (å†…éƒ¨ç³»ç»Ÿè¡¨å°±æ˜¯æˆ‘ä»¬ä¸Šè¾¹ä»¥ <code>SYS</code> å¼€å¤´çš„é‚£äº›è¡¨)ï¼Œè€Œæ˜¯åœ¨å­˜å‚¨å¼•æ“å¯åŠ¨æ—¶è¯»å–è¿™äº›ä»¥ <code>SYS</code> å¼€å¤´çš„ç³»ç»Ÿè¡¨ï¼Œç„¶åå¡«å……åˆ°è¿™äº›ä»¥ <code>INNODB_SYS</code> å¼€å¤´çš„è¡¨ä¸­ã€‚ä»¥ <code>INNODB_SYS</code> å¼€å¤´çš„è¡¨å’Œä»¥ <code>SYS</code> å¼€å¤´çš„è¡¨ä¸­çš„å­—æ®µå¹¶ä¸å®Œå…¨ä¸€æ ·ï¼Œä½†ä»…ä¾›å¤§å®¶å‚è€ƒå·²ç»è¶³çŸ£ã€‚</p><h2 id="é™„å½•ï¼šæ•°æ®é¡µåŠ è½½çš„ä¸‰ç§æ–¹å¼"><a href="#é™„å½•ï¼šæ•°æ®é¡µåŠ è½½çš„ä¸‰ç§æ–¹å¼" class="headerlink" title="é™„å½•ï¼šæ•°æ®é¡µåŠ è½½çš„ä¸‰ç§æ–¹å¼"></a>é™„å½•ï¼šæ•°æ®é¡µåŠ è½½çš„ä¸‰ç§æ–¹å¼</h2><p>InnoDBä»ç£ç›˜ä¸­è¯»å–æ•°æ® <code>æœ€å°å•ä½</code> æ˜¯æ•°æ®é¡µã€‚è€Œä½ æƒ³å¾—åˆ°çš„ id &#x3D; xxx çš„æ•°æ®ï¼Œå°±æ˜¯è¿™ä¸ªæ•°æ®é¡µä¼—å¤šè¡Œä¸­çš„ä¸€è¡Œã€‚</p><p>å¯¹äºMySQLå­˜æ”¾çš„æ•°æ®ï¼Œé€»è¾‘æ¦‚å¿µä¸Šæˆ‘ä»¬ç§°ä¹‹ä¸ºè¡¨ï¼Œåœ¨ç£ç›˜ç­‰ç‰©ç†å±‚é¢è€Œè¨€æ˜¯æŒ‰ <code>æ•°æ®é¡µ</code> å½¢å¼è¿›è¡Œå­˜æ”¾çš„ï¼Œå½“å…¶åŠ è½½åˆ° MySQL ä¸­æˆ‘ä»¬ç§°ä¹‹ä¸º <code>ç¼“å­˜é¡µ</code>ã€‚</p><p>å¦‚æœç¼“å†²æ± æ²¡æœ‰è¯¥é¡µæ•°æ®ï¼Œé‚£ä¹ˆç¼“å†²æ± æœ‰ä»¥ä¸‹ä¸‰ç§è¯»å–æ•°æ®çš„æ–¹å¼ï¼Œæ¯ç§æ–¹å¼çš„è¯»å–é€Ÿç‡æ˜¯ä¸åŒçš„ï¼š</p><p><strong>1. å†…å­˜è¯»å–</strong></p><p>å¦‚æœè¯¥æ•°æ®å­˜åœ¨äºå†…å­˜ä¸­ï¼ŒåŸºæœ¬ä¸Šæ‰§è¡Œæ—¶é—´åœ¨ 1ms å·¦å³ï¼Œæ•ˆç‡è¿˜æ˜¯å¾ˆé«˜çš„ã€‚</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220621135638283.png" class=""><p><strong>2. éšæœºè¯»å–</strong></p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220621135719847.png" class=""><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220621135737422.png" class=""><p><strong>3. é¡ºåºè¯»å–</strong></p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220621135909197.png" class=""><h1 id="ç¬¬8ç« -ç´¢å¼•çš„åˆ›å»ºä¸è®¾è®¡åŸåˆ™"><a href="#ç¬¬8ç« -ç´¢å¼•çš„åˆ›å»ºä¸è®¾è®¡åŸåˆ™" class="headerlink" title="ç¬¬8ç« _ç´¢å¼•çš„åˆ›å»ºä¸è®¾è®¡åŸåˆ™"></a>ç¬¬8ç« _ç´¢å¼•çš„åˆ›å»ºä¸è®¾è®¡åŸåˆ™</h1><h2 id="1-ç´¢å¼•çš„å£°æ˜ä¸ä½¿ç”¨"><a href="#1-ç´¢å¼•çš„å£°æ˜ä¸ä½¿ç”¨" class="headerlink" title="1. ç´¢å¼•çš„å£°æ˜ä¸ä½¿ç”¨"></a>1. ç´¢å¼•çš„å£°æ˜ä¸ä½¿ç”¨</h2><h3 id="1-1-ç´¢å¼•çš„åˆ†ç±»"><a href="#1-1-ç´¢å¼•çš„åˆ†ç±»" class="headerlink" title="1.1 ç´¢å¼•çš„åˆ†ç±»"></a>1.1 ç´¢å¼•çš„åˆ†ç±»</h3><p>MySQLçš„ç´¢å¼•åŒ…æ‹¬æ™®é€šç´¢å¼•ã€å”¯ä¸€æ€§ç´¢å¼•ã€å…¨æ–‡ç´¢å¼•ã€å•åˆ—ç´¢å¼•ã€å¤šåˆ—ç´¢å¼•å’Œç©ºé—´ç´¢å¼•ç­‰ã€‚</p><p>ä» åŠŸèƒ½é€»è¾‘ ä¸Šè¯´ï¼Œç´¢å¼•ä¸»è¦æœ‰ 4 ç§ï¼Œåˆ†åˆ«æ˜¯æ™®é€šç´¢å¼•ã€å”¯ä¸€ç´¢å¼•ã€ä¸»é”®ç´¢å¼•ã€å…¨æ–‡ç´¢å¼•ã€‚ </p><p>æŒ‰ç…§ ç‰©ç†å®ç°æ–¹å¼ ï¼Œç´¢å¼•å¯ä»¥åˆ†ä¸º 2 ç§ï¼šèšç°‡ç´¢å¼•å’Œéèšç°‡ç´¢å¼•ã€‚ </p><p>æŒ‰ç…§ ä½œç”¨å­—æ®µä¸ªæ•° è¿›è¡Œåˆ’åˆ†ï¼Œåˆ†æˆå•åˆ—ç´¢å¼•å’Œè”åˆç´¢å¼•ã€‚</p><p><strong>1. æ™®é€šç´¢å¼•</strong></p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220621202759576.png" class=""><p><strong>2. å”¯ä¸€æ€§ç´¢å¼•</strong></p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220621202850551.png" class=""><p><strong>3. ä¸»é”®ç´¢å¼•</strong></p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220621203302303.png" class=""><p><strong>4. å•åˆ—ç´¢å¼•</strong></p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220621203333925.png" class=""><p><strong>5. å¤šåˆ— (ç»„åˆã€è”åˆ) ç´¢å¼•</strong></p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220621203454424.png" class=""><p><strong>6. å…¨æ–‡æ£€ç´¢</strong></p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220621203645789.png" class=""><p><strong>7. è¡¥å……ï¼šç©ºé—´ç´¢å¼•</strong></p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220621203736098.png" class=""><p>**å°ç»“ï¼šä¸åŒçš„å­˜å‚¨å¼•æ“æ”¯æŒçš„ç´¢å¼•ç±»å‹ä¹Ÿä¸ä¸€æ · **</p><p>InnoDB ï¼šæ”¯æŒ B-treeã€Full-text ç­‰ç´¢å¼•ï¼Œä¸æ”¯æŒ Hash ç´¢å¼•ï¼› </p><p>MyISAM ï¼š æ”¯æŒ B-treeã€Full-text ç­‰ç´¢å¼•ï¼Œä¸æ”¯æŒ Hash ç´¢å¼•ï¼› </p><p>Memory ï¼šæ”¯æŒ B-treeã€Hash ç­‰ ç´¢å¼•ï¼Œä¸æ”¯æŒ Full-text ç´¢å¼•ï¼›</p><p>NDB ï¼šæ”¯æŒ Hash ç´¢å¼•ï¼Œä¸æ”¯æŒ B-treeã€Full-text ç­‰ç´¢å¼•ï¼› </p><p>Archive ï¼šä¸æ”¯ æŒ B-treeã€Hashã€Full-text ç­‰ç´¢å¼•ï¼›</p><h3 id="1-2-åˆ›å»ºç´¢å¼•"><a href="#1-2-åˆ›å»ºç´¢å¼•" class="headerlink" title="1.2 åˆ›å»ºç´¢å¼•"></a>1.2 åˆ›å»ºç´¢å¼•</h3><p>MySQLæ”¯æŒå¤šç§æ–¹æ³•åœ¨å•ä¸ªæˆ–å¤šä¸ªåˆ—ä¸Šåˆ›å»ºç´¢å¼•ï¼šåœ¨åˆ›å»ºè¡¨çš„å®šä¹‰è¯­å¥ CREATE TABLE ä¸­æŒ‡å®šç´¢å¼•åˆ—ï¼Œä½¿ç”¨ ALTER TABLE è¯­å¥åœ¨å­˜åœ¨çš„è¡¨ä¸Šåˆ›å»ºç´¢å¼•ï¼Œæˆ–è€…ä½¿ç”¨ CREATE INDEX è¯­å¥åœ¨å·²å­˜åœ¨çš„è¡¨ä¸Šæ·»åŠ ç´¢å¼•ã€‚</p><h4 id="1-åˆ›å»ºè¡¨çš„æ—¶å€™åˆ›å»ºç´¢å¼•"><a href="#1-åˆ›å»ºè¡¨çš„æ—¶å€™åˆ›å»ºç´¢å¼•" class="headerlink" title="1. åˆ›å»ºè¡¨çš„æ—¶å€™åˆ›å»ºç´¢å¼•"></a>1. åˆ›å»ºè¡¨çš„æ—¶å€™åˆ›å»ºç´¢å¼•</h4><p>ä½¿ç”¨CREATE TABLEåˆ›å»ºè¡¨æ—¶ï¼Œé™¤äº†å¯ä»¥å®šä¹‰åˆ—çš„æ•°æ®ç±»å‹å¤–ï¼Œè¿˜å¯ä»¥å®šä¹‰ä¸»é”®çº¦æŸã€å¤–é”®çº¦æŸæˆ–è€…å”¯ä¸€æ€§çº¦æŸï¼Œè€Œä¸è®ºåˆ›å»ºå“ªç§çº¦æŸï¼Œåœ¨å®šä¹‰çº¦æŸçš„åŒæ—¶ç›¸å½“äºåœ¨æŒ‡å®šåˆ—ä¸Šåˆ›å»ºäº†ä¸€ä¸ªç´¢å¼•ã€‚</p><p>ä¸¾ä¾‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE dept(</span><br><span class="line">dept_id INT PRIMARY KEY AUTO_INCREMENT,</span><br><span class="line">dept_name VARCHAR(20)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">CREATE TABLE emp(</span><br><span class="line">emp_id INT PRIMARY KEY AUTO_INCREMENT,</span><br><span class="line">emp_name VARCHAR(20) UNIQUE,</span><br><span class="line">dept_id INT,</span><br><span class="line">CONSTRAINT emp_dept_id_fk FOREIGN KEY(dept_id) REFERENCES dept(dept_id)</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯ï¼Œå¦‚æœæ˜¾å¼åˆ›å»ºè¡¨æ—¶åˆ›å»ºç´¢å¼•çš„è¯ï¼ŒåŸºæœ¬è¯­æ³•æ ¼å¼å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE table_name [col_name data_type]</span><br><span class="line">[UNIQUE | FULLTEXT | SPATIAL] [INDEX | KEY] [index_name] (col_name [length]) [ASC |</span><br><span class="line">DESC]</span><br></pre></td></tr></table></figure><ul><li>UNIQUE ã€ FULLTEXT å’Œ SPATIAL ä¸ºå¯é€‰å‚æ•°ï¼Œåˆ†åˆ«è¡¨ç¤ºå”¯ä¸€ç´¢å¼•ã€å…¨æ–‡ç´¢å¼•å’Œç©ºé—´ç´¢å¼•ï¼› </li><li>INDEX ä¸ KEY ä¸ºåŒä¹‰è¯ï¼Œä¸¤è€…çš„ä½œç”¨ç›¸åŒï¼Œç”¨æ¥æŒ‡å®šåˆ›å»ºç´¢å¼•ï¼› </li><li>index_name æŒ‡å®šç´¢å¼•çš„åç§°ï¼Œä¸ºå¯é€‰å‚æ•°ï¼Œå¦‚æœä¸æŒ‡å®šï¼Œé‚£ä¹ˆMySQLé»˜è®¤col_nameä¸ºç´¢å¼•åï¼› </li><li>col_name ä¸ºéœ€è¦åˆ›å»ºç´¢å¼•çš„å­—æ®µåˆ—ï¼Œè¯¥åˆ—å¿…é¡»ä»æ•°æ®è¡¨ä¸­å®šä¹‰çš„å¤šä¸ªåˆ—ä¸­é€‰æ‹©ï¼› </li><li>length ä¸ºå¯é€‰å‚æ•°ï¼Œè¡¨ç¤ºç´¢å¼•çš„é•¿åº¦ï¼Œåªæœ‰å­—ç¬¦ä¸²ç±»å‹çš„å­—æ®µæ‰èƒ½æŒ‡å®šç´¢å¼•é•¿åº¦ï¼› </li><li>ASC æˆ– DESC æŒ‡å®šå‡åºæˆ–è€…é™åºçš„ç´¢å¼•å€¼å­˜å‚¨ã€‚</li></ul><p><strong>1. æ™®é€šç´¢å¼•</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#å»ºç«‹æ™®é€šç´¢å¼•</span><br><span class="line">CREATE TABLE book(</span><br><span class="line">book_id INT ,</span><br><span class="line">book_name VARCHAR(100),</span><br><span class="line">authors VARCHAR(100),</span><br><span class="line">info VARCHAR(100) ,</span><br><span class="line">comment VARCHAR(100),</span><br><span class="line">year_publication YEAR,</span><br><span class="line">INDEX(year_publication)</span><br><span class="line">);</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#é€šè¿‡å‘½ä»¤æŸ¥çœ‹ç´¢å¼•</span><br><span class="line">SHOW CREATE TABLE book;</span><br><span class="line">SHOW INDEX FROM book;</span><br><span class="line"></span><br><span class="line">#æ€§èƒ½åˆ†æå·¥å…·ï¼šEXPLAIN</span><br><span class="line">EXPLAIN SELECT * FROM book WHERE book_name = &#x27;mysqlé«˜çº§&#x27;;</span><br></pre></td></tr></table></figure><p><strong>2. å”¯ä¸€ç´¢å¼•</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#å»ºç«‹å”¯ä¸€ç´¢å¼•</span><br><span class="line">CREATE TABLE book(</span><br><span class="line">book_id INT ,</span><br><span class="line">book_name VARCHAR(100),</span><br><span class="line">AUTHORS VARCHAR(100),</span><br><span class="line">info VARCHAR(100) ,</span><br><span class="line">COMMENT VARCHAR(100),</span><br><span class="line">year_publication YEAR,</span><br><span class="line">#å£°æ˜ç´¢å¼•</span><br><span class="line">UNIQUE INDEX uk_idx_cmt(COMMENT)</span><br><span class="line">);</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#é€šè¿‡å‘½ä»¤æŸ¥çœ‹ç´¢å¼•</span><br><span class="line">SHOW CREATE TABLE book;</span><br><span class="line">SHOW INDEX FROM book;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#å£°æ˜æœ‰å”¯ä¸€ç´¢å¼•çš„å­—æ®µï¼Œåœ¨æ·»åŠ æ•°æ®æ—¶ï¼Œè¦ä¿è¯å”¯ä¸€æ€§ï¼Œä½†æ˜¯å¯ä»¥æ·»åŠ null</span><br><span class="line"></span><br><span class="line">INSERT INTO book(book_id,book_name,COMMENT)</span><br><span class="line">VALUES(1,&#x27;Mysqlé«˜çº§&#x27;,&#x27;é€‚åˆæœ‰æ•°æ®åº“å¼€å‘ç»éªŒçš„äººå‘˜å­¦ä¹ &#x27;);</span><br><span class="line"></span><br><span class="line">INSERT INTO (book_id,book_name,COMMENT)</span><br><span class="line">VALUES(2,&#x27;Mysqlé«˜çº§&#x27;,NULL);</span><br><span class="line"></span><br><span class="line">SELECT * FROM book;</span><br></pre></td></tr></table></figure><p><strong>3. ä¸»é”®ç´¢å¼•</strong></p><p>è®¾å®šä¸ºä¸»é”®åæ•°æ®åº“ä¼šè‡ªåŠ¨å»ºç«‹ç´¢å¼•ï¼Œinnodbä¸ºèšç°‡ç´¢å¼•</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#é€šè¿‡å®šä¹‰ä¸»é”®çº¦æŸçš„æ–¹å¼å®šä¹‰ä¸»é”®ç´¢å¼•</span><br><span class="line">CREATE TABLE student (</span><br><span class="line">id INT(10) UNSIGNED AUTO_INCREMENT ,</span><br><span class="line">student_no VARCHAR(200),</span><br><span class="line">student_name VARCHAR(200),</span><br><span class="line">PRIMARY KEY(id)</span><br><span class="line">);</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#é€šè¿‡åˆ é™¤ä¸»é”®çº¦æŸçš„æ–¹å¼åˆ é™¤ä¸»é”®ç´¢å¼•</span><br><span class="line">ALTER TABLE student</span><br><span class="line">drop PRIMARY KEY;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">#ä¿®æ”¹ä¸»é”®ç´¢å¼•ï¼šå¿…é¡»å…ˆåˆ é™¤æ‰(drop)åŸç´¢å¼•ï¼Œå†æ–°å»º(add)ç´¢å¼•</span><br></pre></td></tr></table></figure><p><strong>4. å•åˆ—ç´¢å¼•</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#å»ºç«‹å•åˆ—ç´¢å¼•</span><br><span class="line">CREATE TABLE test(</span><br><span class="line">id INT NOT NULL,</span><br><span class="line">name CHAR(50) NULL,</span><br><span class="line">INDEX single_idx_name(name(20))</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>è¯¥è¯­å¥æ‰§è¡Œå®Œæ¯•ä¹‹åï¼Œä½¿ç”¨SHOW CREATE TABLEæŸ¥çœ‹è¡¨ç»“æ„ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHOW INDEX FROM test;</span><br></pre></td></tr></table></figure><p><strong>5. ç»„åˆç´¢å¼•</strong></p><p>ä¸¾ä¾‹ï¼šåˆ›å»ºè¡¨test3ï¼Œåœ¨è¡¨ä¸­çš„idã€nameå’Œageå­—æ®µä¸Šå»ºç«‹ç»„åˆç´¢å¼•ï¼ŒSQLè¯­å¥å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#å»ºç«‹ç»„åˆç´¢å¼•</span><br><span class="line">CREATE TABLE test(</span><br><span class="line">id INT(11) NOT NULL,</span><br><span class="line">name CHAR(30) NOT NULL,</span><br><span class="line">age INT(11) NOT NULL,</span><br><span class="line">info VARCHAR(255),</span><br><span class="line">INDEX multi_idx(id,name,age)</span><br><span class="line">);</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#ä½¿ç”¨SHOW INDEX æŸ¥çœ‹</span><br><span class="line">SHOW INDEX FROM test;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#æŸ¥è¯¢idå’Œnameå­—æ®µï¼Œä½¿ç”¨EXPLAINè¯­å¥æŸ¥çœ‹ç´¢å¼•çš„ä½¿ç”¨æƒ…å†µ,</span><br><span class="line">#å¯ä»¥çœ‹åˆ°ï¼ŒæŸ¥è¯¢idå’Œnameå­—æ®µæ—¶ï¼Œä½¿ç”¨äº†åç§°ä¸ºMultiIdxçš„ç´¢å¼•ï¼Œå¦‚æœæŸ¥è¯¢ (name, age) ç»„åˆæˆ–è€…å•ç‹¬æŸ¥è¯¢nameå’Œageå­—æ®µï¼Œä¼šå‘ç°ç»“æœä¸­possible_keyså’Œkeyå€¼ä¸ºNULL, å¹¶æ²¡æœ‰ä½¿ç”¨åœ¨t3è¡¨ä¸­åˆ›å»ºçš„ç´¢å¼•è¿›è¡ŒæŸ¥è¯¢ã€‚</span><br><span class="line">EXPLAIN SELECT * FROM test WHERE id=1 AND name=&#x27;songhongkang&#x27;;</span><br></pre></td></tr></table></figure><p><strong>6. å…¨æ–‡ç´¢å¼•</strong></p><p>FULLTEXTå…¨æ–‡ç´¢å¼•å¯ä»¥ç”¨äºå…¨æ–‡æ£€ç´¢ï¼Œå¹¶ä¸”åªä¸º <code>CHAR</code> ã€<code>VARCHAR</code> å’Œ <code>TEXT</code> åˆ—åˆ›å»ºç´¢å¼•ã€‚ç´¢å¼•æ€»æ˜¯å¯¹æ•´ä¸ªåˆ—è¿›è¡Œï¼Œä¸æ”¯æŒå±€éƒ¨ (å‰ç¼€) ç´¢å¼•ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#åˆ›å»ºè¡¨testï¼Œåœ¨è¡¨ä¸­çš„infoå­—æ®µä¸Šå»ºç«‹å…¨æ–‡ç´¢å¼•</span><br><span class="line">CREATE TABLE test(</span><br><span class="line">id INT NOT NULL,</span><br><span class="line">name CHAR(30) NOT NULL,</span><br><span class="line">age INT NOT NULL,</span><br><span class="line">info VARCHAR(255),</span><br><span class="line">FULLTEXT INDEX futxt_idx_info(info)</span><br><span class="line">) ENGINE=MyISAM;</span><br></pre></td></tr></table></figure><blockquote><p>åœ¨MySQL5.7åŠä¹‹åç‰ˆæœ¬ä¸­å¯ä»¥ä¸æŒ‡å®šæœ€åçš„ENGINEäº†ï¼Œå› ä¸ºåœ¨æ­¤ç‰ˆæœ¬ä¸­InnoDBæ”¯æŒå…¨æ–‡ç´¢å¼•ã€‚</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#ä½¿ç”¨SHOW CREATE TABLEæŸ¥çœ‹è¡¨ç»“æ„,infoå­—æ®µä¸Šå·²ç»æˆåŠŸå»ºç«‹äº†ä¸€ä¸ªåä¸ºfutxt_idx_infoçš„FULLTEXTç´¢å¼•ã€‚</span><br><span class="line">SHOW INDEX FROM test;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#åˆ›å»ºä¸€ä¸ªç»™titleå’Œbodyå­—æ®µæ·»åŠ å…¨æ–‡ç´¢å¼•çš„è¡¨</span><br><span class="line">CREATE TABLE articles (</span><br><span class="line">id INT UNSIGNED AUTO_INCREMENT PRIMARY KEY,</span><br><span class="line">title VARCHAR (200),</span><br><span class="line">body TEXT,</span><br><span class="line">FULLTEXT index (title, body)</span><br><span class="line">) ENGINE = INNODB;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># åˆ›å»ºç»„åˆç´¢å¼•</span><br><span class="line">CREATE TABLE `papers` (</span><br><span class="line">`id` int(10) unsigned NOT NULL AUTO_INCREMENT,</span><br><span class="line">`title` varchar(200) DEFAULT NULL,</span><br><span class="line">`content` text,</span><br><span class="line">PRIMARY KEY (`id`),</span><br><span class="line">FULLTEXT KEY `title` (`title`,`content`)</span><br><span class="line">) ENGINE=MyISAM DEFAULT CHARSET=utf8;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#ä¸åŒäºlikeæ–¹å¼çš„çš„æŸ¥è¯¢</span><br><span class="line">SELECT * FROM papers WHERE content LIKE â€˜%æŸ¥è¯¢å­—ç¬¦ä¸²%â€™;</span><br><span class="line">#å…¨æ–‡ç´¢å¼•ç”¨match+againstæ–¹å¼æŸ¥è¯¢</span><br><span class="line">SELECT * FROM papers WHERE MATCH(title,content) AGAINST (â€˜æŸ¥è¯¢å­—ç¬¦ä¸²â€™);</span><br></pre></td></tr></table></figure><p>æ˜æ˜¾çš„æé«˜æŸ¥è¯¢æ•ˆç‡ã€‚</p><blockquote><p>æ³¨æ„ç‚¹ </p><ol><li>ä½¿ç”¨å…¨æ–‡ç´¢å¼•å‰ï¼Œææ¸…æ¥šç‰ˆæœ¬æ”¯æŒæƒ…å†µï¼› </li><li>å…¨æ–‡ç´¢å¼•æ¯” like + % å¿« N å€ï¼Œä½†æ˜¯å¯èƒ½å­˜åœ¨ç²¾åº¦é—®é¢˜ï¼›</li><li>å¦‚æœéœ€è¦å…¨æ–‡ç´¢å¼•çš„æ˜¯å¤§é‡æ•°æ®ï¼Œå»ºè®®å…ˆæ·»åŠ æ•°æ®ï¼Œå†åˆ›å»ºç´¢å¼•ã€‚</li></ol></blockquote><p><strong>7. ç©ºé—´ç´¢å¼•</strong></p><p>ç©ºé—´ç´¢å¼•åˆ›å»ºä¸­ï¼Œè¦æ±‚ç©ºé—´ç±»å‹çš„å­—æ®µå¿…é¡»ä¸º éç©º ã€‚</p><p>ä¸¾ä¾‹ï¼šåˆ›å»ºè¡¨test5ï¼Œåœ¨ç©ºé—´ç±»å‹ä¸ºGEOMETRYçš„å­—æ®µä¸Šåˆ›å»ºç©ºé—´ç´¢å¼•ï¼ŒSQLè¯­å¥å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE test5(</span><br><span class="line">geo GEOMETRY NOT NULL,</span><br><span class="line">SPATIAL INDEX spa_idx_geo(geo)</span><br><span class="line">) ENGINE=MyISAM;</span><br></pre></td></tr></table></figure><p>è¯¥è¯­å¥æ‰§è¡Œå®Œæ¯•ä¹‹åï¼Œä½¿ç”¨SHOW CREATE TABLEæŸ¥çœ‹è¡¨ç»“æ„ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHOW INDEX FROM test5 \G</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œtest5è¡¨çš„geoå­—æ®µä¸Šåˆ›å»ºäº†åç§°ä¸ºspa_idx_geoçš„ç©ºé—´ç´¢å¼•ã€‚æ³¨æ„åˆ›å»ºæ—¶æŒ‡å®šç©ºé—´ç±»å‹å­—æ®µå€¼çš„éç©ºçº¦æŸï¼Œå¹¶ä¸”è¡¨çš„å­˜å‚¨å¼•æ“ä¸ºMyISAMã€‚</p><h4 id="2-åœ¨å·²ç»å­˜åœ¨çš„è¡¨ä¸Šåˆ›å»ºç´¢å¼•"><a href="#2-åœ¨å·²ç»å­˜åœ¨çš„è¡¨ä¸Šåˆ›å»ºç´¢å¼•" class="headerlink" title="2. åœ¨å·²ç»å­˜åœ¨çš„è¡¨ä¸Šåˆ›å»ºç´¢å¼•"></a>2. åœ¨å·²ç»å­˜åœ¨çš„è¡¨ä¸Šåˆ›å»ºç´¢å¼•</h4><p>åœ¨å·²ç»å­˜åœ¨çš„è¡¨ä¸­åˆ›å»ºç´¢å¼•å¯ä»¥ä½¿ç”¨ALTER TABLEè¯­å¥æˆ–è€…CREATE INDEXè¯­å¥ã€‚</p><p><strong>1. ä½¿ç”¨ALTER TABLEè¯­å¥åˆ›å»ºç´¢å¼•</strong> ALTER TABLEè¯­å¥åˆ›å»ºç´¢å¼•çš„åŸºæœ¬è¯­æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ALTER TABLE table_name ADD [UNIQUE | FULLTEXT | SPATIAL] [INDEX | KEY]</span><br><span class="line">[index_name] (col_name[length],...) [ASC | DESC]</span><br></pre></td></tr></table></figure><p><strong>2. ä½¿ç”¨CREATE INDEXåˆ›å»ºç´¢å¼•</strong> CREATE INDEXè¯­å¥å¯ä»¥åœ¨å·²ç»å­˜åœ¨çš„è¡¨ä¸Šæ·»åŠ ç´¢å¼•ï¼Œåœ¨MySQLä¸­ï¼Œ CREATE INDEXè¢«æ˜ å°„åˆ°ä¸€ä¸ªALTER TABLEè¯­å¥ä¸Šï¼ŒåŸºæœ¬è¯­æ³•ç»“æ„ä¸ºï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CREATE [UNIQUE | FULLTEXT | SPATIAL] INDEX index_name</span><br><span class="line">ON table_name (col_name[length],...) [ASC | DESC]</span><br></pre></td></tr></table></figure><h3 id="1-3-åˆ é™¤ç´¢å¼•"><a href="#1-3-åˆ é™¤ç´¢å¼•" class="headerlink" title="1.3 åˆ é™¤ç´¢å¼•"></a>1.3 åˆ é™¤ç´¢å¼•</h3><p><strong>1. ä½¿ç”¨ALTER TABLEåˆ é™¤ç´¢å¼•</strong>  ALTER TABLEåˆ é™¤ç´¢å¼•çš„åŸºæœ¬è¯­æ³•æ ¼å¼å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ALTER TABLE table_name DROP INDEX index_name;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ALTER TABLE book DROP INDEX idx_cmt;</span><br></pre></td></tr></table></figure><blockquote><p>æç¤º: æ·»åŠ AUTO_INCREMENTçº¦æŸå­—æ®µçš„å”¯ä¸€ç´¢å¼•ä¸èƒ½è¢«åˆ é™¤ã€‚<br><strong>2. ä½¿ç”¨DROP INDEXè¯­å¥åˆ é™¤ç´¢å¼•</strong> DROP INDEXåˆ é™¤ç´¢å¼•çš„åŸºæœ¬è¯­æ³•æ ¼å¼å¦‚ä¸‹ï¼š</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DROP INDEX index_name ON table_name;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DROP INDEX uk_idx_bname ON book;</span><br></pre></td></tr></table></figure><blockquote><p>æç¤º: åˆ é™¤è¡¨ä¸­çš„åˆ—æ—¶ï¼Œå¦‚æœè¦åˆ é™¤çš„åˆ—ä¸ºç´¢å¼•çš„ç»„æˆéƒ¨åˆ†ï¼Œåˆ™è¯¥åˆ—ä¹Ÿä¼šä»ç´¢å¼•ä¸­åˆ é™¤ã€‚å¦‚æœç»„æˆç´¢å¼•çš„æ‰€æœ‰åˆ—éƒ½è¢«åˆ é™¤ï¼Œåˆ™æ•´ä¸ªç´¢å¼•å°†è¢«åˆ é™¤ã€‚</p></blockquote><h2 id="2-MySQL8-0ç´¢å¼•æ–°ç‰¹æ€§"><a href="#2-MySQL8-0ç´¢å¼•æ–°ç‰¹æ€§" class="headerlink" title="2. MySQL8.0ç´¢å¼•æ–°ç‰¹æ€§"></a>2. MySQL8.0ç´¢å¼•æ–°ç‰¹æ€§</h2><h3 id="2-1-æ”¯æŒé™åºç´¢å¼•"><a href="#2-1-æ”¯æŒé™åºç´¢å¼•" class="headerlink" title="2.1 æ”¯æŒé™åºç´¢å¼•"></a>2.1 æ”¯æŒé™åºç´¢å¼•</h3><p>é™åºç´¢å¼•ä»¥é™åºå­˜å‚¨é”®å€¼ã€‚è™½ç„¶åœ¨è¯­æ³•ä¸Šï¼Œä»MySQL 4ç‰ˆæœ¬å¼€å§‹å°±å·²ç»æ”¯æŒé™åºç´¢å¼•çš„è¯­æ³•äº†ï¼Œä½†å®é™…ä¸ŠDESCå®šä¹‰æ˜¯è¢«å¿½ç•¥çš„ï¼Œç›´åˆ°MySQL 8.xç‰ˆæœ¬æ‰å¼€å§‹çœŸæ­£æ”¯æŒé™åºç´¢å¼• (ä»…é™äºInnoDBcå­˜å‚¨å¼•æ“)ã€‚</p><p>MySQLåœ¨8.0ç‰ˆæœ¬ä¹‹å‰åˆ›å»ºçš„ä»ç„¶æ˜¯å‡åºç´¢å¼•ï¼Œä½¿ç”¨æ—¶è¿›è¡Œåå‘æ‰«æï¼Œè¿™å¤§å¤§é™ä½äº†æ•°æ®åº“çš„æ•ˆç‡ã€‚åœ¨æŸäº›åœºæ™¯ä¸‹ï¼Œé™åºç´¢å¼•æ„ä¹‰é‡å¤§ã€‚ä¾‹å¦‚ï¼Œå¦‚æœä¸€ä¸ªæŸ¥è¯¢ï¼Œéœ€è¦å¯¹å¤šä¸ªåˆ—è¿›è¡Œæ’åºï¼Œä¸”é¡ºåºè¦æ±‚ä¸ä¸€è‡´ï¼Œé‚£ä¹ˆä½¿ç”¨é™åºç´¢å¼•å°†ä¼šé¿å…æ•°æ®åº“ä½¿ç”¨é¢å¤–çš„æ–‡ä»¶æ’åºæ“ä½œï¼Œä»è€Œæé«˜æ€§èƒ½ã€‚</p><p>ä¸¾ä¾‹ï¼šåˆ†åˆ«åœ¨MySQL 5.7ç‰ˆæœ¬å’ŒMySQL 8.0ç‰ˆæœ¬ä¸­åˆ›å»ºæ•°æ®è¡¨ts1ï¼Œç»“æœå¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE ts1(a int,b int,index idx_a_b(a,b desc));</span><br></pre></td></tr></table></figure><p>åœ¨MySQL 5.7ç‰ˆæœ¬ä¸­æŸ¥çœ‹æ•°æ®è¡¨ts1çš„ç»“æ„ï¼Œç»“æœå¦‚ä¸‹:</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220622224124267.png" class=""><p>ä»ç»“æœå¯ä»¥çœ‹å‡ºï¼Œç´¢å¼•ä»ç„¶æ˜¯é»˜è®¤çš„å‡åº</p><p>åœ¨MySQL 8.0ç‰ˆæœ¬ä¸­æŸ¥çœ‹æ•°æ®è¡¨ts1çš„ç»“æ„ï¼Œç»“æœå¦‚ä¸‹ï¼š</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220622224205048.png" class=""><p>ä»ç»“æœå¯ä»¥çœ‹å‡ºï¼Œç´¢å¼•å·²ç»æ˜¯é™åºäº†ã€‚ä¸‹é¢ç»§ç»­æµ‹è¯•é™åºç´¢å¼•åœ¨æ‰§è¡Œè®¡åˆ’ä¸­çš„è¡¨ç°ã€‚</p><p>åˆ†åˆ«åœ¨MySQL 5.7ç‰ˆæœ¬å’ŒMySQL 8.0ç‰ˆæœ¬çš„æ•°æ®è¡¨ts1ä¸­æ’å…¥800æ¡éšæœºæ•°æ®ï¼Œæ‰§è¡Œè¯­å¥å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER //</span><br><span class="line">CREATE PROCEDURE ts_insert()</span><br><span class="line">BEGIN</span><br><span class="line">DECLARE i INT DEFAULT 1;</span><br><span class="line">WHILE i &lt; 800</span><br><span class="line">DO</span><br><span class="line">insert into ts1 select rand()*80000, rand()*80000;</span><br><span class="line">SET i = i+1;</span><br><span class="line">END WHILE;</span><br><span class="line">commit;</span><br><span class="line">END //</span><br><span class="line">DELIMITER;</span><br><span class="line"></span><br><span class="line"># è°ƒç”¨</span><br><span class="line">CALL ts_insert();</span><br></pre></td></tr></table></figure><p>åœ¨MySQL 5.7ç‰ˆæœ¬ä¸­æŸ¥çœ‹æ•°æ®è¡¨ts1çš„æ‰§è¡Œè®¡åˆ’ã€‚<br>åœ¨MySQL 8.0ç‰ˆæœ¬ä¸­æŸ¥çœ‹æ•°æ®è¡¨ts1çš„æ‰§è¡Œè®¡åˆ’ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN SELECT * FROM ts1 ORDER BY a, b DESC LIMIT 5;</span><br></pre></td></tr></table></figure><p>ä»ç»“æœå¯ä»¥çœ‹å‡ºï¼Œä¿®æ”¹åMySQL 5.7 çš„æ‰§è¡Œè®¡åˆ’è¦æ˜æ˜¾å¥½äºMySQL 8.0ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#ä¸æ¨è å¯¼è‡´ç´¢å¼•å¤±æ•ˆ</span><br><span class="line">EXPLAIN SELECT * FROM ts1 ORDER BY a DESC,b DESC LIMIT 5;</span><br></pre></td></tr></table></figure><h3 id="2-2-æ”¯æŒéšè—ç´¢å¼•"><a href="#2-2-æ”¯æŒéšè—ç´¢å¼•" class="headerlink" title="2.2 æ”¯æŒéšè—ç´¢å¼•"></a>2.2 æ”¯æŒéšè—ç´¢å¼•</h3><p>åœ¨MySQL 5.7ç‰ˆæœ¬åŠä¹‹å‰ï¼Œåªèƒ½é€šè¿‡æ˜¾å¼çš„æ–¹å¼åˆ é™¤ç´¢å¼•ã€‚æ­¤æ—¶ï¼Œå¦‚æœå‘å±•åˆ é™¤ç´¢å¼•åå‡ºç°é”™è¯¯ï¼Œåˆåªèƒ½é€šè¿‡æ˜¾å¼åˆ›å»ºç´¢å¼•çš„æ–¹å¼å°†åˆ é™¤çš„ç´¢å¼•åˆ›å»ºå›æ¥ã€‚å¦‚æœæ•°æ®è¡¨ä¸­çš„æ•°æ®é‡éå¸¸å¤§ï¼Œæˆ–è€…æ•°æ®è¡¨æœ¬èº«æ¯”è¾ƒ å¤§ï¼Œè¿™ç§æ“ä½œå°±ä¼šæ¶ˆè€—ç³»ç»Ÿè¿‡å¤šçš„èµ„æºï¼Œæ“ä½œæˆæœ¬éå¸¸é«˜ã€‚</p><p>ä»MySQL 8.xå¼€å§‹æ”¯æŒ éšè—ç´¢å¼•ï¼ˆinvisible indexesï¼‰ ï¼Œåªéœ€è¦å°†å¾…åˆ é™¤çš„ç´¢å¼•è®¾ç½®ä¸ºéšè—ç´¢å¼•ï¼Œä½¿ æŸ¥è¯¢ä¼˜åŒ–å™¨ä¸å†ä½¿ç”¨è¿™ä¸ªç´¢å¼•ï¼ˆå³ä½¿ä½¿ç”¨force indexï¼ˆå¼ºåˆ¶ä½¿ç”¨ç´¢å¼•ï¼‰ï¼Œä¼˜åŒ–å™¨ä¹Ÿä¸ä¼šä½¿ç”¨è¯¥ç´¢å¼•ï¼‰ï¼Œ ç¡®è®¤å°†ç´¢å¼•è®¾ç½®ä¸ºéšè—ç´¢å¼•åç³»ç»Ÿä¸å—ä»»ä½•å“åº”ï¼Œå°±å¯ä»¥å½»åº•åˆ é™¤ç´¢å¼•ã€‚ è¿™ç§é€šè¿‡å…ˆå°†ç´¢å¼•è®¾ç½®ä¸ºéšè—ç´¢ å¼•ï¼Œå†åˆ é™¤ç´¢å¼•çš„æ–¹å¼å°±æ˜¯è½¯åˆ é™¤ã€‚</p><p>åŒæ—¶ï¼Œå¦‚æœä½ æƒ³éªŒè¯æŸä¸ªç´¢å¼•åˆ é™¤ä¹‹åçš„ <code>æŸ¥è¯¢æ€§èƒ½å½±å“</code>ï¼Œå°±å¯ä»¥æš‚æ—¶å…ˆéšè—è¯¥ç´¢å¼•ã€‚</p><blockquote><p>æ³¨æ„ï¼š ä¸»é”®ä¸èƒ½è¢«è®¾ç½®ä¸ºéšè—ç´¢å¼•ã€‚å½“è¡¨ä¸­æ²¡æœ‰æ˜¾å¼ä¸»é”®æ—¶ï¼Œè¡¨ä¸­ç¬¬ä¸€ä¸ªå”¯ä¸€éç©ºç´¢å¼•ä¼šæˆä¸ºéšå¼ä¸»é”®ï¼Œä¹Ÿä¸èƒ½è®¾ç½®ä¸ºéšè—ç´¢å¼•ã€‚</p></blockquote><p>ç´¢å¼•é»˜è®¤æ˜¯å¯è§çš„ï¼Œåœ¨ä½¿ç”¨CREATE TABLE, CREATE INDEX æˆ–è€… ALTER TABLE ç­‰è¯­å¥æ—¶å¯ä»¥é€šè¿‡ <code>VISIBLE</code> æˆ–è€… <code>INVISIBLE</code> å…³é”®è¯è®¾ç½®ç´¢å¼•çš„å¯è§æ€§ã€‚</p><p><strong>1. åˆ›å»ºè¡¨æ—¶ç›´æ¥åˆ›å»º</strong></p><p>åœ¨MySQLä¸­åˆ›å»ºéšè—ç´¢å¼•é€šè¿‡SQLè¯­å¥INVISIBLEæ¥å®ç°ï¼Œå…¶è¯­æ³•å½¢å¼å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE tablename(</span><br><span class="line">propname1 type1[CONSTRAINT1],</span><br><span class="line">propname2 type2[CONSTRAINT2],</span><br><span class="line">â€¦â€¦</span><br><span class="line">propnamen typen,</span><br><span class="line">INDEX [indexname](propname1 [(length)]) INVISIBLE</span><br><span class="line">);</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">#åˆ›å»ºç´¢å¼•</span><br><span class="line">CREATE TABLE book(</span><br><span class="line">book_id INT ,</span><br><span class="line">book_name VARCHAR(100),</span><br><span class="line">AUTHORS VARCHAR(100),</span><br><span class="line">info VARCHAR(100) ,</span><br><span class="line">COMMENT VARCHAR(100),</span><br><span class="line">year_publication YEAR,</span><br><span class="line">#åˆ›å»ºä¸å¯è§çš„ç´¢å¼•</span><br><span class="line">INDEX idx_cmt(COMMENT) invisible</span><br><span class="line"></span><br><span class="line">#æŸ¥çœ‹ç´¢å¼•</span><br><span class="line">SHOW INDEX FROM book;</span><br><span class="line"></span><br><span class="line">#ç´¢å¼•ä¸ç”Ÿæ•ˆ</span><br><span class="line">EXPLAIN SELECT * FROM book WHERE COMMENT = &#x27;mysql....&#x27;;</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°è¯­å¥æ¯”æ™®é€šç´¢å¼•å¤šäº†ä¸€ä¸ªå…³é”®å­—INVISIBLEï¼Œç”¨æ¥æ ‡è®°ç´¢å¼•ä¸ºä¸å¯è§ç´¢å¼•ã€‚</p><p><strong>2. åœ¨å·²ç»å­˜åœ¨çš„è¡¨ä¸Šåˆ›å»º</strong></p><p>å¯ä»¥ä¸ºå·²ç»å­˜åœ¨çš„è¡¨è®¾ç½®éšè—ç´¢å¼•ï¼Œå…¶è¯­æ³•å½¢å¼å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CREATE INDEX indexname</span><br><span class="line">ON tablename(propname[(length)]) INVISIBLE;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CREATE INDEX idx_year_pub ON book(year_publication) invisible;</span><br></pre></td></tr></table></figure><p><strong>3. é€šè¿‡ALTER TABLEè¯­å¥åˆ›å»º</strong></p><p>å¯ä»¥ä¸ºå·²ç»å­˜åœ¨çš„è¡¨è®¾ç½®éšè—ç´¢å¼•ï¼Œå…¶è¯­æ³•å½¢å¼å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ALTER TABLE tablename</span><br><span class="line">ADD INDEX indexname (propname [(length)]) INVISIBLE;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ALTER TABLE book ADD UNIQUE INDEX uk_idx_bname(book_name) invisible;</span><br></pre></td></tr></table></figure><p><strong>4. åˆ‡æ¢ç´¢å¼•å¯è§çŠ¶æ€</strong></p><p>å·²å­˜åœ¨çš„ç´¢å¼•å¯é€šè¿‡å¦‚ä¸‹è¯­å¥åˆ‡æ¢å¯è§çŠ¶æ€ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ALTER TABLE tablename ALTER INDEX index_name INVISIBLE; #åˆ‡æ¢æˆéšè—ç´¢å¼•</span><br><span class="line">ALTER TABLE tablename ALTER INDEX index_name VISIBLE; #åˆ‡æ¢æˆééšè—ç´¢å¼•</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ALTER TABLE book ALTER INDEX idx_year_pub invisible; #å¯è§---&gt;ä¸å¯è§</span><br><span class="line"></span><br><span class="line">ALTER TABLE book ALTER INDEX idx_cmt visible; #ä¸å¯è§ ---&gt; å¯è§</span><br></pre></td></tr></table></figure><p>å¦‚æœå°†index_cnameç´¢å¼•åˆ‡æ¢æˆå¯è§çŠ¶æ€ï¼Œé€šè¿‡explainæŸ¥çœ‹æ‰§è¡Œè®¡åˆ’ï¼Œå‘ç°ä¼˜åŒ–å™¨é€‰æ‹©äº†index_cnameç´¢å¼•ã€‚</p><blockquote><p>æ³¨æ„ å½“ç´¢å¼•è¢«éšè—æ—¶ï¼Œå®ƒçš„å†…å®¹ä»ç„¶æ˜¯å’Œæ­£å¸¸ç´¢å¼•ä¸€æ ·å®æ—¶æ›´æ–°çš„ã€‚å¦‚æœä¸€ä¸ªç´¢å¼•éœ€è¦é•¿æœŸè¢«éšè—ï¼Œé‚£ä¹ˆå¯ä»¥å°†å…¶åˆ é™¤ï¼Œå› ä¸ºç´¢å¼•çš„å­˜åœ¨ä¼šå½±å“æ’å…¥ã€æ›´æ–°å’Œåˆ é™¤çš„æ€§èƒ½ã€‚</p></blockquote><p>é€šè¿‡è®¾ç½®éšè—ç´¢å¼•çš„å¯è§æ€§å¯ä»¥æŸ¥çœ‹ç´¢å¼•å¯¹è°ƒä¼˜çš„å¸®åŠ©ã€‚</p><p><strong>5. ä½¿éšè—ç´¢å¼•å¯¹æŸ¥è¯¢ä¼˜åŒ–å™¨å¯è§</strong></p><p>åœ¨MySQL 8.xç‰ˆæœ¬ä¸­ï¼Œä¸ºç´¢å¼•æä¾›äº†ä¸€ç§æ–°çš„æµ‹è¯•æ–¹å¼ï¼Œå¯ä»¥é€šè¿‡æŸ¥è¯¢ä¼˜åŒ–å™¨çš„ä¸€ä¸ªå¼€å…³ (use_invisible_indexes) æ¥æ‰“å¼€æŸä¸ªè®¾ç½®ï¼Œä½¿éšè—ç´¢å¼•å¯¹æŸ¥è¯¢ä¼˜åŒ–å™¨å¯è§ã€‚å¦‚æœuse_invisible_indexes è®¾ç½®ä¸ºoff (é»˜è®¤)ï¼Œä¼˜åŒ–å™¨ä¼šå¿½ç•¥éšè—ç´¢å¼•ã€‚å¦‚æœè®¾ç½®ä¸ºonï¼Œå³ä½¿éšè—ç´¢å¼•ä¸å¯è§ï¼Œä¼˜åŒ–å™¨åœ¨ç”Ÿæˆæ‰§è¡Œè®¡ åˆ’æ—¶ä»ä¼šè€ƒè™‘ä½¿ç”¨éšè—ç´¢å¼•ã€‚</p><p>ï¼ˆ1ï¼‰åœ¨MySQLå‘½ä»¤è¡Œæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤æŸ¥çœ‹æŸ¥è¯¢ä¼˜åŒ–å™¨çš„å¼€å…³è®¾ç½®ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select @@optimizer_switch \G</span><br></pre></td></tr></table></figure><p>åœ¨è¾“å‡ºçš„ç»“æœä¿¡æ¯ä¸­æ‰¾åˆ°å¦‚ä¸‹å±æ€§é…ç½®ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">use_invisible_indexes=off</span><br></pre></td></tr></table></figure><p>æ­¤å±æ€§é…ç½®å€¼ä¸ºoffï¼Œè¯´æ˜éšè—ç´¢å¼•é»˜è®¤å¯¹æŸ¥è¯¢ä¼˜åŒ–å™¨ä¸å¯è§ã€‚</p><p>ï¼ˆ2ï¼‰ä½¿éšè—ç´¢å¼•å¯¹æŸ¥è¯¢ä¼˜åŒ–å™¨å¯è§ï¼Œéœ€è¦åœ¨MySQLå‘½ä»¤è¡Œæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; set session optimizer_switch=&quot;use_invisible_indexes=on&quot;;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure><p>SQLè¯­å¥æ‰§è¡ŒæˆåŠŸï¼Œå†æ¬¡æŸ¥çœ‹æŸ¥è¯¢ä¼˜åŒ–å™¨çš„å¼€å…³è®¾ç½®ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select @@optimizer_switch \G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">@@optimizer_switch:</span><br><span class="line">index_merge=on,index_merge_union=on,index_merge_sort_union=on,index_merge_</span><br><span class="line">intersection=on,engine_condition_pushdown=on,index_condition_pushdown=on,mrr=on,mrr_co</span><br><span class="line">st_based=on,block_nested_loop=on,batched_key_access=off,materialization=on,semijoin=on</span><br><span class="line">,loosescan=on,firstmatch=on,duplicateweedout=on,subquery_materialization_cost_based=on</span><br><span class="line">,use_index_extensions=on,condition_fanout_filter=on,derived_merge=on,use_invisible_ind</span><br><span class="line">exes=on,skip_scan=on,hash_join=on</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶ï¼Œåœ¨è¾“å‡ºç»“æœä¸­å¯ä»¥çœ‹åˆ°å¦‚ä¸‹å±æ€§é…ç½®ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">use_invisible_indexes=on</span><br></pre></td></tr></table></figure><p>use_invisible_indexeså±æ€§çš„å€¼ä¸ºonï¼Œè¯´æ˜æ­¤æ—¶éšè—ç´¢å¼•å¯¹æŸ¥è¯¢ä¼˜åŒ–å™¨å¯è§ã€‚</p><p>ï¼ˆ3ï¼‰ä½¿ç”¨EXPLAINæŸ¥çœ‹ä»¥å­—æ®µinvisible_columnä½œä¸ºæŸ¥è¯¢æ¡ä»¶æ—¶çš„ç´¢å¼•ä½¿ç”¨æƒ…å†µã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">explain select * from classes where cname = &#x27;é«˜ä¸€2ç­&#x27;;</span><br></pre></td></tr></table></figure><p>æŸ¥è¯¢ä¼˜åŒ–å™¨ä¼šä½¿ç”¨éšè—ç´¢å¼•æ¥æŸ¥è¯¢æ•°æ®ã€‚</p><p>ï¼ˆ4ï¼‰å¦‚æœéœ€è¦ä½¿éšè—ç´¢å¼•å¯¹æŸ¥è¯¢ä¼˜åŒ–å™¨ä¸å¯è§ï¼Œåˆ™åªéœ€è¦æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤å³å¯ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; set session optimizer_switch=&quot;use_invisible_indexes=off&quot;;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure><p>å†æ¬¡æŸ¥çœ‹æŸ¥è¯¢ä¼˜åŒ–å™¨çš„å¼€å…³è®¾ç½®ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select @@optimizer_switch \G</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶ï¼Œuse_invisible_indexeså±æ€§çš„å€¼å·²ç»è¢«è®¾ç½®ä¸ºâ€œoffâ€ã€‚</p><h2 id="3-ç´¢å¼•çš„è®¾è®¡åŸåˆ™"><a href="#3-ç´¢å¼•çš„è®¾è®¡åŸåˆ™" class="headerlink" title="3. ç´¢å¼•çš„è®¾è®¡åŸåˆ™"></a>3. ç´¢å¼•çš„è®¾è®¡åŸåˆ™</h2><p>ä¸ºäº†ä½¿ç´¢å¼•çš„ä½¿ç”¨æ•ˆç‡æ›´é«˜ï¼Œåœ¨åˆ›å»ºç´¢å¼•æ—¶ï¼Œå¿…é¡»è€ƒè™‘åœ¨å“ªäº›å­—æ®µä¸Šåˆ›å»ºç´¢å¼•å’Œåˆ›å»ºä»€ä¹ˆç±»å‹çš„ç´¢å¼•ã€‚<strong>ç´¢å¼•è®¾è®¡ä¸åˆç†æˆ–è€…ç¼ºå°‘ç´¢å¼•éƒ½ä¼šå¯¹æ•°æ®åº“å’Œåº”ç”¨ç¨‹åºçš„æ€§èƒ½é€ æˆéšœç¢ã€‚</strong>é«˜æ•ˆçš„ç´¢å¼•å¯¹äºè·å¾—è‰¯å¥½çš„æ€§èƒ½éå¸¸é‡è¦ã€‚è®¾è®¡ç´¢å¼•æ—¶ï¼Œåº”è¯¥è€ƒè™‘ç›¸åº”å‡†åˆ™ã€‚</p><h3 id="3-1-æ•°æ®å‡†å¤‡"><a href="#3-1-æ•°æ®å‡†å¤‡" class="headerlink" title="3.1 æ•°æ®å‡†å¤‡"></a>3.1 æ•°æ®å‡†å¤‡</h3><p><strong>ç¬¬1æ­¥ï¼šåˆ›å»ºæ•°æ®åº“ã€åˆ›å»ºè¡¨</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">CREATE DATABASE atguigudb1;</span><br><span class="line">USE atguigudb1;</span><br><span class="line">#1.åˆ›å»ºå­¦ç”Ÿè¡¨å’Œè¯¾ç¨‹è¡¨</span><br><span class="line">CREATE TABLE `student_info` (</span><br><span class="line">`id` INT(11) NOT NULL AUTO_INCREMENT,</span><br><span class="line">`student_id` INT NOT NULL ,</span><br><span class="line">`name` VARCHAR(20) DEFAULT NULL,</span><br><span class="line">`course_id` INT NOT NULL ,</span><br><span class="line">`class_id` INT(11) DEFAULT NULL,</span><br><span class="line">`create_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,</span><br><span class="line">PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=INNODB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8;</span><br><span class="line"></span><br><span class="line">CREATE TABLE `course` (</span><br><span class="line">`id` INT(11) NOT NULL AUTO_INCREMENT,</span><br><span class="line">`course_id` INT NOT NULL ,</span><br><span class="line">`course_name` VARCHAR(40) DEFAULT NULL,</span><br><span class="line">PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=INNODB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8;</span><br></pre></td></tr></table></figure><p><strong>ç¬¬2æ­¥ï¼šåˆ›å»ºæ¨¡æ‹Ÿæ•°æ®å¿…éœ€çš„å­˜å‚¨å‡½æ•°</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#å‡½æ•°1ï¼šåˆ›å»ºéšæœºäº§ç”Ÿå­—ç¬¦ä¸²å‡½æ•°</span><br><span class="line">DELIMITER //</span><br><span class="line">CREATE FUNCTION rand_string(n INT)</span><br><span class="line">RETURNS VARCHAR(255) #è¯¥å‡½æ•°ä¼šè¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²</span><br><span class="line">BEGIN</span><br><span class="line">DECLARE chars_str VARCHAR(100) DEFAULT</span><br><span class="line">&#x27;abcdefghijklmnopqrstuvwxyzABCDEFJHIJKLMNOPQRSTUVWXYZ&#x27;;</span><br><span class="line">DECLARE return_str VARCHAR(255) DEFAULT &#x27;&#x27;;</span><br><span class="line">    DECLARE i INT DEFAULT 0;</span><br><span class="line">    WHILE i &lt; n DO</span><br><span class="line">    SET return_str =CONCAT(return_str,SUBSTRING(chars_str,FLOOR(1+RAND()*52),1));</span><br><span class="line">    SET i = i + 1;</span><br><span class="line">    END WHILE;</span><br><span class="line">    RETURN return_str;</span><br><span class="line">END //</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#å‡½æ•°2ï¼šåˆ›å»ºéšæœºæ•°å‡½æ•°</span><br><span class="line">DELIMITER //</span><br><span class="line">CREATE FUNCTION rand_num (from_num INT ,to_num INT) RETURNS INT(11)</span><br><span class="line">BEGIN</span><br><span class="line">DECLARE i INT DEFAULT 0;</span><br><span class="line">SET i = FLOOR(from_num +RAND()*(to_num - from_num+1)) ;</span><br><span class="line">RETURN i;</span><br><span class="line">END //</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure><p>åˆ›å»ºå‡½æ•°ï¼Œå‡å¦‚æŠ¥é”™ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">This function has none of DETERMINISTIC......</span><br></pre></td></tr></table></figure><p>ç”±äºå¼€å¯è¿‡æ…¢æŸ¥è¯¢æ—¥å¿—bin-log, æˆ‘ä»¬å°±å¿…é¡»ä¸ºæˆ‘ä»¬çš„functionæŒ‡å®šä¸€ä¸ªå‚æ•°ã€‚</p><p>ä¸»ä»å¤åˆ¶ï¼Œä¸»æœºä¼šå°†å†™æ“ä½œè®°å½•åœ¨bin-logæ—¥å¿—ä¸­ã€‚ä»æœºè¯»å–bin-logæ—¥å¿—ï¼Œæ‰§è¡Œè¯­å¥æ¥åŒæ­¥æ•°æ®ã€‚å¦‚æœä½¿ ç”¨å‡½æ•°æ¥æ“ä½œæ•°æ®ï¼Œä¼šå¯¼è‡´ä»æœºå’Œä¸»é”®æ“ä½œæ—¶é—´ä¸ä¸€è‡´ã€‚æ‰€ä»¥ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œmysqlä¸å¼€å¯åˆ›å»ºå‡½æ•°è®¾ç½®ã€‚</p><ul><li>æŸ¥çœ‹mysqlæ˜¯å¦å…è®¸åˆ›å»ºå‡½æ•°ï¼š</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show variables like &#x27;log_bin_trust_function_creators&#x27;;</span><br></pre></td></tr></table></figure><ul><li>å‘½ä»¤å¼€å¯ï¼šå…è®¸åˆ›å»ºå‡½æ•°è®¾ç½®ï¼š</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set global log_bin_trust_function_creators=1; # ä¸åŠ globalåªæ˜¯å½“å‰çª—å£æœ‰æ•ˆã€‚</span><br></pre></td></tr></table></figure><ul><li><p>mysqldé‡å¯ï¼Œä¸Šè¿°å‚æ•°åˆä¼šæ¶ˆå¤±ã€‚æ°¸ä¹…æ–¹æ³•ï¼š</p><ul><li><p>windowsä¸‹ï¼šmy.ini[mysqld]åŠ ä¸Šï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">log_bin_trust_function_creators=1</span><br></pre></td></tr></table></figure></li><li><p>linuxä¸‹ï¼š&#x2F;etc&#x2F;my.cnfä¸‹my.cnf[mysqld]åŠ ä¸Šï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">log_bin_trust_function_creators=1</span><br></pre></td></tr></table></figure></li></ul></li></ul><p><strong>ç¬¬3æ­¥ï¼šåˆ›å»ºæ’å…¥æ¨¡æ‹Ÿæ•°æ®çš„å­˜å‚¨è¿‡ç¨‹</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># å­˜å‚¨è¿‡ç¨‹1ï¼šåˆ›å»ºæ’å…¥è¯¾ç¨‹è¡¨å­˜å‚¨è¿‡ç¨‹</span><br><span class="line">DELIMITER //</span><br><span class="line">CREATE PROCEDURE insert_course( max_num INT )</span><br><span class="line">BEGIN</span><br><span class="line">DECLARE i INT DEFAULT 0;</span><br><span class="line">SET autocommit = 0; #è®¾ç½®æ‰‹åŠ¨æäº¤äº‹åŠ¡</span><br><span class="line">REPEAT #å¾ªç¯</span><br><span class="line">SET i = i + 1; #èµ‹å€¼</span><br><span class="line">INSERT INTO course (course_id, course_name ) VALUES</span><br><span class="line">(rand_num(10000,10100),rand_string(6));</span><br><span class="line">UNTIL i = max_num</span><br><span class="line">END REPEAT;</span><br><span class="line">COMMIT; #æäº¤äº‹åŠ¡</span><br><span class="line">END //</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"># å­˜å‚¨è¿‡ç¨‹2ï¼šåˆ›å»ºæ’å…¥å­¦ç”Ÿä¿¡æ¯è¡¨å­˜å‚¨è¿‡ç¨‹</span><br><span class="line">DELIMITER //</span><br><span class="line">CREATE PROCEDURE insert_stu( max_num INT )</span><br><span class="line">BEGIN</span><br><span class="line">DECLARE i INT DEFAULT 0;</span><br><span class="line">SET autocommit = 0; #è®¾ç½®æ‰‹åŠ¨æäº¤äº‹åŠ¡</span><br><span class="line">REPEAT #å¾ªç¯</span><br><span class="line">SET i = i + 1; #èµ‹å€¼</span><br><span class="line">INSERT INTO student_info (course_id, class_id ,student_id ,NAME ) VALUES</span><br><span class="line">(rand_num(10000,10100),rand_num(10000,10200),rand_num(1,200000),rand_string(6));</span><br><span class="line">UNTIL i = max_num</span><br><span class="line">END REPEAT;</span><br><span class="line">COMMIT; #æäº¤äº‹åŠ¡</span><br><span class="line">END //</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure><p><strong>ç¬¬4æ­¥ï¼šè°ƒç”¨å­˜å‚¨è¿‡ç¨‹</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CALL insert_course(100);</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CALL insert_stu(1000000);</span><br></pre></td></tr></table></figure><h3 id="3-2-å“ªäº›æƒ…å†µé€‚åˆåˆ›å»ºç´¢å¼•"><a href="#3-2-å“ªäº›æƒ…å†µé€‚åˆåˆ›å»ºç´¢å¼•" class="headerlink" title="3.2 å“ªäº›æƒ…å†µé€‚åˆåˆ›å»ºç´¢å¼•"></a>3.2 å“ªäº›æƒ…å†µé€‚åˆåˆ›å»ºç´¢å¼•</h3><h4 id="1-å­—æ®µçš„æ•°å€¼æœ‰å”¯ä¸€æ€§çš„é™åˆ¶"><a href="#1-å­—æ®µçš„æ•°å€¼æœ‰å”¯ä¸€æ€§çš„é™åˆ¶" class="headerlink" title="1. å­—æ®µçš„æ•°å€¼æœ‰å”¯ä¸€æ€§çš„é™åˆ¶"></a>1. å­—æ®µçš„æ•°å€¼æœ‰å”¯ä¸€æ€§çš„é™åˆ¶</h4><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220623154615702.png" class=""><blockquote><p>ä¸šåŠ¡ä¸Šå…·æœ‰å”¯ä¸€ç‰¹æ€§çš„å­—æ®µï¼Œå³ä½¿æ˜¯ç»„åˆå­—æ®µï¼Œä¹Ÿå¿…é¡»å»ºæˆå”¯ä¸€ç´¢å¼•ã€‚ï¼ˆæ¥æºï¼šAlibabaï¼‰ è¯´æ˜ï¼šä¸è¦ä»¥ä¸ºå”¯ä¸€ç´¢å¼•å½±å“äº† insert é€Ÿåº¦ï¼Œè¿™ä¸ªé€Ÿåº¦æŸè€—å¯ä»¥å¿½ç•¥ï¼Œä½†æé«˜æŸ¥æ‰¾é€Ÿåº¦æ˜¯æ˜æ˜¾çš„ã€‚</p></blockquote><h4 id="2-é¢‘ç¹ä½œä¸º-WHERE-æŸ¥è¯¢æ¡ä»¶çš„å­—æ®µ"><a href="#2-é¢‘ç¹ä½œä¸º-WHERE-æŸ¥è¯¢æ¡ä»¶çš„å­—æ®µ" class="headerlink" title="2. é¢‘ç¹ä½œä¸º WHERE æŸ¥è¯¢æ¡ä»¶çš„å­—æ®µ"></a>2. é¢‘ç¹ä½œä¸º WHERE æŸ¥è¯¢æ¡ä»¶çš„å­—æ®µ</h4><p>æŸä¸ªå­—æ®µåœ¨SELECTè¯­å¥çš„ WHERE æ¡ä»¶ä¸­ç»å¸¸è¢«ä½¿ç”¨åˆ°ï¼Œé‚£ä¹ˆå°±éœ€è¦ç»™è¿™ä¸ªå­—æ®µåˆ›å»ºç´¢å¼•äº†ã€‚å°¤å…¶æ˜¯åœ¨ æ•°æ®é‡å¤§çš„æƒ…å†µä¸‹ï¼Œåˆ›å»ºæ™®é€šç´¢å¼•å°±å¯ä»¥å¤§å¹…æå‡æ•°æ®æŸ¥è¯¢çš„æ•ˆç‡ã€‚ </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># åˆ›å»ºæ™®é€šç´¢å¼•</span><br><span class="line">ALTER TABLE student_info</span><br><span class="line">ADD INDEX idx_sid(student_id);</span><br><span class="line"># æŸ¥çœ‹ç´¢å¼•</span><br><span class="line">SHOW INDEX FROM student_info;</span><br><span class="line"># æŸ¥è¯¢æ•°æ®</span><br><span class="line">SELECT course_id, class_id, NAME, create_time, student_id</span><br><span class="line">FROM student_info</span><br><span class="line">WHERE student_id = 123110;</span><br><span class="line"># åˆ é™¤ç´¢å¼•</span><br><span class="line">ALTER TABLE student_info </span><br><span class="line">DROP INDEX idx_sid;</span><br></pre></td></tr></table></figure><h4 id="3-ç»å¸¸-GROUP-BY-å’Œ-ORDER-BY-çš„åˆ—"><a href="#3-ç»å¸¸-GROUP-BY-å’Œ-ORDER-BY-çš„åˆ—" class="headerlink" title="3. ç»å¸¸ GROUP BY å’Œ ORDER BY çš„åˆ—"></a>3. ç»å¸¸ GROUP BY å’Œ ORDER BY çš„åˆ—</h4><p>ç´¢å¼•å°±æ˜¯è®©æ•°æ®æŒ‰ç…§æŸç§é¡ºåºè¿›è¡Œå­˜å‚¨æˆ–æ£€ç´¢ï¼Œå› æ­¤å½“æˆ‘ä»¬ä½¿ç”¨ GROUP BY å¯¹æ•°æ®è¿›è¡Œåˆ†ç»„æŸ¥è¯¢ï¼Œæˆ–è€…ä½¿ç”¨ ORDER BY å¯¹æ•°æ®è¿›è¡Œæ’åºçš„æ—¶å€™ï¼Œå°±éœ€è¦å¯¹åˆ†ç»„æˆ–è€…æ’åºçš„å­—æ®µè¿›è¡Œç´¢å¼• ã€‚å¦‚æœå¾…æ’åºçš„åˆ—æœ‰å¤šä¸ªï¼Œé‚£ä¹ˆå¯ä»¥åœ¨è¿™äº›åˆ—ä¸Šå»ºç«‹ç»„åˆç´¢å¼• ã€‚</p><h5 id="å•ä¸ªæŸ¥è¯¢æ¡ä»¶"><a href="#å•ä¸ªæŸ¥è¯¢æ¡ä»¶" class="headerlink" title="å•ä¸ªæŸ¥è¯¢æ¡ä»¶"></a>å•ä¸ªæŸ¥è¯¢æ¡ä»¶</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># åˆ›å»ºæ™®é€šç´¢å¼•</span><br><span class="line">ALTER TABLE student_info</span><br><span class="line">ADD INDEX idx_sid(student_id);</span><br><span class="line"># æŸ¥çœ‹ç´¢å¼•</span><br><span class="line">SHOW INDEX FROM student_info;</span><br><span class="line"># æŸ¥è¯¢æ•°æ®</span><br><span class="line">SELECT student_id, COUNT(*) AS num</span><br><span class="line">FROM student_info</span><br><span class="line">GROUP BY student_id LIMIT 100;</span><br><span class="line"># åˆ é™¤ç´¢å¼•</span><br><span class="line">ALTER TABLE student_info </span><br><span class="line">DROP INDEX idx_sid;</span><br></pre></td></tr></table></figure><h5 id="å¤åˆæŸ¥è¯¢æ¡ä»¶"><a href="#å¤åˆæŸ¥è¯¢æ¡ä»¶" class="headerlink" title="å¤åˆæŸ¥è¯¢æ¡ä»¶"></a>å¤åˆæŸ¥è¯¢æ¡ä»¶</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># å¼€å¯å®½æ¾æ¨¡å¼</span><br><span class="line"># set @@sql_mode=&#x27;STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION&#x27;;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"># åˆ›å»ºå•åˆ—ç´¢å¼•</span><br><span class="line">ALTER TABLE student_info</span><br><span class="line">ADD INDEX idx_sid(student_id);</span><br><span class="line">ALTER TABLE student_info</span><br><span class="line">ADD INDEX idx_cre_time(create_time);</span><br><span class="line"># æŸ¥çœ‹ç´¢å¼•</span><br><span class="line">SHOW INDEX FROM student_info;</span><br><span class="line"># æŸ¥è¯¢æ•°æ®  idx_cre_timeç´¢å¼•æ²¡æœ‰ä½¿ç”¨ä¸Šï¼Œå…ˆæ‰§è¡ŒGROUP BYï¼Œå†æ‰§è¡ŒORDER BY</span><br><span class="line">EXPLAIN SELECT student_id, COUNT(*) AS num</span><br><span class="line">FROM student_info</span><br><span class="line">GROUP BY student_id </span><br><span class="line">ORDER BY create_time DESC</span><br><span class="line">LIMIT 100;</span><br><span class="line"># åˆ é™¤ç´¢å¼•</span><br><span class="line">ALTER TABLE student_info </span><br><span class="line">DROP INDEX idx_sid;</span><br><span class="line">ALTER TABLE student_info </span><br><span class="line">DROP INDEX idx_cre_time;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"># åˆ›å»ºè”åˆç´¢å¼•</span><br><span class="line">ALTER TABLE student_info</span><br><span class="line">ADD INDEX idx_sid_cre_time(student_id,create_time DESC);</span><br><span class="line"># æŸ¥çœ‹ç´¢å¼•</span><br><span class="line">SHOW INDEX FROM student_info;</span><br><span class="line"># æŸ¥è¯¢æ•°æ® ç´¢å¼•è¢«ä½¿ç”¨ï¼Œå…ˆæ‰§è¡ŒGROUP BYï¼Œå†æ‰§è¡ŒORDER BY</span><br><span class="line">EXPLAIN SELECT student_id, COUNT(*) AS num</span><br><span class="line">FROM student_info</span><br><span class="line">GROUP BY student_id </span><br><span class="line">ORDER BY create_time DESC</span><br><span class="line">LIMIT 100;</span><br><span class="line"># åˆ é™¤ç´¢å¼•</span><br><span class="line">ALTER TABLE student_info </span><br><span class="line">DROP INDEX idx_sid_cre_time;</span><br><span class="line"></span><br><span class="line"># åˆ›å»ºè”åˆç´¢å¼•</span><br><span class="line">ALTER TABLE student_info</span><br><span class="line">ADD INDEX idx_cre_time_sid(create_time DESC,student_id);</span><br><span class="line"># æŸ¥çœ‹ç´¢å¼• </span><br><span class="line">SHOW INDEX FROM student_info;</span><br><span class="line"># æŸ¥è¯¢æ•°æ® idx_cre_time_sidç´¢å¼•æ²¡æœ‰ä½¿ç”¨ä¸Šï¼Œå…ˆæ‰§è¡ŒGROUP BYï¼Œå†æ‰§è¡ŒORDER BY</span><br><span class="line">EXPLAIN SELECT student_id, COUNT(*) AS num</span><br><span class="line">FROM student_info</span><br><span class="line">GROUP BY student_id </span><br><span class="line">ORDER BY create_time DESC</span><br><span class="line">LIMIT 100;</span><br><span class="line"># åˆ é™¤ç´¢å¼•</span><br><span class="line">ALTER TABLE student_info </span><br><span class="line">DROP INDEX idx_cre_time_sid;</span><br></pre></td></tr></table></figure><h4 id="4-UPDATEã€DELETE-çš„-WHERE-æ¡ä»¶åˆ—"><a href="#4-UPDATEã€DELETE-çš„-WHERE-æ¡ä»¶åˆ—" class="headerlink" title="4. UPDATEã€DELETE çš„ WHERE æ¡ä»¶åˆ—"></a>4. UPDATEã€DELETE çš„ WHERE æ¡ä»¶åˆ—</h4><p>å¯¹æ•°æ®æŒ‰ç…§æŸä¸ªæ¡ä»¶è¿›è¡ŒæŸ¥è¯¢åå†è¿›è¡Œ UPDATE æˆ– DELETE çš„æ“ä½œï¼Œå¦‚æœå¯¹ WHERE å­—æ®µåˆ›å»ºäº†ç´¢å¼•ï¼Œå°±èƒ½å¤§å¹…æå‡æ•ˆç‡ã€‚åŸç†æ˜¯å› ä¸ºæˆ‘ä»¬éœ€è¦å…ˆæ ¹æ® WHERE æ¡ä»¶åˆ—æ£€ç´¢å‡ºæ¥è¿™æ¡è®°å½•ï¼Œç„¶åå†å¯¹å®ƒè¿›è¡Œæ›´æ–°æˆ–åˆ é™¤ã€‚<strong>å¦‚æœè¿›è¡Œæ›´æ–°çš„æ—¶å€™ï¼Œæ›´æ–°çš„å­—æ®µæ˜¯éç´¢å¼•å­—æ®µï¼Œæå‡çš„æ•ˆç‡ä¼šæ›´æ˜æ˜¾ï¼Œè¿™æ˜¯å› ä¸ºéç´¢å¼•å­—æ®µæ›´æ–°ä¸éœ€è¦å¯¹ç´¢å¼•è¿›è¡Œç»´æŠ¤ã€‚</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># åˆ›å»ºç´¢å¼•</span><br><span class="line">ALTER TABLE student_info </span><br><span class="line">ADD INDEX idx_name(NAME);</span><br><span class="line"># æŸ¥çœ‹ç´¢å¼•</span><br><span class="line">SHOW INDEX FROM student_info;</span><br><span class="line"># æ‰§è¡Œä¿®æ”¹æ“ä½œ</span><br><span class="line">EXPLAIN UPDATE student_info SET student_id = 10002</span><br><span class="line">WHERE NAME=&#x27;sxlMbV&#x27;;</span><br><span class="line"># åˆ é™¤ç´¢å¼•</span><br><span class="line">ALTER TABLE student_info </span><br><span class="line">DROP INDEX idx_name;</span><br></pre></td></tr></table></figure><h4 id="5-DISTINCT-å­—æ®µéœ€è¦åˆ›å»ºç´¢å¼•"><a href="#5-DISTINCT-å­—æ®µéœ€è¦åˆ›å»ºç´¢å¼•" class="headerlink" title="5.DISTINCT å­—æ®µéœ€è¦åˆ›å»ºç´¢å¼•"></a>5.DISTINCT å­—æ®µéœ€è¦åˆ›å»ºç´¢å¼•</h4><p>æœ‰æ—¶å€™æˆ‘ä»¬éœ€è¦å¯¹æŸä¸ªå­—æ®µè¿›è¡Œå»é‡ï¼Œä½¿ç”¨ DISTINCTï¼Œé‚£ä¹ˆå¯¹è¿™ä¸ªå­—æ®µåˆ›å»ºç´¢å¼•ï¼Œä¹Ÿä¼šæå‡æŸ¥è¯¢æ•ˆç‡ã€‚ </p><p>æ¯”å¦‚ï¼Œæˆ‘ä»¬æƒ³è¦æŸ¥è¯¢è¯¾ç¨‹è¡¨ä¸­ä¸åŒçš„ student_id éƒ½æœ‰å“ªäº›ï¼Œå¦‚æœæˆ‘ä»¬æ²¡æœ‰å¯¹ student_id åˆ›å»ºç´¢å¼•ï¼Œæ‰§è¡Œ SQL è¯­å¥ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT DISTINCT(student_id) FROM `student_info`;</span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœï¼ˆ600637 æ¡è®°å½•ï¼Œè¿è¡Œæ—¶é—´ 0.683s ï¼‰</p><p>å¦‚æœæˆ‘ä»¬å¯¹ student_id åˆ›å»ºç´¢å¼•ï¼Œå†æ‰§è¡Œ SQL è¯­å¥ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT DISTINCT(student_id) FROM `student_info`;</span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœï¼ˆ600637 æ¡è®°å½•ï¼Œè¿è¡Œæ—¶é—´ 0.010s ï¼‰</p><p>ä½ èƒ½çœ‹åˆ° SQL æŸ¥è¯¢æ•ˆç‡æœ‰äº†æå‡ï¼ŒåŒæ—¶æ˜¾ç¤ºå‡ºæ¥çš„ student_id è¿˜æ˜¯æŒ‰ç…§é€’å¢çš„é¡ºåº è¿›è¡Œå±•ç¤ºçš„ã€‚è¿™æ˜¯å› ä¸ºç´¢å¼•ä¼šå¯¹æ•°æ®æŒ‰ç…§æŸç§é¡ºåºè¿›è¡Œæ’åºï¼Œæ‰€ä»¥åœ¨å»é‡çš„æ—¶å€™ä¹Ÿä¼šå¿«å¾ˆå¤šã€‚</p><h4 id="6-å¤šè¡¨-JOIN-è¿æ¥æ“ä½œæ—¶ï¼Œåˆ›å»ºç´¢å¼•æ³¨æ„äº‹é¡¹"><a href="#6-å¤šè¡¨-JOIN-è¿æ¥æ“ä½œæ—¶ï¼Œåˆ›å»ºç´¢å¼•æ³¨æ„äº‹é¡¹" class="headerlink" title="6. å¤šè¡¨ JOIN è¿æ¥æ“ä½œæ—¶ï¼Œåˆ›å»ºç´¢å¼•æ³¨æ„äº‹é¡¹"></a>6. å¤šè¡¨ JOIN è¿æ¥æ“ä½œæ—¶ï¼Œåˆ›å»ºç´¢å¼•æ³¨æ„äº‹é¡¹</h4><p>é¦–å…ˆï¼Œ <code>è¿æ¥è¡¨çš„æ•°é‡å°½é‡ä¸è¦è¶…è¿‡ 3 å¼ </code> ï¼Œå› ä¸ºæ¯å¢åŠ ä¸€å¼ è¡¨å°±ç›¸å½“äºå¢åŠ äº†ä¸€æ¬¡åµŒå¥—çš„å¾ªç¯ï¼Œæ•°é‡çº§å¢ é•¿ä¼šéå¸¸å¿«ï¼Œä¸¥é‡å½±å“æŸ¥è¯¢çš„æ•ˆç‡ã€‚ </p><p>å…¶æ¬¡ï¼Œ <code>å¯¹ WHERE æ¡ä»¶åˆ›å»ºç´¢å¼•</code> ï¼Œå› ä¸º WHERE æ‰æ˜¯å¯¹æ•°æ®æ¡ä»¶çš„è¿‡æ»¤ã€‚å¦‚æœåœ¨æ•°æ®é‡éå¸¸å¤§çš„æƒ…å†µä¸‹ï¼Œ æ²¡æœ‰ WHERE æ¡ä»¶è¿‡æ»¤æ˜¯éå¸¸å¯æ€•çš„ã€‚ </p><p>æœ€åï¼Œ <code>å¯¹ç”¨äºè¿æ¥çš„å­—æ®µåˆ›å»ºç´¢å¼•</code> ï¼Œå¹¶ä¸”è¯¥å­—æ®µåœ¨å¤šå¼ è¡¨ä¸­çš„ ç±»å‹å¿…é¡»ä¸€è‡´ ã€‚æ¯”å¦‚ course_id åœ¨ student_info è¡¨å’Œ course è¡¨ä¸­éƒ½ä¸º int(11) ç±»å‹ï¼Œè€Œä¸èƒ½ä¸€ä¸ªä¸º int å¦ä¸€ä¸ªä¸º varchar ç±»å‹ã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœæˆ‘ä»¬åªå¯¹ student_id åˆ›å»ºç´¢å¼•ï¼Œæ‰§è¡Œ SQL è¯­å¥ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SELECT s.course_id, name, s.student_id, c.course_name</span><br><span class="line">FROM student_info s JOIN course c</span><br><span class="line">ON s.course_id = c.course_id</span><br><span class="line">WHERE name = &#x27;462eed7ac6e791292a79&#x27;;</span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœï¼ˆ1 æ¡æ•°æ®ï¼Œè¿è¡Œæ—¶é—´ 0.189s ï¼‰</p><p>è¿™é‡Œæˆ‘ä»¬å¯¹ name åˆ›å»ºç´¢å¼•ï¼Œå†æ‰§è¡Œä¸Šé¢çš„ SQL è¯­å¥ï¼Œè¿è¡Œæ—¶é—´ä¸º 0.002s ã€‚</p><h4 id="7-ä½¿ç”¨åˆ—çš„ç±»å‹å°çš„åˆ›å»ºç´¢å¼•"><a href="#7-ä½¿ç”¨åˆ—çš„ç±»å‹å°çš„åˆ›å»ºç´¢å¼•" class="headerlink" title="7. ä½¿ç”¨åˆ—çš„ç±»å‹å°çš„åˆ›å»ºç´¢å¼•"></a>7. ä½¿ç”¨åˆ—çš„ç±»å‹å°çš„åˆ›å»ºç´¢å¼•</h4><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220623175306282.png" class=""><h4 id="8-ä½¿ç”¨å­—ç¬¦ä¸²å‰ç¼€åˆ›å»ºç´¢å¼•"><a href="#8-ä½¿ç”¨å­—ç¬¦ä¸²å‰ç¼€åˆ›å»ºç´¢å¼•" class="headerlink" title="8. ä½¿ç”¨å­—ç¬¦ä¸²å‰ç¼€åˆ›å»ºç´¢å¼•"></a>8. ä½¿ç”¨å­—ç¬¦ä¸²å‰ç¼€åˆ›å»ºç´¢å¼•</h4><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220623175513439.png" class=""><p>åˆ›å»ºä¸€å¼ å•†æˆ·è¡¨ï¼Œå› ä¸ºåœ°å€å­—æ®µæ¯”è¾ƒé•¿ï¼Œåœ¨åœ°å€å­—æ®µä¸Šå»ºç«‹å‰ç¼€ç´¢å¼•</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">create table shop(address varchar(120) not null);</span><br><span class="line">alter table shop add index(address(12));</span><br></pre></td></tr></table></figure><p>é—®é¢˜æ˜¯ï¼Œæˆªå–å¤šå°‘å‘¢ï¼Ÿæˆªå–å¾—å¤šäº†ï¼Œè¾¾ä¸åˆ°èŠ‚çœç´¢å¼•å­˜å‚¨ç©ºé—´çš„ç›®çš„ï¼›æˆªå–å¾—å°‘äº†ï¼Œé‡å¤å†…å®¹å¤ªå¤šï¼Œå­— æ®µçš„æ•£åˆ—åº¦(é€‰æ‹©æ€§)ä¼šé™ä½ã€‚æ€ä¹ˆè®¡ç®—ä¸åŒçš„é•¿åº¦çš„é€‰æ‹©æ€§å‘¢ï¼Ÿ</p><p>å…ˆçœ‹ä¸€ä¸‹å­—æ®µåœ¨å…¨éƒ¨æ•°æ®ä¸­çš„é€‰æ‹©åº¦ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select count(distinct address) / count(*) from shop</span><br></pre></td></tr></table></figure><p>é€šè¿‡ä¸åŒé•¿åº¦å»è®¡ç®—ï¼Œä¸å…¨è¡¨çš„é€‰æ‹©æ€§å¯¹æ¯”ï¼š</p><p>å…¬å¼ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">count(distinct left(åˆ—å, ç´¢å¼•é•¿åº¦))/count(*)</span><br></pre></td></tr></table></figure><p>ä¾‹å¦‚ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">select count(distinct left(address,10)) / count(*) as sub10, -- æˆªå–å‰10ä¸ªå­—ç¬¦çš„é€‰æ‹©åº¦</span><br><span class="line">count(distinct left(address,15)) / count(*) as sub11, -- æˆªå–å‰15ä¸ªå­—ç¬¦çš„é€‰æ‹©åº¦</span><br><span class="line">count(distinct left(address,20)) / count(*) as sub12, -- æˆªå–å‰20ä¸ªå­—ç¬¦çš„é€‰æ‹©åº¦</span><br><span class="line">count(distinct left(address,25)) / count(*) as sub13 -- æˆªå–å‰25ä¸ªå­—ç¬¦çš„é€‰æ‹©åº¦</span><br><span class="line">from shop;</span><br></pre></td></tr></table></figure><blockquote><p>è¶Šæ¥è¿‘äº1è¶Šå¥½ï¼Œè¯´æ˜è¶Šæœ‰åŒºåˆ†åº¦</p></blockquote><p><strong>å¼•ç”³å¦ä¸€ä¸ªé—®é¢˜ï¼šç´¢å¼•åˆ—å‰ç¼€å¯¹æ’åºçš„å½±å“</strong></p><p>å¦‚æœä½¿ç”¨äº†ç´¢å¼•åˆ—å‰ç¼€ï¼Œæ¯”æ–¹è¯´å‰è¾¹åªæŠŠaddressåˆ—çš„ <code>å‰12ä¸ªå­—ç¬¦</code> æ”¾åˆ°äº†äºŒçº§ç´¢å¼•ä¸­ï¼Œä¸‹è¾¹è¿™ä¸ªæŸ¥è¯¢å¯èƒ½å°±æœ‰ç‚¹å°´å°¬äº†ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM shop</span><br><span class="line">ORDER BY address</span><br><span class="line">LIMIT 12;</span><br></pre></td></tr></table></figure><p>å› ä¸ºäºŒçº§ç´¢å¼•ä¸­ä¸åŒ…å«å®Œæ•´çš„addressåˆ—ä¿¡æ¯ï¼Œæ‰€ä»¥æ— æ³•å¯¹å‰12ä¸ªå­—ç¬¦ç›¸åŒï¼Œåè¾¹çš„å­—ç¬¦ä¸åŒçš„è®°å½•è¿›è¡Œæ’åºï¼Œä¹Ÿå°±æ˜¯ä½¿ç”¨ç´¢å¼•åˆ—å‰ç¼€çš„æ–¹å¼ <code>æ— æ³•æ”¯æŒä½¿ç”¨ç´¢å¼•æ’åº</code> ï¼Œåªèƒ½ä½¿ç”¨æ–‡ä»¶æ’åºã€‚</p><p><strong>æ‹“å±•ï¼šAlibabaã€ŠJavaå¼€å‘æ‰‹å†Œã€‹</strong></p><p>ã€ å¼ºåˆ¶ ã€‘åœ¨ varchar å­—æ®µä¸Šå»ºç«‹ç´¢å¼•æ—¶ï¼Œå¿…é¡»æŒ‡å®šç´¢å¼•é•¿åº¦ï¼Œæ²¡å¿…è¦å¯¹å…¨å­—æ®µå»ºç«‹ç´¢å¼•ï¼Œæ ¹æ®å®é™…æ–‡æœ¬ åŒºåˆ†åº¦å†³å®šç´¢å¼•é•¿åº¦ã€‚ </p><p>è¯´æ˜ï¼šç´¢å¼•çš„é•¿åº¦ä¸åŒºåˆ†åº¦æ˜¯ä¸€å¯¹çŸ›ç›¾ä½“ï¼Œä¸€èˆ¬å¯¹å­—ç¬¦ä¸²ç±»å‹æ•°æ®ï¼Œé•¿åº¦ä¸º 20 çš„ç´¢å¼•ï¼ŒåŒºåˆ†åº¦ä¼šé«˜è¾¾ 90% ä»¥ä¸Š ï¼Œå¯ä»¥ä½¿ç”¨ count(distinct left(åˆ—å, ç´¢å¼•é•¿åº¦))&#x2F;count(*)çš„åŒºåˆ†åº¦æ¥ç¡®å®šã€‚</p><h4 id="9-åŒºåˆ†åº¦é«˜-æ•£åˆ—æ€§é«˜-çš„åˆ—é€‚åˆä½œä¸ºç´¢å¼•"><a href="#9-åŒºåˆ†åº¦é«˜-æ•£åˆ—æ€§é«˜-çš„åˆ—é€‚åˆä½œä¸ºç´¢å¼•" class="headerlink" title="9. åŒºåˆ†åº¦é«˜(æ•£åˆ—æ€§é«˜)çš„åˆ—é€‚åˆä½œä¸ºç´¢å¼•"></a>9. åŒºåˆ†åº¦é«˜(æ•£åˆ—æ€§é«˜)çš„åˆ—é€‚åˆä½œä¸ºç´¢å¼•</h4><p><code>åˆ—çš„åŸºæ•°</code> æŒ‡çš„æ˜¯æŸä¸€åˆ—ä¸­ä¸é‡å¤æ•°æ®çš„ä¸ªæ•°ï¼Œæ¯”æ–¹è¯´æŸä¸ªåˆ—åŒ…å«å€¼ <code>2, 5, 8, 2, 5, 8, 2, 5, 8</code>ï¼Œè™½ç„¶æœ‰<code>9</code>æ¡è®°å½•ï¼Œä½†è¯¥åˆ—çš„åŸºæ•°å´æ˜¯3ã€‚ä¹Ÿå°±æ˜¯è¯´<strong>åœ¨è®°å½•è¡Œæ•°ä¸€å®šçš„æƒ…å†µä¸‹ï¼Œåˆ—çš„åŸºæ•°è¶Šå¤§ï¼Œè¯¥åˆ—ä¸­çš„å€¼è¶Šåˆ†æ•£ï¼›åˆ—çš„åŸºæ•°è¶Šå°ï¼Œè¯¥åˆ—ä¸­çš„å€¼è¶Šé›†ä¸­ã€‚</strong>è¿™ä¸ªåˆ—çš„åŸºæ•°æŒ‡æ ‡éå¸¸é‡è¦ï¼Œç›´æ¥å½±å“æˆ‘ä»¬æ˜¯å¦èƒ½æœ‰æ•ˆçš„åˆ©ç”¨ç´¢å¼•ã€‚æœ€å¥½ä¸ºåˆ—çš„åŸºæ•°å¤§çš„åˆ—ç®€å†ç´¢å¼•ï¼Œä¸ºåŸºæ•°å¤ªå°çš„åˆ—çš„ç®€å†ç´¢å¼•æ•ˆæœå¯èƒ½ä¸å¥½ã€‚</p><p>å¯ä»¥ä½¿ç”¨å…¬å¼<code>select count(distinct a) / count(*) from t1</code> è®¡ç®—åŒºåˆ†åº¦ï¼Œè¶Šæ¥è¿‘1è¶Šå¥½ï¼Œä¸€èˆ¬è¶…è¿‡33%å°±ç®—æ¯”è¾ƒé«˜æ•ˆçš„ç´¢å¼•äº†ã€‚</p><p>æ‰©å±•ï¼šè”åˆç´¢å¼•æŠŠåŒºåˆ†åº¦æ(æ•£åˆ—æ€§é«˜)çš„åˆ—æ”¾åœ¨å‰é¢ã€‚</p><h4 id="10-ä½¿ç”¨æœ€é¢‘ç¹çš„åˆ—æ”¾åˆ°è”åˆç´¢å¼•çš„å·¦ä¾§"><a href="#10-ä½¿ç”¨æœ€é¢‘ç¹çš„åˆ—æ”¾åˆ°è”åˆç´¢å¼•çš„å·¦ä¾§" class="headerlink" title="10. ä½¿ç”¨æœ€é¢‘ç¹çš„åˆ—æ”¾åˆ°è”åˆç´¢å¼•çš„å·¦ä¾§"></a>10. ä½¿ç”¨æœ€é¢‘ç¹çš„åˆ—æ”¾åˆ°è”åˆç´¢å¼•çš„å·¦ä¾§</h4><p>è¿™æ ·ä¹Ÿå¯ä»¥è¾ƒå°‘çš„å»ºç«‹ä¸€äº›ç´¢å¼•ã€‚åŒæ—¶ï¼Œç”±äºâ€æœ€å·¦å‰ç¼€åŸåˆ™â€ï¼Œå¯ä»¥å¢åŠ è”åˆç´¢å¼•çš„ä½¿ç”¨ç‡ã€‚</p><h4 id="11-åœ¨å¤šä¸ªå­—æ®µéƒ½è¦åˆ›å»ºç´¢å¼•çš„æƒ…å†µä¸‹ï¼Œè”åˆç´¢å¼•ä¼˜äºå•å€¼ç´¢å¼•"><a href="#11-åœ¨å¤šä¸ªå­—æ®µéƒ½è¦åˆ›å»ºç´¢å¼•çš„æƒ…å†µä¸‹ï¼Œè”åˆç´¢å¼•ä¼˜äºå•å€¼ç´¢å¼•" class="headerlink" title="11. åœ¨å¤šä¸ªå­—æ®µéƒ½è¦åˆ›å»ºç´¢å¼•çš„æƒ…å†µä¸‹ï¼Œè”åˆç´¢å¼•ä¼˜äºå•å€¼ç´¢å¼•"></a>11. åœ¨å¤šä¸ªå­—æ®µéƒ½è¦åˆ›å»ºç´¢å¼•çš„æƒ…å†µä¸‹ï¼Œè”åˆç´¢å¼•ä¼˜äºå•å€¼ç´¢å¼•</h4><h3 id="3-3-é™åˆ¶ç´¢å¼•çš„æ•°ç›®"><a href="#3-3-é™åˆ¶ç´¢å¼•çš„æ•°ç›®" class="headerlink" title="3.3 é™åˆ¶ç´¢å¼•çš„æ•°ç›®"></a>3.3 é™åˆ¶ç´¢å¼•çš„æ•°ç›®</h3><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220627151947786.png" class=""><h3 id="3-4-å“ªäº›æƒ…å†µä¸é€‚åˆåˆ›å»ºç´¢å¼•"><a href="#3-4-å“ªäº›æƒ…å†µä¸é€‚åˆåˆ›å»ºç´¢å¼•" class="headerlink" title="3.4 å“ªäº›æƒ…å†µä¸é€‚åˆåˆ›å»ºç´¢å¼•"></a>3.4 å“ªäº›æƒ…å†µä¸é€‚åˆåˆ›å»ºç´¢å¼•</h3><h4 id="1-åœ¨whereä¸­ä½¿ç”¨ä¸åˆ°çš„å­—æ®µï¼Œä¸è¦è®¾ç½®ç´¢å¼•"><a href="#1-åœ¨whereä¸­ä½¿ç”¨ä¸åˆ°çš„å­—æ®µï¼Œä¸è¦è®¾ç½®ç´¢å¼•" class="headerlink" title="1. åœ¨whereä¸­ä½¿ç”¨ä¸åˆ°çš„å­—æ®µï¼Œä¸è¦è®¾ç½®ç´¢å¼•"></a>1. åœ¨whereä¸­ä½¿ç”¨ä¸åˆ°çš„å­—æ®µï¼Œä¸è¦è®¾ç½®ç´¢å¼•</h4><p>WHEREæ¡ä»¶ (åŒ…æ‹¬ GROUP BYã€ORDER BY) é‡Œç”¨ä¸åˆ°çš„å­—æ®µä¸éœ€è¦åˆ›å»ºç´¢å¼•ï¼Œç´¢å¼•çš„ä»·å€¼æ˜¯å¿«é€Ÿå®šä½ï¼Œå¦‚æœèµ·ä¸åˆ°å®šä½çš„å­—æ®µé€šå¸¸æ˜¯ä¸éœ€è¦åˆ›å»ºç´¢å¼•çš„ã€‚ä¸¾ä¸ªä¾‹å­ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SELECT course_id, student_id, create_time</span><br><span class="line">FROM student_info</span><br><span class="line">WHERE student_id = 41251;</span><br></pre></td></tr></table></figure><p>å› ä¸ºæˆ‘ä»¬æ˜¯æŒ‰ç…§ student_id æ¥è¿›è¡Œæ£€ç´¢çš„ï¼Œæ‰€ä»¥ä¸éœ€è¦å¯¹å…¶ä»–å­—æ®µåˆ›å»ºç´¢å¼•ï¼Œå³ä½¿è¿™äº›å­—æ®µå‡ºç°åœ¨SELECTå­—æ®µä¸­ã€‚</p><h4 id="2-æ•°æ®é‡å°çš„è¡¨æœ€å¥½ä¸è¦ä½¿ç”¨ç´¢å¼•"><a href="#2-æ•°æ®é‡å°çš„è¡¨æœ€å¥½ä¸è¦ä½¿ç”¨ç´¢å¼•" class="headerlink" title="2. æ•°æ®é‡å°çš„è¡¨æœ€å¥½ä¸è¦ä½¿ç”¨ç´¢å¼•"></a>2. æ•°æ®é‡å°çš„è¡¨æœ€å¥½ä¸è¦ä½¿ç”¨ç´¢å¼•</h4><p>å¦‚æœè¡¨è®°å½•å¤ªå°‘ï¼Œæ¯”å¦‚å°‘äº1000ä¸ªï¼Œé‚£ä¹ˆæ˜¯ä¸éœ€è¦åˆ›å»ºç´¢å¼•çš„ã€‚è¡¨è®°å½•å¤ªå°‘ï¼Œæ˜¯å¦åˆ›å»ºç´¢å¼• <code>å¯¹æŸ¥è¯¢æ•ˆç‡çš„å½±å“å¹¶ä¸å¤§</code>ã€‚ç”šè‡³è¯´ï¼ŒæŸ¥è¯¢èŠ±è´¹çš„æ—¶é—´å¯èƒ½æ¯”éå†ç´¢å¼•çš„æ—¶é—´è¿˜è¦çŸ­ï¼Œç´¢å¼•å¯èƒ½ä¸ä¼šäº§ç”Ÿä¼˜åŒ–æ•ˆæœã€‚</p><p>ä¸¾ä¾‹ï¼šåˆ›å»ºè¡¨1ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE t_without_index(</span><br><span class="line">a INT PRIMARY KEY AUTO_INCREMENT,</span><br><span class="line">b INT</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>æä¾›å­˜å‚¨è¿‡ç¨‹1ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#åˆ›å»ºå­˜å‚¨è¿‡ç¨‹</span><br><span class="line">DELIMITER //</span><br><span class="line">CREATE PROCEDURE t_wout_insert()</span><br><span class="line">BEGIN</span><br><span class="line">    DECLARE i INT DEFAULT 1;</span><br><span class="line">    WHILE i &lt;= 900</span><br><span class="line">    DO</span><br><span class="line">        INSERT INTO t_without_index(b) SELECT RAND()*10000;</span><br><span class="line">        SET i = i + 1;</span><br><span class="line">    END WHILE;</span><br><span class="line">    COMMIT;</span><br><span class="line">END //</span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line">#è°ƒç”¨</span><br><span class="line">CALL t_wout_insert()</span><br></pre></td></tr></table></figure><p>åˆ›å»ºè¡¨2ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE t_with_index(</span><br><span class="line">a INT PRIMARY KEY AUTO_INCREMENT,</span><br><span class="line">b INT,</span><br><span class="line">INDEX idx_b(b)</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>åˆ›å»ºå­˜å‚¨è¿‡ç¨‹2ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#åˆ›å»ºå­˜å‚¨è¿‡ç¨‹</span><br><span class="line">DELIMITER //</span><br><span class="line">CREATE PROCEDURE t_with_insert()</span><br><span class="line">BEGIN</span><br><span class="line">    DECLARE i INT DEFAULT 1;</span><br><span class="line">    WHILE i &lt;= 900</span><br><span class="line">    DO</span><br><span class="line">        INSERT INTO t_with_index(b) SELECT RAND()*10000;</span><br><span class="line">        SET i = i + 1;</span><br><span class="line">    END WHILE;</span><br><span class="line">    COMMIT;</span><br><span class="line">END //</span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line">#è°ƒç”¨</span><br><span class="line">CALL t_with_insert();</span><br></pre></td></tr></table></figure><p>æŸ¥è¯¢å¯¹æ¯”ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from t_without_index where b = 9879;</span><br><span class="line">+------+------+</span><br><span class="line">| a | b |</span><br><span class="line">+------+------+</span><br><span class="line">| 1242 | 9879 |</span><br><span class="line">+------+------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from t_with_index where b = 9879;</span><br><span class="line">+-----+------+</span><br><span class="line">| a | b |</span><br><span class="line">+-----+------+</span><br><span class="line">| 112 | 9879 |</span><br><span class="line">+-----+------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure><p>ä½ èƒ½çœ‹åˆ°è¿è¡Œç»“æœç›¸åŒï¼Œä½†æ˜¯åœ¨æ•°æ®é‡ä¸å¤§çš„æƒ…å†µä¸‹ï¼Œç´¢å¼•å°±å‘æŒ¥ä¸å‡ºä½œç”¨äº†ã€‚</p><blockquote><p>ç»“è®ºï¼šåœ¨æ•°æ®è¡¨ä¸­çš„æ•°æ®è¡Œæ•°æ¯”è¾ƒå°‘çš„æƒ…å†µä¸‹ï¼Œæ¯”å¦‚ä¸åˆ° 1000 è¡Œï¼Œæ˜¯ä¸éœ€è¦åˆ›å»ºç´¢å¼•çš„ã€‚</p></blockquote><h4 id="3-æœ‰å¤§é‡é‡å¤æ•°æ®çš„åˆ—ä¸Šä¸è¦å»ºç«‹ç´¢å¼•"><a href="#3-æœ‰å¤§é‡é‡å¤æ•°æ®çš„åˆ—ä¸Šä¸è¦å»ºç«‹ç´¢å¼•" class="headerlink" title="3. æœ‰å¤§é‡é‡å¤æ•°æ®çš„åˆ—ä¸Šä¸è¦å»ºç«‹ç´¢å¼•"></a>3. æœ‰å¤§é‡é‡å¤æ•°æ®çš„åˆ—ä¸Šä¸è¦å»ºç«‹ç´¢å¼•</h4><p>åœ¨æ¡ä»¶è¡¨è¾¾å¼ä¸­ç»å¸¸ç”¨åˆ°çš„ä¸åŒå€¼è¾ƒå¤šçš„åˆ—ä¸Šå»ºç«‹ç´¢å¼•ï¼Œä½†å­—æ®µä¸­å¦‚æœæœ‰å¤§é‡é‡å¤æ•°æ®ï¼Œä¹Ÿä¸ç”¨åˆ›å»ºç´¢å¼•ã€‚æ¯”å¦‚åœ¨å­¦ç”Ÿè¡¨çš„â€æ€§åˆ«â€å­—æ®µä¸Šåªæœ‰â€œç”·â€ä¸â€œå¥³â€ä¸¤ä¸ªä¸åŒå€¼ï¼Œå› æ­¤æ— é¡»å»ºç«‹ç´¢å¼•ã€‚å¦‚æœå»ºç«‹ç´¢å¼•ï¼Œä¸ä½†ä¸ä¼šæé«˜æŸ¥è¯¢æ•ˆç‡ï¼Œåè€Œä¼š<code>ä¸¥é‡é™ä½æ•°æ®æ›´æ–°é€Ÿåº¦</code>ã€‚</p><p>ä¸¾ä¾‹1ï¼šè¦åœ¨ 100 ä¸‡è¡Œæ•°æ®ä¸­æŸ¥æ‰¾å…¶ä¸­çš„ 50 ä¸‡è¡Œï¼ˆæ¯”å¦‚æ€§åˆ«ä¸ºç”·çš„æ•°æ®ï¼‰ï¼Œä¸€æ—¦åˆ›å»ºäº†ç´¢å¼•ï¼Œä½ éœ€è¦å…ˆ è®¿é—® 50 ä¸‡æ¬¡ç´¢å¼•ï¼Œç„¶åå†è®¿é—® 50 ä¸‡æ¬¡æ•°æ®è¡¨ï¼Œè¿™æ ·åŠ èµ·æ¥çš„å¼€é”€æ¯”ä¸ä½¿ç”¨ç´¢å¼•å¯èƒ½è¿˜è¦å¤§ã€‚</p><p>ä¸¾ä¾‹2ï¼šå‡è®¾æœ‰ä¸€ä¸ªå­¦ç”Ÿè¡¨ï¼Œå­¦ç”Ÿæ€»æ•°ä¸º 100 ä¸‡äººï¼Œç”·æ€§åªæœ‰ 10 ä¸ªäººï¼Œä¹Ÿå°±æ˜¯å æ€»äººå£çš„ 10 ä¸‡åˆ†ä¹‹ 1ã€‚</p><p>å­¦ç”Ÿè¡¨ student_gender ç»“æ„å¦‚ä¸‹ã€‚å…¶ä¸­æ•°æ®è¡¨ä¸­çš„ student_gender å­—æ®µå–å€¼ä¸º 0 æˆ– 1ï¼Œ0 ä»£è¡¨å¥³æ€§ï¼Œ1 ä»£è¡¨ç”·æ€§ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE student_gender(</span><br><span class="line">    student_id INT(11) NOT NULL,</span><br><span class="line">    student_name VARCHAR(50) NOT NULL,</span><br><span class="line">    student_gender TINYINT(1) NOT NULL,</span><br><span class="line">    PRIMARY KEY(student_id)</span><br><span class="line">)ENGINE = INNODB;</span><br></pre></td></tr></table></figure><p>å¦‚æœæˆ‘ä»¬è¦ç­›é€‰å‡ºè¿™ä¸ªå­¦ç”Ÿè¡¨ä¸­çš„ç”·æ€§ï¼Œå¯ä»¥ä½¿ç”¨ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM student_gender WHERE student_gender = 1;</span><br></pre></td></tr></table></figure><blockquote><p>ç»“è®ºï¼šå½“æ•°æ®é‡å¤åº¦å¤§ï¼Œæ¯”å¦‚ é«˜äº 10% çš„æ—¶å€™ï¼Œä¹Ÿä¸éœ€è¦å¯¹è¿™ä¸ªå­—æ®µä½¿ç”¨ç´¢å¼•ã€‚</p></blockquote><h4 id="4-é¿å…å¯¹ç»å¸¸æ›´æ–°çš„è¡¨åˆ›å»ºè¿‡å¤šçš„ç´¢å¼•"><a href="#4-é¿å…å¯¹ç»å¸¸æ›´æ–°çš„è¡¨åˆ›å»ºè¿‡å¤šçš„ç´¢å¼•" class="headerlink" title="4.  é¿å…å¯¹ç»å¸¸æ›´æ–°çš„è¡¨åˆ›å»ºè¿‡å¤šçš„ç´¢å¼•"></a>4.  é¿å…å¯¹ç»å¸¸æ›´æ–°çš„è¡¨åˆ›å»ºè¿‡å¤šçš„ç´¢å¼•</h4><p>ç¬¬ä¸€å±‚å«ä¹‰ï¼šé¢‘ç¹æ›´æ–°çš„å­—æ®µä¸ä¸€å®šè¦åˆ›å»ºç´¢å¼•ã€‚å› ä¸ºæ›´æ–°æ•°æ®çš„æ—¶å€™ï¼Œä¹Ÿéœ€è¦æ›´æ–°ç´¢å¼•ï¼Œå¦‚æœç´¢å¼•å¤ªå¤šï¼Œåœ¨æ›´æ–°ç´¢å¼•çš„æ—¶å€™ä¹Ÿä¼šé€ æˆè´Ÿæ‹…ï¼Œä»è€Œå½±å“æ•ˆç‡ã€‚</p><p>ç¬¬äºŒå±‚å«ä¹‰ï¼šé¿å…å¯¹ç»å¸¸æ›´æ–°çš„è¡¨åˆ›å»ºè¿‡å¤šçš„ç´¢å¼•ï¼Œå¹¶ä¸”ç´¢å¼•ä¸­çš„åˆ—å°½å¯èƒ½å°‘ã€‚æ­¤æ—¶ï¼Œè™½ç„¶æé«˜äº†æŸ¥è¯¢é€Ÿåº¦ï¼ŒåŒæ—¶å´é™ä½æ›´æ–°è¡¨çš„é€Ÿåº¦ã€‚</p><h4 id="5-ä¸å»ºè®®ç”¨æ— åºçš„å€¼ä½œä¸ºç´¢å¼•"><a href="#5-ä¸å»ºè®®ç”¨æ— åºçš„å€¼ä½œä¸ºç´¢å¼•" class="headerlink" title="5. ä¸å»ºè®®ç”¨æ— åºçš„å€¼ä½œä¸ºç´¢å¼•"></a>5. ä¸å»ºè®®ç”¨æ— åºçš„å€¼ä½œä¸ºç´¢å¼•</h4><p>ä¾‹å¦‚èº«ä»½è¯ã€UUID(åœ¨ç´¢å¼•æ¯”è¾ƒæ—¶éœ€è¦è½¬ä¸ºASCIIï¼Œå¹¶ä¸”æ’å…¥æ—¶å¯èƒ½é€ æˆé¡µåˆ†è£‚)ã€MD5ã€HASHã€æ— åºé•¿å­— ç¬¦ä¸²ç­‰ã€‚</p><h4 id="6-åˆ é™¤ä¸å†ä½¿ç”¨æˆ–è€…å¾ˆå°‘ä½¿ç”¨çš„ç´¢å¼•"><a href="#6-åˆ é™¤ä¸å†ä½¿ç”¨æˆ–è€…å¾ˆå°‘ä½¿ç”¨çš„ç´¢å¼•" class="headerlink" title="6. åˆ é™¤ä¸å†ä½¿ç”¨æˆ–è€…å¾ˆå°‘ä½¿ç”¨çš„ç´¢å¼•"></a>6. åˆ é™¤ä¸å†ä½¿ç”¨æˆ–è€…å¾ˆå°‘ä½¿ç”¨çš„ç´¢å¼•</h4><p>è¡¨ä¸­çš„æ•°æ®è¢«å¤§é‡æ›´æ–°ï¼Œæˆ–è€…æ•°æ®çš„ä½¿ç”¨æ–¹å¼è¢«æ”¹å˜åï¼ŒåŸæœ‰çš„ä¸€äº›ç´¢å¼•å¯èƒ½ä¸å†éœ€è¦ã€‚æ•°æ®åº“ç®¡ç†å‘˜åº”å½“å®šæœŸæ‰¾å‡ºè¿™äº›ç´¢å¼•ï¼Œå°†å®ƒä»¬åˆ é™¤ï¼Œä»è€Œå‡å°‘ç´¢å¼•å¯¹æ›´æ–°æ“ä½œçš„å½±å“ã€‚</p><h4 id="7-ä¸è¦å®šä¹‰å¤¯ä½™æˆ–é‡å¤çš„ç´¢å¼•"><a href="#7-ä¸è¦å®šä¹‰å¤¯ä½™æˆ–é‡å¤çš„ç´¢å¼•" class="headerlink" title="7. ä¸è¦å®šä¹‰å¤¯ä½™æˆ–é‡å¤çš„ç´¢å¼•"></a>7. ä¸è¦å®šä¹‰å¤¯ä½™æˆ–é‡å¤çš„ç´¢å¼•</h4><p>â‘  å†—ä½™ç´¢å¼• </p><p>ä¸¾ä¾‹ï¼šå»ºè¡¨è¯­å¥å¦‚ä¸‹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE person_info(</span><br><span class="line">    id INT UNSIGNED NOT NULL AUTO_INCREMENT,</span><br><span class="line">    name VARCHAR(100) NOT NULL,</span><br><span class="line">    birthday DATE NOT NULL,</span><br><span class="line">    phone_number CHAR(11) NOT NULL,</span><br><span class="line">    country varchar(100) NOT NULL,</span><br><span class="line">    PRIMARY KEY (id),</span><br><span class="line">    KEY idx_name_birthday_phone_number (name(10), birthday, phone_number),</span><br><span class="line">    KEY idx_name (name(10))</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬çŸ¥é“ï¼Œé€šè¿‡ idx_name_birthday_phone_number ç´¢å¼•å°±å¯ä»¥å¯¹ name åˆ—è¿›è¡Œå¿«é€Ÿæœç´¢ï¼Œå†åˆ›å»ºä¸€ ä¸ªä¸“é—¨é’ˆå¯¹ name åˆ—çš„ç´¢å¼•å°±ç®—æ˜¯ä¸€ä¸ª å†—ä½™ç´¢å¼• ï¼Œç»´æŠ¤è¿™ä¸ªç´¢å¼•åªä¼šå¢åŠ ç»´æŠ¤çš„æˆæœ¬ï¼Œå¹¶ä¸ä¼šå¯¹æœç´¢æœ‰ ä»€ä¹ˆå¥½å¤„ã€‚</p><p>â‘¡ é‡å¤ç´¢å¼• </p><p>å¦ä¸€ç§æƒ…å†µï¼Œæˆ‘ä»¬å¯èƒ½ä¼šå¯¹æŸä¸ªåˆ— é‡å¤å»ºç«‹ç´¢å¼• ï¼Œæ¯”æ–¹è¯´è¿™æ ·ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE repeat_index_demo (</span><br><span class="line">col1 INT PRIMARY KEY,</span><br><span class="line">col2 INT,</span><br><span class="line">UNIQUE uk_idx_c1 (col1),</span><br><span class="line">INDEX idx_c1 (col1)</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬çœ‹åˆ°ï¼Œcol1 æ—¢æ˜¯ä¸»é”®ã€åˆç»™å®ƒå®šä¹‰ä¸ºä¸€ä¸ªå”¯ä¸€ç´¢å¼•ï¼Œè¿˜ç»™å®ƒå®šä¹‰äº†ä¸€ä¸ªæ™®é€šç´¢å¼•ï¼Œå¯æ˜¯ä¸»é”®æœ¬èº«å°± ä¼šç”Ÿæˆèšç°‡ç´¢å¼•ï¼Œæ‰€ä»¥å®šä¹‰çš„å”¯ä¸€ç´¢å¼•å’Œæ™®é€šç´¢å¼•æ˜¯é‡å¤çš„ï¼Œè¿™ç§æƒ…å†µè¦é¿å…ã€‚</p><h3 id="3-5-å°ç»“"><a href="#3-5-å°ç»“" class="headerlink" title="3.5 å°ç»“"></a>3.5 å°ç»“</h3><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/14.jpg" class=""><h1 id="ç¬¬09ç« -æ€§èƒ½åˆ†æå·¥å…·çš„ä½¿ç”¨"><a href="#ç¬¬09ç« -æ€§èƒ½åˆ†æå·¥å…·çš„ä½¿ç”¨" class="headerlink" title="ç¬¬09ç« _æ€§èƒ½åˆ†æå·¥å…·çš„ä½¿ç”¨"></a>ç¬¬09ç« _æ€§èƒ½åˆ†æå·¥å…·çš„ä½¿ç”¨</h1><p>åœ¨æ•°æ®åº“è°ƒä¼˜ä¸­ï¼Œæˆ‘ä»¬çš„ç›®æ ‡æ˜¯ <code>å“åº”æ—¶é—´æ›´å¿«, ååé‡æ›´å¤§</code> ã€‚åˆ©ç”¨å®è§‚çš„ç›‘æ§å·¥å…·å’Œå¾®è§‚çš„æ—¥å¿—åˆ†æå¯ä»¥å¸®æˆ‘ä»¬å¿«é€Ÿæ‰¾åˆ°è°ƒä¼˜çš„æ€è·¯å’Œæ–¹å¼ã€‚</p><h2 id="1-æ•°æ®åº“æœåŠ¡å™¨çš„ä¼˜åŒ–æ­¥éª¤"><a href="#1-æ•°æ®åº“æœåŠ¡å™¨çš„ä¼˜åŒ–æ­¥éª¤" class="headerlink" title="1. æ•°æ®åº“æœåŠ¡å™¨çš„ä¼˜åŒ–æ­¥éª¤"></a>1. æ•°æ®åº“æœåŠ¡å™¨çš„ä¼˜åŒ–æ­¥éª¤</h2><p>å½“æˆ‘ä»¬é‡åˆ°æ•°æ®åº“è°ƒä¼˜é—®é¢˜çš„æ—¶å€™ï¼Œè¯¥å¦‚ä½•æ€è€ƒå‘¢ï¼Ÿè¿™é‡ŒæŠŠæ€è€ƒçš„æµç¨‹æ•´ç†æˆä¸‹é¢è¿™å¼ å›¾ã€‚</p><p>æ•´ä¸ªæµç¨‹åˆ’åˆ†æˆäº† <code>è§‚å¯Ÿï¼ˆShow statusï¼‰</code> å’Œ <code>è¡ŒåŠ¨ï¼ˆActionï¼‰</code> ä¸¤ä¸ªéƒ¨åˆ†ã€‚å­—æ¯ S çš„éƒ¨åˆ†ä»£è¡¨è§‚å¯Ÿï¼ˆä¼šä½¿ ç”¨ç›¸åº”çš„åˆ†æå·¥å…·ï¼‰ï¼Œå­—æ¯ A ä»£è¡¨çš„éƒ¨åˆ†æ˜¯è¡ŒåŠ¨ï¼ˆå¯¹åº”åˆ†æå¯ä»¥é‡‡å–çš„è¡ŒåŠ¨ï¼‰ã€‚</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220627162248635.png" class=""><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220627162345815.png" class=""><p>æˆ‘ä»¬å¯ä»¥é€šè¿‡è§‚å¯Ÿäº†è§£æ•°æ®åº“æ•´ä½“çš„è¿è¡ŒçŠ¶æ€ï¼Œé€šè¿‡æ€§èƒ½åˆ†æå·¥å…·å¯ä»¥è®©æˆ‘ä»¬äº†è§£æ‰§è¡Œæ…¢çš„SQLéƒ½æœ‰å“ªäº›ï¼ŒæŸ¥çœ‹å…·ä½“çš„SQLæ‰§è¡Œè®¡åˆ’ï¼Œç”šè‡³æ˜¯SQLæ‰§è¡Œä¸­çš„æ¯ä¸€æ­¥çš„æˆæœ¬ä»£ä»·ï¼Œè¿™æ ·æ‰èƒ½å®šä½é—®é¢˜æ‰€åœ¨ï¼Œæ‰¾åˆ°äº†é—®é¢˜ï¼Œå†é‡‡å–ç›¸åº”çš„è¡ŒåŠ¨ã€‚</p><p><strong>è¯¦ç»†è§£é‡Šä¸€ä¸‹è¿™å¼ å›¾ï¼š</strong></p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220627164046438.png" class=""><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220627164114562.png" class=""><h2 id="2-æŸ¥çœ‹ç³»ç»Ÿæ€§èƒ½å‚æ•°"><a href="#2-æŸ¥çœ‹ç³»ç»Ÿæ€§èƒ½å‚æ•°" class="headerlink" title="2. æŸ¥çœ‹ç³»ç»Ÿæ€§èƒ½å‚æ•°"></a>2. æŸ¥çœ‹ç³»ç»Ÿæ€§èƒ½å‚æ•°</h2><p>åœ¨MySQLä¸­ï¼Œå¯ä»¥ä½¿ç”¨ <code>SHOW STATUS</code> è¯­å¥æŸ¥è¯¢ä¸€äº›MySQLæ•°æ®åº“æœåŠ¡å™¨çš„<code>æ€§èƒ½å‚æ•°ã€æ‰§è¡Œé¢‘ç‡</code>ã€‚</p><p>SHOW STATUSè¯­å¥è¯­æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHOW [GLOBAL|SESSION] STATUS LIKE &#x27;å‚æ•°&#x27;;</span><br></pre></td></tr></table></figure><p>ä¸€äº›å¸¸ç”¨çš„æ€§èƒ½å‚æ•°å¦‚ä¸‹ï¼š</p><ul><li>Connectionsï¼šè¿æ¥MySQLæœåŠ¡å™¨çš„æ¬¡æ•°ã€‚ </li><li>Uptimeï¼šMySQLæœåŠ¡å™¨çš„ä¸Šçº¿æ—¶é—´ã€‚ </li><li>Slow_queriesï¼šæ…¢æŸ¥è¯¢çš„æ¬¡æ•°ã€‚ </li><li>Innodb_rows_readï¼šSelectæŸ¥è¯¢è¿”å›çš„è¡Œæ•° </li><li>Innodb_rows_insertedï¼šæ‰§è¡ŒINSERTæ“ä½œæ’å…¥çš„è¡Œæ•° </li><li>Innodb_rows_updatedï¼šæ‰§è¡ŒUPDATEæ“ä½œæ›´æ–°çš„ è¡Œæ•° </li><li>Innodb_rows_deletedï¼šæ‰§è¡ŒDELETEæ“ä½œåˆ é™¤çš„è¡Œæ•° </li><li>Com_selectï¼šæŸ¥è¯¢æ“ä½œçš„æ¬¡æ•°ã€‚ </li><li>Com_insertï¼šæ’å…¥æ“ä½œçš„æ¬¡æ•°ã€‚å¯¹äºæ‰¹é‡æ’å…¥çš„ INSERT æ“ä½œï¼Œåªç´¯åŠ ä¸€æ¬¡ã€‚ </li><li>Com_updateï¼šæ›´æ–°æ“ä½œ çš„æ¬¡æ•°ã€‚ </li><li>Com_deleteï¼šåˆ é™¤æ“ä½œçš„æ¬¡æ•°ã€‚</li></ul><p>è‹¥æŸ¥è¯¢MySQLæœåŠ¡å™¨çš„è¿æ¥æ¬¡æ•°ï¼Œåˆ™å¯ä»¥æ‰§è¡Œå¦‚ä¸‹è¯­å¥:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHOW STATUS LIKE &#x27;Connections&#x27;;</span><br></pre></td></tr></table></figure><p>è‹¥æŸ¥è¯¢æœåŠ¡å™¨å·¥ä½œæ—¶é—´ï¼Œåˆ™å¯ä»¥æ‰§è¡Œå¦‚ä¸‹è¯­å¥:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHOW STATUS LIKE &#x27;Uptime&#x27;;</span><br></pre></td></tr></table></figure><p>è‹¥æŸ¥è¯¢MySQLæœåŠ¡å™¨çš„æ…¢æŸ¥è¯¢æ¬¡æ•°ï¼Œåˆ™å¯ä»¥æ‰§è¡Œå¦‚ä¸‹è¯­å¥:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHOW STATUS LIKE &#x27;Slow_queries&#x27;;</span><br></pre></td></tr></table></figure><p>æ…¢æŸ¥è¯¢æ¬¡æ•°å‚æ•°å¯ä»¥ç»“åˆæ…¢æŸ¥è¯¢æ—¥å¿—æ‰¾å‡ºæ…¢æŸ¥è¯¢è¯­å¥ï¼Œç„¶åé’ˆå¯¹æ…¢æŸ¥è¯¢è¯­å¥è¿›è¡Œ<code>è¡¨ç»“æ„ä¼˜åŒ–</code>æˆ–è€…<code>æŸ¥è¯¢è¯­å¥ä¼˜åŒ–</code>ã€‚</p><p>å†æ¯”å¦‚ï¼Œå¦‚ä¸‹çš„æŒ‡ä»¤å¯ä»¥æŸ¥çœ‹ç›¸å…³çš„æŒ‡ä»¤æƒ…å†µï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHOW STATUS LIKE &#x27;Innodb_rows_%&#x27;;</span><br></pre></td></tr></table></figure><h2 id="3-ç»Ÿè®¡SQLçš„æŸ¥è¯¢æˆæœ¬-last-query-cost"><a href="#3-ç»Ÿè®¡SQLçš„æŸ¥è¯¢æˆæœ¬-last-query-cost" class="headerlink" title="3. ç»Ÿè®¡SQLçš„æŸ¥è¯¢æˆæœ¬: last_query_cost"></a>3. ç»Ÿè®¡SQLçš„æŸ¥è¯¢æˆæœ¬: last_query_cost</h2><p>ä¸€æ¡SQLæŸ¥è¯¢è¯­å¥åœ¨æ‰§è¡Œå‰éœ€è¦æŸ¥è¯¢æ‰§è¡Œè®¡åˆ’ï¼Œå¦‚æœå­˜åœ¨å¤šç§æ‰§è¡Œè®¡åˆ’çš„è¯ï¼ŒMySQLä¼šè®¡ç®—æ¯ä¸ªæ‰§è¡Œè®¡åˆ’æ‰€éœ€è¦çš„æˆæœ¬ï¼Œä»ä¸­é€‰æ‹©<code>æˆæœ¬æœ€å°</code>çš„ä¸€ä¸ªä½œä¸ºæœ€ç»ˆæ‰§è¡Œçš„æ‰§è¡Œè®¡åˆ’ã€‚</p><p>å¦‚æœæˆ‘ä»¬æƒ³è¦æŸ¥çœ‹æŸæ¡SQLè¯­å¥çš„æŸ¥è¯¢æˆæœ¬ï¼Œå¯ä»¥åœ¨æ‰§è¡Œå®Œè¿™æ¡SQLè¯­å¥ä¹‹åï¼Œé€šè¿‡æŸ¥çœ‹å½“å‰ä¼šè¯ä¸­çš„<code>last_query_cost</code>å˜é‡å€¼æ¥å¾—åˆ°å½“å‰æŸ¥è¯¢çš„æˆæœ¬ã€‚å®ƒé€šå¸¸ä¹Ÿæ˜¯æˆ‘ä»¬<code>è¯„ä»·ä¸€ä¸ªæŸ¥è¯¢çš„æ‰§è¡Œæ•ˆç‡</code>çš„ä¸€ä¸ªå¸¸ç”¨æŒ‡æ ‡ã€‚è¿™ä¸ªæŸ¥è¯¢æˆæœ¬å¯¹åº”çš„æ˜¯<code>SQL è¯­å¥æ‰€éœ€è¦è¯»å–çš„è¯»é¡µçš„æ•°é‡</code>ã€‚</p><p>æˆ‘ä»¬ä¾ç„¶ä½¿ç”¨ç¬¬8ç« çš„ student_info è¡¨ä¸ºä¾‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE `student_info` (</span><br><span class="line">    `id` INT(11) NOT NULL AUTO_INCREMENT,</span><br><span class="line">    `student_id` INT NOT NULL ,</span><br><span class="line">    `name` VARCHAR(20) DEFAULT NULL,</span><br><span class="line">    `course_id` INT NOT NULL ,</span><br><span class="line">    `class_id` INT(11) DEFAULT NULL,</span><br><span class="line">    `create_time` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,</span><br><span class="line">    PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=INNODB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8;</span><br></pre></td></tr></table></figure><p>å¦‚æœæˆ‘ä»¬æƒ³è¦æŸ¥è¯¢ id&#x3D;900001 çš„è®°å½•ï¼Œç„¶åçœ‹ä¸‹æŸ¥è¯¢æˆæœ¬ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥åœ¨èšç°‡ç´¢å¼•ä¸Šè¿›è¡ŒæŸ¥æ‰¾ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT student_id, class_id, NAME, create_time FROM student_info WHERE id = 900001;</span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœï¼ˆ1 æ¡è®°å½•ï¼Œè¿è¡Œæ—¶é—´ä¸º 0.042s ï¼‰</p><p>ç„¶åå†çœ‹ä¸‹æŸ¥è¯¢ä¼˜åŒ–å™¨çš„æˆæœ¬ï¼Œå®é™…ä¸Šæˆ‘ä»¬åªéœ€è¦æ£€ç´¢ä¸€ä¸ªé¡µå³å¯ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SHOW STATUS LIKE &#x27;last_query_cost&#x27;;</span><br><span class="line">+-----------------+----------+</span><br><span class="line">| Variable_name   |   Value  |</span><br><span class="line">+-----------------+----------+</span><br><span class="line">| Last_query_cost | 1.000000 |</span><br><span class="line">+-----------------+----------+</span><br></pre></td></tr></table></figure><p>å¦‚æœæˆ‘ä»¬æƒ³è¦æŸ¥è¯¢ id åœ¨ 900001 åˆ° 9000100 ä¹‹é—´çš„å­¦ç”Ÿè®°å½•å‘¢ï¼Ÿ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT student_id, class_id, NAME, create_time FROM student_info WHERE id BETWEEN 900001 AND 900100;</span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœï¼ˆ100 æ¡è®°å½•ï¼Œè¿è¡Œæ—¶é—´ä¸º 0.046s ï¼‰ï¼š </p><p>ç„¶åå†çœ‹ä¸‹æŸ¥è¯¢ä¼˜åŒ–å™¨çš„æˆæœ¬ï¼Œè¿™æ—¶æˆ‘ä»¬å¤§æ¦‚éœ€è¦è¿›è¡Œ 20 ä¸ªé¡µçš„æŸ¥è¯¢ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SHOW STATUS LIKE &#x27;last_query_cost&#x27;;</span><br><span class="line">+-----------------+-----------+</span><br><span class="line">| Variable_name   |   Value   |</span><br><span class="line">+-----------------+-----------+</span><br><span class="line">| Last_query_cost | 21.134453 |</span><br><span class="line">+-----------------+-----------+</span><br></pre></td></tr></table></figure><p>ä½ èƒ½çœ‹åˆ°é¡µçš„æ•°é‡æ˜¯åˆšæ‰çš„ 20 å€ï¼Œä½†æ˜¯æŸ¥è¯¢çš„æ•ˆç‡å¹¶æ²¡æœ‰æ˜æ˜¾çš„å˜åŒ–ï¼Œå®é™…ä¸Šè¿™ä¸¤ä¸ª SQL æŸ¥è¯¢çš„æ—¶é—´ åŸºæœ¬ä¸Šä¸€æ ·ï¼Œå°±æ˜¯å› ä¸ºé‡‡ç”¨äº†é¡ºåºè¯»å–çš„æ–¹å¼å°†é¡µé¢ä¸€æ¬¡æ€§åŠ è½½åˆ°ç¼“å†²æ± ä¸­ï¼Œç„¶åå†è¿›è¡ŒæŸ¥æ‰¾ã€‚è™½ç„¶ é¡µ æ•°é‡ï¼ˆlast_query_costï¼‰å¢åŠ äº†ä¸å°‘ ï¼Œä½†æ˜¯é€šè¿‡ç¼“å†²æ± çš„æœºåˆ¶ï¼Œå¹¶ æ²¡æœ‰å¢åŠ å¤šå°‘æŸ¥è¯¢æ—¶é—´ ã€‚ </p><p><strong>ä½¿ç”¨åœºæ™¯ï¼š</strong>å®ƒå¯¹äºæ¯”è¾ƒå¼€é”€æ˜¯éå¸¸æœ‰ç”¨çš„ï¼Œç‰¹åˆ«æ˜¯æˆ‘ä»¬æœ‰å¥½å‡ ç§æŸ¥è¯¢æ–¹å¼å¯é€‰çš„æ—¶å€™ã€‚</p><blockquote><p>SQLæŸ¥è¯¢æ—¶ä¸€ä¸ªåŠ¨æ€çš„è¿‡ç¨‹ï¼Œä»é¡µåŠ è½½çš„è§’åº¦æ¥çœ‹ï¼Œæˆ‘ä»¬å¯ä»¥å¾—åˆ°ä»¥ä¸‹ä¸¤ç‚¹ç»“è®ºï¼š</p><ol><li><code>ä½ç½®å†³å®šæ•ˆç‡</code>ã€‚å¦‚æœé¡µå°±åœ¨æ•°æ®åº“ <code>ç¼“å†²æ± </code> ä¸­ï¼Œé‚£ä¹ˆæ•ˆç‡æ˜¯æœ€é«˜çš„ï¼Œå¦åˆ™è¿˜éœ€è¦ä» <code>å†…å­˜</code> æˆ–è€… <code>ç£ç›˜</code> ä¸­è¿›è¡Œè¯»å–ï¼Œå½“ç„¶é’ˆå¯¹å•ä¸ªé¡µçš„è¯»å–æ¥è¯´ï¼Œå¦‚æœé¡µå­˜åœ¨äºå†…å­˜ä¸­ï¼Œä¼šæ¯”åœ¨ç£ç›˜ä¸­è¯»å–æ•ˆç‡é«˜å¾ˆå¤šã€‚</li><li><code>æ‰¹é‡å†³å®šæ•ˆç‡</code>ã€‚å¦‚æœæˆ‘ä»¬ä»ç£ç›˜ä¸­å¯¹å•ä¸€é¡µè¿›è¡Œéšæœºè¯»ï¼Œé‚£ä¹ˆæ•ˆç‡æ˜¯å¾ˆä½çš„(å·®ä¸å¤š10ms)ï¼Œè€Œé‡‡ç”¨é¡ºåºè¯»å–çš„æ–¹å¼ï¼Œæ‰¹é‡å¯¹é¡µè¿›è¡Œè¯»å–ï¼Œå¹³å‡ä¸€é¡µçš„è¯»å–æ•ˆç‡å°±ä¼šæå‡å¾ˆå¤šï¼Œç”šè‡³è¦å¿«äºå•ä¸ªé¡µé¢åœ¨å†…å­˜ä¸­çš„éšæœºè¯»å–ã€‚</li></ol><p>æ‰€ä»¥è¯´ï¼Œé‡åˆ°I&#x2F;Oå¹¶ä¸ç”¨æ‹…å¿ƒï¼Œæ–¹æ³•æ‰¾å¯¹äº†ï¼Œæ•ˆç‡è¿˜æ˜¯å¾ˆé«˜çš„ã€‚æˆ‘ä»¬é¦–å…ˆè¦è€ƒè™‘æ•°æ®å­˜æ”¾çš„ä½ç½®ï¼Œå¦‚æœæ˜¯è¿›ç¨‹ä½¿ç”¨çš„æ•°æ®å°±è¦å°½é‡æ”¾åˆ°<code>ç¼“å†²æ± </code>ä¸­ï¼Œå…¶æ¬¡æˆ‘ä»¬å¯ä»¥å……åˆ†åˆ©ç”¨ç£ç›˜çš„ååèƒ½åŠ›ï¼Œä¸€æ¬¡æ€§æ‰¹é‡è¯»å–æ•°æ®ï¼Œè¿™æ ·å•ä¸ªé¡µçš„è¯»å–æ•ˆç‡ä¹Ÿå°±å¾—åˆ°äº†æå‡ã€‚</p></blockquote><h2 id="4-å®šä½æ‰§è¡Œæ…¢çš„-SQLï¼šæ…¢æŸ¥è¯¢æ—¥å¿—"><a href="#4-å®šä½æ‰§è¡Œæ…¢çš„-SQLï¼šæ…¢æŸ¥è¯¢æ—¥å¿—" class="headerlink" title="4. å®šä½æ‰§è¡Œæ…¢çš„ SQLï¼šæ…¢æŸ¥è¯¢æ—¥å¿—"></a>4. å®šä½æ‰§è¡Œæ…¢çš„ SQLï¼šæ…¢æŸ¥è¯¢æ—¥å¿—</h2><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220628173022699.png" class=""><h3 id="4-1-å¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿—å‚æ•°"><a href="#4-1-å¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿—å‚æ•°" class="headerlink" title="4.1 å¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿—å‚æ•°"></a>4.1 å¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿—å‚æ•°</h3><p><strong>1. å¼€å¯ slow_query_log</strong></p><p>åœ¨ä½¿ç”¨å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆæŸ¥ä¸‹æ…¢æŸ¥è¯¢æ˜¯å¦å·²ç»å¼€å¯ï¼Œä½¿ç”¨ä¸‹é¢è¿™æ¡å‘½ä»¤å³å¯ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql &gt; show variables like &#x27;%slow_query_log&#x27;;</span><br></pre></td></tr></table></figure><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220628173525966.png" class=""><p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ° <code>slow_query_log=OFF</code>ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠæ…¢æŸ¥è¯¢æ—¥å¿—æ‰“å¼€ï¼Œæ³¨æ„è®¾ç½®å˜é‡å€¼çš„æ—¶å€™éœ€è¦ä½¿ç”¨ globalï¼Œå¦åˆ™ä¼šæŠ¥é”™ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql &gt; set global slow_query_log=&#x27;ON&#x27;;</span><br></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬å†æ¥æŸ¥çœ‹ä¸‹æ…¢æŸ¥è¯¢æ—¥å¿—æ˜¯å¦å¼€å¯ï¼Œä»¥åŠæ…¢æŸ¥è¯¢æ—¥å¿—æ–‡ä»¶çš„ä½ç½®ï¼š</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220628175226812.png" class=""><p>ä½ èƒ½çœ‹åˆ°è¿™æ—¶æ…¢æŸ¥è¯¢åˆ†æå·²ç»å¼€å¯ï¼ŒåŒæ—¶æ–‡ä»¶ä¿å­˜åœ¨ <code>/var/lib/mysql/atguigu02-slow.log</code> æ–‡ä»¶ ä¸­ã€‚</p><p><strong>2. ä¿®æ”¹ long_query_time é˜ˆå€¼</strong></p><p>æ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹ä¸‹æ…¢æŸ¥è¯¢çš„æ—¶é—´é˜ˆå€¼è®¾ç½®ï¼Œä½¿ç”¨å¦‚ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql &gt; show variables like &#x27;%long_query_time%&#x27;;</span><br></pre></td></tr></table></figure><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220628175353233.png" class=""><p>è¿™é‡Œå¦‚æœæˆ‘ä»¬æƒ³æŠŠæ—¶é—´ç¼©çŸ­ï¼Œæ¯”å¦‚è®¾ç½®ä¸º 1 ç§’ï¼Œå¯ä»¥è¿™æ ·è®¾ç½®ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#æµ‹è¯•å‘ç°ï¼šè®¾ç½®globalçš„æ–¹å¼å¯¹å½“å‰sessionçš„long_query_timeå¤±æ•ˆã€‚å¯¹æ–°è¿æ¥çš„å®¢æˆ·ç«¯æœ‰æ•ˆã€‚æ‰€ä»¥å¯ä»¥ä¸€å¹¶</span><br><span class="line">æ‰§è¡Œä¸‹è¿°è¯­å¥</span><br><span class="line">mysql &gt; set global long_query_time = 1;</span><br><span class="line">mysql&gt; show global variables like &#x27;%long_query_time%&#x27;;</span><br><span class="line"></span><br><span class="line">mysql&gt; set long_query_time=1;</span><br><span class="line">mysql&gt; show variables like &#x27;%long_query_time%&#x27;;</span><br></pre></td></tr></table></figure><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220628175425922.png" class=""><p><strong>è¡¥å……ï¼šé…ç½®æ–‡ä»¶ä¸­ä¸€å¹¶è®¾ç½®å‚æ•°</strong></p><p>å¦‚ä¸‹çš„æ–¹å¼ç›¸è¾ƒäºå‰é¢çš„å‘½ä»¤è¡Œæ–¹å¼ï¼Œå¯ä»¥çœ‹åšæ˜¯æ°¸ä¹…è®¾ç½®çš„æ–¹å¼ã€‚</p><p>ä¿®æ”¹ <code>my.cnf</code> æ–‡ä»¶ï¼Œ[mysqld] ä¸‹å¢åŠ æˆ–ä¿®æ”¹å‚æ•° <code>long_query_timeã€slow_query_log</code> å’Œ <code>slow_query_log_file</code> åï¼Œç„¶åé‡å¯ MySQL æœåŠ¡å™¨ã€‚</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[mysqld]</span></span><br><span class="line"><span class="attr">slow_query_log</span>=<span class="string">ON  # å¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿—å¼€å…³</span></span><br><span class="line"><span class="attr">slow_query_log_file</span>=<span class="string">/var/lib/mysql/atguigu-low.log  # æ…¢æŸ¥è¯¢æ—¥å¿—çš„ç›®å½•å’Œæ–‡ä»¶åä¿¡æ¯</span></span><br><span class="line"><span class="attr">long_query_time</span>=<span class="string">3  # è®¾ç½®æ…¢æŸ¥è¯¢çš„é˜ˆå€¼ä¸º3ç§’ï¼Œè¶…å‡ºæ­¤è®¾å®šå€¼çš„SQLå³è¢«è®°å½•åˆ°æ…¢æŸ¥è¯¢æ—¥å¿—</span></span><br><span class="line"><span class="attr">log_output</span>=<span class="string">FILE</span></span><br></pre></td></tr></table></figure><p>å¦‚æœä¸æŒ‡å®šå­˜å‚¨è·¯å¾„ï¼Œæ…¢æŸ¥è¯¢æ—¥å¿—é»˜è®¤å­˜å‚¨åˆ°MySQLæ•°æ®åº“çš„æ•°æ®æ–‡ä»¶å¤¹ä¸‹ã€‚å¦‚æœä¸æŒ‡å®šæ–‡ä»¶åï¼Œé»˜è®¤æ–‡ä»¶åä¸ºhostname_slow.logã€‚</p><h3 id="4-2-æŸ¥çœ‹æ…¢æŸ¥è¯¢æ•°ç›®"><a href="#4-2-æŸ¥çœ‹æ…¢æŸ¥è¯¢æ•°ç›®" class="headerlink" title="4.2 æŸ¥çœ‹æ…¢æŸ¥è¯¢æ•°ç›®"></a>4.2 æŸ¥çœ‹æ…¢æŸ¥è¯¢æ•°ç›®</h3><p>æŸ¥è¯¢å½“å‰ç³»ç»Ÿä¸­æœ‰å¤šå°‘æ¡æ…¢æŸ¥è¯¢è®°å½•</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHOW GLOBAL STATUS LIKE &#x27;%Slow_queries%&#x27;;</span><br></pre></td></tr></table></figure><h3 id="4-3-æ¡ˆä¾‹æ¼”ç¤º"><a href="#4-3-æ¡ˆä¾‹æ¼”ç¤º" class="headerlink" title="4.3 æ¡ˆä¾‹æ¼”ç¤º"></a>4.3 æ¡ˆä¾‹æ¼”ç¤º</h3><p><strong>æ­¥éª¤1. å»ºè¡¨</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE `student` (</span><br><span class="line">    `id` INT(11) NOT NULL AUTO_INCREMENT,</span><br><span class="line">    `stuno` INT NOT NULL ,</span><br><span class="line">    `name` VARCHAR(20) DEFAULT NULL,</span><br><span class="line">    `age` INT(3) DEFAULT NULL,</span><br><span class="line">    `classId` INT(11) DEFAULT NULL,</span><br><span class="line">    PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=INNODB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8;</span><br></pre></td></tr></table></figure><p><strong>æ­¥éª¤2ï¼šè®¾ç½®å‚æ•° log_bin_trust_function_creators</strong></p><p>åˆ›å»ºå‡½æ•°ï¼Œå‡å¦‚æŠ¥é”™ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">This function has none of DETERMINISTIC......</span><br></pre></td></tr></table></figure><ul><li>å‘½ä»¤å¼€å¯ï¼šå…è®¸åˆ›å»ºå‡½æ•°è®¾ç½®ï¼š</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set global log_bin_trust_function_creators=1; # ä¸åŠ globalåªæ˜¯å½“å‰çª—å£æœ‰æ•ˆã€‚</span><br></pre></td></tr></table></figure><p><strong>æ­¥éª¤3ï¼šåˆ›å»ºå‡½æ•°</strong></p><p>éšæœºäº§ç”Ÿå­—ç¬¦ä¸²ï¼šï¼ˆåŒä¸Šä¸€ç« ï¼‰</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER //</span><br><span class="line">CREATE FUNCTION rand_string(n INT)</span><br><span class="line">RETURNS VARCHAR(255) #è¯¥å‡½æ•°ä¼šè¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²</span><br><span class="line">BEGIN</span><br><span class="line">DECLARE chars_str VARCHAR(100) DEFAULT</span><br><span class="line">&#x27;abcdefghijklmnopqrstuvwxyzABCDEFJHIJKLMNOPQRSTUVWXYZ&#x27;;</span><br><span class="line">DECLARE return_str VARCHAR(255) DEFAULT &#x27;&#x27;;</span><br><span class="line">    DECLARE i INT DEFAULT 0;</span><br><span class="line">    WHILE i &lt; n DO</span><br><span class="line">    SET return_str =CONCAT(return_str,SUBSTRING(chars_str,FLOOR(1+RAND()*52),1));</span><br><span class="line">    SET i = i + 1;</span><br><span class="line">    END WHILE;</span><br><span class="line">    RETURN return_str;</span><br><span class="line">END //</span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line"># æµ‹è¯•</span><br><span class="line">SELECT rand_string(10);</span><br></pre></td></tr></table></figure><p>äº§ç”Ÿéšæœºæ•°å€¼ï¼šï¼ˆåŒä¸Šä¸€ç« ï¼‰</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER //</span><br><span class="line">CREATE FUNCTION rand_num (from_num INT ,to_num INT) RETURNS INT(11)</span><br><span class="line">BEGIN</span><br><span class="line">    DECLARE i INT DEFAULT 0;</span><br><span class="line">    SET i = FLOOR(from_num +RAND()*(to_num - from_num+1)) ;</span><br><span class="line">    RETURN i;</span><br><span class="line">END //</span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line">#æµ‹è¯•ï¼š</span><br><span class="line">SELECT rand_num(10,100);</span><br></pre></td></tr></table></figure><p><strong>æ­¥éª¤4ï¼šåˆ›å»ºå­˜å‚¨è¿‡ç¨‹</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER //</span><br><span class="line">CREATE PROCEDURE insert_stu1( START INT , max_num INT )</span><br><span class="line">BEGIN</span><br><span class="line">DECLARE i INT DEFAULT 0;</span><br><span class="line">    SET autocommit = 0; #è®¾ç½®æ‰‹åŠ¨æäº¤äº‹åŠ¡</span><br><span class="line">    REPEAT #å¾ªç¯</span><br><span class="line">    SET i = i + 1; #èµ‹å€¼</span><br><span class="line">    INSERT INTO student (stuno, NAME ,age ,classId ) VALUES</span><br><span class="line">    ((START+i),rand_string(6),rand_num(10,100),rand_num(10,1000));</span><br><span class="line">    UNTIL i = max_num</span><br><span class="line">    END REPEAT;</span><br><span class="line">    COMMIT; #æäº¤äº‹åŠ¡</span><br><span class="line">END //</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure><p><strong>æ­¥éª¤5ï¼šè°ƒç”¨å­˜å‚¨è¿‡ç¨‹</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#è°ƒç”¨åˆšåˆšå†™å¥½çš„å‡½æ•°, 4000000æ¡è®°å½•,ä»100001å·å¼€å§‹</span><br><span class="line"></span><br><span class="line">CALL insert_stu1(100001,4000000);</span><br></pre></td></tr></table></figure><h3 id="4-4-æµ‹è¯•åŠåˆ†æ"><a href="#4-4-æµ‹è¯•åŠåˆ†æ" class="headerlink" title="4.4 æµ‹è¯•åŠåˆ†æ"></a>4.4 æµ‹è¯•åŠåˆ†æ</h3><p><strong>1. æµ‹è¯•</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT * FROM student WHERE stuno = 3455655;</span><br><span class="line">+---------+---------+--------+------+---------+</span><br><span class="line">|   id    |  stuno  |  name  | age  | classId |</span><br><span class="line">+---------+---------+--------+------+---------+</span><br><span class="line">| 3523633 | 3455655 | oQmLUr |  19  |    39   |</span><br><span class="line">+---------+---------+--------+------+---------+</span><br><span class="line">1 row in set (2.09 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT * FROM student WHERE name = &#x27;oQmLUr&#x27;;</span><br><span class="line">+---------+---------+--------+------+---------+</span><br><span class="line">|   id    |  stuno  |  name  |  age | classId |</span><br><span class="line">+---------+---------+--------+------+---------+</span><br><span class="line">| 1154002 | 1243200 | OQMlUR | 266  |   28    |</span><br><span class="line">| 1405708 | 1437740 | OQMlUR | 245  |   439   |</span><br><span class="line">| 1748070 | 1680092 | OQMlUR | 240  |   414   |</span><br><span class="line">| 2119892 | 2051914 | oQmLUr | 17   |   32    |</span><br><span class="line">| 2893154 | 2825176 | OQMlUR | 245  |   435   |</span><br><span class="line">| 3523633 | 3455655 | oQmLUr | 19   |   39    |</span><br><span class="line">+---------+---------+--------+------+---------+</span><br><span class="line">6 rows in set (2.39 sec)</span><br></pre></td></tr></table></figure><p>ä»ä¸Šé¢çš„ç»“æœå¯ä»¥çœ‹å‡ºæ¥ï¼ŒæŸ¥è¯¢å­¦ç”Ÿç¼–å·ä¸ºâ€œ3455655â€çš„å­¦ç”Ÿä¿¡æ¯èŠ±è´¹æ—¶é—´ä¸º2.09ç§’ã€‚æŸ¥è¯¢å­¦ç”Ÿå§“åä¸º â€œoQmLUrâ€çš„å­¦ç”Ÿä¿¡æ¯èŠ±è´¹æ—¶é—´ä¸º2.39ç§’ã€‚å·²ç»è¾¾åˆ°äº†ç§’çš„æ•°é‡çº§ï¼Œè¯´æ˜ç›®å‰æŸ¥è¯¢æ•ˆç‡æ˜¯æ¯”è¾ƒä½çš„ï¼Œä¸‹é¢ çš„å°èŠ‚æˆ‘ä»¬åˆ†æä¸€ä¸‹åŸå› ã€‚</p><p><strong>2. åˆ†æ</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show status like &#x27;slow_queries&#x27;;</span><br></pre></td></tr></table></figure><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220628195650079.png" class=""><h3 id="4-5-æ…¢æŸ¥è¯¢æ—¥å¿—åˆ†æå·¥å…·ï¼šmysqldumpslow"><a href="#4-5-æ…¢æŸ¥è¯¢æ—¥å¿—åˆ†æå·¥å…·ï¼šmysqldumpslow" class="headerlink" title="4.5 æ…¢æŸ¥è¯¢æ—¥å¿—åˆ†æå·¥å…·ï¼šmysqldumpslow"></a>4.5 æ…¢æŸ¥è¯¢æ—¥å¿—åˆ†æå·¥å…·ï¼šmysqldumpslow</h3><p>åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå¦‚æœè¦æ‰‹å·¥åˆ†ææ—¥å¿—ï¼ŒæŸ¥æ‰¾ã€åˆ†æSQLï¼Œæ˜¾ç„¶æ˜¯ä¸ªä½“åŠ›æ´»ï¼ŒMySQLæä¾›äº†æ—¥å¿—åˆ†æå·¥å…· <code>mysqldumpslow</code> ã€‚</p><p>æŸ¥çœ‹mysqldumpslowçš„å¸®åŠ©ä¿¡æ¯</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">mysqldumpslow</span> <span class="string">--help</span></span><br></pre></td></tr></table></figure><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220628195821440.png" class=""><p>mysqldumpslow å‘½ä»¤çš„å…·ä½“å‚æ•°å¦‚ä¸‹ï¼š</p><ul><li>-a: ä¸å°†æ•°å­—æŠ½è±¡æˆNï¼Œå­—ç¬¦ä¸²æŠ½è±¡æˆS</li><li>-s: æ˜¯è¡¨ç¤ºæŒ‰ç…§ä½•ç§æ–¹å¼æ’åºï¼š<ul><li>c: è®¿é—®æ¬¡æ•° </li><li>l: é”å®šæ—¶é—´ </li><li>r: è¿”å›è®°å½• </li><li>t: æŸ¥è¯¢æ—¶é—´ </li><li>al:å¹³å‡é”å®šæ—¶é—´ </li><li>ar:å¹³å‡è¿”å›è®°å½•æ•° </li><li>at:å¹³å‡æŸ¥è¯¢æ—¶é—´ ï¼ˆé»˜è®¤æ–¹å¼ï¼‰ </li><li>ac:å¹³å‡æŸ¥è¯¢æ¬¡æ•°</li></ul></li><li>-t: å³ä¸ºè¿”å›å‰é¢å¤šå°‘æ¡çš„æ•°æ®ï¼›</li><li>-g: åè¾¹æ­é…ä¸€ä¸ªæ­£åˆ™åŒ¹é…æ¨¡å¼ï¼Œå¤§å°å†™ä¸æ•æ„Ÿçš„ï¼›</li></ul><p>ä¸¾ä¾‹ï¼šæˆ‘ä»¬æƒ³è¦æŒ‰ç…§æŸ¥è¯¢æ—¶é—´æ’åºï¼ŒæŸ¥çœ‹å‰äº”æ¡ SQL è¯­å¥ï¼Œè¿™æ ·å†™å³å¯ï¼š</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">mysqldumpslow</span> <span class="string">-s t -t 5 /var/lib/mysql/atguigu01-slow.log</span></span><br></pre></td></tr></table></figure><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[root@bogon</span> <span class="string">~]# mysqldumpslow -s t -t 5 /var/lib/mysql/atguigu01-slow.log</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Reading</span> <span class="string">mysql slow query log from /var/lib/mysql/atguigu01-slow.log</span></span><br><span class="line"><span class="attr">Count</span>: <span class="string">1 Time=2.39s (2s) Lock=0.00s (0s) Rows=13.0 (13), root[root]@localhost</span></span><br><span class="line"><span class="attr">SELECT</span> <span class="string">* FROM student WHERE name = &#x27;S&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Count</span>: <span class="string">1 Time=2.09s (2s) Lock=0.00s (0s) Rows=2.0 (2), root[root]@localhost</span></span><br><span class="line"><span class="attr">SELECT</span> <span class="string">* FROM student WHERE stuno = N</span></span><br><span class="line"></span><br><span class="line"><span class="attr">Died</span> <span class="string">at /usr/bin/mysqldumpslow line 162, &lt;&gt; chunk 2.</span></span><br></pre></td></tr></table></figure><p><strong>å·¥ä½œå¸¸ç”¨å‚è€ƒï¼š</strong></p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#å¾—åˆ°è¿”å›è®°å½•é›†æœ€å¤šçš„10ä¸ªSQL</span></span><br><span class="line"><span class="attr">mysqldumpslow</span> <span class="string">-s r -t 10 /var/lib/mysql/atguigu-slow.log</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#å¾—åˆ°è®¿é—®æ¬¡æ•°æœ€å¤šçš„10ä¸ªSQL</span></span><br><span class="line"><span class="attr">mysqldumpslow</span> <span class="string">-s c -t 10 /var/lib/mysql/atguigu-slow.log</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#å¾—åˆ°æŒ‰ç…§æ—¶é—´æ’åºçš„å‰10æ¡é‡Œé¢å«æœ‰å·¦è¿æ¥çš„æŸ¥è¯¢è¯­å¥</span></span><br><span class="line"><span class="attr">mysqldumpslow</span> <span class="string">-s t -t 10 -g &quot;left join&quot; /var/lib/mysql/atguigu-slow.log</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">#å¦å¤–å»ºè®®åœ¨ä½¿ç”¨è¿™äº›å‘½ä»¤æ—¶ç»“åˆ | å’Œmore ä½¿ç”¨ ï¼Œå¦åˆ™æœ‰å¯èƒ½å‡ºç°çˆ†å±æƒ…å†µ</span></span><br><span class="line"><span class="attr">mysqldumpslow</span> <span class="string">-s r -t 10 /var/lib/mysql/atguigu-slow.log | more</span></span><br></pre></td></tr></table></figure><h3 id="4-6-å…³é—­æ…¢æŸ¥è¯¢æ—¥å¿—"><a href="#4-6-å…³é—­æ…¢æŸ¥è¯¢æ—¥å¿—" class="headerlink" title="4.6 å…³é—­æ…¢æŸ¥è¯¢æ—¥å¿—"></a>4.6 å…³é—­æ…¢æŸ¥è¯¢æ—¥å¿—</h3><p>MySQLæœåŠ¡å™¨åœæ­¢æ…¢æŸ¥è¯¢æ—¥å¿—åŠŸèƒ½æœ‰ä¸¤ç§æ–¹æ³•ï¼š</p><p><strong>æ–¹å¼1ï¼šæ°¸ä¹…æ€§æ–¹å¼</strong></p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[mysqld]</span></span><br><span class="line"><span class="attr">slow_query_log</span>=<span class="string">OFF</span></span><br></pre></td></tr></table></figure><p>æˆ–è€…ï¼ŒæŠŠslow_query_logä¸€é¡¹æ³¨é‡Šæ‰ æˆ– åˆ é™¤</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">[mysqld]</span></span><br><span class="line"><span class="comment">#slow_query_log =OFF</span></span><br></pre></td></tr></table></figure><p>é‡å¯MySQLæœåŠ¡ï¼Œæ‰§è¡Œå¦‚ä¸‹è¯­å¥æŸ¥è¯¢æ…¢æ—¥å¿—åŠŸèƒ½ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SHOW VARIABLES LIKE &#x27;%slow%&#x27;; #æŸ¥è¯¢æ…¢æŸ¥è¯¢æ—¥å¿—æ‰€åœ¨ç›®å½•</span><br><span class="line">SHOW VARIABLES LIKE &#x27;%long_query_time%&#x27;; #æŸ¥è¯¢è¶…æ—¶æ—¶é•¿</span><br></pre></td></tr></table></figure><p><strong>æ–¹å¼2ï¼šä¸´æ—¶æ€§æ–¹å¼</strong></p><p>ä½¿ç”¨SETè¯­å¥æ¥è®¾ç½®ã€‚ </p><p>ï¼ˆ1ï¼‰åœæ­¢MySQLæ…¢æŸ¥è¯¢æ—¥å¿—åŠŸèƒ½ï¼Œå…·ä½“SQLè¯­å¥å¦‚ä¸‹ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SET GLOBAL slow_query_log=off;</span><br></pre></td></tr></table></figure><p>ï¼ˆ2ï¼‰<strong>é‡å¯MySQLæœåŠ¡</strong>ï¼Œä½¿ç”¨SHOWè¯­å¥æŸ¥è¯¢æ…¢æŸ¥è¯¢æ—¥å¿—åŠŸèƒ½ä¿¡æ¯ï¼Œå…·ä½“SQLè¯­å¥å¦‚ä¸‹ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SHOW VARIABLES LIKE &#x27;%slow%&#x27;;</span><br><span class="line">#ä»¥åŠ</span><br><span class="line">SHOW VARIABLES LIKE &#x27;%long_query_time%&#x27;;</span><br></pre></td></tr></table></figure><h3 id="4-7-åˆ é™¤æ…¢æŸ¥è¯¢æ—¥å¿—"><a href="#4-7-åˆ é™¤æ…¢æŸ¥è¯¢æ—¥å¿—" class="headerlink" title="4.7 åˆ é™¤æ…¢æŸ¥è¯¢æ—¥å¿—"></a>4.7 åˆ é™¤æ…¢æŸ¥è¯¢æ—¥å¿—</h3><p>ä½¿ç”¨SHOWè¯­å¥æ˜¾ç¤ºæ…¢æŸ¥è¯¢æ—¥å¿—ä¿¡æ¯ï¼Œå…·ä½“SQLè¯­å¥å¦‚ä¸‹ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHOW VARIABLES LIKE `slow_query_log%`;</span><br></pre></td></tr></table></figure><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220628203545536.png" class=""><p>ä»æ‰§è¡Œç»“æœå¯ä»¥çœ‹å‡ºï¼Œæ…¢æŸ¥è¯¢æ—¥å¿—çš„ç›®å½•é»˜è®¤ä¸ºMySQLçš„æ•°æ®ç›®å½•ï¼Œåœ¨è¯¥ç›®å½•ä¸‹ <code>æ‰‹åŠ¨åˆ é™¤æ…¢æŸ¥è¯¢æ—¥å¿—æ–‡ä»¶</code> å³å¯ã€‚</p><p>ä½¿ç”¨å‘½ä»¤ <code>mysqladmin flush-logs</code> æ¥é‡æ–°ç”ŸæˆæŸ¥è¯¢æ—¥å¿—æ–‡ä»¶ï¼Œå…·ä½“å‘½ä»¤å¦‚ä¸‹ï¼Œæ‰§è¡Œå®Œæ¯•ä¼šåœ¨æ•°æ®ç›®å½•ä¸‹é‡æ–°ç”Ÿæˆæ…¢æŸ¥è¯¢æ—¥å¿—æ–‡ä»¶ã€‚</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">mysqladmin</span> <span class="string">-uroot -p flush-logs slow</span></span><br></pre></td></tr></table></figure><blockquote><p>æç¤º</p><p>æ…¢æŸ¥è¯¢æ—¥å¿—éƒ½æ˜¯ä½¿ç”¨mysqladmin flush-logså‘½ä»¤æ¥åˆ é™¤é‡å»ºçš„ã€‚ä½¿ç”¨æ—¶ä¸€å®šè¦æ³¨æ„ï¼Œä¸€æ—¦æ‰§è¡Œäº†è¿™ä¸ªå‘½ä»¤ï¼Œæ…¢æŸ¥è¯¢æ—¥å¿—éƒ½åªå­˜åœ¨æ–°çš„æ—¥å¿—æ–‡ä»¶ä¸­ï¼Œå¦‚æœéœ€è¦æ—§çš„æŸ¥è¯¢æ—¥å¿—ï¼Œå°±å¿…é¡»äº‹å…ˆå¤‡ä»½ã€‚</p></blockquote><h2 id="5-æŸ¥çœ‹-SQL-æ‰§è¡Œæˆæœ¬ï¼šSHOW-PROFILE"><a href="#5-æŸ¥çœ‹-SQL-æ‰§è¡Œæˆæœ¬ï¼šSHOW-PROFILE" class="headerlink" title="5. æŸ¥çœ‹ SQL æ‰§è¡Œæˆæœ¬ï¼šSHOW PROFILE"></a>5. æŸ¥çœ‹ SQL æ‰§è¡Œæˆæœ¬ï¼šSHOW PROFILE</h2><p>show profile åœ¨ã€Šé€»è¾‘æ¶æ„ã€‹ç« èŠ‚ä¸­è®²è¿‡ï¼Œè¿™é‡Œä½œä¸ºå¤ä¹ ã€‚</p><p>show profile æ˜¯ MySQL æä¾›çš„å¯ä»¥ç”¨æ¥åˆ†æå½“å‰ä¼šè¯ä¸­ SQL éƒ½åšäº†ä»€ä¹ˆã€æ‰§è¡Œçš„èµ„æºæ¶ˆè€—å·¥å…·çš„æƒ…å†µï¼Œå¯ç”¨äº sql è°ƒä¼˜çš„æµ‹é‡ã€‚<code>é»˜è®¤æƒ…å†µä¸‹å¤„äºå…³é—­çŠ¶æ€</code>ï¼Œå¹¶ä¿å­˜æœ€è¿‘15æ¬¡çš„è¿è¡Œç»“æœã€‚</p><p>æˆ‘ä»¬å¯ä»¥åœ¨ä¼šè¯çº§åˆ«å¼€å¯è¿™ä¸ªåŠŸèƒ½ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql &gt; show variables like &#x27;profiling&#x27;;</span><br></pre></td></tr></table></figure><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220628204922556.png" class=""><p>é€šè¿‡è®¾ç½® profiling&#x3D;â€™ONâ€™ æ¥å¼€å¯ show profile:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql &gt; set profiling = &#x27;ON&#x27;;</span><br></pre></td></tr></table></figure><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220628205029208.png" class=""><p>ç„¶åæ‰§è¡Œç›¸å…³çš„æŸ¥è¯¢è¯­å¥ã€‚æ¥ç€çœ‹ä¸‹å½“å‰ä¼šè¯éƒ½æœ‰å“ªäº› profilesï¼Œä½¿ç”¨ä¸‹é¢è¿™æ¡å‘½ä»¤ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql &gt; show profiles;</span><br></pre></td></tr></table></figure><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220628205243769.png" class=""><p>ä½ èƒ½çœ‹åˆ°å½“å‰ä¼šè¯ä¸€å…±æœ‰ 2 ä¸ªæŸ¥è¯¢ã€‚å¦‚æœæˆ‘ä»¬æƒ³è¦æŸ¥çœ‹æœ€è¿‘ä¸€æ¬¡æŸ¥è¯¢çš„å¼€é”€ï¼Œå¯ä»¥ä½¿ç”¨ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql &gt; show profile;</span><br></pre></td></tr></table></figure><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220628205317257.png" class=""><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show profile cpu,block io for query 2</span><br></pre></td></tr></table></figure><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220628205354230.png" class=""><p>**show profileçš„å¸¸ç”¨æŸ¥è¯¢å‚æ•°ï¼š **</p><p>â‘  ALLï¼šæ˜¾ç¤ºæ‰€æœ‰çš„å¼€é”€ä¿¡æ¯ã€‚ </p><p>â‘¡ BLOCK IOï¼šæ˜¾ç¤ºå—IOå¼€é”€ã€‚ </p><p>â‘¢ CONTEXT SWITCHESï¼šä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€ã€‚ </p><p>â‘£ CPUï¼šæ˜¾ç¤ºCPUå¼€é”€ä¿¡æ¯ã€‚ </p><p>â‘¤ IPCï¼šæ˜¾ç¤ºå‘é€å’Œæ¥æ”¶å¼€é”€ä¿¡æ¯ã€‚</p><p>â‘¥ MEMORYï¼šæ˜¾ç¤ºå†…å­˜å¼€é”€ä¿¡ æ¯ã€‚ </p><p>â‘¦ PAGE FAULTSï¼šæ˜¾ç¤ºé¡µé¢é”™è¯¯å¼€é”€ä¿¡æ¯ã€‚ </p><p>â‘§ SOURCEï¼šæ˜¾ç¤ºå’ŒSource_functionï¼ŒSource_fileï¼Œ Source_lineç›¸å…³çš„å¼€é”€ä¿¡æ¯ã€‚ </p><p>â‘¨ SWAPSï¼šæ˜¾ç¤ºäº¤æ¢æ¬¡æ•°å¼€é”€ä¿¡æ¯ã€‚</p><p><strong>æ—¥å¸¸å¼€å‘éœ€æ³¨æ„çš„ç»“è®ºï¼š</strong></p><p>â‘  <code>converting HEAP to MyISAM</code>: æŸ¥è¯¢ç»“æœå¤ªå¤§ï¼Œå†…å­˜ä¸å¤Ÿï¼Œæ•°æ®å¾€ç£ç›˜ä¸Šæ¬äº†ã€‚ </p><p>â‘¡ <code>Creating tmp table</code>ï¼šåˆ›å»ºä¸´æ—¶è¡¨ã€‚å…ˆæ‹·è´æ•°æ®åˆ°ä¸´æ—¶è¡¨ï¼Œç”¨å®Œåå†åˆ é™¤ä¸´æ—¶è¡¨ã€‚ </p><p>â‘¢ <code>Copying to tmp table on disk</code>ï¼šæŠŠå†…å­˜ä¸­ä¸´æ—¶è¡¨å¤åˆ¶åˆ°ç£ç›˜ä¸Šï¼Œè­¦æƒ•ï¼ </p><p>â‘£ <code>locked</code>ã€‚ </p><p>å¦‚æœåœ¨show profileè¯Šæ–­ç»“æœä¸­å‡ºç°äº†ä»¥ä¸Š4æ¡ç»“æœä¸­çš„ä»»ä½•ä¸€æ¡ï¼Œåˆ™sqlè¯­å¥éœ€è¦ä¼˜åŒ–ã€‚</p><p><strong>æ³¨æ„ï¼š</strong></p><p>ä¸è¿‡SHOW PROFILEå‘½ä»¤å°†è¢«å¯ç”¨ï¼Œæˆ‘ä»¬å¯ä»¥ä» information_schema ä¸­çš„ profiling æ•°æ®è¡¨è¿›è¡ŒæŸ¥çœ‹ã€‚</p><h2 id="6-åˆ†ææŸ¥è¯¢è¯­å¥ï¼šEXPLAIN"><a href="#6-åˆ†ææŸ¥è¯¢è¯­å¥ï¼šEXPLAIN" class="headerlink" title="6. åˆ†ææŸ¥è¯¢è¯­å¥ï¼šEXPLAIN"></a>6. åˆ†ææŸ¥è¯¢è¯­å¥ï¼šEXPLAIN</h2><h3 id="6-1-æ¦‚è¿°"><a href="#6-1-æ¦‚è¿°" class="headerlink" title="6.1 æ¦‚è¿°"></a>6.1 æ¦‚è¿°</h3><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220628210837301.png" class=""><p><strong>1. èƒ½åšä»€ä¹ˆï¼Ÿ</strong></p><ul><li>è¡¨çš„è¯»å–é¡ºåº</li><li>æ•°æ®è¯»å–æ“ä½œçš„æ“ä½œç±»å‹</li><li>å“ªäº›ç´¢å¼•å¯ä»¥ä½¿ç”¨</li><li>å“ªäº›ç´¢å¼•è¢«å®é™…ä½¿ç”¨</li><li>è¡¨ä¹‹é—´çš„å¼•ç”¨</li><li>æ¯å¼ è¡¨æœ‰å¤šå°‘è¡Œè¢«ä¼˜åŒ–å™¨æŸ¥è¯¢</li></ul><p><strong>2. å®˜ç½‘ä»‹ç»</strong></p><p><a href="https://dev.mysql.com/doc/refman/5.7/en/explain-output.html">https://dev.mysql.com/doc/refman/5.7/en/explain-output.html</a> </p><p><a href="https://dev.mysql.com/doc/refman/8.0/en/explain-output.html">https://dev.mysql.com/doc/refman/8.0/en/explain-output.html</a></p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220628211207436.png" class=""><p><strong>3. ç‰ˆæœ¬æƒ…å†µ</strong></p><ul><li>MySQL 5.6.3ä»¥å‰åªèƒ½ EXPLAIN SELECT ï¼›MYSQL 5.6.3ä»¥åå°±å¯ä»¥ EXPLAIN SELECTï¼ŒUPDATEï¼Œ DELETE </li><li>åœ¨5.7ä»¥å‰çš„ç‰ˆæœ¬ä¸­ï¼Œæƒ³è¦æ˜¾ç¤º partitions éœ€è¦ä½¿ç”¨ explain partitions å‘½ä»¤ï¼›æƒ³è¦æ˜¾ç¤º filtered éœ€è¦ä½¿ç”¨ explain extended å‘½ä»¤ã€‚åœ¨5.7ç‰ˆæœ¬åï¼Œé»˜è®¤explainç›´æ¥æ˜¾ç¤ºpartitionså’Œ filteredä¸­çš„ä¿¡æ¯ã€‚</li></ul><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220628211351678.png" class=""><h3 id="6-2-åŸºæœ¬è¯­æ³•"><a href="#6-2-åŸºæœ¬è¯­æ³•" class="headerlink" title="6.2 åŸºæœ¬è¯­æ³•"></a>6.2 åŸºæœ¬è¯­æ³•</h3><p>EXPLAIN æˆ– DESCRIBEè¯­å¥çš„è¯­æ³•å½¢å¼å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN SELECT select_options</span><br><span class="line">æˆ–è€…</span><br><span class="line">DESCRIBE SELECT select_options</span><br></pre></td></tr></table></figure><p>å¦‚æœæˆ‘ä»¬æƒ³çœ‹çœ‹æŸä¸ªæŸ¥è¯¢çš„æ‰§è¡Œè®¡åˆ’çš„è¯ï¼Œå¯ä»¥åœ¨å…·ä½“çš„æŸ¥è¯¢è¯­å¥å‰è¾¹åŠ ä¸€ä¸ª EXPLAIN ï¼Œå°±åƒè¿™æ ·ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; EXPLAIN SELECT 1;</span><br></pre></td></tr></table></figure><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220628212029574.png" class=""><p>EXPLAIN è¯­å¥è¾“å‡ºçš„å„ä¸ªåˆ—çš„ä½œç”¨å¦‚ä¸‹ï¼š</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220628212049096.png" class=""><p>åœ¨è¿™é‡ŒæŠŠå®ƒä»¬éƒ½åˆ—å‡ºæ¥çŸ¥è¯†ä¸ºäº†æè¿°ä¸€ä¸ªè½®å»“ï¼Œè®©å¤§å®¶æœ‰ä¸€ä¸ªå¤§è‡´çš„å°è±¡ã€‚</p><h3 id="6-3-æ•°æ®å‡†å¤‡"><a href="#6-3-æ•°æ®å‡†å¤‡" class="headerlink" title="6.3 æ•°æ®å‡†å¤‡"></a>6.3 æ•°æ®å‡†å¤‡</h3><p><strong>1. å»ºè¡¨</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE s1 (</span><br><span class="line">    id INT AUTO_INCREMENT,</span><br><span class="line">    key1 VARCHAR(100),</span><br><span class="line">    key2 INT,</span><br><span class="line">    key3 VARCHAR(100),</span><br><span class="line">    key_part1 VARCHAR(100),</span><br><span class="line">    key_part2 VARCHAR(100),</span><br><span class="line">    key_part3 VARCHAR(100),</span><br><span class="line">    common_field VARCHAR(100),</span><br><span class="line">    PRIMARY KEY (id),</span><br><span class="line">    INDEX idx_key1 (key1),</span><br><span class="line">    UNIQUE INDEX idx_key2 (key2),</span><br><span class="line">    INDEX idx_key3 (key3),</span><br><span class="line">    INDEX idx_key_part(key_part1, key_part2, key_part3)</span><br><span class="line">) ENGINE=INNODB CHARSET=utf8;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE s2 (</span><br><span class="line">    id INT AUTO_INCREMENT,</span><br><span class="line">    key1 VARCHAR(100),</span><br><span class="line">    key2 INT,</span><br><span class="line">    key3 VARCHAR(100),</span><br><span class="line">    key_part1 VARCHAR(100),</span><br><span class="line">    key_part2 VARCHAR(100),</span><br><span class="line">    key_part3 VARCHAR(100),</span><br><span class="line">    common_field VARCHAR(100),</span><br><span class="line">    PRIMARY KEY (id),</span><br><span class="line">    INDEX idx_key1 (key1),</span><br><span class="line">    UNIQUE INDEX idx_key2 (key2),</span><br><span class="line">    INDEX idx_key3 (key3),</span><br><span class="line">    INDEX idx_key_part(key_part1, key_part2, key_part3)</span><br><span class="line">) ENGINE=INNODB CHARSET=utf8;</span><br></pre></td></tr></table></figure><p><strong>2. è®¾ç½®å‚æ•° log_bin_trust_function_creators</strong></p><p>åˆ›å»ºå‡½æ•°ï¼Œå‡å¦‚æŠ¥é”™ï¼Œéœ€å¼€å¯å¦‚ä¸‹å‘½ä»¤ï¼šå…è®¸åˆ›å»ºå‡½æ•°è®¾ç½®ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set global log_bin_trust_function_creators=1; # ä¸åŠ globalåªæ˜¯å½“å‰çª—å£æœ‰æ•ˆã€‚</span><br></pre></td></tr></table></figure><p><strong>3. åˆ›å»ºå‡½æ•°</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER //</span><br><span class="line">CREATE FUNCTION rand_string1(n INT)</span><br><span class="line">RETURNS VARCHAR(255) #è¯¥å‡½æ•°ä¼šè¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²</span><br><span class="line">BEGIN</span><br><span class="line">DECLARE chars_str VARCHAR(100) DEFAULT</span><br><span class="line">&#x27;abcdefghijklmnopqrstuvwxyzABCDEFJHIJKLMNOPQRSTUVWXYZ&#x27;;</span><br><span class="line">    DECLARE return_str VARCHAR(255) DEFAULT &#x27;&#x27;;</span><br><span class="line">    DECLARE i INT DEFAULT 0;</span><br><span class="line">    WHILE i &lt; n DO</span><br><span class="line">        SET return_str =CONCAT(return_str,SUBSTRING(chars_str,FLOOR(1+RAND()*52),1));</span><br><span class="line">        SET i = i + 1;</span><br><span class="line">    END WHILE;</span><br><span class="line">    RETURN return_str;</span><br><span class="line">END //</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure><p><strong>4. åˆ›å»ºå­˜å‚¨è¿‡ç¨‹</strong></p><p>åˆ›å»ºå¾€s1è¡¨ä¸­æ’å…¥æ•°æ®çš„å­˜å‚¨è¿‡ç¨‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER //</span><br><span class="line">CREATE PROCEDURE insert_s1 (IN min_num INT (10),IN max_num INT (10))</span><br><span class="line">BEGIN</span><br><span class="line">    DECLARE i INT DEFAULT 0;</span><br><span class="line">    SET autocommit = 0;</span><br><span class="line">    REPEAT</span><br><span class="line">    SET i = i + 1;</span><br><span class="line">    INSERT INTO s1 VALUES(</span><br><span class="line">        (min_num + i),</span><br><span class="line">        rand_string1(6),</span><br><span class="line">        (min_num + 30 * i + 5),</span><br><span class="line">        rand_string1(6),</span><br><span class="line">        rand_string1(10),</span><br><span class="line">        rand_string1(5),</span><br><span class="line">        rand_string1(10),</span><br><span class="line">        rand_string1(10));</span><br><span class="line">    UNTIL i = max_num</span><br><span class="line">    END REPEAT;</span><br><span class="line">    COMMIT;</span><br><span class="line">END //</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure><p>åˆ›å»ºå¾€s2è¡¨ä¸­æ’å…¥æ•°æ®çš„å­˜å‚¨è¿‡ç¨‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER //</span><br><span class="line">CREATE PROCEDURE insert_s2 (IN min_num INT (10),IN max_num INT (10))</span><br><span class="line">BEGIN</span><br><span class="line">    DECLARE i INT DEFAULT 0;</span><br><span class="line">    SET autocommit = 0;</span><br><span class="line">    REPEAT</span><br><span class="line">    SET i = i + 1;</span><br><span class="line">    INSERT INTO s2 VALUES(</span><br><span class="line">        (min_num + i),</span><br><span class="line">        rand_string1(6),</span><br><span class="line">        (min_num + 30 * i + 5),</span><br><span class="line">        rand_string1(6),</span><br><span class="line">        rand_string1(10),</span><br><span class="line">        rand_string1(5),</span><br><span class="line">        rand_string1(10),</span><br><span class="line">        rand_string1(10));</span><br><span class="line">    UNTIL i = max_num</span><br><span class="line">    END REPEAT;</span><br><span class="line">    COMMIT;</span><br><span class="line">END //</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure><p><strong>5. è°ƒç”¨å­˜å‚¨è¿‡ç¨‹</strong></p><p>s1è¡¨æ•°æ®çš„æ·»åŠ ï¼šåŠ å…¥1ä¸‡æ¡è®°å½•ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CALL insert_s1(10001,10000);</span><br></pre></td></tr></table></figure><p>s2è¡¨æ•°æ®çš„æ·»åŠ ï¼šåŠ å…¥1ä¸‡æ¡è®°å½•ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CALL insert_s2(10001,10000);</span><br></pre></td></tr></table></figure><h3 id="6-4-EXPLAINå„åˆ—ä½œç”¨"><a href="#6-4-EXPLAINå„åˆ—ä½œç”¨" class="headerlink" title="6.4 EXPLAINå„åˆ—ä½œç”¨"></a>6.4 EXPLAINå„åˆ—ä½œç”¨</h3><p>ä¸ºäº†è®©å¤§å®¶æœ‰æ¯”è¾ƒå¥½çš„ä½“éªŒï¼Œæˆ‘ä»¬è°ƒæ•´äº†ä¸‹ <code>EXPLAIN</code> è¾“å‡ºåˆ—çš„é¡ºåºã€‚</p><h4 id="1-table"><a href="#1-table" class="headerlink" title="1. table"></a>1. table</h4><p>ä¸è®ºæˆ‘ä»¬çš„æŸ¥è¯¢è¯­å¥æœ‰å¤šå¤æ‚ï¼Œé‡Œè¾¹å„¿ åŒ…å«äº†å¤šå°‘ä¸ªè¡¨ ï¼Œåˆ°æœ€åä¹Ÿæ˜¯éœ€è¦å¯¹æ¯ä¸ªè¡¨è¿›è¡Œ å•è¡¨è®¿é—® çš„ï¼Œæ‰€ ä»¥MySQLè§„å®šEXPLAINè¯­å¥è¾“å‡ºçš„æ¯æ¡è®°å½•éƒ½å¯¹åº”ç€æŸä¸ªå•è¡¨çš„è®¿é—®æ–¹æ³•ï¼Œè¯¥æ¡è®°å½•çš„tableåˆ—ä»£è¡¨ç€è¯¥ è¡¨çš„è¡¨åï¼ˆæœ‰æ—¶ä¸æ˜¯çœŸå®çš„è¡¨åå­—ï¼Œå¯èƒ½æ˜¯ç®€ç§°ï¼‰ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql &gt; EXPLAIN SELECT * FROM s1;</span><br></pre></td></tr></table></figure><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220628221143339.png" class=""><p>è¿™ä¸ªæŸ¥è¯¢è¯­å¥åªæ¶‰åŠå¯¹s1è¡¨çš„å•è¡¨æŸ¥è¯¢ï¼Œæ‰€ä»¥ <code>EXPLAIN</code> è¾“å‡ºä¸­åªæœ‰ä¸€æ¡è®°å½•ï¼Œå…¶ä¸­çš„tableåˆ—çš„å€¼ä¸ºs1ï¼Œè¡¨æ˜è¿™æ¡è®°å½•æ˜¯ç”¨æ¥è¯´æ˜å¯¹s1è¡¨çš„å•è¡¨è®¿é—®æ–¹æ³•çš„ã€‚</p><p>ä¸‹è¾¹æˆ‘ä»¬çœ‹ä¸€ä¸ªè¿æ¥æŸ¥è¯¢çš„æ‰§è¡Œè®¡åˆ’</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql &gt; EXPLAIN SELECT * FROM s1 INNER JOIN s2;</span><br></pre></td></tr></table></figure><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220628221414097.png" class=""><p>å¯ä»¥çœ‹å‡ºè¿™ä¸ªè¿æ¥æŸ¥è¯¢çš„æ‰§è¡Œè®¡åˆ’ä¸­æœ‰ä¸¤æ¡è®°å½•ï¼Œè¿™ä¸¤æ¡è®°å½•çš„tableåˆ—åˆ†åˆ«æ˜¯s1å’Œs2ï¼Œè¿™ä¸¤æ¡è®°å½•ç”¨æ¥åˆ†åˆ«è¯´æ˜å¯¹s1è¡¨å’Œs2è¡¨çš„è®¿é—®æ–¹æ³•æ˜¯ä»€ä¹ˆã€‚</p><h4 id="2-id"><a href="#2-id" class="headerlink" title="2. id"></a>2. id</h4><p>æˆ‘ä»¬å†™çš„æŸ¥è¯¢è¯­å¥ä¸€èˆ¬éƒ½ä»¥ SELECT å…³é”®å­—å¼€å¤´ï¼Œæ¯”è¾ƒç®€å•çš„æŸ¥è¯¢è¯­å¥é‡Œåªæœ‰ä¸€ä¸ª SELECT å…³é”®å­—ï¼Œæ¯” å¦‚ä¸‹è¾¹è¿™ä¸ªæŸ¥è¯¢è¯­å¥ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM s1 WHERE key1 = &#x27;a&#x27;;</span><br></pre></td></tr></table></figure><p>ç¨å¾®å¤æ‚ä¸€ç‚¹çš„è¿æ¥æŸ¥è¯¢ä¸­ä¹Ÿåªæœ‰ä¸€ä¸ª SELECT å…³é”®å­—ï¼Œæ¯”å¦‚ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM s1 INNER JOIN s2</span><br><span class="line">ON s1.key1 = s2.key1</span><br><span class="line">WHERE s1.common_field = &#x27;a&#x27;;</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯ä¸‹è¾¹ä¸¤ç§æƒ…å†µä¸‹åœ¨ä¸€æ¡æŸ¥è¯¢è¯­å¥ä¸­ä¼šå‡ºç°å¤šä¸ªSELECTå…³é”®å­—ï¼š</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220628221948512.png" class=""><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql &gt; EXPLAIN SELECT * FROM s1 WHERE key1 = &#x27;a&#x27;;</span><br></pre></td></tr></table></figure><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220628222055716.png" class=""><p>å¯¹äºè¿æ¥æŸ¥è¯¢æ¥è¯´ï¼Œä¸€ä¸ªSELECTå…³é”®å­—åè¾¹çš„FROMå­—å¥ä¸­å¯ä»¥è·Ÿéšå¤šä¸ªè¡¨ï¼Œæ‰€ä»¥åœ¨è¿æ¥æŸ¥è¯¢çš„æ‰§è¡Œè®¡åˆ’ä¸­ï¼Œæ¯ä¸ªè¡¨éƒ½ä¼šå¯¹åº”ä¸€æ¡è®°å½•ï¼Œä½†æ˜¯è¿™äº›è®°å½•çš„idå€¼éƒ½æ˜¯ç›¸åŒçš„ï¼Œæ¯”å¦‚ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; EXPLAIN SELECT * FROM s1 INNER JOIN s2;</span><br></pre></td></tr></table></figure><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220628222251309.png" class=""><p>å¯ä»¥çœ‹åˆ°ï¼Œä¸Šè¿°è¿æ¥æŸ¥è¯¢ä¸­å‚ä¸è¿æ¥çš„s1å’Œs2è¡¨åˆ†åˆ«å¯¹åº”ä¸€æ¡è®°å½•ï¼Œä½†æ˜¯è¿™ä¸¤æ¡è®°å½•å¯¹åº”çš„<code>id</code>éƒ½æ˜¯1ã€‚è¿™é‡Œéœ€è¦å¤§å®¶è®°ä½çš„æ˜¯ï¼Œ<strong>åœ¨è¿æ¥æŸ¥è¯¢çš„æ‰§è¡Œè®¡åˆ’ä¸­ï¼Œæ¯ä¸ªè¡¨éƒ½ä¼šå¯¹åº”ä¸€æ¡è®°å½•ï¼Œè¿™äº›è®°å½•çš„idåˆ—çš„å€¼æ˜¯ç›¸åŒçš„</strong>ï¼Œå‡ºç°åœ¨å‰è¾¹çš„è¡¨è¡¨ç¤º<code>é©±åŠ¨è¡¨</code>ï¼Œå‡ºç°åœ¨åé¢çš„è¡¨è¡¨ç¤º<code>è¢«é©±åŠ¨è¡¨</code>ã€‚æ‰€ä»¥ä»ä¸Šè¾¹çš„EXPLAINè¾“å‡ºä¸­æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒæŸ¥è¯¢ä¼˜åŒ–å™¨å‡†å¤‡è®©s1è¡¨ä½œä¸ºé©±åŠ¨è¡¨ï¼Œè®©s2è¡¨ä½œä¸ºè¢«é©±åŠ¨è¡¨æ¥æ‰§è¡ŒæŸ¥è¯¢ã€‚</p><p>å¯¹äºåŒ…å«å­æŸ¥è¯¢çš„æŸ¥è¯¢è¯­å¥æ¥è¯´ï¼Œå°±å¯èƒ½æ¶‰åŠå¤šä¸ª<code>SELECT</code>å…³é”®å­—ï¼Œæ‰€ä»¥åœ¨**åŒ…å«å­æŸ¥è¯¢çš„æŸ¥è¯¢è¯­å¥çš„æ‰§è¡Œè®¡åˆ’ä¸­ï¼Œæ¯ä¸ª<code>SELECT</code>å…³é”®å­—éƒ½ä¼šå¯¹åº”ä¸€ä¸ªå”¯ä¸€çš„idå€¼ï¼Œæ¯”å¦‚è¿™æ ·ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; EXPLAIN SELECT * FROM s1 WHERE key1 IN (SELECT key1 FROM s2) OR key3 = &#x27;a&#x27;;</span><br></pre></td></tr></table></figure><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220629165122837.png" class=""><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220629170848349.png" class=""><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># æŸ¥è¯¢ä¼˜åŒ–å™¨å¯èƒ½å¯¹æ¶‰åŠå­æŸ¥è¯¢çš„æŸ¥è¯¢è¯­å¥è¿›è¡Œé‡å†™ï¼Œè½¬å˜ä¸ºå¤šè¡¨æŸ¥è¯¢çš„æ“ä½œã€‚  </span><br><span class="line">mysql&gt; EXPLAIN SELECT * FROM s1 WHERE key1 IN (SELECT key2 FROM s2 WHERE common_field = &#x27;a&#x27;);</span><br></pre></td></tr></table></figure><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220629165603072.png" class=""><p>å¯ä»¥çœ‹åˆ°ï¼Œè™½ç„¶æˆ‘ä»¬çš„æŸ¥è¯¢è¯­å¥æ˜¯ä¸€ä¸ªå­æŸ¥è¯¢ï¼Œä½†æ˜¯æ‰§è¡Œè®¡åˆ’ä¸­s1å’Œs2è¡¨å¯¹åº”çš„è®°å½•çš„<code>id</code>å€¼å…¨éƒ¨æ˜¯1ï¼Œè¿™å°±è¡¨æ˜<code>æŸ¥è¯¢ä¼˜åŒ–å™¨å°†å­æŸ¥è¯¢è½¬æ¢ä¸ºäº†è¿æ¥æŸ¥è¯¢</code>ã€‚</p><p>å¯¹äºåŒ…å«<code>UNION</code>å­å¥çš„æŸ¥è¯¢è¯­å¥æ¥è¯´ï¼Œæ¯ä¸ª<code>SELECT</code>å…³é”®å­—å¯¹åº”ä¸€ä¸ª<code>id</code>å€¼ä¹Ÿæ˜¯æ²¡é”™çš„ï¼Œä¸è¿‡è¿˜æ˜¯æœ‰ç‚¹å„¿ç‰¹åˆ«çš„ä¸œè¥¿ï¼Œæ¯”æ–¹è¯´ä¸‹è¾¹çš„æŸ¥è¯¢ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># Unionå»é‡</span><br><span class="line">mysql&gt; EXPLAIN SELECT * FROM s1 UNION SELECT * FROM s2;</span><br></pre></td></tr></table></figure><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220629165909340.png" class=""><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220629171104375.png" class=""><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; EXPLAIN SELECT * FROM s1 UNION ALL SELECT * FROM s2;</span><br></pre></td></tr></table></figure><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220629171138065.png" class=""><p><strong>å°ç»“:</strong></p><ul><li>idå¦‚æœç›¸åŒï¼Œå¯ä»¥è®¤ä¸ºæ˜¯ä¸€ç»„ï¼Œä»ä¸Šå¾€ä¸‹é¡ºåºæ‰§è¡Œ </li><li>åœ¨æ‰€æœ‰ç»„ä¸­ï¼Œidå€¼è¶Šå¤§ï¼Œä¼˜å…ˆçº§è¶Šé«˜ï¼Œè¶Šå…ˆæ‰§è¡Œ </li><li>å…³æ³¨ç‚¹ï¼šidå·æ¯ä¸ªå·ç ï¼Œè¡¨ç¤ºä¸€è¶Ÿç‹¬ç«‹çš„æŸ¥è¯¢, ä¸€ä¸ªsqlçš„æŸ¥è¯¢è¶Ÿæ•°è¶Šå°‘è¶Šå¥½</li></ul><h4 id="3-select-type"><a href="#3-select-type" class="headerlink" title="3. select_type"></a>3. select_type</h4><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220629171611716.png" class=""><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220629171442624.png" class=""><p>å…·ä½“åˆ†æå¦‚ä¸‹ï¼š</p><ul><li><p>SIMPLE</p><p>æŸ¥è¯¢è¯­å¥ä¸­ä¸åŒ…å«<code>UNION</code>æˆ–è€…å­æŸ¥è¯¢çš„æŸ¥è¯¢éƒ½ç®—ä½œæ˜¯<code>SIMPLE</code>ç±»å‹ï¼Œæ¯”æ–¹è¯´ä¸‹è¾¹è¿™ä¸ªå•è¡¨æŸ¥è¯¢<code>select_type</code>çš„å€¼å°±æ˜¯<code>SIMPLE</code>:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; EXPLAIN SELECT * FROM s1;</span><br></pre></td></tr></table></figure></li></ul><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220629171840300.png" class=""><p>â€‹        å½“ç„¶ï¼Œè¿æ¥æŸ¥è¯¢ä¹Ÿç®—æ˜¯ SIMPLE ç±»å‹ï¼Œæ¯”å¦‚ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; EXPLAIN SELECT * FROM s1 INNER JOIN s2;</span><br></pre></td></tr></table></figure><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220629171904912.png" class=""><ul><li><p>PRIMARY</p><p>å¯¹äºåŒ…å«<code>UNIONã€UNION ALL</code>æˆ–è€…å­æŸ¥è¯¢çš„å¤§æŸ¥è¯¢æ¥è¯´ï¼Œå®ƒæ˜¯ç”±å‡ ä¸ªå°æŸ¥è¯¢ç»„æˆçš„ï¼Œå…¶ä¸­æœ€å·¦è¾¹çš„é‚£ä¸ªæŸ¥è¯¢çš„<code>select_type</code>çš„å€¼å°±æ˜¯<code>PRIMARY</code>,æ¯”æ–¹è¯´ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; EXPLAIN SELECT * FROM s1 UNION SELECT * FROM s2;</span><br></pre></td></tr></table></figure></li></ul><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220629171929924.png" class=""><p>  ä»ç»“æœä¸­å¯ä»¥çœ‹åˆ°ï¼Œæœ€å·¦è¾¹çš„å°æŸ¥è¯¢<code>SELECT * FROM s1</code>å¯¹åº”çš„æ˜¯æ‰§è¡Œè®¡åˆ’ä¸­çš„ç¬¬ä¸€æ¡è®°å½•ï¼Œå®ƒçš„<code>select_type</code>çš„å€¼å°±æ˜¯<code>PRIMARY</code>ã€‚</p><ul><li><p>UNION</p><p>å¯¹äºåŒ…å«<code>UNION</code>æˆ–è€…<code>UNION ALL</code>çš„å¤§æŸ¥è¯¢æ¥è¯´ï¼Œå®ƒæ˜¯ç”±å‡ ä¸ªå°æŸ¥è¯¢ç»„æˆçš„ï¼Œå…¶ä¸­é™¤äº†æœ€å·¦è¾¹çš„é‚£ä¸ªå°æŸ¥è¯¢æ„å¤–ï¼Œå…¶ä½™çš„å°æŸ¥è¯¢çš„<code>select_type</code>å€¼å°±æ˜¯UNIONï¼Œå¯ä»¥å¯¹æ¯”ä¸Šä¸€ä¸ªä¾‹å­çš„æ•ˆæœã€‚</p></li><li><p>UNION RESULT</p><p>MySQL é€‰æ‹©ä½¿ç”¨ä¸´æ—¶è¡¨æ¥å®Œæˆ<code>UNION</code>æŸ¥è¯¢çš„å»é‡å·¥ä½œï¼Œé’ˆå¯¹è¯¥ä¸´æ—¶è¡¨çš„æŸ¥è¯¢çš„<code>select_type</code>å°±æ˜¯<code>UNION RESULT</code>, ä¾‹å­ä¸Šè¾¹æœ‰ã€‚</p></li><li><p>SUBQUERY</p><p>å¦‚æœåŒ…å«å­æŸ¥è¯¢çš„æŸ¥è¯¢è¯­å¥ä¸èƒ½å¤Ÿè½¬ä¸ºå¯¹åº”çš„<code>semi-join</code>çš„å½¢å¼ï¼Œå¹¶ä¸”è¯¥å­æŸ¥è¯¢æ˜¯ä¸ç›¸å…³å­æŸ¥è¯¢ï¼Œå¹¶ä¸”æŸ¥è¯¢ä¼˜åŒ–å™¨å†³å®šé‡‡ç”¨å°†è¯¥å­æŸ¥è¯¢ç‰©åŒ–çš„æ–¹æ¡ˆæ¥æ‰§è¡Œè¯¥å­æŸ¥è¯¢æ—¶ï¼Œè¯¥å­æŸ¥è¯¢çš„ç¬¬ä¸€ä¸ª<code>SELECT</code>å…³é”®å­—ä»£è¡¨çš„é‚£ä¸ªæŸ¥è¯¢çš„<code>select_type</code>å°±æ˜¯<code>SUBQUERY</code>ï¼Œæ¯”å¦‚ä¸‹è¾¹è¿™ä¸ªæŸ¥è¯¢ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; EXPLAIN SELECT * FROM s1 WHERE key1 IN (SELECT key1 FROM s2) OR key3 = &#x27;a&#x27;;</span><br></pre></td></tr></table></figure></li></ul><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220629172449267.png" class=""><ul><li><p>DEPENDENT SUBQUERY</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; EXPLAIN SELECT * FROM s1 WHERE key1 IN (SELECT key1 FROM s2 WHERE s1.key2 = s2.key2) OR key3 = &#x27;a&#x27;;</span><br></pre></td></tr></table></figure></li></ul><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220629172525236.png" class=""><ul><li><p>DEPENDENT UNION</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; EXPLAIN SELECT * FROM s1 WHERE key1 IN (SELECT key1 FROM s2 WHERE key1 = &#x27;a&#x27; UNION SELECT key1 FROM s1 WHERE key1 = &#x27;b&#x27;);</span><br></pre></td></tr></table></figure></li></ul><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220629172555603.png" class=""><ul><li><p>DERIVED</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; EXPLAIN SELECT * FROM (SELECT key1, count(*) as c FROM s1 GROUP BY key1) AS derived_s1 where c &gt; 1;</span><br></pre></td></tr></table></figure></li></ul><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220629172622893.png" class=""><p>  ä»æ‰§è¡Œè®¡åˆ’ä¸­å¯ä»¥çœ‹å‡ºï¼Œidä¸º2çš„è®°å½•å°±ä»£è¡¨å­æŸ¥è¯¢çš„æ‰§è¡Œæ–¹å¼ï¼Œå®ƒçš„select_typeæ˜¯DERIVED, è¯´æ˜è¯¥å­æŸ¥è¯¢æ˜¯ä»¥ç‰©åŒ–çš„æ–¹å¼æ‰§è¡Œçš„ã€‚idä¸º1çš„è®°å½•ä»£è¡¨å¤–å±‚æŸ¥è¯¢ï¼Œå¤§å®¶æ³¨æ„çœ‹å®ƒçš„tableåˆ—æ˜¾ç¤ºçš„æ˜¯derived2ï¼Œè¡¨ç¤ºè¯¥æŸ¥è¯¢æ—¶é’ˆå¯¹å°†æ´¾ç”Ÿè¡¨ç‰©åŒ–ä¹‹åçš„è¡¨è¿›è¡ŒæŸ¥è¯¢çš„ã€‚</p><ul><li><p>MATERIALIZED</p><p>å½“æŸ¥è¯¢ä¼˜åŒ–å™¨åœ¨æ‰§è¡ŒåŒ…å«å­æŸ¥è¯¢çš„è¯­å¥æ—¶ï¼Œé€‰æ‹©å°†å­æŸ¥è¯¢ç‰©åŒ–ä¹‹åçš„å¤–å±‚æŸ¥è¯¢è¿›è¡Œè¿æ¥æŸ¥è¯¢æ—¶ï¼Œè¯¥å­æŸ¥è¯¢å¯¹åº”çš„<code>select_type</code>å±æ€§å°±æ˜¯DERIVEDï¼Œæ¯”å¦‚ä¸‹è¾¹è¿™ä¸ªæŸ¥è¯¢ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; EXPLAIN SELECT * FROM s1 WHERE key1 IN (SELECT key1 FROM s2);</span><br></pre></td></tr></table></figure></li></ul><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220629172646367.png" class=""><ul><li><p>UNCACHEABLE SUBQUERY</p><p>ä¸å¸¸ç”¨ï¼Œå°±ä¸å¤šè¯´äº†ã€‚</p></li><li><p>UNCACHEABLE UNION</p><p>ä¸å¸¸ç”¨ï¼Œå°±ä¸å¤šè¯´äº†ã€‚</p></li></ul><h4 id="4-partitions-å¯ç•¥"><a href="#4-partitions-å¯ç•¥" class="headerlink" title="4. partitions (å¯ç•¥)"></a>4. partitions (å¯ç•¥)</h4><ul><li>ä»£è¡¨åˆ†åŒºè¡¨ä¸­çš„å‘½ä¸­æƒ…å†µï¼Œéåˆ†åŒºè¡¨ï¼Œè¯¥é¡¹ä¸º<code>NULL</code>ã€‚ä¸€èˆ¬æƒ…å†µä¸‹æˆ‘ä»¬çš„é¢æŸ¥è¯¢è¯­å¥çš„æ‰§è¡Œè®¡åˆ’çš„<code>partitions</code>åˆ—çš„å€¼ä¸º<code>NULL</code>ã€‚</li><li><a><a href="https://dev.mysql.com/doc/refman/5.7/en/alter-table-partition-operations.html">https://dev.mysql.com/doc/refman/5.7/en/alter-table-partition-operations.html</a></a></li><li>å¦‚æœæƒ³è¯¦ç»†äº†è§£ï¼Œå¯ä»¥å¦‚ä¸‹æ–¹å¼æµ‹è¯•ã€‚åˆ›å»ºåˆ†åŒºè¡¨ï¼š</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">-- åˆ›å»ºåˆ†åŒºè¡¨ï¼Œ</span><br><span class="line">-- æŒ‰ç…§idåˆ†åŒºï¼Œid&lt;100 p0åˆ†åŒºï¼Œå…¶ä»–p1åˆ†åŒº</span><br><span class="line">CREATE TABLE user_partitions (id INT auto_increment,</span><br><span class="line">NAME VARCHAR(12),PRIMARY KEY(id))</span><br><span class="line">PARTITION BY RANGE(id)(</span><br><span class="line">PARTITION p0 VALUES less than(100),</span><br><span class="line">PARTITION p1 VALUES less than MAXVALUE</span><br><span class="line">);</span><br></pre></td></tr></table></figure><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220629190304966.png" class=""><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DESC SELECT * FROM user_partitions WHERE id&gt;200;</span><br></pre></td></tr></table></figure><p>æŸ¥è¯¢idå¤§äº200ï¼ˆ200&gt;100ï¼Œp1åˆ†åŒºï¼‰çš„è®°å½•ï¼ŒæŸ¥çœ‹æ‰§è¡Œè®¡åˆ’ï¼Œpartitionsæ˜¯p1ï¼Œç¬¦åˆæˆ‘ä»¬çš„åˆ†åŒºè§„åˆ™</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220629190335371.png" class=""><h4 id="5-type-â˜†"><a href="#5-type-â˜†" class="headerlink" title="5. type â˜†"></a>5. type â˜†</h4><p>æ‰§è¡Œè®¡åˆ’çš„ä¸€æ¡è®°å½•å°±ä»£è¡¨ç€MySQLå¯¹æŸä¸ªè¡¨çš„ <code>æ‰§è¡ŒæŸ¥è¯¢æ—¶çš„è®¿é—®æ–¹æ³•</code> , åˆç§°â€œè®¿é—®ç±»å‹â€ï¼Œå…¶ä¸­çš„ <code>type</code> åˆ—å°±è¡¨æ˜äº†è¿™ä¸ªè®¿é—®æ–¹æ³•æ˜¯å•¥ï¼Œæ˜¯è¾ƒä¸ºé‡è¦çš„ä¸€ä¸ªæŒ‡æ ‡ã€‚æ¯”å¦‚ï¼Œçœ‹åˆ°<code>type</code>åˆ—çš„å€¼æ˜¯<code>ref</code>ï¼Œè¡¨æ˜<code>MySQL</code>å³å°†ä½¿ç”¨<code>ref</code>è®¿é—®æ–¹æ³•æ¥æ‰§è¡Œå¯¹<code>s1</code>è¡¨çš„æŸ¥è¯¢ã€‚</p><p>å®Œæ•´çš„è®¿é—®æ–¹æ³•å¦‚ä¸‹ï¼š <code>system ï¼Œ const ï¼Œ eq_ref ï¼Œ ref ï¼Œ fulltext ï¼Œ ref_or_null ï¼Œ index_merge ï¼Œ unique_subquery ï¼Œ index_subquery ï¼Œ range ï¼Œ index ï¼Œ ALL</code> ã€‚</p><p>æˆ‘ä»¬è¯¦ç»†è§£é‡Šä¸€ä¸‹ï¼š</p><ul><li><p><code>system</code></p><p>å½“è¡¨ä¸­<code>åªæœ‰ä¸€æ¡è®°å½•</code>å¹¶ä¸”è¯¥è¡¨ä½¿ç”¨çš„å­˜å‚¨å¼•æ“çš„ç»Ÿè®¡æ•°æ®æ˜¯ç²¾ç¡®çš„ï¼Œæ¯”å¦‚MyISAMã€Memoryï¼Œé‚£ä¹ˆå¯¹è¯¥è¡¨çš„è®¿é—®æ–¹æ³•å°±æ˜¯<code>system</code>ã€‚æ¯”æ–¹è¯´æˆ‘ä»¬æ–°å»ºä¸€ä¸ª<code>MyISAM</code>è¡¨ï¼Œå¹¶ä¸ºå…¶æ’å…¥ä¸€æ¡è®°å½•ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; CREATE TABLE t(i int) Engine=MyISAM;</span><br><span class="line">Query OK, 0 rows affected (0.05 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; INSERT INTO t VALUES(1);</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬çœ‹ä¸€ä¸‹æŸ¥è¯¢è¿™ä¸ªè¡¨çš„æ‰§è¡Œè®¡åˆ’ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; EXPLAIN SELECT * FROM t;</span><br></pre></td></tr></table></figure><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220630164434315.png" class=""><p>å¯ä»¥çœ‹åˆ°<code>type</code>åˆ—çš„å€¼å°±æ˜¯<code>system</code>äº†ï¼Œ</p><blockquote><p>æµ‹è¯•ï¼Œå¯ä»¥æŠŠè¡¨æ”¹æˆä½¿ç”¨InnoDBå­˜å‚¨å¼•æ“ï¼Œè¯•è¯•çœ‹æ‰§è¡Œè®¡åˆ’çš„<code>type</code>åˆ—æ˜¯ä»€ä¹ˆã€‚ALL</p></blockquote></li><li><p><code>const</code></p><p>å½“æˆ‘ä»¬æ ¹æ®ä¸»é”®æˆ–è€…å”¯ä¸€äºŒçº§ç´¢å¼•åˆ—ä¸å¸¸æ•°è¿›è¡Œç­‰å€¼åŒ¹é…æ—¶ï¼Œå¯¹å•è¡¨çš„è®¿é—®æ–¹æ³•å°±æ˜¯<code>const</code>, æ¯”å¦‚ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; EXPLAIN SELECT * FROM s1 WHERE id = 10005;</span><br></pre></td></tr></table></figure><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220630164724548.png" class=""></li><li><p><code>eq_ref</code></p><p>åœ¨è¿æ¥æŸ¥è¯¢æ—¶ï¼Œå¦‚æœè¢«é©±åŠ¨è¡¨æ˜¯é€šè¿‡ä¸»é”®æˆ–è€…å”¯ä¸€äºŒçº§ç´¢å¼•åˆ—ç­‰å€¼åŒ¹é…çš„æ–¹å¼è¿›è¡Œè®¿é—®çš„ï¼ˆå¦‚æœè¯¥ä¸»é”®æˆ–è€…å”¯ä¸€äºŒçº§ç´¢å¼•æ˜¯è”åˆç´¢å¼•çš„è¯ï¼Œæ‰€æœ‰çš„ç´¢å¼•åˆ—éƒ½å¿…é¡»è¿›è¡Œç­‰å€¼æ¯”è¾ƒï¼‰ã€‚åˆ™å¯¹è¯¥è¢«é©±åŠ¨è¡¨çš„è®¿é—®æ–¹æ³•å°±æ˜¯<code>eq_ref</code>ï¼Œæ¯”æ–¹è¯´ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; EXPLAIN SELECT * FROM s1 INNER JOIN s2 ON s1.id = s2.id;</span><br></pre></td></tr></table></figure><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220630164802559.png" class=""><p>ä»æ‰§è¡Œè®¡åˆ’çš„ç»“æœä¸­å¯ä»¥çœ‹å‡ºï¼ŒMySQLæ‰“ç®—å°†s2ä½œä¸ºé©±åŠ¨è¡¨ï¼Œs1ä½œä¸ºè¢«é©±åŠ¨è¡¨ï¼Œé‡ç‚¹å…³æ³¨s1çš„è®¿é—® æ–¹æ³•æ˜¯ <code>eq_ref</code> ï¼Œè¡¨æ˜åœ¨è®¿é—®s1è¡¨çš„æ—¶å€™å¯ä»¥ <code>é€šè¿‡ä¸»é”®çš„ç­‰å€¼åŒ¹é…</code> æ¥è¿›è¡Œè®¿é—®ã€‚</p></li><li><p><code>ref</code></p><p>å½“é€šè¿‡æ™®é€šçš„äºŒçº§ç´¢å¼•åˆ—ä¸å¸¸é‡è¿›è¡Œç­‰å€¼åŒ¹é…æ—¶æ¥æŸ¥è¯¢æŸä¸ªè¡¨ï¼Œé‚£ä¹ˆå¯¹è¯¥è¡¨çš„è®¿é—®æ–¹æ³•å°±å¯èƒ½æ˜¯<code>ref</code>ï¼Œæ¯”æ–¹è¯´ä¸‹è¾¹è¿™ä¸ªæŸ¥è¯¢ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; EXPLAIN SELECT * FROM s1 WHERE key1 = &#x27;a&#x27;;</span><br></pre></td></tr></table></figure><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220630164930020.png" class=""></li><li><p><code>fulltext</code></p><p>å…¨æ–‡ç´¢å¼•</p></li><li><p><code>ref_or_null</code></p><p>å½“å¯¹æ™®é€šäºŒçº§ç´¢å¼•è¿›è¡Œç­‰å€¼åŒ¹é…æŸ¥è¯¢ï¼Œè¯¥ç´¢å¼•åˆ—çš„å€¼ä¹Ÿå¯ä»¥æ˜¯<code>NULL</code>å€¼æ—¶ï¼Œé‚£ä¹ˆå¯¹è¯¥è¡¨çš„è®¿é—®æ–¹æ³•å°±å¯èƒ½æ˜¯<code>ref_or_null</code>ï¼Œæ¯”å¦‚è¯´ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; EXPLAIN SELECT * FROM s1 WHERE key1 = &#x27;a&#x27; OR key1 IS NULL;</span><br></pre></td></tr></table></figure><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220630175133920.png" class=""></li><li><p><code>index_merge</code></p><p>ä¸€èˆ¬æƒ…å†µä¸‹å¯¹äºæŸä¸ªè¡¨çš„æŸ¥è¯¢åªèƒ½ä½¿ç”¨åˆ°ä¸€ä¸ªç´¢å¼•ï¼Œä½†å•è¡¨è®¿é—®æ–¹æ³•æ—¶åœ¨æŸäº›åœºæ™¯ä¸‹å¯ä»¥ä½¿ç”¨<code>Interseationã€unionã€Sort-Union</code>è¿™ä¸‰ç§ç´¢å¼•åˆå¹¶çš„æ–¹å¼æ¥æ‰§è¡ŒæŸ¥è¯¢ã€‚æˆ‘ä»¬çœ‹ä¸€ä¸‹æ‰§è¡Œè®¡åˆ’ä¸­æ˜¯æ€ä¹ˆä½“ç°MySQLä½¿ç”¨ç´¢å¼•åˆå¹¶çš„æ–¹å¼æ¥å¯¹æŸä¸ªè¡¨æ‰§è¡ŒæŸ¥è¯¢çš„ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; EXPLAIN SELECT * FROM s1 WHERE key1 = &#x27;a&#x27; OR key3 = &#x27;a&#x27;;</span><br></pre></td></tr></table></figure><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220630175511644.png" class=""><p>ä»æ‰§è¡Œè®¡åˆ’çš„ <code>type</code> åˆ—çš„å€¼æ˜¯ <code>index_merge</code> å°±å¯ä»¥çœ‹å‡ºï¼ŒMySQL æ‰“ç®—ä½¿ç”¨ç´¢å¼•åˆå¹¶çš„æ–¹å¼æ¥æ‰§è¡Œ å¯¹ s1 è¡¨çš„æŸ¥è¯¢ã€‚</p></li><li><p><code>unique_subquery</code></p><p>ç±»ä¼¼äºä¸¤è¡¨è¿æ¥ä¸­è¢«é©±åŠ¨è¡¨çš„<code>eq_ref</code>è®¿é—®æ–¹æ³•ï¼Œ<code>unique_subquery</code>æ˜¯é’ˆå¯¹åœ¨ä¸€äº›åŒ…å«<code>IN</code>å­æŸ¥è¯¢çš„æŸ¥è¯¢è¯­å¥ä¸­ï¼Œå¦‚æœæŸ¥è¯¢ä¼˜åŒ–å™¨å†³å®šå°†<code>IN</code>å­æŸ¥è¯¢è½¬æ¢ä¸º<code>EXISTS</code>å­æŸ¥è¯¢ï¼Œè€Œä¸”å­æŸ¥è¯¢å¯ä»¥ä½¿ç”¨åˆ°ä¸»é”®è¿›è¡Œç­‰å€¼åŒ¹é…çš„è¯ï¼Œé‚£ä¹ˆè¯¥å­æŸ¥è¯¢æ‰§è¡Œè®¡åˆ’çš„<code>type</code>åˆ—çš„å€¼å°±æ˜¯<code>unique_subquery</code>ï¼Œæ¯”å¦‚ä¸‹è¾¹çš„è¿™ä¸ªæŸ¥è¯¢è¯­å¥ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; EXPLAIN SELECT * FROM s1 WHERE key2 IN (SELECT id FROM s2 where s1.key1 = s2.key1) OR key3 = &#x27;a&#x27;;</span><br></pre></td></tr></table></figure><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220630180123913.png" class=""></li></ul><ul><li><p><code>index_subquery</code></p><p><code>index_subquery</code> ä¸ <code>unique_subquery</code> ç±»ä¼¼ï¼Œåªä¸è¿‡è®¿é—®å­æŸ¥è¯¢ä¸­çš„è¡¨æ—¶ä½¿ç”¨çš„æ˜¯æ™®é€šçš„ç´¢å¼•ï¼Œæ¯”å¦‚è¿™æ ·ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; EXPLAIN SELECT * FROM s1 WHERE common_field IN (SELECT key3 FROM s2 where s1.key1 = s2.key1) OR key3 = &#x27;a&#x27;;</span><br></pre></td></tr></table></figure></li></ul><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220703214407225.png" class=""><ul><li><p><code>range</code></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; EXPLAIN SELECT * FROM s1 WHERE key1 IN (&#x27;a&#x27;, &#x27;b&#x27;, &#x27;c&#x27;);</span><br></pre></td></tr></table></figure></li></ul><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220703214633338.png" class=""><p>  æˆ–è€…ï¼š</p>  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; EXPLAIN SELECT * FROM s1 WHERE key1 &gt; &#x27;a&#x27; AND key1 &lt; &#x27;b&#x27;;</span><br></pre></td></tr></table></figure><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220703214657251.png" class=""><ul><li><p><code>index</code></p><p>å½“æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ç´¢å¼•è¦†ç›–ï¼Œä½†éœ€è¦æ‰«æå…¨éƒ¨çš„ç´¢å¼•è®°å½•æ—¶ï¼Œè¯¥è¡¨çš„è®¿é—®æ–¹æ³•å°±æ˜¯<code>index</code>ï¼Œæ¯”å¦‚è¿™æ ·ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; EXPLAIN SELECT key_part2 FROM s1 WHERE key_part3 = &#x27;a&#x27;;</span><br></pre></td></tr></table></figure></li></ul> <img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220703214844885.png" class=""><p>  ä¸Šè¿°æŸ¥è¯¢ä¸­çš„æ‰€æœ‰åˆ—è¡¨ä¸­åªæœ‰key_part2 ä¸€ä¸ªåˆ—ï¼Œè€Œä¸”æœç´¢æ¡ä»¶ä¸­ä¹Ÿåªæœ‰ key_part3 ä¸€ä¸ªåˆ—ï¼Œè¿™ä¸¤ä¸ªåˆ—åˆæ°å¥½åŒ…å«åœ¨idx_key_partè¿™ä¸ªç´¢å¼•ä¸­ï¼Œå¯æ˜¯æœç´¢æ¡ä»¶key_part3ä¸èƒ½ç›´æ¥ä½¿ç”¨è¯¥ç´¢å¼•è¿›è¡Œ<code>ref</code>å’Œ<code>range</code>æ–¹å¼çš„è®¿é—®ï¼Œåªèƒ½æ‰«ææ•´ä¸ª<code>idx_key_part</code>ç´¢å¼•çš„è®°å½•ï¼Œæ‰€ä»¥æŸ¥è¯¢è®¡åˆ’çš„<code>type</code>åˆ—çš„å€¼å°±æ˜¯<code>index</code>ã€‚</p><blockquote><p>å†ä¸€æ¬¡å¼ºè°ƒï¼Œå¯¹äºä½¿ç”¨InnoDBå­˜å‚¨å¼•æ“çš„è¡¨æ¥è¯´ï¼ŒäºŒçº§ç´¢å¼•çš„è®°å½•åªåŒ…å«ç´¢å¼•åˆ—å’Œä¸»é”®åˆ—çš„å€¼ï¼Œè€Œèšç°‡ç´¢å¼•ä¸­åŒ…å«ç”¨æˆ·å®šä¹‰çš„å…¨éƒ¨åˆ—ä»¥åŠä¸€äº›éšè—åˆ—ï¼Œæ‰€ä»¥æ‰«æäºŒçº§ç´¢å¼•çš„ä»£ä»·æ¯”ç›´æ¥å…¨è¡¨æ‰«æï¼Œä¹Ÿå°±æ˜¯æ‰«æèšç°‡ç´¢å¼•çš„ä»£ä»·æ›´ä½ä¸€äº›ã€‚</p></blockquote><ul><li><p><code>ALL</code></p><p>æœ€ç†Ÿæ‚‰çš„å…¨è¡¨æ‰«æï¼Œå°±ä¸å¤šè¯´äº†ï¼Œç›´æ¥çœ‹ä¾‹å­ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; EXPLAIN SELECT * FROM s1;</span><br></pre></td></tr></table></figure></li></ul><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220703215958374.png" class=""><p>**å°ç»“: **</p><p>**ç»“æœå€¼ä»æœ€å¥½åˆ°æœ€åä¾æ¬¡æ˜¯ï¼š **</p><p><strong>system &gt; const &gt; eq_ref &gt; ref</strong> &gt; fulltext &gt; ref_or_null &gt; index_merge &gt; unique_subquery &gt; index_subquery &gt; range &gt; index &gt; ALL </p><p><strong>å…¶ä¸­æ¯”è¾ƒé‡è¦çš„å‡ ä¸ªæå–å‡ºæ¥ï¼ˆè§ä¸Šå›¾ä¸­çš„ç²—ä½“ï¼‰ã€‚SQL æ€§èƒ½ä¼˜åŒ–çš„ç›®æ ‡ï¼šè‡³å°‘è¦è¾¾åˆ° range çº§åˆ«ï¼Œè¦æ±‚æ˜¯ ref çº§åˆ«ï¼Œæœ€å¥½æ˜¯ constsçº§åˆ«ã€‚ï¼ˆé˜¿é‡Œå·´å·´ å¼€å‘æ‰‹å†Œè¦æ±‚ï¼‰</strong></p><h4 id="6-possible-keyså’Œkey"><a href="#6-possible-keyså’Œkey" class="headerlink" title="6. possible_keyså’Œkey"></a>6. possible_keyså’Œkey</h4><p>åœ¨EXPLAINè¯­å¥è¾“å‡ºçš„æ‰§è¡Œè®¡åˆ’ä¸­ï¼Œ<code>possible_keys</code>åˆ—è¡¨ç¤ºåœ¨æŸä¸ªæŸ¥è¯¢è¯­å¥ä¸­ï¼Œå¯¹æŸä¸ªåˆ—æ‰§è¡Œ<code>å•è¡¨æŸ¥è¯¢æ—¶å¯èƒ½ç”¨åˆ°çš„ç´¢å¼•</code>æœ‰å“ªäº›ã€‚ä¸€èˆ¬æŸ¥è¯¢æ¶‰åŠåˆ°çš„å­—æ®µä¸Šè‹¥å­˜åœ¨ç´¢å¼•ï¼Œåˆ™è¯¥ç´¢å¼•å°†è¢«åˆ—å‡ºï¼Œä½†ä¸ä¸€å®šè¢«æŸ¥è¯¢ä½¿ç”¨ã€‚<code>key</code>åˆ—è¡¨ç¤º<code>å®é™…ç”¨åˆ°çš„ç´¢å¼•</code>æœ‰å“ªäº›ï¼Œå¦‚æœä¸ºNULLï¼Œåˆ™æ²¡æœ‰ä½¿ç”¨ç´¢å¼•ã€‚æ¯”æ–¹è¯´ä¸‹é¢è¿™ä¸ªæŸ¥è¯¢ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; EXPLAIN SELECT * FROM s1 WHERE key1 &gt; &#x27;z&#x27; AND key3 = &#x27;a&#x27;;</span><br></pre></td></tr></table></figure><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220703220724964.png" class=""><p>ä¸Šè¿°æ‰§è¡Œè®¡åˆ’çš„<code>possible_keys</code>åˆ—çš„å€¼æ˜¯<code>idx_key1, idx_key3</code>ï¼Œè¡¨ç¤ºè¯¥æŸ¥è¯¢å¯èƒ½ä½¿ç”¨åˆ°<code>idx_key1, idx_key3</code>ä¸¤ä¸ªç´¢å¼•ï¼Œç„¶å<code>key</code>åˆ—çš„å€¼æ˜¯<code>idx_key3</code>ï¼Œè¡¨ç¤ºç»è¿‡æŸ¥è¯¢ä¼˜åŒ–å™¨è®¡ç®—ä½¿ç”¨ä¸åŒç´¢å¼•çš„æˆæœ¬åï¼Œæœ€åå†³å®šé‡‡ç”¨<code>idx_key3</code>ã€‚</p><h4 id="7-key-len-â˜†"><a href="#7-key-len-â˜†" class="headerlink" title="7. key_len â˜†"></a>7. key_len â˜†</h4><p>å®é™…ä½¿ç”¨åˆ°çš„ç´¢å¼•é•¿åº¦ (å³ï¼šå­—èŠ‚æ•°)</p><p>å¸®ä½ æ£€æŸ¥<code>æ˜¯å¦å……åˆ†çš„åˆ©ç”¨äº†ç´¢å¼•</code>ï¼Œ<code>å€¼è¶Šå¤§è¶Šå¥½</code>ï¼Œä¸»è¦é’ˆå¯¹äºè”åˆç´¢å¼•ï¼Œæœ‰ä¸€å®šçš„å‚è€ƒæ„ä¹‰ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; EXPLAIN SELECT * FROM s1 WHERE id = 10005;</span><br></pre></td></tr></table></figure><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220704130030692.png" class=""><blockquote><p>int å ç”¨ 4 ä¸ªå­—èŠ‚</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; EXPLAIN SELECT * FROM s1 WHERE key2 = 10126;</span><br></pre></td></tr></table></figure><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220704130138204.png" class=""><blockquote><p>key2ä¸Šæœ‰ä¸€ä¸ªå”¯ä¸€æ€§çº¦æŸï¼Œæ˜¯å¦ä¸ºNULLå ç”¨ä¸€ä¸ªå­—èŠ‚ï¼Œé‚£ä¹ˆå°±æ˜¯5ä¸ªå­—èŠ‚</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; EXPLAIN SELECT * FROM s1 WHERE key1 = &#x27;a&#x27;;</span><br></pre></td></tr></table></figure><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220704130214482.png" class=""><blockquote><p>key1 VARCHAR(100) ä¸€ä¸ªå­—ç¬¦å 3ä¸ªå­—èŠ‚ï¼Œ100*3ï¼Œæ˜¯å¦ä¸ºNULLå ç”¨ä¸€ä¸ªå­—èŠ‚ï¼Œvarcharçš„é•¿åº¦ä¿¡æ¯å ä¸¤ä¸ªå­—èŠ‚ã€‚</p></blockquote><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; EXPLAIN SELECT * FROM s1 WHERE key_part1 = &#x27;a&#x27;;</span><br></pre></td></tr></table></figure><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220704130442095.png" class=""><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; EXPLAIN SELECT * FROM s1 WHERE key_part1 = &#x27;a&#x27; AND key_part2 = &#x27;b&#x27;;</span><br></pre></td></tr></table></figure><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220704130515031.png" class=""><blockquote><p>è”åˆç´¢å¼•ä¸­å¯ä»¥æ¯”è¾ƒï¼Œkey_len&#x3D;606çš„å¥½äºkey_len&#x3D;303</p></blockquote><p>**ç»ƒä¹ ï¼š **</p><p>key_lençš„é•¿åº¦è®¡ç®—å…¬å¼ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">varchar(10)å˜é•¿å­—æ®µä¸”å…è®¸NULL = 10 * ( character setï¼šutf8=3,gbk=2,latin1=1)+1(NULL)+2(å˜é•¿å­—æ®µ)</span><br><span class="line"></span><br><span class="line">varchar(10)å˜é•¿å­—æ®µä¸”ä¸å…è®¸NULL = 10 * ( character setï¼šutf8=3,gbk=2,latin1=1)+2(å˜é•¿å­—æ®µ)</span><br><span class="line"></span><br><span class="line">char(10)å›ºå®šå­—æ®µä¸”å…è®¸NULL = 10 * ( character setï¼šutf8=3,gbk=2,latin1=1)+1(NULL)</span><br><span class="line"></span><br><span class="line">char(10)å›ºå®šå­—æ®µä¸”ä¸å…è®¸NULL = 10 * ( character setï¼šutf8=3,gbk=2,latin1=1)</span><br></pre></td></tr></table></figure><h4 id="8-ref"><a href="#8-ref" class="headerlink" title="8. ref"></a>8. ref</h4><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220704131759630.png" class=""><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; EXPLAIN SELECT * FROM s1 WHERE key1 = &#x27;a&#x27;;</span><br></pre></td></tr></table></figure><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220704130837498.png" class=""><p>å¯ä»¥çœ‹åˆ°<code>ref</code>åˆ—çš„å€¼æ˜¯<code>const</code>ï¼Œè¡¨æ˜åœ¨ä½¿ç”¨<code>idx_key1</code>ç´¢å¼•æ‰§è¡ŒæŸ¥è¯¢æ—¶ï¼Œä¸<code>key1</code>åˆ—ä½œç­‰å€¼åŒ¹é…çš„å¯¹è±¡æ˜¯ä¸€ä¸ªå¸¸æ•°ï¼Œå½“ç„¶æœ‰æ—¶å€™æ›´å¤æ‚ä¸€ç‚¹:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; EXPLAIN SELECT * FROM s1 INNER JOIN s2 ON s1.id = s2.id;</span><br></pre></td></tr></table></figure><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220704130925426.png" class=""><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; EXPLAIN SELECT * FROM s1 INNER JOIN s2 ON s2.key1 = UPPER(s1.key1);</span><br></pre></td></tr></table></figure><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220704130957359.png" class=""><h4 id="9-rows-â˜†"><a href="#9-rows-â˜†" class="headerlink" title="9. rows â˜†"></a>9. rows â˜†</h4><p>é¢„ä¼°çš„éœ€è¦è¯»å–çš„è®°å½•æ¡æ•°ï¼Œ<code>å€¼è¶Šå°è¶Šå¥½</code>ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; EXPLAIN SELECT * FROM s1 WHERE key1 &gt; &#x27;z&#x27;;</span><br></pre></td></tr></table></figure><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220704131050496.png" class=""><h4 id="10-filtered"><a href="#10-filtered" class="headerlink" title="10. filtered"></a>10. filtered</h4><p>æŸä¸ªè¡¨ç»è¿‡æœç´¢æ¡ä»¶è¿‡æ»¤åå‰©ä½™è®°å½•æ¡æ•°çš„ç™¾åˆ†æ¯”</p><p>å¦‚æœä½¿ç”¨çš„æ˜¯ç´¢å¼•æ‰§è¡Œçš„å•è¡¨æ‰«æï¼Œé‚£ä¹ˆè®¡ç®—æ—¶éœ€è¦ä¼°è®¡å‡ºæ»¡è¶³é™¤ä½¿ç”¨åˆ°å¯¹åº”ç´¢å¼•çš„æœç´¢æ¡ä»¶å¤–çš„å…¶ä»–æœç´¢æ¡ä»¶çš„è®°å½•æœ‰å¤šå°‘æ¡ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; EXPLAIN SELECT * FROM s1 WHERE key1 &gt; &#x27;z&#x27; AND common_field = &#x27;a&#x27;;</span><br></pre></td></tr></table></figure><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220704131323242.png" class=""><p>å¯¹äºå•è¡¨æŸ¥è¯¢æ¥è¯´ï¼Œè¿™ä¸ªfilteredçš„å€¼æ²¡æœ‰ä»€ä¹ˆæ„ä¹‰ï¼Œæˆ‘ä»¬<code>æ›´å…³æ³¨åœ¨è¿æ¥æŸ¥è¯¢ä¸­é©±åŠ¨è¡¨å¯¹åº”çš„æ‰§è¡Œè®¡åˆ’è®°å½•çš„filteredå€¼</code>ï¼Œå®ƒå†³å®šäº†è¢«é©±åŠ¨è¡¨è¦æ‰§è¡Œçš„æ¬¡æ•° (å³: rows * filtered)</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; EXPLAIN SELECT * FROM s1 INNER JOIN s2 ON s1.key1 = s2.key1 WHERE s1.common_field = &#x27;a&#x27;;</span><br></pre></td></tr></table></figure><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220704131644615.png" class=""><p>ä»æ‰§è¡Œè®¡åˆ’ä¸­å¯ä»¥çœ‹å‡ºæ¥ï¼ŒæŸ¥è¯¢ä¼˜åŒ–å™¨æ‰“ç®—æŠŠ<code>s1</code>ä½œä¸ºé©±åŠ¨è¡¨ï¼Œ<code>s2</code>å½“åšè¢«é©±åŠ¨è¡¨ã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°é©±åŠ¨è¡¨<code>s1</code>è¡¨çš„æ‰§è¡Œè®¡åˆ’çš„<code>rows</code>åˆ—ä¸º<code>9688</code>ï¼Œfilteredåˆ—ä¸º<code>10.00</code>ï¼Œè¿™æ„å‘³ç€é©±åŠ¨è¡¨<code>s1</code>çš„æ‰‡å‡ºå€¼å°±æ˜¯<code>9688 x 10.00% = 968.8</code>ï¼Œè¿™è¯´æ˜è¿˜è¦å¯¹è¢«é©±åŠ¨è¡¨æ‰§è¡Œå¤§çº¦<code>968</code>æ¬¡æŸ¥è¯¢ã€‚</p><h4 id="11-Extra-â˜†"><a href="#11-Extra-â˜†" class="headerlink" title="11. Extra â˜†"></a>11. Extra â˜†</h4><p>é¡¾åæ€ä¹‰ï¼Œ<code>Extra</code>åˆ—æ˜¯ç”¨æ¥è¯´æ˜ä¸€äº›é¢å¤–ä¿¡æ¯çš„ï¼ŒåŒ…å«ä¸é€‚åˆåœ¨å…¶ä»–åˆ—ä¸­æ˜¾ç¤ºä½†ååˆ†é‡è¦çš„é¢å¤–ä¿¡æ¯ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™äº›é¢å¤–ä¿¡æ¯æ¥<code>æ›´å‡†ç¡®çš„ç†è§£MySQLåˆ°åº•å°†å¦‚ä½•æ‰§è¡Œç»™å®šçš„æŸ¥è¯¢è¯­å¥</code>ã€‚MySQLæä¾›çš„é¢å¤–ä¿¡æ¯æœ‰å¥½å‡ åä¸ªï¼Œæˆ‘ä»¬å°±ä¸ä¸€ä¸ªä¸€ä¸ªä»‹ç»äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬åªæŒ‘é€‰æ¯”è¾ƒé‡è¦çš„é¢å¤–ä¿¡æ¯ä»‹ç»ç»™å¤§å®¶ã€‚</p><ul><li><p><code>No tables used</code></p><p>å½“æŸ¥è¯¢è¯­å¥æ²¡æœ‰<code>FROM</code>å­å¥æ—¶å°†ä¼šæç¤ºè¯¥é¢å¤–ä¿¡æ¯ï¼Œæ¯”å¦‚ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; EXPLAIN SELECT 1;</span><br></pre></td></tr></table></figure></li></ul><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220704132345383.png" class=""><ul><li><p><code>Impossible WHERE</code></p><p>å½“æŸ¥è¯¢è¯­å¥çš„<code>WHERE</code>å­å¥æ°¸è¿œä¸º<code>FALSE</code>æ—¶å°†ä¼šæç¤ºè¯¥é¢å¤–ä¿¡æ¯</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; EXPLAIN SELECT * FROM s1 WHERE 1 != 1;</span><br></pre></td></tr></table></figure></li></ul><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220704132458978.png" class=""><ul><li><p><code>Using where</code></p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220704140148163.png" class=""><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; EXPLAIN SELECT * FROM s1 WHERE common_field = &#x27;a&#x27;;</span><br></pre></td></tr></table></figure></li></ul><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220704132655342.png" class="">  <img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220704140212813.png" class="">  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; EXPLAIN SELECT * FROM s1 WHERE key1 = &#x27;a&#x27; AND common_field = &#x27;a&#x27;;</span><br></pre></td></tr></table></figure><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220704133130515.png" class=""><ul><li><p><code>No matching min/max row</code></p><p>å½“æŸ¥è¯¢åˆ—è¡¨å¤„æœ‰<code>MIN</code>æˆ–è€…<code>MAX</code>èšåˆå‡½æ•°ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰ç¬¦åˆ<code>WHERE</code>å­å¥ä¸­çš„æœç´¢æ¡ä»¶çš„è®°å½•æ—¶ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; EXPLAIN SELECT MIN(key1) FROM s1 WHERE key1 = &#x27;abcdefg&#x27;;</span><br></pre></td></tr></table></figure></li></ul><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220704134324354.png" class=""><ul><li><p><code>Using index</code></p><p>å½“æˆ‘ä»¬çš„æŸ¥è¯¢åˆ—è¡¨ä»¥åŠæœç´¢æ¡ä»¶ä¸­åªåŒ…å«å±äºæŸä¸ªç´¢å¼•çš„åˆ—ï¼Œä¹Ÿå°±æ˜¯åœ¨å¯ä»¥ä½¿ç”¨è¦†ç›–ç´¢å¼•çš„æƒ…å†µä¸‹ï¼Œåœ¨<code>Extra</code>åˆ—å°†ä¼šæç¤ºè¯¥é¢å¤–ä¿¡æ¯ã€‚æ¯”æ–¹è¯´ä¸‹è¾¹è¿™ä¸ªæŸ¥è¯¢ä¸­åªéœ€è¦ç”¨åˆ°<code>idx_key1</code>è€Œä¸éœ€è¦å›è¡¨æ“ä½œ:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; EXPLAIN SELECT key1 FROM s1 WHERE key1 = &#x27;a&#x27;;</span><br></pre></td></tr></table></figure></li></ul><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220704134931220.png" class=""><ul><li><p><code>Using index condition</code></p><p>æœ‰äº›æœç´¢æ¡ä»¶ä¸­è™½ç„¶å‡ºç°äº†ç´¢å¼•åˆ—ï¼Œä½†å´ä¸èƒ½ä½¿ç”¨åˆ°ç´¢å¼•ï¼Œæ¯”å¦‚ä¸‹è¾¹è¿™ä¸ªæŸ¥è¯¢ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM s1 WHERE key1 &gt; &#x27;z&#x27; AND key1 LIKE &#x27;%a&#x27;;</span><br></pre></td></tr></table></figure><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220704140344015.png" class=""><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220704140411033.png" class=""><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; EXPLAIN SELECT * FROM s1 WHERE key1 &gt; &#x27;z&#x27; AND key1 LIKE &#x27;%b&#x27;;</span><br></pre></td></tr></table></figure></li></ul><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220704140441702.png" class=""><ul><li><p><code>Using join buffer (Block Nested Loop)</code></p><p>åœ¨è¿æ¥æŸ¥è¯¢æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå½“è¢«é©±åŠ¨è¡¨ä¸èƒ½æœ‰æ•ˆçš„åˆ©ç”¨ç´¢å¼•åŠ å¿«è®¿é—®é€Ÿåº¦ï¼ŒMySQLä¸€èˆ¬ä¼šä¸ºå…¶åˆ†é…ä¸€å—åå«<code>join buffer</code>çš„å†…å­˜å—æ¥åŠ å¿«æŸ¥è¯¢é€Ÿåº¦ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬æ‰€è®²çš„<code>åŸºäºå—çš„åµŒå¥—å¾ªç¯ç®—æ³•</code>ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; EXPLAIN SELECT * FROM s1 INNER JOIN s2 ON s1.common_field = s2.common_field;</span><br></pre></td></tr></table></figure></li></ul><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220704140815955.png" class=""><ul><li><p><code>Not exists</code></p><p>å½“æˆ‘ä»¬ä½¿ç”¨å·¦(å¤–)è¿æ¥æ—¶ï¼Œå¦‚æœ<code>WHERE</code>å­å¥ä¸­åŒ…å«è¦æ±‚è¢«é©±åŠ¨è¡¨çš„æŸä¸ªåˆ—ç­‰äº<code>NULL</code>å€¼çš„æœç´¢æ¡ä»¶ï¼Œè€Œä¸”é‚£ä¸ªåˆ—æ˜¯ä¸å…è®¸å­˜å‚¨<code>NULL</code>å€¼çš„ï¼Œé‚£ä¹ˆåœ¨è¯¥è¡¨çš„æ‰§è¡Œè®¡åˆ’çš„Extraåˆ—å°±ä¼šæç¤ºè¿™ä¸ªä¿¡æ¯ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; EXPLAIN SELECT * FROM s1 LEFT JOIN s2 ON s1.key1 = s2.key1 WHERE s2.id IS NULL;</span><br></pre></td></tr></table></figure></li></ul><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220704142059555.png" class=""><ul><li><p><code>Using intersect(...) ã€ Using union(...) å’Œ Using sort_union(...)</code></p><p>å¦‚æœæ‰§è¡Œè®¡åˆ’çš„<code>Extra</code>åˆ—å‡ºç°äº†<code>Using intersect(...)</code>æç¤ºï¼Œè¯´æ˜å‡†å¤‡ä½¿ç”¨<code>Intersect</code>ç´¢å¼•åˆå¹¶çš„æ–¹å¼æ‰§è¡ŒæŸ¥è¯¢ï¼Œæ‹¬å·ä¸­çš„<code>...</code>è¡¨ç¤ºéœ€è¦è¿›è¡Œç´¢å¼•åˆå¹¶çš„ç´¢å¼•åç§°ï¼›</p><p>å¦‚æœå‡ºç°<code>Using union(...)</code>æç¤ºï¼Œè¯´æ˜å‡†å¤‡ä½¿ç”¨<code>Union</code>ç´¢å¼•åˆå¹¶çš„æ–¹å¼æ‰§è¡ŒæŸ¥è¯¢;</p><p>å¦‚æœå‡ºç°<code>Using sort_union(...)</code>æç¤ºï¼Œè¯´æ˜å‡†å¤‡ä½¿ç”¨<code>Sort-Union</code>ç´¢å¼•åˆå¹¶çš„æ–¹å¼æ‰§è¡ŒæŸ¥è¯¢ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; EXPLAIN SELECT * FROM s1 WHERE key1 = &#x27;a&#x27; OR key3 = &#x27;a&#x27;;</span><br></pre></td></tr></table></figure></li></ul><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220704142552890.png" class=""><ul><li><p><code>Zero limit</code></p><p>å½“æˆ‘ä»¬çš„<code>LIMIT</code>å­å¥çš„å‚æ•°ä¸º<code>0</code>æ—¶ï¼Œè¡¨ç¤ºå‹æ ¹å„¿ä¸æ‰“ç®—ä»è¡¨ä¸­è¯»å–ä»»ä½•è®°å½•ï¼Œå°†ä¼šæç¤ºè¯¥é¢å¤–ä¿¡æ¯</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; EXPLAIN SELECT * FROM s1 LIMIT 0;</span><br></pre></td></tr></table></figure></li></ul><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220704142754394.png" class=""><ul><li><p><code>Using filesort</code></p><p>æœ‰ä¸€äº›æƒ…å†µä¸‹å¯¹ç»“æœé›†ä¸­çš„è®°å½•è¿›è¡Œæ’åºæ˜¯å¯ä»¥ä½¿ç”¨åˆ°ç´¢å¼•çš„ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; EXPLAIN SELECT * FROM s1 ORDER BY key1 LIMIT 10;</span><br></pre></td></tr></table></figure></li></ul><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220704142901857.png" class="">  <img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220704145143170.png" class="">  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; EXPLAIN SELECT * FROM s1 ORDER BY common_field LIMIT 10;</span><br></pre></td></tr></table></figure><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220704143518857.png" class=""><p>  éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœæŸ¥è¯¢ä¸­éœ€è¦ä½¿ç”¨<code>filesort</code>çš„æ–¹å¼è¿›è¡Œæ’åºçš„è®°å½•éå¸¸å¤šï¼Œé‚£ä¹ˆè¿™ä¸ªè¿‡ç¨‹æ˜¯å¾ˆè€—è´¹æ€§èƒ½çš„ï¼Œæˆ‘ä»¬æœ€å¥½æƒ³åŠæ³•<code>å°†ä½¿ç”¨æ–‡ä»¶æ’åºçš„æ‰§è¡Œæ–¹å¼æ”¹ä¸ºç´¢å¼•è¿›è¡Œæ’åº</code>ã€‚</p><ul><li><p><code>Using temporary</code></p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220704145924130.png" class=""><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; EXPLAIN SELECT DISTINCT common_field FROM s1;</span><br></pre></td></tr></table></figure></li></ul><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220704150030005.png" class=""><p>  å†æ¯”å¦‚ï¼š</p>  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; EXPLAIN SELECT common_field, COUNT(*) AS amount FROM s1 GROUP BY common_field;</span><br></pre></td></tr></table></figure><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220704150156416.png" class=""><p>  æ‰§è¡Œè®¡åˆ’ä¸­å‡ºç°<code>Using temporary</code>å¹¶ä¸æ˜¯ä¸€ä¸ªå¥½çš„å¾å…†ï¼Œå› ä¸ºå»ºç«‹ä¸ç»´æŠ¤ä¸´æ—¶è¡¨è¦ä»˜å‡ºå¾ˆå¤§çš„æˆæœ¬çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬<code>æœ€å¥½èƒ½ä½¿ç”¨ç´¢å¼•æ¥æ›¿ä»£æ‰ä½¿ç”¨ä¸´æ—¶è¡¨</code>ï¼Œæ¯”æ–¹è¯´ä¸‹è¾¹è¿™ä¸ªåŒ…å«<code>GROUP BY</code>å­å¥çš„æŸ¥è¯¢å°±ä¸éœ€è¦ä½¿ç”¨ä¸´æ—¶è¡¨ï¼š</p>  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; EXPLAIN SELECT key1, COUNT(*) AS amount FROM s1 GROUP BY key1;</span><br></pre></td></tr></table></figure><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220704150308189.png" class=""><p>  ä» <code>Extra</code> çš„ <code>Using index</code> çš„æç¤ºé‡Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºï¼Œä¸Šè¿°æŸ¥è¯¢åªéœ€è¦æ‰«æ <code>idx_key1</code> ç´¢å¼•å°±å¯ä»¥æ å®šäº†ï¼Œä¸å†éœ€è¦ä¸´æ—¶è¡¨äº†ã€‚</p><ul><li><p>å…¶ä»–</p><p>å…¶å®ƒç‰¹æ®Šæƒ…å†µè¿™é‡Œçœç•¥ã€‚</p></li></ul><h4 id="12-å°ç»“"><a href="#12-å°ç»“" class="headerlink" title="12. å°ç»“"></a>12. å°ç»“</h4><ul><li>EXPLAINä¸è€ƒè™‘å„ç§Cache </li><li>EXPLAINä¸èƒ½æ˜¾ç¤ºMySQLåœ¨æ‰§è¡ŒæŸ¥è¯¢æ—¶æ‰€ä½œçš„ä¼˜åŒ–å·¥ä½œ </li><li>EXPLAINä¸ä¼šå‘Šè¯‰ä½ å…³äºè§¦å‘å™¨ã€å­˜å‚¨è¿‡ç¨‹çš„ä¿¡æ¯æˆ–ç”¨æˆ·è‡ªå®šä¹‰å‡½æ•°å¯¹æŸ¥è¯¢çš„å½±å“æƒ…å†µ </li><li>éƒ¨åˆ†ç»Ÿè®¡ä¿¡æ¯æ˜¯ä¼°ç®—çš„ï¼Œå¹¶éç²¾ç¡®å€¼</li></ul><h2 id="7-EXPLAINçš„è¿›ä¸€æ­¥ä½¿ç”¨"><a href="#7-EXPLAINçš„è¿›ä¸€æ­¥ä½¿ç”¨" class="headerlink" title="7. EXPLAINçš„è¿›ä¸€æ­¥ä½¿ç”¨"></a>7. EXPLAINçš„è¿›ä¸€æ­¥ä½¿ç”¨</h2><h3 id="7-1-EXPLAINå››ç§è¾“å‡ºæ ¼å¼"><a href="#7-1-EXPLAINå››ç§è¾“å‡ºæ ¼å¼" class="headerlink" title="7.1 EXPLAINå››ç§è¾“å‡ºæ ¼å¼"></a>7.1 EXPLAINå››ç§è¾“å‡ºæ ¼å¼</h3><p>è¿™é‡Œè°ˆè°ˆEXPLAINçš„è¾“å‡ºæ ¼å¼ã€‚EXPLAINå¯ä»¥è¾“å‡ºå››ç§æ ¼å¼ï¼š <code>ä¼ ç»Ÿæ ¼å¼</code> ï¼Œ<code>JSONæ ¼å¼</code> ï¼Œ <code>TREEæ ¼å¼</code> ä»¥åŠ <code>å¯è§†åŒ–è¾“å‡º</code> ã€‚ç”¨æˆ·å¯ä»¥æ ¹æ®éœ€è¦é€‰æ‹©é€‚ç”¨äºè‡ªå·±çš„æ ¼å¼ã€‚</p><h4 id="1-ä¼ ç»Ÿæ ¼å¼"><a href="#1-ä¼ ç»Ÿæ ¼å¼" class="headerlink" title="1. ä¼ ç»Ÿæ ¼å¼"></a>1. ä¼ ç»Ÿæ ¼å¼</h4><p>ä¼ ç»Ÿæ ¼å¼ç®€å•æ˜äº†ï¼Œè¾“å‡ºæ˜¯ä¸€ä¸ªè¡¨æ ¼å½¢å¼ï¼Œæ¦‚è¦è¯´æ˜æŸ¥è¯¢è®¡åˆ’ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; EXPLAIN SELECT s1.key1, s2.key1 FROM s1 LEFT JOIN s2 ON s1.key1 = s2.key1 WHERE s2.common_field IS NOT NULL;</span><br></pre></td></tr></table></figure><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220704161702384.png" class=""><h4 id="2-JSONæ ¼å¼"><a href="#2-JSONæ ¼å¼" class="headerlink" title="2. JSONæ ¼å¼"></a>2. JSONæ ¼å¼</h4><p>ç¬¬1ç§æ ¼å¼ä¸­ä»‹ç»çš„<code>EXPLAIN</code>è¯­å¥è¾“å‡ºä¸­ç¼ºå°‘äº†ä¸€ä¸ªè¡¡é‡æ‰§è¡Œå¥½åçš„é‡è¦å±æ€§ â€”â€” <code>æˆæœ¬</code>ã€‚è€ŒJSONæ ¼å¼æ˜¯å››ç§æ ¼å¼é‡Œé¢è¾“å‡º<code>ä¿¡æ¯æœ€è¯¦å°½</code>çš„æ ¼å¼ï¼Œé‡Œé¢åŒ…å«äº†æ‰§è¡Œçš„æˆæœ¬ä¿¡æ¯ã€‚</p><ul><li>JSONæ ¼å¼ï¼šåœ¨EXPLAINå•è¯å’ŒçœŸæ­£çš„æŸ¥è¯¢è¯­å¥ä¸­é—´åŠ ä¸Š FORMAT&#x3D;JSON ã€‚</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN FORMAT=JSON SELECT ....</span><br></pre></td></tr></table></figure><ul><li>EXPLAINçš„Columnä¸JSONçš„å¯¹åº”å…³ç³»ï¼š(æ¥æºäºMySQL 5.7æ–‡æ¡£)</li></ul><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220704164236909.png" class=""><p>è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥å¾—åˆ°ä¸€ä¸ªjsonæ ¼å¼çš„æ‰§è¡Œè®¡åˆ’ï¼Œé‡Œé¢åŒ…å«è¯¥è®¡åˆ’èŠ±è´¹çš„æˆæœ¬ã€‚æ¯”å¦‚è¿™æ ·ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; EXPLAIN FORMAT=JSON SELECT * FROM s1 INNER JOIN s2 ON s1.key1 = s2.key2 WHERE s1.common_field = &#x27;a&#x27;\G</span><br></pre></td></tr></table></figure><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220704172833362.png" class=""><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220704172920158.png" class=""><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220704173012413.png" class=""><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220704173045190.png" class=""><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220704173108888.png" class=""><p>æˆ‘ä»¬ä½¿ç”¨ # åè¾¹è·Ÿéšæ³¨é‡Šçš„å½¢å¼ä¸ºå¤§å®¶è§£é‡Šäº† <code>EXPLAIN FORMAT=JSON</code> è¯­å¥çš„è¾“å‡ºå†…å®¹ï¼Œä½†æ˜¯å¤§å®¶å¯èƒ½ æœ‰ç–‘é—® â€œ<code>cost_info</code>â€œ é‡Œè¾¹çš„æˆæœ¬çœ‹ç€æ€ªæ€ªçš„ï¼Œå®ƒä»¬æ˜¯æ€ä¹ˆè®¡ç®—å‡ºæ¥çš„ï¼Ÿå…ˆçœ‹ s1 è¡¨çš„ â€œ<code>cost_info</code>â€œ éƒ¨ åˆ†ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&quot;cost_info&quot;: &#123;</span><br><span class="line">    &quot;read_cost&quot;: &quot;1840.84&quot;,</span><br><span class="line">    &quot;eval_cost&quot;: &quot;193.76&quot;,</span><br><span class="line">    &quot;prefix_cost&quot;: &quot;2034.60&quot;,</span><br><span class="line">    &quot;data_read_per_join&quot;: &quot;1M&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li><p><code>read_cost</code> æ˜¯ç”±ä¸‹è¾¹è¿™ä¸¤éƒ¨åˆ†ç»„æˆçš„ï¼š</p><ul><li>IO æˆæœ¬</li><li>æ£€æµ‹ rows Ã— (1 - filter) æ¡è®°å½•çš„ CPU æˆæœ¬</li></ul><blockquote><p>å°è´´å£«ï¼š rowså’Œfilteréƒ½æ˜¯æˆ‘ä»¬å‰è¾¹ä»‹ç»æ‰§è¡Œè®¡åˆ’çš„è¾“å‡ºåˆ—ï¼Œåœ¨JSONæ ¼å¼çš„æ‰§è¡Œè®¡åˆ’ä¸­ï¼Œrows ç›¸å½“äºrows_examined_per_scanï¼Œfilteredåç§°ä¸å˜ã€‚</p></blockquote></li></ul><ul><li><p><code>eval_cost</code> æ˜¯è¿™æ ·è®¡ç®—çš„ï¼š</p><p>æ£€æµ‹ rows Ã— filter æ¡è®°å½•çš„æˆæœ¬ã€‚</p></li><li><p><code>prefix_cost</code> å°±æ˜¯å•ç‹¬æŸ¥è¯¢ s1 è¡¨çš„æˆæœ¬ï¼Œä¹Ÿå°±æ˜¯ï¼š</p><p><code>read_cost + eval_cost</code></p></li><li><p><code>data_read_per_join</code> è¡¨ç¤ºåœ¨æ­¤æ¬¡æŸ¥è¯¢ä¸­éœ€è¦è¯»å–çš„æ•°æ®é‡ã€‚</p></li></ul><p>å¯¹äº <code>s2</code> è¡¨çš„ â€œ<code>cost_info</code>â€œ éƒ¨åˆ†æ˜¯è¿™æ ·çš„ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&quot;cost_info&quot;: &#123;</span><br><span class="line">    &quot;read_cost&quot;: &quot;968.80&quot;,</span><br><span class="line">    &quot;eval_cost&quot;: &quot;193.76&quot;,</span><br><span class="line">    &quot;prefix_cost&quot;: &quot;3197.16&quot;,</span><br><span class="line">    &quot;data_read_per_join&quot;: &quot;1M&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”±äº <code>s2</code> è¡¨æ˜¯è¢«é©±åŠ¨è¡¨ï¼Œæ‰€ä»¥å¯èƒ½è¢«è¯»å–å¤šæ¬¡ï¼Œè¿™é‡Œçš„<code>read_cost</code> å’Œ <code>eval_cost</code> æ˜¯è®¿é—®å¤šæ¬¡ <code>s2</code> è¡¨åç´¯åŠ èµ·æ¥çš„å€¼ï¼Œå¤§å®¶ä¸»è¦å…³æ³¨é‡Œè¾¹å„¿çš„ <code>prefix_cost</code> çš„å€¼ä»£è¡¨çš„æ˜¯æ•´ä¸ªè¿æ¥æŸ¥è¯¢é¢„è®¡çš„æˆæœ¬ï¼Œä¹Ÿå°±æ˜¯å•æ¬¡æŸ¥è¯¢ <code>s1</code> è¡¨å’Œå¤šæ¬¡æŸ¥è¯¢ <code>s2</code> è¡¨åçš„æˆæœ¬çš„å’Œï¼Œä¹Ÿå°±æ˜¯ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">968.80 + 193.76 + 2034.60 = 3197.16</span><br></pre></td></tr></table></figure><h4 id="3-TREEæ ¼å¼"><a href="#3-TREEæ ¼å¼" class="headerlink" title="3. TREEæ ¼å¼"></a>3. TREEæ ¼å¼</h4><p>TREEæ ¼å¼æ˜¯8.0.16ç‰ˆæœ¬ä¹‹åå¼•å…¥çš„æ–°æ ¼å¼ï¼Œä¸»è¦æ ¹æ®æŸ¥è¯¢çš„ <code>å„ä¸ªéƒ¨åˆ†ä¹‹é—´çš„å…³ç³»</code> å’Œ <code>å„éƒ¨åˆ†çš„æ‰§è¡Œé¡ºåº</code> æ¥æè¿°å¦‚ä½•æŸ¥è¯¢ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; EXPLAIN FORMAT=tree SELECT * FROM s1 INNER JOIN s2 ON s1.key1 = s2.key2 WHERE</span><br><span class="line">s1.common_field = &#x27;a&#x27;\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">EXPLAIN: -&gt; Nested loop inner join (cost=1360.08 rows=990)</span><br><span class="line">-&gt; Filter: ((s1.common_field = &#x27;a&#x27;) and (s1.key1 is not null)) (cost=1013.75</span><br><span class="line">rows=990)</span><br><span class="line">-&gt; Table scan on s1 (cost=1013.75 rows=9895)</span><br><span class="line">-&gt; Single-row index lookup on s2 using idx_key2 (key2=s1.key1), with index</span><br><span class="line">condition: (cast(s1.key1 as double) = cast(s2.key2 as double)) (cost=0.25 rows=1)</span><br><span class="line">1 row in set, 1 warning (0.00 sec)</span><br></pre></td></tr></table></figure><h4 id="4-å¯è§†åŒ–è¾“å‡º"><a href="#4-å¯è§†åŒ–è¾“å‡º" class="headerlink" title="4. å¯è§†åŒ–è¾“å‡º"></a>4. å¯è§†åŒ–è¾“å‡º</h4><p>å¯è§†åŒ–è¾“å‡ºï¼Œå¯ä»¥é€šè¿‡MySQL Workbenchå¯è§†åŒ–æŸ¥çœ‹MySQLçš„æ‰§è¡Œè®¡åˆ’ã€‚é€šè¿‡ç‚¹å‡»Workbenchçš„æ”¾å¤§é•œå›¾æ ‡ï¼Œå³å¯ç”Ÿæˆå¯è§†åŒ–çš„æŸ¥è¯¢è®¡åˆ’ã€‚ </p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220704174401970.png" class=""><p>ä¸Šå›¾æŒ‰ä»å·¦åˆ°å³çš„è¿æ¥é¡ºåºæ˜¾ç¤ºè¡¨ã€‚çº¢è‰²æ¡†è¡¨ç¤º <code>å…¨è¡¨æ‰«æ</code> ï¼Œè€Œç»¿è‰²æ¡†è¡¨ç¤ºä½¿ç”¨ <code>ç´¢å¼•æŸ¥æ‰¾</code> ã€‚å¯¹äºæ¯ä¸ªè¡¨ï¼Œ æ˜¾ç¤ºä½¿ç”¨çš„ç´¢å¼•ã€‚è¿˜è¦æ³¨æ„çš„æ˜¯ï¼Œæ¯ä¸ªè¡¨æ ¼çš„æ¡†ä¸Šæ–¹æ˜¯æ¯ä¸ªè¡¨è®¿é—®æ‰€å‘ç°çš„è¡Œæ•°çš„ä¼°è®¡å€¼ä»¥åŠè®¿é—®è¯¥è¡¨çš„æˆæœ¬ã€‚</p><h3 id="7-2-SHOW-WARNINGSçš„ä½¿ç”¨"><a href="#7-2-SHOW-WARNINGSçš„ä½¿ç”¨" class="headerlink" title="7.2 SHOW WARNINGSçš„ä½¿ç”¨"></a>7.2 SHOW WARNINGSçš„ä½¿ç”¨</h3><p>åœ¨æˆ‘ä»¬ä½¿ç”¨<code>EXPLAIN</code>è¯­å¥æŸ¥çœ‹äº†æŸä¸ªæŸ¥è¯¢çš„æ‰§è¡Œè®¡åˆ’åï¼Œç´§æ¥ç€è¿˜å¯ä»¥ä½¿ç”¨<code>SHOW WARNINGS</code>è¯­å¥æŸ¥çœ‹ä¸è¿™ä¸ªæŸ¥è¯¢çš„æ‰§è¡Œè®¡åˆ’æœ‰å…³çš„ä¸€äº›æ‰©å±•ä¿¡æ¯ï¼Œæ¯”å¦‚è¿™æ ·ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; EXPLAIN SELECT s1.key1, s2.key1 FROM s1 LEFT JOIN s2 ON s1.key1 = s2.key1 WHERE s2.common_field IS NOT NULL;</span><br></pre></td></tr></table></figure><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220704174543663.png" class=""><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SHOW WARNINGS\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">    Level: Note</span><br><span class="line">     Code: 1003</span><br><span class="line">Message: /* select#1 */ select `atguigu`.`s1`.`key1` AS `key1`,`atguigu`.`s2`.`key1`</span><br><span class="line">AS `key1` from `atguigu`.`s1` join `atguigu`.`s2` where ((`atguigu`.`s1`.`key1` =</span><br><span class="line">`atguigu`.`s2`.`key1`) and (`atguigu`.`s2`.`common_field` is not null))</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure><p>å¤§å®¶å¯ä»¥çœ‹åˆ°<code>SHOW WARNINGS</code>å±•ç¤ºå‡ºæ¥çš„ä¿¡æ¯æœ‰ä¸‰ä¸ªå­—æ®µï¼Œåˆ†åˆ«æ˜¯<code>Levelã€Codeã€Message</code>ã€‚æˆ‘ä»¬æœ€å¸¸è§çš„å°±æ˜¯Codeä¸º1003çš„ä¿¡æ¯ï¼Œå½“Codeå€¼ä¸º1003æ—¶ï¼Œ<code>Message</code>å­—æ®µå±•ç¤ºçš„ä¿¡æ¯ç±»ä¼¼äºæŸ¥è¯¢ä¼˜åŒ–å™¨å°†æˆ‘ä»¬çš„æŸ¥è¯¢è¯­å¥é‡å†™åçš„è¯­å¥ã€‚æ¯”å¦‚æˆ‘ä»¬ä¸Šè¾¹çš„æŸ¥è¯¢æœ¬æ¥æ˜¯ä¸€ä¸ªå·¦(å¤–)è¿æ¥æŸ¥è¯¢ï¼Œä½†æ˜¯æœ‰ä¸€ä¸ªs2.common_field IS NOT NULLçš„æ¡ä»¶ï¼Œè¿™å°±ä¼šå¯¼è‡´æŸ¥è¯¢ä¼˜åŒ–å™¨æŠŠå·¦(å¤–)è¿æ¥æŸ¥è¯¢ä¼˜åŒ–ä¸ºå†…è¿æ¥æŸ¥è¯¢ï¼Œä»<code>SHOW WARNINGS</code>çš„<code>Message</code>å­—æ®µä¹Ÿå¯ä»¥çœ‹å‡ºæ¥ï¼ŒåŸæœ¬çš„LEFE JOINå·²ç»å˜æˆäº†JOINã€‚</p><p>ä½†æ˜¯å¤§å®¶ä¸€å®šè¦æ³¨æ„ï¼Œæˆ‘ä»¬è¯´<code>Message</code>å­—æ®µå±•ç¤ºçš„ä¿¡æ¯ç±»ä¼¼äºæŸ¥è¯¢ä¼˜åŒ–å™¨å°†æˆ‘ä»¬çš„æŸ¥è¯¢è¯­å¥<code>é‡å†™åçš„è¯­å¥</code>ï¼Œå¹¶ä¸æ˜¯ç­‰ä»·äºï¼Œä¹Ÿå°±æ˜¯è¯´<code>Message</code>å­—æ®µå±•ç¤ºçš„ä¿¡æ¯å¹¶ä¸æ˜¯æ ‡å‡†çš„æŸ¥è¯¢è¯­å¥ï¼Œåœ¨å¾ˆå¤šæƒ…å†µä¸‹å¹¶ä¸èƒ½ç›´æ¥æ‹¿åˆ°é»‘æ¡†æ¡†ä¸­è¿è¡Œï¼Œå®ƒåªèƒ½ä½œä¸ºå¸®åŠ©æˆ‘ä»¬ç†è§£MySQLå°†å¦‚ä½•æ‰§è¡ŒæŸ¥è¯¢è¯­å¥çš„ä¸€ä¸ªå‚è€ƒä¾æ®è€Œå·²ã€‚</p><h2 id="8-åˆ†æä¼˜åŒ–å™¨æ‰§è¡Œè®¡åˆ’ï¼štrace"><a href="#8-åˆ†æä¼˜åŒ–å™¨æ‰§è¡Œè®¡åˆ’ï¼štrace" class="headerlink" title="8. åˆ†æä¼˜åŒ–å™¨æ‰§è¡Œè®¡åˆ’ï¼štrace"></a>8. åˆ†æä¼˜åŒ–å™¨æ‰§è¡Œè®¡åˆ’ï¼štrace</h2><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220704175711800.png" class=""><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SET optimizer_trace=&quot;enabled=on&quot;,end_markers_in_json=on;</span><br><span class="line">set optimizer_trace_max_mem_size=1000000;</span><br></pre></td></tr></table></figure><p>å¼€å¯åï¼Œå¯åˆ†æå¦‚ä¸‹è¯­å¥ï¼š </p><ul><li>SELECT </li><li>INSERT </li><li>REPLACE</li><li>UPDATE </li><li>DELETE </li><li>EXPLAIN </li><li>SET </li><li>DECLARE </li><li>CASE </li><li>IF </li><li>RETURN </li><li>CALL</li></ul><p>æµ‹è¯•ï¼šæ‰§è¡Œå¦‚ä¸‹SQLè¯­å¥</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from student where id &lt; 10;</span><br></pre></td></tr></table></figure><p>æœ€åï¼Œ æŸ¥è¯¢ information_schema.optimizer_trace å°±å¯ä»¥çŸ¥é“MySQLæ˜¯å¦‚ä½•æ‰§è¡ŒSQLçš„ ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from information_schema.optimizer_trace\G</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br></pre></td><td class="code"><pre><span class="line">*************************** 1. row ***************************</span><br><span class="line">//ç¬¬1éƒ¨åˆ†ï¼šæŸ¥è¯¢è¯­å¥</span><br><span class="line">QUERY: select * from student where id &lt; 10</span><br><span class="line">//ç¬¬2éƒ¨åˆ†ï¼šQUERYå­—æ®µå¯¹åº”è¯­å¥çš„è·Ÿè¸ªä¿¡æ¯</span><br><span class="line">TRACE: &#123;</span><br><span class="line">&quot;steps&quot;: [</span><br><span class="line">&#123;</span><br><span class="line">    &quot;join_preparation&quot;: &#123; //é¢„å¤‡å·¥ä½œ</span><br><span class="line">        &quot;select#&quot;: 1,</span><br><span class="line">        &quot;steps&quot;: [</span><br><span class="line">            &#123;</span><br><span class="line">            &quot;expanded_query&quot;: &quot;/* select#1 */ select `student`.`id` AS</span><br><span class="line">            `id`,`student`.`stuno` AS `stuno`,`student`.`name` AS `name`,`student`.`age` AS</span><br><span class="line">            `age`,`student`.`classId` AS `classId` from `student` where (`student`.`id` &lt; 10)&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        ] /* steps */</span><br><span class="line">    &#125; /* join_preparation */</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">    &quot;join_optimization&quot;: &#123; //è¿›è¡Œä¼˜åŒ–</span><br><span class="line">    &quot;select#&quot;: 1,</span><br><span class="line">    &quot;steps&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">        &quot;condition_processing&quot;: &#123; //æ¡ä»¶å¤„ç†</span><br><span class="line">        &quot;condition&quot;: &quot;WHERE&quot;,</span><br><span class="line">        &quot;original_condition&quot;: &quot;(`student`.`id` &lt; 10)&quot;,</span><br><span class="line">        &quot;steps&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;transformation&quot;: &quot;equality_propagation&quot;,</span><br><span class="line">            &quot;resulting_condition&quot;: &quot;(`student`.`id` &lt; 10)&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;transformation&quot;: &quot;constant_propagation&quot;,</span><br><span class="line">            &quot;resulting_condition&quot;: &quot;(`student`.`id` &lt; 10)&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;transformation&quot;: &quot;trivial_condition_removal&quot;,</span><br><span class="line">            &quot;resulting_condition&quot;: &quot;(`student`.`id` &lt; 10)&quot;</span><br><span class="line">        &#125;</span><br><span class="line">        ] /* steps */</span><br><span class="line">    &#125; /* condition_processing */</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;substitute_generated_columns&quot;: &#123; //æ›¿æ¢ç”Ÿæˆçš„åˆ—</span><br><span class="line">        &#125; /* substitute_generated_columns */</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;table_dependencies&quot;: [ //è¡¨çš„ä¾èµ–å…³ç³»</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;table&quot;: &quot;`student`&quot;,</span><br><span class="line">            &quot;row_may_be_null&quot;: false,</span><br><span class="line">            &quot;map_bit&quot;: 0,</span><br><span class="line">            &quot;depends_on_map_bits&quot;: [</span><br><span class="line">            ] /* depends_on_map_bits */</span><br><span class="line">        &#125;</span><br><span class="line">    ] /* table_dependencies */</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">    &quot;ref_optimizer_key_uses&quot;: [ //ä½¿ç”¨é”®</span><br><span class="line">        ] /* ref_optimizer_key_uses */</span><br><span class="line">        &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;rows_estimation&quot;: [ //è¡Œåˆ¤æ–­</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;table&quot;: &quot;`student`&quot;,</span><br><span class="line">            &quot;range_analysis&quot;: &#123;</span><br><span class="line">                &quot;table_scan&quot;: &#123;</span><br><span class="line">                    &quot;rows&quot;: 3973767,</span><br><span class="line">                    &quot;cost&quot;: 408558</span><br><span class="line">            &#125; /* table_scan */, //æ‰«æè¡¨</span><br><span class="line">            &quot;potential_range_indexes&quot;: [ //æ½œåœ¨çš„èŒƒå›´ç´¢å¼•</span><br><span class="line">                &#123;</span><br><span class="line">                    &quot;index&quot;: &quot;PRIMARY&quot;,</span><br><span class="line">                    &quot;usable&quot;: true,</span><br><span class="line">                    &quot;key_parts&quot;: [</span><br><span class="line">                    &quot;id&quot;</span><br><span class="line">                    ] /* key_parts */</span><br><span class="line">                &#125;</span><br><span class="line">            ] /* potential_range_indexes */,</span><br><span class="line">        &quot;setup_range_conditions&quot;: [ //è®¾ç½®èŒƒå›´æ¡ä»¶</span><br><span class="line">        ] /* setup_range_conditions */,</span><br><span class="line">        &quot;group_index_range&quot;: &#123;</span><br><span class="line">            &quot;chosen&quot;: false,</span><br><span class="line">            &quot;cause&quot;: &quot;not_group_by_or_distinct&quot;</span><br><span class="line">        &#125; /* group_index_range */,</span><br><span class="line">            &quot;skip_scan_range&quot;: &#123;</span><br><span class="line">                &quot;potential_skip_scan_indexes&quot;: [</span><br><span class="line">                    &#123;</span><br><span class="line">                        &quot;index&quot;: &quot;PRIMARY&quot;,</span><br><span class="line">                        &quot;usable&quot;: false,</span><br><span class="line">                        &quot;cause&quot;: &quot;query_references_nonkey_column&quot;</span><br><span class="line">                    &#125;</span><br><span class="line">                ] /* potential_skip_scan_indexes */</span><br><span class="line">            &#125; /* skip_scan_range */,</span><br><span class="line">        &quot;analyzing_range_alternatives&quot;: &#123; //åˆ†æèŒƒå›´é€‰é¡¹</span><br><span class="line">            &quot;range_scan_alternatives&quot;: [</span><br><span class="line">                &#123;</span><br><span class="line">                &quot;index&quot;: &quot;PRIMARY&quot;,</span><br><span class="line">                    &quot;ranges&quot;: [</span><br><span class="line">                        &quot;id &lt; 10&quot;</span><br><span class="line">                    ] /* ranges */,</span><br><span class="line">                &quot;index_dives_for_eq_ranges&quot;: true,</span><br><span class="line">                &quot;rowid_ordered&quot;: true,</span><br><span class="line">                &quot;using_mrr&quot;: false,</span><br><span class="line">                &quot;index_only&quot;: false,</span><br><span class="line">                &quot;rows&quot;: 9,</span><br><span class="line">                &quot;cost&quot;: 1.91986,</span><br><span class="line">                &quot;chosen&quot;: true</span><br><span class="line">                &#125;</span><br><span class="line">            ] /* range_scan_alternatives */,</span><br><span class="line">        &quot;analyzing_roworder_intersect&quot;: &#123;</span><br><span class="line">            &quot;usable&quot;: false,</span><br><span class="line">            &quot;cause&quot;: &quot;too_few_roworder_scans&quot;</span><br><span class="line">        &#125; /* analyzing_roworder_intersect */</span><br><span class="line">        &#125; /* analyzing_range_alternatives */,</span><br><span class="line">        &quot;chosen_range_access_summary&quot;: &#123; //é€‰æ‹©èŒƒå›´è®¿é—®æ‘˜è¦</span><br><span class="line">            &quot;range_access_plan&quot;: &#123;</span><br><span class="line">                &quot;type&quot;: &quot;range_scan&quot;,</span><br><span class="line">                &quot;index&quot;: &quot;PRIMARY&quot;,</span><br><span class="line">                &quot;rows&quot;: 9,</span><br><span class="line">                &quot;ranges&quot;: [</span><br><span class="line">                &quot;id &lt; 10&quot;</span><br><span class="line">                ] /* ranges */</span><br><span class="line">                &#125; /* range_access_plan */,</span><br><span class="line">                &quot;rows_for_plan&quot;: 9,</span><br><span class="line">                &quot;cost_for_plan&quot;: 1.91986,</span><br><span class="line">                &quot;chosen&quot;: true</span><br><span class="line">                &#125; /* chosen_range_access_summary */</span><br><span class="line">                &#125; /* range_analysis */</span><br><span class="line">            &#125;</span><br><span class="line">        ] /* rows_estimation */</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">    &quot;considered_execution_plans&quot;: [ //è€ƒè™‘æ‰§è¡Œè®¡åˆ’</span><br><span class="line">    &#123;</span><br><span class="line">    &quot;plan_prefix&quot;: [</span><br><span class="line">    ] /* plan_prefix */,</span><br><span class="line">        &quot;table&quot;: &quot;`student`&quot;,</span><br><span class="line">        &quot;best_access_path&quot;: &#123; //æœ€ä½³è®¿é—®è·¯å¾„</span><br><span class="line">        &quot;considered_access_paths&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;rows_to_scan&quot;: 9,</span><br><span class="line">            &quot;access_type&quot;: &quot;range&quot;,</span><br><span class="line">            &quot;range_details&quot;: &#123;</span><br><span class="line">            &quot;used_index&quot;: &quot;PRIMARY&quot;</span><br><span class="line">        &#125; /* range_details */,</span><br><span class="line">        &quot;resulting_rows&quot;: 9,</span><br><span class="line">        &quot;cost&quot;: 2.81986,</span><br><span class="line">        &quot;chosen&quot;: true</span><br><span class="line">    &#125;</span><br><span class="line">    ] /* considered_access_paths */</span><br><span class="line">    &#125; /* best_access_path */,</span><br><span class="line">        &quot;condition_filtering_pct&quot;: 100, //è¡Œè¿‡æ»¤ç™¾åˆ†æ¯”</span><br><span class="line">        &quot;rows_for_plan&quot;: 9,</span><br><span class="line">        &quot;cost_for_plan&quot;: 2.81986,</span><br><span class="line">        &quot;chosen&quot;: true</span><br><span class="line">    &#125;</span><br><span class="line">    ] /* considered_execution_plans */</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;attaching_conditions_to_tables&quot;: &#123; //å°†æ¡ä»¶é™„åŠ åˆ°è¡¨ä¸Š</span><br><span class="line">        &quot;original_condition&quot;: &quot;(`student`.`id` &lt; 10)&quot;,</span><br><span class="line">        &quot;attached_conditions_computation&quot;: [</span><br><span class="line">        ] /* attached_conditions_computation */,</span><br><span class="line">        &quot;attached_conditions_summary&quot;: [ //é™„åŠ æ¡ä»¶æ¦‚è¦</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;table&quot;: &quot;`student`&quot;,</span><br><span class="line">        &quot;attached&quot;: &quot;(`student`.`id` &lt; 10)&quot;</span><br><span class="line">    &#125;</span><br><span class="line">    ] /* attached_conditions_summary */</span><br><span class="line">    &#125; /* attaching_conditions_to_tables */</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">    &quot;finalizing_table_conditions&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;table&quot;: &quot;`student`&quot;,</span><br><span class="line">        &quot;original_table_condition&quot;: &quot;(`student`.`id` &lt; 10)&quot;,</span><br><span class="line">        &quot;final_table_condition &quot;: &quot;(`student`.`id` &lt; 10)&quot;</span><br><span class="line">    &#125;</span><br><span class="line">    ] /* finalizing_table_conditions */</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">    &quot;refine_plan&quot;: [ //ç²¾ç®€è®¡åˆ’</span><br><span class="line">    &#123;</span><br><span class="line">    &quot;table&quot;: &quot;`student`&quot;</span><br><span class="line">    &#125;</span><br><span class="line">    ] /* refine_plan */</span><br><span class="line">    &#125;</span><br><span class="line">    ] /* steps */</span><br><span class="line">    &#125; /* join_optimization */</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">        &quot;join_execution&quot;: &#123; //æ‰§è¡Œ</span><br><span class="line">            &quot;select#&quot;: 1,</span><br><span class="line">            &quot;steps&quot;: [</span><br><span class="line">            ] /* steps */</span><br><span class="line">        &#125; /* join_execution */</span><br><span class="line">        &#125;</span><br><span class="line">    ] /* steps */</span><br><span class="line">&#125;</span><br><span class="line">//ç¬¬3éƒ¨åˆ†ï¼šè·Ÿè¸ªä¿¡æ¯è¿‡é•¿æ—¶ï¼Œè¢«æˆªæ–­çš„è·Ÿè¸ªä¿¡æ¯çš„å­—èŠ‚æ•°ã€‚</span><br><span class="line">MISSING_BYTES_BEYOND_MAX_MEM_SIZE: 0 //ä¸¢å¤±çš„è¶…å‡ºæœ€å¤§å®¹é‡çš„å­—èŠ‚</span><br><span class="line">//ç¬¬4éƒ¨åˆ†ï¼šæ‰§è¡Œè·Ÿè¸ªè¯­å¥çš„ç”¨æˆ·æ˜¯å¦æœ‰æŸ¥çœ‹å¯¹è±¡çš„æƒé™ã€‚å½“ä¸å…·æœ‰æƒé™æ—¶ï¼Œè¯¥åˆ—ä¿¡æ¯ä¸º1ä¸”TRACEå­—æ®µä¸ºç©ºï¼Œä¸€èˆ¬åœ¨</span><br><span class="line">è°ƒç”¨å¸¦æœ‰SQL SECURITY DEFINERçš„è§†å›¾æˆ–è€…æ˜¯å­˜å‚¨è¿‡ç¨‹çš„æƒ…å†µä¸‹ï¼Œä¼šå‡ºç°æ­¤é—®é¢˜ã€‚</span><br><span class="line">INSUFFICIENT_PRIVILEGES: 0 //ç¼ºå¤±æƒé™</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure><h2 id="9-MySQLç›‘æ§åˆ†æè§†å›¾-sys-schema"><a href="#9-MySQLç›‘æ§åˆ†æè§†å›¾-sys-schema" class="headerlink" title="9. MySQLç›‘æ§åˆ†æè§†å›¾-sys schema"></a>9. MySQLç›‘æ§åˆ†æè§†å›¾-sys schema</h2><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220704190726180.png" class=""><h3 id="9-1-Sys-schemaè§†å›¾æ‘˜è¦"><a href="#9-1-Sys-schemaè§†å›¾æ‘˜è¦" class="headerlink" title="9.1 Sys schemaè§†å›¾æ‘˜è¦"></a>9.1 Sys schemaè§†å›¾æ‘˜è¦</h3><ol><li><strong>ä¸»æœºç›¸å…³</strong>ï¼šä»¥host_summaryå¼€å¤´ï¼Œä¸»è¦æ±‡æ€»äº†IOå»¶è¿Ÿçš„ä¿¡æ¯ã€‚ </li><li><strong>Innodbç›¸å…³</strong>ï¼šä»¥innodbå¼€å¤´ï¼Œæ±‡æ€»äº†innodb bufferä¿¡æ¯å’Œäº‹åŠ¡ç­‰å¾…innodbé”çš„ä¿¡æ¯ã€‚ </li><li><strong>I&#x2F;oç›¸å…³</strong>ï¼šä»¥ioå¼€å¤´ï¼Œæ±‡æ€»äº†ç­‰å¾…I&#x2F;Oã€I&#x2F;Oä½¿ç”¨é‡æƒ…å†µã€‚ </li><li><strong>å†…å­˜ä½¿ç”¨æƒ…å†µ</strong>ï¼šä»¥memoryå¼€å¤´ï¼Œä»ä¸»æœºã€çº¿ç¨‹ã€äº‹ä»¶ç­‰è§’åº¦å±•ç¤ºå†…å­˜çš„ä½¿ç”¨æƒ…å†µ </li><li><strong>è¿æ¥ä¸ä¼šè¯ä¿¡æ¯</strong>ï¼šprocesslistå’Œsessionç›¸å…³è§†å›¾ï¼Œæ€»ç»“äº†ä¼šè¯ç›¸å…³ä¿¡æ¯ã€‚ </li><li><strong>è¡¨ç›¸å…³</strong>ï¼šä»¥schema_tableå¼€å¤´çš„è§†å›¾ï¼Œå±•ç¤ºäº†è¡¨çš„ç»Ÿè®¡ä¿¡æ¯ã€‚ </li><li><strong>ç´¢å¼•ä¿¡æ¯</strong>ï¼šç»Ÿè®¡äº†ç´¢å¼•çš„ä½¿ç”¨æƒ…å†µï¼ŒåŒ…å«å†—ä½™ç´¢å¼•å’Œæœªä½¿ç”¨çš„ç´¢å¼•æƒ…å†µã€‚ </li><li><strong>è¯­å¥ç›¸å…³</strong>ï¼šä»¥statementå¼€å¤´ï¼ŒåŒ…å«æ‰§è¡Œå…¨è¡¨æ‰«æã€ä½¿ç”¨ä¸´æ—¶è¡¨ã€æ’åºç­‰çš„è¯­å¥ä¿¡æ¯ã€‚ </li><li><strong>ç”¨æˆ·ç›¸å…³</strong>ï¼šä»¥userå¼€å¤´çš„è§†å›¾ï¼Œç»Ÿè®¡äº†ç”¨æˆ·ä½¿ç”¨çš„æ–‡ä»¶I&#x2F;Oã€æ‰§è¡Œè¯­å¥ç»Ÿè®¡ä¿¡æ¯ã€‚ </li><li><strong>ç­‰å¾…äº‹ä»¶ç›¸å…³ä¿¡æ¯</strong>ï¼šä»¥waitå¼€å¤´ï¼Œå±•ç¤ºç­‰å¾…äº‹ä»¶çš„å»¶è¿Ÿæƒ…å†µã€‚</li></ol><h3 id="9-2-Sys-schemaè§†å›¾ä½¿ç”¨åœºæ™¯"><a href="#9-2-Sys-schemaè§†å›¾ä½¿ç”¨åœºæ™¯" class="headerlink" title="9.2 Sys schemaè§†å›¾ä½¿ç”¨åœºæ™¯"></a>9.2 Sys schemaè§†å›¾ä½¿ç”¨åœºæ™¯</h3><p>ç´¢å¼•æƒ…å†µ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#1. æŸ¥è¯¢å†—ä½™ç´¢å¼•</span><br><span class="line">select * from sys.schema_redundant_indexes;</span><br><span class="line">#2. æŸ¥è¯¢æœªä½¿ç”¨è¿‡çš„ç´¢å¼•</span><br><span class="line">select * from sys.schema_unused_indexes;</span><br><span class="line">#3. æŸ¥è¯¢ç´¢å¼•çš„ä½¿ç”¨æƒ…å†µ</span><br><span class="line">select index_name,rows_selected,rows_inserted,rows_updated,rows_deleted</span><br><span class="line">from sys.schema_index_statistics where table_schema=&#x27;dbname&#x27;;</span><br></pre></td></tr></table></figure><p>è¡¨ç›¸å…³</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 1. æŸ¥è¯¢è¡¨çš„è®¿é—®é‡</span><br><span class="line">select table_schema,table_name,sum(io_read_requests+io_write_requests) as io from</span><br><span class="line">sys.schema_table_statistics group by table_schema,table_name order by io desc;</span><br><span class="line"># 2. æŸ¥è¯¢å ç”¨bufferpoolè¾ƒå¤šçš„è¡¨</span><br><span class="line">select object_schema,object_name,allocated,data</span><br><span class="line">from sys.innodb_buffer_stats_by_table order by allocated limit 10;</span><br><span class="line"># 3. æŸ¥çœ‹è¡¨çš„å…¨è¡¨æ‰«ææƒ…å†µ</span><br><span class="line">select * from sys.statements_with_full_table_scans where db=&#x27;dbname&#x27;;</span><br></pre></td></tr></table></figure><p>è¯­å¥ç›¸å…³</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">#1. ç›‘æ§SQLæ‰§è¡Œçš„é¢‘ç‡</span><br><span class="line">select db,exec_count,query from sys.statement_analysis</span><br><span class="line">order by exec_count desc;</span><br><span class="line">#2. ç›‘æ§ä½¿ç”¨äº†æ’åºçš„SQL</span><br><span class="line">select db,exec_count,first_seen,last_seen,query</span><br><span class="line">from sys.statements_with_sorting limit 1;</span><br><span class="line">#3. ç›‘æ§ä½¿ç”¨äº†ä¸´æ—¶è¡¨æˆ–è€…ç£ç›˜ä¸´æ—¶è¡¨çš„SQL</span><br><span class="line">select db,exec_count,tmp_tables,tmp_disk_tables,query</span><br><span class="line">from sys.statement_analysis where tmp_tables&gt;0 or tmp_disk_tables &gt;0</span><br><span class="line">order by (tmp_tables+tmp_disk_tables) desc;</span><br></pre></td></tr></table></figure><p>IOç›¸å…³</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#1. æŸ¥çœ‹æ¶ˆè€—ç£ç›˜IOçš„æ–‡ä»¶</span><br><span class="line">select file,avg_read,avg_write,avg_read+avg_write as avg_io</span><br><span class="line">from sys.io_global_by_file_by_bytes order by avg_read limit 10;</span><br></pre></td></tr></table></figure><p>Innodb ç›¸å…³</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#1. è¡Œé”é˜»å¡æƒ…å†µ</span><br><span class="line">select * from sys.innodb_lock_waits;</span><br></pre></td></tr></table></figure><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220704192020603.png" class=""><h2 id="10-å°ç»“"><a href="#10-å°ç»“" class="headerlink" title="10. å°ç»“"></a>10. å°ç»“</h2><p>æŸ¥è¯¢æ˜¯æ•°æ®åº“ä¸­æœ€é¢‘ç¹çš„æ“ä½œï¼Œæé«˜æŸ¥è¯¢é€Ÿåº¦å¯ä»¥æœ‰æ•ˆåœ°æé«˜MySQLæ•°æ®åº“çš„æ€§èƒ½ã€‚é€šè¿‡å¯¹æŸ¥è¯¢è¯­å¥çš„åˆ†æå¯ä»¥äº†è§£æŸ¥è¯¢è¯­å¥çš„æ‰§è¡Œæƒ…å†µï¼Œæ‰¾å‡ºæŸ¥è¯¢è¯­å¥æ‰§è¡Œçš„ç“¶é¢ˆï¼Œä»è€Œä¼˜åŒ–æŸ¥è¯¢è¯­å¥ã€‚</p><h1 id="ç¬¬10ç« -ç´¢å¼•ä¼˜åŒ–ä¸æŸ¥è¯¢ä¼˜åŒ–"><a href="#ç¬¬10ç« -ç´¢å¼•ä¼˜åŒ–ä¸æŸ¥è¯¢ä¼˜åŒ–" class="headerlink" title="ç¬¬10ç« _ç´¢å¼•ä¼˜åŒ–ä¸æŸ¥è¯¢ä¼˜åŒ–"></a>ç¬¬10ç« _ç´¢å¼•ä¼˜åŒ–ä¸æŸ¥è¯¢ä¼˜åŒ–</h1><p>éƒ½æœ‰å“ªäº›ç»´åº¦å¯ä»¥è¿›è¡Œæ•°æ®åº“è°ƒä¼˜ï¼Ÿç®€è¨€ä¹‹ï¼š</p><ul><li>ç´¢å¼•å¤±æ•ˆã€æ²¡æœ‰å……åˆ†åˆ©ç”¨åˆ°ç´¢å¼•â€”â€”å»ºç«‹ç´¢å¼•</li><li>å…³è”æŸ¥è¯¢å¤ªå¤šJOINï¼ˆè®¾è®¡ç¼ºé™·æˆ–ä¸å¾—å·²çš„éœ€æ±‚ï¼‰â€”â€”SQLä¼˜åŒ–</li><li>æœåŠ¡å™¨è°ƒä¼˜åŠå„ä¸ªå‚æ•°è®¾ç½®ï¼ˆç¼“å†²ã€çº¿ç¨‹æ•°ç­‰ï¼‰â€”â€”è°ƒæ•´my.cnf</li><li>æ•°æ®è¿‡å¤šâ€”â€”åˆ†åº“åˆ†è¡¨</li></ul><p>å…³äºæ•°æ®åº“è°ƒä¼˜çš„çŸ¥è¯†éå¸¸åˆ†æ•£ã€‚ä¸åŒçš„DBMSï¼Œä¸åŒçš„å…¬å¸ï¼Œä¸åŒçš„èŒä½ï¼Œä¸åŒçš„é¡¹ç›®é‡åˆ°çš„é—®é¢˜éƒ½ä¸å°½ç›¸åŒã€‚è¿™é‡Œæˆ‘ä»¬åˆ†ä¸ºä¸‰ä¸ªç« èŠ‚è¿›è¡Œç»†è‡´è®²è§£ã€‚</p><p>è™½ç„¶SQLæŸ¥è¯¢ä¼˜åŒ–çš„æŠ€æœ¯æœ‰å¾ˆå¤šï¼Œä½†æ˜¯å¤§æ–¹å‘ä¸Šå®Œå…¨å¯ä»¥åˆ†æˆ<code>ç‰©ç†æŸ¥è¯¢ä¼˜åŒ–</code>å’Œ<code>é€»è¾‘æŸ¥è¯¢ä¼˜åŒ–</code>ä¸¤å¤§å—ã€‚</p><ul><li>ç‰©ç†æŸ¥è¯¢ä¼˜åŒ–æ˜¯é€šè¿‡<code>ç´¢å¼•</code>å’Œ<code>è¡¨è¿æ¥æ–¹å¼</code>ç­‰æŠ€æœ¯æ¥è¿›è¡Œä¼˜åŒ–ï¼Œè¿™é‡Œé‡ç‚¹éœ€è¦æŒæ¡ç´¢å¼•çš„ä½¿ç”¨ã€‚</li><li>é€»è¾‘æŸ¥è¯¢ä¼˜åŒ–å°±æ˜¯é€šè¿‡SQL<code>ç­‰ä»·å˜æ¢</code>æå‡æŸ¥è¯¢æ•ˆç‡ï¼Œç›´ç™½ä¸€ç‚¹å°±æ˜¯è¯´ï¼Œæ¢ä¸€ç§æŸ¥è¯¢å†™æ³•æ•ˆç‡å¯èƒ½æ›´é«˜ã€‚</li></ul><h2 id="1-æ•°æ®å‡†å¤‡"><a href="#1-æ•°æ®å‡†å¤‡" class="headerlink" title="1. æ•°æ®å‡†å¤‡"></a>1. æ•°æ®å‡†å¤‡</h2><p><code>å­¦å‘˜è¡¨</code> æ’ <code>50ä¸‡</code> æ¡ï¼Œ<code> ç­çº§è¡¨</code> æ’ <code>1ä¸‡</code> æ¡ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CREATE DATABASE atguigudb2;</span><br><span class="line">USE atguigudb2;</span><br></pre></td></tr></table></figure><p><strong>æ­¥éª¤1ï¼šå»ºè¡¨</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE `class` (</span><br><span class="line">    `id` INT(11) NOT NULL AUTO_INCREMENT,</span><br><span class="line">    `className` VARCHAR(30) DEFAULT NULL,</span><br><span class="line">    `address` VARCHAR(40) DEFAULT NULL,</span><br><span class="line">    `monitor` INT NULL ,</span><br><span class="line">    PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=INNODB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8;</span><br><span class="line"></span><br><span class="line">CREATE TABLE `student` (</span><br><span class="line">    `id` INT(11) NOT NULL AUTO_INCREMENT,</span><br><span class="line">    `stuno` INT NOT NULL ,</span><br><span class="line">    `name` VARCHAR(20) DEFAULT NULL,</span><br><span class="line">    `age` INT(3) DEFAULT NULL,</span><br><span class="line">    `classId` INT(11) DEFAULT NULL,</span><br><span class="line">    PRIMARY KEY (`id`)</span><br><span class="line">    #CONSTRAINT `fk_class_id` FOREIGN KEY (`classId`) REFERENCES `t_class` (`id`)</span><br><span class="line">) ENGINE=INNODB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8;</span><br></pre></td></tr></table></figure><p><strong>æ­¥éª¤2ï¼šè®¾ç½®å‚æ•°</strong></p><ul><li>å‘½ä»¤å¼€å¯ï¼šå…è®¸åˆ›å»ºå‡½æ•°è®¾ç½®ï¼š</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set global log_bin_trust_function_creators=1; # ä¸åŠ globalåªæ˜¯å½“å‰çª—å£æœ‰æ•ˆã€‚</span><br></pre></td></tr></table></figure><p><strong>æ­¥éª¤3ï¼šåˆ›å»ºå‡½æ•°</strong></p><p>ä¿è¯æ¯æ¡æ•°æ®éƒ½ä¸åŒã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">#éšæœºäº§ç”Ÿå­—ç¬¦ä¸²</span><br><span class="line">DELIMITER //</span><br><span class="line">CREATE FUNCTION rand_string(n INT) RETURNS VARCHAR(255)</span><br><span class="line">BEGIN</span><br><span class="line">DECLARE chars_str VARCHAR(100) DEFAULT</span><br><span class="line">&#x27;abcdefghijklmnopqrstuvwxyzABCDEFJHIJKLMNOPQRSTUVWXYZ&#x27;;</span><br><span class="line">DECLARE return_str VARCHAR(255) DEFAULT &#x27;&#x27;;</span><br><span class="line">DECLARE i INT DEFAULT 0;</span><br><span class="line">WHILE i &lt; n DO</span><br><span class="line">SET return_str =CONCAT(return_str,SUBSTRING(chars_str,FLOOR(1+RAND()*52),1));</span><br><span class="line">SET i = i + 1;</span><br><span class="line">END WHILE;</span><br><span class="line">RETURN return_str;</span><br><span class="line">END //</span><br><span class="line">DELIMITER ;</span><br><span class="line">#å‡å¦‚è¦åˆ é™¤</span><br><span class="line">#drop function rand_string;</span><br></pre></td></tr></table></figure><p>éšæœºäº§ç”Ÿç­çº§ç¼–å·</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#ç”¨äºéšæœºäº§ç”Ÿå¤šå°‘åˆ°å¤šå°‘çš„ç¼–å·</span><br><span class="line">DELIMITER //</span><br><span class="line">CREATE FUNCTION rand_num (from_num INT ,to_num INT) RETURNS INT(11)</span><br><span class="line">BEGIN</span><br><span class="line">DECLARE i INT DEFAULT 0;</span><br><span class="line">SET i = FLOOR(from_num +RAND()*(to_num - from_num+1)) ;</span><br><span class="line">RETURN i;</span><br><span class="line">END //</span><br><span class="line">DELIMITER ;</span><br><span class="line">#å‡å¦‚è¦åˆ é™¤</span><br><span class="line">#drop function rand_num;</span><br></pre></td></tr></table></figure><p><strong>æ­¥éª¤4ï¼šåˆ›å»ºå­˜å‚¨è¿‡ç¨‹</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">#åˆ›å»ºå¾€stuè¡¨ä¸­æ’å…¥æ•°æ®çš„å­˜å‚¨è¿‡ç¨‹</span><br><span class="line">DELIMITER //</span><br><span class="line">CREATE PROCEDURE insert_stu( START INT , max_num INT )</span><br><span class="line">BEGIN</span><br><span class="line">DECLARE i INT DEFAULT 0;</span><br><span class="line">SET autocommit = 0; #è®¾ç½®æ‰‹åŠ¨æäº¤äº‹åŠ¡</span><br><span class="line">REPEAT #å¾ªç¯</span><br><span class="line">SET i = i + 1; #èµ‹å€¼</span><br><span class="line">INSERT INTO student (stuno, name ,age ,classId ) VALUES</span><br><span class="line">((START+i),rand_string(6),rand_num(1,50),rand_num(1,1000));</span><br><span class="line">UNTIL i = max_num</span><br><span class="line">END REPEAT;</span><br><span class="line">COMMIT; #æäº¤äº‹åŠ¡</span><br><span class="line">END //</span><br><span class="line">DELIMITER ;</span><br><span class="line">#å‡å¦‚è¦åˆ é™¤</span><br><span class="line">#drop PROCEDURE insert_stu;</span><br></pre></td></tr></table></figure><p>åˆ›å»ºå¾€classè¡¨ä¸­æ’å…¥æ•°æ®çš„å­˜å‚¨è¿‡ç¨‹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">#æ‰§è¡Œå­˜å‚¨è¿‡ç¨‹ï¼Œå¾€classè¡¨æ·»åŠ éšæœºæ•°æ®</span><br><span class="line">DELIMITER //</span><br><span class="line">CREATE PROCEDURE `insert_class`( max_num INT )</span><br><span class="line">BEGIN</span><br><span class="line">DECLARE i INT DEFAULT 0;</span><br><span class="line">SET autocommit = 0;</span><br><span class="line">REPEAT</span><br><span class="line">SET i = i + 1;</span><br><span class="line">INSERT INTO class ( classname,address,monitor ) VALUES</span><br><span class="line">(rand_string(8),rand_string(10),rand_num(1,100000));</span><br><span class="line">UNTIL i = max_num</span><br><span class="line">END REPEAT;</span><br><span class="line">COMMIT;</span><br><span class="line">END //</span><br><span class="line">DELIMITER ;</span><br><span class="line">#å‡å¦‚è¦åˆ é™¤</span><br><span class="line">#drop PROCEDURE insert_class;</span><br></pre></td></tr></table></figure><p><strong>æ­¥éª¤5ï¼šè°ƒç”¨å­˜å‚¨è¿‡ç¨‹</strong></p><p>class</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#æ‰§è¡Œå­˜å‚¨è¿‡ç¨‹ï¼Œå¾€classè¡¨æ·»åŠ 1ä¸‡æ¡æ•°æ®</span><br><span class="line">CALL insert_class(10000);</span><br></pre></td></tr></table></figure><p>stu</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#æ‰§è¡Œå­˜å‚¨è¿‡ç¨‹ï¼Œå¾€stuè¡¨æ·»åŠ 50ä¸‡æ¡æ•°æ®</span><br><span class="line">CALL insert_stu(100000,500000);</span><br></pre></td></tr></table></figure><p><strong>æ­¥éª¤6ï¼šåˆ é™¤æŸè¡¨ä¸Šçš„ç´¢å¼•</strong></p><p>åˆ›å»ºå­˜å‚¨è¿‡ç¨‹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER //</span><br><span class="line">CREATE PROCEDURE `proc_drop_index`(dbname VARCHAR(200),tablename VARCHAR(200))</span><br><span class="line">BEGIN</span><br><span class="line">        DECLARE done INT DEFAULT 0;</span><br><span class="line">        DECLARE ct INT DEFAULT 0;</span><br><span class="line">        DECLARE _index VARCHAR(200) DEFAULT &#x27;&#x27;;</span><br><span class="line">        DECLARE _cur CURSOR FOR SELECT index_name FROM</span><br><span class="line">information_schema.STATISTICS WHERE table_schema=dbname AND table_name=tablename AND</span><br><span class="line">seq_in_index=1 AND index_name &lt;&gt;&#x27;PRIMARY&#x27; ;</span><br><span class="line">#æ¯ä¸ªæ¸¸æ ‡å¿…é¡»ä½¿ç”¨ä¸åŒçš„declare continue handler for not found set done=1æ¥æ§åˆ¶æ¸¸æ ‡çš„ç»“æŸ</span><br><span class="line">DECLARE CONTINUE HANDLER FOR NOT FOUND set done=2 ;</span><br><span class="line">#è‹¥æ²¡æœ‰æ•°æ®è¿”å›,ç¨‹åºç»§ç»­,å¹¶å°†å˜é‡doneè®¾ä¸º2</span><br><span class="line">        OPEN _cur;</span><br><span class="line">        FETCH _cur INTO _index;</span><br><span class="line">        WHILE _index&lt;&gt;&#x27;&#x27; DO</span><br><span class="line">            SET @str = CONCAT(&quot;drop index &quot; , _index , &quot; on &quot; , tablename );</span><br><span class="line">            PREPARE sql_str FROM @str ;</span><br><span class="line">            EXECUTE sql_str;</span><br><span class="line">            DEALLOCATE PREPARE sql_str;</span><br><span class="line">            SET _index=&#x27;&#x27;;</span><br><span class="line">            FETCH _cur INTO _index;</span><br><span class="line">        END WHILE;</span><br><span class="line">    CLOSE _cur;</span><br><span class="line">END //</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œå­˜å‚¨è¿‡ç¨‹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CALL proc_drop_index(&quot;dbname&quot;,&quot;tablename&quot;);</span><br></pre></td></tr></table></figure><h2 id="2-ç´¢å¼•å¤±æ•ˆæ¡ˆä¾‹"><a href="#2-ç´¢å¼•å¤±æ•ˆæ¡ˆä¾‹" class="headerlink" title="2. ç´¢å¼•å¤±æ•ˆæ¡ˆä¾‹"></a>2. ç´¢å¼•å¤±æ•ˆæ¡ˆä¾‹</h2><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220704202453482.png" class=""><h3 id="2-1-å…¨å€¼åŒ¹é…æˆ‘æœ€çˆ±"><a href="#2-1-å…¨å€¼åŒ¹é…æˆ‘æœ€çˆ±" class="headerlink" title="2.1 å…¨å€¼åŒ¹é…æˆ‘æœ€çˆ±"></a>2.1 å…¨å€¼åŒ¹é…æˆ‘æœ€çˆ±</h3><p>ç³»ç»Ÿä¸­ç»å¸¸å‡ºç°çš„sqlè¯­å¥å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN SELECT SQL_NO_CACHE * FROM student WHERE age=30;</span><br><span class="line">EXPLAIN SELECT SQL_NO_CACHE * FROM student WHERE age=30 AND classId=4;</span><br><span class="line">EXPLAIN SELECT SQL_NO_CACHE * FROM student WHERE age=30 AND classId=4 AND name = &#x27;abcd&#x27;;</span><br></pre></td></tr></table></figure><p>å»ºç«‹ç´¢å¼•å‰æ‰§è¡Œï¼šï¼ˆå…³æ³¨æ‰§è¡Œæ—¶é—´ï¼‰</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT SQL_NO_CACHE * FROM student WHERE age=30 AND classId=4 AND name = &#x27;abcd&#x27;;</span><br><span class="line">Empty set, 1 warning (0.28 sec)</span><br></pre></td></tr></table></figure><p><strong>å»ºç«‹ç´¢å¼•</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CREATE INDEX idx_age ON student(age);</span><br><span class="line">CREATE INDEX idx_age_classid ON student(age,classId);</span><br><span class="line">CREATE INDEX idx_age_classid_name ON student(age,classId,name);</span><br></pre></td></tr></table></figure><p>å»ºç«‹ç´¢å¼•åæ‰§è¡Œï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT SQL_NO_CACHE * FROM student WHERE age=30 AND classId=4 AND name = &#x27;abcd&#x27;;</span><br><span class="line">Empty set, 1 warning (0.01 sec)</span><br></pre></td></tr></table></figure><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220704204140589.png" class=""><h3 id="2-2-æœ€ä½³å·¦å‰ç¼€æ³•åˆ™"><a href="#2-2-æœ€ä½³å·¦å‰ç¼€æ³•åˆ™" class="headerlink" title="2.2 æœ€ä½³å·¦å‰ç¼€æ³•åˆ™"></a>2.2 æœ€ä½³å·¦å‰ç¼€æ³•åˆ™</h3><p>åœ¨MySQLå»ºç«‹è”åˆç´¢å¼•æ—¶ä¼šéµå®ˆæœ€ä½³å·¦å‰ç¼€åŸåˆ™ï¼Œå³æœ€å·¦ä¼˜å…ˆï¼Œåœ¨æ£€ç´¢æ•°æ®æ—¶ä»è”åˆç´¢å¼•çš„æœ€å·¦è¾¹å¼€å§‹åŒ¹é…ã€‚</p><p>ä¸¾ä¾‹1ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN SELECT SQL_NO_CACHE * FROM student WHERE student.age=30 AND student.name = &#x27;abcd&#x27;;</span><br></pre></td></tr></table></figure><p>ä¸¾ä¾‹2ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN SELECT SQL_NO_CACHE * FROM student WHERE student.classId=1 AND student.name = &#x27;abcd&#x27;;</span><br></pre></td></tr></table></figure><p>ä¸¾ä¾‹3ï¼šç´¢å¼•<code>idx_age_classid_name</code>è¿˜èƒ½å¦æ­£å¸¸ä½¿ç”¨ï¼Ÿ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN SELECT SQL_NO_CACHE * FROM student WHERE student.classId=4 AND student.age=30 AND student.name = &#x27;abcd&#x27;;</span><br></pre></td></tr></table></figure><p>å¦‚æœç´¢å¼•äº†å¤šåˆ—ï¼Œè¦éµå®ˆæœ€å·¦å‰ç¼€æ³•åˆ™ã€‚æŒ‡çš„æ˜¯æŸ¥è¯¢ä»ç´¢å¼•çš„æœ€å·¦å‰åˆ—å¼€å§‹å¹¶ä¸”ä¸è·³è¿‡ç´¢å¼•ä¸­çš„åˆ—ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; EXPLAIN SELECT SQL_NO_CACHE * FROM student WHERE student.age=30 AND student.name = &#x27;abcd&#x27;;</span><br></pre></td></tr></table></figure><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220704211116351.png" class=""><p>è™½ç„¶å¯ä»¥æ­£å¸¸ä½¿ç”¨ï¼Œä½†æ˜¯åªæœ‰éƒ¨åˆ†è¢«ä½¿ç”¨åˆ°äº†ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; EXPLAIN SELECT SQL_NO_CACHE * FROM student WHERE student.classId=1 AND student.name = &#x27;abcd&#x27;;</span><br></pre></td></tr></table></figure><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220704211254581.png" class=""><p>å®Œå…¨æ²¡æœ‰ä½¿ç”¨ä¸Šç´¢å¼•ã€‚</p><p>ç»“è®ºï¼šMySQLå¯ä»¥ä¸ºå¤šä¸ªå­—æ®µåˆ›å»ºç´¢å¼•ï¼Œä¸€ä¸ªç´¢å¼•å¯ä»¥åŒ…å«16ä¸ªå­—æ®µã€‚å¯¹äºå¤šåˆ—ç´¢å¼•ï¼Œ<strong>è¿‡æ»¤æ¡ä»¶è¦ä½¿ç”¨ç´¢å¼•å¿…é¡»æŒ‰ç…§ç´¢å¼•å»ºç«‹æ—¶çš„é¡ºåºï¼Œä¾æ¬¡æ»¡è¶³ï¼Œä¸€æ—¦è·³è¿‡æŸä¸ªå­—æ®µï¼Œç´¢å¼•åé¢çš„å­—æ®µéƒ½æ— æ³•è¢«ä½¿ç”¨</strong>ã€‚å¦‚æœæŸ¥è¯¢æ¡ä»¶ä¸­æ²¡æœ‰ç”¨è¿™äº›å­—æ®µä¸­ç¬¬ä¸€ä¸ªå­—æ®µæ—¶ï¼Œå¤šåˆ—ï¼ˆæˆ–è”åˆï¼‰ç´¢å¼•ä¸ä¼šè¢«ä½¿ç”¨ã€‚</p><blockquote><p>æ‹“å±•ï¼šAlibabaã€ŠJavaå¼€å‘æ‰‹å†Œã€‹ </p><p>ç´¢å¼•æ–‡ä»¶å…·æœ‰ B-Tree çš„æœ€å·¦å‰ç¼€åŒ¹é…ç‰¹æ€§ï¼Œå¦‚æœå·¦è¾¹çš„å€¼æœªç¡®å®šï¼Œé‚£ä¹ˆæ— æ³•ä½¿ç”¨æ­¤ç´¢å¼•ã€‚</p></blockquote><h3 id="2-3-ä¸»é”®æ’å…¥é¡ºåº"><a href="#2-3-ä¸»é”®æ’å…¥é¡ºåº" class="headerlink" title="2.3 ä¸»é”®æ’å…¥é¡ºåº"></a>2.3 ä¸»é”®æ’å…¥é¡ºåº</h3><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220704212354041.png" class=""><p>å¦‚æœæ­¤æ—¶å†æ’å…¥ä¸€æ¡ä¸»é”®å€¼ä¸º 9 çš„è®°å½•ï¼Œé‚£å®ƒæ’å…¥çš„ä½ç½®å°±å¦‚ä¸‹å›¾ï¼š</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220704212428607.png" class=""><p>å¯è¿™ä¸ªæ•°æ®é¡µå·²ç»æ»¡äº†ï¼Œå†æ’è¿›æ¥å’‹åŠå‘¢ï¼Ÿæˆ‘ä»¬éœ€è¦æŠŠå½“å‰ <code>é¡µé¢åˆ†è£‚</code> æˆä¸¤ä¸ªé¡µé¢ï¼ŒæŠŠæœ¬é¡µä¸­çš„ä¸€äº›è®°å½•ç§»åŠ¨åˆ°æ–°åˆ›å»ºçš„è¿™ä¸ªé¡µä¸­ã€‚é¡µé¢åˆ†è£‚å’Œè®°å½•ç§»ä½æ„å‘³ç€ä»€ä¹ˆï¼Ÿæ„å‘³ç€ï¼š <code>æ€§èƒ½æŸè€—</code> ï¼æ‰€ä»¥å¦‚æœæˆ‘ä»¬æƒ³å°½é‡é¿å…è¿™æ ·æ— è°“çš„æ€§èƒ½æŸè€—ï¼Œæœ€å¥½è®©æ’å…¥çš„è®°å½•çš„ <code>ä¸»é”®å€¼ä¾æ¬¡é€’å¢</code> ï¼Œè¿™æ ·å°±ä¸ä¼šå‘ç”Ÿè¿™æ ·çš„æ€§èƒ½æŸè€—äº†ã€‚ æ‰€ä»¥æˆ‘ä»¬å»ºè®®ï¼šè®©ä¸»é”®å…·æœ‰ <code>AUTO_INCREMENT</code> ï¼Œè®©å­˜å‚¨å¼•æ“è‡ªå·±ä¸ºè¡¨ç”Ÿæˆä¸»é”®ï¼Œè€Œä¸æ˜¯æˆ‘ä»¬æ‰‹åŠ¨æ’å…¥ ï¼Œ æ¯”å¦‚ï¼š <code>person_info</code> è¡¨ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE person_info(</span><br><span class="line">    id INT UNSIGNED NOT NULL AUTO_INCREMENT,</span><br><span class="line">    name VARCHAR(100) NOT NULL,</span><br><span class="line">    birthday DATE NOT NULL,</span><br><span class="line">    phone_number CHAR(11) NOT NULL,</span><br><span class="line">    country varchar(100) NOT NULL,</span><br><span class="line">    PRIMARY KEY (id),</span><br><span class="line">    KEY idx_name_birthday_phone_number (name(10), birthday, phone_number)</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬è‡ªå®šä¹‰çš„ä¸»é”®åˆ— <code>id</code> æ‹¥æœ‰ <code>AUTO_INCREMENT</code> å±æ€§ï¼Œåœ¨æ’å…¥è®°å½•æ—¶å­˜å‚¨å¼•æ“ä¼šè‡ªåŠ¨ä¸ºæˆ‘ä»¬å¡«å…¥è‡ªå¢çš„ä¸»é”®å€¼ã€‚è¿™æ ·çš„ä¸»é”®å ç”¨ç©ºé—´å°ï¼Œé¡ºåºå†™å…¥ï¼Œå‡å°‘é¡µåˆ†è£‚ã€‚</p><h3 id="2-4-è®¡ç®—ã€å‡½æ•°ã€ç±»å‹è½¬æ¢-è‡ªåŠ¨æˆ–æ‰‹åŠ¨-å¯¼è‡´ç´¢å¼•å¤±æ•ˆ"><a href="#2-4-è®¡ç®—ã€å‡½æ•°ã€ç±»å‹è½¬æ¢-è‡ªåŠ¨æˆ–æ‰‹åŠ¨-å¯¼è‡´ç´¢å¼•å¤±æ•ˆ" class="headerlink" title="2.4 è®¡ç®—ã€å‡½æ•°ã€ç±»å‹è½¬æ¢(è‡ªåŠ¨æˆ–æ‰‹åŠ¨)å¯¼è‡´ç´¢å¼•å¤±æ•ˆ"></a>2.4 è®¡ç®—ã€å‡½æ•°ã€ç±»å‹è½¬æ¢(è‡ªåŠ¨æˆ–æ‰‹åŠ¨)å¯¼è‡´ç´¢å¼•å¤±æ•ˆ</h3><ol><li><p>è¿™ä¸¤æ¡sqlå“ªç§å†™æ³•æ›´å¥½</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN SELECT SQL_NO_CACHE * FROM student WHERE student.name LIKE &#x27;abc%&#x27;;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN SELECT SQL_NO_CACHE * FROM student WHERE LEFT(student.name,3) = &#x27;abc&#x27;;</span><br></pre></td></tr></table></figure></li><li><p>åˆ›å»ºç´¢å¼•</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CREATE INDEX idx_name ON student(NAME);</span><br></pre></td></tr></table></figure></li><li><p>ç¬¬ä¸€ç§ï¼šç´¢å¼•ä¼˜åŒ–ç”Ÿæ•ˆ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; EXPLAIN SELECT SQL_NO_CACHE * FROM student WHERE student.name LIKE &#x27;abc%&#x27;;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT SQL_NO_CACHE * FROM student WHERE student.name LIKE &#x27;abc%&#x27;;</span><br><span class="line">+---------+---------+--------+------+---------+</span><br><span class="line">| id | stuno | name | age | classId |</span><br><span class="line">+---------+---------+--------+------+---------+</span><br><span class="line">| 5301379 | 1233401 | AbCHEa | 164 | 259 |</span><br><span class="line">| 7170042 | 3102064 | ABcHeB | 199 | 161 |</span><br><span class="line">| 1901614 | 1833636 | ABcHeC | 226 | 275 |</span><br><span class="line">| 5195021 | 1127043 | abchEC | 486 | 72 |</span><br><span class="line">| 4047089 | 3810031 | AbCHFd | 268 | 210 |</span><br><span class="line">| 4917074 | 849096 | ABcHfD | 264 | 442 |</span><br><span class="line">| 1540859 | 141979 | abchFF | 119 | 140 |</span><br><span class="line">| 5121801 | 1053823 | AbCHFg | 412 | 327 |</span><br><span class="line">| 2441254 | 2373276 | abchFJ | 170 | 362 |</span><br><span class="line">| 7039146 | 2971168 | ABcHgI | 502 | 465 |</span><br><span class="line">| 1636826 | 1580286 | ABcHgK | 71 | 262 |</span><br><span class="line">| 374344 | 474345 | abchHL | 367 | 212 |</span><br><span class="line">| 1596534 | 169191 | AbCHHl | 102 | 146 |</span><br><span class="line">...</span><br><span class="line">| 5266837 | 1198859 | abclXe | 292 | 298 |</span><br><span class="line">| 8126968 | 4058990 | aBClxE | 316 | 150 |</span><br><span class="line">| 4298305 | 399962 | AbCLXF | 72 | 423 |</span><br><span class="line">| 5813628 | 1745650 | aBClxF | 356 | 323 |</span><br><span class="line">| 6980448 | 2912470 | AbCLXF | 107 | 78 |</span><br><span class="line">| 7881979 | 3814001 | AbCLXF | 89 | 497 |</span><br><span class="line">| 4955576 | 887598 | ABcLxg | 121 | 385 |</span><br><span class="line">| 3653460 | 3585482 | AbCLXJ | 130 | 174 |</span><br><span class="line">| 1231990 | 1283439 | AbCLYH | 189 | 429 |</span><br><span class="line">| 6110615 | 2042637 | ABcLyh | 157 | 40 |</span><br><span class="line">+---------+---------+--------+------+---------+</span><br><span class="line">401 rows in set, 1 warning (0.01 sec)</span><br></pre></td></tr></table></figure></li><li><p>ç¬¬äºŒç§ï¼šç´¢å¼•ä¼˜åŒ–å¤±æ•ˆ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; EXPLAIN SELECT SQL_NO_CACHE * FROM student WHERE LEFT(student.name,3) = &#x27;abc&#x27;;</span><br></pre></td></tr></table></figure></li></ol><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220704214905412.png" class="">   <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT SQL_NO_CACHE * FROM student WHERE LEFT(student.name,3) = &#x27;abc&#x27;;</span><br><span class="line">+---------+---------+--------+------+---------+</span><br><span class="line">| id | stuno | name | age | classId |</span><br><span class="line">+---------+---------+--------+------+---------+</span><br><span class="line">| 5301379 | 1233401 | AbCHEa | 164 | 259 |</span><br><span class="line">| 7170042 | 3102064 | ABcHeB | 199 | 161 |</span><br><span class="line">| 1901614 | 1833636 | ABcHeC | 226 | 275 |</span><br><span class="line">| 5195021 | 1127043 | abchEC | 486 | 72 |</span><br><span class="line">| 4047089 | 3810031 | AbCHFd | 268 | 210 |</span><br><span class="line">| 4917074 | 849096 | ABcHfD | 264 | 442 |</span><br><span class="line">| 1540859 | 141979 | abchFF | 119 | 140 |</span><br><span class="line">| 5121801 | 1053823 | AbCHFg | 412 | 327 |</span><br><span class="line">| 2441254 | 2373276 | abchFJ | 170 | 362 |</span><br><span class="line">| 7039146 | 2971168 | ABcHgI | 502 | 465 |</span><br><span class="line">| 1636826 | 1580286 | ABcHgK | 71 | 262 |</span><br><span class="line">| 374344 | 474345 | abchHL | 367 | 212 |</span><br><span class="line">| 1596534 | 169191 | AbCHHl | 102 | 146 |</span><br><span class="line">...</span><br><span class="line">| 5266837 | 1198859 | abclXe | 292 | 298 |</span><br><span class="line">| 8126968 | 4058990 | aBClxE | 316 | 150 |</span><br><span class="line">| 4298305 | 399962 | AbCLXF | 72 | 423 |</span><br><span class="line">| 5813628 | 1745650 | aBClxF | 356 | 323 |</span><br><span class="line">| 6980448 | 2912470 | AbCLXF | 107 | 78 |</span><br><span class="line">| 7881979 | 3814001 | AbCLXF | 89 | 497 |</span><br><span class="line">| 4955576 | 887598 | ABcLxg | 121 | 385 |</span><br><span class="line">| 3653460 | 3585482 | AbCLXJ | 130 | 174 |</span><br><span class="line">| 1231990 | 1283439 | AbCLYH | 189 | 429 |</span><br><span class="line">| 6110615 | 2042637 | ABcLyh | 157 | 40 |</span><br><span class="line">+---------+---------+--------+------+---------+</span><br><span class="line">401 rows in set, 1 warning (3.62 sec)</span><br></pre></td></tr></table></figure><p>   typeä¸ºâ€œALLâ€ï¼Œè¡¨ç¤ºæ²¡æœ‰ä½¿ç”¨åˆ°ç´¢å¼•ï¼ŒæŸ¥è¯¢æ—¶é—´ä¸º 3.62 ç§’ï¼ŒæŸ¥è¯¢æ•ˆç‡è¾ƒä¹‹å‰ä½å¾ˆå¤šã€‚</p><p><strong>å†ä¸¾ä¾‹ï¼š</strong></p><ul><li><p>studentè¡¨çš„å­—æ®µstunoä¸Šè®¾ç½®æœ‰ç´¢å¼•</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CREATE INDEX idx_sno ON student(stuno);</span><br></pre></td></tr></table></figure></li><li><p>ç´¢å¼•ä¼˜åŒ–å¤±æ•ˆï¼šï¼ˆå‡è®¾ï¼šstudentè¡¨çš„å­—æ®µstunoä¸Šè®¾ç½®æœ‰ç´¢å¼•ï¼‰</p></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN SELECT SQL_NO_CACHE id, stuno, NAME FROM student WHERE stuno+1 = 900001;</span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœï¼š</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220704215159768.png" class=""><ul><li><p>ç´¢å¼•ä¼˜åŒ–ç”Ÿæ•ˆï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN SELECT SQL_NO_CACHE id, stuno, NAME FROM student WHERE stuno = 900000;</span><br></pre></td></tr></table></figure></li></ul><p><strong>å†ä¸¾ä¾‹ï¼š</strong></p><ul><li><p>studentè¡¨çš„å­—æ®µnameä¸Šè®¾ç½®æœ‰ç´¢å¼•</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CREATE INDEX idx_name ON student(NAME);</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN SELECT id, stuno, name FROM student WHERE SUBSTRING(name, 1,3)=&#x27;abc&#x27;;</span><br></pre></td></tr></table></figure></li></ul><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220704215533871.png" class=""><ul><li><p>ç´¢å¼•ä¼˜åŒ–ç”Ÿæ•ˆ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN SELECT id, stuno, NAME FROM student WHERE NAME LIKE &#x27;abc%&#x27;;</span><br></pre></td></tr></table></figure></li></ul><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220704215600507.png" class=""><h3 id="2-5-ç±»å‹è½¬æ¢å¯¼è‡´ç´¢å¼•å¤±æ•ˆ"><a href="#2-5-ç±»å‹è½¬æ¢å¯¼è‡´ç´¢å¼•å¤±æ•ˆ" class="headerlink" title="2.5 ç±»å‹è½¬æ¢å¯¼è‡´ç´¢å¼•å¤±æ•ˆ"></a>2.5 ç±»å‹è½¬æ¢å¯¼è‡´ç´¢å¼•å¤±æ•ˆ</h3><p>ä¸‹åˆ—å“ªä¸ªsqlè¯­å¥å¯ä»¥ç”¨åˆ°ç´¢å¼•ã€‚ï¼ˆå‡è®¾nameå­—æ®µä¸Šè®¾ç½®æœ‰ç´¢å¼•ï¼‰</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># æœªä½¿ç”¨åˆ°ç´¢å¼•</span><br><span class="line">EXPLAIN SELECT SQL_NO_CACHE * FROM student WHERE name=123;</span><br></pre></td></tr></table></figure><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220704215658526.png" class=""><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># ä½¿ç”¨åˆ°ç´¢å¼•</span><br><span class="line">EXPLAIN SELECT SQL_NO_CACHE * FROM student WHERE name=&#x27;123&#x27;;</span><br></pre></td></tr></table></figure><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220704215721216.png" class=""><p>name&#x3D;123å‘ç”Ÿç±»å‹è½¬æ¢ï¼Œç´¢å¼•å¤±æ•ˆã€‚</p><h3 id="2-6-èŒƒå›´æ¡ä»¶å³è¾¹çš„åˆ—ç´¢å¼•å¤±æ•ˆ"><a href="#2-6-èŒƒå›´æ¡ä»¶å³è¾¹çš„åˆ—ç´¢å¼•å¤±æ•ˆ" class="headerlink" title="2.6 èŒƒå›´æ¡ä»¶å³è¾¹çš„åˆ—ç´¢å¼•å¤±æ•ˆ"></a>2.6 èŒƒå›´æ¡ä»¶å³è¾¹çš„åˆ—ç´¢å¼•å¤±æ•ˆ</h3><ol><li>ç³»ç»Ÿç»å¸¸å‡ºç°çš„sqlå¦‚ä¸‹ï¼š</li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ALTER TABLE student DROP INDEX idx_name;</span><br><span class="line">ALTER TABLE student DROP INDEX idx_age;</span><br><span class="line">ALTER TABLE student DROP INDEX idx_age_classid;</span><br><span class="line"></span><br><span class="line">EXPLAIN SELECT SQL_NO_CACHE * FROM student</span><br><span class="line">WHERE student.age=30 AND student.classId&gt;20 AND student.name = &#x27;abc&#x27; ;</span><br></pre></td></tr></table></figure><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220704220123647.png" class=""><ol start="2"><li>é‚£ä¹ˆç´¢å¼• idx_age_classId_name è¿™ä¸ªç´¢å¼•è¿˜èƒ½æ­£å¸¸ä½¿ç”¨ä¹ˆï¼Ÿ</li></ol><ul><li>ä¸èƒ½ï¼ŒèŒƒå›´å³è¾¹çš„åˆ—ä¸èƒ½ä½¿ç”¨ã€‚æ¯”å¦‚ï¼š(&lt;) (&lt;&#x3D;) (&gt;) (&gt;&#x3D;) å’Œ between ç­‰</li><li>å¦‚æœè¿™ç§sqlå‡ºç°è¾ƒå¤šï¼Œåº”è¯¥å»ºç«‹ï¼š</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">create index idx_age_name_classId on student(age,name,classId);</span><br></pre></td></tr></table></figure><ul><li>å°†èŒƒå›´æŸ¥è¯¢æ¡ä»¶æ”¾ç½®è¯­å¥æœ€åï¼š</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN SELECT SQL_NO_CACHE * FROM student WHERE student.age=30 AND student.name = &#x27;abc&#x27; AND student.classId&gt;20;</span><br></pre></td></tr></table></figure><blockquote><p>åº”ç”¨å¼€å‘ä¸­èŒƒå›´æŸ¥è¯¢ï¼Œä¾‹å¦‚ï¼šé‡‘é¢æŸ¥è¯¢ï¼Œæ—¥æœŸæŸ¥è¯¢å¾€å¾€éƒ½æ˜¯èŒƒå›´æŸ¥è¯¢ã€‚åº”å°†æŸ¥è¯¢æ¡ä»¶æ”¾ç½®whereè¯­å¥æœ€åã€‚ï¼ˆåˆ›å»ºçš„è”åˆç´¢å¼•ä¸­ï¼ŒåŠ¡å¿…æŠŠèŒƒå›´æ¶‰åŠåˆ°çš„å­—æ®µå†™åœ¨æœ€åï¼‰</p></blockquote><ol start="3"><li>æ•ˆæœ</li></ol><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220704223211981.png" class=""><h3 id="2-7-ä¸ç­‰äº-x3D-æˆ–è€…-lt-gt-ç´¢å¼•å¤±æ•ˆ"><a href="#2-7-ä¸ç­‰äº-x3D-æˆ–è€…-lt-gt-ç´¢å¼•å¤±æ•ˆ" class="headerlink" title="2.7 ä¸ç­‰äº(!&#x3D; æˆ–è€…&lt;&gt;)ç´¢å¼•å¤±æ•ˆ"></a>2.7 ä¸ç­‰äº(!&#x3D; æˆ–è€…&lt;&gt;)ç´¢å¼•å¤±æ•ˆ</h3><ul><li>ä¸ºnameå­—æ®µåˆ›å»ºç´¢å¼•</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CREATE INDEX idx_name ON student(NAME);</span><br></pre></td></tr></table></figure><ul><li>æŸ¥çœ‹ç´¢å¼•æ˜¯å¦å¤±æ•ˆ</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN SELECT SQL_NO_CACHE * FROM student WHERE student.name &lt;&gt; &#x27;abc&#x27;;</span><br></pre></td></tr></table></figure><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220704224552374.png" class=""><p>æˆ–è€…</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN SELECT SQL_NO_CACHE * FROM student WHERE student.name != &#x27;abc&#x27;;</span><br></pre></td></tr></table></figure><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220704224916117.png" class=""><p>åœºæ™¯ä¸¾ä¾‹ï¼šç”¨æˆ·æå‡ºéœ€æ±‚ï¼Œå°†è´¢åŠ¡æ•°æ®ï¼Œäº§å“åˆ©æ¶¦é‡‘é¢ä¸ç­‰äº0çš„éƒ½ç»Ÿè®¡å‡ºæ¥ã€‚</p><h3 id="2-8-is-nullå¯ä»¥ä½¿ç”¨ç´¢å¼•ï¼Œis-not-nullæ— æ³•ä½¿ç”¨ç´¢å¼•"><a href="#2-8-is-nullå¯ä»¥ä½¿ç”¨ç´¢å¼•ï¼Œis-not-nullæ— æ³•ä½¿ç”¨ç´¢å¼•" class="headerlink" title="2.8 is nullå¯ä»¥ä½¿ç”¨ç´¢å¼•ï¼Œis not nullæ— æ³•ä½¿ç”¨ç´¢å¼•"></a>2.8 is nullå¯ä»¥ä½¿ç”¨ç´¢å¼•ï¼Œis not nullæ— æ³•ä½¿ç”¨ç´¢å¼•</h3><ul><li>IS NULL: å¯ä»¥è§¦å‘ç´¢å¼•</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN SELECT SQL_NO_CACHE * FROM student WHERE age IS NULL;</span><br></pre></td></tr></table></figure><ul><li>IS NOT NULL: æ— æ³•è§¦å‘ç´¢å¼•</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN SELECT SQL_NO_CACHE * FROM student WHERE age IS NOT NULL;</span><br></pre></td></tr></table></figure><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220704225333199.png" class=""><blockquote><p>ç»“è®ºï¼šæœ€å¥½åœ¨è®¾è®¡æ•°æ®åº“çš„æ—¶å€™å°±å°†<code>å­—æ®µè®¾ç½®ä¸º NOT NULL çº¦æŸ</code>ï¼Œæ¯”å¦‚ä½ å¯ä»¥å°† INT ç±»å‹çš„å­—æ®µï¼Œé»˜è®¤å€¼è®¾ç½®ä¸º0ã€‚å°†å­—ç¬¦ç±»å‹çš„é»˜è®¤å€¼è®¾ç½®ä¸ºç©ºå­—ç¬¦ä¸²(â€˜â€™)ã€‚</p><p>æ‰©å±•ï¼šåŒç†ï¼Œåœ¨æŸ¥è¯¢ä¸­ä½¿ç”¨<code>not like</code>ä¹Ÿæ— æ³•ä½¿ç”¨ç´¢å¼•ï¼Œå¯¼è‡´å…¨è¡¨æ‰«æã€‚</p></blockquote><h3 id="2-9-likeä»¥é€šé…ç¬¦-å¼€å¤´ç´¢å¼•å¤±æ•ˆ"><a href="#2-9-likeä»¥é€šé…ç¬¦-å¼€å¤´ç´¢å¼•å¤±æ•ˆ" class="headerlink" title="2.9 likeä»¥é€šé…ç¬¦%å¼€å¤´ç´¢å¼•å¤±æ•ˆ"></a>2.9 likeä»¥é€šé…ç¬¦%å¼€å¤´ç´¢å¼•å¤±æ•ˆ</h3><p>åœ¨ä½¿ç”¨LIKEå…³é”®å­—è¿›è¡ŒæŸ¥è¯¢çš„æŸ¥è¯¢è¯­å¥ä¸­ï¼Œå¦‚æœåŒ¹é…å­—ç¬¦ä¸²çš„ç¬¬ä¸€ä¸ªå­—ç¬¦ä¸ºâ€™%â€™ï¼Œç´¢å¼•å°±ä¸ä¼šèµ·ä½œç”¨ã€‚åªæœ‰â€™%â€™ä¸åœ¨ç¬¬ä¸€ä¸ªä½ç½®ï¼Œç´¢å¼•æ‰ä¼šèµ·ä½œç”¨ã€‚</p><ul><li>ä½¿ç”¨åˆ°ç´¢å¼•</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN SELECT SQL_NO_CACHE * FROM student WHERE name LIKE &#x27;ab%&#x27;;</span><br></pre></td></tr></table></figure><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220705131643304.png" class=""><ul><li>æœªä½¿ç”¨åˆ°ç´¢å¼•</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN SELECT SQL_NO_CACHE * FROM student WHERE name LIKE &#x27;%ab%&#x27;;</span><br></pre></td></tr></table></figure><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220705131717329.png" class=""><blockquote><p>æ‹“å±•ï¼šAlibabaã€ŠJavaå¼€å‘æ‰‹å†Œã€‹ </p><p>ã€å¼ºåˆ¶ã€‘é¡µé¢æœç´¢ä¸¥ç¦å·¦æ¨¡ç³Šæˆ–è€…å…¨æ¨¡ç³Šï¼Œå¦‚æœéœ€è¦è¯·èµ°æœç´¢å¼•æ“æ¥è§£å†³ã€‚</p></blockquote><h3 id="2-10-OR-å‰åå­˜åœ¨éç´¢å¼•çš„åˆ—ï¼Œç´¢å¼•å¤±æ•ˆ"><a href="#2-10-OR-å‰åå­˜åœ¨éç´¢å¼•çš„åˆ—ï¼Œç´¢å¼•å¤±æ•ˆ" class="headerlink" title="2.10 OR å‰åå­˜åœ¨éç´¢å¼•çš„åˆ—ï¼Œç´¢å¼•å¤±æ•ˆ"></a>2.10 OR å‰åå­˜åœ¨éç´¢å¼•çš„åˆ—ï¼Œç´¢å¼•å¤±æ•ˆ</h3><p>åœ¨WHEREå­å¥ä¸­ï¼Œå¦‚æœåœ¨ORå‰çš„æ¡ä»¶åˆ—è¿›è¡Œäº†ç´¢å¼•ï¼Œè€Œåœ¨ORåçš„æ¡ä»¶åˆ—æ²¡æœ‰è¿›è¡Œç´¢å¼•ï¼Œé‚£ä¹ˆç´¢å¼•ä¼šå¤±æ•ˆã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ<strong>ORå‰åçš„ä¸¤ä¸ªæ¡ä»¶ä¸­çš„åˆ—éƒ½æ˜¯ç´¢å¼•æ—¶ï¼ŒæŸ¥è¯¢ä¸­æ‰ä½¿ç”¨ç´¢å¼•ã€‚</strong></p><p>å› ä¸ºORçš„å«ä¹‰å°±æ˜¯ä¸¤ä¸ªåªè¦æ»¡è¶³ä¸€ä¸ªå³å¯ï¼Œå› æ­¤<code>åªæœ‰ä¸€ä¸ªæ¡ä»¶åˆ—è¿›è¡Œäº†ç´¢å¼•æ˜¯æ²¡æœ‰æ„ä¹‰çš„</code>ï¼Œåªè¦æœ‰æ¡ä»¶åˆ—æ²¡æœ‰è¿›è¡Œç´¢å¼•ï¼Œå°±ä¼šè¿›è¡Œ<code>å…¨è¡¨æ‰«æ</code>ï¼Œå› æ­¤æ‰€ä»¥çš„æ¡ä»¶åˆ—ä¹Ÿä¼šå¤±æ•ˆã€‚</p><p>æŸ¥è¯¢è¯­å¥ä½¿ç”¨ORå…³é”®å­—çš„æƒ…å†µï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># æœªä½¿ç”¨åˆ°ç´¢å¼•</span><br><span class="line">EXPLAIN SELECT SQL_NO_CACHE * FROM student WHERE age = 10 OR classid = 100;</span><br></pre></td></tr></table></figure><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220705132221045.png" class=""><p>å› ä¸ºclassIdå­—æ®µä¸Šæ²¡æœ‰ç´¢å¼•ï¼Œæ‰€ä»¥ä¸Šè¿°æŸ¥è¯¢è¯­å¥æ²¡æœ‰ä½¿ç”¨ç´¢å¼•ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#ä½¿ç”¨åˆ°ç´¢å¼•</span><br><span class="line">EXPLAIN SELECT SQL_NO_CACHE * FROM student WHERE age = 10 OR name = &#x27;Abel&#x27;;</span><br></pre></td></tr></table></figure><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220705132239232.png" class=""><p>å› ä¸ºageå­—æ®µå’Œnameå­—æ®µä¸Šéƒ½æœ‰ç´¢å¼•ï¼Œæ‰€ä»¥æŸ¥è¯¢ä¸­ä½¿ç”¨äº†ç´¢å¼•ã€‚ä½ èƒ½çœ‹åˆ°è¿™é‡Œä½¿ç”¨åˆ°äº†<code>index_merge</code>ï¼Œç®€å•æ¥è¯´index_mergeå°±æ˜¯å¯¹ageå’Œnameåˆ†åˆ«è¿›è¡Œäº†æ‰«æï¼Œç„¶åå°†è¿™ä¸¤ä¸ªç»“æœé›†è¿›è¡Œäº†åˆå¹¶ã€‚è¿™æ ·åšçš„å¥½å¤„å°±æ˜¯<code>é¿å…äº†å…¨è¡¨æ‰«æ</code>ã€‚</p><h3 id="2-11-æ•°æ®åº“å’Œè¡¨çš„å­—ç¬¦é›†ç»Ÿä¸€ä½¿ç”¨utf8mb4"><a href="#2-11-æ•°æ®åº“å’Œè¡¨çš„å­—ç¬¦é›†ç»Ÿä¸€ä½¿ç”¨utf8mb4" class="headerlink" title="2.11 æ•°æ®åº“å’Œè¡¨çš„å­—ç¬¦é›†ç»Ÿä¸€ä½¿ç”¨utf8mb4"></a>2.11 æ•°æ®åº“å’Œè¡¨çš„å­—ç¬¦é›†ç»Ÿä¸€ä½¿ç”¨utf8mb4</h3><p>ç»Ÿä¸€ä½¿ç”¨utf8mb4( 5.5.3ç‰ˆæœ¬ä»¥ä¸Šæ”¯æŒ)å…¼å®¹æ€§æ›´å¥½ï¼Œç»Ÿä¸€å­—ç¬¦é›†å¯ä»¥é¿å…ç”±äºå­—ç¬¦é›†è½¬æ¢äº§ç”Ÿçš„ä¹±ç ã€‚ä¸ åŒçš„ <code>å­—ç¬¦é›†</code> è¿›è¡Œæ¯”è¾ƒå‰éœ€è¦è¿›è¡Œ <code>è½¬æ¢</code> ä¼šé€ æˆç´¢å¼•å¤±æ•ˆã€‚</p><h3 id="2-12-ç»ƒä¹ åŠä¸€èˆ¬æ€§å»ºè®®"><a href="#2-12-ç»ƒä¹ åŠä¸€èˆ¬æ€§å»ºè®®" class="headerlink" title="2.12 ç»ƒä¹ åŠä¸€èˆ¬æ€§å»ºè®®"></a>2.12 ç»ƒä¹ åŠä¸€èˆ¬æ€§å»ºè®®</h3><p><strong>ç»ƒä¹ ï¼š</strong>å‡è®¾ï¼šindex(a,b,c)</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220705145225852.png" class=""><p><strong>ä¸€èˆ¬æ€§å»ºè®®</strong></p><ul><li>å¯¹äºå•åˆ—ç´¢å¼•ï¼Œå°½é‡é€‰æ‹©é’ˆå¯¹å½“å‰queryè¿‡æ»¤æ€§æ›´å¥½çš„ç´¢å¼•</li><li>åœ¨é€‰æ‹©ç»„åˆç´¢å¼•çš„æ—¶å€™ï¼Œå½“å‰queryä¸­è¿‡æ»¤æ€§æœ€å¥½çš„å­—æ®µåœ¨ç´¢å¼•å­—æ®µé¡ºåºä¸­ï¼Œä½ç½®è¶Šé å‰è¶Šå¥½ã€‚</li><li>åœ¨é€‰æ‹©ç»„åˆç´¢å¼•çš„æ—¶å€™ï¼Œå°½é‡é€‰æ‹©èƒ½å¤Ÿå½“å‰queryä¸­whereå­å¥ä¸­æ›´å¤šçš„ç´¢å¼•ã€‚</li><li>åœ¨é€‰æ‹©ç»„åˆç´¢å¼•çš„æ—¶å€™ï¼Œå¦‚æœæŸä¸ªå­—æ®µå¯èƒ½å‡ºç°èŒƒå›´æŸ¥è¯¢æ—¶ï¼Œå°½é‡æŠŠè¿™ä¸ªå­—æ®µæ”¾åœ¨ç´¢å¼•æ¬¡åºçš„æœ€åé¢ã€‚</li></ul><p><strong>æ€»ä¹‹ï¼Œä¹¦å†™SQLè¯­å¥æ—¶ï¼Œå°½é‡é¿å…é€ æˆç´¢å¼•å¤±æ•ˆçš„æƒ…å†µ</strong></p><h2 id="3-å…³è”æŸ¥è¯¢ä¼˜åŒ–"><a href="#3-å…³è”æŸ¥è¯¢ä¼˜åŒ–" class="headerlink" title="3. å…³è”æŸ¥è¯¢ä¼˜åŒ–"></a>3. å…³è”æŸ¥è¯¢ä¼˜åŒ–</h2><h3 id="3-1-æ•°æ®å‡†å¤‡-1"><a href="#3-1-æ•°æ®å‡†å¤‡-1" class="headerlink" title="3.1 æ•°æ®å‡†å¤‡"></a>3.1 æ•°æ®å‡†å¤‡</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"># åˆ†ç±»</span><br><span class="line">CREATE TABLE IF NOT EXISTS `type` (</span><br><span class="line">`id` INT(10) UNSIGNED NOT NULL AUTO_INCREMENT,</span><br><span class="line">`card` INT(10) UNSIGNED NOT NULL,</span><br><span class="line">PRIMARY KEY (`id`)</span><br><span class="line">);</span><br><span class="line">#å›¾ä¹¦</span><br><span class="line">CREATE TABLE IF NOT EXISTS `book` (</span><br><span class="line">`bookid` INT(10) UNSIGNED NOT NULL AUTO_INCREMENT,</span><br><span class="line">`card` INT(10) UNSIGNED NOT NULL,</span><br><span class="line">PRIMARY KEY (`bookid`)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">#å‘åˆ†ç±»è¡¨ä¸­æ·»åŠ 20æ¡è®°å½•</span><br><span class="line">INSERT INTO `type`(card) VALUES(FLOOR(1 + (RAND() * 20)));</span><br><span class="line">INSERT INTO `type`(card) VALUES(FLOOR(1 + (RAND() * 20)));</span><br><span class="line">INSERT INTO `type`(card) VALUES(FLOOR(1 + (RAND() * 20)));</span><br><span class="line">INSERT INTO `type`(card) VALUES(FLOOR(1 + (RAND() * 20)));</span><br><span class="line">INSERT INTO `type`(card) VALUES(FLOOR(1 + (RAND() * 20)));</span><br><span class="line">INSERT INTO `type`(card) VALUES(FLOOR(1 + (RAND() * 20)));</span><br><span class="line">INSERT INTO `type`(card) VALUES(FLOOR(1 + (RAND() * 20)));</span><br><span class="line">INSERT INTO `type`(card) VALUES(FLOOR(1 + (RAND() * 20)));</span><br><span class="line">INSERT INTO `type`(card) VALUES(FLOOR(1 + (RAND() * 20)));</span><br><span class="line">INSERT INTO `type`(card) VALUES(FLOOR(1 + (RAND() * 20)));</span><br><span class="line">INSERT INTO `type`(card) VALUES(FLOOR(1 + (RAND() * 20)));</span><br><span class="line">INSERT INTO `type`(card) VALUES(FLOOR(1 + (RAND() * 20)));</span><br><span class="line">INSERT INTO `type`(card) VALUES(FLOOR(1 + (RAND() * 20)));</span><br><span class="line">INSERT INTO `type`(card) VALUES(FLOOR(1 + (RAND() * 20)));</span><br><span class="line">INSERT INTO `type`(card) VALUES(FLOOR(1 + (RAND() * 20)));</span><br><span class="line">INSERT INTO `type`(card) VALUES(FLOOR(1 + (RAND() * 20)));</span><br><span class="line">INSERT INTO `type`(card) VALUES(FLOOR(1 + (RAND() * 20)));</span><br><span class="line">INSERT INTO `type`(card) VALUES(FLOOR(1 + (RAND() * 20)));</span><br><span class="line">INSERT INTO `type`(card) VALUES(FLOOR(1 + (RAND() * 20)));</span><br><span class="line">INSERT INTO `type`(card) VALUES(FLOOR(1 + (RAND() * 20)));</span><br><span class="line"></span><br><span class="line">#å‘å›¾ä¹¦è¡¨ä¸­æ·»åŠ 20æ¡è®°å½•</span><br><span class="line">INSERT INTO book(card) VALUES(FLOOR(1 + (RAND() * 20)));</span><br><span class="line">INSERT INTO book(card) VALUES(FLOOR(1 + (RAND() * 20)));</span><br><span class="line">INSERT INTO book(card) VALUES(FLOOR(1 + (RAND() * 20)));</span><br><span class="line">INSERT INTO book(card) VALUES(FLOOR(1 + (RAND() * 20)));</span><br><span class="line">INSERT INTO book(card) VALUES(FLOOR(1 + (RAND() * 20)));</span><br><span class="line">INSERT INTO book(card) VALUES(FLOOR(1 + (RAND() * 20)));</span><br><span class="line">INSERT INTO book(card) VALUES(FLOOR(1 + (RAND() * 20)));</span><br><span class="line">INSERT INTO book(card) VALUES(FLOOR(1 + (RAND() * 20)));</span><br><span class="line">INSERT INTO book(card) VALUES(FLOOR(1 + (RAND() * 20)));</span><br><span class="line">INSERT INTO book(card) VALUES(FLOOR(1 + (RAND() * 20)));</span><br><span class="line">INSERT INTO book(card) VALUES(FLOOR(1 + (RAND() * 20)));</span><br><span class="line">INSERT INTO book(card) VALUES(FLOOR(1 + (RAND() * 20)));</span><br><span class="line">INSERT INTO book(card) VALUES(FLOOR(1 + (RAND() * 20)));</span><br><span class="line">INSERT INTO book(card) VALUES(FLOOR(1 + (RAND() * 20)));</span><br><span class="line">INSERT INTO book(card) VALUES(FLOOR(1 + (RAND() * 20)));</span><br><span class="line">INSERT INTO book(card) VALUES(FLOOR(1 + (RAND() * 20)));</span><br><span class="line">INSERT INTO book(card) VALUES(FLOOR(1 + (RAND() * 20)));</span><br><span class="line">INSERT INTO book(card) VALUES(FLOOR(1 + (RAND() * 20)));</span><br><span class="line">INSERT INTO book(card) VALUES(FLOOR(1 + (RAND() * 20)));</span><br><span class="line">INSERT INTO book(card) VALUES(FLOOR(1 + (RAND() * 20)));</span><br></pre></td></tr></table></figure><h3 id="3-2-é‡‡ç”¨å·¦å¤–è¿æ¥"><a href="#3-2-é‡‡ç”¨å·¦å¤–è¿æ¥" class="headerlink" title="3.2 é‡‡ç”¨å·¦å¤–è¿æ¥"></a>3.2 é‡‡ç”¨å·¦å¤–è¿æ¥</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN SELECT SQL_NO_CACHE * FROM `type` LEFT JOIN book ON type.card = book.card;</span><br></pre></td></tr></table></figure><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220705160504018.png" class=""><p>æ·»åŠ ç´¢å¼•ä¼˜åŒ–</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CREATE INDEX Y ON book(card);   #ã€è¢«é©±åŠ¨è¡¨ã€‘ï¼Œå¯ä»¥é¿å…å…¨è¡¨æ‰«æ</span><br><span class="line">EXPLAIN SELECT SQL_NO_CACHE * FROM `type` LEFT JOIN book ON type.card = book.card;</span><br><span class="line">DROP INDEX Y ON book;</span><br><span class="line"># LEFT JOIN æ¡ä»¶ç”¨äºç¡®å®šå¦‚ä½•ä»å³è¡¨æœç´¢è¡Œï¼Œå·¦è¾¹ä¸€å®šéƒ½æœ‰ï¼Œæ‰€ä»¥ `å³è¾¹æ˜¯æˆ‘ä»¬çš„å…³é”®ç‚¹,ä¸€å®šéœ€è¦å»ºç«‹ç´¢å¼•`</span><br></pre></td></tr></table></figure><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220705160935109.png" class=""><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CREATE INDEX X ON `type`(card); #ã€é©±åŠ¨è¡¨ã€‘ï¼Œæ— æ³•é¿å…å…¨è¡¨æ‰«æ</span><br><span class="line">EXPLAIN SELECT SQL_NO_CACHE * FROM `type` LEFT JOIN book ON type.card = book.card;</span><br><span class="line">DROP INDEX X ON `type`;</span><br></pre></td></tr></table></figure><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220705161243838.png" class=""><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CREATE INDEX X ON `type`(card);</span><br><span class="line">CREATE INDEX Y ON book(card);</span><br><span class="line">EXPLAIN SELECT SQL_NO_CACHE * FROM `type` LEFT JOIN book ON type.card = book.card;</span><br><span class="line">DROP INDEX X ON `type`;</span><br><span class="line">DROP INDEX Y ON book;</span><br></pre></td></tr></table></figure><h3 id="3-3-é‡‡ç”¨å†…è¿æ¥"><a href="#3-3-é‡‡ç”¨å†…è¿æ¥" class="headerlink" title="3.3 é‡‡ç”¨å†…è¿æ¥"></a>3.3 é‡‡ç”¨å†…è¿æ¥</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">drop index X on type;</span><br><span class="line">drop index Y on book;ï¼ˆå¦‚æœå·²ç»åˆ é™¤äº†å¯ä»¥ä¸ç”¨å†æ‰§è¡Œè¯¥æ“ä½œï¼‰</span><br></pre></td></tr></table></figure><p>æ¢æˆ inner joinï¼ˆMySQLè‡ªåŠ¨é€‰æ‹©é©±åŠ¨è¡¨ï¼‰</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN SELECT SQL_NO_CACHE * FROM type INNER JOIN book ON type.card=book.card;</span><br></pre></td></tr></table></figure><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220705161602362.png" class=""><p>æ·»åŠ ç´¢å¼•ä¼˜åŒ–</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ALTER TABLE book ADD INDEX Y (card);</span><br><span class="line">EXPLAIN SELECT SQL_NO_CACHE * FROM type INNER JOIN book ON type.card=book.card;</span><br></pre></td></tr></table></figure><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220705161746184.png" class=""><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ALTER TABLE type ADD INDEX X (card);</span><br><span class="line">EXPLAIN SELECT SQL_NO_CACHE * FROM type INNER JOIN book ON type.card=book.card;</span><br></pre></td></tr></table></figure><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220705161843558.png" class=""><p>å¯¹äºå†…è¿æ¥æ¥è¯´ï¼ŒæŸ¥è¯¢ä¼˜åŒ–å™¨å¯ä»¥å†³å®šè°ä½œä¸ºé©±åŠ¨è¡¨ï¼Œè°ä½œä¸ºè¢«é©±åŠ¨è¡¨å‡ºç°çš„</p><p>æ¥ç€ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DROP INDEX X ON `type`;</span><br><span class="line">EXPLAIN SELECT SQL_NO_CACHE * FROM TYPE INNER JOIN book ON type.card=book.card;</span><br></pre></td></tr></table></figure><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220705161929544.png" class=""><p>æ¥ç€ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ALTER TABLE `type` ADD INDEX X (card);</span><br><span class="line">EXPLAIN SELECT SQL_NO_CACHE * FROM `type` INNER JOIN book ON type.card=book.card;</span><br></pre></td></tr></table></figure><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220705162009145.png" class=""><p>æ¥ç€ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">#å‘å›¾ä¹¦è¡¨ä¸­æ·»åŠ 20æ¡è®°å½•</span><br><span class="line">INSERT INTO book(card) VALUES(FLOOR(1 + (RAND() * 20)));</span><br><span class="line">INSERT INTO book(card) VALUES(FLOOR(1 + (RAND() * 20)));</span><br><span class="line">INSERT INTO book(card) VALUES(FLOOR(1 + (RAND() * 20)));</span><br><span class="line">INSERT INTO book(card) VALUES(FLOOR(1 + (RAND() * 20)));</span><br><span class="line">INSERT INTO book(card) VALUES(FLOOR(1 + (RAND() * 20)));</span><br><span class="line">INSERT INTO book(card) VALUES(FLOOR(1 + (RAND() * 20)));</span><br><span class="line">INSERT INTO book(card) VALUES(FLOOR(1 + (RAND() * 20)));</span><br><span class="line">INSERT INTO book(card) VALUES(FLOOR(1 + (RAND() * 20)));</span><br><span class="line">INSERT INTO book(card) VALUES(FLOOR(1 + (RAND() * 20)));</span><br><span class="line">INSERT INTO book(card) VALUES(FLOOR(1 + (RAND() * 20)));</span><br><span class="line">INSERT INTO book(card) VALUES(FLOOR(1 + (RAND() * 20)));</span><br><span class="line">INSERT INTO book(card) VALUES(FLOOR(1 + (RAND() * 20)));</span><br><span class="line">INSERT INTO book(card) VALUES(FLOOR(1 + (RAND() * 20)));</span><br><span class="line">INSERT INTO book(card) VALUES(FLOOR(1 + (RAND() * 20)));</span><br><span class="line">INSERT INTO book(card) VALUES(FLOOR(1 + (RAND() * 20)));</span><br><span class="line">INSERT INTO book(card) VALUES(FLOOR(1 + (RAND() * 20)));</span><br><span class="line">INSERT INTO book(card) VALUES(FLOOR(1 + (RAND() * 20)));</span><br><span class="line">INSERT INTO book(card) VALUES(FLOOR(1 + (RAND() * 20)));</span><br><span class="line">INSERT INTO book(card) VALUES(FLOOR(1 + (RAND() * 20)));</span><br><span class="line">INSERT INTO book(card) VALUES(FLOOR(1 + (RAND() * 20)));</span><br><span class="line"></span><br><span class="line">ALTER TABLE book ADD INDEX Y (card);</span><br><span class="line">EXPLAIN SELECT SQL_NO_CACHE * FROM `type` INNER JOIN book ON `type`.card = book.card;</span><br></pre></td></tr></table></figure><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220705163833445.png" class=""><p>å›¾ä¸­å‘ç°ï¼Œç”±äºtypeè¡¨æ•°æ®å¤§äºbookè¡¨æ•°æ®ï¼ŒMySQLé€‰æ‹©å°†typeä½œä¸ºè¢«é©±åŠ¨è¡¨ã€‚</p><h3 id="3-4-joinè¯­å¥åŸç†"><a href="#3-4-joinè¯­å¥åŸç†" class="headerlink" title="3.4 joinè¯­å¥åŸç†"></a>3.4 joinè¯­å¥åŸç†</h3><p>joinæ–¹å¼è¿æ¥å¤šä¸ªè¡¨ï¼Œæœ¬è´¨å°±æ˜¯å„ä¸ªè¡¨ä¹‹é—´æ•°æ®çš„å¾ªç¯åŒ¹é…ã€‚MySQL5.5ç‰ˆæœ¬ä¹‹å‰ï¼ŒMySQLåªæ”¯æŒä¸€ç§è¡¨é—´å…³è”æ–¹å¼ï¼Œå°±æ˜¯åµŒå¥—å¾ªç¯(Nested Loop Join)ã€‚å¦‚æœå…³è”è¡¨çš„æ•°æ®é‡å¾ˆå¤§ï¼Œåˆ™joinå…³è”çš„æ‰§è¡Œæ—¶é—´ä¼šå¾ˆé•¿ã€‚åœ¨MySQL5.5ä»¥åçš„ç‰ˆæœ¬ä¸­ï¼ŒMySQLé€šè¿‡å¼•å…¥BNLJç®—æ³•æ¥ä¼˜åŒ–åµŒå¥—æ‰§è¡Œã€‚</p><h4 id="1-é©±åŠ¨è¡¨å’Œè¢«é©±åŠ¨è¡¨"><a href="#1-é©±åŠ¨è¡¨å’Œè¢«é©±åŠ¨è¡¨" class="headerlink" title="1. é©±åŠ¨è¡¨å’Œè¢«é©±åŠ¨è¡¨"></a>1. é©±åŠ¨è¡¨å’Œè¢«é©±åŠ¨è¡¨</h4><p>é©±åŠ¨è¡¨å°±æ˜¯ä¸»è¡¨ï¼Œè¢«é©±åŠ¨è¡¨å°±æ˜¯ä»è¡¨ã€éé©±åŠ¨è¡¨ã€‚</p><ul><li>å¯¹äºå†…è¿æ¥æ¥è¯´ï¼š</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM A JOIN B ON ...</span><br></pre></td></tr></table></figure><p>Aä¸€å®šæ˜¯é©±åŠ¨è¡¨å—ï¼Ÿä¸ä¸€å®šï¼Œä¼˜åŒ–å™¨ä¼šæ ¹æ®ä½ æŸ¥è¯¢è¯­å¥åšä¼˜åŒ–ï¼Œå†³å®šå…ˆæŸ¥å“ªå¼ è¡¨ã€‚å…ˆæŸ¥è¯¢çš„é‚£å¼ è¡¨å°±æ˜¯é©±åŠ¨è¡¨ï¼Œåä¹‹å°±æ˜¯è¢«é©±åŠ¨è¡¨ã€‚é€šè¿‡explainå…³é”®å­—å¯ä»¥æŸ¥çœ‹ã€‚</p><ul><li>å¯¹äºå¤–è¿æ¥æ¥è¯´ï¼š</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM A LEFT JOIN B ON ...</span><br><span class="line"># æˆ–</span><br><span class="line">SELECT * FROM B RIGHT JOIN A ON ... </span><br></pre></td></tr></table></figure><p>é€šå¸¸ï¼Œå¤§å®¶ä¼šè®¤ä¸ºAå°±æ˜¯é©±åŠ¨è¡¨ï¼ŒBå°±æ˜¯è¢«é©±åŠ¨è¡¨ã€‚ä½†ä¹Ÿæœªå¿…ã€‚æµ‹è¯•å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE a(f1 INT, f2 INT, INDEX(f1)) ENGINE=INNODB;</span><br><span class="line">CREATE TABLE b(f1 INT, f2 INT) ENGINE=INNODB;</span><br><span class="line"></span><br><span class="line">INSERT INTO a VALUES(1,1),(2,2),(3,3),(4,4),(5,5),(6,6);</span><br><span class="line">INSERT INTO b VALUES(3,3),(4,4),(5,5),(6,6),(7,7),(8,8);</span><br><span class="line"></span><br><span class="line">SELECT * FROM b;</span><br><span class="line"></span><br><span class="line"># æµ‹è¯•1</span><br><span class="line">EXPLAIN SELECT * FROM a LEFT JOIN b ON(a.f1=b.f1) WHERE (a.f2=b.f2);</span><br><span class="line"></span><br><span class="line"># æµ‹è¯•2</span><br><span class="line">EXPLAIN SELECT * FROM a LEFT JOIN b ON(a.f1=b.f1) AND (a.f2=b.f2);</span><br></pre></td></tr></table></figure><h4 id="2-Simple-Nested-Loop-Join-ç®€å•åµŒå¥—å¾ªç¯è¿æ¥"><a href="#2-Simple-Nested-Loop-Join-ç®€å•åµŒå¥—å¾ªç¯è¿æ¥" class="headerlink" title="2. Simple Nested-Loop Join (ç®€å•åµŒå¥—å¾ªç¯è¿æ¥)"></a>2. Simple Nested-Loop Join (ç®€å•åµŒå¥—å¾ªç¯è¿æ¥)</h4><p>ç®—æ³•ç›¸å½“ç®€å•ï¼Œä»è¡¨Aä¸­å–å‡ºä¸€æ¡æ•°æ®1ï¼Œéå†è¡¨Bï¼Œå°†åŒ¹é…åˆ°çš„æ•°æ®æ”¾åˆ°result.. ä»¥æ­¤ç±»æ¨ï¼Œé©±åŠ¨è¡¨Aä¸­çš„æ¯ä¸€æ¡è®°å½•ä¸è¢«é©±åŠ¨è¡¨Bçš„è®°å½•è¿›è¡Œåˆ¤æ–­ï¼š</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220705165559127.png" class=""><p>å¯ä»¥çœ‹åˆ°è¿™ç§æ–¹å¼æ•ˆç‡æ˜¯éå¸¸ä½çš„ï¼Œä»¥ä¸Šè¿°è¡¨Aæ•°æ®100æ¡ï¼Œè¡¨Bæ•°æ®1000æ¡è®¡ç®—ï¼Œåˆ™A*B&#x3D;10ä¸‡æ¬¡ã€‚å¼€é”€ç»Ÿè®¡å¦‚ä¸‹:</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220705165646252.png" class=""><p>å½“ç„¶mysqlè‚¯å®šä¸ä¼šè¿™ä¹ˆç²—æš´çš„å»è¿›è¡Œè¡¨çš„è¿æ¥ï¼Œæ‰€ä»¥å°±å‡ºç°äº†åé¢çš„ä¸¤ç§å¯¹Nested-Loop Joinä¼˜åŒ–ç®—æ³•ã€‚</p><h4 id="3-Index-Nested-Loop-Join-ï¼ˆç´¢å¼•åµŒå¥—å¾ªç¯è¿æ¥ï¼‰"><a href="#3-Index-Nested-Loop-Join-ï¼ˆç´¢å¼•åµŒå¥—å¾ªç¯è¿æ¥ï¼‰" class="headerlink" title="3. Index Nested-Loop Join ï¼ˆç´¢å¼•åµŒå¥—å¾ªç¯è¿æ¥ï¼‰"></a>3. Index Nested-Loop Join ï¼ˆç´¢å¼•åµŒå¥—å¾ªç¯è¿æ¥ï¼‰</h4><p>Index Nested-Loop Joinå…¶ä¼˜åŒ–çš„æ€è·¯ä¸»è¦æ˜¯ä¸ºäº†<code>å‡å°‘å†…å­˜è¡¨æ•°æ®çš„åŒ¹é…æ¬¡æ•°</code>ï¼Œæ‰€ä»¥è¦æ±‚è¢«é©±åŠ¨è¡¨ä¸Šå¿…é¡»<code>æœ‰ç´¢å¼•</code>æ‰è¡Œã€‚é€šè¿‡å¤–å±‚è¡¨åŒ¹é…æ¡ä»¶ç›´æ¥ä¸å†…å±‚è¡¨ç´¢å¼•è¿›è¡ŒåŒ¹é…ï¼Œé¿å…å’Œå†…å­˜è¡¨çš„æ¯æ¡è®°å½•å»è¿›è¡Œæ¯”è¾ƒï¼Œè¿™æ ·æå¤§çš„å‡å°‘äº†å¯¹å†…å­˜è¡¨çš„åŒ¹é…æ¬¡æ•°ã€‚</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220705172315554.png" class=""><p>é©±åŠ¨è¡¨ä¸­çš„æ¯æ¡è®°å½•é€šè¿‡è¢«é©±åŠ¨è¡¨çš„ç´¢å¼•è¿›è¡Œè®¿é—®ï¼Œå› ä¸ºç´¢å¼•æŸ¥è¯¢çš„æˆæœ¬æ˜¯æ¯”è¾ƒå›ºå®šçš„ï¼Œæ•…mysqlä¼˜åŒ–å™¨éƒ½å€¾å‘äºä½¿ç”¨è®°å½•æ•°å°‘çš„è¡¨ä½œä¸ºé©±åŠ¨è¡¨ï¼ˆå¤–è¡¨ï¼‰ã€‚</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220705172650749.png" class=""><p>å¦‚æœè¢«é©±åŠ¨è¡¨åŠ ç´¢å¼•ï¼Œæ•ˆç‡æ˜¯éå¸¸é«˜çš„ï¼Œä½†å¦‚æœç´¢å¼•ä¸æ˜¯ä¸»é”®ç´¢å¼•ï¼Œæ‰€ä»¥è¿˜å¾—è¿›è¡Œä¸€æ¬¡å›è¡¨æŸ¥è¯¢ã€‚ç›¸æ¯”ï¼Œè¢«é©±åŠ¨è¡¨çš„ç´¢å¼•æ˜¯ä¸»é”®ç´¢å¼•ï¼Œæ•ˆç‡ä¼šæ›´é«˜ã€‚</p><h4 id="4-Block-Nested-Loop-Joinï¼ˆå—åµŒå¥—å¾ªç¯è¿æ¥ï¼‰"><a href="#4-Block-Nested-Loop-Joinï¼ˆå—åµŒå¥—å¾ªç¯è¿æ¥ï¼‰" class="headerlink" title="4. Block Nested-Loop Joinï¼ˆå—åµŒå¥—å¾ªç¯è¿æ¥ï¼‰"></a>4. Block Nested-Loop Joinï¼ˆå—åµŒå¥—å¾ªç¯è¿æ¥ï¼‰</h4><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220705173047234.png" class=""><blockquote><p>æ³¨æ„ï¼š</p><p>è¿™é‡Œç¼“å­˜çš„ä¸åªæ˜¯å…³è”è¡¨çš„åˆ—ï¼Œselectåé¢çš„åˆ—ä¹Ÿä¼šç¼“å­˜èµ·æ¥ã€‚</p><p>åœ¨ä¸€ä¸ªæœ‰Nä¸ªjoinå…³è”çš„sqlä¸­ä¼šåˆ†é…N-1ä¸ªjoin bufferã€‚æ‰€ä»¥æŸ¥è¯¢çš„æ—¶å€™å°½é‡å‡å°‘ä¸å¿…è¦çš„å­—æ®µï¼Œå¯ä»¥è®©join bufferä¸­å¯ä»¥å­˜æ”¾æ›´å¤šçš„åˆ—ã€‚</p></blockquote><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220705174005280.png" class=""><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220705174250551.png" class=""><p>å‚æ•°è®¾ç½®ï¼š</p><ul><li>block_nested_loop</li></ul><p>é€šè¿‡<code>show variables like &#39;%optimizer_switch%</code> æŸ¥çœ‹ <code>block_nested_loop</code>çŠ¶æ€ã€‚é»˜è®¤æ˜¯å¼€å¯çš„ã€‚</p><ul><li>join_buffer_size</li></ul><p>é©±åŠ¨è¡¨èƒ½ä¸èƒ½ä¸€æ¬¡åŠ è½½å®Œï¼Œè¦çœ‹join bufferèƒ½ä¸èƒ½å­˜å‚¨æ‰€æœ‰çš„æ•°æ®ï¼Œé»˜è®¤æƒ…å†µä¸‹<code>join_buffer_size=256k</code>ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like &#x27;%join_buffer%&#x27;;</span><br></pre></td></tr></table></figure><p>join_buffer_sizeçš„æœ€å¤§å€¼åœ¨32ä½æ“ä½œç³»ç»Ÿå¯ä»¥ç”³è¯·4Gï¼Œè€Œåœ¨64ä½æ“ä½œç³»ç»Ÿä¸‹å¯ä»¥ç”³è¯·å¤§äº4Gçš„Join Bufferç©ºé—´ï¼ˆ64ä½Windowsé™¤å¤–ï¼Œå…¶å¤§å€¼ä¼šè¢«æˆªæ–­ä¸º4GBå¹¶å‘å‡ºè­¦å‘Šï¼‰ã€‚</p><h4 id="5-Joinå°ç»“"><a href="#5-Joinå°ç»“" class="headerlink" title="5. Joinå°ç»“"></a>5. Joinå°ç»“</h4><p>1ã€<strong>æ•´ä½“æ•ˆç‡æ¯”è¾ƒï¼šINLJ &gt; BNLJ &gt; SNLJ</strong></p><p>2ã€æ°¸è¿œç”¨å°ç»“æœé›†é©±åŠ¨å¤§ç»“æœé›†ï¼ˆå…¶æœ¬è´¨å°±æ˜¯å‡å°‘å¤–å±‚å¾ªç¯çš„æ•°æ®æ•°é‡ï¼‰ï¼ˆå°çš„åº¦é‡å•ä½æŒ‡çš„æ˜¯è¡¨è¡Œæ•° * æ¯è¡Œå¤§å°ï¼‰</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">select t1.b,t2.* from t1 straight_join t2 on (t1.b=t2.b) where t2.id&lt;=100; # æ¨è</span><br><span class="line">select t1.b,t2.* from t2 straight_join t1 on (t1.b=t2.b) where t2.id&lt;=100; # ä¸æ¨è</span><br></pre></td></tr></table></figure><p>3ã€ä¸ºè¢«é©±åŠ¨è¡¨åŒ¹é…çš„æ¡ä»¶å¢åŠ ç´¢å¼•(å‡å°‘å†…å­˜è¡¨çš„å¾ªç¯åŒ¹é…æ¬¡æ•°)</p><p>4ã€å¢å¤§join buffer sizeçš„å¤§å°ï¼ˆä¸€æ¬¡ç´¢å¼•çš„æ•°æ®è¶Šå¤šï¼Œé‚£ä¹ˆå†…å±‚åŒ…çš„æ‰«ææ¬¡æ•°å°±è¶Šå°‘ï¼‰</p><p>5ã€å‡å°‘é©±åŠ¨è¡¨ä¸å¿…è¦çš„å­—æ®µæŸ¥è¯¢ï¼ˆå­—æ®µè¶Šå°‘ï¼Œjoin bufferæ‰€ç¼“å­˜çš„æ•°æ®å°±è¶Šå¤šï¼‰</p><h4 id="6-Hash-Join"><a href="#6-Hash-Join" class="headerlink" title="6. Hash Join"></a>6. Hash Join</h4><p><strong>ä»MySQLçš„8.0.20ç‰ˆæœ¬å¼€å§‹å°†åºŸå¼ƒBNLJï¼Œå› ä¸ºä»MySQL8.0.18ç‰ˆæœ¬å¼€å§‹å°±åŠ å…¥äº†hash joiné»˜è®¤éƒ½ä¼šä½¿ç”¨hash join</strong></p><ul><li><p>Nested Loop:</p><p>å¯¹äºè¢«è¿æ¥çš„æ•°æ®å­é›†è¾ƒå°çš„æƒ…å†µï¼ŒNested Loopæ˜¯ä¸ªè¾ƒå¥½çš„é€‰æ‹©ã€‚</p></li><li><p>Hash Joinæ˜¯åš<code>å¤§æ•°æ®é›†è¿æ¥</code>æ—¶çš„å¸¸ç”¨æ–¹å¼ï¼Œä¼˜åŒ–å™¨ä½¿ç”¨ä¸¤ä¸ªè¡¨ä¸­è¾ƒå°ï¼ˆç›¸å¯¹è¾ƒå°ï¼‰çš„è¡¨åˆ©ç”¨Join Keyåœ¨å†…å­˜ä¸­å»ºç«‹<code>æ•£åˆ—è¡¨</code>ï¼Œç„¶åæ‰«æè¾ƒå¤§çš„è¡¨å¹¶æ¢æµ‹æ•£åˆ—è¡¨ï¼Œæ‰¾å‡ºä¸Hashè¡¨åŒ¹é…çš„è¡Œã€‚</p><ul><li>è¿™ç§æ–¹å¼é€‚åˆäºè¾ƒå°çš„è¡¨å®Œå…¨å¯ä»¥æ”¾äºå†…å­˜ä¸­çš„æƒ…å†µï¼Œè¿™æ ·æ€»æˆæœ¬å°±æ˜¯è®¿é—®ä¸¤ä¸ªè¡¨çš„æˆæœ¬ä¹‹å’Œã€‚</li><li>åœ¨è¡¨å¾ˆå¤§çš„æƒ…å†µä¸‹å¹¶ä¸èƒ½å®Œå…¨æ”¾å…¥å†…å­˜ï¼Œè¿™æ—¶ä¼˜åŒ–å™¨ä¼šå°†å®ƒåˆ†å‰²æˆ<code>è‹¥å¹²ä¸åŒçš„åˆ†åŒº</code>ï¼Œä¸èƒ½æ”¾å…¥å†…å­˜çš„éƒ¨åˆ†å°±æŠŠè¯¥åˆ†åŒºå†™å…¥ç£ç›˜çš„ä¸´æ—¶æ®µï¼Œæ­¤æ—¶è¦æ±‚æœ‰è¾ƒå¤§çš„ä¸´æ—¶æ®µä»è€Œå°½é‡æé«˜I&#x2F;Oçš„æ€§èƒ½ã€‚</li><li>å®ƒèƒ½å¤Ÿå¾ˆå¥½çš„å·¥ä½œäºæ²¡æœ‰ç´¢å¼•çš„å¤§è¡¨å’Œå¹¶è¡ŒæŸ¥è¯¢çš„ç¯å¢ƒä¸­ï¼Œå¹¶æä¾›æœ€å¥½çš„æ€§èƒ½ã€‚å¤§å¤šæ•°äººéƒ½è¯´å®ƒæ˜¯Joinçš„é‡å‹å‡é™æœºã€‚Hash Joinåªèƒ½åº”ç”¨äºç­‰å€¼è¿æ¥ï¼ˆå¦‚WHERE A.COL1 &#x3D; B.COL2ï¼‰ï¼Œè¿™æ˜¯ç”±Hashçš„ç‰¹ç‚¹å†³å®šçš„ã€‚</li></ul></li></ul><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220705205050280.png" class=""><h3 id="3-5-å°ç»“-1"><a href="#3-5-å°ç»“-1" class="headerlink" title="3.5 å°ç»“"></a>3.5 å°ç»“</h3><ul><li>ä¿è¯è¢«é©±åŠ¨è¡¨çš„JOINå­—æ®µå·²ç»åˆ›å»ºäº†ç´¢å¼• </li><li>éœ€è¦JOIN çš„å­—æ®µï¼Œæ•°æ®ç±»å‹ä¿æŒç»å¯¹ä¸€è‡´ã€‚ </li><li>LEFT JOIN æ—¶ï¼Œé€‰æ‹©å°è¡¨ä½œä¸ºé©±åŠ¨è¡¨ï¼Œ å¤§è¡¨ä½œä¸ºè¢«é©±åŠ¨è¡¨ ã€‚å‡å°‘å¤–å±‚å¾ªç¯çš„æ¬¡æ•°ã€‚ </li><li>INNER JOIN æ—¶ï¼ŒMySQLä¼šè‡ªåŠ¨å°† å°ç»“æœé›†çš„è¡¨é€‰ä¸ºé©±åŠ¨è¡¨ ã€‚é€‰æ‹©ç›¸ä¿¡MySQLä¼˜åŒ–ç­–ç•¥ã€‚ </li><li>èƒ½å¤Ÿç›´æ¥å¤šè¡¨å…³è”çš„å°½é‡ç›´æ¥å…³è”ï¼Œä¸ç”¨å­æŸ¥è¯¢ã€‚(å‡å°‘æŸ¥è¯¢çš„è¶Ÿæ•°) </li><li>ä¸å»ºè®®ä½¿ç”¨å­æŸ¥è¯¢ï¼Œå»ºè®®å°†å­æŸ¥è¯¢SQLæ‹†å¼€ç»“åˆç¨‹åºå¤šæ¬¡æŸ¥è¯¢ï¼Œæˆ–ä½¿ç”¨ JOIN æ¥ä»£æ›¿å­æŸ¥è¯¢ã€‚ </li><li>è¡ç”Ÿè¡¨å»ºä¸äº†ç´¢å¼•</li></ul><h2 id="4-å­æŸ¥è¯¢ä¼˜åŒ–"><a href="#4-å­æŸ¥è¯¢ä¼˜åŒ–" class="headerlink" title="4. å­æŸ¥è¯¢ä¼˜åŒ–"></a>4. å­æŸ¥è¯¢ä¼˜åŒ–</h2><p>MySQLä»4.1ç‰ˆæœ¬å¼€å§‹æ”¯æŒå­æŸ¥è¯¢ï¼Œä½¿ç”¨å­æŸ¥è¯¢å¯ä»¥è¿›è¡ŒSELECTè¯­å¥çš„åµŒå¥—æŸ¥è¯¢ï¼Œå³ä¸€ä¸ªSELECTæŸ¥è¯¢çš„ç»“ æœä½œä¸ºå¦ä¸€ä¸ªSELECTè¯­å¥çš„æ¡ä»¶ã€‚ <code>å­æŸ¥è¯¢å¯ä»¥ä¸€æ¬¡æ€§å®Œæˆå¾ˆå¤šé€»è¾‘ä¸Šéœ€è¦å¤šä¸ªæ­¥éª¤æ‰èƒ½å®Œæˆçš„SQLæ“ä½œ</code> ã€‚</p><p><strong>å­æŸ¥è¯¢æ˜¯ MySQL çš„ä¸€é¡¹é‡è¦çš„åŠŸèƒ½ï¼Œå¯ä»¥å¸®åŠ©æˆ‘ä»¬é€šè¿‡ä¸€ä¸ª SQL è¯­å¥å®ç°æ¯”è¾ƒå¤æ‚çš„æŸ¥è¯¢ã€‚ä½†æ˜¯ï¼Œå­ æŸ¥è¯¢çš„æ‰§è¡Œæ•ˆç‡ä¸é«˜ã€‚</strong>åŸå› ï¼š</p><p>â‘  æ‰§è¡Œå­æŸ¥è¯¢æ—¶ï¼ŒMySQLéœ€è¦ä¸ºå†…å±‚æŸ¥è¯¢è¯­å¥çš„æŸ¥è¯¢ç»“æœ å»ºç«‹ä¸€ä¸ªä¸´æ—¶è¡¨ ï¼Œç„¶åå¤–å±‚æŸ¥è¯¢è¯­å¥ä»ä¸´æ—¶è¡¨ ä¸­æŸ¥è¯¢è®°å½•ã€‚æŸ¥è¯¢å®Œæ¯•åï¼Œå† æ’¤é”€è¿™äº›ä¸´æ—¶è¡¨ ã€‚è¿™æ ·ä¼šæ¶ˆè€—è¿‡å¤šçš„CPUå’ŒIOèµ„æºï¼Œäº§ç”Ÿå¤§é‡çš„æ…¢æŸ¥è¯¢ã€‚</p><p>â‘¡ å­æŸ¥è¯¢çš„ç»“æœé›†å­˜å‚¨çš„ä¸´æ—¶è¡¨ï¼Œä¸è®ºæ˜¯å†…å­˜ä¸´æ—¶è¡¨è¿˜æ˜¯ç£ç›˜ä¸´æ—¶è¡¨éƒ½ ä¸ä¼šå­˜åœ¨ç´¢å¼• ï¼Œæ‰€ä»¥æŸ¥è¯¢æ€§èƒ½ä¼š å—åˆ°ä¸€å®šçš„å½±å“ã€‚</p><p>â‘¢ å¯¹äºè¿”å›ç»“æœé›†æ¯”è¾ƒå¤§çš„å­æŸ¥è¯¢ï¼Œå…¶å¯¹æŸ¥è¯¢æ€§èƒ½çš„å½±å“ä¹Ÿå°±è¶Šå¤§ã€‚</p><p><strong>åœ¨MySQLä¸­ï¼Œå¯ä»¥ä½¿ç”¨è¿æ¥ï¼ˆJOINï¼‰æŸ¥è¯¢æ¥æ›¿ä»£å­æŸ¥è¯¢ã€‚</strong>è¿æ¥æŸ¥è¯¢ <code>ä¸éœ€è¦å»ºç«‹ä¸´æ—¶è¡¨</code> ï¼Œå…¶ <code>é€Ÿåº¦æ¯”å­æŸ¥è¯¢</code> è¦å¿« ï¼Œå¦‚æœæŸ¥è¯¢ä¸­ä½¿ç”¨ç´¢å¼•çš„è¯ï¼Œæ€§èƒ½å°±ä¼šæ›´å¥½ã€‚</p><p>ä¸¾ä¾‹1ï¼šæŸ¥è¯¢å­¦ç”Ÿè¡¨ä¸­æ˜¯ç­é•¿çš„å­¦ç”Ÿä¿¡æ¯</p><ul><li>ä½¿ç”¨å­æŸ¥è¯¢</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># åˆ›å»ºç­çº§è¡¨ä¸­ç­é•¿çš„ç´¢å¼•</span><br><span class="line">CREATE INDEX idx_monitor ON class(monitor);</span><br><span class="line"></span><br><span class="line">EXPLAIN SELECT * FROM student stu1</span><br><span class="line">WHERE stu1.`stuno` IN (</span><br><span class="line">SELECT monitor</span><br><span class="line">FROM class c</span><br><span class="line">WHERE monitor IS NOT NULL</span><br><span class="line">)</span><br></pre></td></tr></table></figure><ul><li>æ¨èä½¿ç”¨å¤šè¡¨æŸ¥è¯¢</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN SELECT stu1.* FROM student stu1 JOIN class c</span><br><span class="line">ON stu1.`stuno` = c.`monitor`</span><br><span class="line">WHERE c.`monitor` is NOT NULL;</span><br></pre></td></tr></table></figure><p>ä¸¾ä¾‹2ï¼šå–æ‰€æœ‰ä¸ä¸ºç­é•¿çš„åŒå­¦</p><ul><li>ä¸æ¨è</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN SELECT SQL_NO_CACHE a.*</span><br><span class="line">FROM student a</span><br><span class="line">WHERE a.stuno NOT IN (</span><br><span class="line">SELECT monitor FROM class b</span><br><span class="line">    WHERE monitor IS NOT NULL</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œç»“æœå¦‚ä¸‹ï¼š</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220705210708343.png" class=""><ul><li>æ¨èï¼š</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN SELECT SQL_NO_CACHE a.*</span><br><span class="line">FROM student a LEFT OUTER JOIN class b</span><br><span class="line">ON a.stuno = b.monitor</span><br><span class="line">WHERE b.monitor IS NULL;</span><br></pre></td></tr></table></figure><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220705210839437.png" class=""><blockquote><p>ç»“è®ºï¼šå°½é‡ä¸è¦ä½¿ç”¨NOT INæˆ–è€…NOT EXISTSï¼Œç”¨LEFT JOIN xxx ON xx WHERE xx IS NULLæ›¿ä»£</p></blockquote><h2 id="5-æ’åºä¼˜åŒ–"><a href="#5-æ’åºä¼˜åŒ–" class="headerlink" title="5. æ’åºä¼˜åŒ–"></a>5. æ’åºä¼˜åŒ–</h2><h3 id="5-1-æ’åºä¼˜åŒ–"><a href="#5-1-æ’åºä¼˜åŒ–" class="headerlink" title="5.1 æ’åºä¼˜åŒ–"></a>5.1 æ’åºä¼˜åŒ–</h3><p><strong>é—®é¢˜</strong>ï¼šåœ¨ WHERE æ¡ä»¶å­—æ®µä¸ŠåŠ ç´¢å¼•ï¼Œä½†æ˜¯ä¸ºä»€ä¹ˆåœ¨ ORDER BY å­—æ®µä¸Šè¿˜è¦åŠ ç´¢å¼•å‘¢ï¼Ÿ</p><p><strong>å›ç­”ï¼š</strong></p><p>åœ¨MySQLä¸­ï¼Œæ”¯æŒä¸¤ç§æ’åºæ–¹å¼ï¼Œåˆ†åˆ«æ˜¯ <code>FileSort</code> å’Œ <code>Index</code> æ’åºã€‚</p><ul><li>Index æ’åºä¸­ï¼Œç´¢å¼•å¯ä»¥ä¿è¯æ•°æ®çš„æœ‰åºæ€§ï¼Œä¸éœ€è¦å†è¿›è¡Œæ’åºï¼Œ<code>æ•ˆç‡æ›´é«˜</code>ã€‚</li><li>FileSort æ’åºåˆ™ä¸€èˆ¬åœ¨ <code>å†…å­˜ä¸­</code> è¿›è¡Œæ’åºï¼Œå ç”¨<code>CPUè¾ƒå¤š</code>ã€‚å¦‚æœå¾…æ’ç»“æœè¾ƒå¤§ï¼Œä¼šäº§ç”Ÿä¸´æ—¶æ–‡ä»¶ I&#x2F;O åˆ°ç£ç›˜è¿›è¡Œæ’åºçš„æƒ…å†µï¼Œæ•ˆç‡è¾ƒä½ã€‚</li></ul><p><strong>ä¼˜åŒ–å»ºè®®ï¼š</strong></p><ol><li>SQL ä¸­ï¼Œå¯ä»¥åœ¨ WHERE å­å¥å’Œ ORDER BY å­å¥ä¸­ä½¿ç”¨ç´¢å¼•ï¼Œç›®çš„æ˜¯åœ¨ WHERE å­å¥ä¸­ <code>é¿å…å…¨è¡¨æ‰«æ</code> ï¼Œåœ¨ ORDER BY å­å¥ <code>é¿å…ä½¿ç”¨ FileSort æ’åº</code> ã€‚å½“ç„¶ï¼ŒæŸäº›æƒ…å†µä¸‹å…¨è¡¨æ‰«æï¼Œæˆ–è€… FileSort æ’åºä¸ä¸€å®šæ¯”ç´¢å¼•æ…¢ã€‚ä½†æ€»çš„æ¥è¯´ï¼Œæˆ‘ä»¬è¿˜æ˜¯è¦é¿å…ï¼Œä»¥æé«˜æŸ¥è¯¢æ•ˆç‡ã€‚ </li><li>å°½é‡ä½¿ç”¨ Index å®Œæˆ ORDER BY æ’åºã€‚å¦‚æœ WHERE å’Œ ORDER BY åé¢æ˜¯ç›¸åŒçš„åˆ—å°±ä½¿ç”¨å•ç´¢å¼•åˆ—ï¼› å¦‚æœä¸åŒå°±ä½¿ç”¨è”åˆç´¢å¼•ã€‚ </li><li>æ— æ³•ä½¿ç”¨ Index æ—¶ï¼Œéœ€è¦å¯¹ FileSort æ–¹å¼è¿›è¡Œè°ƒä¼˜ã€‚</li></ol><h3 id="5-2-æµ‹è¯•"><a href="#5-2-æµ‹è¯•" class="headerlink" title="5.2 æµ‹è¯•"></a>5.2 æµ‹è¯•</h3><p>åˆ é™¤studentè¡¨å’Œclassè¡¨ä¸­å·²åˆ›å»ºçš„ç´¢å¼•ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># æ–¹å¼1</span><br><span class="line">DROP INDEX idx_monitor ON class;</span><br><span class="line">DROP INDEX idx_cid ON student;</span><br><span class="line">DROP INDEX idx_age ON student;</span><br><span class="line">DROP INDEX idx_name ON student;</span><br><span class="line">DROP INDEX idx_age_name_classId ON student;</span><br><span class="line">DROP INDEX idx_age_classId_name ON student;</span><br><span class="line"></span><br><span class="line"># æ–¹å¼2</span><br><span class="line">call proc_drop_index(&#x27;atguigudb2&#x27;,&#x27;student&#x27;;)</span><br></pre></td></tr></table></figure><p>ä»¥ä¸‹æ˜¯å¦èƒ½ä½¿ç”¨åˆ°ç´¢å¼•ï¼Œ<code>èƒ½å¦å»æ‰using filesort</code></p><p><strong>è¿‡ç¨‹ä¸€ï¼š</strong></p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220705215436102.png" class=""><p><strong>è¿‡ç¨‹äºŒï¼š order by æ—¶ä¸limit,ç´¢å¼•å¤±æ•ˆ</strong></p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220705215909350.png" class=""><p><strong>è¿‡ç¨‹ä¸‰ï¼šorder by æ—¶é¡ºåºé”™è¯¯ï¼Œç´¢å¼•å¤±æ•ˆ</strong></p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220705220033520.png" class=""><p><strong>è¿‡ç¨‹å››ï¼šorder by æ—¶è§„åˆ™ä¸ä¸€è‡´ï¼Œç´¢å¼•å¤±æ•ˆï¼ˆé¡ºåºé”™ï¼Œä¸ç´¢å¼•ï¼›æ–¹å‘åï¼Œä¸ç´¢å¼•ï¼‰</strong></p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220705220404802.png" class=""><blockquote><p>ç»“è®ºï¼šORDER BY å­å¥ï¼Œå°½é‡ä½¿ç”¨ Index æ–¹å¼æ’åºï¼Œé¿å…ä½¿ç”¨ FileSort æ–¹å¼æ’åº</p></blockquote><p><strong>è¿‡ç¨‹äº”ï¼šæ— è¿‡æ»¤ï¼Œä¸ç´¢å¼•</strong></p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220705221212879.png" class=""><p><strong>å°ç»“</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">INDEX a_b_c(a,b,c)</span><br><span class="line">order by èƒ½ä½¿ç”¨ç´¢å¼•æœ€å·¦å‰ç¼€</span><br><span class="line">- ORDER BY a</span><br><span class="line">- ORDER BY a,b</span><br><span class="line">- ORDER BY a,b,c</span><br><span class="line">- ORDER BY a DESC,b DESC,c DESC</span><br><span class="line">å¦‚æœWHEREä½¿ç”¨ç´¢å¼•çš„æœ€å·¦å‰ç¼€å®šä¹‰ä¸ºå¸¸é‡ï¼Œåˆ™order by èƒ½ä½¿ç”¨ç´¢å¼•</span><br><span class="line">- WHERE a = const ORDER BY b,c</span><br><span class="line">- WHERE a = const AND b = const ORDER BY c</span><br><span class="line">- WHERE a = const ORDER BY b,c</span><br><span class="line">- WHERE a = const AND b &gt; const ORDER BY b,c</span><br><span class="line">ä¸èƒ½ä½¿ç”¨ç´¢å¼•è¿›è¡Œæ’åº</span><br><span class="line">- ORDER BY a ASC,b DESC,c DESC /* æ’åºä¸ä¸€è‡´ */</span><br><span class="line">- WHERE g = const ORDER BY b,c /*ä¸¢å¤±aç´¢å¼•*/</span><br><span class="line">- WHERE a = const ORDER BY c /*ä¸¢å¤±bç´¢å¼•*/</span><br><span class="line">- WHERE a = const ORDER BY a,d /*dä¸æ˜¯ç´¢å¼•çš„ä¸€éƒ¨åˆ†*/</span><br><span class="line">- WHERE a in (...) ORDER BY b,c /*å¯¹äºæ’åºæ¥è¯´ï¼Œå¤šä¸ªç›¸ç­‰æ¡ä»¶ä¹Ÿæ˜¯èŒƒå›´æŸ¥è¯¢*/</span><br></pre></td></tr></table></figure><h3 id="5-3-æ¡ˆä¾‹å®æˆ˜"><a href="#5-3-æ¡ˆä¾‹å®æˆ˜" class="headerlink" title="5.3 æ¡ˆä¾‹å®æˆ˜"></a>5.3 æ¡ˆä¾‹å®æˆ˜</h3><p>ORDER BYå­å¥ï¼Œå°½é‡ä½¿ç”¨Indexæ–¹å¼æ’åºï¼Œé¿å…ä½¿ç”¨FileSortæ–¹å¼æ’åºã€‚ </p><p>æ‰§è¡Œæ¡ˆä¾‹å‰å…ˆæ¸…é™¤studentä¸Šçš„ç´¢å¼•ï¼Œåªç•™ä¸»é”®ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">DROP INDEX idx_age ON student;</span><br><span class="line">DROP INDEX idx_age_classid_stuno ON student;</span><br><span class="line">DROP INDEX idx_age_classid_name ON student;</span><br><span class="line"></span><br><span class="line">#æˆ–è€…</span><br><span class="line">call proc_drop_index(&#x27;atguigudb2&#x27;,&#x27;student&#x27;);</span><br></pre></td></tr></table></figure><p><strong>åœºæ™¯:æŸ¥è¯¢å¹´é¾„ä¸º30å²çš„ï¼Œä¸”å­¦ç”Ÿç¼–å·å°äº101000çš„å­¦ç”Ÿï¼ŒæŒ‰ç”¨æˆ·åç§°æ’åº</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN SELECT SQL_NO_CACHE * FROM student WHERE age = 30 AND stuno &lt;101000 ORDER BY NAME ;</span><br></pre></td></tr></table></figure><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220705222027812.png" class=""><p>æŸ¥è¯¢ç»“æœå¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT SQL_NO_CACHE * FROM student WHERE age = 30 AND stuno &lt;101000 ORDER BY NAME;</span><br><span class="line">+---------+--------+--------+------+---------+</span><br><span class="line">| id      | stuno  |  name  | age  | classId |</span><br><span class="line">+---------+--------+--------+------+---------+</span><br><span class="line">| 922     | 100923 | elTLXD | 30   | 249     |</span><br><span class="line">| 3723263 | 100412 | hKcjLb | 30   | 59      |</span><br><span class="line">| 3724152 | 100827 | iHLJmh | 30   | 387     |</span><br><span class="line">| 3724030 | 100776 | LgxWoD | 30   | 253     |</span><br><span class="line">| 30      | 100031 | LZMOIa | 30   | 97      |</span><br><span class="line">| 3722887 | 100237 | QzbJdx | 30   | 440     |</span><br><span class="line">| 609     | 100610 | vbRimN | 30   | 481     |</span><br><span class="line">| 139     | 100140 | ZqFbuR | 30   | 351     |</span><br><span class="line">+---------+--------+--------+------+---------+</span><br><span class="line">8 rows in set, 1 warning (3.16 sec)</span><br></pre></td></tr></table></figure><blockquote><p>ç»“è®ºï¼štype æ˜¯ ALLï¼Œå³æœ€åçš„æƒ…å†µã€‚Extra é‡Œè¿˜å‡ºç°äº† Using filesort,ä¹Ÿæ˜¯æœ€åçš„æƒ…å†µã€‚ä¼˜åŒ–æ˜¯å¿…é¡»çš„ã€‚</p></blockquote><p><strong>æ–¹æ¡ˆä¸€: ä¸ºäº†å»æ‰filesortæˆ‘ä»¬å¯ä»¥æŠŠç´¢å¼•å»ºæˆ</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#åˆ›å»ºæ–°ç´¢å¼•</span><br><span class="line">CREATE INDEX idx_age_name ON student(age,NAME);</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN SELECT SQL_NO_CACHE * FROM student WHERE age = 30 AND stuno &lt;101000 ORDER BY NAME;</span><br></pre></td></tr></table></figure><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220705222912521.png" class=""><p>è¿™æ ·æˆ‘ä»¬ä¼˜åŒ–æ‰äº† using filesort</p><p>æŸ¥è¯¢ç»“æœå¦‚ä¸‹ï¼š</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220705222954971.png" class=""><p><strong>æ–¹æ¡ˆäºŒï¼šå°½é‡è®©whereçš„è¿‡æ»¤æ¡ä»¶å’Œæ’åºä½¿ç”¨ä¸Šç´¢å¼•</strong></p><p>å»ºä¸€ä¸ªä¸‰ä¸ªå­—æ®µçš„ç»„åˆç´¢å¼•ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">DROP INDEX idx_age_name ON student;</span><br><span class="line">CREATE INDEX idx_age_stuno_name ON student (age,stuno,NAME);</span><br><span class="line">EXPLAIN SELECT SQL_NO_CACHE * FROM student WHERE age = 30 AND stuno &lt;101000 ORDER BY NAME;</span><br></pre></td></tr></table></figure><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220705223111883.png" class=""><p>æˆ‘ä»¬å‘ç°using filesortä¾ç„¶å­˜åœ¨ï¼Œæ‰€ä»¥nameå¹¶æ²¡æœ‰ç”¨åˆ°ç´¢å¼•ï¼Œè€Œä¸”typeè¿˜æ˜¯rangeå…‰çœ‹åå­—å…¶å®å¹¶ä¸ç¾å¥½ã€‚åŸå› æ˜¯ï¼Œå› ä¸º<code>stunoæ˜¯ä¸€ä¸ªèŒƒå›´è¿‡æ»¤</code>ï¼Œæ‰€ä»¥ç´¢å¼•åé¢çš„å­—æ®µä¸ä¼šåœ¨ä½¿ç”¨ç´¢å¼•äº† ã€‚</p><p>ç»“æœå¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT SQL_NO_CACHE * FROM student</span><br><span class="line">-&gt; WHERE age = 30 AND stuno &lt;101000 ORDER BY NAME ;</span><br><span class="line">+-----+--------+--------+------+---------+</span><br><span class="line">| id | stuno | name | age | classId |</span><br><span class="line">+-----+--------+--------+------+---------+</span><br><span class="line">| 167 | 100168 | AClxEF | 30 | 319 |</span><br><span class="line">| 323 | 100324 | bwbTpQ | 30 | 654 |</span><br><span class="line">| 651 | 100652 | DRwIac | 30 | 997 |</span><br><span class="line">| 517 | 100518 | HNSYqJ | 30 | 256 |</span><br><span class="line">| 344 | 100345 | JuepiX | 30 | 329 |</span><br><span class="line">| 905 | 100906 | JuWALd | 30 | 892 |</span><br><span class="line">| 574 | 100575 | kbyqjX | 30 | 260 |</span><br><span class="line">| 703 | 100704 | KJbprS | 30 | 594 |</span><br><span class="line">| 723 | 100724 | OTdJkY | 30 | 236 |</span><br><span class="line">| 656 | 100657 | Pfgqmj | 30 | 600 |</span><br><span class="line">| 982 | 100983 | qywLqw | 30 | 837 |</span><br><span class="line">| 468 | 100469 | sLEKQW | 30 | 346 |</span><br><span class="line">| 988 | 100989 | UBYqJl | 30 | 457 |</span><br><span class="line">| 173 | 100174 | UltkTN | 30 | 830 |</span><br><span class="line">| 332 | 100333 | YjWiZw | 30 | 824 |</span><br><span class="line">+-----+--------+--------+------+---------+</span><br><span class="line">15 rows in set, 1 warning (0.00 sec)</span><br></pre></td></tr></table></figure><p>ç»“æœç«Ÿç„¶æœ‰ filesortçš„ sql è¿è¡Œé€Ÿåº¦ï¼Œ è¶…è¿‡äº†å·²ç»ä¼˜åŒ–æ‰ filesortçš„ sql ï¼Œè€Œä¸”å¿«äº†å¾ˆå¤šï¼Œå‡ ä¹ä¸€ç¬é—´å°±å‡ºç°äº†ç»“æœã€‚</p><p>åŸå› ï¼š</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220705223329164.png" class=""><blockquote><p>ç»“è®ºï¼š</p><ol><li>ä¸¤ä¸ªç´¢å¼•åŒæ—¶å­˜åœ¨ï¼Œmysqlè‡ªåŠ¨é€‰æ‹©æœ€ä¼˜çš„æ–¹æ¡ˆã€‚ï¼ˆå¯¹äºè¿™ä¸ªä¾‹å­ï¼Œmysqlé€‰æ‹© idx_age_stuno_nameï¼‰ã€‚ä½†æ˜¯ï¼Œ <code>éšç€æ•°æ®é‡çš„å˜åŒ–ï¼Œé€‰æ‹©çš„ç´¢å¼•ä¹Ÿä¼šéšä¹‹å˜åŒ–çš„ </code>ã€‚ </li><li><strong>å½“ã€èŒƒå›´æ¡ä»¶ã€‘å’Œã€group by æˆ–è€… order byã€‘çš„å­—æ®µå‡ºç°äºŒé€‰ä¸€æ—¶ï¼Œä¼˜å…ˆè§‚å¯Ÿæ¡ä»¶å­—æ®µçš„è¿‡ æ»¤æ•°é‡ï¼Œå¦‚æœè¿‡æ»¤çš„æ•°æ®è¶³å¤Ÿå¤šï¼Œè€Œéœ€è¦æ’åºçš„æ•°æ®å¹¶ä¸å¤šæ—¶ï¼Œä¼˜å…ˆæŠŠç´¢å¼•æ”¾åœ¨èŒƒå›´å­—æ®µä¸Šã€‚åä¹‹ï¼Œäº¦ç„¶ã€‚</strong></li></ol></blockquote><p>æ€è€ƒï¼šè¿™é‡Œæˆ‘ä»¬ä½¿ç”¨å¦‚ä¸‹ç´¢å¼•ï¼Œæ˜¯å¦å¯è¡Œï¼Ÿ</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">DROP INDEX idx_age_stuno_name ON student;</span><br><span class="line"></span><br><span class="line">CREATE INDEX idx_age_stuno ON student(age,stuno);</span><br></pre></td></tr></table></figure><p>å½“ç„¶å¯ä»¥ã€‚</p><h3 id="5-4-filesortç®—æ³•ï¼šåŒè·¯æ’åºå’Œå•è·¯æ’åº"><a href="#5-4-filesortç®—æ³•ï¼šåŒè·¯æ’åºå’Œå•è·¯æ’åº" class="headerlink" title="5.4 filesortç®—æ³•ï¼šåŒè·¯æ’åºå’Œå•è·¯æ’åº"></a>5.4 filesortç®—æ³•ï¼šåŒè·¯æ’åºå’Œå•è·¯æ’åº</h3><p>æ’åºçš„å­—æ®µè‹¥ä¸åœ¨ç´¢å¼•åˆ—ä¸Šï¼Œåˆ™filesortä¼šæœ‰ä¸¤ç§ç®—æ³•ï¼šåŒè·¯æ’åºå’Œå•è·¯æ’åº</p><p><strong>åŒè·¯æ’åº ï¼ˆæ…¢ï¼‰</strong></p><ul><li>MySQL 4.1ä¹‹å‰æ˜¯ä½¿ç”¨åŒè·¯æ’åº ï¼Œå­—é¢æ„æ€å°±æ˜¯ä¸¤æ¬¡æ‰«æç£ç›˜ï¼Œæœ€ç»ˆå¾—åˆ°æ•°æ®ï¼Œ è¯»å–è¡ŒæŒ‡é’ˆå’Œ order byåˆ— ï¼Œå¯¹ä»–ä»¬è¿›è¡Œæ’åºï¼Œç„¶åæ‰«æå·²ç»æ’åºå¥½çš„åˆ—è¡¨ï¼ŒæŒ‰ç…§åˆ—è¡¨ä¸­çš„å€¼é‡æ–°ä»åˆ—è¡¨ä¸­è¯»å–å¯¹åº”çš„æ•°æ®è¾“å‡º </li><li>ä»ç£ç›˜å–æ’åºå­—æ®µï¼Œåœ¨bufferè¿›è¡Œæ’åºï¼Œå†ä»ç£ç›˜å–å…¶ä»–å­—æ®µ ã€‚</li></ul><p>å–ä¸€æ‰¹æ•°æ®ï¼Œè¦å¯¹ç£ç›˜è¿›è¡Œä¸¤æ¬¡æ‰«æï¼Œä¼—æ‰€å‘¨çŸ¥ï¼ŒIOæ˜¯å¾ˆè€—æ—¶çš„ï¼Œæ‰€ä»¥åœ¨mysql4.1ä¹‹åï¼Œå‡ºç°äº†ç¬¬äºŒç§ æ”¹è¿›çš„ç®—æ³•ï¼Œå°±æ˜¯å•è·¯æ’åºã€‚</p><p><strong>å•è·¯æ’åº ï¼ˆå¿«ï¼‰</strong></p><p>ä»ç£ç›˜è¯»å–æŸ¥è¯¢éœ€è¦çš„ æ‰€æœ‰åˆ— ï¼ŒæŒ‰ç…§order byåˆ—åœ¨bufferå¯¹å®ƒä»¬è¿›è¡Œæ’åºï¼Œç„¶åæ‰«ææ’åºåçš„åˆ—è¡¨è¿›è¡Œè¾“å‡ºï¼Œ å®ƒçš„æ•ˆç‡æ›´å¿«ä¸€äº›ï¼Œé¿å…äº†ç¬¬äºŒæ¬¡è¯»å–æ•°æ®ã€‚å¹¶ä¸”æŠŠéšæœºIOå˜æˆäº†é¡ºåºIOï¼Œä½†æ˜¯å®ƒä¼šä½¿ç”¨æ›´å¤šçš„ç©ºé—´ï¼Œ å› ä¸ºå®ƒæŠŠæ¯ä¸€è¡Œéƒ½ä¿å­˜åœ¨å†…å­˜ä¸­äº†ã€‚</p><p><strong>ç»“è®ºåŠå¼•ç”³å‡ºçš„é—®é¢˜</strong></p><ul><li>ç”±äºå•è·¯æ˜¯åå‡ºçš„ï¼Œæ€»ä½“è€Œè¨€å¥½è¿‡åŒè·¯ </li><li>ä½†æ˜¯ç”¨å•è·¯æœ‰é—®é¢˜<ul><li>åœ¨sort_bufferä¸­ï¼Œå•è·¯è¦æ¯”å¤šè·¯å¤šå ç”¨å¾ˆå¤šç©ºé—´ï¼Œå› ä¸ºå•è·¯æ˜¯æŠŠæ‰€æœ‰å­—æ®µéƒ½å–å‡ºï¼Œæ‰€ä»¥æœ‰å¯èƒ½å–å‡ºçš„æ•°æ®çš„æ€»å¤§å°è¶…å‡ºäº†<code>sort_buffer</code>çš„å®¹é‡ï¼Œå¯¼è‡´æ¯æ¬¡åªèƒ½å–<code>sort_buffer</code>å®¹é‡å¤§å°çš„æ•°æ®ï¼Œè¿›è¡Œæ’åºï¼ˆåˆ›å»ºtmpæ–‡ä»¶ï¼Œå¤šè·¯åˆå¹¶ï¼‰ï¼Œæ’å®Œå†å–sort_bufferå®¹é‡å¤§å°ï¼Œå†æ’â€¦ä»è€Œå¤šæ¬¡I&#x2F;Oã€‚</li><li>å•è·¯æœ¬æ¥æƒ³çœä¸€æ¬¡I&#x2F;Oæ“ä½œï¼Œåè€Œå¯¼è‡´äº†å¤§é‡çš„I&#x2F;Oæ“ä½œï¼Œåè€Œå¾—ä¸å¿å¤±ã€‚</li></ul></li></ul><p><strong>ä¼˜åŒ–ç­–ç•¥</strong></p><p><strong>1. å°è¯•æé«˜ sort_buffer_size</strong></p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220705224410340.png" class=""><p><strong>2. å°è¯•æé«˜ max_length_for_sort_data</strong></p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220705224505668.png" class=""><p><strong>3. Order by æ—¶select * æ˜¯ä¸€ä¸ªå¤§å¿Œã€‚æœ€å¥½åªQueryéœ€è¦çš„å­—æ®µã€‚</strong></p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220705224551104.png" class=""><h2 id="6-GROUP-BYä¼˜åŒ–"><a href="#6-GROUP-BYä¼˜åŒ–" class="headerlink" title="6. GROUP BYä¼˜åŒ–"></a>6. GROUP BYä¼˜åŒ–</h2><ul><li>group by ä½¿ç”¨ç´¢å¼•çš„åŸåˆ™å‡ ä¹è·Ÿorder byä¸€è‡´ ï¼Œgroup by å³ä½¿æ²¡æœ‰è¿‡æ»¤æ¡ä»¶ç”¨åˆ°ç´¢å¼•ï¼Œä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨ç´¢å¼•ã€‚ </li><li>group by å…ˆæ’åºå†åˆ†ç»„ï¼Œéµç…§ç´¢å¼•å»ºçš„æœ€ä½³å·¦å‰ç¼€æ³•åˆ™ </li><li>å½“æ— æ³•ä½¿ç”¨ç´¢å¼•åˆ—ï¼Œå¢å¤§ max_length_for_sort_data å’Œ sort_buffer_size å‚æ•°çš„è®¾ç½® </li><li>whereæ•ˆç‡é«˜äºhavingï¼Œèƒ½å†™åœ¨whereé™å®šçš„æ¡ä»¶å°±ä¸è¦å†™åœ¨havingä¸­äº† </li><li>å‡å°‘ä½¿ç”¨order byï¼Œå’Œä¸šåŠ¡æ²Ÿé€šèƒ½ä¸æ’åºå°±ä¸æ’åºï¼Œæˆ–å°†æ’åºæ”¾åˆ°ç¨‹åºç«¯å»åšã€‚Order byã€group byã€distinctè¿™äº›è¯­å¥è¾ƒä¸ºè€—è´¹CPUï¼Œæ•°æ®åº“çš„CPUèµ„æºæ˜¯æå…¶å®è´µçš„ã€‚ </li><li>åŒ…å«äº†order byã€group byã€distinctè¿™äº›æŸ¥è¯¢çš„è¯­å¥ï¼Œwhereæ¡ä»¶è¿‡æ»¤å‡ºæ¥çš„ç»“æœé›†è¯·ä¿æŒåœ¨1000è¡Œ ä»¥å†…ï¼Œå¦åˆ™SQLä¼šå¾ˆæ…¢ã€‚</li></ul><h2 id="7-ä¼˜åŒ–åˆ†é¡µæŸ¥è¯¢"><a href="#7-ä¼˜åŒ–åˆ†é¡µæŸ¥è¯¢" class="headerlink" title="7. ä¼˜åŒ–åˆ†é¡µæŸ¥è¯¢"></a>7. ä¼˜åŒ–åˆ†é¡µæŸ¥è¯¢</h2><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220705225329130.png" class=""><p><strong>ä¼˜åŒ–æ€è·¯ä¸€</strong></p><p>åœ¨ç´¢å¼•ä¸Šå®Œæˆæ’åºåˆ†é¡µæ“ä½œï¼Œæœ€åæ ¹æ®ä¸»é”®å…³è”å›åŸè¡¨æŸ¥è¯¢æ‰€éœ€è¦çš„å…¶ä»–åˆ—å†…å®¹ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN SELECT * FROM student t,(SELECT id FROM student ORDER BY id LIMIT 2000000,10) a WHERE t.id = a.id;</span><br></pre></td></tr></table></figure><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220705225625166.png" class=""><p><strong>ä¼˜åŒ–æ€è·¯äºŒ</strong></p><p>è¯¥æ–¹æ¡ˆé€‚ç”¨äºä¸»é”®è‡ªå¢çš„è¡¨ï¼Œå¯ä»¥æŠŠLimit æŸ¥è¯¢è½¬æ¢æˆæŸä¸ªä½ç½®çš„æŸ¥è¯¢ ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN SELECT * FROM student WHERE id &gt; 2000000 LIMIT 10;</span><br></pre></td></tr></table></figure><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220705225654124.png" class=""><h2 id="8-ä¼˜å…ˆè€ƒè™‘è¦†ç›–ç´¢å¼•"><a href="#8-ä¼˜å…ˆè€ƒè™‘è¦†ç›–ç´¢å¼•" class="headerlink" title="8. ä¼˜å…ˆè€ƒè™‘è¦†ç›–ç´¢å¼•"></a>8. ä¼˜å…ˆè€ƒè™‘è¦†ç›–ç´¢å¼•</h2><h3 id="8-1-ä»€ä¹ˆæ˜¯è¦†ç›–ç´¢å¼•ï¼Ÿ"><a href="#8-1-ä»€ä¹ˆæ˜¯è¦†ç›–ç´¢å¼•ï¼Ÿ" class="headerlink" title="8.1 ä»€ä¹ˆæ˜¯è¦†ç›–ç´¢å¼•ï¼Ÿ"></a>8.1 ä»€ä¹ˆæ˜¯è¦†ç›–ç´¢å¼•ï¼Ÿ</h3><p><strong>ç†è§£æ–¹å¼ä¸€</strong>ï¼šç´¢å¼•æ˜¯é«˜æ•ˆæ‰¾åˆ°è¡Œçš„ä¸€ä¸ªæ–¹æ³•ï¼Œä½†æ˜¯ä¸€èˆ¬æ•°æ®åº“ä¹Ÿèƒ½ä½¿ç”¨ç´¢å¼•æ‰¾åˆ°ä¸€ä¸ªåˆ—çš„æ•°æ®ï¼Œå› æ­¤å®ƒä¸å¿…è¯»å–æ•´ä¸ªè¡Œã€‚æ¯•ç«Ÿç´¢å¼•å¶å­èŠ‚ç‚¹å­˜å‚¨äº†å®ƒä»¬ç´¢å¼•çš„æ•°æ®ï¼›å½“èƒ½é€šè¿‡è¯»å–ç´¢å¼•å°±å¯ä»¥å¾—åˆ°æƒ³è¦çš„æ•°æ®ï¼Œé‚£å°±ä¸éœ€è¦è¯»å–è¡Œäº†ã€‚<strong>ä¸€ä¸ªç´¢å¼•åŒ…å«äº†æ»¡è¶³æŸ¥è¯¢ç»“æœçš„æ•°æ®å°±å«åšè¦†ç›–ç´¢å¼•</strong>ã€‚</p><p><strong>ç†è§£æ–¹å¼äºŒ</strong>ï¼šéèšç°‡å¤åˆç´¢å¼•çš„ä¸€ç§å½¢å¼ï¼Œå®ƒåŒ…æ‹¬åœ¨æŸ¥è¯¢é‡Œçš„SELECTã€JOINå’ŒWHEREå­å¥ç”¨åˆ°çš„æ‰€æœ‰åˆ— ï¼ˆå³å»ºç´¢å¼•çš„å­—æ®µæ­£å¥½æ˜¯è¦†ç›–æŸ¥è¯¢æ¡ä»¶ä¸­æ‰€æ¶‰åŠçš„å­—æ®µï¼‰ã€‚</p><p>ç®€å•è¯´å°±æ˜¯ï¼Œ <code>ç´¢å¼•åˆ—+ä¸»é”®</code> åŒ…å« <code>SELECT åˆ° FROMä¹‹é—´æŸ¥è¯¢çš„åˆ—</code> ã€‚</p><p><strong>ä¸¾ä¾‹ä¸€ï¼š</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># åˆ é™¤ä¹‹å‰çš„ç´¢å¼•</span><br><span class="line">DROP INDEX idx_age_stuno ON student;</span><br><span class="line">CREATE INDEX idx_age_name ON student(age, NAME);</span><br><span class="line">EXPLAIN SELECT * FROM student WHERE age &lt;&gt; 20;</span><br></pre></td></tr></table></figure><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220706124528680.png" class=""><p><strong>ä¸¾ä¾‹äºŒï¼š</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN SELECT * FROM student WHERE NAME LIKE &#x27;%abc&#x27;;</span><br></pre></td></tr></table></figure><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220706124612180.png" class=""><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CREATE INDEX idx_age_name ON student(age, NAME);</span><br><span class="line">EXPLAIN SELECT id,age,NAME FROM student WHERE NAME LIKE &#x27;%abc&#x27;;</span><br></pre></td></tr></table></figure><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220706125113658.png" class=""><p>ä¸Šè¿°éƒ½ä½¿ç”¨åˆ°äº†å£°æ˜çš„ç´¢å¼•ï¼Œä¸‹é¢çš„æƒ…å†µåˆ™ä¸ç„¶ï¼ŒæŸ¥è¯¢åˆ—ä¾ç„¶å¤šäº†classId,ç»“æœæ˜¯æœªä½¿ç”¨åˆ°ç´¢å¼•ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">EXPLAIN SELECT id,age,NAME,classId FROM student WHERE NAME LIKE &#x27;%abc&#x27;;</span><br></pre></td></tr></table></figure><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220706125351116.png" class=""><h3 id="8-2-è¦†ç›–ç´¢å¼•çš„åˆ©å¼Š"><a href="#8-2-è¦†ç›–ç´¢å¼•çš„åˆ©å¼Š" class="headerlink" title="8.2 è¦†ç›–ç´¢å¼•çš„åˆ©å¼Š"></a>8.2 è¦†ç›–ç´¢å¼•çš„åˆ©å¼Š</h3><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220706125943936.png" class=""><h2 id="9-å¦‚ä½•ç»™å­—ç¬¦ä¸²æ·»åŠ ç´¢å¼•"><a href="#9-å¦‚ä½•ç»™å­—ç¬¦ä¸²æ·»åŠ ç´¢å¼•" class="headerlink" title="9. å¦‚ä½•ç»™å­—ç¬¦ä¸²æ·»åŠ ç´¢å¼•"></a>9. å¦‚ä½•ç»™å­—ç¬¦ä¸²æ·»åŠ ç´¢å¼•</h2><p>æœ‰ä¸€å¼ æ•™å¸ˆè¡¨ï¼Œè¡¨å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">create table teacher(</span><br><span class="line">ID bigint unsigned primary key,</span><br><span class="line">email varchar(64),</span><br><span class="line">...</span><br><span class="line">)engine=innodb;</span><br></pre></td></tr></table></figure><p>è®²å¸ˆè¦ä½¿ç”¨é‚®ç®±ç™»å½•ï¼Œæ‰€ä»¥ä¸šåŠ¡ä»£ç ä¸­ä¸€å®šä¼šå‡ºç°ç±»ä¼¼äºè¿™æ ·çš„è¯­å¥ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select col1, col2 from teacher where email=&#x27;xxx&#x27;;</span><br></pre></td></tr></table></figure><p>å¦‚æœemailè¿™ä¸ªå­—æ®µä¸Šæ²¡æœ‰ç´¢å¼•ï¼Œé‚£ä¹ˆè¿™ä¸ªè¯­å¥å°±åªèƒ½åš <code>å…¨è¡¨æ‰«æ</code> ã€‚</p><h3 id="9-1-å‰ç¼€ç´¢å¼•"><a href="#9-1-å‰ç¼€ç´¢å¼•" class="headerlink" title="9.1 å‰ç¼€ç´¢å¼•"></a>9.1 å‰ç¼€ç´¢å¼•</h3><p>MySQLæ˜¯æ”¯æŒå‰ç¼€ç´¢å¼•çš„ã€‚é»˜è®¤åœ°ï¼Œå¦‚æœä½ åˆ›å»ºç´¢å¼•çš„è¯­å¥ä¸æŒ‡å®šå‰ç¼€é•¿åº¦ï¼Œé‚£ä¹ˆç´¢å¼•å°±ä¼šåŒ…å«æ•´ä¸ªå­— ç¬¦ä¸²ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; alter table teacher add index index1(email);</span><br><span class="line">#æˆ–</span><br><span class="line">mysql&gt; alter table teacher add index index2(email(6));</span><br></pre></td></tr></table></figure><p>è¿™ä¸¤ç§ä¸åŒçš„å®šä¹‰åœ¨æ•°æ®ç»“æ„å’Œå­˜å‚¨ä¸Šæœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿä¸‹å›¾å°±æ˜¯è¿™ä¸¤ä¸ªç´¢å¼•çš„ç¤ºæ„å›¾ã€‚</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220706130901307.png" class=""><p>ä»¥åŠ</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220706130921934.png" class=""><p><strong>å¦‚æœä½¿ç”¨çš„æ˜¯index1</strong>ï¼ˆå³emailæ•´ä¸ªå­—ç¬¦ä¸²çš„ç´¢å¼•ç»“æ„ï¼‰ï¼Œæ‰§è¡Œé¡ºåºæ˜¯è¿™æ ·çš„ï¼š</p><ol><li>ä»index1ç´¢å¼•æ ‘æ‰¾åˆ°æ»¡è¶³ç´¢å¼•å€¼æ˜¯â€™ <a href="mailto:&#x7a;&#104;&#x61;&#110;&#103;&#x73;&#x73;&#120;&#x79;&#122;&#x40;&#x78;&#120;&#120;&#x2e;&#99;&#111;&#x6d;">&#x7a;&#104;&#x61;&#110;&#103;&#x73;&#x73;&#120;&#x79;&#122;&#x40;&#x78;&#120;&#120;&#x2e;&#99;&#111;&#x6d;</a>â€™çš„è¿™æ¡è®°å½•ï¼Œå–å¾—ID2çš„å€¼ï¼› </li><li>åˆ°ä¸»é”®ä¸ŠæŸ¥åˆ°ä¸»é”®å€¼æ˜¯ID2çš„è¡Œï¼Œåˆ¤æ–­emailçš„å€¼æ˜¯æ­£ç¡®çš„ï¼Œå°†è¿™è¡Œè®°å½•åŠ å…¥ç»“æœé›†ï¼› </li><li>å–index1ç´¢å¼•æ ‘ä¸ŠåˆšåˆšæŸ¥åˆ°çš„ä½ç½®çš„ä¸‹ä¸€æ¡è®°å½•ï¼Œå‘ç°å·²ç»ä¸æ»¡è¶³email&#x3D;â€™ <a href="mailto:&#x7a;&#x68;&#x61;&#x6e;&#x67;&#115;&#x73;&#120;&#121;&#122;&#64;&#x78;&#x78;&#x78;&#x2e;&#x63;&#x6f;&#109;">&#x7a;&#x68;&#x61;&#x6e;&#x67;&#115;&#x73;&#120;&#121;&#122;&#64;&#x78;&#x78;&#x78;&#x2e;&#x63;&#x6f;&#109;</a> â€™çš„ æ¡ä»¶äº†ï¼Œå¾ªç¯ç»“æŸã€‚</li></ol><p>è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œåªéœ€è¦å›ä¸»é”®ç´¢å¼•å–ä¸€æ¬¡æ•°æ®ï¼Œæ‰€ä»¥ç³»ç»Ÿè®¤ä¸ºåªæ‰«æäº†ä¸€è¡Œã€‚</p><p><strong>å¦‚æœä½¿ç”¨çš„æ˜¯index2</strong>ï¼ˆå³email(6)ç´¢å¼•ç»“æ„ï¼‰ï¼Œæ‰§è¡Œé¡ºåºæ˜¯è¿™æ ·çš„ï¼š</p><ol><li>ä»index2ç´¢å¼•æ ‘æ‰¾åˆ°æ»¡è¶³ç´¢å¼•å€¼æ˜¯â€™zhangsâ€™çš„è®°å½•ï¼Œæ‰¾åˆ°çš„ç¬¬ä¸€ä¸ªæ˜¯ID1ï¼› </li><li>åˆ°ä¸»é”®ä¸ŠæŸ¥åˆ°ä¸»é”®å€¼æ˜¯ID1çš„è¡Œï¼Œåˆ¤æ–­å‡ºemailçš„å€¼ä¸æ˜¯â€™ <a href="mailto:&#x7a;&#x68;&#97;&#110;&#x67;&#x73;&#x73;&#120;&#121;&#x7a;&#64;&#120;&#120;&#x78;&#46;&#x63;&#x6f;&#109;">&#x7a;&#x68;&#97;&#110;&#x67;&#x73;&#x73;&#120;&#121;&#x7a;&#64;&#120;&#120;&#x78;&#46;&#x63;&#x6f;&#109;</a> â€™ï¼Œè¿™è¡Œè®°å½•ä¸¢å¼ƒï¼› </li><li>å–index2ä¸ŠåˆšåˆšæŸ¥åˆ°çš„ä½ç½®çš„ä¸‹ä¸€æ¡è®°å½•ï¼Œå‘ç°ä»ç„¶æ˜¯â€™zhangsâ€™ï¼Œå–å‡ºID2ï¼Œå†åˆ°IDç´¢å¼•ä¸Šå–æ•´è¡Œç„¶ ååˆ¤æ–­ï¼Œè¿™æ¬¡å€¼å¯¹äº†ï¼Œå°†è¿™è¡Œè®°å½•åŠ å…¥ç»“æœé›†ï¼› </li><li>é‡å¤ä¸Šä¸€æ­¥ï¼Œç›´åˆ°åœ¨idxe2ä¸Šå–åˆ°çš„å€¼ä¸æ˜¯â€™zhangsâ€™æ—¶ï¼Œå¾ªç¯ç»“æŸã€‚</li></ol><p>ä¹Ÿå°±æ˜¯è¯´<strong>ä½¿ç”¨å‰ç¼€ç´¢å¼•ï¼Œå®šä¹‰å¥½é•¿åº¦ï¼Œå°±å¯ä»¥åšåˆ°æ—¢èŠ‚çœç©ºé—´ï¼Œåˆä¸ç”¨é¢å¤–å¢åŠ å¤ªå¤šçš„æŸ¥è¯¢æˆæœ¬ã€‚</strong>å‰é¢ å·²ç»è®²è¿‡åŒºåˆ†åº¦ï¼ŒåŒºåˆ†åº¦è¶Šé«˜è¶Šå¥½ã€‚å› ä¸ºåŒºåˆ†åº¦è¶Šé«˜ï¼Œæ„å‘³ç€é‡å¤çš„é”®å€¼è¶Šå°‘ã€‚</p><h3 id="9-2-å‰ç¼€ç´¢å¼•å¯¹è¦†ç›–ç´¢å¼•çš„å½±å“"><a href="#9-2-å‰ç¼€ç´¢å¼•å¯¹è¦†ç›–ç´¢å¼•çš„å½±å“" class="headerlink" title="9.2 å‰ç¼€ç´¢å¼•å¯¹è¦†ç›–ç´¢å¼•çš„å½±å“"></a>9.2 å‰ç¼€ç´¢å¼•å¯¹è¦†ç›–ç´¢å¼•çš„å½±å“</h3><blockquote><p>ç»“è®ºï¼š ä½¿ç”¨å‰ç¼€ç´¢å¼•å°±ç”¨ä¸ä¸Šè¦†ç›–ç´¢å¼•å¯¹æŸ¥è¯¢æ€§èƒ½çš„ä¼˜åŒ–äº†ï¼Œè¿™ä¹Ÿæ˜¯ä½ åœ¨é€‰æ‹©æ˜¯å¦ä½¿ç”¨å‰ç¼€ç´¢å¼•æ—¶éœ€è¦è€ƒè™‘çš„ä¸€ä¸ªå› ç´ ã€‚</p></blockquote><h2 id="10-ç´¢å¼•ä¸‹æ¨"><a href="#10-ç´¢å¼•ä¸‹æ¨" class="headerlink" title="10. ç´¢å¼•ä¸‹æ¨"></a>10. ç´¢å¼•ä¸‹æ¨</h2><h3 id="10-1-ä½¿ç”¨å‰åå¯¹æ¯”"><a href="#10-1-ä½¿ç”¨å‰åå¯¹æ¯”" class="headerlink" title="10.1 ä½¿ç”¨å‰åå¯¹æ¯”"></a>10.1 ä½¿ç”¨å‰åå¯¹æ¯”</h3><p>Index Condition Pushdown(ICP)æ˜¯MySQL 5.6ä¸­æ–°ç‰¹æ€§ï¼Œæ˜¯ä¸€ç§åœ¨å­˜å‚¨å¼•æ“å±‚ä½¿ç”¨ç´¢å¼•è¿‡æ»¤æ•°æ®çš„ä¸€ç§ä¼˜åŒ–æ–¹å¼ã€‚</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220706131320477.png" class=""><h3 id="10-2-ICPçš„å¼€å¯-x2F-å…³é—­"><a href="#10-2-ICPçš„å¼€å¯-x2F-å…³é—­" class="headerlink" title="10.2 ICPçš„å¼€å¯&#x2F;å…³é—­"></a>10.2 ICPçš„å¼€å¯&#x2F;å…³é—­</h3><ul><li>é»˜è®¤æƒ…å†µä¸‹å¯åŠ¨ç´¢å¼•æ¡ä»¶ä¸‹æ¨ã€‚å¯ä»¥é€šè¿‡è®¾ç½®ç³»ç»Ÿå˜é‡<code>optimizer_switch</code>æ§åˆ¶ï¼š<code>index_condition_pushdown</code></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># æ‰“å¼€ç´¢å¼•ä¸‹æ¨</span><br><span class="line">SET optimizer_switch = &#x27;index_condition_pushdown=on&#x27;;</span><br><span class="line"></span><br><span class="line"># å…³é—­ç´¢å¼•ä¸‹æ¨</span><br><span class="line">SET optimizer_switch = &#x27;index_condition_pushdown=off&#x27;;</span><br></pre></td></tr></table></figure><ul><li>å½“ä½¿ç”¨ç´¢å¼•æ¡ä»¶ä¸‹æ¨æ˜¯ï¼Œ<code>EXPLAIN</code>è¯­å¥è¾“å‡ºç»“æœä¸­<code>Extra</code>åˆ—å†…å®¹æ˜¾ç¤ºä¸º<code>Using index condition</code>ã€‚</li></ul><h3 id="10-3-ICPä½¿ç”¨æ¡ˆä¾‹"><a href="#10-3-ICPä½¿ç”¨æ¡ˆä¾‹" class="headerlink" title="10.3 ICPä½¿ç”¨æ¡ˆä¾‹"></a>10.3 ICPä½¿ç”¨æ¡ˆä¾‹</h3><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220706135436316.png" class=""><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220706135506409.png" class=""><ul><li>ä¸»é”®ç´¢å¼• (ç®€å›¾)</li></ul><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220706135633814.png" class=""><p>äºŒçº§ç´¢å¼•zip_last_first (ç®€å›¾ï¼Œè¿™é‡Œçœç•¥äº†æ•°æ®é¡µç­‰ä¿¡æ¯)</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220706135701187.png" class=""><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220706135723203.png" class=""><h3 id="10-4-å¼€å¯å’Œå…³é—­ICPæ€§èƒ½å¯¹æ¯”"><a href="#10-4-å¼€å¯å’Œå…³é—­ICPæ€§èƒ½å¯¹æ¯”" class="headerlink" title="10.4 å¼€å¯å’Œå…³é—­ICPæ€§èƒ½å¯¹æ¯”"></a>10.4 å¼€å¯å’Œå…³é—­ICPæ€§èƒ½å¯¹æ¯”</h3><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220706135904713.png" class=""><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220706140213382.png" class=""><h3 id="10-5-ICPçš„ä½¿ç”¨æ¡ä»¶"><a href="#10-5-ICPçš„ä½¿ç”¨æ¡ä»¶" class="headerlink" title="10.5 ICPçš„ä½¿ç”¨æ¡ä»¶"></a>10.5 ICPçš„ä½¿ç”¨æ¡ä»¶</h3><ol><li>å¦‚æœè¡¨çš„è®¿é—®ç±»å‹ä¸º range ã€ ref ã€ eq_ref æˆ–è€… ref_or_null å¯ä»¥ä½¿ç”¨ICPã€‚</li><li>ICPå¯ä»¥ä½¿ç”¨<code>InnDB</code>å’Œ<code>MyISAM</code>è¡¨ï¼ŒåŒ…æ‹¬åˆ†åŒºè¡¨<code>InnoDB</code>å’Œ<code>MyISAM</code>è¡¨</li><li>å¯¹äº<code>InnoDB</code>è¡¨ï¼ŒICPä»…ç”¨äº<code>äºŒçº§ç´¢å¼•</code>ã€‚ICPçš„ç›®æ ‡æ˜¯å‡å°‘å…¨è¡Œè¯»å–æ¬¡æ•°ï¼Œä»è€Œå‡å°‘I&#x2F;Oæ“ä½œã€‚</li><li>å½“SQLä½¿ç”¨è¦†ç›–ç´¢å¼•æ—¶ï¼Œä¸æ”¯æŒICPä¼˜åŒ–æ–¹æ³•ã€‚å› ä¸ºè¿™ç§æƒ…å†µä¸‹ä½¿ç”¨ICPä¸ä¼šå‡å°‘I&#x2F;Oã€‚</li><li>ç›¸å…³å­æŸ¥è¯¢çš„æ¡ä»¶ä¸èƒ½ä½¿ç”¨ICP</li></ol><h2 id="11-æ™®é€šç´¢å¼•-vs-å”¯ä¸€ç´¢å¼•"><a href="#11-æ™®é€šç´¢å¼•-vs-å”¯ä¸€ç´¢å¼•" class="headerlink" title="11. æ™®é€šç´¢å¼• vs å”¯ä¸€ç´¢å¼•"></a>11. æ™®é€šç´¢å¼• vs å”¯ä¸€ç´¢å¼•</h2><p>ä»æ€§èƒ½çš„è§’åº¦è€ƒè™‘ï¼Œä½ é€‰æ‹©å”¯ä¸€ç´¢å¼•è¿˜æ˜¯æ™®é€šç´¢å¼•å‘¢ï¼Ÿé€‰æ‹©çš„ä¾æ®æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</p><p>å‡è®¾ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªä¸»é”®åˆ—ä¸ºIDçš„è¡¨ï¼Œè¡¨ä¸­æœ‰å­—æ®µkï¼Œå¹¶ä¸”åœ¨kä¸Šæœ‰ç´¢å¼•ï¼Œå‡è®¾å­—æ®µ k ä¸Šçš„å€¼éƒ½ä¸é‡å¤ã€‚</p><p>è¿™ä¸ªè¡¨çš„å»ºè¡¨è¯­å¥æ˜¯ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; create table test(</span><br><span class="line">id int primary key,</span><br><span class="line">k int not null,</span><br><span class="line">name varchar(16),</span><br><span class="line">index (k)</span><br><span class="line">)engine=InnoDB;</span><br></pre></td></tr></table></figure><p>è¡¨ä¸­R1~R5çš„(ID,k)å€¼åˆ†åˆ«ä¸º(100,1)ã€(200,2)ã€(300,3)ã€(500,5)å’Œ(600,6)ã€‚</p><h3 id="11-1-æŸ¥è¯¢è¿‡ç¨‹"><a href="#11-1-æŸ¥è¯¢è¿‡ç¨‹" class="headerlink" title="11.1 æŸ¥è¯¢è¿‡ç¨‹"></a>11.1 æŸ¥è¯¢è¿‡ç¨‹</h3><p>å‡è®¾ï¼Œæ‰§è¡ŒæŸ¥è¯¢çš„è¯­å¥æ˜¯ select id from test where k&#x3D;5ã€‚</p><ul><li>å¯¹äºæ™®é€šç´¢å¼•æ¥è¯´ï¼ŒæŸ¥æ‰¾åˆ°æ»¡è¶³æ¡ä»¶çš„ç¬¬ä¸€ä¸ªè®°å½•(5,500)åï¼Œéœ€è¦æŸ¥æ‰¾ä¸‹ä¸€ä¸ªè®°å½•ï¼Œç›´åˆ°ç¢°åˆ°ç¬¬ä¸€ ä¸ªä¸æ»¡è¶³k&#x3D;5æ¡ä»¶çš„è®°å½•ã€‚ </li><li>å¯¹äºå”¯ä¸€ç´¢å¼•æ¥è¯´ï¼Œç”±äºç´¢å¼•å®šä¹‰äº†å”¯ä¸€æ€§ï¼ŒæŸ¥æ‰¾åˆ°ç¬¬ä¸€ä¸ªæ»¡è¶³æ¡ä»¶çš„è®°å½•åï¼Œå°±ä¼šåœæ­¢ç»§ç»­æ£€ ç´¢ã€‚</li></ul><p>é‚£ä¹ˆï¼Œè¿™ä¸ªä¸åŒå¸¦æ¥çš„æ€§èƒ½å·®è·ä¼šæœ‰å¤šå°‘å‘¢ï¼Ÿç­”æ¡ˆæ˜¯ï¼Œ å¾®ä¹å…¶å¾® ã€‚</p><h3 id="11-2-æ›´æ–°è¿‡ç¨‹"><a href="#11-2-æ›´æ–°è¿‡ç¨‹" class="headerlink" title="11.2 æ›´æ–°è¿‡ç¨‹"></a>11.2 æ›´æ–°è¿‡ç¨‹</h3><p>ä¸ºäº†è¯´æ˜æ™®é€šç´¢å¼•å’Œå”¯ä¸€ç´¢å¼•å¯¹æ›´æ–°è¯­å¥æ€§èƒ½çš„å½±å“è¿™ä¸ªé—®é¢˜ï¼Œä»‹ç»ä¸€ä¸‹change bufferã€‚</p><p>å½“éœ€è¦æ›´æ–°ä¸€ä¸ªæ•°æ®é¡µæ—¶ï¼Œå¦‚æœæ•°æ®é¡µåœ¨å†…å­˜ä¸­å°±ç›´æ¥æ›´æ–°ï¼Œè€Œå¦‚æœè¿™ä¸ªæ•°æ®é¡µè¿˜æ²¡æœ‰åœ¨å†…å­˜ä¸­çš„è¯ï¼Œ åœ¨ä¸å½±å“æ•°æ®ä¸€è‡´æ€§çš„å‰æä¸‹ï¼Œ <code>InooDBä¼šå°†è¿™äº›æ›´æ–°æ“ä½œç¼“å­˜åœ¨change bufferä¸­</code> ï¼Œè¿™æ ·å°±ä¸éœ€è¦ä»ç£ç›˜ä¸­è¯»å…¥è¿™ä¸ªæ•°æ®é¡µäº†ã€‚åœ¨ä¸‹æ¬¡æŸ¥è¯¢éœ€è¦è®¿é—®è¿™ä¸ªæ•°æ®é¡µçš„æ—¶å€™ï¼Œå°†æ•°æ®é¡µè¯»å…¥å†…å­˜ï¼Œç„¶åæ‰§è¡Œchange bufferä¸­ä¸è¿™ä¸ªé¡µæœ‰å…³çš„æ“ä½œã€‚é€šè¿‡è¿™ç§æ–¹å¼å°±èƒ½ä¿è¯è¿™ä¸ªæ•°æ®é€»è¾‘çš„æ­£ç¡®æ€§ã€‚</p><p>å°†change bufferä¸­çš„æ“ä½œåº”ç”¨åˆ°åŸæ•°æ®é¡µï¼Œå¾—åˆ°æœ€æ–°ç»“æœçš„è¿‡ç¨‹ç§°ä¸º merge ã€‚é™¤äº† <code>è®¿é—®è¿™ä¸ªæ•°æ®é¡µ</code> ä¼šè§¦ å‘mergeå¤–ï¼Œç³»ç»Ÿæœ‰ <code>åå°çº¿ç¨‹ä¼šå®šæœŸ</code> mergeã€‚åœ¨ <code>æ•°æ®åº“æ­£å¸¸å…³é—­ï¼ˆshutdownï¼‰</code> çš„è¿‡ç¨‹ä¸­ï¼Œä¹Ÿä¼šæ‰§è¡Œmerge æ“ä½œã€‚</p><p>å¦‚æœèƒ½å¤Ÿå°†æ›´æ–°æ“ä½œå…ˆè®°å½•åœ¨change bufferï¼Œ <code>å‡å°‘è¯»ç£ç›˜</code> ï¼Œè¯­å¥çš„æ‰§è¡Œé€Ÿåº¦ä¼šå¾—åˆ°æ˜æ˜¾çš„æå‡ã€‚è€Œä¸”ï¼Œ æ•°æ®è¯»å…¥å†…å­˜æ˜¯éœ€è¦å ç”¨ buffer pool çš„ï¼Œæ‰€ä»¥è¿™ç§æ–¹å¼è¿˜èƒ½å¤Ÿ <code>é¿å…å ç”¨å†…å­˜ </code>ï¼Œæé«˜å†…å­˜åˆ©ç”¨ç‡ã€‚</p><p><code>å”¯ä¸€ç´¢å¼•çš„æ›´æ–°å°±ä¸èƒ½ä½¿ç”¨change buffer</code> ï¼Œå®é™…ä¸Šä¹Ÿåªæœ‰æ™®é€šç´¢å¼•å¯ä»¥ä½¿ç”¨ã€‚</p><p>å¦‚æœè¦åœ¨è¿™å¼ è¡¨ä¸­æ’å…¥ä¸€ä¸ªæ–°è®°å½•(4,400)çš„è¯ï¼ŒInnoDBçš„å¤„ç†æµç¨‹æ˜¯æ€æ ·çš„ï¼Ÿ</p><h3 id="11-3-change-bufferçš„ä½¿ç”¨åœºæ™¯"><a href="#11-3-change-bufferçš„ä½¿ç”¨åœºæ™¯" class="headerlink" title="11.3 change bufferçš„ä½¿ç”¨åœºæ™¯"></a>11.3 change bufferçš„ä½¿ç”¨åœºæ™¯</h3><ol><li>æ™®é€šç´¢å¼•å’Œå”¯ä¸€ç´¢å¼•åº”è¯¥æ€ä¹ˆé€‰æ‹©ï¼Ÿå…¶å®ï¼Œè¿™ä¸¤ç±»ç´¢å¼•åœ¨æŸ¥è¯¢èƒ½åŠ›ä¸Šæ˜¯æ²¡å·®åˆ«çš„ï¼Œä¸»è¦è€ƒè™‘çš„æ˜¯ å¯¹ æ›´æ–°æ€§èƒ½ çš„å½±å“ã€‚æ‰€ä»¥ï¼Œå»ºè®®ä½  å°½é‡é€‰æ‹©æ™®é€šç´¢å¼• ã€‚ </li><li>åœ¨å®é™…ä½¿ç”¨ä¸­ä¼šå‘ç°ï¼Œ æ™®é€šç´¢å¼• å’Œ change buffer çš„é…åˆä½¿ç”¨ï¼Œå¯¹äº æ•°æ®é‡å¤§ çš„è¡¨çš„æ›´æ–°ä¼˜åŒ– è¿˜æ˜¯å¾ˆæ˜æ˜¾çš„ã€‚ </li><li>å¦‚æœæ‰€æœ‰çš„æ›´æ–°åé¢ï¼Œéƒ½é©¬ä¸Š ä¼´éšç€å¯¹è¿™ä¸ªè®°å½•çš„æŸ¥è¯¢ ï¼Œé‚£ä¹ˆä½ åº”è¯¥ å…³é—­change buffer ã€‚è€Œåœ¨ å…¶ä»–æƒ…å†µä¸‹ï¼Œchange bufferéƒ½èƒ½æå‡æ›´æ–°æ€§èƒ½ã€‚ </li><li>ç”±äºå”¯ä¸€ç´¢å¼•ç”¨ä¸ä¸Šchange bufferçš„ä¼˜åŒ–æœºåˆ¶ï¼Œå› æ­¤å¦‚æœ ä¸šåŠ¡å¯ä»¥æ¥å— ï¼Œä»æ€§èƒ½è§’åº¦å‡ºå‘å»ºè®®ä¼˜ å…ˆè€ƒè™‘éå”¯ä¸€ç´¢å¼•ã€‚ä½†æ˜¯å¦‚æœâ€ä¸šåŠ¡å¯èƒ½æ— æ³•ç¡®ä¿â€çš„æƒ…å†µä¸‹ï¼Œæ€ä¹ˆå¤„ç†å‘¢ï¼Ÿ <ul><li>é¦–å…ˆï¼Œ ä¸šåŠ¡æ­£ç¡®æ€§ä¼˜å…ˆ ã€‚æˆ‘ä»¬çš„å‰ææ˜¯â€œä¸šåŠ¡ä»£ç å·²ç»ä¿è¯ä¸ä¼šå†™å…¥é‡å¤æ•°æ®â€çš„æƒ…å†µä¸‹ï¼Œè®¨è®ºæ€§èƒ½ é—®é¢˜ã€‚å¦‚æœä¸šåŠ¡ä¸èƒ½ä¿è¯ï¼Œæˆ–è€…ä¸šåŠ¡å°±æ˜¯è¦æ±‚æ•°æ®åº“æ¥åšçº¦æŸï¼Œé‚£ä¹ˆæ²¡å¾—é€‰ï¼Œå¿…é¡»åˆ›å»ºå”¯ä¸€ç´¢å¼•ã€‚ è¿™ç§æƒ…å†µä¸‹ï¼Œæœ¬èŠ‚çš„æ„ä¹‰åœ¨äºï¼Œå¦‚æœç¢°ä¸Šäº†å¤§é‡æ’å…¥æ•°æ®æ…¢ã€å†…å­˜å‘½ä¸­ç‡ä½çš„æ—¶å€™ï¼Œç»™ä½ å¤šæä¾›ä¸€ ä¸ªæ’æŸ¥æ€è·¯ã€‚ </li><li>ç„¶åï¼Œåœ¨ä¸€äº›â€œ å½’æ¡£åº“ â€çš„åœºæ™¯ï¼Œä½ æ˜¯å¯ä»¥è€ƒè™‘ä½¿ç”¨å”¯ä¸€ç´¢å¼•çš„ã€‚æ¯”å¦‚ï¼Œçº¿ä¸Šæ•°æ®åªéœ€è¦ä¿ç•™åŠå¹´ï¼Œ ç„¶åå†å²æ•°æ®ä¿å­˜åœ¨å½’æ¡£åº“ã€‚è¿™æ—¶å€™ï¼Œå½’æ¡£æ•°æ®å·²ç»æ˜¯ç¡®ä¿æ²¡æœ‰å”¯ä¸€é”®å†²çªäº†ã€‚è¦æé«˜å½’æ¡£æ•ˆç‡ï¼Œ å¯ä»¥è€ƒè™‘æŠŠè¡¨é‡Œé¢çš„å”¯ä¸€ç´¢å¼•æ”¹æˆæ™®é€šç´¢å¼•ã€‚</li></ul></li></ol><h2 id="12-å…¶å®ƒæŸ¥è¯¢ä¼˜åŒ–ç­–ç•¥"><a href="#12-å…¶å®ƒæŸ¥è¯¢ä¼˜åŒ–ç­–ç•¥" class="headerlink" title="12. å…¶å®ƒæŸ¥è¯¢ä¼˜åŒ–ç­–ç•¥"></a>12. å…¶å®ƒæŸ¥è¯¢ä¼˜åŒ–ç­–ç•¥</h2><h3 id="12-1-EXISTS-å’Œ-IN-çš„åŒºåˆ†"><a href="#12-1-EXISTS-å’Œ-IN-çš„åŒºåˆ†" class="headerlink" title="12.1 EXISTS å’Œ IN çš„åŒºåˆ†"></a>12.1 EXISTS å’Œ IN çš„åŒºåˆ†</h3><p><strong>é—®é¢˜ï¼š</strong></p><p>ä¸å¤ªç†è§£å“ªç§æƒ…å†µä¸‹åº”è¯¥ä½¿ç”¨ EXISTSï¼Œå“ªç§æƒ…å†µåº”è¯¥ç”¨ INã€‚é€‰æ‹©çš„æ ‡å‡†æ˜¯çœ‹èƒ½å¦ä½¿ç”¨è¡¨çš„ç´¢å¼•å—ï¼Ÿ</p><p><strong>å›ç­”ï¼š</strong></p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220706141957185.png" class=""><h3 id="12-2-COUNT-ä¸COUNT-å…·ä½“å­—æ®µ-æ•ˆç‡"><a href="#12-2-COUNT-ä¸COUNT-å…·ä½“å­—æ®µ-æ•ˆç‡" class="headerlink" title="12.2 COUNT(*)ä¸COUNT(å…·ä½“å­—æ®µ)æ•ˆç‡"></a>12.2 COUNT(*)ä¸COUNT(å…·ä½“å­—æ®µ)æ•ˆç‡</h3><p>é—®ï¼šåœ¨ MySQL ä¸­ç»Ÿè®¡æ•°æ®è¡¨çš„è¡Œæ•°ï¼Œå¯ä»¥ä½¿ç”¨ä¸‰ç§æ–¹å¼ï¼š SELECT COUNT(*) ã€ SELECT COUNT(1) å’Œ SELECT COUNT(å…·ä½“å­—æ®µ) ï¼Œä½¿ç”¨è¿™ä¸‰è€…ä¹‹é—´çš„æŸ¥è¯¢æ•ˆç‡æ˜¯æ€æ ·çš„ï¼Ÿ</p><p>ç­”ï¼š</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220706142648452.png" class=""><h3 id="12-3-å…³äºSELECT"><a href="#12-3-å…³äºSELECT" class="headerlink" title="12.3 å…³äºSELECT(*)"></a>12.3 å…³äºSELECT(*)</h3><p>åœ¨è¡¨æŸ¥è¯¢ä¸­ï¼Œå»ºè®®æ˜ç¡®å­—æ®µï¼Œä¸è¦ä½¿ç”¨ * ä½œä¸ºæŸ¥è¯¢çš„å­—æ®µåˆ—è¡¨ï¼Œæ¨èä½¿ç”¨SELECT &lt;å­—æ®µåˆ—è¡¨&gt; æŸ¥è¯¢ã€‚åŸå› ï¼š </p><p>â‘  MySQL åœ¨è§£æçš„è¿‡ç¨‹ä¸­ï¼Œä¼šé€šè¿‡æŸ¥è¯¢æ•°æ®å­—å…¸ å°†â€*â€æŒ‰åºè½¬æ¢æˆæ‰€æœ‰åˆ—åï¼Œè¿™ä¼šå¤§å¤§çš„è€—è´¹èµ„æºå’Œæ—¶é—´ã€‚ </p><p>â‘¡ æ— æ³•ä½¿ç”¨ è¦†ç›–ç´¢å¼•</p><h3 id="12-4-LIMIT-1-å¯¹ä¼˜åŒ–çš„å½±å“"><a href="#12-4-LIMIT-1-å¯¹ä¼˜åŒ–çš„å½±å“" class="headerlink" title="12.4 LIMIT 1 å¯¹ä¼˜åŒ–çš„å½±å“"></a>12.4 LIMIT 1 å¯¹ä¼˜åŒ–çš„å½±å“</h3><p>é’ˆå¯¹çš„æ˜¯ä¼šæ‰«æå…¨è¡¨çš„ SQL è¯­å¥ï¼Œå¦‚æœä½ å¯ä»¥ç¡®å®šç»“æœé›†åªæœ‰ä¸€æ¡ï¼Œé‚£ä¹ˆåŠ ä¸Š LIMIT 1 çš„æ—¶å€™ï¼Œå½“æ‰¾åˆ°ä¸€æ¡ç»“æœçš„æ—¶å€™å°±ä¸ä¼šç»§ç»­æ‰«æäº†ï¼Œè¿™æ ·ä¼šåŠ å¿«æŸ¥è¯¢é€Ÿåº¦ã€‚</p><p> å¦‚æœæ•°æ®è¡¨å·²ç»å¯¹å­—æ®µå»ºç«‹äº†å”¯ä¸€ç´¢å¼•ï¼Œé‚£ä¹ˆå¯ä»¥é€šè¿‡ç´¢å¼•è¿›è¡ŒæŸ¥è¯¢ï¼Œä¸ä¼šå…¨è¡¨æ‰«æçš„è¯ï¼Œå°±ä¸éœ€è¦åŠ ä¸Š LIMIT 1 äº†ã€‚</p><h3 id="12-5-å¤šä½¿ç”¨COMMIT"><a href="#12-5-å¤šä½¿ç”¨COMMIT" class="headerlink" title="12.5 å¤šä½¿ç”¨COMMIT"></a>12.5 å¤šä½¿ç”¨COMMIT</h3><p>åªè¦æœ‰å¯èƒ½ï¼Œåœ¨ç¨‹åºä¸­å°½é‡å¤šä½¿ç”¨ COMMITï¼Œè¿™æ ·ç¨‹åºçš„æ€§èƒ½å¾—åˆ°æé«˜ï¼Œéœ€æ±‚ä¹Ÿä¼šå› ä¸º COMMIT æ‰€é‡Šæ”¾ çš„èµ„æºè€Œå‡å°‘ã€‚</p><p>COMMIT æ‰€é‡Šæ”¾çš„èµ„æºï¼š </p><ul><li>å›æ»šæ®µä¸Šç”¨äºæ¢å¤æ•°æ®çš„ä¿¡æ¯ </li><li>è¢«ç¨‹åºè¯­å¥è·å¾—çš„é” </li><li>redo &#x2F; undo log buffer ä¸­çš„ç©ºé—´ </li><li>ç®¡ç†ä¸Šè¿° 3 ç§èµ„æºä¸­çš„å†…éƒ¨èŠ±è´¹</li></ul><h2 id="13-æ·˜å®æ•°æ®åº“ï¼Œä¸»é”®å¦‚ä½•è®¾è®¡çš„ï¼Ÿ"><a href="#13-æ·˜å®æ•°æ®åº“ï¼Œä¸»é”®å¦‚ä½•è®¾è®¡çš„ï¼Ÿ" class="headerlink" title="13. æ·˜å®æ•°æ®åº“ï¼Œä¸»é”®å¦‚ä½•è®¾è®¡çš„ï¼Ÿ"></a>13. æ·˜å®æ•°æ®åº“ï¼Œä¸»é”®å¦‚ä½•è®¾è®¡çš„ï¼Ÿ</h2><p>èŠä¸€ä¸ªå®é™…é—®é¢˜ï¼šæ·˜å®çš„æ•°æ®åº“ï¼Œä¸»é”®æ˜¯å¦‚ä½•è®¾è®¡çš„ï¼Ÿ</p><p>æŸäº›é”™çš„ç¦»è°±çš„ç­”æ¡ˆè¿˜åœ¨ç½‘ä¸Šå¹´å¤ä¸€å¹´çš„æµä¼ ç€ï¼Œç”šè‡³è¿˜æˆä¸ºäº†æ‰€è°“çš„MySQLå†›è§„ã€‚å…¶ä¸­ï¼Œä¸€ä¸ªæœ€æ˜æ˜¾çš„é”™è¯¯å°±æ˜¯å…³äºMySQLçš„ä¸»é”®è®¾è®¡ã€‚</p><p>å¤§éƒ¨åˆ†äººçš„å›ç­”å¦‚æ­¤è‡ªä¿¡ï¼šç”¨8å­—èŠ‚çš„ BIGINT åšä¸»é”®ï¼Œè€Œä¸è¦ç”¨INTã€‚ <code>é”™ </code>ï¼</p><p>è¿™æ ·çš„å›ç­”ï¼Œåªç«™åœ¨äº†æ•°æ®åº“è¿™ä¸€å±‚ï¼Œè€Œæ²¡æœ‰ <code>ä»ä¸šåŠ¡çš„è§’åº¦</code> æ€è€ƒä¸»é”®ã€‚ä¸»é”®å°±æ˜¯ä¸€ä¸ªè‡ªå¢IDå—ï¼Ÿç«™åœ¨ 2022å¹´çš„æ–°å¹´æ¡£å£ï¼Œç”¨è‡ªå¢åšä¸»é”®ï¼Œæ¶æ„è®¾è®¡ä¸Šå¯èƒ½ <code>è¿åŠæ ¼éƒ½æ‹¿ä¸åˆ°</code> ã€‚</p><h3 id="13-1-è‡ªå¢IDçš„é—®é¢˜"><a href="#13-1-è‡ªå¢IDçš„é—®é¢˜" class="headerlink" title="13.1 è‡ªå¢IDçš„é—®é¢˜"></a>13.1 è‡ªå¢IDçš„é—®é¢˜</h3><p>è‡ªå¢IDåšä¸»é”®ï¼Œç®€å•æ˜“æ‡‚ï¼Œå‡ ä¹æ‰€æœ‰æ•°æ®åº“éƒ½æ”¯æŒè‡ªå¢ç±»å‹ï¼Œåªæ˜¯å®ç°ä¸Šå„è‡ªæœ‰æ‰€ä¸åŒè€Œå·²ã€‚è‡ªå¢IDé™¤ äº†ç®€å•ï¼Œå…¶ä»–éƒ½æ˜¯ç¼ºç‚¹ï¼Œæ€»ä½“æ¥çœ‹å­˜åœ¨ä»¥ä¸‹å‡ æ–¹é¢çš„é—®é¢˜ï¼š</p><ol><li><p><strong>å¯é æ€§ä¸é«˜</strong></p><p>å­˜åœ¨è‡ªå¢IDå›æº¯çš„é—®é¢˜ï¼Œè¿™ä¸ªé—®é¢˜ç›´åˆ°æœ€æ–°ç‰ˆæœ¬çš„MySQL 8.0æ‰ä¿®å¤ã€‚ </p></li><li><p>**å®‰å…¨æ€§ä¸é«˜ **</p><p>å¯¹å¤–æš´éœ²çš„æ¥å£å¯ä»¥éå¸¸å®¹æ˜“çŒœæµ‹å¯¹åº”çš„ä¿¡æ¯ã€‚æ¯”å¦‚ï¼š&#x2F;User&#x2F;1&#x2F;è¿™æ ·çš„æ¥å£ï¼Œå¯ä»¥éå¸¸å®¹æ˜“çŒœæµ‹ç”¨æˆ·IDçš„ å€¼ä¸ºå¤šå°‘ï¼Œæ€»ç”¨æˆ·æ•°é‡æœ‰å¤šå°‘ï¼Œä¹Ÿå¯ä»¥éå¸¸å®¹æ˜“åœ°é€šè¿‡æ¥å£è¿›è¡Œæ•°æ®çš„çˆ¬å–ã€‚ </p></li><li><p><strong>æ€§èƒ½å·®</strong> </p><p>è‡ªå¢IDçš„æ€§èƒ½è¾ƒå·®ï¼Œéœ€è¦åœ¨æ•°æ®åº“æœåŠ¡å™¨ç«¯ç”Ÿæˆã€‚ </p></li><li><p><strong>äº¤äº’å¤š</strong> </p><p>ä¸šåŠ¡è¿˜éœ€è¦é¢å¤–æ‰§è¡Œä¸€æ¬¡ç±»ä¼¼ last_insert_id() çš„å‡½æ•°æ‰èƒ½çŸ¥é“åˆšæ‰æ’å…¥çš„è‡ªå¢å€¼ï¼Œè¿™éœ€è¦å¤šä¸€æ¬¡çš„ ç½‘ç»œäº¤äº’ã€‚åœ¨æµ·é‡å¹¶å‘çš„ç³»ç»Ÿä¸­ï¼Œå¤š1æ¡SQLï¼Œå°±å¤šä¸€æ¬¡æ€§èƒ½ä¸Šçš„å¼€é”€ã€‚ </p></li><li><p>**å±€éƒ¨å”¯ä¸€æ€§ **</p><p>æœ€é‡è¦çš„ä¸€ç‚¹ï¼Œè‡ªå¢IDæ˜¯å±€éƒ¨å”¯ä¸€ï¼Œåªåœ¨å½“å‰æ•°æ®åº“å®ä¾‹ä¸­å”¯ä¸€ï¼Œè€Œä¸æ˜¯å…¨å±€å”¯ä¸€ï¼Œåœ¨ä»»æ„æœåŠ¡å™¨é—´éƒ½ æ˜¯å”¯ä¸€çš„ã€‚å¯¹äºç›®å‰åˆ†å¸ƒå¼ç³»ç»Ÿæ¥è¯´ï¼Œè¿™ç®€ç›´å°±æ˜¯å™©æ¢¦ã€‚</p></li></ol><h3 id="13-2-ä¸šåŠ¡å­—æ®µåšä¸»é”®"><a href="#13-2-ä¸šåŠ¡å­—æ®µåšä¸»é”®" class="headerlink" title="13.2 ä¸šåŠ¡å­—æ®µåšä¸»é”®"></a>13.2 ä¸šåŠ¡å­—æ®µåšä¸»é”®</h3><p>ä¸ºäº†èƒ½å¤Ÿå”¯ä¸€åœ°æ ‡è¯†ä¸€ä¸ªä¼šå‘˜çš„ä¿¡æ¯ï¼Œéœ€è¦ä¸º ä¼šå‘˜ä¿¡æ¯è¡¨ è®¾ç½®ä¸€ä¸ªä¸»é”®ã€‚é‚£ä¹ˆï¼Œæ€ä¹ˆä¸ºè¿™ä¸ªè¡¨è®¾ç½®ä¸» é”®ï¼Œæ‰èƒ½è¾¾åˆ°æˆ‘ä»¬ç†æƒ³çš„ç›®æ ‡å‘¢ï¼Ÿ è¿™é‡Œæˆ‘ä»¬è€ƒè™‘ä¸šåŠ¡å­—æ®µåšä¸»é”®ã€‚</p><p>è¡¨æ•°æ®å¦‚ä¸‹ï¼š</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220706151506580.png" class=""><p>åœ¨è¿™ä¸ªè¡¨é‡Œï¼Œå“ªä¸ªå­—æ®µæ¯”è¾ƒåˆé€‚å‘¢ï¼Ÿ</p><ul><li><strong>é€‰æ‹©å¡å·ï¼ˆcardnoï¼‰</strong></li></ul><p>ä¼šå‘˜å¡å·ï¼ˆcardnoï¼‰çœ‹èµ·æ¥æ¯”è¾ƒåˆé€‚ï¼Œå› ä¸ºä¼šå‘˜å¡å·ä¸èƒ½ä¸ºç©ºï¼Œè€Œä¸”æœ‰å”¯ä¸€æ€§ï¼Œå¯ä»¥ç”¨æ¥ æ ‡è¯†ä¸€æ¡ä¼šå‘˜ è®°å½•ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; CREATE TABLE demo.membermaster</span><br><span class="line">-&gt; (</span><br><span class="line">-&gt; cardno CHAR(8) PRIMARY KEY, -- ä¼šå‘˜å¡å·ä¸ºä¸»é”®</span><br><span class="line">-&gt; membername TEXT,</span><br><span class="line">-&gt; memberphone TEXT,</span><br><span class="line">-&gt; memberpid TEXT,</span><br><span class="line">-&gt; memberaddress TEXT,</span><br><span class="line">-&gt; sex TEXT,</span><br><span class="line">-&gt; birthday DATETIME</span><br><span class="line">-&gt; );</span><br><span class="line">Query OK, 0 rows affected (0.06 sec)</span><br></pre></td></tr></table></figure><p>ä¸åŒçš„ä¼šå‘˜å¡å·å¯¹åº”ä¸åŒçš„ä¼šå‘˜ï¼Œå­—æ®µâ€œcardnoâ€å”¯ä¸€åœ°æ ‡è¯†æŸä¸€ä¸ªä¼šå‘˜ã€‚å¦‚æœéƒ½æ˜¯è¿™æ ·ï¼Œä¼šå‘˜å¡å·ä¸ä¼š å‘˜ä¸€ä¸€å¯¹åº”ï¼Œç³»ç»Ÿæ˜¯å¯ä»¥æ­£å¸¸è¿è¡Œçš„ã€‚</p><p>ä½†å®é™…æƒ…å†µæ˜¯ï¼Œ ä¼šå‘˜å¡å·å¯èƒ½å­˜åœ¨é‡å¤ä½¿ç”¨ çš„æƒ…å†µã€‚æ¯”å¦‚ï¼Œå¼ ä¸‰å› ä¸ºå·¥ä½œå˜åŠ¨æ¬ç¦»äº†åŸæ¥çš„åœ°å€ï¼Œä¸å† åˆ°å•†å®¶çš„é—¨åº—æ¶ˆè´¹äº† ï¼ˆé€€è¿˜äº†ä¼šå‘˜å¡ï¼‰ï¼Œäºæ˜¯å¼ ä¸‰å°±ä¸å†æ˜¯è¿™ä¸ªå•†å®¶é—¨åº—çš„ä¼šå‘˜äº†ã€‚ä½†æ˜¯ï¼Œå•†å®¶ä¸æƒ³è®© è¿™ä¸ªä¼š å‘˜å¡ç©ºç€ï¼Œå°±æŠŠå¡å·æ˜¯â€œ10000001â€çš„ä¼šå‘˜å¡å‘ç»™äº†ç‹äº”ã€‚</p><p>ä»ç³»ç»Ÿè®¾è®¡çš„è§’åº¦çœ‹ï¼Œè¿™ä¸ªå˜åŒ–åªæ˜¯ä¿®æ”¹äº†ä¼šå‘˜ä¿¡æ¯è¡¨ä¸­çš„å¡å·æ˜¯â€œ10000001â€è¿™ä¸ªä¼šå‘˜ ä¿¡æ¯ï¼Œå¹¶ä¸ä¼šå½± å“åˆ°æ•°æ®ä¸€è‡´æ€§ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¿®æ”¹ä¼šå‘˜å¡å·æ˜¯â€œ10000001â€çš„ä¼šå‘˜ä¿¡æ¯ï¼Œ ç³»ç»Ÿçš„å„ä¸ªæ¨¡å—ï¼Œéƒ½ä¼šè·å–åˆ°ä¿® æ”¹åçš„ä¼šå‘˜ä¿¡æ¯ï¼Œä¸ä¼šå‡ºç°â€œæœ‰çš„æ¨¡å—è·å–åˆ°ä¿®æ”¹ä¹‹å‰çš„ä¼šå‘˜ä¿¡æ¯ï¼Œæœ‰çš„æ¨¡å—è·å–åˆ°ä¿®æ”¹åçš„ä¼šå‘˜ä¿¡æ¯ï¼Œ è€Œå¯¼è‡´ç³»ç»Ÿå†…éƒ¨æ•°æ®ä¸ä¸€è‡´â€çš„æƒ…å†µã€‚å› æ­¤ï¼Œä» ä¿¡æ¯ç³»ç»Ÿå±‚é¢ ä¸Šçœ‹æ˜¯æ²¡é—®é¢˜çš„ã€‚</p><p>ä½†æ˜¯ä»ä½¿ç”¨ ç³»ç»Ÿçš„ä¸šåŠ¡å±‚é¢ æ¥çœ‹ï¼Œå°±æœ‰å¾ˆå¤§çš„é—®é¢˜ äº†ï¼Œä¼šå¯¹å•†å®¶é€ æˆå½±å“ã€‚</p><p>æ¯”å¦‚ï¼Œæˆ‘ä»¬æœ‰ä¸€ä¸ªé”€å”®æµæ°´è¡¨ï¼ˆtransï¼‰ï¼Œè®°å½•äº†æ‰€æœ‰çš„é”€å”®æµæ°´æ˜ç»†ã€‚2020 å¹´ 12 æœˆ 01 æ—¥ï¼Œå¼ ä¸‰åœ¨é—¨åº— è´­ä¹°äº†ä¸€æœ¬ä¹¦ï¼Œæ¶ˆè´¹äº† 89 å…ƒã€‚é‚£ä¹ˆï¼Œç³»ç»Ÿä¸­å°±æœ‰äº†å¼ ä¸‰ä¹°ä¹¦çš„æµæ°´è®°å½•ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220706151715106.png" class=""><p>æ¥ç€ï¼Œæˆ‘ä»¬æŸ¥è¯¢ä¸€ä¸‹ 2020 å¹´ 12 æœˆ 01 æ—¥çš„ä¼šå‘˜é”€å”®è®°å½•ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT b.membername,c.goodsname,a.quantity,a.salesvalue,a.transdate</span><br><span class="line">-&gt; FROM demo.trans AS a</span><br><span class="line">-&gt; JOIN demo.membermaster AS b</span><br><span class="line">-&gt; JOIN demo.goodsmaster AS c</span><br><span class="line">-&gt; ON (a.cardno = b.cardno AND a.itemnumber=c.itemnumber);</span><br><span class="line">+------------+-----------+----------+------------+---------------------+</span><br><span class="line">| membername | goodsname | quantity | salesvalue | transdate |</span><br><span class="line">+------------+-----------+----------+------------+---------------------+</span><br><span class="line">|     å¼ ä¸‰   | ä¹¦         | 1.000    | 89.00      | 2020-12-01 00:00:00 |</span><br><span class="line">+------------+-----------+----------+------------+---------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure><p>å¦‚æœä¼šå‘˜å¡â€œ10000001â€åˆå‘ç»™äº†ç‹äº”ï¼Œæˆ‘ä»¬ä¼šæ›´æ”¹ä¼šå‘˜ä¿¡æ¯è¡¨ã€‚å¯¼è‡´æŸ¥è¯¢æ—¶ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT b.membername,c.goodsname,a.quantity,a.salesvalue,a.transdate</span><br><span class="line">-&gt; FROM demo.trans AS a</span><br><span class="line">-&gt; JOIN demo.membermaster AS b</span><br><span class="line">-&gt; JOIN demo.goodsmaster AS c</span><br><span class="line">-&gt; ON (a.cardno = b.cardno AND a.itemnumber=c.itemnumber);</span><br><span class="line">+------------+-----------+----------+------------+---------------------+</span><br><span class="line">| membername | goodsname | quantity | salesvalue | transdate |</span><br><span class="line">+------------+-----------+----------+------------+---------------------+</span><br><span class="line">| ç‹äº”        | ä¹¦        | 1.000    | 89.00      | 2020-12-01 00:00:00 |</span><br><span class="line">+------------+-----------+----------+------------+---------------------+</span><br><span class="line">1 row in set (0.01 sec)</span><br></pre></td></tr></table></figure><p>è¿™æ¬¡å¾—åˆ°çš„ç»“æœæ˜¯ï¼šç‹äº”åœ¨ 2020 å¹´ 12 æœˆ 01 æ—¥ï¼Œä¹°äº†ä¸€æœ¬ä¹¦ï¼Œæ¶ˆè´¹ 89 å…ƒã€‚æ˜¾ç„¶æ˜¯é”™è¯¯çš„ï¼ç»“è®ºï¼šåƒä¸‡ ä¸èƒ½æŠŠä¼šå‘˜å¡å·å½“åšä¸»é”®ã€‚</p><ul><li><strong>é€‰æ‹©ä¼šå‘˜ç”µè¯ æˆ– èº«ä»½è¯å·</strong></li></ul><p>ä¼šå‘˜ç”µè¯å¯ä»¥åšä¸»é”®å—ï¼Ÿä¸è¡Œçš„ã€‚åœ¨å®é™…æ“ä½œä¸­ï¼Œæ‰‹æœºå·ä¹Ÿå­˜åœ¨ è¢«è¿è¥å•†æ”¶å› ï¼Œé‡æ–°å‘ç»™åˆ«äººç”¨çš„æƒ…å†µã€‚</p><p>é‚£èº«ä»½è¯å·è¡Œä¸è¡Œå‘¢ï¼Ÿå¥½åƒå¯ä»¥ã€‚å› ä¸ºèº«ä»½è¯å†³ä¸ä¼šé‡å¤ï¼Œèº«ä»½è¯å·ä¸ä¸€ä¸ªäººå­˜åœ¨ä¸€ä¸€å¯¹ åº”çš„å…³ç³»ã€‚å¯ é—®é¢˜æ˜¯ï¼Œèº«ä»½è¯å·å±äº ä¸ªäººéšç§ ï¼Œé¡¾å®¢ä¸ä¸€å®šæ„¿æ„ç»™ä½ ã€‚è¦æ˜¯å¼ºåˆ¶è¦æ±‚ä¼šå‘˜å¿…é¡»ç™»è®°èº«ä»½è¯å·ï¼Œä¼šæŠŠå¾ˆ å¤šå®¢äººèµ¶è·‘çš„ã€‚å…¶å®ï¼Œå®¢æˆ·ç”µè¯ä¹Ÿæœ‰è¿™ä¸ªé—®é¢˜ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬åœ¨è®¾è®¡ä¼šå‘˜ä¿¡æ¯è¡¨çš„æ—¶å€™ï¼Œå…è®¸èº«ä»½è¯å·å’Œ ç”µè¯éƒ½ä¸ºç©ºçš„åŸå› ã€‚</p><p><strong>æ‰€ä»¥ï¼Œå»ºè®®å°½é‡ä¸è¦ç”¨è·Ÿä¸šåŠ¡æœ‰å…³çš„å­—æ®µåšä¸»é”®ã€‚æ¯•ç«Ÿï¼Œä½œä¸ºé¡¹ç›®è®¾è®¡çš„æŠ€æœ¯äººå‘˜ï¼Œæˆ‘ä»¬è°ä¹Ÿæ— æ³•é¢„æµ‹ åœ¨é¡¹ç›®çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸä¸­ï¼Œå“ªä¸ªä¸šåŠ¡å­—æ®µä¼šå› ä¸ºé¡¹ç›®çš„ä¸šåŠ¡éœ€æ±‚è€Œæœ‰é‡å¤ï¼Œæˆ–è€…é‡ç”¨ä¹‹ç±»çš„æƒ…å†µå‡ºç°ã€‚</strong></p><blockquote><p>ç»éªŒï¼š åˆšå¼€å§‹ä½¿ç”¨ MySQL æ—¶ï¼Œå¾ˆå¤šäººéƒ½å¾ˆå®¹æ˜“çŠ¯çš„é”™è¯¯æ˜¯å–œæ¬¢ç”¨ä¸šåŠ¡å­—æ®µåšä¸»é”®ï¼Œæƒ³å½“ç„¶åœ°è®¤ä¸ºäº†è§£ä¸š åŠ¡éœ€æ±‚ï¼Œä½†å®é™…æƒ…å†µå¾€å¾€å‡ºä¹æ„æ–™ï¼Œè€Œæ›´æ”¹ä¸»é”®è®¾ç½®çš„æˆæœ¬éå¸¸é«˜ã€‚</p></blockquote><h3 id="13-3-æ·˜å®çš„ä¸»é”®è®¾è®¡"><a href="#13-3-æ·˜å®çš„ä¸»é”®è®¾è®¡" class="headerlink" title="13.3 æ·˜å®çš„ä¸»é”®è®¾è®¡"></a>13.3 æ·˜å®çš„ä¸»é”®è®¾è®¡</h3><p>åœ¨æ·˜å®çš„ç”µå•†ä¸šåŠ¡ä¸­ï¼Œè®¢å•æœåŠ¡æ˜¯ä¸€ä¸ªæ ¸å¿ƒä¸šåŠ¡ã€‚è¯·é—®ï¼Œ è®¢å•è¡¨çš„ä¸»é”® æ·˜å®æ˜¯å¦‚ä½•è®¾è®¡çš„å‘¢ï¼Ÿæ˜¯è‡ªå¢ID å—ï¼Ÿ</p><p>æ‰“å¼€æ·˜å®ï¼Œçœ‹ä¸€ä¸‹è®¢å•ä¿¡æ¯ï¼š</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220706161436920.png" class=""><p>ä»ä¸Šå›¾å¯ä»¥å‘ç°ï¼Œè®¢å•å·ä¸æ˜¯è‡ªå¢IDï¼æˆ‘ä»¬è¯¦ç»†çœ‹ä¸‹ä¸Šè¿°4ä¸ªè®¢å•å·ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1550672064762308113</span><br><span class="line">1481195847180308113</span><br><span class="line">1431156171142308113</span><br><span class="line">1431146631521308113</span><br></pre></td></tr></table></figure><p>è®¢å•å·æ˜¯19ä½çš„é•¿åº¦ï¼Œä¸”è®¢å•çš„æœ€å5ä½éƒ½æ˜¯ä¸€æ ·çš„ï¼Œéƒ½æ˜¯08113ã€‚ä¸”è®¢å•å·çš„å‰é¢14ä½éƒ¨åˆ†æ˜¯å•è°ƒé€’å¢çš„ã€‚</p><p>å¤§èƒ†çŒœæµ‹ï¼Œæ·˜å®çš„è®¢å•IDè®¾è®¡åº”è¯¥æ˜¯ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">è®¢å•ID = æ—¶é—´ + å»é‡å­—æ®µ + ç”¨æˆ·IDå6ä½å°¾å·</span><br></pre></td></tr></table></figure><p>è¿™æ ·çš„è®¾è®¡èƒ½åšåˆ°å…¨å±€å”¯ä¸€ï¼Œä¸”å¯¹åˆ†å¸ƒå¼ç³»ç»ŸæŸ¥è¯¢åŠå…¶å‹å¥½ã€‚</p><h3 id="13-4-æ¨èçš„ä¸»é”®è®¾è®¡"><a href="#13-4-æ¨èçš„ä¸»é”®è®¾è®¡" class="headerlink" title="13.4 æ¨èçš„ä¸»é”®è®¾è®¡"></a>13.4 æ¨èçš„ä¸»é”®è®¾è®¡</h3><p><strong>éæ ¸å¿ƒä¸šåŠ¡</strong> ï¼šå¯¹åº”è¡¨çš„ä¸»é”®è‡ªå¢IDï¼Œå¦‚å‘Šè­¦ã€æ—¥å¿—ã€ç›‘æ§ç­‰ä¿¡æ¯ã€‚</p><p><strong>æ ¸å¿ƒä¸šåŠ¡</strong> ï¼š<code>ä¸»é”®è®¾è®¡è‡³å°‘åº”è¯¥æ˜¯å…¨å±€å”¯ä¸€ä¸”æ˜¯å•è°ƒé€’å¢</code>ã€‚å…¨å±€å”¯ä¸€ä¿è¯åœ¨å„ç³»ç»Ÿä¹‹é—´éƒ½æ˜¯å”¯ä¸€çš„ï¼Œå•è°ƒ é€’å¢æ˜¯å¸Œæœ›æ’å…¥æ—¶ä¸å½±å“æ•°æ®åº“æ€§èƒ½ã€‚</p><p>è¿™é‡Œæ¨èæœ€ç®€å•çš„ä¸€ç§ä¸»é”®è®¾è®¡ï¼šUUIDã€‚</p><p><strong>UUIDçš„ç‰¹ç‚¹ï¼š</strong></p><p>å…¨å±€å”¯ä¸€ï¼Œå ç”¨36å­—èŠ‚ï¼Œæ•°æ®æ— åºï¼Œæ’å…¥æ€§èƒ½å·®ã€‚</p><p><strong>è®¤è¯†UUIDï¼š</strong></p><ul><li>ä¸ºä»€ä¹ˆUUIDæ˜¯å…¨å±€å”¯ä¸€çš„ï¼Ÿ </li><li>ä¸ºä»€ä¹ˆUUIDå ç”¨36ä¸ªå­—èŠ‚ï¼Ÿ </li><li>ä¸ºä»€ä¹ˆUUIDæ˜¯æ— åºçš„ï¼Ÿ</li></ul><p>MySQLæ•°æ®åº“çš„UUIDç»„æˆå¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UUID = æ—¶é—´+UUIDç‰ˆæœ¬ï¼ˆ16å­—èŠ‚ï¼‰- æ—¶é’Ÿåºåˆ—ï¼ˆ4å­—èŠ‚ï¼‰ - MACåœ°å€ï¼ˆ12å­—èŠ‚ï¼‰</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬ä»¥UUIDå€¼e0ea12d4-6473-11eb-943c-00155dbaa39dä¸¾ä¾‹ï¼š</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220706162131362.png" class=""><p><code>ä¸ºä»€ä¹ˆUUIDæ˜¯å…¨å±€å”¯ä¸€çš„ï¼Ÿ</code></p><p>åœ¨UUIDä¸­æ—¶é—´éƒ¨åˆ†å ç”¨60ä½ï¼Œå­˜å‚¨çš„ç±»ä¼¼TIMESTAMPçš„æ—¶é—´æˆ³ï¼Œä½†è¡¨ç¤ºçš„æ˜¯ä»1582-10-15 00ï¼š00ï¼š00.00 åˆ°ç°åœ¨çš„100nsçš„è®¡æ•°ã€‚å¯ä»¥çœ‹åˆ°UUIDå­˜å‚¨çš„æ—¶é—´ç²¾åº¦æ¯”TIMESTAMPEæ›´é«˜ï¼Œæ—¶é—´ç»´åº¦å‘ç”Ÿé‡å¤çš„æ¦‚ç‡é™ ä½åˆ°1&#x2F;100nsã€‚</p><p>æ—¶é’Ÿåºåˆ—æ˜¯ä¸ºäº†é¿å…æ—¶é’Ÿè¢«å›æ‹¨å¯¼è‡´äº§ç”Ÿæ—¶é—´é‡å¤çš„å¯èƒ½æ€§ã€‚MACåœ°å€ç”¨äºå…¨å±€å”¯ä¸€ã€‚</p><p><code>ä¸ºä»€ä¹ˆUUIDå ç”¨36ä¸ªå­—èŠ‚ï¼Ÿ</code></p><p>UUIDæ ¹æ®å­—ç¬¦ä¸²è¿›è¡Œå­˜å‚¨ï¼Œè®¾è®¡æ—¶è¿˜å¸¦æœ‰æ— ç”¨â€-â€œå­—ç¬¦ä¸²ï¼Œå› æ­¤æ€»å…±éœ€è¦36ä¸ªå­—èŠ‚ã€‚</p><p><code>ä¸ºä»€ä¹ˆUUIDæ˜¯éšæœºæ— åºçš„å‘¢ï¼Ÿ</code></p><p>å› ä¸ºUUIDçš„è®¾è®¡ä¸­ï¼Œå°†æ—¶é—´ä½ä½æ”¾åœ¨æœ€å‰é¢ï¼Œè€Œè¿™éƒ¨åˆ†çš„æ•°æ®æ˜¯ä¸€ç›´åœ¨å˜åŒ–çš„ï¼Œå¹¶ä¸”æ˜¯æ— åºã€‚</p><p><strong>æ”¹é€ UUID</strong></p><p>è‹¥å°†æ—¶é—´é«˜ä½ä½äº’æ¢ï¼Œåˆ™æ—¶é—´å°±æ˜¯å•è°ƒé€’å¢çš„äº†ï¼Œä¹Ÿå°±å˜å¾—å•è°ƒé€’å¢äº†ã€‚MySQL 8.0å¯ä»¥æ›´æ¢æ—¶é—´ä½ä½å’Œæ—¶é—´é«˜ä½çš„å­˜å‚¨æ–¹å¼ï¼Œè¿™æ ·UUIDå°±æ˜¯æœ‰åºçš„UUIDäº†ã€‚</p><p>MySQL 8.0è¿˜è§£å†³äº†UUIDå­˜åœ¨çš„ç©ºé—´å ç”¨çš„é—®é¢˜ï¼Œé™¤å»äº†UUIDå­—ç¬¦ä¸²ä¸­æ— æ„ä¹‰çš„â€-â€œå­—ç¬¦ä¸²ï¼Œå¹¶ä¸”å°†å­—ç¬¦ä¸²ç”¨äºŒè¿›åˆ¶ç±»å‹ä¿å­˜ï¼Œè¿™æ ·å­˜å‚¨ç©ºé—´é™ä½ä¸ºäº†16å­—èŠ‚ã€‚</p><p>å¯ä»¥é€šè¿‡MySQL8.0æä¾›çš„uuid_to_binå‡½æ•°å®ç°ä¸Šè¿°åŠŸèƒ½ï¼ŒåŒæ ·çš„ï¼ŒMySQLä¹Ÿæä¾›äº†bin_to_uuidå‡½æ•°è¿›è¡Œè½¬åŒ–ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SET @uuid = UUID();</span><br><span class="line">SELECT @uuid,uuid_to_bin(@uuid),uuid_to_bin(@uuid,TRUE);</span><br></pre></td></tr></table></figure><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220706162657448.png" class=""><p><strong>é€šè¿‡å‡½æ•°uuid_to_bin(@uuid,true)å°†UUIDè½¬åŒ–ä¸ºæœ‰åºUUIDäº†</strong>ã€‚å…¨å±€å”¯ä¸€ + å•è°ƒé€’å¢ï¼Œè¿™ä¸å°±æ˜¯æˆ‘ä»¬æƒ³è¦çš„ä¸»é”®ï¼</p><p><strong>æœ‰åºUUIDæ€§èƒ½æµ‹è¯•</strong></p><p>16å­—èŠ‚çš„æœ‰åºUUIDï¼Œç›¸æ¯”ä¹‹å‰8å­—èŠ‚çš„è‡ªå¢IDï¼Œæ€§èƒ½å’Œå­˜å‚¨ç©ºé—´å¯¹æ¯”ç©¶ç«Ÿå¦‚ä½•å‘¢ï¼Ÿ</p><p>æˆ‘ä»¬æ¥åšä¸€ä¸ªæµ‹è¯•ï¼Œæ’å…¥1äº¿æ¡æ•°æ®ï¼Œæ¯æ¡æ•°æ®å ç”¨500å­—èŠ‚ï¼Œå«æœ‰3ä¸ªäºŒçº§ç´¢å¼•ï¼Œæœ€ç»ˆçš„ç»“æœå¦‚ä¸‹æ‰€ç¤ºï¼š</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220706162947613.png" class=""><p>ä»ä¸Šå›¾å¯ä»¥çœ‹åˆ°æ’å…¥1äº¿æ¡æ•°æ®æœ‰åºUUIDæ˜¯æœ€å¿«çš„ï¼Œè€Œä¸”åœ¨å®é™…ä¸šåŠ¡ä½¿ç”¨ä¸­æœ‰åºUUIDåœ¨ <code>ä¸šåŠ¡ç«¯å°±å¯ä»¥ç”Ÿæˆ</code> ã€‚è¿˜å¯ä»¥è¿›ä¸€æ­¥å‡å°‘SQLçš„äº¤äº’æ¬¡æ•°ã€‚</p><p>å¦å¤–ï¼Œè™½ç„¶æœ‰åºUUIDç›¸æ¯”è‡ªå¢IDå¤šäº†8ä¸ªå­—èŠ‚ï¼Œä½†å®é™…åªå¢å¤§äº†3Gçš„å­˜å‚¨ç©ºé—´ï¼Œè¿˜å¯ä»¥æ¥å—ã€‚</p><blockquote><p>åœ¨å½“ä»Šçš„äº’è”ç½‘ç¯å¢ƒä¸­ï¼Œéå¸¸ä¸æ¨èè‡ªå¢IDä½œä¸ºä¸»é”®çš„æ•°æ®åº“è®¾è®¡ã€‚æ›´æ¨èç±»ä¼¼æœ‰åºUUIDçš„å…¨å±€ å”¯ä¸€çš„å®ç°ã€‚ </p><p>å¦å¤–åœ¨çœŸå®çš„ä¸šåŠ¡ç³»ç»Ÿä¸­ï¼Œä¸»é”®è¿˜å¯ä»¥åŠ å…¥ä¸šåŠ¡å’Œç³»ç»Ÿå±æ€§ï¼Œå¦‚ç”¨æˆ·çš„å°¾å·ï¼Œæœºæˆ¿çš„ä¿¡æ¯ç­‰ã€‚è¿™æ · çš„ä¸»é”®è®¾è®¡å°±æ›´ä¸ºè€ƒéªŒæ¶æ„å¸ˆçš„æ°´å¹³äº†ã€‚</p></blockquote><p><strong>å¦‚æœä¸æ˜¯MySQL8.0 è‚¿ä¹ˆåŠï¼Ÿ</strong></p><p>æ‰‹åŠ¨èµ‹å€¼å­—æ®µåšä¸»é”®ï¼</p><p>æ¯”å¦‚ï¼Œè®¾è®¡å„ä¸ªåˆ†åº—çš„ä¼šå‘˜è¡¨çš„ä¸»é”®ï¼Œå› ä¸ºå¦‚æœæ¯å°æœºå™¨å„è‡ªäº§ç”Ÿçš„æ•°æ®éœ€è¦åˆå¹¶ï¼Œå°±å¯èƒ½ä¼šå‡ºç°ä¸»é”®é‡å¤çš„é—®é¢˜ã€‚</p><p>å¯ä»¥åœ¨æ€»éƒ¨ MySQL æ•°æ®åº“ä¸­ï¼Œæœ‰ä¸€ä¸ªç®¡ç†ä¿¡æ¯è¡¨ï¼Œåœ¨è¿™ä¸ªè¡¨ä¸­æ·»åŠ ä¸€ä¸ªå­—æ®µï¼Œä¸“é—¨ç”¨æ¥è®°å½•å½“å‰ä¼šå‘˜ç¼–å·çš„æœ€å¤§å€¼ã€‚</p><p>é—¨åº—åœ¨æ·»åŠ ä¼šå‘˜çš„æ—¶å€™ï¼Œå…ˆåˆ°æ€»éƒ¨ MySQL æ•°æ®åº“ä¸­è·å–è¿™ä¸ªæœ€å¤§å€¼ï¼Œåœ¨è¿™ä¸ªåŸºç¡€ä¸ŠåŠ  1ï¼Œç„¶åç”¨è¿™ä¸ªå€¼ ä½œä¸ºæ–°ä¼šå‘˜çš„â€œidâ€ï¼ŒåŒæ—¶ï¼Œæ›´æ–°æ€»éƒ¨ MySQL æ•°æ®åº“ç®¡ç†ä¿¡æ¯è¡¨ä¸­çš„å½“å‰ä¼šå‘˜ç¼–å·çš„æœ€å¤§å€¼ã€‚</p><p>è¿™æ ·ä¸€æ¥ï¼Œå„ä¸ªé—¨åº—æ·»åŠ ä¼šå‘˜çš„æ—¶å€™ï¼Œéƒ½å¯¹åŒä¸€ä¸ªæ€»éƒ¨ MySQL æ•°æ®åº“ä¸­çš„æ•°æ®è¡¨å­—æ®µè¿›è¡Œæ“ä½œï¼Œå°±è§£ å†³äº†å„é—¨åº—æ·»åŠ ä¼šå‘˜æ—¶ä¼šå‘˜ç¼–å·å†²çªçš„é—®é¢˜ã€‚</p><h1 id="ç¬¬11ç« -æ•°æ®åº“çš„è®¾è®¡è§„èŒƒ"><a href="#ç¬¬11ç« -æ•°æ®åº“çš„è®¾è®¡è§„èŒƒ" class="headerlink" title="ç¬¬11ç« _æ•°æ®åº“çš„è®¾è®¡è§„èŒƒ"></a>ç¬¬11ç« _æ•°æ®åº“çš„è®¾è®¡è§„èŒƒ</h1><h2 id="1-ä¸ºä»€ä¹ˆéœ€è¦æ•°æ®åº“è®¾è®¡"><a href="#1-ä¸ºä»€ä¹ˆéœ€è¦æ•°æ®åº“è®¾è®¡" class="headerlink" title="1. ä¸ºä»€ä¹ˆéœ€è¦æ•°æ®åº“è®¾è®¡"></a>1. ä¸ºä»€ä¹ˆéœ€è¦æ•°æ®åº“è®¾è®¡</h2><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220706164201695.png" class=""><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220706164359539.png" class=""><h2 id="2-èŒƒ-å¼"><a href="#2-èŒƒ-å¼" class="headerlink" title="2. èŒƒ å¼"></a>2. èŒƒ å¼</h2><h3 id="2-1-èŒƒå¼ç®€ä»‹"><a href="#2-1-èŒƒå¼ç®€ä»‹" class="headerlink" title="2.1 èŒƒå¼ç®€ä»‹"></a>2.1 èŒƒå¼ç®€ä»‹</h3><p>åœ¨å…³ç³»å‹æ•°æ®åº“ä¸­ï¼Œå…³äºæ•°æ®è¡¨è®¾è®¡çš„åŸºæœ¬åŸåˆ™ã€è§„åˆ™å°±ç§°ä¸ºèŒƒå¼ã€‚å¯ä»¥ç†è§£ä¸ºï¼Œä¸€å¼ æ•°æ®è¡¨çš„è®¾è®¡ç»“ æ„éœ€è¦æ»¡è¶³çš„æŸç§è®¾è®¡æ ‡å‡†çš„ çº§åˆ« ã€‚è¦æƒ³è®¾è®¡ä¸€ä¸ªç»“æ„åˆç†çš„å…³ç³»å‹æ•°æ®åº“ï¼Œå¿…é¡»æ»¡è¶³ä¸€å®šçš„èŒƒå¼ã€‚</p><h3 id="2-2-èŒƒå¼éƒ½åŒ…æ‹¬å“ªäº›"><a href="#2-2-èŒƒå¼éƒ½åŒ…æ‹¬å“ªäº›" class="headerlink" title="2.2 èŒƒå¼éƒ½åŒ…æ‹¬å“ªäº›"></a>2.2 èŒƒå¼éƒ½åŒ…æ‹¬å“ªäº›</h3><p>ç›®å‰å…³ç³»å‹æ•°æ®åº“æœ‰å…­ç§å¸¸è§èŒƒå¼ï¼ŒæŒ‰ç…§èŒƒå¼çº§åˆ«ï¼Œä»ä½åˆ°é«˜åˆ†åˆ«æ˜¯ï¼šç¬¬ä¸€èŒƒå¼ï¼ˆ1NFï¼‰ã€ç¬¬äºŒèŒƒå¼ ï¼ˆ2NFï¼‰ã€ç¬¬ä¸‰èŒƒå¼ï¼ˆ3NFï¼‰ã€å·´æ–¯-ç§‘å¾·èŒƒå¼ï¼ˆBCNFï¼‰ã€ç¬¬å››èŒƒå¼(4NFï¼‰å’Œç¬¬äº”èŒƒå¼ï¼ˆ5NFï¼Œåˆç§°å®Œç¾èŒƒå¼ï¼‰ã€‚</p><p>æ•°æ®åº“çš„èŒƒå¼è®¾è®¡è¶Šé«˜é˜¶ï¼Œå¤¯ä½™åº¦å°±è¶Šä½ï¼ŒåŒæ—¶é«˜é˜¶çš„èŒƒå¼ä¸€å®šç¬¦åˆä½é˜¶èŒƒå¼çš„è¦æ±‚ï¼Œæ»¡è¶³æœ€ä½è¦æ±‚çš„èŒƒå¼æ˜¯ç¬¬ä¸€èŒƒå¼ï¼ˆ1NFï¼‰ã€‚åœ¨ç¬¬ä¸€èŒƒå¼çš„åŸºç¡€ä¸Šè¿›ä¸€æ­¥æ»¡è¶³æ›´å¤šè§„èŒƒçš„è¦æ±‚ç§°ä¸ºç¬¬äºŒèŒƒå¼ï¼ˆ2NFï¼‰ï¼Œå…¶ä½™èŒƒå¼ä»¥æ­¤ç±»æ¨ã€‚</p><p>ä¸€èˆ¬æ¥è¯´ï¼Œåœ¨å…³ç³»å‹æ•°æ®åº“è®¾è®¡ä¸­ï¼Œæœ€é«˜ä¹Ÿå°±éµå¾ªåˆ°<code>BCNF</code>, æ™®éè¿˜æ˜¯<code>3NF</code>ã€‚ä½†ä¹Ÿä¸ç»å¯¹ï¼Œæœ‰æ—¶å€™ä¸ºäº†æé«˜æŸäº›æŸ¥è¯¢æ€§èƒ½ï¼Œæˆ‘ä»¬è¿˜éœ€è¦ç ´åèŒƒå¼è§„åˆ™ï¼Œä¹Ÿå°±æ˜¯<code>åè§„èŒƒåŒ–</code>ã€‚</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220706165020939.png" class=""><h3 id="2-3-é”®å’Œç›¸å…³å±æ€§çš„æ¦‚å¿µ"><a href="#2-3-é”®å’Œç›¸å…³å±æ€§çš„æ¦‚å¿µ" class="headerlink" title="2.3 é”®å’Œç›¸å…³å±æ€§çš„æ¦‚å¿µ"></a>2.3 é”®å’Œç›¸å…³å±æ€§çš„æ¦‚å¿µ</h3><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220706165231022.png" class=""><p><strong>ä¸¾ä¾‹:</strong></p><p>è¿™é‡Œæœ‰ä¸¤ä¸ªè¡¨ï¼š</p><p><code>çƒå‘˜è¡¨(player)</code> ï¼šçƒå‘˜ç¼–å· | å§“å | èº«ä»½è¯å· | å¹´é¾„ | çƒé˜Ÿç¼–å· </p><p><code>çƒé˜Ÿè¡¨(team) </code>ï¼šçƒé˜Ÿç¼–å· | ä¸»æ•™ç»ƒ | çƒé˜Ÿæ‰€åœ¨åœ°</p><ul><li>è¶…é”® ï¼šå¯¹äºçƒå‘˜è¡¨æ¥è¯´ï¼Œè¶…é”®å°±æ˜¯åŒ…æ‹¬çƒå‘˜ç¼–å·æˆ–è€…èº«ä»½è¯å·çš„ä»»æ„ç»„åˆï¼Œæ¯”å¦‚ï¼ˆçƒå‘˜ç¼–å·ï¼‰ ï¼ˆçƒå‘˜ç¼–å·ï¼Œå§“åï¼‰ï¼ˆèº«ä»½è¯å·ï¼Œå¹´é¾„ï¼‰ç­‰ã€‚ </li><li>å€™é€‰é”® ï¼šå°±æ˜¯æœ€å°çš„è¶…é”®ï¼Œå¯¹äºçƒå‘˜è¡¨æ¥è¯´ï¼Œå€™é€‰é”®å°±æ˜¯ï¼ˆçƒå‘˜ç¼–å·ï¼‰æˆ–è€…ï¼ˆèº«ä»½è¯å·ï¼‰ã€‚ </li><li>ä¸»é”® ï¼šæˆ‘ä»¬è‡ªå·±é€‰å®šï¼Œä¹Ÿå°±æ˜¯ä»å€™é€‰é”®ä¸­é€‰æ‹©ä¸€ä¸ªï¼Œæ¯”å¦‚ï¼ˆçƒå‘˜ç¼–å·ï¼‰ã€‚ </li><li>å¤–é”® ï¼šçƒå‘˜è¡¨ä¸­çš„çƒé˜Ÿç¼–å·ã€‚ </li><li>ä¸»å±æ€§ ã€ éä¸»å±æ€§ ï¼šåœ¨çƒå‘˜è¡¨ä¸­ï¼Œä¸»å±æ€§æ˜¯ï¼ˆçƒå‘˜ç¼–å·ï¼‰ï¼ˆèº«ä»½è¯å·ï¼‰ï¼Œå…¶ä»–çš„å±æ€§ï¼ˆå§“åï¼‰ ï¼ˆå¹´é¾„ï¼‰ï¼ˆçƒé˜Ÿç¼–å·ï¼‰éƒ½æ˜¯éä¸»å±æ€§ã€‚</li></ul><h3 id="2-4-ç¬¬ä¸€èŒƒå¼-1st-NF"><a href="#2-4-ç¬¬ä¸€èŒƒå¼-1st-NF" class="headerlink" title="2.4 ç¬¬ä¸€èŒƒå¼(1st NF)"></a>2.4 ç¬¬ä¸€èŒƒå¼(1st NF)</h3><p>ç¬¬ä¸€èŒƒå¼ä¸»è¦ç¡®ä¿æ•°æ®åº“ä¸­æ¯ä¸ªå­—æ®µçš„å€¼å¿…é¡»å…·æœ‰<code>åŸå­æ€§</code>ï¼Œä¹Ÿå°±æ˜¯è¯´æ•°æ®è¡¨ä¸­æ¯ä¸ªå­—æ®µçš„å€¼ä¸º<code>ä¸å¯å†æ¬¡æ‹†åˆ†</code>çš„æœ€å°æ•°æ®å•å…ƒã€‚</p><p>æˆ‘ä»¬åœ¨è®¾è®¡æŸä¸ªå­—æ®µçš„æ—¶å€™ï¼Œå¯¹äºå­—æ®µXæ¥è¯´ï¼Œä¸èƒ½æŠŠå­—æ®µXæ‹†åˆ†æˆå­—æ®µX-1å’Œå­—æ®µX-2ã€‚äº‹å®ä¸Šï¼Œä»»ä½•çš„DBMSéƒ½ä¼šæ»¡è¶³ç¬¬ä¸€èŒƒå¼çš„è¦æ±‚ï¼Œä¸ä¼šå°†å­—æ®µè¿›è¡Œæ‹†åˆ†ã€‚</p><p><strong>ä¸¾ä¾‹1ï¼š</strong></p><p>å‡è®¾ä¸€å®¶å…¬å¸è¦å­˜å‚¨å‘˜å·¥çš„å§“åå’Œè”ç³»æ–¹å¼ã€‚å®ƒåˆ›å»ºä¸€ä¸ªå¦‚ä¸‹è¡¨ï¼š</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220706171057270.png" class=""><p>è¯¥è¡¨ä¸ç¬¦åˆ 1NF ï¼Œå› ä¸ºè§„åˆ™è¯´â€œè¡¨çš„æ¯ä¸ªå±æ€§å¿…é¡»å…·æœ‰åŸå­ï¼ˆå•ä¸ªï¼‰å€¼â€ï¼Œlisiå’Œzhaoliuå‘˜å·¥çš„ emp_mobile å€¼è¿åäº†è¯¥è§„åˆ™ã€‚ä¸ºäº†ä½¿è¡¨ç¬¦åˆ 1NF ï¼Œæˆ‘ä»¬åº”è¯¥æœ‰å¦‚ä¸‹è¡¨æ•°æ®ï¼š</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220706171130851.png" class=""><p><strong>ä¸¾ä¾‹2ï¼š</strong></p><p>user è¡¨çš„è®¾è®¡ä¸ç¬¦åˆç¬¬ä¸€èŒƒå¼</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220706171225292.png" class=""><p>å…¶ä¸­ï¼Œuser_infoå­—æ®µä¸ºç”¨æˆ·ä¿¡æ¯ï¼Œå¯ä»¥è¿›ä¸€æ­¥æ‹†åˆ†æˆæ›´å°ç²’åº¦çš„å­—æ®µï¼Œä¸ç¬¦åˆæ•°æ®åº“è®¾è®¡å¯¹ç¬¬ä¸€èŒƒå¼çš„ è¦æ±‚ã€‚å°†user_infoæ‹†åˆ†åå¦‚ä¸‹ï¼š</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220706171242455.png" class=""><p><strong>ä¸¾ä¾‹3ï¼š</strong></p><p>å±æ€§çš„åŸå­æ€§æ˜¯ ä¸»è§‚çš„ ã€‚ä¾‹å¦‚ï¼ŒEmployeeså…³ç³»ä¸­é›‡å‘˜å§“ååº”å½“ä½¿ç”¨1ä¸ªï¼ˆfullnameï¼‰ã€2ä¸ªï¼ˆfirstname å’Œlastnameï¼‰è¿˜æ˜¯3ä¸ªï¼ˆfirstnameã€middlenameå’Œlastnameï¼‰å±æ€§è¡¨ç¤ºå‘¢ï¼Ÿç­”æ¡ˆå–å†³äºåº”ç”¨ç¨‹åºã€‚å¦‚æœåº” ç”¨ç¨‹åºéœ€è¦åˆ†åˆ«å¤„ç†é›‡å‘˜çš„å§“åéƒ¨åˆ†ï¼ˆå¦‚ï¼šç”¨äºæœç´¢ç›®çš„ï¼‰ï¼Œåˆ™æœ‰å¿…è¦æŠŠå®ƒä»¬åˆ†å¼€ã€‚å¦åˆ™ï¼Œä¸éœ€è¦ã€‚</p><p>è¡¨1ï¼š</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220706171442919.png" class=""><p>è¡¨2ï¼š</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220706171456873.png" class=""><h3 id="2-5-ç¬¬äºŒèŒƒå¼-2nd-NF"><a href="#2-5-ç¬¬äºŒèŒƒå¼-2nd-NF" class="headerlink" title="2.5 ç¬¬äºŒèŒƒå¼(2nd NF)"></a>2.5 ç¬¬äºŒèŒƒå¼(2nd NF)</h3><p>ç¬¬äºŒèŒƒå¼è¦æ±‚ï¼Œåœ¨æ»¡è¶³ç¬¬ä¸€èŒƒå¼çš„åŸºç¡€ä¸Šï¼Œè¿˜è¦<strong>æ»¡è¶³æ•°æ®åº“é‡Œçš„æ¯ä¸€æ¡æ•°æ®è®°å½•ï¼Œéƒ½æ˜¯å¯å”¯ä¸€æ ‡è¯†çš„ã€‚è€Œä¸”æ‰€æœ‰éä¸»é”®å­—æ®µï¼Œéƒ½å¿…é¡»å®Œå…¨ä¾èµ–ä¸»é”®ï¼Œä¸èƒ½åªä¾èµ–ä¸»é”®çš„ä¸€éƒ¨åˆ†</strong>ã€‚å¦‚æœçŸ¥é“ä¸»é”®çš„æ‰€æœ‰å±æ€§çš„å€¼ï¼Œå°±å¯ä»¥æ£€ç´¢åˆ°ä»»ä½•å…ƒç»„ï¼ˆè¡Œï¼‰çš„ä»»ä½•å±æ€§çš„ä»»ä½•å€¼ã€‚ï¼ˆè¦æ±‚ä¸­çš„ä¸»é”®ï¼Œå…¶å®å¯ä»¥æ‰©å±•æ›¿æ¢ä¸ºå€™é€‰é”®ï¼‰ã€‚</p><p><strong>ä¸¾ä¾‹1ï¼š</strong></p><p><code>æˆç»©è¡¨</code> ï¼ˆå­¦å·ï¼Œè¯¾ç¨‹å·ï¼Œæˆç»©ï¼‰å…³ç³»ä¸­ï¼Œï¼ˆå­¦å·ï¼Œè¯¾ç¨‹å·ï¼‰å¯ä»¥å†³å®šæˆç»©ï¼Œä½†æ˜¯å­¦å·ä¸èƒ½å†³å®šæˆç»©ï¼Œè¯¾ ç¨‹å·ä¹Ÿä¸èƒ½å†³å®šæˆç»©ï¼Œæ‰€ä»¥â€œï¼ˆå­¦å·ï¼Œè¯¾ç¨‹å·ï¼‰â†’æˆç»©â€å°±æ˜¯ <code>å®Œå…¨ä¾èµ–å…³ç³»</code> ã€‚</p><p><strong>ä¸¾ä¾‹2ï¼š</strong></p><p><code>æ¯”èµ›è¡¨ player_game</code> ï¼Œé‡Œé¢åŒ…å«çƒå‘˜ç¼–å·ã€å§“åã€å¹´é¾„ã€æ¯”èµ›ç¼–å·ã€æ¯”èµ›æ—¶é—´å’Œæ¯”èµ›åœºåœ°ç­‰å±æ€§ï¼Œè¿™ é‡Œå€™é€‰é”®å’Œä¸»é”®éƒ½ä¸ºï¼ˆçƒå‘˜ç¼–å·ï¼Œæ¯”èµ›ç¼–å·ï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å€™é€‰é”®ï¼ˆæˆ–ä¸»é”®ï¼‰æ¥å†³å®šå¦‚ä¸‹çš„å…³ç³»ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(çƒå‘˜ç¼–å·, æ¯”èµ›ç¼–å·) â†’ (å§“å, å¹´é¾„, æ¯”èµ›æ—¶é—´, æ¯”èµ›åœºåœ°ï¼Œå¾—åˆ†)</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯è¿™ä¸ªæ•°æ®è¡¨ä¸æ»¡è¶³ç¬¬äºŒèŒƒå¼ï¼Œå› ä¸ºæ•°æ®è¡¨ä¸­çš„å­—æ®µä¹‹é—´è¿˜å­˜åœ¨ç€å¦‚ä¸‹çš„å¯¹åº”å…³ç³»ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">(çƒå‘˜ç¼–å·) â†’ (å§“åï¼Œå¹´é¾„)</span><br><span class="line"></span><br><span class="line">(æ¯”èµ›ç¼–å·) â†’ (æ¯”èµ›æ—¶é—´, æ¯”èµ›åœºåœ°)</span><br></pre></td></tr></table></figure><p>å¯¹äºéä¸»å±æ€§æ¥è¯´ï¼Œå¹¶éå®Œå…¨ä¾èµ–å€™é€‰é”®ã€‚è¿™æ ·ä¼šäº§ç”Ÿæ€æ ·çš„é—®é¢˜å‘¢ï¼Ÿ</p><ol><li><code>æ•°æ®å†—ä½™</code> ï¼šå¦‚æœä¸€ä¸ªçƒå‘˜å¯ä»¥å‚åŠ  m åœºæ¯”èµ›ï¼Œé‚£ä¹ˆçƒå‘˜çš„å§“åå’Œå¹´é¾„å°±é‡å¤äº† m-1 æ¬¡ã€‚ä¸€ä¸ªæ¯”èµ› ä¹Ÿå¯èƒ½ä¼šæœ‰ n ä¸ªçƒå‘˜å‚åŠ ï¼Œæ¯”èµ›çš„æ—¶é—´å’Œåœ°ç‚¹å°±é‡å¤äº† n-1 æ¬¡ã€‚ </li><li><code>æ’å…¥å¼‚å¸¸</code> ï¼šå¦‚æœæˆ‘ä»¬æƒ³è¦æ·»åŠ ä¸€åœºæ–°çš„æ¯”èµ›ï¼Œä½†æ˜¯è¿™æ—¶è¿˜æ²¡æœ‰ç¡®å®šå‚åŠ çš„çƒå‘˜éƒ½æœ‰è°ï¼Œé‚£ä¹ˆå°±æ²¡æ³•æ’å…¥ã€‚ </li><li><code>åˆ é™¤å¼‚å¸¸</code> ï¼šå¦‚æœæˆ‘è¦åˆ é™¤æŸä¸ªçƒå‘˜ç¼–å·ï¼Œå¦‚æœæ²¡æœ‰å•ç‹¬ä¿å­˜æ¯”èµ›è¡¨çš„è¯ï¼Œå°±ä¼šåŒæ—¶æŠŠæ¯”èµ›ä¿¡æ¯åˆ  é™¤æ‰ã€‚ </li><li><code>æ›´æ–°å¼‚å¸¸</code> ï¼šå¦‚æœæˆ‘ä»¬è°ƒæ•´äº†æŸä¸ªæ¯”èµ›çš„æ—¶é—´ï¼Œé‚£ä¹ˆæ•°æ®è¡¨ä¸­æ‰€æœ‰è¿™ä¸ªæ¯”èµ›çš„æ—¶é—´éƒ½éœ€è¦è¿›è¡Œè°ƒ æ•´ï¼Œå¦åˆ™å°±ä¼šå‡ºç°ä¸€åœºæ¯”èµ›æ—¶é—´ä¸åŒçš„æƒ…å†µã€‚</li></ol><p>ä¸ºäº†é¿å…å‡ºç°ä¸Šè¿°çš„æƒ…å†µï¼Œæˆ‘ä»¬å¯ä»¥æŠŠçƒå‘˜æ¯”èµ›è¡¨è®¾è®¡ä¸ºä¸‹é¢çš„ä¸‰å¼ è¡¨ã€‚</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707122639894.png" class=""><p>è¿™æ ·çš„è¯ï¼Œæ¯å¼ æ•°æ®è¡¨éƒ½ç¬¦åˆç¬¬äºŒèŒƒå¼ï¼Œä¹Ÿå°±é¿å…äº†å¼‚å¸¸æƒ…å†µçš„å‘ç”Ÿã€‚</p><blockquote><p>1NF å‘Šè¯‰æˆ‘ä»¬å­—æ®µå±æ€§éœ€è¦æ˜¯åŸå­æ€§çš„ï¼Œè€Œ 2NF å‘Šè¯‰æˆ‘ä»¬ä¸€å¼ è¡¨å°±æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„å¯¹è±¡ï¼Œä¸€å¼ è¡¨åªè¡¨è¾¾ä¸€ä¸ªæ„æ€ã€‚</p></blockquote><p><strong>ä¸¾ä¾‹3ï¼š</strong></p><p>å®šä¹‰äº†ä¸€ä¸ªåä¸º Orders çš„å…³ç³»ï¼Œè¡¨ç¤ºè®¢å•å’Œè®¢å•è¡Œçš„ä¿¡æ¯ï¼š</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707123038469.png" class=""><p>è¿åäº†ç¬¬äºŒèŒƒå¼ï¼Œå› ä¸ºæœ‰éä¸»é”®å±æ€§ä»…ä¾èµ–äºå€™é€‰é”®ï¼ˆæˆ–ä¸»é”®ï¼‰çš„ä¸€éƒ¨åˆ†ã€‚ä¾‹å¦‚ï¼Œå¯ä»¥ä»…é€šè¿‡orderidæ‰¾ åˆ°è®¢å•çš„ orderdateï¼Œä»¥åŠ customerid å’Œ companynameï¼Œè€Œæ²¡æœ‰å¿…è¦å†å»ä½¿ç”¨productidã€‚</p><p>ä¿®æ”¹ï¼š</p><p>Ordersè¡¨å’ŒOrderDetailsè¡¨å¦‚ä¸‹ï¼Œæ­¤æ—¶ç¬¦åˆç¬¬äºŒèŒƒå¼ã€‚</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707123104009.png" class=""><blockquote><p>å°ç»“ï¼šç¬¬äºŒèŒƒå¼ï¼ˆ2NFï¼‰è¦æ±‚å®ä½“çš„å±æ€§å®Œå…¨ä¾èµ–ä¸»å…³é”®å­—ã€‚å¦‚æœå­˜åœ¨ä¸å®Œå…¨ä¾èµ–ï¼Œé‚£ä¹ˆè¿™ä¸ªå±æ€§å’Œä¸»å…³é”®å­—çš„è¿™ä¸€éƒ¨åˆ†åº”è¯¥åˆ†ç¦»å‡ºæ¥å½¢æˆä¸€ä¸ªæ–°çš„å®ä½“ï¼Œæ–°å®ä½“ä¸å…ƒå®ä½“ä¹‹é—´æ˜¯ä¸€å¯¹å¤šçš„å…³ç³»ã€‚</p></blockquote><h3 id="2-6-ç¬¬ä¸‰èŒƒå¼-3rd-NF"><a href="#2-6-ç¬¬ä¸‰èŒƒå¼-3rd-NF" class="headerlink" title="2.6 ç¬¬ä¸‰èŒƒå¼(3rd NF)"></a>2.6 ç¬¬ä¸‰èŒƒå¼(3rd NF)</h3><p>ç¬¬ä¸‰èŒƒå¼æ˜¯åœ¨ç¬¬äºŒèŒƒå¼çš„åŸºç¡€ä¸Šï¼Œç¡®ä¿æ•°æ®è¡¨ä¸­çš„æ¯ä¸€ä¸ªéä¸»é”®å­—æ®µéƒ½å’Œä¸»é”®å­—æ®µç›´æ¥ç›¸å…³ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œ<strong>è¦æ±‚æ•°æ®è¡¨ä¸­çš„æ‰€æœ‰éä¸»é”®å­—æ®µä¸èƒ½ä¾èµ–äºå…¶ä»–éä¸»é”®å­—æ®µ</strong>ã€‚ï¼ˆå³ï¼Œä¸èƒ½å­˜åœ¨éä¸»å±æ€§Aä¾èµ–äºéä¸»å±æ€§Bï¼Œéä¸»å±æ€§Bä¾èµ–äºä¸»é”®Cçš„æƒ…å†µï¼Œå³å­˜åœ¨â€œA-&gt;B-&gt;Câ€çš„å†³å®šå…³ç³»ï¼‰é€šä¿—åœ°è®²ï¼Œè¯¥è§„åˆ™çš„æ„æ€æ˜¯æ‰€æœ‰<code>éä¸»é”®å±æ€§</code>ä¹‹é—´ä¸èƒ½ç”±ä¾èµ–å…³ç³»ï¼Œå¿…é¡»<code>ç›¸äº’ç‹¬ç«‹</code>ã€‚</p><p>è¿™é‡Œçš„ä¸»é”®å¯ä»¥æ‰©å±•ä¸ºå€™é€‰é”®ã€‚</p><p><strong>ä¸¾ä¾‹1ï¼š</strong></p><p><code>éƒ¨é—¨ä¿¡æ¯è¡¨</code> ï¼šæ¯ä¸ªéƒ¨é—¨æœ‰éƒ¨é—¨ç¼–å·ï¼ˆdept_idï¼‰ã€éƒ¨é—¨åç§°ã€éƒ¨é—¨ç®€ä»‹ç­‰ä¿¡æ¯ã€‚</p><p><code>å‘˜å·¥ä¿¡æ¯è¡¨ </code>ï¼šæ¯ä¸ªå‘˜å·¥æœ‰å‘˜å·¥ç¼–å·ã€å§“åã€éƒ¨é—¨ç¼–å·ã€‚åˆ—å‡ºéƒ¨é—¨ç¼–å·åå°±ä¸èƒ½å†å°†éƒ¨é—¨åç§°ã€éƒ¨é—¨ç®€ä»‹ ç­‰ä¸éƒ¨é—¨æœ‰å…³çš„ä¿¡æ¯å†åŠ å…¥å‘˜å·¥ä¿¡æ¯è¡¨ä¸­ã€‚</p><p>å¦‚æœä¸å­˜åœ¨éƒ¨é—¨ä¿¡æ¯è¡¨ï¼Œåˆ™æ ¹æ®ç¬¬ä¸‰èŒƒå¼ï¼ˆ3NFï¼‰ä¹Ÿåº”è¯¥æ„å»ºå®ƒï¼Œå¦åˆ™å°±ä¼šæœ‰å¤§é‡çš„æ•°æ®å†—ä½™ã€‚</p><p><strong>ä¸¾ä¾‹2ï¼š</strong></p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707124011654.png" class=""><p>å•†å“ç±»åˆ«åç§°ä¾èµ–äºå•†å“ç±»åˆ«ç¼–å·ï¼Œä¸ç¬¦åˆç¬¬ä¸‰èŒƒå¼ã€‚</p><p>ä¿®æ”¹ï¼š</p><p>è¡¨1ï¼šç¬¦åˆç¬¬ä¸‰èŒƒå¼çš„ <code>å•†å“ç±»åˆ«è¡¨</code> çš„è®¾è®¡</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707124040899.png" class=""><p>è¡¨2ï¼šç¬¦åˆç¬¬ä¸‰èŒƒå¼çš„ <code>å•†å“è¡¨</code> çš„è®¾è®¡</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707124058174.png" class=""><p>å•†å“è¡¨goodsé€šè¿‡å•†å“ç±»åˆ«idå­—æ®µï¼ˆcategory_idï¼‰ä¸å•†å“ç±»åˆ«è¡¨goods_categoryè¿›è¡Œå…³è”ã€‚</p><p><strong>ä¸¾ä¾‹3ï¼š</strong></p><p><code>çƒå‘˜playerè¡¨</code> ï¼šçƒå‘˜ç¼–å·ã€å§“åã€çƒé˜Ÿåç§°å’Œçƒé˜Ÿä¸»æ•™ç»ƒã€‚ç°åœ¨ï¼Œæˆ‘ä»¬æŠŠå±æ€§ä¹‹é—´çš„ä¾èµ–å…³ç³»ç”»å‡ºæ¥ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º:</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707124136228.png" class=""><p>ä½ èƒ½çœ‹åˆ°çƒå‘˜ç¼–å·å†³å®šäº†çƒé˜Ÿåç§°ï¼ŒåŒæ—¶çƒé˜Ÿåç§°å†³å®šäº†çƒé˜Ÿä¸»æ•™ç»ƒï¼Œéä¸»å±æ€§çƒé˜Ÿä¸»æ•™ç»ƒå°±ä¼šä¼ é€’ä¾ èµ–äºçƒå‘˜ç¼–å·ï¼Œå› æ­¤ä¸ç¬¦åˆ 3NF çš„è¦æ±‚ã€‚</p><p>å¦‚æœè¦è¾¾åˆ° 3NF çš„è¦æ±‚ï¼Œéœ€è¦æŠŠæ•°æ®è¡¨æ‹†æˆä¸‹é¢è¿™æ ·ï¼š</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707124152312.png" class=""><p><strong>ä¸¾ä¾‹4ï¼š</strong></p><p>ä¿®æ”¹ç¬¬äºŒèŒƒå¼ä¸­çš„ä¸¾ä¾‹3ã€‚</p><p>æ­¤æ—¶çš„Orderså…³ç³»åŒ…å« orderidã€orderdateã€customerid å’Œ companyname å±æ€§ï¼Œä¸»é”®å®šä¹‰ä¸º orderidã€‚ customerid å’Œcompanynameå‡ä¾èµ–äºä¸»é”®â€”â€”orderidã€‚ä¾‹å¦‚ï¼Œä½ éœ€è¦é€šè¿‡orderidä¸»é”®æ¥æŸ¥æ‰¾ä»£è¡¨è®¢å•ä¸­ å®¢æˆ·çš„customeridï¼ŒåŒæ ·ï¼Œä½ éœ€è¦é€šè¿‡ orderid ä¸»é”®æŸ¥æ‰¾è®¢å•ä¸­å®¢æˆ·çš„å…¬å¸åç§°ï¼ˆcompanynameï¼‰ã€‚ç„¶ è€Œï¼Œ customeridå’Œcompanynameä¹Ÿæ˜¯äº’ç›¸ä¾é çš„ã€‚ä¸ºæ»¡è¶³ç¬¬ä¸‰èŒƒå¼ï¼Œå¯ä»¥æ”¹å†™å¦‚ä¸‹ï¼š</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707124212114.png" class=""><blockquote><p>ç¬¦åˆ3NFåçš„æ•°æ®æ¨¡å‹é€šä¿—åœ°è®²ï¼Œ2NFå’Œ3NFé€šå¸¸ä»¥è¿™å¥è¯æ¦‚æ‹¬ï¼šâ€œæ¯ä¸ªéé”®å±æ€§ä¾èµ–äºé”®ï¼Œä¾èµ–äº æ•´ä¸ªé”®ï¼Œå¹¶ä¸”é™¤äº†é”®åˆ«æ— ä»–ç‰©â€ã€‚</p></blockquote><h3 id="2-7-å°ç»“"><a href="#2-7-å°ç»“" class="headerlink" title="2.7 å°ç»“"></a>2.7 å°ç»“</h3><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707124343085.png" class=""><h2 id="3-åèŒƒå¼åŒ–"><a href="#3-åèŒƒå¼åŒ–" class="headerlink" title="3. åèŒƒå¼åŒ–"></a>3. åèŒƒå¼åŒ–</h2><h3 id="3-1-æ¦‚è¿°"><a href="#3-1-æ¦‚è¿°" class="headerlink" title="3.1 æ¦‚è¿°"></a>3.1 æ¦‚è¿°</h3><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707124741675.png" class=""><p><strong>è§„èŒƒåŒ– vs æ€§èƒ½</strong></p><blockquote><ol><li>ä¸ºæ»¡è¶³æŸç§å•†ä¸šç›®æ ‡ , æ•°æ®åº“æ€§èƒ½æ¯”è§„èŒƒåŒ–æ•°æ®åº“æ›´é‡è¦ </li><li>åœ¨æ•°æ®è§„èŒƒåŒ–çš„åŒæ—¶ , è¦ç»¼åˆè€ƒè™‘æ•°æ®åº“çš„æ€§èƒ½ </li><li>é€šè¿‡åœ¨ç»™å®šçš„è¡¨ä¸­æ·»åŠ é¢å¤–çš„å­—æ®µï¼Œä»¥å¤§é‡å‡å°‘éœ€è¦ä»ä¸­æœç´¢ä¿¡æ¯æ‰€éœ€çš„æ—¶é—´ </li><li>é€šè¿‡åœ¨ç»™å®šçš„è¡¨ä¸­æ’å…¥è®¡ç®—åˆ—ï¼Œä»¥æ–¹ä¾¿æŸ¥è¯¢</li></ol></blockquote><h3 id="3-2-åº”ç”¨ä¸¾ä¾‹"><a href="#3-2-åº”ç”¨ä¸¾ä¾‹" class="headerlink" title="3.2 åº”ç”¨ä¸¾ä¾‹"></a>3.2 åº”ç”¨ä¸¾ä¾‹</h3><p><strong>ä¸¾ä¾‹1ï¼š</strong></p><p>å‘˜å·¥çš„ä¿¡æ¯å­˜å‚¨åœ¨ <code>employees è¡¨</code> ä¸­ï¼Œéƒ¨é—¨ä¿¡æ¯å­˜å‚¨åœ¨ <code>departments è¡¨</code> ä¸­ã€‚é€šè¿‡ employees è¡¨ä¸­çš„ department_idå­—æ®µä¸ departments è¡¨å»ºç«‹å…³è”å…³ç³»ã€‚å¦‚æœè¦æŸ¥è¯¢ä¸€ä¸ªå‘˜å·¥æ‰€åœ¨éƒ¨é—¨çš„åç§°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">select employee_id,department_name</span><br><span class="line">from employees e join departments d</span><br><span class="line">on e.department_id = d.department_id;</span><br></pre></td></tr></table></figure><p>å¦‚æœç»å¸¸éœ€è¦è¿›è¡Œè¿™ä¸ªæ“ä½œï¼Œè¿æ¥æŸ¥è¯¢å°±ä¼šæµªè´¹å¾ˆå¤šæ—¶é—´ã€‚å¯ä»¥åœ¨ employees è¡¨ä¸­å¢åŠ ä¸€ä¸ªå†—ä½™å­—æ®µ department_nameï¼Œè¿™æ ·å°±ä¸ç”¨æ¯æ¬¡éƒ½è¿›è¡Œè¿æ¥æ“ä½œäº†ã€‚</p><p><strong>ä¸¾ä¾‹2ï¼š</strong></p><p>åèŒƒå¼åŒ–çš„ <code>goodså•†å“ä¿¡æ¯è¡¨</code> è®¾è®¡å¦‚ä¸‹ï¼š</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707125118808.png" class=""><p><strong>ä¸¾ä¾‹3ï¼š</strong></p><p>æˆ‘ä»¬æœ‰ 2 ä¸ªè¡¨ï¼Œåˆ†åˆ«æ˜¯ <code>å•†å“æµæ°´è¡¨ï¼ˆatguigu.trans ï¼‰</code>å’Œ <code>å•†å“ä¿¡æ¯è¡¨ ï¼ˆatguigu.goodsinfoï¼‰</code> ã€‚å•†å“æµæ°´è¡¨é‡Œæœ‰ 400 ä¸‡æ¡æµæ°´è®°å½•ï¼Œå•†å“ä¿¡æ¯è¡¨é‡Œæœ‰ 2000 æ¡å•†å“è®°å½•ã€‚</p><p>å•†å“æµæ°´è¡¨ï¼š</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707125401029.png" class=""><p>å•†å“ä¿¡æ¯è¡¨ï¼š</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707125447317.png" class=""><p>æ–°çš„å•†å“æµæ°´è¡¨å¦‚ä¸‹æ‰€ç¤ºï¼š</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707125500378.png" class=""><p><strong>ä¸¾ä¾‹4ï¼š</strong></p><p><code>è¯¾ç¨‹è¯„è®ºè¡¨ class_comment</code> ï¼Œå¯¹åº”çš„å­—æ®µåç§°åŠå«ä¹‰å¦‚ä¸‹ï¼š</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707125531172.png" class=""><p><code>å­¦ç”Ÿè¡¨ student</code> ï¼Œå¯¹åº”çš„å­—æ®µåç§°åŠå«ä¹‰å¦‚ä¸‹ï¼š</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707125545891.png" class=""><p>åœ¨å®é™…åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬åœ¨æ˜¾ç¤ºè¯¾ç¨‹è¯„è®ºçš„æ—¶å€™ï¼Œé€šå¸¸ä¼šæ˜¾ç¤ºè¿™ä¸ªå­¦ç”Ÿçš„æ˜µç§°ï¼Œè€Œä¸æ˜¯å­¦ç”Ÿ IDï¼Œå› æ­¤å½“æˆ‘ä»¬ æƒ³è¦æŸ¥è¯¢æŸä¸ªè¯¾ç¨‹çš„å‰ 1000 æ¡è¯„è®ºæ—¶ï¼Œéœ€è¦å…³è” class_comment å’Œ studentè¿™ä¸¤å¼ è¡¨æ¥è¿›è¡ŒæŸ¥è¯¢ã€‚</p><p><strong>å®éªŒæ•°æ®ï¼šæ¨¡æ‹Ÿä¸¤å¼ ç™¾ä¸‡é‡çº§çš„æ•°æ®è¡¨</strong></p><p>ä¸ºäº†æ›´å¥½åœ°è¿›è¡Œ SQL ä¼˜åŒ–å®éªŒï¼Œæˆ‘ä»¬éœ€è¦ç»™å­¦ç”Ÿè¡¨å’Œè¯¾ç¨‹è¯„è®ºè¡¨éšæœºæ¨¡æ‹Ÿå‡ºç™¾ä¸‡é‡çº§çš„æ•°æ®ã€‚æˆ‘ä»¬å¯ä»¥ é€šè¿‡å­˜å‚¨è¿‡ç¨‹æ¥å®ç°æ¨¡æ‹Ÿæ•°æ®ã€‚</p><p><strong>åèŒƒå¼ä¼˜åŒ–å®éªŒå¯¹æ¯”</strong></p><p>å¦‚æœæˆ‘ä»¬æƒ³è¦æŸ¥è¯¢è¯¾ç¨‹ ID ä¸º 10001 çš„å‰ 1000 æ¡è¯„è®ºï¼Œéœ€è¦å†™æˆä¸‹é¢è¿™æ ·ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">SELECT p.comment_text, p.comment_time, stu.stu_name</span><br><span class="line">FROM class_comment AS p LEFT JOIN student AS stu</span><br><span class="line">ON p.stu_id = stu.stu_id</span><br><span class="line">WHERE p.class_id = 10001</span><br><span class="line">ORDER BY p.comment_id DESC</span><br><span class="line">LIMIT 1000;</span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœï¼ˆ1000 æ¡æ•°æ®è¡Œï¼‰ï¼š</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707125642908.png" class=""><p>è¿è¡Œæ—¶é•¿ä¸º 0.395 ç§’ï¼Œå¯¹äºç½‘ç«™çš„å“åº”æ¥è¯´ï¼Œè¿™å·²ç»å¾ˆæ…¢äº†ï¼Œç”¨æˆ·ä½“éªŒä¼šéå¸¸å·®ã€‚</p><p>å¦‚æœæˆ‘ä»¬æƒ³è¦æå‡æŸ¥è¯¢çš„æ•ˆç‡ï¼Œå¯ä»¥å…è®¸é€‚å½“çš„æ•°æ®å†—ä½™ï¼Œä¹Ÿå°±æ˜¯åœ¨å•†å“è¯„è®ºè¡¨ä¸­å¢åŠ ç”¨æˆ·æ˜µç§°å­—æ®µï¼Œ åœ¨ class_comment æ•°æ®è¡¨çš„åŸºç¡€ä¸Šå¢åŠ  stu_name å­—æ®µï¼Œå°±å¾—åˆ°äº† class_comment2 æ•°æ®è¡¨ã€‚</p><p>è¿™æ ·ä¸€æ¥ï¼Œåªéœ€å•è¡¨æŸ¥è¯¢å°±å¯ä»¥å¾—åˆ°æ•°æ®é›†ç»“æœï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SELECT comment_text, comment_time, stu_name</span><br><span class="line">FROM class_comment2</span><br><span class="line">WHERE class_id = 10001</span><br><span class="line">ORDER BY class_id DESC LIMIT 1000;</span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœï¼ˆ1000 æ¡æ•°æ®ï¼‰ï¼š</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707125718469.png" class=""><p>ä¼˜åŒ–ä¹‹ååªéœ€è¦æ‰«æä¸€æ¬¡èšé›†ç´¢å¼•å³å¯ï¼Œè¿è¡Œæ—¶é—´ä¸º 0.039 ç§’ï¼ŒæŸ¥è¯¢æ—¶é—´æ˜¯ä¹‹å‰çš„ 1&#x2F;10ã€‚ ä½ èƒ½çœ‹åˆ°ï¼Œ åœ¨æ•°æ®é‡å¤§çš„æƒ…å†µä¸‹ï¼ŒæŸ¥è¯¢æ•ˆç‡ä¼šæœ‰æ˜¾è‘—çš„æå‡ã€‚</p><h3 id="3-3-åèŒƒå¼çš„æ–°é—®é¢˜"><a href="#3-3-åèŒƒå¼çš„æ–°é—®é¢˜" class="headerlink" title="3.3 åèŒƒå¼çš„æ–°é—®é¢˜"></a>3.3 åèŒƒå¼çš„æ–°é—®é¢˜</h3><ul><li>å­˜å‚¨ ç©ºé—´å˜å¤§äº† </li><li>ä¸€ä¸ªè¡¨ä¸­å­—æ®µåšäº†ä¿®æ”¹ï¼Œå¦ä¸€ä¸ªè¡¨ä¸­å†—ä½™çš„å­—æ®µä¹Ÿéœ€è¦åšåŒæ­¥ä¿®æ”¹ï¼Œå¦åˆ™ æ•°æ®ä¸ä¸€è‡´ </li><li>è‹¥é‡‡ç”¨å­˜å‚¨è¿‡ç¨‹æ¥æ”¯æŒæ•°æ®çš„æ›´æ–°ã€åˆ é™¤ç­‰é¢å¤–æ“ä½œï¼Œå¦‚æœæ›´æ–°é¢‘ç¹ï¼Œä¼šéå¸¸ æ¶ˆè€—ç³»ç»Ÿèµ„æº </li><li>åœ¨ æ•°æ®é‡å° çš„æƒ…å†µä¸‹ï¼ŒåèŒƒå¼ä¸èƒ½ä½“ç°æ€§èƒ½çš„ä¼˜åŠ¿ï¼Œå¯èƒ½è¿˜ä¼šè®©æ•°æ®åº“çš„è®¾è®¡æ›´åŠ å¤æ‚</li></ul><h3 id="3-4-åèŒƒå¼çš„é€‚ç”¨åœºæ™¯"><a href="#3-4-åèŒƒå¼çš„é€‚ç”¨åœºæ™¯" class="headerlink" title="3.4 åèŒƒå¼çš„é€‚ç”¨åœºæ™¯"></a>3.4 åèŒƒå¼çš„é€‚ç”¨åœºæ™¯</h3><p>å½“å†—ä½™ä¿¡æ¯æœ‰ä»·å€¼æˆ–è€…èƒ½ <code>å¤§å¹…åº¦æé«˜æŸ¥è¯¢æ•ˆç‡</code> çš„æ—¶å€™ï¼Œæˆ‘ä»¬æ‰ä¼šé‡‡å–åèŒƒå¼çš„ä¼˜åŒ–ã€‚</p><h4 id="1-å¢åŠ å†—ä½™å­—æ®µçš„å»ºè®®"><a href="#1-å¢åŠ å†—ä½™å­—æ®µçš„å»ºè®®" class="headerlink" title="1. å¢åŠ å†—ä½™å­—æ®µçš„å»ºè®®"></a>1. å¢åŠ å†—ä½™å­—æ®µçš„å»ºè®®</h4><p>å¢åŠ å†—ä½™å­—æ®µä¸€å®šè¦ç¬¦åˆå¦‚ä¸‹ä¸¤ä¸ªæ¡ä»¶ã€‚åªè¦æ»¡è¶³è¿™ä¸¤ä¸ªæ¡ä»¶ï¼Œæ‰å¯ä»¥è€ƒè™‘å¢åŠ å¤¯ä½™å­—æ®µã€‚</p><p>1ï¼‰è¿™ä¸ªå†—ä½™å­—æ®µ<code>ä¸éœ€è¦ç»å¸¸è¿›è¡Œä¿®æ”¹</code>ã€‚</p><p>2ï¼‰è¿™ä¸ªå†—ä½™å­—æ®µ<code>æŸ¥è¯¢çš„æ—¶å€™ä¸å¯æˆ–ç¼º</code>ã€‚</p><h4 id="2-å†å²å¿«ç…§ã€å†å²æ•°æ®çš„éœ€è¦"><a href="#2-å†å²å¿«ç…§ã€å†å²æ•°æ®çš„éœ€è¦" class="headerlink" title="2. å†å²å¿«ç…§ã€å†å²æ•°æ®çš„éœ€è¦"></a>2. å†å²å¿«ç…§ã€å†å²æ•°æ®çš„éœ€è¦</h4><p>åœ¨ç°å®ç”Ÿæ´»ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸éœ€è¦ä¸€äº›å†—ä½™ä¿¡æ¯ï¼Œæ¯”å¦‚è®¢å•ä¸­çš„æ”¶è´§äººä¿¡æ¯ï¼ŒåŒ…æ‹¬å§“åã€ç”µè¯å’Œåœ°å€ç­‰ã€‚æ¯ æ¬¡å‘ç”Ÿçš„ <code>è®¢å•æ”¶è´§ä¿¡æ¯</code> éƒ½å±äº <code>å†å²å¿«ç…§</code> ï¼Œéœ€è¦è¿›è¡Œä¿å­˜ï¼Œä½†ç”¨æˆ·å¯ä»¥éšæ—¶ä¿®æ”¹è‡ªå·±çš„ä¿¡æ¯ï¼Œè¿™æ—¶ä¿å­˜è¿™ äº›å†—ä½™ä¿¡æ¯æ˜¯éå¸¸æœ‰å¿…è¦çš„ã€‚</p><p>åèŒƒå¼ä¼˜åŒ–ä¹Ÿå¸¸ç”¨åœ¨ <code>æ•°æ®ä»“åº“</code> çš„è®¾è®¡ä¸­ï¼Œå› ä¸ºæ•°æ®ä»“åº“é€šå¸¸<code>å­˜å‚¨å†å²æ•°æ®</code> ï¼Œå¯¹å¢åˆ æ”¹çš„å®æ—¶æ€§è¦æ±‚ä¸ å¼ºï¼Œå¯¹å†å²æ•°æ®çš„åˆ†æéœ€æ±‚å¼ºã€‚è¿™æ—¶é€‚å½“å…è®¸æ•°æ®çš„å†—ä½™åº¦ï¼Œæ›´æ–¹ä¾¿è¿›è¡Œæ•°æ®åˆ†æã€‚</p><p>æˆ‘ç®€å•æ€»ç»“ä¸‹æ•°æ®ä»“åº“å’Œæ•°æ®åº“åœ¨ä½¿ç”¨ä¸Šçš„åŒºåˆ«ï¼š</p><ol><li>æ•°æ®åº“è®¾è®¡çš„ç›®çš„åœ¨äº<code>æ•æ‰æ•°æ®</code>ï¼Œè€Œæ•°æ®ä»“åº“è®¾è®¡çš„ç›®çš„åœ¨äº<code>åˆ†ææ•°æ®</code>ã€‚</li><li>æ•°æ®åº“å¯¹æ•°æ®çš„<code>å¢åˆ æ”¹å®æ—¶æ€§</code>è¦æ±‚å¼ºï¼Œéœ€è¦å­˜å‚¨åœ¨çº¿çš„ç”¨æˆ·æ•°æ®ï¼Œè€Œæ•°æ®ä»“åº“å­˜å‚¨çš„ä¸€èˆ¬æ˜¯<code>å†å²æ•°æ®</code>ã€‚</li><li>æ•°æ®åº“è®¾è®¡éœ€è¦<code>å°½é‡é¿å…å†—ä½™</code>ï¼Œä½†ä¸ºäº†æé«˜æŸ¥è¯¢æ•ˆç‡ä¹Ÿå…è®¸ä¸€å®šçš„<code>å†—ä½™åº¦</code>ï¼Œè€Œæ•°æ®ä»“åº“åœ¨è®¾è®¡ä¸Šæ›´åå‘é‡‡ç”¨åèŒƒå¼è®¾è®¡ï¼Œ</li></ol><h2 id="4-BCNF-å·´æ–¯èŒƒå¼"><a href="#4-BCNF-å·´æ–¯èŒƒå¼" class="headerlink" title="4. BCNF(å·´æ–¯èŒƒå¼)"></a>4. BCNF(å·´æ–¯èŒƒå¼)</h2><p>äººä»¬åœ¨3NFçš„åŸºç¡€ä¸Šè¿›è¡Œäº†æ”¹è¿›ï¼Œæå‡ºäº†å·´æ–¯èŒƒå¼ï¼ˆBCNFï¼‰ï¼Œé¡µè„šå·´æ–¯ - ç§‘å¾·èŒƒå¼ï¼ˆBoyce - Codd Normal Formï¼‰ã€‚BCNFè¢«è®¤ä¸ºæ²¡æœ‰æ–°çš„è®¾è®¡è§„èŒƒåŠ å…¥ï¼Œåªæ˜¯å¯¹ç¬¬ä¸‰èŒƒå¼ä¸­è®¾è®¡è§„èŒƒè¦æ±‚æ›´å¼ºï¼Œä½¿å¾—æ•°æ®åº“å†—ä½™åº¦æ›´å°ã€‚æ‰€ä»¥ï¼Œç§°ä¸ºæ˜¯<code>ä¿®æ­£çš„ç¬¬ä¸‰èŒƒå¼</code>ï¼Œæˆ–<code>æ‰©å……çš„ç¬¬ä¸‰èŒƒå¼</code>ï¼ŒBCNFä¸è¢«ç§°ä¸ºç¬¬å››èŒƒå¼ã€‚</p><p>è‹¥ä¸€ä¸ªå…³ç³»è¾¾åˆ°äº†ç¬¬ä¸‰èŒƒå¼ï¼Œå¹¶ä¸”å®ƒåªæœ‰ä¸€ä¸ªå€™é€‰é”®ï¼Œæˆ–è€…å®ƒçš„æ¯ä¸ªå€™é€‰é”®éƒ½æ˜¯å•å±æ€§ï¼Œåˆ™è¯¥å…³ç³»è‡ªç„¶è¾¾åˆ°BCèŒƒå¼ã€‚</p><p>ä¸€èˆ¬æ¥è¯´ï¼Œä¸€ä¸ªæ•°æ®åº“è®¾ç¬¦åˆ3NFæˆ–è€…BCNFå°±å¯ä»¥äº†ã€‚</p><p><strong>1. æ¡ˆä¾‹</strong></p><p>æˆ‘ä»¬åˆ†æå¦‚ä¸‹è¡¨çš„èŒƒå¼æƒ…å†µï¼š</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707131428597.png" class=""><p>åœ¨è¿™ä¸ªè¡¨ä¸­ï¼Œä¸€ä¸ªä»“åº“åªæœ‰ä¸€ä¸ªç®¡ç†å‘˜ï¼ŒåŒæ—¶ä¸€ä¸ªç®¡ç†å‘˜ä¹Ÿåªç®¡ç†ä¸€ä¸ªä»“åº“ã€‚æˆ‘ä»¬å…ˆæ¥æ¢³ç†ä¸‹è¿™äº›å±æ€§ä¹‹é—´çš„ä¾èµ–å…³ç³»ã€‚</p><p>ä»“åº“åå†³å®šäº†ç®¡ç†å‘˜ï¼Œç®¡ç†å‘˜ä¹Ÿå†³å®šäº†ä»“åº“åï¼ŒåŒæ—¶ï¼ˆä»“åº“åï¼Œç‰©å“åï¼‰çš„å±æ€§é›†åˆå¯ä»¥å†³å®šæ•°é‡è¿™ä¸ª å±æ€§ã€‚è¿™æ ·ï¼Œæˆ‘ä»¬å°±å¯ä»¥æ‰¾åˆ°æ•°æ®è¡¨çš„å€™é€‰é”®ã€‚</p><p><code>å€™é€‰é”® </code>ï¼šæ˜¯ï¼ˆç®¡ç†å‘˜ï¼Œç‰©å“åï¼‰å’Œï¼ˆä»“åº“åï¼Œç‰©å“åï¼‰ï¼Œç„¶åæˆ‘ä»¬ä»å€™é€‰é”®ä¸­é€‰æ‹©ä¸€ä¸ªä½œä¸ºä¸»é”® ï¼Œæ¯” å¦‚ï¼ˆä»“åº“åï¼Œç‰©å“åï¼‰ã€‚</p><p><code>ä¸»å±æ€§</code> ï¼šåŒ…å«åœ¨ä»»ä¸€å€™é€‰é”®ä¸­çš„å±æ€§ï¼Œä¹Ÿå°±æ˜¯ä»“åº“åï¼Œç®¡ç†å‘˜å’Œç‰©å“åã€‚</p><p><code>éä¸»å±æ€§</code> ï¼šæ•°é‡è¿™ä¸ªå±æ€§ã€‚</p><p><strong>2. æ˜¯å¦ç¬¦åˆä¸‰èŒƒå¼</strong></p><p>å¦‚ä½•åˆ¤æ–­ä¸€å¼ è¡¨çš„èŒƒå¼å‘¢ï¼Ÿæˆ‘ä»¬éœ€è¦æ ¹æ®èŒƒå¼çš„ç­‰çº§ï¼Œä»ä½åˆ°é«˜æ¥è¿›è¡Œåˆ¤æ–­ã€‚</p><p>é¦–å…ˆï¼Œæ•°æ®è¡¨æ¯ä¸ªå±æ€§éƒ½æ˜¯åŸå­æ€§çš„ï¼Œç¬¦åˆ 1NF çš„è¦æ±‚ï¼›</p><p>å…¶æ¬¡ï¼Œæ•°æ®è¡¨ä¸­éä¸»å±æ€§â€æ•°é‡â€œéƒ½ä¸å€™é€‰é”®å…¨éƒ¨ä¾èµ–ï¼Œï¼ˆä»“åº“åï¼Œç‰©å“åï¼‰å†³å®šæ•°é‡ï¼Œï¼ˆç®¡ç†å‘˜ï¼Œç‰©å“ åï¼‰å†³å®šæ•°é‡ã€‚å› æ­¤ï¼Œæ•°æ®è¡¨ç¬¦åˆ 2NF çš„è¦æ±‚ï¼›</p><p>æœ€åï¼Œæ•°æ®è¡¨ä¸­çš„éä¸»å±æ€§ï¼Œä¸ä¼ é€’ä¾èµ–äºå€™é€‰é”®ã€‚å› æ­¤ç¬¦åˆ 3NF çš„è¦æ±‚ã€‚</p><p><strong>3. å­˜åœ¨çš„é—®é¢˜</strong></p><p>æ—¢ç„¶æ•°æ®è¡¨å·²ç»ç¬¦åˆäº† 3NF çš„è¦æ±‚ï¼Œæ˜¯ä¸æ˜¯å°±ä¸å­˜åœ¨é—®é¢˜äº†å‘¢ï¼Ÿæˆ‘ä»¬æ¥çœ‹ä¸‹é¢çš„æƒ…å†µï¼š</p><ol><li>å¢åŠ ä¸€ä¸ªä»“åº“ï¼Œä½†æ˜¯è¿˜æ²¡æœ‰å­˜æ”¾ä»»ä½•ç‰©å“ã€‚æ ¹æ®æ•°æ®è¡¨å®ä½“å®Œæ•´æ€§çš„è¦æ±‚ï¼Œä¸»é”®ä¸èƒ½æœ‰ç©ºå€¼ï¼Œå›  æ­¤ä¼šå‡ºç° æ’å…¥å¼‚å¸¸ ï¼›</li><li>å¦‚æœä»“åº“æ›´æ¢äº†ç®¡ç†å‘˜ï¼Œæˆ‘ä»¬å°±å¯èƒ½ä¼šä¿®æ”¹æ•°æ®è¡¨ä¸­çš„å¤šæ¡è®°å½• ï¼›</li><li>å¦‚æœä»“åº“é‡Œçš„å•†å“éƒ½å–ç©ºäº†ï¼Œé‚£ä¹ˆæ­¤æ—¶ä»“åº“åç§°å’Œç›¸åº”çš„ç®¡ç†å‘˜åç§°ä¹Ÿä¼šéšä¹‹è¢«åˆ é™¤ã€‚</li></ol><p>ä½ èƒ½çœ‹åˆ°ï¼Œå³ä¾¿æ•°æ®è¡¨ç¬¦åˆ 3NF çš„è¦æ±‚ï¼ŒåŒæ ·å¯èƒ½å­˜åœ¨æ’å…¥ï¼Œæ›´æ–°å’Œåˆ é™¤æ•°æ®çš„å¼‚å¸¸æƒ…å†µã€‚</p><p><strong>4. é—®é¢˜è§£å†³</strong></p><p>é¦–å…ˆæˆ‘ä»¬éœ€è¦ç¡®è®¤é€ æˆå¼‚å¸¸çš„åŸå› ï¼šä¸»å±æ€§ä»“åº“åå¯¹äºå€™é€‰é”®ï¼ˆç®¡ç†å‘˜ï¼Œç‰©å“åï¼‰æ˜¯éƒ¨åˆ†ä¾èµ–çš„å…³ç³»ï¼Œ è¿™æ ·å°±æœ‰å¯èƒ½å¯¼è‡´ä¸Šé¢çš„å¼‚å¸¸æƒ…å†µã€‚å› æ­¤å¼•å…¥BCNFï¼Œ<strong>å®ƒåœ¨ 3NF çš„åŸºç¡€ä¸Šæ¶ˆé™¤äº†ä¸»å±æ€§å¯¹å€™é€‰é”®çš„éƒ¨åˆ†ä¾èµ–æˆ–è€…ä¼ é€’ä¾èµ–å…³ç³»</strong>ã€‚</p><ul><li>å¦‚æœåœ¨å…³ç³»Rä¸­ï¼ŒUä¸ºä¸»é”®ï¼ŒAå±æ€§æ˜¯ä¸»é”®çš„ä¸€ä¸ªå±æ€§ï¼Œè‹¥å­˜åœ¨A-&gt;Yï¼ŒYä¸ºä¸»å±æ€§ï¼Œåˆ™è¯¥å…³ç³»ä¸å±äº BCNFã€‚</li></ul><p>æ ¹æ® BCNF çš„è¦æ±‚ï¼Œæˆ‘ä»¬éœ€è¦æŠŠä»“åº“ç®¡ç†å…³ç³» warehouse_keeper è¡¨æ‹†åˆ†æˆä¸‹é¢è¿™æ ·ï¼š</p><p><code>ä»“åº“è¡¨</code> ï¼šï¼ˆä»“åº“åï¼Œç®¡ç†å‘˜ï¼‰</p><p><code>åº“å­˜è¡¨ </code>ï¼šï¼ˆä»“åº“åï¼Œç‰©å“åï¼Œæ•°é‡ï¼‰</p><p>è¿™æ ·å°±ä¸å­˜åœ¨ä¸»å±æ€§å¯¹äºå€™é€‰é”®çš„éƒ¨åˆ†ä¾èµ–æˆ–ä¼ é€’ä¾èµ–ï¼Œä¸Šé¢æ•°æ®è¡¨çš„è®¾è®¡å°±ç¬¦åˆ BCNFã€‚</p><p>å†ä¸¾ä¾‹ï¼š</p><p>æœ‰ä¸€ä¸ª <code>å­¦ç”Ÿå¯¼å¸ˆè¡¨</code> ï¼Œå…¶ä¸­åŒ…å«å­—æ®µï¼šå­¦ç”ŸIDï¼Œä¸“ä¸šï¼Œå¯¼å¸ˆï¼Œä¸“ä¸šGPAï¼Œè¿™å…¶ä¸­å­¦ç”ŸIDå’Œä¸“ä¸šæ˜¯è”åˆä¸»é”®ã€‚</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707132038425.png" class=""><p>è¿™ä¸ªè¡¨çš„è®¾è®¡æ»¡è¶³ä¸‰èŒƒå¼ï¼Œä½†æ˜¯è¿™é‡Œå­˜åœ¨å¦ä¸€ä¸ªä¾èµ–å…³ç³»ï¼Œâ€œä¸“ä¸šâ€ä¾èµ–äºâ€œå¯¼å¸ˆâ€ï¼Œä¹Ÿå°±æ˜¯è¯´æ¯ä¸ªå¯¼å¸ˆåªåšä¸€ä¸ªä¸“ä¸šæ–¹é¢çš„å¯¼å¸ˆï¼Œåªè¦çŸ¥é“äº†æ˜¯å“ªä¸ªå¯¼å¸ˆï¼Œæˆ‘ä»¬è‡ªç„¶å°±çŸ¥é“æ˜¯å“ªä¸ªä¸“ä¸šçš„äº†ã€‚</p><p>æ‰€ä»¥è¿™ä¸ªè¡¨çš„éƒ¨åˆ†ä¸»é”®Majorä¾èµ–äºéä¸»é”®å±æ€§Advisorï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥è¿›è¡Œä»¥ä¸‹çš„è°ƒæ•´ï¼Œæ‹†åˆ†æˆ2ä¸ªè¡¨ï¼š</p><p>å­¦ç”Ÿå¯¼å¸ˆè¡¨ï¼š</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707132344634.png" class=""><p>å¯¼å¸ˆè¡¨ï¼š</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707132355841.png" class=""><h2 id="5-ç¬¬å››èŒƒå¼"><a href="#5-ç¬¬å››èŒƒå¼" class="headerlink" title="5. ç¬¬å››èŒƒå¼"></a>5. ç¬¬å››èŒƒå¼</h2><p>å¤šå€¼ä¾èµ–çš„æ¦‚å¿µï¼š</p><ul><li><code>å¤šå€¼ä¾èµ–</code>å³å±æ€§ä¹‹é—´çš„ä¸€å¯¹å¤šå…³ç³»ï¼Œè®°ä¸ºKâ€”&gt;â€”&gt;Aã€‚</li><li><code>å‡½æ•°ä¾èµ–</code>äº‹å®ä¸Šæ˜¯å•å€¼ä¾èµ–ï¼Œæ‰€ä»¥ä¸èƒ½è¡¨è¾¾å±æ€§å€¼ä¹‹é—´çš„ä¸€å¯¹å¤šå…³ç³»ã€‚</li><li><code>å¹³å‡¡çš„å¤šå€¼ä¾èµ–</code>ï¼šå…¨é›†U&#x3D;K+Aï¼Œä¸€ä¸ªKå¯ä»¥å¯¹åº”äºå¤šä¸ªAï¼Œå³Kâ€”&gt;â€”&gt;Aã€‚æ­¤æ—¶æ•´ä¸ªè¡¨å°±æ˜¯ä¸€ç»„ä¸€å¯¹å¤šå…³ç³»ã€‚</li><li><code>éå¹³å‡¡çš„å¤šå€¼ä¾èµ–</code>ï¼šå…¨é›†U&#x3D;K+A+Bï¼Œä¸€ä¸ªKå¯ä»¥å¯¹åº”äºå¤šä¸ªAï¼Œä¹Ÿå¯ä»¥å¯¹åº”äºå¤šä¸ªBï¼ŒAä¸Bç›¸äº’ç‹¬ç«‹ï¼Œå³Kâ€”&gt;â€”&gt;Aï¼ŒKâ€”&gt;â€”&gt;Bã€‚æ•´ä¸ªè¡¨æœ‰å¤šç»„ä¸€å¯¹å¤šå…³ç³»ï¼Œä¸”æœ‰ï¼šâ€ä¸€â€éƒ¨åˆ†æ˜¯ç›¸åŒçš„å±æ€§é›†åˆï¼Œâ€œå¤šâ€éƒ¨åˆ†æ˜¯ç›¸äº’ç‹¬ç«‹çš„å±æ€§é›†åˆã€‚</li></ul><p>ç¬¬å››èŒƒå¼å³åœ¨æ»¡è¶³å·´æ–¯ - ç§‘å¾·èŒƒå¼ï¼ˆBCNFï¼‰çš„åŸºç¡€ä¸Šï¼Œæ¶ˆé™¤éå¹³å‡¡ä¸”éå‡½æ•°ä¾èµ–çš„å¤šå€¼ä¾èµ–ï¼ˆå³æŠŠåŒä¸€è¡¨çš„å¤šå¯¹å¤šå…³ç³»åˆ é™¤ï¼‰ã€‚</p><p><strong>ä¸¾ä¾‹1ï¼š</strong>èŒå·¥è¡¨(èŒå·¥ç¼–å·ï¼ŒèŒå·¥å­©å­å§“åï¼ŒèŒå·¥é€‰ä¿®è¯¾ç¨‹)ã€‚</p><p>åœ¨è¿™ä¸ªè¡¨ä¸­ï¼ŒåŒä¸€ä¸ªèŒå·¥å¯èƒ½ä¼šæœ‰å¤šä¸ªèŒå·¥å­©å­å§“åã€‚åŒæ ·ï¼ŒåŒä¸€ä¸ªèŒå·¥ä¹Ÿå¯èƒ½ä¼šæœ‰å¤šä¸ªèŒå·¥é€‰ä¿®è¯¾ç¨‹ï¼Œå³è¿™é‡Œå­˜åœ¨ç€å¤šå€¼äº‹å®ï¼Œä¸ç¬¦åˆç¬¬å››èŒƒå¼ã€‚</p><p>å¦‚æœè¦ç¬¦åˆç¬¬å››èŒƒå¼ï¼Œåªéœ€è¦å°†ä¸Šè¡¨åˆ†ä¸ºä¸¤ä¸ªè¡¨ï¼Œä½¿å®ƒä»¬åªæœ‰ä¸€ä¸ªå¤šå€¼äº‹å®ï¼Œä¾‹å¦‚ï¼š <code>èŒå·¥è¡¨ä¸€</code> (èŒå·¥ç¼– å·ï¼ŒèŒå·¥å­©å­å§“å)ï¼Œ <code>èŒå·¥è¡¨äºŒ</code>(èŒå·¥ç¼–å·ï¼ŒèŒå·¥é€‰ä¿®è¯¾ç¨‹)ï¼Œä¸¤ä¸ªè¡¨éƒ½åªæœ‰ä¸€ä¸ªå¤šå€¼äº‹å®ï¼Œæ‰€ä»¥ç¬¦åˆç¬¬å››èŒƒå¼ã€‚</p><p><strong>ä¸¾ä¾‹2ï¼š</strong></p><p>æ¯”å¦‚æˆ‘ä»¬å»ºç«‹è¯¾ç¨‹ã€æ•™å¸ˆã€æ•™æçš„æ¨¡å‹ã€‚æˆ‘ä»¬è§„å®šï¼Œæ¯é—¨è¯¾ç¨‹æœ‰å¯¹åº”çš„ä¸€ç»„æ•™å¸ˆï¼Œæ¯é—¨è¯¾ç¨‹ä¹Ÿæœ‰å¯¹åº”çš„ä¸€ç»„æ•™æï¼Œä¸€é—¨è¯¾ç¨‹ä½¿ç”¨çš„æ•™æå’Œæ•™å¸ˆæ²¡æœ‰å…³ç³»ã€‚æˆ‘ä»¬å»ºç«‹çš„å…³ç³»è¡¨å¦‚ä¸‹ï¼š</p><p>è¯¾ç¨‹IDï¼Œæ•™å¸ˆIDï¼Œæ•™æIDï¼›è¿™ä¸‰åˆ—ä½œä¸ºè”åˆä¸»é”®ã€‚</p><p>ä¸ºäº†è¡¨è¿°æ–¹ä¾¿ï¼Œæˆ‘ä»¬ç”¨Nameä»£æ›¿IDï¼Œè¿™æ ·æ›´å®¹æ˜“çœ‹æ‡‚ï¼š</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707133830721.png" class=""><p>è¿™ä¸ªè¡¨é™¤äº†ä¸»é”®ï¼Œå°±æ²¡æœ‰å…¶ä»–å­—æ®µäº†ï¼Œæ‰€ä»¥è‚¯å®šæ»¡è¶³BCèŒƒå¼ï¼Œä½†æ˜¯å´å­˜åœ¨ <code>å¤šå€¼ä¾èµ–</code> å¯¼è‡´çš„å¼‚å¸¸ã€‚</p><p>å‡å¦‚æˆ‘ä»¬ä¸‹å­¦æœŸæƒ³é‡‡ç”¨ä¸€æœ¬æ–°çš„è‹±ç‰ˆé«˜æ•°æ•™æï¼Œä½†æ˜¯è¿˜æ²¡ç¡®å®šå…·ä½“å“ªä¸ªè€å¸ˆæ¥æ•™ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±æ— æ³•åœ¨è¿™ ä¸ªè¡¨ä¸­ç»´æŠ¤Courseé«˜æ•°å’ŒBookè‹±ç‰ˆé«˜æ•°æ•™æçš„çš„å…³ç³»ã€‚</p><p>è§£å†³åŠæ³•æ˜¯æˆ‘ä»¬æŠŠè¿™ä¸ªå¤šå€¼ä¾èµ–çš„è¡¨æ‹†è§£æˆ2ä¸ªè¡¨ï¼Œåˆ†åˆ«å»ºç«‹å…³ç³»ã€‚è¿™æ˜¯æˆ‘ä»¬æ‹†åˆ†åçš„è¡¨ï¼š</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707134028730.png" class=""><p>ä»¥åŠ</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707134220820.png" class=""><h2 id="6-ç¬¬äº”èŒƒå¼ã€åŸŸé”®èŒƒå¼"><a href="#6-ç¬¬äº”èŒƒå¼ã€åŸŸé”®èŒƒå¼" class="headerlink" title="6. ç¬¬äº”èŒƒå¼ã€åŸŸé”®èŒƒå¼"></a>6. ç¬¬äº”èŒƒå¼ã€åŸŸé”®èŒƒå¼</h2><p>é™¤äº†ç¬¬å››èŒƒå¼å¤–ï¼Œæˆ‘ä»¬è¿˜æœ‰æ›´é«˜çº§çš„ç¬¬äº”èŒƒå¼ï¼ˆåˆç§°å®Œç¾èŒƒå¼ï¼‰å’ŒåŸŸé”®èŒƒå¼ï¼ˆDKNFï¼‰ã€‚</p><p>åœ¨æ»¡è¶³ç¬¬å››èŒƒå¼ï¼ˆ4NFï¼‰çš„åŸºç¡€ä¸Šï¼Œæ¶ˆé™¤ä¸æ˜¯ç”±å€™é€‰é”®æ‰€è•´å«çš„è¿æ¥ä¾èµ–ã€‚<strong>å¦‚æœå…³ç³»æ¨¡å¼Rä¸­çš„æ¯ä¸€ä¸ªè¿ æ¥ä¾èµ–å‡ç”±Rçš„å€™é€‰é”®æ‰€éšå«</strong>ï¼Œåˆ™ç§°æ­¤å…³ç³»æ¨¡å¼ç¬¦åˆç¬¬äº”èŒƒå¼ã€‚</p><p>å‡½æ•°ä¾èµ–æ˜¯å¤šå€¼ä¾èµ–çš„ä¸€ç§ç‰¹æ®Šçš„æƒ…å†µï¼Œè€Œå¤šå€¼ä¾èµ–å®é™…ä¸Šæ˜¯è¿æ¥ä¾èµ–çš„ä¸€ç§ç‰¹æ®Šæƒ…å†µã€‚ä½†è¿æ¥ä¾èµ–ä¸ åƒå‡½æ•°ä¾èµ–å’Œå¤šå€¼ä¾èµ–å¯ä»¥ç”± <code>è¯­ä¹‰ç›´æ¥å¯¼å‡º</code> ï¼Œè€Œæ˜¯åœ¨ <code>å…³ç³»è¿æ¥è¿ç®—</code> æ—¶æ‰åæ˜ å‡ºæ¥ã€‚å­˜åœ¨è¿æ¥ä¾èµ–çš„å…³ç³» æ¨¡å¼ä»å¯èƒ½é‡åˆ°æ•°æ®å†—ä½™åŠæ’å…¥ã€ä¿®æ”¹ã€åˆ é™¤å¼‚å¸¸ç­‰é—®é¢˜ã€‚</p><p>ç¬¬äº”èŒƒå¼å¤„ç†çš„æ˜¯ <code>æ— æŸè¿æ¥é—®é¢˜</code> ï¼Œè¿™ä¸ªèŒƒå¼åŸºæœ¬ <code>æ²¡æœ‰å®é™…æ„ä¹‰</code> ï¼Œå› ä¸ºæ— æŸè¿æ¥å¾ˆå°‘å‡ºç°ï¼Œè€Œä¸”éš¾ä»¥å¯Ÿè§‰ã€‚è€ŒåŸŸé”®èŒƒå¼è¯•å›¾å®šä¹‰ä¸€ä¸ª <code>ç»ˆæèŒƒå¼</code> ï¼Œè¯¥èŒƒå¼è€ƒè™‘æ‰€æœ‰çš„ä¾èµ–å’Œçº¦æŸç±»å‹ï¼Œä½†æ˜¯å®ç”¨ä»·å€¼ä¹Ÿæ˜¯æœ€å°çš„ï¼Œåªå­˜åœ¨ç†è®ºç ”ç©¶ä¸­ã€‚</p><h2 id="7-å®æˆ˜æ¡ˆä¾‹"><a href="#7-å®æˆ˜æ¡ˆä¾‹" class="headerlink" title="7. å®æˆ˜æ¡ˆä¾‹"></a>7. å®æˆ˜æ¡ˆä¾‹</h2><p>å•†è¶…è¿›è´§ç³»ç»Ÿä¸­çš„<code>è¿›è´§å•è¡¨</code>è¿›è¡Œå‰–æï¼š</p><p>è¿›è´§å•è¡¨ï¼š</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707134636225.png" class=""><p>è¿™ä¸ªè¡¨ä¸­çš„å­—æ®µå¾ˆå¤šï¼Œè¡¨é‡Œçš„æ•°æ®é‡ä¹Ÿå¾ˆæƒŠäººã€‚å¤§é‡é‡å¤å¯¼è‡´è¡¨å˜å¾—åºå¤§ï¼Œæ•ˆç‡æä½ã€‚å¦‚ä½•æ”¹é€ ï¼Ÿ</p><blockquote><p>åœ¨å®é™…å·¥ä½œåœºæ™¯ä¸­ï¼Œè¿™ç§ç”±äºæ•°æ®è¡¨ç»“æ„è®¾è®¡ä¸åˆç†ï¼Œè€Œå¯¼è‡´çš„æ•°æ®é‡å¤çš„ç°è±¡å¹¶ä¸å°‘è§ã€‚å¾€å¾€æ˜¯ç³»ç»Ÿè™½ç„¶èƒ½å¤Ÿè¿è¡Œï¼Œæ‰¿è½½èƒ½åŠ›å´å¾ˆå·®ï¼Œç¨å¾®æœ‰ç‚¹æµé‡ï¼Œå°±ä¼šå‡ºç°å†…å­˜ä¸è¶³ã€CPUä½¿ç”¨ç‡é£™å‡çš„æƒ…å†µï¼Œç”šè‡³ä¼šå¯¼è‡´æ•´ä¸ªé¡¹ç›®å¤±è´¥ã€‚</p></blockquote><h3 id="7-1-è¿­ä»£1æ¬¡ï¼šè€ƒè™‘1NF"><a href="#7-1-è¿­ä»£1æ¬¡ï¼šè€ƒè™‘1NF" class="headerlink" title="7.1 è¿­ä»£1æ¬¡ï¼šè€ƒè™‘1NF"></a>7.1 è¿­ä»£1æ¬¡ï¼šè€ƒè™‘1NF</h3><p>ç¬¬ä¸€èŒƒå¼è¦æ±‚ï¼š<strong>æ‰€æœ‰çš„å­—æ®µéƒ½æ˜¯åŸºæœ¬æ•°æ®ç±»å‹ï¼Œä¸å¯è¿›è¡Œæ‹†åˆ†</strong>ã€‚è¿™é‡Œéœ€è¦ç¡®è®¤ï¼Œæ‰€æœ‰çš„åˆ—ä¸­ï¼Œæ¯ä¸ªå­—æ®µåªåŒ…å«ä¸€ç§æ•°æ®ã€‚</p><p>è¿™å¼ è¡¨é‡Œï¼Œæˆ‘ä»¬æŠŠâ€œpropertyâ€è¿™ä¸€å­—æ®µï¼Œæ‹†åˆ†æˆâ€specification (è§„æ ¼)â€ å’Œ â€œunit (å•ä½)â€ï¼Œè¿™ä¸¤ä¸ªå­—æ®µå¦‚ä¸‹ï¼š</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707154400580.png" class=""><h3 id="7-2-è¿­ä»£2æ¬¡ï¼šè€ƒè™‘2NF"><a href="#7-2-è¿­ä»£2æ¬¡ï¼šè€ƒè™‘2NF" class="headerlink" title="7.2 è¿­ä»£2æ¬¡ï¼šè€ƒè™‘2NF"></a>7.2 è¿­ä»£2æ¬¡ï¼šè€ƒè™‘2NF</h3><p>ç¬¬äºŒèŒƒå¼è¦æ±‚ï¼Œåœ¨æ»¡è¶³ç¬¬ä¸€èŒƒå¼çš„åŸºç¡€ä¸Šï¼Œ<strong>è¿˜è¦æ»¡è¶³æ•°æ®è¡¨é‡Œçš„æ¯ä¸€æ¡æ•°æ®è®°å½•ï¼Œéƒ½æ˜¯å¯å”¯ä¸€æ ‡è¯†çš„ã€‚è€Œä¸”æ‰€æœ‰å­—æ®µï¼Œéƒ½å¿…é¡»å®Œå…¨ä¾èµ–ä¸»é”®ï¼Œä¸èƒ½åªä¾èµ–ä¸»é”®çš„ä¸€éƒ¨åˆ†</strong>ã€‚</p><p>ç¬¬1æ­¥ï¼Œå°±æ˜¯è¦ç¡®å®šè¿™ä¸ªè¡¨çš„ä¸»é”®ã€‚é€šè¿‡è§‚å¯Ÿå‘ç°ï¼Œå­—æ®µâ€œlistnumberï¼ˆå•å·ï¼‰â€+â€barcodeï¼ˆæ¡ç ï¼‰â€å¯ä»¥å”¯ä¸€æ ‡è¯†æ¯ä¸€æ¡è®°å½•ï¼Œå¯ä»¥ä½œä¸ºä¸»é”®ã€‚</p><p>ç¬¬2æ­¥ï¼Œç¡®å®šå¥½äº†ä¸»é”®ä»¥åï¼Œåˆ¤æ–­å“ªäº›å­—æ®µå®Œå…¨ä¾èµ–ä¸»é”®ï¼Œå“ªäº›å­—æ®µåªä¾èµ–äºä¸»é”®çš„ä¸€éƒ¨åˆ†ã€‚æŠŠåªä¾èµ–äºä¸»é”®ä¸€éƒ¨åˆ†çš„å­—æ®µæ‹†å‡ºå»ï¼Œå½¢æˆæ–°çš„æ•°æ®è¡¨ã€‚</p><p>é¦–å…ˆï¼Œè¿›è´§å•æ˜ç»†è¡¨é‡Œé¢çš„â€goodsname(åç§°)â€â€specification(è§„æ ¼)â€â€unit(å•ä½)â€è¿™äº›ä¿¡æ¯æ˜¯å•†å“çš„å±æ€§ï¼Œåªä¾èµ–äºâ€batcode(æ¡ç )â€ï¼Œä¸å®Œå…¨ä¾èµ–ä¸»é”®ï¼Œå¯ä»¥æ‹†åˆ†å‡ºå»ã€‚æˆ‘ä»¬æŠŠè¿™3ä¸ªå­—æ®µåŠ ä¸Šå®ƒä»¬æ‰€ä¾èµ–çš„å­—æ®µâ€barcode(æ¡ç )â€ï¼Œæ‹†åˆ†å½¢æˆæ–°çš„æ•°æ®è¡¨â€å•†å“ä¿¡æ¯è¡¨â€ã€‚</p><p>è¿™æ ·ä¸€æ¥ï¼ŒåŸæ¥çš„æ•°æ®è¡¨å°±è¢«æ‹†åˆ†æˆäº†ä¸¤ä¸ªè¡¨ã€‚</p><p>å•†å“ä¿¡æ¯è¡¨ï¼š</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707163807205.png" class=""><p>è¿›è´§å•è¡¨ï¼š</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707163828614.png" class=""><p>æ­¤å¤–ï¼Œå­—æ®µâ€supplierid(ä¾›åº”å•†ç¼–å·)â€â€suppliername(ä¾›åº”å•†åç§°)â€â€stock(ä»“åº“)â€œåªä¾èµ–äºâ€listnumber(å•å·)â€ï¼Œä¸å®Œå…¨ä¾èµ–äºä¸»é”®ï¼Œæ‰€ä»¥ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠâ€supplieridâ€â€suppliernameâ€â€stockâ€è¿™3ä¸ªå­—æ®µæ‹†å‡ºå»ï¼Œå†åŠ ä¸Šå®ƒä»¬ä¾èµ–çš„å­—æ®µâ€listnumber(å•å·)â€ï¼Œå°±å½¢æˆäº†ä¸€ä¸ªæ–°çš„è¡¨â€è¿›è´§å•å¤´è¡¨â€ã€‚å‰©ä¸‹çš„å­—æ®µï¼Œä¼šç»„æˆæ–°çš„è¡¨ï¼Œæˆ‘ä»¬å«å®ƒâ€è¿›è´§å•æ˜ç»†è¡¨â€ã€‚</p><p>åŸæ¥çš„æ•°æ®è¡¨å°±æ‹†åˆ†æˆäº†3ä¸ªè¡¨ã€‚</p><p>è¿›è´§å•å¤´è¡¨ï¼š</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707164128704.png" class=""><p>è¿›è´§å•æ˜ç»†è¡¨ï¼š</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707164146216.png" class=""><p>å•†å“ä¿¡æ¯è¡¨ï¼š</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707164227845.png" class=""><p>ç°åœ¨ï¼Œæˆ‘ä»¬å†æ¥åˆ†æä¸€ä¸‹æ‹†åˆ†åçš„3ä¸ªè¡¨ï¼Œä¿è¯è¿™3ä¸ªè¡¨éƒ½æ»¡è¶³ç¬¬äºŒèŒƒå¼çš„è¦æ±‚ã€‚</p><p>ç¬¬3æ­¥ï¼Œåœ¨â€œå•†å“ä¿¡æ¯è¡¨â€ä¸­ï¼Œå­—æ®µâ€œbarcodeâ€æ˜¯æœ‰<code>å¯èƒ½å­˜åœ¨é‡å¤</code>çš„ï¼Œæ¯”å¦‚ï¼Œç”¨æˆ·é—¨åº—å¯èƒ½æœ‰æ•£è£…ç§°é‡å•†å“å’Œè‡ªäº§å•†å“ï¼Œä¼šå­˜åœ¨æ¡ç å…±ç”¨çš„æƒ…å†µã€‚æ‰€ä»¥ï¼Œæ‰€æœ‰çš„å­—æ®µéƒ½ä¸èƒ½å”¯ä¸€æ ‡è¯†è¡¨é‡Œçš„è®°å½•ã€‚è¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å¿…é¡»ç»™è¿™ä¸ªè¡¨åŠ ä¸Šä¸€ä¸ªä¸»é”®ï¼Œæ¯”å¦‚è¯´æ˜¯<code>è‡ªå¢å­—æ®µ&quot;itemnumber&quot;</code>ã€‚</p><h3 id="7-3-è¿­ä»£3æ¬¡ï¼šè€ƒè™‘3NF"><a href="#7-3-è¿­ä»£3æ¬¡ï¼šè€ƒè™‘3NF" class="headerlink" title="7.3 è¿­ä»£3æ¬¡ï¼šè€ƒè™‘3NF"></a>7.3 è¿­ä»£3æ¬¡ï¼šè€ƒè™‘3NF</h3><p>æˆ‘ä»¬çš„è¿›è´§å•å¤´è¡¨ï¼Œè¿˜æœ‰æ•°æ®å†—ä½™çš„å¯èƒ½ã€‚å› ä¸ºâ€suppliernameâ€ä¾èµ–â€supplieridâ€ï¼Œé‚£ä¹ˆå°±å¯ä»¥æŒ‰ç…§ç¬¬ä¸‰èŒƒå¼çš„åŸåˆ™è¿›è¡Œæ‹†åˆ†äº†ã€‚æˆ‘ä»¬å°±è¿›ä¸€æ­¥æ‹†åˆ†è¿›è´§å•å¤´è¡¨ï¼ŒæŠŠå®ƒæ‹†è§£é™ˆä¾›è´§å•†è¡¨å’Œè¿›è´§å•å¤´è¡¨ã€‚</p><p>ä¾›è´§å•†è¡¨ï¼š</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707165011050.png" class=""><p>è¿›è´§å•å¤´è¡¨ï¼š</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707165038108.png" class=""><p>è¿™2ä¸ªè¡¨éƒ½æ»¡è¶³ç¬¬ä¸‰èŒƒå¼çš„è¦æ±‚äº†ã€‚</p><h3 id="7-4-åèŒƒå¼åŒ–ï¼šä¸šåŠ¡ä¼˜å…ˆçš„åŸåˆ™"><a href="#7-4-åèŒƒå¼åŒ–ï¼šä¸šåŠ¡ä¼˜å…ˆçš„åŸåˆ™" class="headerlink" title="7.4 åèŒƒå¼åŒ–ï¼šä¸šåŠ¡ä¼˜å…ˆçš„åŸåˆ™"></a>7.4 åèŒƒå¼åŒ–ï¼šä¸šåŠ¡ä¼˜å…ˆçš„åŸåˆ™</h3><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707165459547.png" class=""><p>å› æ­¤ï¼Œæœ€åæˆ‘ä»¬å¯ä»¥æŠŠè¿›è´§å•è¡¨æ‹†åˆ†æˆä¸‹é¢çš„4ä¸ªè¡¨ï¼š</p><p>ä¾›è´§å•†è¡¨ï¼š</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707165011050.png" class=""><p>è¿›è´§å•å¤´è¡¨ï¼š</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707165038108.png" class=""><p>è¿›è´§å•æ˜ç»†è¡¨ï¼š</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707164146216.png" class=""><p>å•†å“ä¿¡æ¯è¡¨ï¼š</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707164227845.png" class=""><p>è¿™æ ·ä¸€æ¥ï¼Œæˆ‘ä»¬å°±é¿å…äº†å†—ä½™æ•°æ®ï¼Œè€Œä¸”è¿˜èƒ½å¤Ÿæ»¡è¶³ä¸šåŠ¡çš„éœ€æ±‚ï¼Œè¿™æ ·çš„æ•°æ®åº“è®¾è®¡ï¼Œæ‰æ˜¯åˆæ ¼çš„è®¾è®¡ã€‚</p><h2 id="8-ERæ¨¡å‹"><a href="#8-ERæ¨¡å‹" class="headerlink" title="8. ERæ¨¡å‹"></a>8. ERæ¨¡å‹</h2><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707170027637.png" class=""><h3 id="8-1-ERæ¨¡å‹åŒ…æ‹¬å“ªäº›è¦ç´ ï¼Ÿ"><a href="#8-1-ERæ¨¡å‹åŒ…æ‹¬å“ªäº›è¦ç´ ï¼Ÿ" class="headerlink" title="8.1 ERæ¨¡å‹åŒ…æ‹¬å“ªäº›è¦ç´ ï¼Ÿ"></a>8.1 ERæ¨¡å‹åŒ…æ‹¬å“ªäº›è¦ç´ ï¼Ÿ</h3><p><strong>ER æ¨¡å‹ä¸­æœ‰ä¸‰ä¸ªè¦ç´ ï¼Œåˆ†åˆ«æ˜¯å®ä½“ã€å±æ€§å’Œå…³ç³»ã€‚</strong></p><p><code>å®ä½“</code> ï¼Œå¯ä»¥çœ‹åšæ˜¯æ•°æ®å¯¹è±¡ï¼Œå¾€å¾€å¯¹åº”äºç°å®ç”Ÿæ´»ä¸­çš„çœŸå®å­˜åœ¨çš„ä¸ªä½“ã€‚åœ¨ ER æ¨¡å‹ä¸­ï¼Œç”¨ çŸ©å½¢ æ¥è¡¨ ç¤ºã€‚å®ä½“åˆ†ä¸ºä¸¤ç±»ï¼Œåˆ†åˆ«æ˜¯ å¼ºå®ä½“ å’Œ å¼±å®ä½“ ã€‚å¼ºå®ä½“æ˜¯æŒ‡ä¸ä¾èµ–äºå…¶ä»–å®ä½“çš„å®ä½“ï¼›å¼±å®ä½“æ˜¯æŒ‡å¯¹å¦ ä¸€ä¸ªå®ä½“æœ‰å¾ˆå¼ºçš„ä¾èµ–å…³ç³»çš„å®ä½“ã€‚</p><p><code>å±æ€§</code> ï¼Œåˆ™æ˜¯æŒ‡å®ä½“çš„ç‰¹æ€§ã€‚æ¯”å¦‚è¶…å¸‚çš„åœ°å€ã€è”ç³»ç”µè¯ã€å‘˜å·¥æ•°ç­‰ã€‚åœ¨ ER æ¨¡å‹ä¸­ç”¨ æ¤­åœ†å½¢ æ¥è¡¨ç¤ºã€‚</p><p><code>å…³ç³»</code> ï¼Œåˆ™æ˜¯æŒ‡å®ä½“ä¹‹é—´çš„è”ç³»ã€‚æ¯”å¦‚è¶…å¸‚æŠŠå•†å“å–ç»™é¡¾å®¢ï¼Œå°±æ˜¯ä¸€ç§è¶…å¸‚ä¸é¡¾å®¢ä¹‹é—´çš„è”ç³»ã€‚åœ¨ ER æ¨¡ å‹ä¸­ç”¨ è±å½¢ æ¥è¡¨ç¤ºã€‚</p><p>æ³¨æ„ï¼šå®ä½“å’Œå±æ€§ä¸å®¹æ˜“åŒºåˆ†ã€‚è¿™é‡Œæä¾›ä¸€ä¸ªåŸåˆ™ï¼šæˆ‘ä»¬è¦ä»ç³»ç»Ÿæ•´ä½“çš„è§’åº¦å‡ºå‘å»çœ‹ï¼Œ<strong>å¯ä»¥ç‹¬ç«‹å­˜åœ¨çš„æ˜¯å®ä½“ï¼Œä¸å¯å†åˆ†çš„æ˜¯å±æ€§</strong>ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå±æ€§ä¸èƒ½åŒ…å«å…¶ä»–å±æ€§ã€‚</p><h3 id="8-2-å…³ç³»çš„ç±»å‹"><a href="#8-2-å…³ç³»çš„ç±»å‹" class="headerlink" title="8.2 å…³ç³»çš„ç±»å‹"></a>8.2 å…³ç³»çš„ç±»å‹</h3><p>åœ¨ ER æ¨¡å‹çš„ 3 ä¸ªè¦ç´ ä¸­ï¼Œå…³ç³»åˆå¯ä»¥åˆ†ä¸º 3 ç§ç±»å‹ï¼Œåˆ†åˆ«æ˜¯ ä¸€å¯¹ä¸€ã€ä¸€å¯¹å¤šã€å¤šå¯¹å¤šã€‚</p><p><code>ä¸€å¯¹ä¸€</code> ï¼šæŒ‡å®ä½“ä¹‹é—´çš„å…³ç³»æ˜¯ä¸€ä¸€å¯¹åº”çš„ï¼Œæ¯”å¦‚ä¸ªäººä¸èº«ä»½è¯ä¿¡æ¯ä¹‹é—´çš„å…³ç³»å°±æ˜¯ä¸€å¯¹ä¸€çš„å…³ç³»ã€‚ä¸€ä¸ªäººåªèƒ½æœ‰ä¸€ä¸ªèº«ä»½è¯ä¿¡æ¯ï¼Œä¸€ä¸ªèº«ä»½è¯ä¿¡æ¯ä¹Ÿåªå±äºä¸€ä¸ªäººã€‚</p><p><code>ä¸€å¯¹å¤š</code> ï¼šæŒ‡ä¸€è¾¹çš„å®ä½“é€šè¿‡å…³ç³»ï¼Œå¯ä»¥å¯¹åº”å¤šä¸ªå¦å¤–ä¸€è¾¹çš„å®ä½“ã€‚ç›¸åï¼Œå¦å¤–ä¸€è¾¹çš„å®ä½“é€šè¿‡è¿™ä¸ªå…³ç³»ï¼Œåˆ™åªèƒ½å¯¹åº”å”¯ä¸€çš„ä¸€è¾¹çš„å®ä½“ã€‚æ¯”å¦‚è¯´ï¼Œæˆ‘ä»¬æ–°å»ºä¸€ä¸ªç­çº§è¡¨ï¼Œè€Œæ¯ä¸ªç­çº§éƒ½æœ‰å¤šä¸ªå­¦ç”Ÿï¼Œæ¯ä¸ªå­¦ ç”Ÿåˆ™å¯¹åº”ä¸€ä¸ªç­çº§ï¼Œç­çº§å¯¹å­¦ç”Ÿå°±æ˜¯ä¸€å¯¹å¤šçš„å…³ç³»ã€‚</p><p><code>å¤šå¯¹å¤š</code> ï¼šæŒ‡å…³ç³»ä¸¤è¾¹çš„å®ä½“éƒ½å¯ä»¥é€šè¿‡å…³ç³»å¯¹åº”å¤šä¸ªå¯¹æ–¹çš„å®ä½“ã€‚æ¯”å¦‚åœ¨è¿›è´§æ¨¡å—ä¸­ï¼Œä¾›è´§å•†ä¸è¶…å¸‚ä¹‹ é—´çš„å…³ç³»å°±æ˜¯å¤šå¯¹å¤šçš„å…³ç³»ï¼Œä¸€ä¸ªä¾›è´§å•†å¯ä»¥ç»™å¤šä¸ªè¶…å¸‚ä¾›è´§ï¼Œä¸€ä¸ªè¶…å¸‚ä¹Ÿå¯ä»¥ä»å¤šä¸ªä¾›è´§å•†é‚£é‡Œé‡‡è´­ å•†å“ã€‚å†æ¯”å¦‚ä¸€ä¸ªé€‰è¯¾è¡¨ï¼Œæœ‰è®¸å¤šç§‘ç›®ï¼Œæ¯ä¸ªç§‘ç›®æœ‰å¾ˆå¤šå­¦ç”Ÿé€‰ï¼Œè€Œæ¯ä¸ªå­¦ç”Ÿåˆå¯ä»¥é€‰æ‹©å¤šä¸ªç§‘ç›®ï¼Œè¿™ å°±æ˜¯å¤šå¯¹å¤šçš„å…³ç³»ã€‚</p><h3 id="8-3-å»ºæ¨¡åˆ†æ"><a href="#8-3-å»ºæ¨¡åˆ†æ" class="headerlink" title="8.3 å»ºæ¨¡åˆ†æ"></a>8.3 å»ºæ¨¡åˆ†æ</h3><p>ER æ¨¡å‹çœ‹èµ·æ¥æ¯”è¾ƒéº»çƒ¦ï¼Œä½†æ˜¯å¯¹æˆ‘ä»¬æŠŠæ§é¡¹ç›®æ•´ä½“éå¸¸é‡è¦ã€‚å¦‚æœä½ åªæ˜¯å¼€å‘ä¸€ä¸ªå°åº”ç”¨ï¼Œæˆ–è®¸ç®€å•è®¾ è®¡å‡ ä¸ªè¡¨å¤Ÿç”¨äº†ï¼Œä¸€æ—¦è¦è®¾è®¡æœ‰ä¸€å®šè§„æ¨¡çš„åº”ç”¨ï¼Œåœ¨é¡¹ç›®çš„åˆå§‹é˜¶æ®µï¼Œå»ºç«‹å®Œæ•´çš„ ER æ¨¡å‹å°±éå¸¸å…³é”® äº†ã€‚å¼€å‘åº”ç”¨é¡¹ç›®çš„å®è´¨ï¼Œå…¶å®å°±æ˜¯ å»ºæ¨¡ ã€‚</p><p>æˆ‘ä»¬è®¾è®¡çš„æ¡ˆä¾‹æ˜¯ ç”µå•†ä¸šåŠ¡ ï¼Œç”±äºç”µå•†ä¸šåŠ¡å¤ªè¿‡åºå¤§ä¸”å¤æ‚ï¼Œæ‰€ä»¥æˆ‘ä»¬åšäº†ä¸šåŠ¡ç®€åŒ–ï¼Œæ¯”å¦‚é’ˆå¯¹ SKUï¼ˆStockKeepingUnitï¼Œåº“å­˜é‡å•ä½ï¼‰å’ŒSPUï¼ˆStandard Product Unitï¼Œæ ‡å‡†åŒ–äº§å“å•å…ƒï¼‰çš„å«ä¹‰ä¸Šï¼Œæˆ‘ ä»¬ç›´æ¥ä½¿ç”¨äº†SKUï¼Œå¹¶æ²¡æœ‰æåŠSPUçš„æ¦‚å¿µã€‚æœ¬æ¬¡ç”µå•†ä¸šåŠ¡è®¾è®¡æ€»å…±æœ‰8ä¸ªå®ä½“ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p><ul><li>åœ°å€å®ä½“ </li><li>ç”¨æˆ·å®ä½“ </li><li>è´­ç‰©è½¦å®ä½“ </li><li>è¯„è®ºå®ä½“ </li><li>å•†å“å®ä½“ </li><li>å•†å“åˆ†ç±»å®ä½“ </li><li>è®¢å•å®ä½“ </li><li>è®¢å•è¯¦æƒ…å®ä½“</li></ul><p>å…¶ä¸­ï¼Œ ç”¨æˆ· å’Œ å•†å“åˆ†ç±» æ˜¯å¼ºå®ä½“ï¼Œå› ä¸ºå®ƒä»¬ä¸éœ€è¦ä¾èµ–å…¶ä»–ä»»ä½•å®ä½“ã€‚è€Œå…¶ä»–å±äºå¼±å®ä½“ï¼Œå› ä¸ºå®ƒä»¬ è™½ç„¶éƒ½å¯ä»¥ç‹¬ç«‹å­˜åœ¨ï¼Œä½†æ˜¯å®ƒä»¬éƒ½ä¾èµ–ç”¨æˆ·è¿™ä¸ªå®ä½“ï¼Œå› æ­¤éƒ½æ˜¯å¼±å®ä½“ã€‚çŸ¥é“äº†è¿™äº›è¦ç´ ï¼Œæˆ‘ä»¬å°±å¯ä»¥ ç»™ç”µå•†ä¸šåŠ¡åˆ›å»º ER æ¨¡å‹äº†ï¼Œå¦‚å›¾ï¼š</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707170608782.png" class=""><p>åœ¨è¿™ä¸ªå›¾ä¸­ï¼Œåœ°å€å’Œç”¨æˆ·ä¹‹é—´çš„æ·»åŠ å…³ç³»ï¼Œæ˜¯ä¸€å¯¹å¤šçš„å…³ç³»ï¼Œè€Œå•†å“å’Œå•†å“è¯¦æƒ…ç¤ºä¸€å¯¹1çš„å…³ç³»ï¼Œå•†å“å’Œ è®¢å•æ˜¯å¤šå¯¹å¤šçš„å…³ç³»ã€‚ è¿™ä¸ª ER æ¨¡å‹ï¼ŒåŒ…æ‹¬äº† 8ä¸ªå®ä½“ä¹‹é—´çš„ 8ç§å…³ç³»ã€‚</p><p>ï¼ˆ1ï¼‰ç”¨æˆ·å¯ä»¥åœ¨ç”µå•†å¹³å°æ·»åŠ å¤šä¸ªåœ°å€ï¼› </p><p>ï¼ˆ2ï¼‰ç”¨æˆ·åªèƒ½æ‹¥æœ‰ä¸€ä¸ªè´­ç‰©è½¦ï¼› </p><p>ï¼ˆ3ï¼‰ç”¨æˆ·å¯ä»¥ç”Ÿæˆå¤šä¸ªè®¢å•ï¼› </p><p>ï¼ˆ4ï¼‰ç”¨æˆ·å¯ä»¥å‘è¡¨å¤šæ¡è¯„è®ºï¼› </p><p>ï¼ˆ5ï¼‰ä¸€ä»¶å•†å“å¯ä»¥æœ‰å¤šæ¡è¯„è®ºï¼› </p><p>ï¼ˆ6ï¼‰æ¯ä¸€ä¸ªå•†å“åˆ†ç±»åŒ…å«å¤šç§å•†å“ï¼›</p><p>ï¼ˆ7ï¼‰ä¸€ä¸ªè®¢å•å¯ä»¥åŒ…å«å¤šä¸ªå•†å“ï¼Œä¸€ä¸ªå•†å“å¯ä»¥åœ¨å¤šä¸ªè®¢å•é‡Œã€‚ </p><p>ï¼ˆ8ï¼‰è®¢å•ä¸­åˆåŒ…å«å¤šä¸ªè®¢å•è¯¦æƒ…ï¼Œå› ä¸ºä¸€ä¸ªè®¢å•ä¸­å¯èƒ½åŒ…å«ä¸åŒç§ç±»çš„å•†å“</p><h3 id="8-4-ER-æ¨¡å‹çš„ç»†åŒ–"><a href="#8-4-ER-æ¨¡å‹çš„ç»†åŒ–" class="headerlink" title="8.4 ER æ¨¡å‹çš„ç»†åŒ–"></a>8.4 ER æ¨¡å‹çš„ç»†åŒ–</h3><p>æœ‰äº†è¿™ä¸ª ER æ¨¡å‹ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä»æ•´ä½“ä¸Š ç†è§£ ç”µå•†çš„ä¸šåŠ¡äº†ã€‚åˆšåˆšçš„ ER æ¨¡å‹å±•ç¤ºäº†ç”µå•†ä¸šåŠ¡çš„æ¡†æ¶ï¼Œ ä½†æ˜¯åªåŒ…æ‹¬äº†è®¢å•ï¼Œåœ°å€ï¼Œç”¨æˆ·ï¼Œè´­ç‰©è½¦ï¼Œè¯„è®ºï¼Œå•†å“ï¼Œå•†å“åˆ†ç±»å’Œè®¢å•è¯¦æƒ…è¿™å…«ä¸ªå®ä½“ï¼Œä»¥åŠå®ƒä»¬ä¹‹ é—´çš„å…³ç³»ï¼Œè¿˜ä¸èƒ½å¯¹åº”åˆ°å…·ä½“çš„è¡¨ï¼Œä»¥åŠè¡¨ä¸è¡¨ä¹‹é—´çš„å…³è”ã€‚æˆ‘ä»¬éœ€è¦æŠŠ å±æ€§åŠ ä¸Š ï¼Œç”¨ æ¤­åœ† æ¥è¡¨ç¤ºï¼Œ è¿™æ ·æˆ‘ä»¬å¾—åˆ°çš„ ER æ¨¡å‹å°±æ›´åŠ å®Œæ•´äº†ã€‚</p><p>å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦è¿›ä¸€æ­¥å»è®¾è®¡ä¸€ä¸‹è¿™ä¸ª ER æ¨¡å‹çš„å„ä¸ªå±€éƒ¨ï¼Œä¹Ÿå°±æ˜¯ç»†åŒ–ä¸‹ç”µå•†çš„å…·ä½“ä¸šåŠ¡æµç¨‹ï¼Œç„¶åæŠŠ å®ƒä»¬ç»¼åˆåˆ°ä¸€èµ·ï¼Œå½¢æˆä¸€ä¸ªå®Œæ•´çš„ ER æ¨¡å‹ã€‚è¿™æ ·å¯ä»¥å¸®åŠ©æˆ‘ä»¬ç†æ¸…æ•°æ®åº“çš„è®¾è®¡æ€è·¯ã€‚</p><p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å†åˆ†æä¸€ä¸‹å„ä¸ªå®ä½“éƒ½æœ‰å“ªäº›å±æ€§ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p><p>ï¼ˆ1ï¼‰ <code>åœ°å€å®ä½“</code> åŒ…æ‹¬ç”¨æˆ·ç¼–å·ã€çœã€å¸‚ã€åœ°åŒºã€æ”¶ä»¶äººã€è”ç³»ç”µè¯ã€æ˜¯å¦æ˜¯é»˜è®¤åœ°å€ã€‚ </p><p>ï¼ˆ2ï¼‰ <code>ç”¨æˆ·å®ä½“</code> åŒ…æ‹¬ç”¨æˆ·ç¼–å·ã€ç”¨æˆ·åç§°ã€æ˜µç§°ã€ç”¨æˆ·å¯†ç ã€æ‰‹æœºå·ã€é‚®ç®±ã€å¤´åƒã€ç”¨æˆ·çº§åˆ«ã€‚</p><p>ï¼ˆ3ï¼‰ <code>è´­ç‰©è½¦å®ä½“</code> åŒ…æ‹¬è´­ç‰©è½¦ç¼–å·ã€ç”¨æˆ·ç¼–å·ã€å•†å“ç¼–å·ã€å•†å“æ•°é‡ã€å›¾ç‰‡æ–‡ä»¶urlã€‚</p><p>ï¼ˆ4ï¼‰ <code>è®¢å•å®ä½“</code> åŒ…æ‹¬è®¢å•ç¼–å·ã€æ”¶è´§äººã€æ”¶ä»¶äººç”µè¯ã€æ€»é‡‘é¢ã€ç”¨æˆ·ç¼–å·ã€ä»˜æ¬¾æ–¹å¼ã€é€è´§åœ°å€ã€ä¸‹å• æ—¶é—´ã€‚ </p><p>ï¼ˆ5ï¼‰ <code>è®¢å•è¯¦æƒ…å®ä½“</code> åŒ…æ‹¬è®¢å•è¯¦æƒ…ç¼–å·ã€è®¢å•ç¼–å·ã€å•†å“åç§°ã€å•†å“ç¼–å·ã€å•†å“æ•°é‡ã€‚ </p><p>ï¼ˆ6ï¼‰ <code>å•†å“å®ä½“</code> åŒ…æ‹¬å•†å“ç¼–å·ã€ä»·æ ¼ã€å•†å“åç§°ã€åˆ†ç±»ç¼–å·ã€æ˜¯å¦é”€å”®ï¼Œè§„æ ¼ã€é¢œè‰²ã€‚ </p><p>ï¼ˆ7ï¼‰ <code>è¯„è®ºå®ä½“</code> åŒ…æ‹¬è¯„è®ºidã€è¯„è®ºå†…å®¹ã€è¯„è®ºæ—¶é—´ã€ç”¨æˆ·ç¼–å·ã€å•†å“ç¼–å· </p><p>ï¼ˆ8ï¼‰ <code>å•†å“åˆ†ç±»å®ä½“</code> åŒ…æ‹¬ç±»åˆ«ç¼–å·ã€ç±»åˆ«åç§°ã€çˆ¶ç±»åˆ«ç¼–å·</p><p>è¿™æ ·ç»†åˆ†ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥é‡æ–°è®¾è®¡ç”µå•†ä¸šåŠ¡äº†ï¼ŒER æ¨¡å‹å¦‚å›¾ï¼š</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707171022246.png" class=""><h3 id="8-5-ER-æ¨¡å‹å›¾è½¬æ¢æˆæ•°æ®è¡¨"><a href="#8-5-ER-æ¨¡å‹å›¾è½¬æ¢æˆæ•°æ®è¡¨" class="headerlink" title="8.5 ER æ¨¡å‹å›¾è½¬æ¢æˆæ•°æ®è¡¨"></a>8.5 ER æ¨¡å‹å›¾è½¬æ¢æˆæ•°æ®è¡¨</h3><p>é€šè¿‡ç»˜åˆ¶ ER æ¨¡å‹ï¼Œæˆ‘ä»¬å·²ç»ç†æ¸…äº†ä¸šåŠ¡é€»è¾‘ï¼Œç°åœ¨ï¼Œæˆ‘ä»¬å°±è¦è¿›è¡Œéå¸¸é‡è¦çš„ä¸€æ­¥äº†ï¼šæŠŠç»˜åˆ¶å¥½çš„ ER æ¨¡å‹ï¼Œè½¬æ¢æˆå…·ä½“çš„æ•°æ®è¡¨ï¼Œä¸‹é¢ä»‹ç»ä¸‹è½¬æ¢çš„åŸåˆ™ï¼š</p><p>ï¼ˆ1ï¼‰ä¸€ä¸ª å®ä½“ é€šå¸¸è½¬æ¢æˆä¸€ä¸ª æ•°æ®è¡¨ ï¼› </p><p>ï¼ˆ2ï¼‰ä¸€ä¸ª å¤šå¯¹å¤šçš„å…³ç³» ï¼Œé€šå¸¸ä¹Ÿè½¬æ¢æˆä¸€ä¸ª æ•°æ®è¡¨ ï¼› </p><p>ï¼ˆ3ï¼‰ä¸€ä¸ª 1 å¯¹ 1 ï¼Œæˆ–è€… 1 å¯¹å¤š çš„å…³ç³»ï¼Œå¾€å¾€é€šè¿‡è¡¨çš„ å¤–é”® æ¥è¡¨è¾¾ï¼Œè€Œä¸æ˜¯è®¾è®¡ä¸€ä¸ªæ–°çš„æ•°æ®è¡¨ï¼› </p><p>ï¼ˆ4ï¼‰ å±æ€§ è½¬æ¢æˆè¡¨çš„ å­—æ®µ ã€‚</p><p>ä¸‹é¢ç»“åˆå‰é¢çš„ERæ¨¡å‹ï¼Œå…·ä½“è®²è§£ä¸€ä¸‹æ€ä¹ˆè¿ç”¨è¿™äº›è½¬æ¢çš„åŸåˆ™ï¼ŒæŠŠ ER æ¨¡å‹è½¬æ¢æˆå…·ä½“çš„æ•°æ®è¡¨ï¼Œä» è€ŒæŠŠæŠ½è±¡å‡ºæ¥çš„æ•°æ®æ¨¡å‹ï¼Œè½å®åˆ°å…·ä½“çš„æ•°æ®åº“è®¾è®¡å½“ä¸­ã€‚</p><h4 id="1-ä¸€ä¸ªå®ä½“è½¬æ¢æˆä¸€ä¸ªæ•°æ®åº“"><a href="#1-ä¸€ä¸ªå®ä½“è½¬æ¢æˆä¸€ä¸ªæ•°æ®åº“" class="headerlink" title="1. ä¸€ä¸ªå®ä½“è½¬æ¢æˆä¸€ä¸ªæ•°æ®åº“"></a>1. ä¸€ä¸ªå®ä½“è½¬æ¢æˆä¸€ä¸ªæ•°æ®åº“</h4><p><strong>å…ˆæ¥çœ‹ä¸€ä¸‹å¼ºå®ä½“è½¬æ¢æˆæ•°æ®è¡¨:</strong></p><p><code>ç”¨æˆ·å®ä½“</code>è½¬æ¢æˆç”¨æˆ·è¡¨(user_info)çš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707171335255.png" class=""><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707171412363.png" class=""><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707171915637.png" class=""><p><strong>ä¸‹é¢æˆ‘ä»¬å†æŠŠå¼±å®ä½“è½¬æ¢æˆæ•°æ®è¡¨ï¼š</strong></p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707172033399.png" class=""><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707172052236.png" class=""><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707172143793.png" class=""><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707172217772.png" class=""><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707172236606.png" class=""><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707172259143.png" class=""><h4 id="2-ä¸€ä¸ªå¤šå¯¹å¤šçš„å…³ç³»è½¬æ¢æˆä¸€ä¸ªæ•°æ®è¡¨"><a href="#2-ä¸€ä¸ªå¤šå¯¹å¤šçš„å…³ç³»è½¬æ¢æˆä¸€ä¸ªæ•°æ®è¡¨" class="headerlink" title="2. ä¸€ä¸ªå¤šå¯¹å¤šçš„å…³ç³»è½¬æ¢æˆä¸€ä¸ªæ•°æ®è¡¨"></a>2. ä¸€ä¸ªå¤šå¯¹å¤šçš„å…³ç³»è½¬æ¢æˆä¸€ä¸ªæ•°æ®è¡¨</h4><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707172350226.png" class=""><h4 id="3-é€šè¿‡å¤–é”®æ¥è¡¨è¾¾1å¯¹å¤šçš„å…³ç³»"><a href="#3-é€šè¿‡å¤–é”®æ¥è¡¨è¾¾1å¯¹å¤šçš„å…³ç³»" class="headerlink" title="3. é€šè¿‡å¤–é”®æ¥è¡¨è¾¾1å¯¹å¤šçš„å…³ç³»"></a>3. é€šè¿‡å¤–é”®æ¥è¡¨è¾¾1å¯¹å¤šçš„å…³ç³»</h4><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707172609833.png" class=""><h4 id="4-æŠŠå±æ€§è½¬æ¢æˆè¡¨çš„å­—æ®µ"><a href="#4-æŠŠå±æ€§è½¬æ¢æˆè¡¨çš„å­—æ®µ" class="headerlink" title="4. æŠŠå±æ€§è½¬æ¢æˆè¡¨çš„å­—æ®µ"></a>4. æŠŠå±æ€§è½¬æ¢æˆè¡¨çš„å­—æ®µ</h4><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707172819174.png" class=""><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707172918017.png" class=""><h2 id="9-æ•°æ®è¡¨çš„è®¾è®¡åŸåˆ™"><a href="#9-æ•°æ®è¡¨çš„è®¾è®¡åŸåˆ™" class="headerlink" title="9. æ•°æ®è¡¨çš„è®¾è®¡åŸåˆ™"></a>9. æ•°æ®è¡¨çš„è®¾è®¡åŸåˆ™</h2><p>ç»¼åˆä»¥ä¸Šå†…å®¹ï¼Œæ€»ç»“å‡ºæ•°æ®è¡¨è®¾è®¡çš„ä¸€èˆ¬åŸåˆ™ï¼šâ€ä¸‰å°‘ä¸€å¤šâ€</p><p><strong>1. æ•°æ®è¡¨çš„ä¸ªæ•°è¶Šå°‘è¶Šå¥½</strong></p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707173028203.png" class=""><p><strong>2. æ•°æ®è¡¨ä¸­çš„å­—æ®µä¸ªæ•°è¶Šå°‘è¶Šå¥½</strong></p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707173402491.png" class=""><p><strong>3. æ•°æ®è¡¨ä¸­è”åˆä¸»é”®çš„å­—æ®µä¸ªæ•°è¶Šå°‘è¶Šå¥½</strong></p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707173522971.png" class=""><p><strong>4. ä½¿ç”¨ä¸»é”®å’Œå¤–é”®è¶Šå¤šè¶Šå¥½</strong></p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707173557568.png" class=""><h2 id="10-æ•°æ®åº“å¯¹è±¡ç¼–å†™å»ºè®®"><a href="#10-æ•°æ®åº“å¯¹è±¡ç¼–å†™å»ºè®®" class="headerlink" title="10. æ•°æ®åº“å¯¹è±¡ç¼–å†™å»ºè®®"></a>10. æ•°æ®åº“å¯¹è±¡ç¼–å†™å»ºè®®</h2><h3 id="10-1-å…³äºåº“"><a href="#10-1-å…³äºåº“" class="headerlink" title="10.1 å…³äºåº“"></a>10.1 å…³äºåº“</h3><ol><li>ã€å¼ºåˆ¶ã€‘åº“çš„åç§°å¿…é¡»æ§åˆ¶åœ¨32ä¸ªå­—ç¬¦ä»¥å†…ï¼Œåªèƒ½ä½¿ç”¨è‹±æ–‡å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿ï¼Œå»ºè®®ä»¥è‹±æ–‡å­— æ¯å¼€å¤´ã€‚ </li><li>ã€å¼ºåˆ¶ã€‘åº“åä¸­è‹±æ–‡ ä¸€å¾‹å°å†™ ï¼Œä¸åŒå•è¯é‡‡ç”¨ ä¸‹åˆ’çº¿ åˆ†å‰²ã€‚é¡»è§åçŸ¥æ„ã€‚ </li><li>ã€å¼ºåˆ¶ã€‘åº“çš„åç§°æ ¼å¼ï¼šä¸šåŠ¡ç³»ç»Ÿåç§°_å­ç³»ç»Ÿåã€‚</li><li>ã€å¼ºåˆ¶ã€‘åº“åç¦æ­¢ä½¿ç”¨å…³é”®å­—ï¼ˆå¦‚type,orderç­‰ï¼‰ã€‚</li><li>ã€å¼ºåˆ¶ã€‘åˆ›å»ºæ•°æ®åº“æ—¶å¿…é¡» æ˜¾å¼æŒ‡å®šå­—ç¬¦é›† ï¼Œå¹¶ä¸”å­—ç¬¦é›†åªèƒ½æ˜¯utf8æˆ–è€…utf8mb4ã€‚ åˆ›å»ºæ•°æ®åº“SQLä¸¾ä¾‹ï¼šCREATE DATABASE crm_fund DEFAULT CHARACTER SET â€˜utf8â€™ ; </li><li>ã€å»ºè®®ã€‘å¯¹äºç¨‹åºè¿æ¥æ•°æ®åº“è´¦å·ï¼Œéµå¾ª æƒé™æœ€å°åŸåˆ™ ä½¿ç”¨æ•°æ®åº“è´¦å·åªèƒ½åœ¨ä¸€ä¸ªDBä¸‹ä½¿ç”¨ï¼Œä¸å‡†è·¨åº“ã€‚ç¨‹åºä½¿ç”¨çš„è´¦å· åŸåˆ™ä¸Šä¸å‡†æœ‰dropæƒé™ ã€‚ </li><li>ã€å»ºè®®ã€‘ä¸´æ—¶åº“ä»¥ tmp_ ä¸ºå‰ç¼€ï¼Œå¹¶ä»¥æ—¥æœŸä¸ºåç¼€ï¼› å¤‡ä»½åº“ä»¥ bak_ ä¸ºå‰ç¼€ï¼Œå¹¶ä»¥æ—¥æœŸä¸ºåç¼€ã€‚</li></ol><h3 id="10-2-å…³äºè¡¨ã€åˆ—"><a href="#10-2-å…³äºè¡¨ã€åˆ—" class="headerlink" title="10.2 å…³äºè¡¨ã€åˆ—"></a>10.2 å…³äºè¡¨ã€åˆ—</h3><ol><li><p>ã€å¼ºåˆ¶ã€‘è¡¨å’Œåˆ—çš„åç§°å¿…é¡»æ§åˆ¶åœ¨32ä¸ªå­—ç¬¦ä»¥å†…ï¼Œè¡¨ååªèƒ½ä½¿ç”¨è‹±æ–‡å­—æ¯ã€æ•°å­—å’Œä¸‹åˆ’çº¿ï¼Œå»ºè®® ä»¥ è‹±æ–‡å­—æ¯å¼€å¤´ ã€‚ </p></li><li><p>ã€å¼ºåˆ¶ã€‘ è¡¨åã€åˆ—åä¸€å¾‹å°å†™ ï¼Œä¸åŒå•è¯é‡‡ç”¨ä¸‹åˆ’çº¿åˆ†å‰²ã€‚é¡»è§åçŸ¥æ„ã€‚ </p></li><li><p>ã€å¼ºåˆ¶ã€‘è¡¨åè¦æ±‚æœ‰æ¨¡å—åå¼ºç›¸å…³ï¼ŒåŒä¸€æ¨¡å—çš„è¡¨åå°½é‡ä½¿ç”¨ ç»Ÿä¸€å‰ç¼€ ã€‚æ¯”å¦‚ï¼šcrm_fund_item </p></li><li><p>ã€å¼ºåˆ¶ã€‘åˆ›å»ºè¡¨æ—¶å¿…é¡» æ˜¾å¼æŒ‡å®šå­—ç¬¦é›† ä¸ºutf8æˆ–utf8mb4ã€‚ </p></li><li><p>ã€å¼ºåˆ¶ã€‘è¡¨åã€åˆ—åç¦æ­¢ä½¿ç”¨å…³é”®å­—ï¼ˆå¦‚type,orderç­‰ï¼‰ã€‚ </p></li><li><p>ã€å¼ºåˆ¶ã€‘åˆ›å»ºè¡¨æ—¶å¿…é¡» æ˜¾å¼æŒ‡å®šè¡¨å­˜å‚¨å¼•æ“ ç±»å‹ã€‚å¦‚æ— ç‰¹æ®Šéœ€æ±‚ï¼Œä¸€å¾‹ä¸ºInnoDBã€‚ </p></li><li><p>ã€å¼ºåˆ¶ã€‘å»ºè¡¨å¿…é¡»æœ‰commentã€‚ </p></li><li><p>ã€å¼ºåˆ¶ã€‘å­—æ®µå‘½ååº”å°½å¯èƒ½ä½¿ç”¨è¡¨è¾¾å®é™…å«ä¹‰çš„è‹±æ–‡å•è¯æˆ– ç¼©å†™ ã€‚å¦‚ï¼šå…¬å¸ IDï¼Œä¸è¦ä½¿ç”¨ corporation_id, è€Œç”¨corp_id å³å¯ã€‚ </p></li><li><p>ã€å¼ºåˆ¶ã€‘å¸ƒå°”å€¼ç±»å‹çš„å­—æ®µå‘½åä¸º is_æè¿° ã€‚å¦‚memberè¡¨ä¸Šè¡¨ç¤ºæ˜¯å¦ä¸ºenabledçš„ä¼šå‘˜çš„å­—æ®µå‘½ åä¸º is_enabledã€‚ </p></li><li><p>ã€å¼ºåˆ¶ã€‘ç¦æ­¢åœ¨æ•°æ®åº“ä¸­å­˜å‚¨å›¾ç‰‡ã€æ–‡ä»¶ç­‰å¤§çš„äºŒè¿›åˆ¶æ•°æ® é€šå¸¸æ–‡ä»¶å¾ˆå¤§ï¼ŒçŸ­æ—¶é—´å†…é€ æˆæ•°æ®é‡å¿«é€Ÿå¢é•¿ï¼Œæ•°æ®åº“è¿›è¡Œæ•°æ®åº“è¯»å–æ—¶ï¼Œé€šå¸¸ä¼šè¿›è¡Œå¤§é‡çš„éš æœºIOæ“ä½œï¼Œæ–‡ä»¶å¾ˆå¤§æ—¶ï¼ŒIOæ“ä½œå¾ˆè€—æ—¶ã€‚é€šå¸¸å­˜å‚¨äºæ–‡ä»¶æœåŠ¡å™¨ï¼Œæ•°æ®åº“åªå­˜å‚¨æ–‡ä»¶åœ°å€ä¿¡æ¯ã€‚ </p></li><li><p>ã€å»ºè®®ã€‘å»ºè¡¨æ—¶å…³äºä¸»é”®ï¼š è¡¨å¿…é¡»æœ‰ä¸»é”®</p><p> (1)å¼ºåˆ¶è¦æ±‚ä¸»é”®ä¸ºidï¼Œç±»å‹ä¸ºintæˆ–bigintï¼Œä¸”ä¸º auto_increment å»ºè®®ä½¿ç”¨unsignedæ— ç¬¦å·å‹ã€‚</p><p> (2)æ ‡è¯†è¡¨é‡Œæ¯ä¸€è¡Œä¸»ä½“çš„å­—æ®µä¸è¦è®¾ä¸ºä¸»é”®ï¼Œå»ºè®® è®¾ä¸ºå…¶ä»–å­—æ®µå¦‚user_idï¼Œorder_idç­‰ï¼Œå¹¶å»ºç«‹unique keyç´¢å¼•ã€‚å› ä¸ºå¦‚æœè®¾ä¸ºä¸»é”®ä¸”ä¸»é”®å€¼ä¸ºéšæœº æ’å…¥ï¼Œåˆ™ä¼šå¯¼è‡´innodbå†…éƒ¨é¡µåˆ†è£‚å’Œå¤§é‡éšæœºI&#x2F;Oï¼Œæ€§èƒ½ä¸‹é™ã€‚ </p></li><li><p>ã€å»ºè®®ã€‘æ ¸å¿ƒè¡¨ï¼ˆå¦‚ç”¨æˆ·è¡¨ï¼‰å¿…é¡»æœ‰è¡Œæ•°æ®çš„ åˆ›å»ºæ—¶é—´å­—æ®µ ï¼ˆcreate_timeï¼‰å’Œ æœ€åæ›´æ–°æ—¶é—´å­—æ®µ ï¼ˆupdate_timeï¼‰ï¼Œä¾¿äºæŸ¥é—®é¢˜ã€‚ </p></li><li><p>ã€å»ºè®®ã€‘è¡¨ä¸­æ‰€æœ‰å­—æ®µå°½é‡éƒ½æ˜¯ NOT NULL å±æ€§ï¼Œä¸šåŠ¡å¯ä»¥æ ¹æ®éœ€è¦å®šä¹‰ DEFAULTå€¼ ã€‚ å› ä¸ºä½¿ç”¨ NULLå€¼ä¼šå­˜åœ¨æ¯ä¸€è¡Œéƒ½ä¼šå ç”¨é¢å¤–å­˜å‚¨ç©ºé—´ã€æ•°æ®è¿ç§»å®¹æ˜“å‡ºé”™ã€èšåˆå‡½æ•°è®¡ç®—ç»“æœåå·®ç­‰é—® é¢˜ã€‚ </p></li><li><p>ã€å»ºè®®ã€‘æ‰€æœ‰å­˜å‚¨ç›¸åŒæ•°æ®çš„ åˆ—åå’Œåˆ—ç±»å‹å¿…é¡»ä¸€è‡´ ï¼ˆä¸€èˆ¬ä½œä¸ºå…³è”åˆ—ï¼Œå¦‚æœæŸ¥è¯¢æ—¶å…³è”åˆ—ç±»å‹ ä¸ä¸€è‡´ä¼šè‡ªåŠ¨è¿›è¡Œæ•°æ®ç±»å‹éšå¼è½¬æ¢ï¼Œä¼šé€ æˆåˆ—ä¸Šçš„ç´¢å¼•å¤±æ•ˆï¼Œå¯¼è‡´æŸ¥è¯¢æ•ˆç‡é™ä½ï¼‰ã€‚ </p></li><li><p>ã€å»ºè®®ã€‘ä¸­é—´è¡¨ï¼ˆæˆ–ä¸´æ—¶è¡¨ï¼‰ç”¨äºä¿ç•™ä¸­é—´ç»“æœé›†ï¼Œåç§°ä»¥ tmp_ å¼€å¤´ã€‚ å¤‡ä»½è¡¨ç”¨äºå¤‡ä»½æˆ–æŠ“å–æºè¡¨å¿«ç…§ï¼Œåç§°ä»¥ bak_ å¼€å¤´ã€‚ä¸­é—´è¡¨å’Œå¤‡ä»½è¡¨å®šæœŸæ¸…ç†ã€‚ 1</p></li><li><p>ã€ç¤ºèŒƒã€‘ä¸€ä¸ªè¾ƒä¸ºè§„èŒƒçš„å»ºè¡¨è¯­å¥ï¼š</p></li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE user_info (</span><br><span class="line">`id` int unsigned NOT NULL AUTO_INCREMENT COMMENT &#x27;è‡ªå¢ä¸»é”®&#x27;,</span><br><span class="line">`user_id` bigint(11) NOT NULL COMMENT &#x27;ç”¨æˆ·id&#x27;,</span><br><span class="line">`username` varchar(45) NOT NULL COMMENT &#x27;çœŸå®å§“å&#x27;,</span><br><span class="line">`email` varchar(30) NOT NULL COMMENT &#x27;ç”¨æˆ·é‚®ç®±&#x27;,</span><br><span class="line">`nickname` varchar(45) NOT NULL COMMENT &#x27;æ˜µç§°&#x27;,</span><br><span class="line">`birthday` date NOT NULL COMMENT &#x27;ç”Ÿæ—¥&#x27;,</span><br><span class="line">`sex` tinyint(4) DEFAULT &#x27;0&#x27; COMMENT &#x27;æ€§åˆ«&#x27;,</span><br><span class="line">`short_introduce` varchar(150) DEFAULT NULL COMMENT &#x27;ä¸€å¥è¯ä»‹ç»è‡ªå·±ï¼Œæœ€å¤š50ä¸ªæ±‰å­—&#x27;,</span><br><span class="line">`user_resume` varchar(300) NOT NULL COMMENT &#x27;ç”¨æˆ·æäº¤çš„ç®€å†å­˜æ”¾åœ°å€&#x27;,</span><br><span class="line">`user_register_ip` int NOT NULL COMMENT &#x27;ç”¨æˆ·æ³¨å†Œæ—¶çš„æºip&#x27;,</span><br><span class="line">`create_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;åˆ›å»ºæ—¶é—´&#x27;,</span><br><span class="line">`update_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE</span><br><span class="line">CURRENT_TIMESTAMP COMMENT &#x27;ä¿®æ”¹æ—¶é—´&#x27;,</span><br><span class="line">`user_review_status` tinyint NOT NULL COMMENT &#x27;ç”¨æˆ·èµ„æ–™å®¡æ ¸çŠ¶æ€ï¼Œ1ä¸ºé€šè¿‡ï¼Œ2ä¸ºå®¡æ ¸ä¸­ï¼Œ3ä¸ºæœª</span><br><span class="line">é€šè¿‡ï¼Œ4ä¸ºè¿˜æœªæäº¤å®¡æ ¸&#x27;,</span><br><span class="line">PRIMARY KEY (`id`),</span><br><span class="line">UNIQUE KEY `uniq_user_id` (`user_id`),</span><br><span class="line">KEY `idx_username`(`username`),</span><br><span class="line">KEY `idx_create_time_status`(`create_time`,`user_review_status`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8 COMMENT=&#x27;ç½‘ç«™ç”¨æˆ·åŸºæœ¬ä¿¡æ¯</span><br></pre></td></tr></table></figure><ol start="17"><li>ã€å»ºè®®ã€‘åˆ›å»ºè¡¨æ—¶ï¼Œå¯ä»¥ä½¿ç”¨å¯è§†åŒ–å·¥å…·ã€‚è¿™æ ·å¯ä»¥ç¡®ä¿è¡¨ã€å­—æ®µç›¸å…³çš„çº¦å®šéƒ½èƒ½è®¾ç½®ä¸Šã€‚</li></ol><p>å®é™…ä¸Šï¼Œæˆ‘ä»¬é€šå¸¸å¾ˆå°‘è‡ªå·±å†™ DDL è¯­å¥ï¼Œå¯ä»¥ä½¿ç”¨ä¸€äº›å¯è§†åŒ–å·¥å…·æ¥åˆ›å»ºå’Œæ“ä½œæ•°æ®åº“å’Œæ•°æ®è¡¨ã€‚</p><p>å¯è§†åŒ–å·¥å…·é™¤äº†æ–¹ä¾¿ï¼Œè¿˜èƒ½ç›´æ¥å¸®æˆ‘ä»¬å°†æ•°æ®åº“çš„ç»“æ„å®šä¹‰è½¬åŒ–æˆ SQL è¯­è¨€ï¼Œæ–¹ä¾¿æ•°æ®åº“å’Œæ•°æ®è¡¨ç»“æ„çš„å¯¼å‡ºå’Œå¯¼å…¥ã€‚</p><h3 id="10-3-å…³äºç´¢å¼•"><a href="#10-3-å…³äºç´¢å¼•" class="headerlink" title="10.3 å…³äºç´¢å¼•"></a>10.3 å…³äºç´¢å¼•</h3><ol><li>ã€å¼ºåˆ¶ã€‘InnoDBè¡¨å¿…é¡»ä¸»é”®ä¸ºid int&#x2F;bigint auto_incrementï¼Œä¸”ä¸»é”®å€¼ ç¦æ­¢è¢«æ›´æ–° ã€‚ </li><li>ã€å¼ºåˆ¶ã€‘InnoDBå’ŒMyISAMå­˜å‚¨å¼•æ“è¡¨ï¼Œç´¢å¼•ç±»å‹å¿…é¡»ä¸º BTREE ã€‚ </li><li>ã€å»ºè®®ã€‘ä¸»é”®çš„åç§°ä»¥ pk_ å¼€å¤´ï¼Œå”¯ä¸€é”®ä»¥ uni_ æˆ– uk_ å¼€å¤´ï¼Œæ™®é€šç´¢å¼•ä»¥ idx_ å¼€å¤´ï¼Œä¸€å¾‹ä½¿ç”¨å°å†™æ ¼å¼ï¼Œä»¥å­—æ®µçš„åç§°æˆ–ç¼©å†™ä½œä¸ºåç¼€ã€‚ </li><li>ã€å»ºè®®ã€‘å¤šå•è¯ç»„æˆçš„columnnameï¼Œå–å‰å‡ ä¸ªå•è¯é¦–å­—æ¯ï¼ŒåŠ æœ«å•è¯ç»„æˆcolumn_nameã€‚å¦‚: sample è¡¨ member_id ä¸Šçš„ç´¢å¼•ï¼šidx_sample_midã€‚ </li><li>ã€å»ºè®®ã€‘å•ä¸ªè¡¨ä¸Šçš„ç´¢å¼•ä¸ªæ•° ä¸èƒ½è¶…è¿‡6ä¸ª ã€‚ </li><li>ã€å»ºè®®ã€‘åœ¨å»ºç«‹ç´¢å¼•æ—¶ï¼Œå¤šè€ƒè™‘å»ºç«‹ è”åˆç´¢å¼• ï¼Œå¹¶æŠŠåŒºåˆ†åº¦æœ€é«˜çš„å­—æ®µæ”¾åœ¨æœ€å‰é¢ã€‚ </li><li>ã€å»ºè®®ã€‘åœ¨å¤šè¡¨ JOIN çš„SQLé‡Œï¼Œä¿è¯è¢«é©±åŠ¨è¡¨çš„è¿æ¥åˆ—ä¸Šæœ‰ç´¢å¼•ï¼Œè¿™æ ·JOIN æ‰§è¡Œæ•ˆç‡æœ€é«˜ã€‚ </li><li>ã€å»ºè®®ã€‘å»ºè¡¨æˆ–åŠ ç´¢å¼•æ—¶ï¼Œä¿è¯è¡¨é‡Œäº’ç›¸ä¸å­˜åœ¨ å†—ä½™ç´¢å¼• ã€‚ æ¯”å¦‚ï¼šå¦‚æœè¡¨é‡Œå·²ç»å­˜åœ¨key(a,b)ï¼Œ åˆ™key(a)ä¸ºå†—ä½™ç´¢å¼•ï¼Œéœ€è¦åˆ é™¤ã€‚</li></ol><h3 id="10-4-SQLç¼–å†™"><a href="#10-4-SQLç¼–å†™" class="headerlink" title="10.4 SQLç¼–å†™"></a>10.4 SQLç¼–å†™</h3><ol><li>ã€å¼ºåˆ¶ã€‘ç¨‹åºç«¯SELECTè¯­å¥å¿…é¡»æŒ‡å®šå…·ä½“å­—æ®µåç§°ï¼Œç¦æ­¢å†™æˆ *ã€‚ </li><li>ã€å»ºè®®ã€‘ç¨‹åºç«¯insertè¯­å¥æŒ‡å®šå…·ä½“å­—æ®µåç§°ï¼Œä¸è¦å†™æˆINSERT INTO t1 VALUES(â€¦)ã€‚ </li><li>ã€å»ºè®®ã€‘é™¤é™æ€è¡¨æˆ–å°è¡¨ï¼ˆ100è¡Œä»¥å†…ï¼‰ï¼ŒDMLè¯­å¥å¿…é¡»æœ‰WHEREæ¡ä»¶ï¼Œä¸”ä½¿ç”¨ç´¢å¼•æŸ¥æ‰¾ã€‚ </li><li>ã€å»ºè®®ã€‘INSERT INTOâ€¦VALUES(XX),(XX),(XX).. è¿™é‡ŒXXçš„å€¼ä¸è¦è¶…è¿‡5000ä¸ªã€‚ å€¼è¿‡å¤šè™½ç„¶ä¸Šçº¿å¾ˆ å¿«ï¼Œä½†ä¼šå¼•èµ·ä¸»ä»åŒæ­¥å»¶è¿Ÿã€‚ </li><li>ã€å»ºè®®ã€‘SELECTè¯­å¥ä¸è¦ä½¿ç”¨UNIONï¼Œæ¨èä½¿ç”¨UNION ALLï¼Œå¹¶ä¸”UNIONå­å¥ä¸ªæ•°é™åˆ¶åœ¨5ä¸ªä»¥ å†…ã€‚ </li><li>ã€å»ºè®®ã€‘çº¿ä¸Šç¯å¢ƒï¼Œå¤šè¡¨ JOIN ä¸è¦è¶…è¿‡5ä¸ªè¡¨ã€‚ </li><li>ã€å»ºè®®ã€‘å‡å°‘ä½¿ç”¨ORDER BYï¼Œå’Œä¸šåŠ¡æ²Ÿé€šèƒ½ä¸æ’åºå°±ä¸æ’åºï¼Œæˆ–å°†æ’åºæ”¾åˆ°ç¨‹åºç«¯å»åšã€‚ORDER BYã€GROUP BYã€DISTINCT è¿™äº›è¯­å¥è¾ƒä¸ºè€—è´¹CPUï¼Œæ•°æ®åº“çš„CPUèµ„æºæ˜¯æå…¶å®è´µçš„ã€‚ </li><li>ã€å»ºè®®ã€‘åŒ…å«äº†ORDER BYã€GROUP BYã€DISTINCT è¿™äº›æŸ¥è¯¢çš„è¯­å¥ï¼ŒWHERE æ¡ä»¶è¿‡æ»¤å‡ºæ¥çš„ç»“æœ é›†è¯·ä¿æŒåœ¨1000è¡Œä»¥å†…ï¼Œå¦åˆ™SQLä¼šå¾ˆæ…¢ã€‚ </li><li>ã€å»ºè®®ã€‘å¯¹å•è¡¨çš„å¤šæ¬¡alteræ“ä½œå¿…é¡»åˆå¹¶ä¸ºä¸€æ¬¡ å¯¹äºè¶…è¿‡100Wè¡Œçš„å¤§è¡¨è¿›è¡Œalter tableï¼Œå¿…é¡»ç»è¿‡DBAå®¡æ ¸ï¼Œå¹¶åœ¨ä¸šåŠ¡ä½å³°æœŸæ‰§è¡Œï¼Œå¤šä¸ªalteréœ€æ•´ åˆåœ¨ä¸€èµ·ã€‚ å› ä¸ºalter tableä¼šäº§ç”Ÿ è¡¨é” ï¼ŒæœŸé—´é˜»å¡å¯¹äºè¯¥è¡¨çš„æ‰€æœ‰å†™å…¥ï¼Œå¯¹äºä¸šåŠ¡å¯èƒ½ä¼šäº§ç”Ÿæ å¤§å½±å“ã€‚ </li><li>ã€å»ºè®®ã€‘æ‰¹é‡æ“ä½œæ•°æ®æ—¶ï¼Œéœ€è¦æ§åˆ¶äº‹åŠ¡å¤„ç†é—´éš”æ—¶é—´ï¼Œè¿›è¡Œå¿…è¦çš„sleepã€‚ </li><li>ã€å»ºè®®ã€‘äº‹åŠ¡é‡ŒåŒ…å«SQLä¸è¶…è¿‡5ä¸ªã€‚ å› ä¸ºè¿‡é•¿çš„äº‹åŠ¡ä¼šå¯¼è‡´é”æ•°æ®è¾ƒä¹…ï¼ŒMySQLå†…éƒ¨ç¼“å­˜ã€è¿æ¥æ¶ˆè€—è¿‡å¤šç­‰é—®é¢˜ã€‚ </li><li>ã€å»ºè®®ã€‘äº‹åŠ¡é‡Œæ›´æ–°è¯­å¥å°½é‡åŸºäºä¸»é”®æˆ–UNIQUE KEYï¼Œå¦‚UPDATEâ€¦ WHERE id&#x3D;XX; å¦åˆ™ä¼šäº§ç”Ÿé—´éš™é”ï¼Œå†…éƒ¨æ‰©å¤§é”å®šèŒƒå›´ï¼Œå¯¼è‡´ç³»ç»Ÿæ€§èƒ½ä¸‹é™ï¼Œäº§ç”Ÿæ­»é”ã€‚</li></ol><h2 id="11-PowerDesignerçš„ä½¿ç”¨"><a href="#11-PowerDesignerçš„ä½¿ç”¨" class="headerlink" title="11. PowerDesignerçš„ä½¿ç”¨"></a>11. PowerDesignerçš„ä½¿ç”¨</h2><p>PowerDesigneræ˜¯ä¸€æ¬¾å¼€å‘äººå‘˜å¸¸ç”¨çš„æ•°æ®åº“å»ºæ¨¡å·¥å…·ï¼Œç”¨æˆ·åˆ©ç”¨è¯¥è½¯ä»¶å¯ä»¥æ–¹ä¾¿åœ°åˆ¶ä½œ <code>æ•°æ®æµç¨‹å›¾</code> ã€ <code>æ¦‚å¿µæ•°æ®æ¨¡å‹</code> ã€ <code>ç‰©ç†æ•°æ®æ¨¡å‹</code> ï¼Œå®ƒå‡ ä¹åŒ…æ‹¬äº†æ•°æ®åº“æ¨¡å‹è®¾è®¡çš„å…¨è¿‡ç¨‹ï¼Œæ˜¯Sybaseå…¬å¸ä¸ºä¼ä¸šå»ºæ¨¡å’Œè®¾ è®¡æä¾›çš„ä¸€å¥—å®Œæ•´çš„é›†æˆåŒ–ä¼ä¸šçº§å»ºæ¨¡è§£å†³æ–¹æ¡ˆã€‚</p><h3 id="11-1-å¼€å§‹ç•Œé¢"><a href="#11-1-å¼€å§‹ç•Œé¢" class="headerlink" title="11.1 å¼€å§‹ç•Œé¢"></a>11.1 å¼€å§‹ç•Œé¢</h3><p>å½“å‰ä½¿ç”¨çš„PowerDesignerç‰ˆæœ¬æ˜¯16.5çš„ã€‚æ‰“å¼€è½¯ä»¶å³æ˜¯æ­¤é¡µé¢ï¼Œå¯é€‰æ‹©Create Model,ä¹Ÿå¯ä»¥é€‰æ‹©Do Not Show page Again,è‡ªè¡Œåœ¨æ‰“å¼€è½¯ä»¶ååˆ›å»ºä¹Ÿå¯ä»¥ï¼å®Œå…¨çœ‹ä¸ªäººçš„å–œå¥½ï¼Œåœ¨æ­¤æˆ‘åœ¨åé¢çš„å­¦ä¹ ä¸­ä¸åœ¨æ˜¾ç¤ºæ­¤é¡µé¢ã€‚</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707175250944.png" class=""><p>â€œCreate Modelâ€çš„ä½œç”¨ç±»ä¼¼äºæ™®é€šçš„ä¸€ä¸ªæ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶å¯ä»¥å•ç‹¬å­˜æ”¾ä¹Ÿå¯ä»¥å½’ç±»å­˜æ”¾ã€‚</p><p> â€œCreate Projectâ€çš„ä½œç”¨ç±»ä¼¼äºæ–‡ä»¶å¤¹ï¼Œè´Ÿè´£æŠŠæœ‰å…³è”å…³ç³»çš„æ–‡ä»¶é›†ä¸­å½’ç±»å­˜æ”¾ã€‚</p><h3 id="11-2-æ¦‚å¿µæ•°æ®æ¨¡å‹"><a href="#11-2-æ¦‚å¿µæ•°æ®æ¨¡å‹" class="headerlink" title="11.2 æ¦‚å¿µæ•°æ®æ¨¡å‹"></a>11.2 æ¦‚å¿µæ•°æ®æ¨¡å‹</h3><p>å¸¸ç”¨çš„æ¨¡å‹æœ‰4ç§ï¼Œåˆ†åˆ«æ˜¯ <code>æ¦‚å¿µæ¨¡å‹(CDM Conceptual Data Model)</code> ï¼Œ <code>ç‰©ç†æ¨¡å‹ï¼ˆPDM,Physical Data Modelï¼‰</code> ï¼Œ <code>é¢å‘å¯¹è±¡çš„æ¨¡å‹ï¼ˆOOM Objcet Oriented Modelï¼‰</code> å’Œ <code>ä¸šåŠ¡æ¨¡å‹ï¼ˆBPM Business Process Modelï¼‰</code> ï¼Œæˆ‘ä»¬å…ˆåˆ›å»ºæ¦‚å¿µæ•°æ®æ¨¡å‹ã€‚</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707175350250.png" class=""><p>ç‚¹å‡»ä¸Šé¢çš„okï¼Œå³å¯å‡ºç°ä¸‹å›¾å·¦è¾¹çš„æ¦‚å¿µæ¨¡å‹1ï¼Œå¯ä»¥è‡ªå®šä¹‰æ¦‚å¿µæ¨¡å‹çš„åå­—ï¼Œåœ¨æ¦‚å¿µæ¨¡å‹ä¸­ä½¿ç”¨æœ€å¤šçš„ å°±æ˜¯å¦‚å›¾æ‰€ç¤ºçš„Entity(å®ä½“),Relationship(å…³ç³»)</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707175604026.png" class=""><p><strong>Entityå®ä½“</strong></p><p>é€‰ä¸­å³è¾¹æ¡†ä¸­Entityè¿™ä¸ªåŠŸèƒ½ï¼Œå³å¯å‡ºç°ä¸‹é¢è¿™ä¸ªæ–¹æ¡†ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ä¹¦å†™nameçš„æ—¶å€™ï¼Œcodeè‡ªè¡Œè¡¥å…¨ï¼Œnameå¯ä»¥æ˜¯è‹±æ–‡çš„ä¹Ÿå¯ä»¥æ˜¯ä¸­æ–‡çš„ï¼Œä½†æ˜¯codeå¿…é¡»æ˜¯è‹±æ–‡çš„ã€‚</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707175653689.png" class=""><p><strong>å¡«å……å®ä½“å­—æ®µ</strong></p><p>Generalä¸­çš„nameå’Œcodeå¡«å¥½åï¼Œå°±å¯ä»¥ç‚¹å‡»Attributesï¼ˆå±æ€§ï¼‰æ¥è®¾ç½®nameï¼ˆåå­—ï¼‰ï¼Œcode(åœ¨æ•°æ®åº“ä¸­ çš„å­—æ®µå)ï¼ŒData Type(æ•°æ®ç±»å‹) ï¼Œlength(æ•°æ®ç±»å‹çš„é•¿åº¦)</p><ul><li>Name: å®ä½“åå­—ä¸€èˆ¬ä¸ºä¸­æ–‡ï¼Œå¦‚è®ºå›ç”¨æˆ· </li><li>Code: å®ä½“ä»£å·ï¼Œä¸€èˆ¬ç”¨è‹±æ–‡ï¼Œå¦‚XXXUser </li><li>Comment:æ³¨é‡Šï¼Œå¯¹æ­¤å®ä½“è¯¦ç»†è¯´æ˜ </li><li>Codeå±æ€§ï¼šä»£å·ï¼Œä¸€èˆ¬ç”¨è‹±æ–‡UID DataType </li><li>DomainåŸŸï¼Œè¡¨ç¤ºå±æ€§å–å€¼èŒƒå›´å¦‚å¯ä»¥åˆ›å»º10ä¸ªå­—ç¬¦çš„åœ°å€åŸŸ </li><li>M:Mandatoryå¼ºåˆ¶å±æ€§ï¼Œè¡¨ç¤ºè¯¥å±æ€§å¿…å¡«ã€‚ä¸èƒ½ä¸ºç©º </li><li>P:Primary Identiferæ˜¯å¦æ˜¯ä¸»æ ‡è¯†ç¬¦ï¼Œè¡¨ç¤ºå®ä½“å”¯ä¸€æ ‡è¯†ç¬¦ </li><li>D:Displayedæ˜¾ç¤ºå‡ºæ¥ï¼Œé»˜è®¤å…¨éƒ¨å‹¾é€‰</li></ul><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707175805226.png" class=""><p>åœ¨æ­¤ä¸Šå›¾è¯´æ˜nameå’Œcodeçš„èµ·åæ–¹æ³•</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707175827417.png" class=""><p><strong>è®¾ç½®ä¸»æ ‡è¯†ç¬¦</strong></p><p>å¦‚æœä¸å¸Œæœ›ç³»ç»Ÿè‡ªåŠ¨ç”Ÿæˆæ ‡è¯†ç¬¦è€Œæ˜¯æ‰‹åŠ¨è®¾ç½®çš„è¯ï¼Œé‚£ä¹ˆåˆ‡æ¢åˆ°Identifiersé€‰é¡¹å¡ï¼Œæ·»åŠ ä¸€è¡ŒIdentifierï¼Œ ç„¶åå•å‡»å·¦ä¸Šè§’çš„â€œå±æ€§â€æŒ‰é’®ï¼Œç„¶åå¼¹å‡ºçš„æ ‡è¯†å±æ€§è®¾ç½®å¯¹è¯æ¡†ä¸­å•å‡»â€œæ·»åŠ è¡Œâ€æŒ‰é’®ï¼Œé€‰æ‹©è¯¥æ ‡è¯†ä¸­ä½¿ç”¨çš„å±æ€§ã€‚ä¾‹å¦‚å°†å­¦å·è®¾ç½®ä¸ºå­¦ç”Ÿå®ä½“çš„æ ‡è¯†ã€‚</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707175858031.png" class=""><p><strong>æ”¾å¤§æ¨¡å‹</strong></p><p>åˆ›å»ºå¥½æ¦‚å¿µæ•°æ®æ¨¡å‹å¦‚å›¾æ‰€ç¤ºï¼Œä½†æ˜¯åˆ›å»ºå¥½çš„å­—ä½“å¾ˆå°ï¼Œè¯»è€…å¯ä»¥æŒ‰ç€ctrlé”®åŒæ—¶æ»‘åŠ¨é¼ æ ‡çš„å¯æ»‘åŠ¨æŒ‰é’® å³å¯æ”¾å¤§ç¼©å†™å­—ä½“ï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥çœ‹åˆ°ä¸»æ ‡è¯†ç¬¦æœ‰ä¸€ä¸ª*å·çš„æ ‡å¿—ï¼ŒåŒæ—¶ä¹Ÿæ˜¾ç¤ºå‡ºæ¥äº†ï¼Œname,Data typeå’Œ lengthè¿™äº›å¯è§çš„å±æ€§</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707175925155.png" class=""><p><strong>å®ä½“å…³ç³»</strong></p><p>åŒç†åˆ›å»ºä¸€ä¸ªç­çº§çš„å®ä½“ï¼ˆéœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯ï¼Œç‚¹å‡»å®Œå³è¾¹åŠŸèƒ½çš„æŒ‰é’®åéœ€è¦ç‚¹å‡»é¼ æ ‡æŒ‡é’ˆçŠ¶æ€çš„æŒ‰é’® æˆ–è€…å³å‡»é¼ æ ‡å³å¯ï¼Œä¸ç„¶å¾ˆå®¹æ˜“ä¹±æ“ä½œï¼Œè¿™ç‚¹æ³¨æ„ä¸€ä¸‹å°±å¯ä»¥äº†ï¼‰ï¼Œç„¶åä½¿ç”¨Relationshipï¼ˆå…³ç³»ï¼‰è¿™ä¸ª æŒ‰é’®å¯ä»¥è¿æ¥å­¦ç”Ÿå’Œç­çº§ä¹‹é—´çš„å…³ç³»ï¼Œå‘ç”Ÿä¸€å¯¹å¤šï¼ˆç­çº§å¯¹å­¦ç”Ÿï¼‰æˆ–è€…å¤šå¯¹ä¸€ï¼ˆå­¦ç”Ÿå¯¹ç­çº§ï¼‰çš„å…³ç³»ã€‚ </p><p>å¦‚å›¾æ‰€ç¤º</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707175954634.png" class=""><p>éœ€è¦æ³¨æ„çš„æ˜¯ç‚¹å‡»Relationshipè¿™ä¸ªæŒ‰é’®ï¼Œå°±æŠŠç­çº§å’Œå­¦ç”Ÿè”ç³»èµ·æ¥äº†ï¼Œå°±æ˜¯ä¸€æ¡çº¿ï¼Œç„¶ååŒå‡»è¿™æ¡çº¿è¿› è¡Œç¼–è¾‘ï¼Œåœ¨Generalè¿™å—èµ·nameå’Œcode</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707180021612.png" class=""><p>ä¸Šé¢çš„nameå’Œcodeèµ·å¥½åå°±å¯ä»¥åœ¨Cardinalitiesè¿™å—æŸ¥çœ‹ç­çº§å’Œå­¦ç”Ÿçš„å…³ç³»ï¼Œå¯ä»¥çœ‹åˆ°ç­çº§çš„ä¸€ç«¯æ˜¯ä¸€ æ¡çº¿ï¼Œå­¦ç”Ÿçš„ä¸€ç«¯æ˜¯ä¸‰æ¡ï¼Œä»£è¡¨ç­çº§å¯¹å­¦ç”Ÿæ˜¯ä¸€å¯¹å¤šçš„å…³ç³»å³oneå¯¹manyçš„å…³ç³»ï¼Œç‚¹å‡»åº”ç”¨ï¼Œç„¶åç¡®å®š å³å¯</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707180044291.png" class=""><p>ä¸€å¯¹å¤šå’Œå¤šå¯¹ä¸€ç»ƒä¹ å®Œè¿˜æœ‰å¤šå¯¹å¤šçš„ç»ƒä¹ ï¼Œå¦‚ä¸‹å›¾æ“ä½œæ‰€ç¤ºï¼Œè€å¸ˆå®ä½“å’Œä¸Šé¢ä»‹ç»çš„ä¸€æ ·ï¼Œè‡ªå·±å°† nameï¼Œdata typeç­‰ç­‰ä¿®æ”¹æˆè‡ªå·±éœ€è¦çš„å³å¯ï¼Œæ»¡è¶³é¡¹ç›®å¼€å‘éœ€æ±‚å³å¯ã€‚ï¼ˆcommentæ˜¯è§£é‡Šè¯´æ˜ï¼Œè‡ªå·±å¯ä»¥å†™ç›¸å…³çš„ä»‹ç»å’Œè¯´æ˜ï¼‰</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707180113532.png" class=""><p>å¤šå¯¹å¤šéœ€è¦æ³¨æ„çš„æ˜¯è‡ªå·±å¯ä»¥æ‰‹åŠ¨ç‚¹å‡»æŒ‰é’®å°†å…³ç³»è°ƒæ•´ç§°ä¸ºå¤šå¯¹å¤šçš„å…³ç³»manyå¯¹manyçš„å…³ç³»ï¼Œç„¶åç‚¹å‡»åº”ç”¨å’Œç¡®å®šå³å¯</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707180159184.png" class=""><p>ç»¼ä¸Šå³å¯å®Œæˆæœ€ç®€å•çš„å­¦ç”Ÿï¼Œç­çº§ï¼Œæ•™å¸ˆè¿™ç§æ¦‚å¿µæ•°æ®æ¨¡å‹çš„è®¾è®¡ï¼Œéœ€è¦è€ƒè™‘æ•°æ®çš„ç±»å‹å’Œä¸»æ ‡è¯†ç ï¼Œ æ˜¯å¦ä¸ºç©ºã€‚å…³ç³»æ˜¯ä¸€å¯¹ä¸€è¿˜æ˜¯ä¸€å¯¹å¤šè¿˜æ˜¯å¤šå¯¹å¤šçš„å…³ç³»ï¼Œè‡ªå·±éœ€è¦å…ˆè§„åˆ’å¥½å†è®¾è®¡ï¼Œç„¶åå°±okäº†ã€‚</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707180254510.png" class=""><h3 id="11-3-ç‰©ç†æ•°æ®æ¨¡å‹"><a href="#11-3-ç‰©ç†æ•°æ®æ¨¡å‹" class="headerlink" title="11.3 ç‰©ç†æ•°æ®æ¨¡å‹"></a>11.3 ç‰©ç†æ•°æ®æ¨¡å‹</h3><p>ä¸Šé¢æ˜¯æ¦‚å¿µæ•°æ®æ¨¡å‹ï¼Œä¸‹é¢ä»‹ç»ä¸€ä¸‹ç‰©ç†æ•°æ®æ¨¡å‹ï¼Œä»¥å ç»å¸¸ä½¿ç”¨ çš„å°±æ˜¯ç‰©ç†æ•°æ®æ¨¡å‹ã€‚æ‰“å¼€ PowerDesignerï¼Œç„¶åç‚¹å‡»Fileâ€“&gt;New Modelç„¶åé€‰æ‹©å¦‚ä¸‹å›¾æ‰€ç¤ºçš„ç‰©ç†æ•°æ®æ¨¡å‹ï¼Œç‰©ç†æ•°æ®æ¨¡å‹çš„åå­—è‡ªå·±èµ·ï¼Œç„¶åé€‰æ‹©è‡ªå·±æ‰€ä½¿ç”¨çš„æ•°æ®åº“å³å¯ã€‚</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707180327712.png" class=""><p>åˆ›å»ºå¥½ä¸»é¡µé¢å¦‚å›¾æ‰€ç¤ºï¼Œä½†æ˜¯å³è¾¹çš„æŒ‰é’®å’Œæ¦‚å¿µæ¨¡å‹ç•¥æœ‰å·®åˆ«ï¼Œç‰©ç†æ¨¡å‹æœ€å¸¸ç”¨çš„ä¸‰ä¸ªæ˜¯ <code>table(è¡¨)</code> ï¼Œ <code>view(è§†å›¾)</code>ï¼Œ <code>reference(å…³ç³») </code>ï¼›</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707180418090.png" class=""><p>é¼ æ ‡å…ˆç‚¹å‡»å³è¾¹tableè¿™ä¸ªæŒ‰é’®ç„¶ååœ¨æ–°å»ºçš„ç‰©ç†æ¨¡å‹ç‚¹ä¸€ä¸‹ï¼Œå³å¯æ–°å»ºä¸€ä¸ªè¡¨ï¼Œç„¶ååŒå‡»æ–°å»ºå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œåœ¨Generalçš„nameå’Œcodeå¡«ä¸Šè‡ªå·±éœ€è¦çš„ï¼Œç‚¹å‡»åº”ç”¨å³å¯ï¼‰ï¼Œå¦‚ä¸‹å›¾ï¼š</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707180449212.png" class=""><p>ç„¶åç‚¹å‡»Columns,å¦‚ä¸‹å›¾è®¾ç½®ï¼Œéå¸¸ç®€å•ï¼Œéœ€è¦æ³¨æ„çš„å°±æ˜¯Pï¼ˆprimaryä¸»é”®ï¼‰ , F ï¼ˆforeign keyå¤–é”®ï¼‰ , Mï¼ˆmandatoryå¼ºåˆ¶æ€§çš„ï¼Œä»£è¡¨ä¸å¯ä¸ºç©ºï¼‰ è¿™ä¸‰ä¸ªã€‚</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707180537251.png" class=""><p>åœ¨æ­¤è®¾ç½®å­¦å·çš„è‡ªå¢ï¼ˆMYSQLé‡Œé¢çš„è‡ªå¢æ˜¯è¿™ä¸ªAUTO_INCREMENTï¼‰ï¼Œç­çº§ç¼–å·åŒç†ï¼Œä¸å¤šèµ˜è¿°ï¼</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707180556645.png" class=""><p>åœ¨ä¸‹é¢çš„è¿™ä¸ªç‚¹ä¸Šå¯¹å·å³å¯ï¼Œå°±è®¾ç½®å¥½äº†è‡ªå¢</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707180619440.png" class=""><p>å…¨éƒ¨å®Œæˆåå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707180643107.png" class=""><p>ç­çº§ç‰©ç†æ¨¡å‹åŒç†å¦‚ä¸‹å›¾æ‰€ç¤ºåˆ›å»ºå³å¯</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707180723698.png" class=""><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707180744600.png" class=""><p>å®Œæˆåå¦‚ä¸‹å›¾æ‰€ç¤º</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707180806150.png" class=""><p>ä¸Šé¢çš„è®¾ç½®å¥½å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œç„¶åä¸‹é¢æ˜¯å…³é”®çš„åœ°æ–¹ï¼Œç‚¹å‡»å³è¾¹æŒ‰é’®Referenceè¿™ä¸ªæŒ‰é’®ï¼Œå› ä¸ºæ˜¯ç­çº§å¯¹å­¦ ç”Ÿæ˜¯ä¸€å¯¹å¤šçš„ï¼Œæ‰€ä»¥é¼ æ ‡ä»å­¦ç”Ÿæ‹‰åˆ°ç­çº§å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå­¦ç”Ÿè¡¨å°†å‘ç”Ÿå˜åŒ–ï¼Œå­¦ç”Ÿè¡¨é‡Œé¢å¢åŠ äº†ä¸€è¡Œï¼Œè¿™ è¡Œæ˜¯ç­çº§è¡¨çš„ä¸»é”®ä½œä¸ºå­¦ç”Ÿè¡¨çš„å¤–é”®ï¼Œå°†ç­çº§è¡¨å’Œå­¦ç”Ÿè¡¨è”ç³»èµ·æ¥ã€‚ï¼ˆä»”ç»†è§‚å¯Ÿå³å¯çœ‹åˆ°åŒºåˆ«ã€‚ï¼‰</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707180828164.png" class=""><p>åšå®Œä¸Šé¢çš„æ“ä½œï¼Œå°±å¯ä»¥åŒå‡»ä¸­é—´çš„ä¸€æ¡çº¿ï¼Œæ˜¾ç¤ºå¦‚ä¸‹å›¾ï¼Œä¿®æ”¹nameå’Œcodeå³å¯</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707183743297.png" class=""><p>ä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¿®æ”¹å®Œæ¯•åæ˜¾ç¤ºçš„ç»“æœå´å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå¹¶æ²¡æœ‰åŠæ³•ç›´æ¥åƒæ¦‚å¿µæ¨¡å‹é‚£æ ·ï¼Œä¿®æ”¹è¿‡å æ˜¾ç¤ºåœ¨ä¸­é—´çš„é‚£æ¡çº¿ä¸Šé¢ï¼Œè‡ªå·±æ˜ç™½å³å¯ã€‚</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707193816176.png" class=""><p>å­¦ä¹ äº†å¤šå¯¹ä¸€æˆ–è€…ä¸€å¯¹å¤šçš„å…³ç³»ï¼Œæ¥ä¸‹æ¥å­¦ä¹ å¤šå¯¹å¯¹çš„å…³ç³»ï¼ŒåŒç†è‡ªå·±å»ºå¥½è€å¸ˆè¡¨ï¼Œè¿™é‡Œä¸åœ¨å™è¿°ï¼Œè®°å¾—è€å¸ˆç¼–å·è‡ªå¢ï¼Œå»ºå¥½å¦‚ä¸‹å›¾æ‰€ç¤º</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707193932694.png" class=""><p>ä¸‹é¢æ˜¯å¤šå¯¹å¤šå…³ç³»çš„å…³é”®ï¼Œç”±äºç‰©ç†æ¨¡å‹å¤šå¯¹å¤šçš„å…³ç³»éœ€è¦ä¸€ä¸ªä¸­é—´è¡¨æ¥è¿æ¥ï¼Œå¦‚ä¸‹å›¾ï¼Œåªè®¾ç½®ä¸€ä¸ªå­— æ®µï¼Œä¸»é”®ï¼Œè‡ªå¢</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707193957629.png" class=""><p>ç‚¹å‡»åº”ç”¨ï¼Œç„¶åè®¾ç½®Columnsï¼Œåªæ·»åŠ ä¸€ä¸ªå­—æ®µ</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707194048843.png" class=""><p>è¿™æ˜¯è®¾ç½®å­—æ®µé€’å¢ï¼Œå‰é¢å·²ç»å™è¿°è¿‡å¥½å‡ æ¬¡</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707194111885.png" class=""><p>è®¾ç½®å¥½åå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œéœ€è¦æ³¨æ„çš„æ˜¯æœ‰ç®­å¤´çš„ä¸€æ–¹æ˜¯ä¸€ï¼Œæ— ç®­å¤´çš„ä¸€æ–¹æ˜¯å¤šï¼Œå³ä¸€å¯¹å¤šçš„å¤šå¯¹ä¸€çš„å…³ç³» éœ€è¦ææ¸…æ¥šï¼Œå­¦ç”Ÿä¹Ÿå¯ä»¥æœ‰å¾ˆå¤šè€å¸ˆï¼Œè€å¸ˆä¹Ÿå¯ä»¥æœ‰å¾ˆå¤šå­¦ç”Ÿï¼Œæ‰€ä»¥å­¦ç”Ÿå’Œè€å¸ˆéƒ½å¯ä»¥æ˜¯ä¸»ä½“ï¼›</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707194138137.png" class=""><p>å¯ä»¥çœ‹åˆ°æ·»åŠ å…³ç³»ä»¥åå­¦ç”Ÿå’Œæ•™å¸ˆçš„å…³ç³»è¡¨å‰åå‘ç”Ÿçš„å˜åŒ–</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707194158936.png" class=""><h3 id="11-4-æ¦‚å¿µæ¨¡å‹è½¬ä¸ºç‰©ç†æ¨¡å‹"><a href="#11-4-æ¦‚å¿µæ¨¡å‹è½¬ä¸ºç‰©ç†æ¨¡å‹" class="headerlink" title="11.4 æ¦‚å¿µæ¨¡å‹è½¬ä¸ºç‰©ç†æ¨¡å‹"></a>11.4 æ¦‚å¿µæ¨¡å‹è½¬ä¸ºç‰©ç†æ¨¡å‹</h3><p>1ï¼šå¦‚ä¸‹å›¾æ‰€ç¤ºå…ˆæ‰“å¼€æ¦‚å¿µæ¨¡å‹å›¾ï¼Œç„¶åç‚¹å‡»Tool,å¦‚ä¸‹å›¾æ‰€ç¤º</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707194228064.png" class=""><p>ç‚¹å¼€çš„é¡µé¢å¦‚ä¸‹æ‰€ç¤ºï¼Œnameå’Œcodeå·²ç»ä»æ¦‚å¿µæ¨¡å‹1æ”¹æˆç‰©ç†æ¨¡å‹1äº†</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707194248236.png" class=""><p>å®Œæˆåå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå°†è‡ªè¡Œæ‰“å¼€ä¿®æ”¹çš„ç‰©ç†æ¨¡å‹ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯è¿™äº›è¡¨çš„æ•°æ®ç±»å‹å·²ç»è‡ªè¡Œæ”¹å˜äº†ï¼Œè€Œ ä¸”ä¸­é—´è¡¨å‡ºç°ä¸¤ä¸ªä¸»é”®ï¼Œå³åŒä¸»é”®</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707194308595.png" class=""><h3 id="11-5-ç‰©ç†æ¨¡å‹è½¬ä¸ºæ¦‚å¿µæ¨¡å‹"><a href="#11-5-ç‰©ç†æ¨¡å‹è½¬ä¸ºæ¦‚å¿µæ¨¡å‹" class="headerlink" title="11.5 ç‰©ç†æ¨¡å‹è½¬ä¸ºæ¦‚å¿µæ¨¡å‹"></a>11.5 ç‰©ç†æ¨¡å‹è½¬ä¸ºæ¦‚å¿µæ¨¡å‹</h3><p>ä¸Šé¢ä»‹ç»äº†æ¦‚å¿µæ¨¡å‹è½¬ç‰©ç†æ¨¡å‹ï¼Œä¸‹é¢ä»‹ç»ä¸€ä¸‹ç‰©ç†æ¨¡å‹è½¬æ¦‚å¿µæ¨¡å‹ï¼ˆå¦‚ä¸‹å›¾ç‚¹å‡»æ“ä½œå³å¯ï¼‰</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707194405358.png" class=""><p>ç„¶åå‡ºç°å¦‚ä¸‹å›¾æ‰€ç¤ºç•Œé¢ï¼Œç„¶åå°†ç‰©ç†ä¿®æ”¹ä¸ºæ¦‚å¿µ ï¼Œç‚¹å‡»åº”ç”¨ç¡®è®¤å³å¯</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707194419360.png" class=""><p>ç‚¹å‡»ç¡®è®¤åå°†è‡ªè¡Œæ‰“å¼€å¦‚ä¸‹å›¾æ‰€ç¤ºçš„é¡µé¢ï¼Œè‡ªå·±è§‚å¯Ÿæœ‰ä½•å˜åŒ–ï¼Œå¦‚æœè½¬æ¢ä¸ºoracleçš„ï¼Œæ•°æ®ç±»å‹ä¼šå‘ç”Ÿå˜ åŒ–ï¼Œæ¯”å¦‚Varchar2ç­‰ç­‰ï¼‰ï¼›</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707194433407.png" class=""><h3 id="11-6-ç‰©ç†æ¨¡å‹å¯¼å‡ºSQLè¯­å¥"><a href="#11-6-ç‰©ç†æ¨¡å‹å¯¼å‡ºSQLè¯­å¥" class="headerlink" title="11.6 ç‰©ç†æ¨¡å‹å¯¼å‡ºSQLè¯­å¥"></a>11.6 ç‰©ç†æ¨¡å‹å¯¼å‡ºSQLè¯­å¥</h3><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707194544714.png" class=""><p>æ‰“å¼€ä¹‹åå¦‚å›¾æ‰€ç¤ºï¼Œä¿®æ”¹å¥½å­˜åœ¨sqlè¯­å¥çš„ä½ç½®å’Œç”Ÿæˆæ–‡ä»¶çš„åç§°å³å¯</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707194557554.png" class=""><p>åœ¨Selectionä¸­é€‰æ‹©éœ€è¦å¯¼å‡ºçš„è¡¨ï¼Œç„¶åç‚¹å‡»åº”ç”¨å’Œç¡®è®¤å³å¯</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707194637242.png" class=""><p>å®Œæˆä»¥åå‡ºç°å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå¯ä»¥ç‚¹å‡»Editæˆ–è€…closeæŒ‰é’®</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707194727849.png" class=""><p>è‡ªæ­¤ï¼Œå°±å®Œæˆäº†å¯¼å‡ºsqlè¯­å¥ï¼Œå°±å¯ä»¥åˆ°è‡ªå·±æŒ‡å®šçš„ä½ç½®æŸ¥çœ‹å¯¼å‡ºçš„sqlè¯­å¥äº†ï¼›PowerDesigneråœ¨ä»¥ååœ¨ é¡¹ç›®å¼€å‘è¿‡ç¨‹ä¸­ç”¨æ¥åšéœ€æ±‚åˆ†æå’Œæ•°æ®åº“çš„è®¾è®¡éå¸¸çš„æ–¹ä¾¿å’Œå¿«æ·ã€‚</p><h1 id="ç¬¬12ç« -æ•°æ®åº“å…¶å®ƒè°ƒä¼˜ç­–ç•¥"><a href="#ç¬¬12ç« -æ•°æ®åº“å…¶å®ƒè°ƒä¼˜ç­–ç•¥" class="headerlink" title="ç¬¬12ç« _æ•°æ®åº“å…¶å®ƒè°ƒä¼˜ç­–ç•¥"></a>ç¬¬12ç« _æ•°æ®åº“å…¶å®ƒè°ƒä¼˜ç­–ç•¥</h1><h2 id="1-æ•°æ®åº“è°ƒä¼˜çš„æªæ–½"><a href="#1-æ•°æ®åº“è°ƒä¼˜çš„æªæ–½" class="headerlink" title="1. æ•°æ®åº“è°ƒä¼˜çš„æªæ–½"></a>1. æ•°æ®åº“è°ƒä¼˜çš„æªæ–½</h2><h3 id="1-1-è°ƒä¼˜çš„ç›®æ ‡"><a href="#1-1-è°ƒä¼˜çš„ç›®æ ‡" class="headerlink" title="1.1 è°ƒä¼˜çš„ç›®æ ‡"></a>1.1 è°ƒä¼˜çš„ç›®æ ‡</h3><ul><li>å°½å¯èƒ½èŠ‚çœç³»ç»Ÿèµ„æº ï¼Œä»¥ä¾¿ç³»ç»Ÿå¯ä»¥æä¾›æ›´å¤§è´Ÿè·çš„æœåŠ¡ã€‚ï¼ˆååé‡æ›´å¤§ï¼‰ </li><li>åˆç†çš„ç»“æ„è®¾è®¡å’Œå‚æ•°è°ƒæ•´ï¼Œä»¥æé«˜ç”¨æˆ·æ“ä½œå“åº”çš„é€Ÿåº¦ ã€‚ï¼ˆå“åº”é€Ÿåº¦æ›´å¿«ï¼‰ </li><li>å‡å°‘ç³»ç»Ÿçš„ç“¶é¢ˆï¼Œæé«˜MySQLæ•°æ®åº“æ•´ä½“çš„æ€§èƒ½ã€‚</li></ul><h3 id="1-2-å¦‚ä½•å®šä½è°ƒä¼˜é—®é¢˜"><a href="#1-2-å¦‚ä½•å®šä½è°ƒä¼˜é—®é¢˜" class="headerlink" title="1.2 å¦‚ä½•å®šä½è°ƒä¼˜é—®é¢˜"></a>1.2 å¦‚ä½•å®šä½è°ƒä¼˜é—®é¢˜</h3><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707200915836.png" class=""><p>å¦‚ä½•ç¡®å®šå‘¢ï¼Ÿä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæœ‰å¦‚ä¸‹å‡ ç§æ–¹å¼ï¼š</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707201133424.png" class=""><h3 id="1-3-è°ƒä¼˜çš„ç»´åº¦å’Œæ­¥éª¤"><a href="#1-3-è°ƒä¼˜çš„ç»´åº¦å’Œæ­¥éª¤" class="headerlink" title="1.3 è°ƒä¼˜çš„ç»´åº¦å’Œæ­¥éª¤"></a>1.3 è°ƒä¼˜çš„ç»´åº¦å’Œæ­¥éª¤</h3><p>æˆ‘ä»¬éœ€è¦è°ƒä¼˜çš„å¯¹è±¡æ˜¯æ•´ä¸ªæ•°æ®åº“ç®¡ç†ç³»ç»Ÿï¼Œå®ƒä¸ä»…åŒ…æ‹¬ SQL æŸ¥è¯¢ï¼Œè¿˜åŒ…æ‹¬æ•°æ®åº“çš„éƒ¨ç½²é…ç½®ã€æ¶æ„ ç­‰ã€‚ä»è¿™ä¸ªè§’åº¦æ¥è¯´ï¼Œæˆ‘ä»¬æ€è€ƒçš„ç»´åº¦å°±ä¸ä»…ä»…å±€é™åœ¨ SQL ä¼˜åŒ–ä¸Šäº†ã€‚é€šè¿‡å¦‚ä¸‹çš„æ­¥éª¤æˆ‘ä»¬è¿›è¡Œæ¢³ç†ï¼š</p><h4 id="ç¬¬1æ­¥ï¼šé€‰æ‹©é€‚åˆçš„-DBMS"><a href="#ç¬¬1æ­¥ï¼šé€‰æ‹©é€‚åˆçš„-DBMS" class="headerlink" title="ç¬¬1æ­¥ï¼šé€‰æ‹©é€‚åˆçš„ DBMS"></a>ç¬¬1æ­¥ï¼šé€‰æ‹©é€‚åˆçš„ DBMS</h4><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707201443229.png" class=""><h4 id="ç¬¬2æ­¥ï¼šä¼˜åŒ–è¡¨è®¾è®¡"><a href="#ç¬¬2æ­¥ï¼šä¼˜åŒ–è¡¨è®¾è®¡" class="headerlink" title="ç¬¬2æ­¥ï¼šä¼˜åŒ–è¡¨è®¾è®¡"></a>ç¬¬2æ­¥ï¼šä¼˜åŒ–è¡¨è®¾è®¡</h4><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707201617799.png" class=""><h4 id="ç¬¬3æ­¥ï¼šä¼˜åŒ–é€»è¾‘æŸ¥è¯¢"><a href="#ç¬¬3æ­¥ï¼šä¼˜åŒ–é€»è¾‘æŸ¥è¯¢" class="headerlink" title="ç¬¬3æ­¥ï¼šä¼˜åŒ–é€»è¾‘æŸ¥è¯¢"></a>ç¬¬3æ­¥ï¼šä¼˜åŒ–é€»è¾‘æŸ¥è¯¢</h4><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707202059972.png" class=""><h4 id="ç¬¬4æ­¥ï¼šä¼˜åŒ–ç‰©ç†æŸ¥è¯¢"><a href="#ç¬¬4æ­¥ï¼šä¼˜åŒ–ç‰©ç†æŸ¥è¯¢" class="headerlink" title="ç¬¬4æ­¥ï¼šä¼˜åŒ–ç‰©ç†æŸ¥è¯¢"></a>ç¬¬4æ­¥ï¼šä¼˜åŒ–ç‰©ç†æŸ¥è¯¢</h4><p>ç‰©ç†æŸ¥è¯¢ä¼˜åŒ–æ˜¯åœ¨ç¡®å®šäº†é€»è¾‘æŸ¥è¯¢ä¼˜åŒ–ä¹‹åï¼Œé‡‡ç”¨ç‰©ç†ä¼˜åŒ–æŠ€æœ¯ï¼ˆæ¯”å¦‚ç´¢å¼•ç­‰ï¼‰ï¼Œé€šè¿‡è®¡ç®—ä»£ä»·æ¨¡å‹å¯¹ å„ç§å¯èƒ½çš„è®¿é—®è·¯å¾„è¿›è¡Œä¼°ç®—ï¼Œä»è€Œæ‰¾åˆ°æ‰§è¡Œæ–¹å¼ä¸­ä»£ä»·æœ€å°çš„ä½œä¸ºæ‰§è¡Œè®¡åˆ’ã€‚<strong>åœ¨è¿™ä¸ªéƒ¨åˆ†ä¸­ï¼Œæˆ‘ä»¬éœ€è¦æŒæ¡çš„é‡ç‚¹æ˜¯å¯¹ç´¢å¼•çš„åˆ›å»ºå’Œä½¿ç”¨ã€‚</strong></p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707202156660.png" class=""><h4 id="ç¬¬5æ­¥ï¼šä½¿ç”¨-Redis-æˆ–-Memcached-ä½œä¸ºç¼“å­˜"><a href="#ç¬¬5æ­¥ï¼šä½¿ç”¨-Redis-æˆ–-Memcached-ä½œä¸ºç¼“å­˜" class="headerlink" title="ç¬¬5æ­¥ï¼šä½¿ç”¨ Redis æˆ– Memcached ä½œä¸ºç¼“å­˜"></a>ç¬¬5æ­¥ï¼šä½¿ç”¨ Redis æˆ– Memcached ä½œä¸ºç¼“å­˜</h4><p>é™¤äº†å¯ä»¥å¯¹ SQL æœ¬èº«è¿›è¡Œä¼˜åŒ–ä»¥å¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥è¯·å¤–æ´æå‡æŸ¥è¯¢çš„æ•ˆç‡ã€‚</p><p>å› ä¸ºæ•°æ®éƒ½æ˜¯å­˜æ”¾åˆ°æ•°æ®åº“ä¸­ï¼Œæˆ‘ä»¬éœ€è¦ä»æ•°æ®åº“å±‚ä¸­å–å‡ºæ•°æ®æ”¾åˆ°å†…å­˜ä¸­è¿›è¡Œä¸šåŠ¡é€»è¾‘çš„æ“ä½œï¼Œå½“ç”¨ æˆ·é‡å¢å¤§çš„æ—¶å€™ï¼Œå¦‚æœé¢‘ç¹åœ°è¿›è¡Œæ•°æ®æŸ¥è¯¢ï¼Œä¼šæ¶ˆè€—æ•°æ®åº“çš„å¾ˆå¤šèµ„æºã€‚å¦‚æœæˆ‘ä»¬å°†å¸¸ç”¨çš„æ•°æ®ç›´æ¥æ”¾ åˆ°å†…å­˜ä¸­ï¼Œå°±ä¼šå¤§å¹…æå‡æŸ¥è¯¢çš„æ•ˆç‡ã€‚</p><p>é”®å€¼å­˜å‚¨æ•°æ®åº“å¯ä»¥å¸®æˆ‘ä»¬è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p><p>å¸¸ç”¨çš„é”®å€¼å­˜å‚¨æ•°æ®åº“æœ‰ Redis å’Œ Memcachedï¼Œå®ƒä»¬éƒ½å¯ä»¥å°†æ•°æ®å­˜æ”¾åˆ°å†…å­˜ä¸­ã€‚</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707202436467.png" class=""><h4 id="ç¬¬6æ­¥ï¼šåº“çº§ä¼˜åŒ–"><a href="#ç¬¬6æ­¥ï¼šåº“çº§ä¼˜åŒ–" class="headerlink" title="ç¬¬6æ­¥ï¼šåº“çº§ä¼˜åŒ–"></a>ç¬¬6æ­¥ï¼šåº“çº§ä¼˜åŒ–</h4><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707202555506.png" class=""><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707202732911.png" class=""><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707203538155.png" class=""><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707203607993.png" class=""><blockquote><p>ä½†éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåˆ†æ‹†åœ¨æå‡æ•°æ®åº“æ€§èƒ½çš„åŒæ—¶ï¼Œä¹Ÿä¼šå¢åŠ ç»´æŠ¤å’Œä½¿ç”¨æˆæœ¬ã€‚</p></blockquote><h2 id="2-ä¼˜åŒ–MySQLæœåŠ¡å™¨"><a href="#2-ä¼˜åŒ–MySQLæœåŠ¡å™¨" class="headerlink" title="2. ä¼˜åŒ–MySQLæœåŠ¡å™¨"></a>2. ä¼˜åŒ–MySQLæœåŠ¡å™¨</h2><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707203818987.png" class=""><h3 id="2-1-ä¼˜åŒ–æœåŠ¡å™¨ç¡¬ä»¶"><a href="#2-1-ä¼˜åŒ–æœåŠ¡å™¨ç¡¬ä»¶" class="headerlink" title="2.1 ä¼˜åŒ–æœåŠ¡å™¨ç¡¬ä»¶"></a>2.1 ä¼˜åŒ–æœåŠ¡å™¨ç¡¬ä»¶</h3><p>æœåŠ¡å™¨çš„ç¡¬ä»¶æ€§èƒ½ç›´æ¥å†³å®šç€MySQLæ•°æ®åº“çš„æ€§èƒ½ã€‚ç¡¬ä»¶çš„æ€§èƒ½ç“¶é¢ˆç›´æ¥å†³å®šMySQLæ•°æ®åº“çš„è¿è¡Œé€Ÿåº¦ å’Œæ•ˆç‡ã€‚é’ˆå¯¹æ€§èƒ½ç“¶é¢ˆæé«˜ç¡¬ä»¶é…ç½®ï¼Œå¯ä»¥æé«˜MySQLæ•°æ®åº“æŸ¥è¯¢ã€æ›´æ–°çš„é€Ÿåº¦ã€‚ </p><p>ï¼ˆ1ï¼‰ <code>é…ç½®è¾ƒå¤§çš„å†…å­˜</code> ã€‚è¶³å¤Ÿå¤§çš„æ˜¾å­˜æ˜¯æé«˜MySQLæ•°æ®åº“æ€§èƒ½çš„æ–¹æ³•ä¹‹ä¸€ã€‚å†…å­˜çš„é€Ÿåº¦æ¯”ç£ç›˜I&#x2F;Oå¿«å¾—å¤šï¼Œå¯ä»¥é€šè¿‡å¢åŠ ç³»ç»Ÿçš„<code>ç¼“å†²åŒºå®¹é‡</code>ä½¿æ•°æ®åœ¨å†…å­˜ä¸­åœç•™çš„æ—¶é—´æ›´é•¿ï¼Œä»¥<code>å‡å°‘ç£ç›˜I/O</code>ã€‚</p><p>ï¼ˆ2ï¼‰ <code>é…ç½®é«˜é€Ÿç£ç›˜ç³»ç»Ÿ </code>ï¼Œä»¥å‡å°‘è¯»ç›˜çš„ç­‰å¾…æ—¶é—´ï¼Œæé«˜å“åº”é€Ÿåº¦ã€‚ç£ç›˜çš„I&#x2F;Oèƒ½åŠ›ï¼Œä¹Ÿå°±æ˜¯å®ƒçš„å¯»é“èƒ½åŠ›ï¼Œç›®å‰çš„SCSIé«˜é€Ÿæ—‹è½¬çš„æ˜¯7200è½¬&#x2F;åˆ†é’Ÿï¼Œè¿™æ ·çš„é€Ÿåº¦ï¼Œä¸€æ—¦è®¿é—®çš„ç”¨æˆ·é‡ä¸Šå»ï¼Œç£ç›˜çš„å‹åŠ›å°±ä¼šè¿‡å¤§ï¼Œå¦‚æœæ˜¯æ¯å¤©çš„ç½‘ç«™pv (page view) åœ¨150wï¼Œè¿™æ ·çš„ä¸€èˆ¬çš„é…ç½®å°±æ— æ³•æ»¡è¶³è¿™æ ·çš„éœ€æ±‚äº†ã€‚ç°åœ¨SSDç››è¡Œï¼Œåœ¨SSDä¸Šéšæœºè®¿é—®å’Œé¡ºåºè®¿é—®æ€§èƒ½å·®ä¸å¤šï¼Œä½¿ç”¨SSDå¯ä»¥å‡å°‘éšæœºIOå¸¦æ¥çš„æ€§èƒ½æŸè€—ã€‚</p><p>ï¼ˆ3ï¼‰ <code>åˆç†åˆ†å¸ƒç£ç›˜I/O</code>ï¼ŒæŠŠç£ç›˜I&#x2F;Oåˆ†æ•£åœ¨å¤šä¸ªè®¾å¤‡ï¼Œä»¥å‡å°‘èµ„æºç«äº‰ï¼Œæé«˜å†°ç®±æ“ä½œèƒ½åŠ›ã€‚</p><p>ï¼ˆ4ï¼‰ <code>é…ç½®å¤šå¤„ç†å™¨</code>, MySQLæ˜¯å¤šçº¿ç¨‹çš„æ•°æ®åº“ï¼Œå¤šå¤„ç†å™¨å¯åŒæ—¶æ‰§è¡Œå¤šä¸ªçº¿ç¨‹ã€‚</p><h3 id="2-2-ä¼˜åŒ–MySQLçš„å‚æ•°"><a href="#2-2-ä¼˜åŒ–MySQLçš„å‚æ•°" class="headerlink" title="2.2 ä¼˜åŒ–MySQLçš„å‚æ•°"></a>2.2 ä¼˜åŒ–MySQLçš„å‚æ•°</h3><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707204403406.png" class=""><ul><li><p>innodb_buffer_pool_size ï¼šè¿™ä¸ªå‚æ•°æ˜¯Mysqlæ•°æ®åº“æœ€é‡è¦çš„å‚æ•°ä¹‹ä¸€ï¼Œè¡¨ç¤ºInnoDBç±»å‹çš„ è¡¨ å’Œç´¢å¼•çš„æœ€å¤§ç¼“å­˜ ã€‚å®ƒä¸ä»…ä»…ç¼“å­˜ ç´¢å¼•æ•°æ® ï¼Œè¿˜ä¼šç¼“å­˜ è¡¨çš„æ•°æ® ã€‚è¿™ä¸ªå€¼è¶Šå¤§ï¼ŒæŸ¥è¯¢çš„é€Ÿåº¦å°±ä¼šè¶Š å¿«ã€‚ä½†æ˜¯è¿™ä¸ªå€¼å¤ªå¤§ä¼šå½±å“æ“ä½œç³»ç»Ÿçš„æ€§èƒ½ã€‚</p></li><li><p>key_buffer_size ï¼šè¡¨ç¤º ç´¢å¼•ç¼“å†²åŒºçš„å¤§å° ã€‚ç´¢å¼•ç¼“å†²åŒºæ˜¯æ‰€æœ‰çš„ çº¿ç¨‹å…±äº« ã€‚å¢åŠ ç´¢å¼•ç¼“å†²åŒºå¯ ä»¥å¾—åˆ°æ›´å¥½å¤„ç†çš„ç´¢å¼•ï¼ˆå¯¹æ‰€æœ‰è¯»å’Œå¤šé‡å†™ï¼‰ã€‚å½“ç„¶ï¼Œè¿™ä¸ªå€¼ä¸æ˜¯è¶Šå¤§è¶Šå¥½ï¼Œå®ƒçš„å¤§å°å–å†³äºå†…å­˜ çš„å¤§å°ã€‚å¦‚æœè¿™ä¸ªå€¼å¤ªå¤§ï¼Œå°±ä¼šå¯¼è‡´æ“ä½œç³»ç»Ÿé¢‘ç¹æ¢é¡µï¼Œä¹Ÿä¼šé™ä½ç³»ç»Ÿæ€§èƒ½ã€‚å¯¹äºå†…å­˜åœ¨ 4GB å·¦å³ çš„æœåŠ¡å™¨è¯¥å‚æ•°å¯è®¾ç½®ä¸º 256M æˆ– 384M ã€‚</p></li><li><p>table_cache ï¼šè¡¨ç¤º åŒæ—¶æ‰“å¼€çš„è¡¨çš„ä¸ªæ•° ã€‚è¿™ä¸ªå€¼è¶Šå¤§ï¼Œèƒ½å¤ŸåŒæ—¶æ‰“å¼€çš„è¡¨çš„ä¸ªæ•°è¶Šå¤šã€‚ç‰©ç†å†… å­˜è¶Šå¤§ï¼Œè®¾ç½®å°±è¶Šå¤§ã€‚é»˜è®¤ä¸º2402ï¼Œè°ƒåˆ°512-1024æœ€ä½³ã€‚è¿™ä¸ªå€¼ä¸æ˜¯è¶Šå¤§è¶Šå¥½ï¼Œå› ä¸ºåŒæ—¶æ‰“å¼€çš„è¡¨ å¤ªå¤šä¼šå½±å“æ“ä½œç³»ç»Ÿçš„æ€§èƒ½ã€‚</p></li><li><p>query_cache_size ï¼šè¡¨ç¤º æŸ¥è¯¢ç¼“å†²åŒºçš„å¤§å° ã€‚å¯ä»¥é€šè¿‡åœ¨MySQLæ§åˆ¶å°è§‚å¯Ÿï¼Œå¦‚æœ Qcache_lowmem_prunesçš„å€¼éå¸¸å¤§ï¼Œåˆ™è¡¨æ˜ç»å¸¸å‡ºç°ç¼“å†²ä¸å¤Ÿçš„æƒ…å†µï¼Œå°±è¦å¢åŠ Query_cache_size çš„å€¼ï¼›å¦‚æœQcache_hitsçš„å€¼éå¸¸å¤§ï¼Œåˆ™è¡¨æ˜æŸ¥è¯¢ç¼“å†²ä½¿ç”¨éå¸¸é¢‘ç¹ï¼Œå¦‚æœè¯¥å€¼è¾ƒå°åè€Œä¼šå½±å“æ•ˆ ç‡ï¼Œé‚£ä¹ˆå¯ä»¥è€ƒè™‘ä¸ç”¨æŸ¥è¯¢ç¼“å­˜ï¼›Qcache_free_blocksï¼Œå¦‚æœè¯¥å€¼éå¸¸å¤§ï¼Œåˆ™è¡¨æ˜ç¼“å†²åŒºä¸­ç¢ç‰‡å¾ˆ å¤šã€‚MySQL8.0ä¹‹åå¤±æ•ˆã€‚è¯¥å‚æ•°éœ€è¦å’Œquery_cache_typeé…åˆä½¿ç”¨ã€‚</p></li><li><p>query_cache_type çš„å€¼æ˜¯0æ—¶ï¼Œæ‰€æœ‰çš„æŸ¥è¯¢éƒ½ä¸ä½¿ç”¨æŸ¥è¯¢ç¼“å­˜åŒºã€‚ä½†æ˜¯query_cache_type&#x3D;0å¹¶ä¸ ä¼šå¯¼è‡´MySQLé‡Šæ”¾query_cache_sizeæ‰€é…ç½®çš„ç¼“å­˜åŒºå†…å­˜ã€‚</p><ul><li>å½“query_cache_type&#x3D;1æ—¶ï¼Œæ‰€æœ‰çš„æŸ¥è¯¢éƒ½å°†ä½¿ç”¨æŸ¥è¯¢ç¼“å­˜åŒºï¼Œé™¤éåœ¨æŸ¥è¯¢è¯­å¥ä¸­æŒ‡å®š SQL_NO_CACHE ï¼Œå¦‚SELECT SQL_NO_CACHE * FROM tbl_nameã€‚</li><li>å½“query_cache_type&#x3D;2æ—¶ï¼Œåªæœ‰åœ¨æŸ¥è¯¢è¯­å¥ä¸­ä½¿ç”¨ SQL_CACHE å…³é”®å­—ï¼ŒæŸ¥è¯¢æ‰ä¼šä½¿ç”¨æŸ¥è¯¢ç¼“ å­˜åŒºã€‚ä½¿ç”¨æŸ¥è¯¢ç¼“å­˜åŒºå¯ä»¥æé«˜æŸ¥è¯¢çš„é€Ÿåº¦ï¼Œè¿™ç§æ–¹å¼åªé€‚ç”¨äºä¿®æ”¹æ“ä½œå°‘ä¸”ç»å¸¸æ‰§è¡Œç›¸åŒçš„ æŸ¥è¯¢æ“ä½œçš„æƒ…å†µã€‚</li></ul></li><li><p>sort_buffer_size ï¼šè¡¨ç¤ºæ¯ä¸ª éœ€è¦è¿›è¡Œæ’åºçš„çº¿ç¨‹åˆ†é…çš„ç¼“å†²åŒºçš„å¤§å° ã€‚å¢åŠ è¿™ä¸ªå‚æ•°çš„å€¼å¯ä»¥ æé«˜ ORDER BY æˆ– GROUP BY æ“ä½œçš„é€Ÿåº¦ã€‚é»˜è®¤æ•°å€¼æ˜¯2 097 144å­—èŠ‚ï¼ˆçº¦2MBï¼‰ã€‚å¯¹äºå†…å­˜åœ¨4GB å·¦å³çš„æœåŠ¡å™¨æ¨èè®¾ç½®ä¸º6-8Mï¼Œå¦‚æœæœ‰100ä¸ªè¿æ¥ï¼Œé‚£ä¹ˆå®é™…åˆ†é…çš„æ€»å…±æ’åºç¼“å†²åŒºå¤§å°ä¸º100 Ã— 6 ï¼ 600MBã€‚</p></li><li><p>join_buffer_size &#x3D; 8M ï¼šè¡¨ç¤º è”åˆæŸ¥è¯¢æ“ä½œæ‰€èƒ½ä½¿ç”¨çš„ç¼“å†²åŒºå¤§å° ï¼Œå’Œsort_buffer_sizeä¸€æ ·ï¼Œ è¯¥å‚æ•°å¯¹åº”çš„åˆ†é…å†…å­˜ä¹Ÿæ˜¯æ¯ä¸ªè¿æ¥ç‹¬äº«ã€‚</p></li><li><p>read_buffer_size ï¼šè¡¨ç¤º æ¯ä¸ªçº¿ç¨‹è¿ç»­æ‰«ææ—¶ä¸ºæ‰«æçš„æ¯ä¸ªè¡¨åˆ†é…çš„ç¼“å†²åŒºçš„å¤§å°ï¼ˆå­—èŠ‚ï¼‰ ã€‚å½“çº¿ ç¨‹ä»è¡¨ä¸­è¿ç»­è¯»å–è®°å½•æ—¶éœ€è¦ç”¨åˆ°è¿™ä¸ªç¼“å†²åŒºã€‚SET SESSION read_buffer_size&#x3D;nå¯ä»¥ä¸´æ—¶è®¾ç½®è¯¥å‚ æ•°çš„å€¼ã€‚é»˜è®¤ä¸º64Kï¼Œå¯ä»¥è®¾ç½®ä¸º4Mã€‚</p></li><li><p>innodb_flush_log_at_trx_commit ï¼šè¡¨ç¤º ä½•æ—¶å°†ç¼“å†²åŒºçš„æ•°æ®å†™å…¥æ—¥å¿—æ–‡ä»¶ ï¼Œå¹¶ä¸”å°†æ—¥å¿—æ–‡ä»¶ å†™å…¥ç£ç›˜ä¸­ã€‚è¯¥å‚æ•°å¯¹äºinnoDBå¼•æ“éå¸¸é‡è¦ã€‚è¯¥å‚æ•°æœ‰3ä¸ªå€¼ï¼Œåˆ†åˆ«ä¸º0ã€1å’Œ2ã€‚è¯¥å‚æ•°çš„é»˜è®¤å€¼ ä¸º1ã€‚</p><ul><li>å€¼ä¸º 0 æ—¶ï¼Œè¡¨ç¤º æ¯ç§’1æ¬¡ çš„é¢‘ç‡å°†æ•°æ®å†™å…¥æ—¥å¿—æ–‡ä»¶å¹¶å°†æ—¥å¿—æ–‡ä»¶å†™å…¥ç£ç›˜ã€‚æ¯ä¸ªäº‹åŠ¡çš„ commitå¹¶ä¸ä¼šè§¦å‘å‰é¢çš„ä»»ä½•æ“ä½œã€‚è¯¥æ¨¡å¼é€Ÿåº¦æœ€å¿«ï¼Œä½†ä¸å¤ªå®‰å…¨ï¼Œmysqldè¿›ç¨‹çš„å´©æºƒä¼šå¯¼ è‡´ä¸Šä¸€ç§’é’Ÿæ‰€æœ‰äº‹åŠ¡æ•°æ®çš„ä¸¢å¤±ã€‚</li><li>å€¼ä¸º 1 æ—¶ï¼Œè¡¨ç¤º æ¯æ¬¡æäº¤äº‹åŠ¡æ—¶ å°†æ•°æ®å†™å…¥æ—¥å¿—æ–‡ä»¶å¹¶å°†æ—¥å¿—æ–‡ä»¶å†™å…¥ç£ç›˜è¿›è¡ŒåŒæ­¥ã€‚è¯¥æ¨¡ å¼æ˜¯æœ€å®‰å…¨çš„ï¼Œä½†ä¹Ÿæ˜¯æœ€æ…¢çš„ä¸€ç§æ–¹å¼ã€‚å› ä¸ºæ¯æ¬¡äº‹åŠ¡æäº¤æˆ–äº‹åŠ¡å¤–çš„æŒ‡ä»¤éƒ½éœ€è¦æŠŠæ—¥å¿—å†™å…¥ ï¼ˆflushï¼‰ç¡¬ç›˜ã€‚</li><li>å€¼ä¸º 2 æ—¶ï¼Œè¡¨ç¤º æ¯æ¬¡æäº¤äº‹åŠ¡æ—¶ å°†æ•°æ®å†™å…¥æ—¥å¿—æ–‡ä»¶ï¼Œ æ¯éš”1ç§’ å°†æ—¥å¿—æ–‡ä»¶å†™å…¥ç£ç›˜ã€‚è¯¥æ¨¡ å¼é€Ÿåº¦è¾ƒå¿«ï¼Œä¹Ÿæ¯”0å®‰å…¨ï¼Œåªæœ‰åœ¨æ“ä½œç³»ç»Ÿå´©æºƒæˆ–è€…ç³»ç»Ÿæ–­ç”µçš„æƒ…å†µä¸‹ï¼Œä¸Šä¸€ç§’é’Ÿæ‰€æœ‰äº‹åŠ¡æ•° æ®æ‰å¯èƒ½ä¸¢å¤±ã€‚</li></ul></li><li><p>innodb_log_buffer_size ï¼šè¿™æ˜¯ InnoDB å­˜å‚¨å¼•æ“çš„ äº‹åŠ¡æ—¥å¿—æ‰€ä½¿ç”¨çš„ç¼“å†²åŒº ã€‚ä¸ºäº†æé«˜æ€§èƒ½ï¼Œ ä¹Ÿæ˜¯å…ˆå°†ä¿¡æ¯å†™å…¥ Innodb Log Buffer ä¸­ï¼Œå½“æ»¡è¶³ innodb_flush_log_trx_commit å‚æ•°æ‰€è®¾ç½®çš„ç›¸åº”æ¡ ä»¶ï¼ˆæˆ–è€…æ—¥å¿—ç¼“å†²åŒºå†™æ»¡ï¼‰ä¹‹åï¼Œæ‰ä¼šå°†æ—¥å¿—å†™åˆ°æ–‡ä»¶ï¼ˆæˆ–è€…åŒæ­¥åˆ°ç£ç›˜ï¼‰ä¸­ã€‚</p></li><li><p>max_connections ï¼šè¡¨ç¤º å…è®¸è¿æ¥åˆ°MySQLæ•°æ®åº“çš„æœ€å¤§æ•°é‡ ï¼Œé»˜è®¤å€¼æ˜¯ 151 ã€‚å¦‚æœçŠ¶æ€å˜é‡ connection_errors_max_connections ä¸ä¸ºé›¶ï¼Œå¹¶ä¸”ä¸€ç›´å¢é•¿ï¼Œåˆ™è¯´æ˜ä¸æ–­æœ‰è¿æ¥è¯·æ±‚å› æ•°æ®åº“è¿æ¥ æ•°å·²è¾¾åˆ°å…è®¸æœ€å¤§å€¼è€Œå¤±è´¥ï¼Œè¿™æ˜¯å¯ä»¥è€ƒè™‘å¢å¤§max_connections çš„å€¼ã€‚åœ¨Linux å¹³å°ä¸‹ï¼Œæ€§èƒ½å¥½çš„ æœåŠ¡å™¨ï¼Œæ”¯æŒ 500-1000 ä¸ªè¿æ¥ä¸æ˜¯éš¾äº‹ï¼Œéœ€è¦æ ¹æ®æœåŠ¡å™¨æ€§èƒ½è¿›è¡Œè¯„ä¼°è®¾å®šã€‚è¿™ä¸ªè¿æ¥æ•° ä¸æ˜¯è¶Šå¤§ è¶Šå¥½ ï¼Œå› ä¸ºè¿™äº›è¿æ¥ä¼šæµªè´¹å†…å­˜çš„èµ„æºã€‚è¿‡å¤šçš„è¿æ¥å¯èƒ½ä¼šå¯¼è‡´MySQLæœåŠ¡å™¨åƒµæ­»ã€‚</p></li><li><p>back_log ï¼šç”¨äº æ§åˆ¶MySQLç›‘å¬TCPç«¯å£æ—¶è®¾ç½®çš„ç§¯å‹è¯·æ±‚æ ˆå¤§å° ã€‚å¦‚æœMySqlçš„è¿æ¥æ•°è¾¾åˆ° max_connectionsæ—¶ï¼Œæ–°æ¥çš„è¯·æ±‚å°†ä¼šè¢«å­˜åœ¨å †æ ˆä¸­ï¼Œä»¥ç­‰å¾…æŸä¸€è¿æ¥é‡Šæ”¾èµ„æºï¼Œè¯¥å †æ ˆçš„æ•°é‡å³ back_logï¼Œå¦‚æœç­‰å¾…è¿æ¥çš„æ•°é‡è¶…è¿‡back_logï¼Œå°†ä¸è¢«æˆäºˆè¿æ¥èµ„æºï¼Œå°†ä¼šæŠ¥é”™ã€‚5.6.6 ç‰ˆæœ¬ä¹‹å‰é»˜ è®¤å€¼ä¸º 50 ï¼Œ ä¹‹åçš„ç‰ˆæœ¬é»˜è®¤ä¸º 50 + ï¼ˆmax_connections &#x2F; 5ï¼‰ï¼Œ å¯¹äºLinuxç³»ç»Ÿæ¨èè®¾ç½®ä¸ºå°äº512 çš„æ•´æ•°ï¼Œä½†æœ€å¤§ä¸è¶…è¿‡900ã€‚</p><p>å¦‚æœéœ€è¦æ•°æ®åº“åœ¨è¾ƒçŸ­çš„æ—¶é—´å†…å¤„ç†å¤§é‡è¿æ¥è¯·æ±‚ï¼Œ å¯ä»¥è€ƒè™‘é€‚å½“å¢å¤§back_log çš„å€¼ã€‚</p></li><li><p>thread_cache_size ï¼š çº¿ç¨‹æ± ç¼“å­˜çº¿ç¨‹æ•°é‡çš„å¤§å° ï¼Œå½“å®¢æˆ·ç«¯æ–­å¼€è¿æ¥åå°†å½“å‰çº¿ç¨‹ç¼“å­˜èµ·æ¥ï¼Œ å½“åœ¨æ¥åˆ°æ–°çš„è¿æ¥è¯·æ±‚æ—¶å¿«é€Ÿå“åº”æ— éœ€åˆ›å»ºæ–°çš„çº¿ç¨‹ ã€‚è¿™å°¤å…¶å¯¹é‚£äº›ä½¿ç”¨çŸ­è¿æ¥çš„åº”ç”¨ç¨‹åºæ¥è¯´å¯ ä»¥æå¤§çš„æé«˜åˆ›å»ºè¿æ¥çš„æ•ˆç‡ã€‚é‚£ä¹ˆä¸ºäº†æé«˜æ€§èƒ½å¯ä»¥å¢å¤§è¯¥å‚æ•°çš„å€¼ã€‚é»˜è®¤ä¸º60ï¼Œå¯ä»¥è®¾ç½®ä¸º 120ã€‚</p><p>å¯ä»¥é€šè¿‡å¦‚ä¸‹å‡ ä¸ªMySQLçŠ¶æ€å€¼æ¥é€‚å½“è°ƒæ•´çº¿ç¨‹æ± çš„å¤§å°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show global status like &#x27;Thread%&#x27;;</span><br><span class="line">+-------------------+-------+</span><br><span class="line">| Variable_name | Value |</span><br><span class="line">+-------------------+-------+</span><br><span class="line">| Threads_cached | 2 |</span><br><span class="line">| Threads_connected | 1 |</span><br><span class="line">| Threads_created | 3 |</span><br><span class="line">| Threads_running | 2 |</span><br><span class="line">+-------------------+-------+</span><br><span class="line">4 rows in set (0.01 sec)</span><br></pre></td></tr></table></figure><p>å½“ Threads_cached è¶Šæ¥è¶Šå°‘ï¼Œä½† Threads_connected å§‹ç»ˆä¸é™ï¼Œä¸” Threads_created æŒç»­å‡é«˜ï¼Œå¯ é€‚å½“å¢åŠ  thread_cache_size çš„å¤§å°ã€‚</p></li><li><p>wait_timeout ï¼šæŒ‡å®š ä¸€ä¸ªè¯·æ±‚çš„æœ€å¤§è¿æ¥æ—¶é—´ ï¼Œå¯¹äº4GBå·¦å³å†…å­˜çš„æœåŠ¡å™¨å¯ä»¥è®¾ç½®ä¸º5-10ã€‚</p></li><li><p>interactive_timeout ï¼šè¡¨ç¤ºæœåŠ¡å™¨åœ¨å…³é—­è¿æ¥å‰ç­‰å¾…è¡ŒåŠ¨çš„ç§’æ•°ã€‚</p></li></ul><p>è¿™é‡Œç»™å‡ºä¸€ä»½my.cnfçš„å‚è€ƒé…ç½®ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">mysqld]</span><br><span class="line">port = 3306 </span><br><span class="line">serverid = 1 </span><br><span class="line">socket = /tmp/mysql.sock </span><br><span class="line">skip-locking #é¿å…MySQLçš„å¤–éƒ¨é”å®šï¼Œå‡å°‘å‡ºé”™å‡ ç‡å¢å¼ºç¨³å®šæ€§ã€‚ </span><br><span class="line">skip-name-resolve #ç¦æ­¢MySQLå¯¹å¤–éƒ¨è¿æ¥è¿›è¡ŒDNSè§£æï¼Œä½¿ç”¨è¿™ä¸€é€‰é¡¹å¯ä»¥æ¶ˆé™¤MySQLè¿›è¡ŒDNSè§£æçš„æ—¶é—´ã€‚ä½†éœ€è¦æ³¨æ„ï¼Œå¦‚æœå¼€å¯è¯¥é€‰é¡¹ï¼Œåˆ™æ‰€æœ‰è¿œç¨‹ä¸»æœºè¿æ¥æˆæƒéƒ½è¦ä½¿ç”¨IPåœ°å€æ–¹å¼ï¼Œå¦åˆ™MySQLå°†æ— æ³•æ­£å¸¸å¤„ç†è¿æ¥è¯·æ±‚ï¼ </span><br><span class="line">back_log = 384</span><br><span class="line">key_buffer_size = 256M </span><br><span class="line">max_allowed_packet = 4M </span><br><span class="line">thread_stack = 256K</span><br><span class="line">table_cache = 128K </span><br><span class="line">sort_buffer_size = 6M </span><br><span class="line">read_buffer_size = 4M</span><br><span class="line">read_rnd_buffer_size=16M </span><br><span class="line">join_buffer_size = 8M </span><br><span class="line">myisam_sort_buffer_size =64M </span><br><span class="line">table_cache = 512 </span><br><span class="line">thread_cache_size = 64 </span><br><span class="line">query_cache_size = 64M</span><br><span class="line">tmp_table_size = 256M </span><br><span class="line">max_connections = 768 </span><br><span class="line">max_connect_errors = 10000000</span><br><span class="line">wait_timeout = 10 </span><br><span class="line">thread_concurrency = 8 #è¯¥å‚æ•°å–å€¼ä¸ºæœåŠ¡å™¨é€»è¾‘CPUæ•°é‡*2ï¼Œåœ¨æœ¬ä¾‹ä¸­ï¼ŒæœåŠ¡å™¨æœ‰2é¢—ç‰©ç†CPUï¼Œè€Œæ¯é¢—ç‰©ç†CPUåˆæ”¯æŒH.Tè¶…çº¿ç¨‹ï¼Œæ‰€ä»¥å®é™…å–å€¼ä¸º4*2=8</span><br><span class="line">skip-networking #å¼€å¯è¯¥é€‰é¡¹å¯ä»¥å½»åº•å…³é—­MySQLçš„TCP/IPè¿æ¥æ–¹å¼ï¼Œå¦‚æœWEBæœåŠ¡å™¨æ˜¯ä»¥è¿œç¨‹è¿æ¥çš„æ–¹å¼è®¿é—®MySQLæ•°æ®åº“æœåŠ¡å™¨åˆ™ä¸è¦å¼€å¯è¯¥é€‰é¡¹ï¼å¦åˆ™å°†æ— æ³•æ­£å¸¸è¿æ¥ï¼ </span><br><span class="line">table_cache=1024</span><br><span class="line">innodb_additional_mem_pool_size=4M #é»˜è®¤ä¸º2M </span><br><span class="line">innodb_flush_log_at_trx_commit=1</span><br><span class="line">innodb_log_buffer_size=2M #é»˜è®¤ä¸º1M </span><br><span class="line">innodb_thread_concurrency=8 #ä½ çš„æœåŠ¡å™¨CPUæœ‰å‡ ä¸ªå°±è®¾ç½®ä¸ºå‡ ã€‚å»ºè®®ç”¨é»˜è®¤ä¸€èˆ¬ä¸º8 </span><br><span class="line">tmp_table_size=64M #é»˜è®¤ä¸º16Mï¼Œè°ƒåˆ°64-256æœ€æŒ‚</span><br><span class="line">thread_cache_size=120 </span><br><span class="line">query_cache_size=32M</span><br></pre></td></tr></table></figure><p>å¾ˆå¤šæƒ…å†µè¿˜éœ€è¦å…·ä½“æƒ…å†µå…·ä½“åˆ†æï¼</p><p><strong>ä¸¾ä¾‹ï¼š</strong></p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707210351452.png" class=""><p><strong>(1) è°ƒæ•´ç³»ç»Ÿå‚æ•° InnoDB_flush_log_at_trx_commit</strong></p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707210447501.png" class=""><p><strong>(2)  è°ƒæ•´ç³»ç»Ÿå‚æ•° InnoDB_buffer_pool_size</strong></p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707210555848.png" class=""><p><strong>(3) è°ƒæ•´ç³»ç»Ÿå‚æ•° InnoDB_buffer_pool_instances</strong></p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707210720394.png" class=""><h2 id="3-ä¼˜åŒ–æ•°æ®åº“ç»“æ„"><a href="#3-ä¼˜åŒ–æ•°æ®åº“ç»“æ„" class="headerlink" title="3. ä¼˜åŒ–æ•°æ®åº“ç»“æ„"></a>3. ä¼˜åŒ–æ•°æ®åº“ç»“æ„</h2><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707211709553.png" class=""><h3 id="3-1-æ‹†åˆ†è¡¨ï¼šå†·çƒ­æ•°æ®åˆ†ç¦»"><a href="#3-1-æ‹†åˆ†è¡¨ï¼šå†·çƒ­æ•°æ®åˆ†ç¦»" class="headerlink" title="3.1 æ‹†åˆ†è¡¨ï¼šå†·çƒ­æ•°æ®åˆ†ç¦»"></a>3.1 æ‹†åˆ†è¡¨ï¼šå†·çƒ­æ•°æ®åˆ†ç¦»</h3><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707211802756.png" class=""><p><strong>ä¸¾ä¾‹1ï¼š</strong> <code>ä¼šå‘˜membersè¡¨</code> å­˜å‚¨ä¼šå‘˜ç™»å½•è®¤è¯ä¿¡æ¯ï¼Œè¯¥è¡¨ä¸­æœ‰å¾ˆå¤šå­—æ®µï¼Œå¦‚idã€å§“åã€å¯†ç ã€åœ°å€ã€ç”µ è¯ã€ä¸ªäººæè¿°å­—æ®µã€‚å…¶ä¸­åœ°å€ã€ç”µè¯ã€ä¸ªäººæè¿°ç­‰å­—æ®µå¹¶ä¸å¸¸ç”¨ï¼Œå¯ä»¥å°†è¿™äº›ä¸å¸¸ç”¨çš„å­—æ®µåˆ†è§£å‡ºå¦ä¸€ ä¸ªè¡¨ã€‚å°†è¿™ä¸ªè¡¨å–åå«members_detailï¼Œè¡¨ä¸­æœ‰member_idã€addressã€telephoneã€descriptionç­‰å­—æ®µã€‚ è¿™æ ·å°±æŠŠä¼šå‘˜è¡¨åˆ†æˆäº†ä¸¤ä¸ªè¡¨ï¼Œåˆ†åˆ«ä¸º <code>membersè¡¨</code> å’Œ <code>members_detailè¡¨</code> ã€‚</p><p>åˆ›å»ºè¿™ä¸¤ä¸ªè¡¨çš„SQLè¯­å¥å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE members (</span><br><span class="line">    id int(11) NOT NULL AUTO_INCREMENT,</span><br><span class="line">    username varchar(50) DEFAULT NULL,</span><br><span class="line">    password varchar(50) DEFAULT NULL,</span><br><span class="line">    last_login_time datetime DEFAULT NULL,</span><br><span class="line">    last_login_ip varchar(100) DEFAULT NULL,</span><br><span class="line">    PRIMARY KEY(Id)</span><br><span class="line">);</span><br><span class="line">CREATE TABLE members_detail (</span><br><span class="line">    Member_id int(11) NOT NULL DEFAULT 0,</span><br><span class="line">    address varchar(255) DEFAULT NULL,</span><br><span class="line">    telephone varchar(255) DEFAULT NULL,</span><br><span class="line">    description text</span><br><span class="line">);</span><br></pre></td></tr></table></figure><p>å¦‚æœéœ€è¦æŸ¥è¯¢ä¼šå‘˜çš„åŸºæœ¬ä¿¡æ¯æˆ–è¯¦ç»†ä¿¡æ¯ï¼Œé‚£ä¹ˆå¯ä»¥ç”¨ä¼šå‘˜çš„idæ¥æŸ¥è¯¢ã€‚å¦‚æœéœ€è¦å°†ä¼šå‘˜çš„åŸºæœ¬ä¿¡æ¯å’Œ è¯¦ç»†ä¿¡æ¯åŒæ—¶æ˜¾ç¤ºï¼Œé‚£ä¹ˆå¯ä»¥å°†membersè¡¨å’Œmembers_detailè¡¨è¿›è¡Œè”åˆæŸ¥è¯¢ï¼ŒæŸ¥è¯¢è¯­å¥å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM members LEFT JOIN members_detail on members.id =</span><br><span class="line">members_detail.member_id;</span><br></pre></td></tr></table></figure><p>é€šè¿‡è¿™ç§åˆ†è§£å¯ä»¥æé«˜è¡¨çš„æŸ¥è¯¢æ•ˆç‡ã€‚å¯¹äºå­—æ®µå¾ˆå¤šä¸”æœ‰äº›å­—æ®µä½¿ç”¨ä¸é¢‘ç¹çš„è¡¨ï¼Œå¯ä»¥é€šè¿‡è¿™ç§åˆ†è§£çš„æ–¹å¼æ¥ä¼˜åŒ–æ•°æ®åº“çš„æ€§èƒ½ã€‚</p><h3 id="3-2-å¢åŠ ä¸­é—´è¡¨"><a href="#3-2-å¢åŠ ä¸­é—´è¡¨" class="headerlink" title="3.2 å¢åŠ ä¸­é—´è¡¨"></a>3.2 å¢åŠ ä¸­é—´è¡¨</h3><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707212800544.png" class=""><p>ä¸¾ä¾‹1ï¼š å­¦ç”Ÿä¿¡æ¯è¡¨ å’Œ ç­çº§è¡¨ çš„SQLè¯­å¥å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE `class` (</span><br><span class="line">`id` INT(11) NOT NULL AUTO_INCREMENT,</span><br><span class="line">`className` VARCHAR(30) DEFAULT NULL,</span><br><span class="line">`address` VARCHAR(40) DEFAULT NULL,</span><br><span class="line">`monitor` INT NULL ,</span><br><span class="line">PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=INNODB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8;</span><br><span class="line"></span><br><span class="line">CREATE TABLE `student` (</span><br><span class="line">`id` INT(11) NOT NULL AUTO_INCREMENT,</span><br><span class="line">`stuno` INT NOT NULL ,</span><br><span class="line">`name` VARCHAR(20) DEFAULT NULL,</span><br><span class="line">`age` INT(3) DEFAULT NULL,</span><br><span class="line">`classId` INT(11) DEFAULT NULL,</span><br><span class="line">PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=INNODB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8;</span><br></pre></td></tr></table></figure><p>ç°åœ¨æœ‰ä¸€ä¸ªæ¨¡å—éœ€è¦ç»å¸¸æŸ¥è¯¢å¸¦æœ‰å­¦ç”Ÿåç§°ï¼ˆnameï¼‰ã€å­¦ç”Ÿæ‰€åœ¨ç­çº§åç§°ï¼ˆclassNameï¼‰ã€å­¦ç”Ÿç­çº§ç­ é•¿ï¼ˆmonitorï¼‰çš„å­¦ç”Ÿä¿¡æ¯ã€‚æ ¹æ®è¿™ç§æƒ…å†µå¯ä»¥åˆ›å»ºä¸€ä¸ª temp_student è¡¨ã€‚temp_studentè¡¨ä¸­å­˜å‚¨å­¦ç”Ÿåç§°ï¼ˆstu_nameï¼‰ã€å­¦ç”Ÿæ‰€åœ¨ç­çº§åç§°ï¼ˆclassNameï¼‰å’Œå­¦ç”Ÿç­çº§ç­é•¿ï¼ˆmonitorï¼‰ä¿¡æ¯ã€‚åˆ›å»ºè¡¨çš„è¯­å¥å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE `temp_student` (</span><br><span class="line">`id` INT(11) NOT NULL AUTO_INCREMENT,</span><br><span class="line">`stu_name` INT NOT NULL ,</span><br><span class="line">`className` VARCHAR(20) DEFAULT NULL,</span><br><span class="line">`monitor` INT(3) DEFAULT NULL,</span><br><span class="line">PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=INNODB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8;</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥ï¼Œä»å­¦ç”Ÿä¿¡æ¯è¡¨å’Œç­çº§è¡¨ä¸­æŸ¥è¯¢ç›¸å…³ä¿¡æ¯å­˜å‚¨åˆ°ä¸´æ—¶è¡¨ä¸­ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">insert into temp_student(stu_name,className,monitor)</span><br><span class="line">            select s.name,c.className,c.monitor</span><br><span class="line">            from student as s,class as c</span><br><span class="line">            where s.classId = c.id</span><br></pre></td></tr></table></figure><p>ä»¥åï¼Œå¯ä»¥ç›´æ¥ä»temp_studentè¡¨ä¸­æŸ¥è¯¢å­¦ç”Ÿåç§°ã€ç­çº§åç§°å’Œç­çº§ç­é•¿ï¼Œè€Œä¸ç”¨æ¯æ¬¡éƒ½è¿›è¡Œè”åˆæŸ¥ è¯¢ã€‚è¿™æ ·å¯ä»¥æé«˜æ•°æ®åº“çš„æŸ¥è¯¢é€Ÿåº¦ã€‚</p><h3 id="3-3-å¢åŠ å†—ä½™å­—æ®µ"><a href="#3-3-å¢åŠ å†—ä½™å­—æ®µ" class="headerlink" title="3.3 å¢åŠ å†—ä½™å­—æ®µ"></a>3.3 å¢åŠ å†—ä½™å­—æ®µ</h3><p>è®¾è®¡æ•°æ®åº“è¡¨æ—¶åº”å°½é‡éµå¾ªèŒƒå¼ç†è®ºçš„è§„çº¦ï¼Œå°½å¯èƒ½å‡å°‘å†—ä½™å­—æ®µï¼Œè®©æ•°æ®åº“è®¾è®¡çœ‹èµ·æ¥ç²¾è‡´ã€ä¼˜é›…ã€‚ ä½†æ˜¯ï¼Œåˆç†åœ°åŠ å…¥å†—ä½™å­—æ®µå¯ä»¥æé«˜æŸ¥è¯¢é€Ÿåº¦ã€‚</p><p>è¡¨çš„è§„èŒƒåŒ–ç¨‹åº¦è¶Šé«˜ï¼Œè¡¨ä¸è¡¨ä¹‹é—´çš„å…³ç³»å°±è¶Šå¤šï¼Œéœ€è¦è¿æ¥æŸ¥è¯¢çš„æƒ…å†µä¹Ÿå°±è¶Šå¤šã€‚å°¤å…¶åœ¨æ•°æ®é‡å¤§ï¼Œè€Œ ä¸”éœ€è¦é¢‘ç¹è¿›è¡Œè¿æ¥çš„æ—¶å€™ï¼Œä¸ºäº†æå‡æ•ˆç‡ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥è€ƒè™‘å¢åŠ å†—ä½™å­—æ®µæ¥å‡å°‘è¿æ¥ã€‚</p><p>è¿™éƒ¨åˆ†å†…å®¹åœ¨ã€Šç¬¬11ç« _æ•°æ®åº“çš„è®¾è®¡è§„èŒƒã€‹ç« èŠ‚ä¸­ åèŒƒå¼åŒ–å°èŠ‚ ä¸­å…·ä½“å±•å¼€è®²è§£äº†ã€‚è¿™é‡Œçœç•¥ã€‚</p><h3 id="3-4-ä¼˜åŒ–æ•°æ®ç±»å‹"><a href="#3-4-ä¼˜åŒ–æ•°æ®ç±»å‹" class="headerlink" title="3.4 ä¼˜åŒ–æ•°æ®ç±»å‹"></a>3.4 ä¼˜åŒ–æ•°æ®ç±»å‹</h3><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707213524137.png" class=""><p><strong>æƒ…å†µ1ï¼šå¯¹æ•´æ•°ç±»å‹æ•°æ®è¿›è¡Œä¼˜åŒ–ã€‚</strong></p><p>é‡åˆ°æ•´æ•°ç±»å‹çš„å­—æ®µå¯ä»¥ç”¨ INT å‹ ã€‚è¿™æ ·åšçš„ç†ç”±æ˜¯ï¼ŒINT å‹æ•°æ®æœ‰è¶³å¤Ÿå¤§çš„å–å€¼èŒƒå›´ï¼Œä¸ç”¨æ‹…å¿ƒæ•° æ®è¶…å‡ºå–å€¼èŒƒå›´çš„é—®é¢˜ã€‚åˆšå¼€å§‹åšé¡¹ç›®çš„æ—¶å€™ï¼Œé¦–å…ˆè¦ä¿è¯ç³»ç»Ÿçš„ç¨³å®šæ€§ï¼Œè¿™æ ·è®¾è®¡å­—æ®µç±»å‹æ˜¯å¯ä»¥ çš„ã€‚ä½†åœ¨æ•°æ®é‡å¾ˆå¤§çš„æ—¶å€™ï¼Œæ•°æ®ç±»å‹çš„å®šä¹‰ï¼Œåœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šä¼šå½±å“åˆ°ç³»ç»Ÿæ•´ä½“çš„æ‰§è¡Œæ•ˆç‡ã€‚</p><p>å¯¹äº éè´Ÿå‹ çš„æ•°æ®ï¼ˆå¦‚è‡ªå¢IDã€æ•´å‹IPï¼‰æ¥è¯´ï¼Œè¦ä¼˜å…ˆä½¿ç”¨æ— ç¬¦å·æ•´å‹ UNSIGNED æ¥å­˜å‚¨ã€‚å› ä¸ºæ— ç¬¦å· ç›¸å¯¹äºæœ‰ç¬¦å·ï¼ŒåŒæ ·çš„å­—èŠ‚æ•°ï¼Œå­˜å‚¨çš„æ•°å€¼èŒƒå›´æ›´å¤§ã€‚å¦‚tinyintæœ‰ç¬¦å·ä¸º-128-127ï¼Œæ— ç¬¦å·ä¸º0-255ï¼Œå¤š å‡ºä¸€å€çš„å­˜å‚¨ç©ºé—´ã€‚</p><p><strong>æƒ…å†µ2ï¼šæ—¢å¯ä»¥ä½¿ç”¨æ–‡æœ¬ç±»å‹ä¹Ÿå¯ä»¥ä½¿ç”¨æ•´æ•°ç±»å‹çš„å­—æ®µï¼Œè¦é€‰æ‹©ä½¿ç”¨æ•´æ•°ç±»å‹ã€‚</strong></p><p>è·Ÿæ–‡æœ¬ç±»å‹æ•°æ®ç›¸æ¯”ï¼Œå¤§æ•´æ•°å¾€å¾€å ç”¨æ›´å°‘çš„å­˜å‚¨ç©ºé—´ ï¼Œå› æ­¤ï¼Œåœ¨å­˜å–å’Œæ¯”å¯¹çš„æ—¶å€™ï¼Œå¯ä»¥å ç”¨æ›´å°‘çš„ å†…å­˜ç©ºé—´ã€‚æ‰€ä»¥ï¼Œåœ¨äºŒè€…çš†å¯ç”¨çš„æƒ…å†µä¸‹ï¼Œå°½é‡ä½¿ç”¨æ•´æ•°ç±»å‹ï¼Œè¿™æ ·å¯ä»¥æé«˜æŸ¥è¯¢çš„æ•ˆç‡ã€‚å¦‚ï¼šå°†IPåœ° å€è½¬æ¢æˆæ•´å‹æ•°æ®ã€‚</p><p><strong>æƒ…å†µ3ï¼šé¿å…ä½¿ç”¨TEXTã€BLOBæ•°æ®ç±»å‹</strong></p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707214640374.png" class=""><p><strong>æƒ…å†µ4ï¼šé¿å…ä½¿ç”¨ENUMç±»å‹</strong></p><p>ä¿®æ”¹ENUMå€¼éœ€è¦ä½¿ç”¨ALTERè¯­å¥ã€‚</p><p>ENUMç±»å‹çš„ORDER BY æ“ä½œæ•ˆç‡ä½ï¼Œéœ€è¦é¢å¤–æ“ä½œã€‚ä½¿ç”¨TINYINTæ¥ä»£æ›¿ENUMç±»å‹ã€‚</p><p><strong>æƒ…å†µ5ï¼šä½¿ç”¨TIMESTAMPå­˜å‚¨æ—¶é—´</strong></p><p>TIMESTAMPå­˜å‚¨çš„æ—¶é—´èŒƒå›´1970-01-01 00:00:01 ~ 2038-01_19-03:14:07ã€‚TIMESTAMPä½¿ç”¨4å­—èŠ‚ï¼ŒDATETIMEä½¿ç”¨8ä¸ªå­—èŠ‚ï¼ŒåŒæ—¶TIMESTAMPå…·æœ‰è‡ªåŠ¨èµ‹å€¼ä»¥åŠè‡ªåŠ¨æ›´æ–°çš„ç‰¹æ€§ã€‚</p><p><strong>æƒ…å†µ6ï¼šç”¨DECIMALä»£æ›¿FLOATå’ŒDOUBLEå­˜å‚¨ç²¾ç¡®æµ®ç‚¹æ•°</strong></p><ol><li>éç²¾å‡†æµ®ç‚¹ï¼š float, double</li><li>ç²¾å‡†æµ®ç‚¹ï¼šdecimal</li></ol><p>Decimalç±»å‹ä¸ºç²¾å‡†æµ®ç‚¹æ•°ï¼Œåœ¨è®¡ç®—æ—¶ä¸ä¼šä¸¢å¤±ç²¾åº¦ï¼Œå°¤å…¶æ˜¯è´¢åŠ¡ç›¸å…³çš„é‡‘èç±»æ•°æ®ã€‚å ç”¨ç©ºé—´ç”±å®šä¹‰çš„å®½åº¦å†³å®šï¼Œæ¯4ä¸ªå­—èŠ‚å¯ä»¥å­˜å‚¨9ä½æ•°å­—ï¼Œå¹¶ä¸”å°æ•°ç‚¹è¦å ç”¨ä¸€ä¸ªå­—èŠ‚ã€‚å¯ç”¨äºå­˜å‚¨æ¯”bigintæ›´å¤§çš„æ•´å‹æ•°æ®ã€‚</p><p><strong>æ€»ä¹‹ï¼Œé‡åˆ°æ•°æ®é‡å¤§çš„é¡¹ç›®æ—¶ï¼Œä¸€å®šè¦åœ¨å……åˆ†äº†è§£ä¸šåŠ¡éœ€æ±‚çš„å‰æä¸‹ï¼Œåˆç†ä¼˜åŒ–æ•°æ®ç±»å‹ï¼Œè¿™æ ·æ‰èƒ½å…… åˆ†å‘æŒ¥èµ„æºçš„æ•ˆç‡ï¼Œä½¿ç³»ç»Ÿè¾¾åˆ°æœ€ä¼˜ã€‚</strong></p><h3 id="3-5-ä¼˜åŒ–æ’å…¥è®°å½•çš„é€Ÿåº¦"><a href="#3-5-ä¼˜åŒ–æ’å…¥è®°å½•çš„é€Ÿåº¦" class="headerlink" title="3.5 ä¼˜åŒ–æ’å…¥è®°å½•çš„é€Ÿåº¦"></a>3.5 ä¼˜åŒ–æ’å…¥è®°å½•çš„é€Ÿåº¦</h3><p>æ’å…¥è®°å½•æ—¶ï¼Œå½±å“æ’å…¥é€Ÿåº¦çš„ä¸»è¦æ˜¯ç´¢å¼•ã€å”¯ä¸€æ€§æ ¡éªŒã€ä¸€æ¬¡æ’å…¥è®°å½•æ¡æ•°ç­‰ã€‚æ ¹æ®è¿™äº›æƒ…å†µå¯ä»¥åˆ†åˆ«è¿›è¡Œä¼˜åŒ–ã€‚è¿™é‡Œæˆ‘ä»¬åˆ†ä¸ºMyISAMå¼•æ“å’ŒInnoDBå¼•æ“æ¥è®²ã€‚</p><p><strong>1. MyISAMå¼•æ“çš„è¡¨ï¼š</strong></p><p><strong>â‘  ç¦ç”¨ç´¢å¼•</strong></p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707215305640.png" class=""><p><strong>â‘¡ ç¦ç”¨å”¯ä¸€æ€§æ£€æŸ¥</strong></p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707215356893.png" class=""><p><strong>â‘¢ ä½¿ç”¨æ‰¹é‡æ’å…¥</strong></p><p>æ’å…¥å¤šæ¡è®°å½•æ—¶ï¼Œå¯ä»¥ä½¿ç”¨ä¸€æ¡INSERTè¯­å¥æ’å…¥ä¸€æ¡æ•°æ®ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ä¸€æ¡INSERTè¯­å¥æ’å…¥å¤šæ¡æ•°æ®ã€‚æ’å…¥ä¸€æ¡è®°å½•çš„INSERTè¯­å¥æƒ…å½¢å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">insert into student values(1,&#x27;zhangsan&#x27;,18,1);</span><br><span class="line">insert into student values(2,&#x27;lisi&#x27;,17,1);</span><br><span class="line">insert into student values(3,&#x27;wangwu&#x27;,17,1);</span><br><span class="line">insert into student values(4,&#x27;zhaoliu&#x27;,19,1);</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ä¸€æ¡INSERTè¯­å¥æ’å…¥å¤šæ¡è®°å½•çš„æƒ…å½¢å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">insert into student values</span><br><span class="line">(1,&#x27;zhangsan&#x27;,18,1),</span><br><span class="line">(2,&#x27;lisi&#x27;,17,1),</span><br><span class="line">(3,&#x27;wangwu&#x27;,17,1),</span><br><span class="line">(4,&#x27;zhaoliu&#x27;,19,1);</span><br></pre></td></tr></table></figure><p>ç¬¬2ç§æƒ…å½¢çš„æ’å…¥é€Ÿåº¦è¦æ¯”ç¬¬1ç§æƒ…å½¢å¿«ã€‚</p><p><strong>â‘£ ä½¿ç”¨LOAD DATA INFILE æ‰¹é‡å¯¼å…¥</strong></p><p>å½“éœ€è¦æ‰¹é‡å¯¼å…¥æ•°æ®æ—¶ï¼Œå¦‚æœèƒ½ç”¨LOAD DATA INFILEè¯­å¥ï¼Œå°±å°½é‡ä½¿ç”¨ã€‚å› ä¸ºLOAD DATA INFILEè¯­å¥å¯¼å…¥æ•°æ®çš„é€Ÿåº¦æ¯”INSERTè¯­å¥å—ã€‚</p><p><strong>2. InnoDBå¼•æ“çš„è¡¨ï¼š</strong></p><p><strong>â‘  ç¦ç”¨å”¯ä¸€æ€§æ£€æŸ¥</strong></p><p>æ’å…¥æ•°æ®ä¹‹å‰æ‰§è¡Œ<code>set unique_checks=0</code>æ¥ç¦æ­¢å¯¹å”¯ä¸€ç´¢å¼•çš„æ£€æŸ¥ï¼Œæ•°æ®å¯¼å…¥å®Œæˆä¹‹åå†è¿è¡Œ<code>set unique_check=1</code>ã€‚è¿™ä¸ªå’ŒMyISAMå¼•æ“çš„ä½¿ç”¨æ–¹æ³•ä¸€æ ·ã€‚</p><p><strong>â‘¡ ç¦ç”¨å¤–é”®æ£€æŸ¥</strong></p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707220034534.png" class=""><p><strong>â‘¢ ç¦æ­¢è‡ªåŠ¨æäº¤</strong></p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707220131891.png" class=""><h3 id="3-6-ä½¿ç”¨éç©ºçº¦æŸ"><a href="#3-6-ä½¿ç”¨éç©ºçº¦æŸ" class="headerlink" title="3.6 ä½¿ç”¨éç©ºçº¦æŸ"></a>3.6 ä½¿ç”¨éç©ºçº¦æŸ</h3><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707220157606.png" class=""><h3 id="3-7-åˆ†æè¡¨ã€æ£€æŸ¥è¡¨ä¸ä¼˜åŒ–è¡¨"><a href="#3-7-åˆ†æè¡¨ã€æ£€æŸ¥è¡¨ä¸ä¼˜åŒ–è¡¨" class="headerlink" title="3.7 åˆ†æè¡¨ã€æ£€æŸ¥è¡¨ä¸ä¼˜åŒ–è¡¨"></a>3.7 åˆ†æè¡¨ã€æ£€æŸ¥è¡¨ä¸ä¼˜åŒ–è¡¨</h3><p>MySQLæä¾›äº†åˆ†æè¡¨ã€æ£€æŸ¥è¡¨å’Œä¼˜åŒ–è¡¨çš„è¯­å¥ã€‚<code>åˆ†æè¡¨</code>ä¸»è¦æ˜¯åˆ†æå…³é”®å­—çš„åˆ†å¸ƒï¼Œ<code>æ£€æŸ¥è¡¨</code>ä¸»è¦æ˜¯æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨é”™è¯¯ï¼Œ<code>ä¼˜åŒ–è¡¨</code>ä¸»è¦æ˜¯æ¶ˆé™¤åˆ é™¤æˆ–è€…æ›´æ–°é€ æˆçš„ç©ºé—´æµªè´¹ã€‚</p><h4 id="1-åˆ†æè¡¨"><a href="#1-åˆ†æè¡¨" class="headerlink" title="1. åˆ†æè¡¨"></a>1. åˆ†æè¡¨</h4><p>MySQLä¸­æä¾›äº†ANALYZE TABLEè¯­å¥åˆ†æè¡¨ï¼ŒANALYZE TABLEè¯­å¥çš„åŸºæœ¬è¯­æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ANALYZE [LOCAL | NO_WRITE_TO_BINLOG] TABLE tbl_name[,tbl_name]â€¦</span><br></pre></td></tr></table></figure><p>é»˜è®¤çš„ï¼ŒMySQLæœåŠ¡ä¼šå°† ANALYZE TABLEè¯­å¥å†™åˆ°binlogä¸­ï¼Œä»¥ä¾¿åœ¨ä¸»ä»æ¶æ„ä¸­ï¼Œä»æœåŠ¡èƒ½å¤ŸåŒæ­¥æ•°æ®ã€‚ å¯ä»¥æ·»åŠ å‚æ•°LOCAL æˆ–è€… NO_WRITE_TO_BINLOGå–æ¶ˆå°†è¯­å¥å†™åˆ°binlogä¸­ã€‚</p><p>ä½¿ç”¨ <code>ANALYZE TABLE</code> åˆ†æè¡¨çš„è¿‡ç¨‹ä¸­ï¼Œæ•°æ®åº“ç³»ç»Ÿä¼šè‡ªåŠ¨å¯¹è¡¨åŠ ä¸€ä¸ª <code>åªè¯»é”</code> ã€‚åœ¨åˆ†ææœŸé—´ï¼Œåªèƒ½è¯»å– è¡¨ä¸­çš„è®°å½•ï¼Œä¸èƒ½æ›´æ–°å’Œæ’å…¥è®°å½•ã€‚ANALYZE TABLEè¯­å¥èƒ½å¤Ÿåˆ†æInnoDBå’ŒMyISAMç±»å‹çš„è¡¨ï¼Œä½†æ˜¯ä¸èƒ½ä½œç”¨äºè§†å›¾ã€‚</p><p>ANALYZE TABLEåˆ†æåçš„ç»Ÿè®¡ç»“æœä¼šååº”åˆ° <code>cardinality</code> çš„å€¼ï¼Œè¯¥å€¼ç»Ÿè®¡äº†è¡¨ä¸­æŸä¸€é”®æ‰€åœ¨çš„åˆ—ä¸é‡å¤ çš„å€¼çš„ä¸ªæ•°ã€‚<strong>è¯¥å€¼è¶Šæ¥è¿‘è¡¨ä¸­çš„æ€»è¡Œæ•°ï¼Œåˆ™åœ¨è¡¨è¿æ¥æŸ¥è¯¢æˆ–è€…ç´¢å¼•æŸ¥è¯¢æ—¶ï¼Œå°±è¶Šä¼˜å…ˆè¢«ä¼˜åŒ–å™¨é€‰æ‹©ä½¿ç”¨</strong>ã€‚ä¹Ÿå°±æ˜¯ç´¢å¼•åˆ—çš„cardinalityçš„å€¼ä¸è¡¨ä¸­æ•°æ®çš„æ€»æ¡æ•°å·®è·è¶Šå¤§ï¼Œå³ä½¿æŸ¥è¯¢çš„æ—¶å€™ä½¿ç”¨äº†è¯¥ç´¢å¼•ä½œä¸ºæŸ¥ è¯¢æ¡ä»¶ï¼Œå­˜å‚¨å¼•æ“å®é™…æŸ¥è¯¢çš„æ—¶å€™ä½¿ç”¨çš„æ¦‚ç‡å°±è¶Šå°ã€‚ä¸‹é¢é€šè¿‡ä¾‹å­æ¥éªŒè¯ä¸‹ã€‚cardinalityå¯ä»¥é€šè¿‡ SHOW INDEX FROM è¡¨åæŸ¥çœ‹ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; ANALYZE TABLE user;</span><br><span class="line">+--------------+---------+----------+---------+</span><br><span class="line">| Table        | Op      | Msg_type |Msg_text |</span><br><span class="line">+--------------+---------+----------+---------+</span><br><span class="line">| atguigu.user | analyze | status   | Ok      |</span><br><span class="line">+--------------+----------+---------+---------+</span><br></pre></td></tr></table></figure><p>ä¸Šé¢ç»“æœæ˜¾ç¤ºçš„ä¿¡æ¯è¯´æ˜å¦‚ä¸‹ï¼š</p><ul><li>Table: è¡¨ç¤ºåˆ†æçš„è¡¨çš„åç§°ã€‚</li><li>Op: è¡¨ç¤ºæ‰§è¡Œçš„æ“ä½œã€‚analyzeè¡¨ç¤ºè¿›è¡Œåˆ†ææ“ä½œã€‚</li><li>Msg_type: è¡¨ç¤ºä¿¡æ¯ç±»å‹ï¼Œå…¶å€¼é€šå¸¸æ˜¯çŠ¶æ€ (status) ã€ä¿¡æ¯ (info) ã€æ³¨æ„ (note) ã€è­¦å‘Š (warning) å’Œ é”™è¯¯ (error) ä¹‹ä¸€ã€‚</li><li>Msg_text: æ˜¾ç¤ºä¿¡æ¯ã€‚</li></ul><h4 id="2-æ£€æŸ¥è¡¨"><a href="#2-æ£€æŸ¥è¡¨" class="headerlink" title="2. æ£€æŸ¥è¡¨"></a>2. æ£€æŸ¥è¡¨</h4><p>MySQLä¸­å¯ä»¥ä½¿ç”¨ <code>CHECK TABLE</code> è¯­å¥æ¥æ£€æŸ¥è¡¨ã€‚CHECK TABLEè¯­å¥èƒ½å¤Ÿæ£€æŸ¥InnoDBå’ŒMyISAMç±»å‹çš„è¡¨ æ˜¯å¦å­˜åœ¨é”™è¯¯ã€‚CHECK TABLEè¯­å¥åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ä¹Ÿä¼šç»™è¡¨åŠ ä¸Š <code>åªè¯»é”</code> ã€‚</p><p>å¯¹äºMyISAMç±»å‹çš„è¡¨ï¼ŒCHECK TABLEè¯­å¥è¿˜ä¼šæ›´æ–°å…³é”®å­—ç»Ÿè®¡æ•°æ®ã€‚è€Œä¸”ï¼ŒCHECK TABLEä¹Ÿå¯ä»¥æ£€æŸ¥è§† å›¾æ˜¯å¦æœ‰é”™è¯¯ï¼Œæ¯”å¦‚åœ¨è§†å›¾å®šä¹‰ä¸­è¢«å¼•ç”¨çš„è¡¨å·²ä¸å­˜åœ¨ã€‚è¯¥è¯­å¥çš„åŸºæœ¬è¯­æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CHECK TABLE tbl_name [, tbl_name] ... [option] ...</span><br><span class="line">option = &#123;QUICK | FAST | MEDIUM | EXTENDED | CHANGED&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­ï¼Œtbl_nameæ˜¯è¡¨åï¼›optionå‚æ•°æœ‰5ä¸ªå–å€¼ï¼Œåˆ†åˆ«æ˜¯QUICKã€FASTã€MEDIUMã€EXTENDEDå’Œ CHANGEDã€‚å„ä¸ªé€‰é¡¹çš„æ„ä¹‰åˆ†åˆ«æ˜¯ï¼š</p><ul><li>QUICK ï¼šä¸æ‰«æè¡Œï¼Œä¸æ£€æŸ¥é”™è¯¯çš„è¿æ¥ã€‚ </li><li>FAST ï¼šåªæ£€æŸ¥æ²¡æœ‰è¢«æ­£ç¡®å…³é—­çš„è¡¨ã€‚ </li><li>CHANGED ï¼šåªæ£€æŸ¥ä¸Šæ¬¡æ£€æŸ¥åè¢«æ›´æ”¹çš„è¡¨å’Œæ²¡æœ‰è¢«æ­£ç¡®å…³é—­çš„è¡¨ã€‚ </li><li>MEDIUM ï¼šæ‰«æè¡Œï¼Œä»¥éªŒè¯è¢«åˆ é™¤çš„è¿æ¥æ˜¯æœ‰æ•ˆçš„ã€‚ä¹Ÿå¯ä»¥è®¡ç®—å„è¡Œçš„å…³é”®å­—æ ¡éªŒå’Œï¼Œå¹¶ä½¿ç”¨è®¡ç®—å‡ºçš„æ ¡éªŒå’ŒéªŒè¯è¿™ä¸€ç‚¹ã€‚ </li><li>EXTENDED ï¼šå¯¹æ¯è¡Œçš„æ‰€æœ‰å…³é”®å­—è¿›è¡Œä¸€ä¸ªå…¨é¢çš„å…³é”®å­—æŸ¥æ‰¾ã€‚è¿™å¯ä»¥ç¡®ä¿è¡¨æ˜¯100%ä¸€è‡´çš„ï¼Œä½† æ˜¯èŠ±çš„æ—¶é—´è¾ƒé•¿ã€‚</li></ul><p>optionåªå¯¹MyISAMç±»å‹çš„è¡¨æœ‰æ•ˆï¼Œå¯¹InnoDBç±»å‹çš„è¡¨æ— æ•ˆã€‚æ¯”å¦‚ï¼š</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707221707254.png" class=""><p>è¯¥è¯­å¥å¯¹äºæ£€æŸ¥çš„è¡¨å¯èƒ½ä¼šäº§ç”Ÿå¤šè¡Œä¿¡æ¯ã€‚æœ€åä¸€è¡Œæœ‰ä¸€ä¸ªçŠ¶æ€çš„ Msg_type å€¼ï¼ŒMsg_text é€šå¸¸ä¸º OKã€‚ å¦‚æœå¾—åˆ°çš„ä¸æ˜¯ OKï¼Œé€šå¸¸è¦å¯¹å…¶è¿›è¡Œä¿®å¤ï¼›æ˜¯ OK è¯´æ˜è¡¨å·²ç»æ˜¯æœ€æ–°çš„äº†ã€‚è¡¨å·²ç»æ˜¯æœ€æ–°çš„ï¼Œæ„å‘³ç€å­˜ å‚¨å¼•æ“å¯¹è¿™å¼ è¡¨ä¸å¿…è¿›è¡Œæ£€æŸ¥ã€‚</p><h4 id="3-ä¼˜åŒ–è¡¨"><a href="#3-ä¼˜åŒ–è¡¨" class="headerlink" title="3. ä¼˜åŒ–è¡¨"></a>3. ä¼˜åŒ–è¡¨</h4><p><strong>æ–¹å¼1ï¼šOPTIMIZE TABLE</strong></p><p>MySQLä¸­ä½¿ç”¨ <code>OPTIMIZE TABLE</code> è¯­å¥æ¥ä¼˜åŒ–è¡¨ã€‚ä½†æ˜¯ï¼ŒOPTILMIZE TABLEè¯­å¥åªèƒ½ä¼˜åŒ–è¡¨ä¸­çš„ <code>VARCHAR</code> ã€ <code>BLOB</code> æˆ– <code>TEXT</code> ç±»å‹çš„å­—æ®µã€‚ä¸€ä¸ªè¡¨ä½¿ç”¨äº†è¿™äº›å­—æ®µçš„æ•°æ®ç±»å‹ï¼Œè‹¥å·²ç» <code>åˆ é™¤</code> äº†è¡¨çš„ä¸€å¤§éƒ¨ åˆ†æ•°æ®ï¼Œæˆ–è€…å·²ç»å¯¹å«æœ‰å¯å˜é•¿åº¦è¡Œçš„è¡¨ï¼ˆå«æœ‰VARCHARã€BLOBæˆ–TEXTåˆ—çš„è¡¨ï¼‰è¿›è¡Œäº†å¾ˆå¤š <code>æ›´æ–°</code> ï¼Œåˆ™ åº”ä½¿ç”¨OPTIMIZE TABLEæ¥é‡æ–°åˆ©ç”¨æœªä½¿ç”¨çš„ç©ºé—´ï¼Œå¹¶æ•´ç†æ•°æ®æ–‡ä»¶çš„ <code>ç¢ç‰‡</code> ã€‚</p><p>OPTIMIZE TABLE è¯­å¥å¯¹InnoDBå’ŒMyISAMç±»å‹çš„è¡¨éƒ½æœ‰æ•ˆã€‚è¯¥è¯­å¥åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ä¹Ÿä¼šç»™è¡¨åŠ ä¸Š <code>åªè¯»é”</code> ã€‚</p><p>OPTILMIZE TABLEè¯­å¥çš„åŸºæœ¬è¯­æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">OPTIMIZE [LOCAL | NO_WRITE_TO_BINLOG] TABLE tbl_name [, tbl_name] ...</span><br></pre></td></tr></table></figure><p>LOCAL | NO_WRITE_TO_BINLOGå…³é”®å­—çš„æ„ä¹‰å’Œåˆ†æè¡¨ç›¸åŒï¼Œéƒ½æ˜¯æŒ‡å®šä¸å†™å…¥äºŒè¿›åˆ¶æ—¥å¿—ã€‚</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707221901664.png" class=""><p>æ‰§è¡Œå®Œæ¯•ï¼ŒMsg_textæ˜¾ç¤º</p><blockquote><p>â€˜numysql.SYS_APP_USERâ€™, â€˜optimizeâ€™, â€˜noteâ€™, â€˜Table does not support optimize, doing recreate + analyze insteadâ€™</p></blockquote><p>åŸå› æ˜¯æˆ‘æœåŠ¡å™¨ä¸Šçš„MySQLæ˜¯InnoDBå­˜å‚¨å¼•æ“ã€‚</p><p>åˆ°åº•ä¼˜åŒ–äº†æ²¡æœ‰å‘¢ï¼Ÿçœ‹å®˜ç½‘ï¼</p><p><a><a href="https://dev.mysql.com/doc/refman/8.0/en/optimize-table.html">MySQL :: MySQL 8.0 Reference Manual :: 13.7.3.4 OPTIMIZE TABLE Statement</a></a></p><p>åœ¨MyISAMä¸­ï¼Œæ˜¯å…ˆåˆ†æè¿™å¼ è¡¨ï¼Œç„¶åä¼šæ•´ç†ç›¸å…³çš„MySQL datafileï¼Œä¹‹åå›æ”¶æœªä½¿ç”¨çš„ç©ºé—´ï¼›åœ¨InnoDB ä¸­ï¼Œå›æ”¶ç©ºé—´æ˜¯ç®€å•é€šè¿‡Alter tableè¿›è¡Œæ•´ç†ç©ºé—´ã€‚åœ¨ä¼˜åŒ–æœŸé—´ï¼ŒMySQLä¼šåˆ›å»ºä¸€ä¸ªä¸´æ—¶è¡¨ï¼Œä¼˜åŒ–å®Œæˆä¹‹ åä¼šåˆ é™¤åŸå§‹è¡¨ï¼Œç„¶åä¼šå°†ä¸´æ—¶è¡¨renameæˆä¸ºåŸå§‹è¡¨ã€‚</p><blockquote><p>è¯´æ˜ï¼š åœ¨å¤šæ•°çš„è®¾ç½®ä¸­ï¼Œæ ¹æœ¬ä¸éœ€è¦è¿è¡ŒOPTIMIZE TABLEã€‚å³ä½¿å¯¹å¯å˜é•¿åº¦çš„è¡Œè¿›è¡Œäº†å¤§é‡çš„æ›´ æ–°ï¼Œä¹Ÿä¸éœ€è¦ç»å¸¸è¿è¡Œï¼Œ<code> æ¯å‘¨ä¸€æ¬¡</code> æˆ– <code>æ¯æœˆä¸€æ¬¡</code> å³å¯ï¼Œå¹¶ä¸”åªéœ€è¦å¯¹ <code>ç‰¹å®šçš„è¡¨</code> è¿è¡Œã€‚</p></blockquote><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707222156765.png" class=""><p><strong>æ–¹å¼äºŒï¼šä½¿ç”¨mysqlcheckå‘½ä»¤</strong></p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707222305302.png" class=""><h4 id="3-8-å°ç»“"><a href="#3-8-å°ç»“" class="headerlink" title="3.8 å°ç»“"></a>3.8 å°ç»“</h4><p>ä¸Šè¿°è¿™äº›æ–¹æ³•éƒ½æ˜¯æœ‰åˆ©æœ‰å¼Šçš„ã€‚æ¯”å¦‚ï¼š</p><ul><li>ä¿®æ”¹æ•°æ®ç±»å‹ï¼ŒèŠ‚çœå­˜å‚¨ç©ºé—´çš„åŒæ—¶ï¼Œä½ è¦è€ƒè™‘åˆ°æ•°æ®ä¸èƒ½è¶…è¿‡å–å€¼èŒƒå›´ï¼› </li><li>å¢åŠ å†—ä½™å­—æ®µçš„æ—¶å€™ï¼Œä¸è¦å¿˜äº†ç¡®ä¿æ•°æ®ä¸€è‡´æ€§ï¼› </li><li>æŠŠå¤§è¡¨æ‹†åˆ†ï¼Œä¹Ÿæ„å‘³ç€ä½ çš„æŸ¥è¯¢ä¼šå¢åŠ æ–°çš„è¿æ¥ï¼Œä»è€Œå¢åŠ é¢å¤–çš„å¼€é”€å’Œè¿ç»´çš„æˆæœ¬ã€‚</li></ul><p>å› æ­¤ï¼Œä½ ä¸€å®šè¦ç»“åˆå®é™…çš„ä¸šåŠ¡éœ€æ±‚è¿›è¡Œæƒè¡¡ã€‚</p><h2 id="4-å¤§è¡¨ä¼˜åŒ–"><a href="#4-å¤§è¡¨ä¼˜åŒ–" class="headerlink" title="4. å¤§è¡¨ä¼˜åŒ–"></a>4. å¤§è¡¨ä¼˜åŒ–</h2><p>å½“MySQLå•è¡¨è®°å½•æ•°è¿‡å¤§æ—¶ï¼Œæ•°æ®åº“çš„CRUDæ€§èƒ½ä¼šæ˜æ˜¾ä¸‹é™ï¼Œä¸€äº›å¸¸è§çš„ä¼˜åŒ–æªæ–½å¦‚ä¸‹ï¼š</p><h3 id="4-1-é™å®šæŸ¥è¯¢çš„èŒƒå›´"><a href="#4-1-é™å®šæŸ¥è¯¢çš„èŒƒå›´" class="headerlink" title="4.1 é™å®šæŸ¥è¯¢çš„èŒƒå›´"></a>4.1 é™å®šæŸ¥è¯¢çš„èŒƒå›´</h3><p>ç¦æ­¢ä¸å¸¦ä»»ä½•é™åˆ¶æ•°æ®èŒƒå›´æ¡ä»¶çš„æŸ¥è¯¢è¯­å¥ã€‚æ¯”å¦‚ï¼šæˆ‘ä»¬å½“ç”¨æˆ·åœ¨æŸ¥è¯¢è®¢å•å†å²çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥æ§åˆ¶ åœ¨ä¸€ä¸ªæœˆçš„èŒƒå›´å†…ï¼›</p><h3 id="4-2-è¯»-x2F-å†™åˆ†ç¦»"><a href="#4-2-è¯»-x2F-å†™åˆ†ç¦»" class="headerlink" title="4.2 è¯»&#x2F;å†™åˆ†ç¦»"></a>4.2 è¯»&#x2F;å†™åˆ†ç¦»</h3><p>ç»å…¸çš„æ•°æ®åº“æ‹†åˆ†æ–¹æ¡ˆï¼Œä¸»åº“è´Ÿè´£å†™ï¼Œä»åº“è´Ÿè´£è¯»ã€‚</p><ul><li>ä¸€ä¸»ä¸€ä»æ¨¡å¼ï¼š</li></ul><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707222606097.png" class=""><ul><li>åŒä¸»åŒä»æ¨¡å¼ï¼š</li></ul><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707222623485.png" class=""><h3 id="4-3-å‚ç›´æ‹†åˆ†"><a href="#4-3-å‚ç›´æ‹†åˆ†" class="headerlink" title="4.3 å‚ç›´æ‹†åˆ†"></a>4.3 å‚ç›´æ‹†åˆ†</h3><p>å½“æ•°æ®é‡çº§è¾¾åˆ° <code>åƒä¸‡çº§</code> ä»¥ä¸Šæ—¶ï¼Œæœ‰æ—¶å€™æˆ‘ä»¬éœ€è¦æŠŠä¸€ä¸ªæ•°æ®åº“åˆ‡æˆå¤šä»½ï¼Œæ”¾åˆ°ä¸åŒçš„æ•°æ®åº“æœåŠ¡å™¨ä¸Šï¼Œ å‡å°‘å¯¹å•ä¸€æ•°æ®åº“æœåŠ¡å™¨çš„è®¿é—®å‹åŠ›ã€‚</p><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707222648112.png" class=""><ul><li>å¦‚æœæ•°æ®åº“çš„æ•°æ®è¡¨è¿‡å¤šï¼Œå¯ä»¥é‡‡ç”¨<code>å‚ç›´åˆ†åº“</code>çš„æ–¹å¼ï¼Œå°†å…³è”çš„æ•°æ®åº“éƒ¨ç½²åœ¨åŒä¸€ä¸ªæ•°æ®åº“ä¸Šã€‚</li><li>å¦‚æœæ•°æ®åº“ä¸­çš„åˆ—è¿‡å¤šï¼Œå¯ä»¥é‡‡ç”¨<code>å‚ç›´åˆ†è¡¨</code>çš„æ–¹å¼ï¼Œå°†ä¸€å¼ æ•°æ®è¡¨åˆ†æ‹†æˆå¤šå¼ æ•°æ®è¡¨ï¼ŒæŠŠç»å¸¸ä¸€èµ·ä½¿ç”¨çš„åˆ—æ”¾åœ¨åŒä¸€å¼ è¡¨é‡Œã€‚</li></ul><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707222910740.png" class=""><p><code>å‚ç›´æ‹†åˆ†çš„ä¼˜ç‚¹</code>ï¼š å¯ä»¥ä½¿å¾—åˆ—æ•°æ®å˜å°ï¼Œåœ¨æŸ¥è¯¢æ—¶å‡å°‘è¯»å–çš„Blockæ•°ï¼Œå‡å°‘I&#x2F;Oæ¬¡æ•°ã€‚æ­¤å¤–ï¼Œå‚ç›´åˆ†åŒºå¯ä»¥ç®€åŒ–è¡¨çš„ç»“æ„ï¼Œæ˜“äºç»´æŠ¤ã€‚ </p><p><code>å‚ç›´æ‹†åˆ†çš„ç¼ºç‚¹</code>ï¼š ä¸»é”®ä¼šå‡ºç°å†—ä½™ï¼Œéœ€è¦ç®¡ç†å†—ä½™åˆ—ï¼Œå¹¶ä¼šå¼•èµ· JOIN æ“ä½œã€‚æ­¤å¤–ï¼Œå‚ç›´æ‹†åˆ†ä¼šè®©äº‹åŠ¡å˜å¾—æ›´åŠ å¤æ‚ã€‚</p><h3 id="4-4-æ°´å¹³æ‹†åˆ†"><a href="#4-4-æ°´å¹³æ‹†åˆ†" class="headerlink" title="4.4 æ°´å¹³æ‹†åˆ†"></a>4.4 æ°´å¹³æ‹†åˆ†</h3><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707222954304.png" class=""><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707222739120.png" class=""><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707223024163.png" class=""><p>ä¸‹é¢è¡¥å……ä¸€ä¸‹æ•°æ®åº“åˆ†ç‰‡çš„ä¸¤ç§å¸¸è§æ–¹æ¡ˆï¼š</p><ul><li><strong>å®¢æˆ·ç«¯ä»£ç†ï¼š åˆ†ç‰‡é€»è¾‘åœ¨åº”ç”¨ç«¯ï¼Œå°è£…åœ¨jaråŒ…ä¸­ï¼Œé€šè¿‡ä¿®æ”¹æˆ–è€…å°è£…JDBCå±‚æ¥å®ç°ã€‚</strong> å½“å½“ç½‘çš„ Sharding-JDBC ã€é˜¿é‡Œçš„TDDLæ˜¯ä¸¤ç§æ¯”è¾ƒå¸¸ç”¨çš„å®ç°ã€‚ </li><li><strong>ä¸­é—´ä»¶ä»£ç†ï¼š åœ¨åº”ç”¨å’Œæ•°æ®ä¸­é—´åŠ äº†ä¸€ä¸ªä»£ç†å±‚ã€‚åˆ†ç‰‡é€»è¾‘ç»Ÿä¸€ç»´æŠ¤åœ¨ä¸­é—´ä»¶æœåŠ¡ä¸­ã€‚</strong>æˆ‘ä»¬ç°åœ¨ è°ˆçš„ Mycat ã€360çš„Atlasã€ç½‘æ˜“çš„DDBç­‰ç­‰éƒ½æ˜¯è¿™ç§æ¶æ„çš„å®ç°ã€‚</li></ul><h2 id="5-å…¶å®ƒè°ƒä¼˜ç­–ç•¥"><a href="#5-å…¶å®ƒè°ƒä¼˜ç­–ç•¥" class="headerlink" title="5. å…¶å®ƒè°ƒä¼˜ç­–ç•¥"></a>5. å…¶å®ƒè°ƒä¼˜ç­–ç•¥</h2><h3 id="5-1-æœåŠ¡å™¨è¯­å¥è¶…æ—¶å¤„ç†"><a href="#5-1-æœåŠ¡å™¨è¯­å¥è¶…æ—¶å¤„ç†" class="headerlink" title="5.1 æœåŠ¡å™¨è¯­å¥è¶…æ—¶å¤„ç†"></a>5.1 æœåŠ¡å™¨è¯­å¥è¶…æ—¶å¤„ç†</h3><p>åœ¨MySQL 8.0ä¸­å¯ä»¥è®¾ç½® æœåŠ¡å™¨è¯­å¥è¶…æ—¶çš„é™åˆ¶ ï¼Œå•ä½å¯ä»¥è¾¾åˆ° æ¯«ç§’çº§åˆ« ã€‚å½“ä¸­æ–­çš„æ‰§è¡Œè¯­å¥è¶…è¿‡è®¾ç½®çš„ æ¯«ç§’æ•°åï¼ŒæœåŠ¡å™¨å°†ç»ˆæ­¢æŸ¥è¯¢å½±å“ä¸å¤§çš„äº‹åŠ¡æˆ–è¿æ¥ï¼Œç„¶åå°†é”™è¯¯æŠ¥ç»™å®¢æˆ·ç«¯ã€‚</p><p>è®¾ç½®æœåŠ¡å™¨è¯­å¥è¶…æ—¶çš„é™åˆ¶ï¼Œå¯ä»¥é€šè¿‡è®¾ç½®ç³»ç»Ÿå˜é‡ MAX_EXECUTION_TIME æ¥å®ç°ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œ MAX_EXECUTION_TIMEçš„å€¼ä¸º0ï¼Œä»£è¡¨æ²¡æœ‰æ—¶é—´é™åˆ¶ã€‚ ä¾‹å¦‚ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SET GLOBAL MAX_EXECUTION_TIME=2000;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SET SESSION MAX_EXECUTION_TIME=2000; #æŒ‡å®šè¯¥ä¼šè¯ä¸­SELECTè¯­å¥çš„è¶…æ—¶æ—¶é—´</span><br></pre></td></tr></table></figure><h3 id="5-2-åˆ›å»ºå…¨å±€é€šç”¨è¡¨ç©ºé—´"><a href="#5-2-åˆ›å»ºå…¨å±€é€šç”¨è¡¨ç©ºé—´" class="headerlink" title="5.2 åˆ›å»ºå…¨å±€é€šç”¨è¡¨ç©ºé—´"></a>5.2 åˆ›å»ºå…¨å±€é€šç”¨è¡¨ç©ºé—´</h3><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707223246684.png" class=""><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707223349879.png" class=""><h3 id="5-3-MySQL-8-0æ–°ç‰¹æ€§ï¼šéšè—ç´¢å¼•å¯¹è°ƒä¼˜çš„å¸®åŠ©"><a href="#5-3-MySQL-8-0æ–°ç‰¹æ€§ï¼šéšè—ç´¢å¼•å¯¹è°ƒä¼˜çš„å¸®åŠ©" class="headerlink" title="5.3 MySQL 8.0æ–°ç‰¹æ€§ï¼šéšè—ç´¢å¼•å¯¹è°ƒä¼˜çš„å¸®åŠ©"></a>5.3 MySQL 8.0æ–°ç‰¹æ€§ï¼šéšè—ç´¢å¼•å¯¹è°ƒä¼˜çš„å¸®åŠ©</h3><img src="/2023/03/03/02-MySQL%E7%B4%A2%E5%BC%95%E5%8F%8A%E8%B0%83%E4%BC%98%E7%AF%87/image-20220707223420496.png" class="">]]></content>
      
      
      <categories>
          
          <category> Mysql </category>
          
          <category> Mysqlé«˜çº§ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Mysqlé«˜çº§ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>01_MySQLæ¶æ„ç¯‡</title>
      <link href="/2023/03/03/01-MySQL%E6%9E%B6%E6%9E%84%E7%AF%87/"/>
      <url>/2023/03/03/01-MySQL%E6%9E%B6%E6%9E%84%E7%AF%87/</url>
      
        <content type="html"><![CDATA[<h1 id="ç¬¬04ç« -é€»è¾‘æ¶æ„"><a href="#ç¬¬04ç« -é€»è¾‘æ¶æ„" class="headerlink" title="ç¬¬04ç« _é€»è¾‘æ¶æ„"></a>ç¬¬04ç« _é€»è¾‘æ¶æ„</h1><h2 id="1-é€»è¾‘æ¶æ„å‰–æ"><a href="#1-é€»è¾‘æ¶æ„å‰–æ" class="headerlink" title="1. é€»è¾‘æ¶æ„å‰–æ"></a>1. é€»è¾‘æ¶æ„å‰–æ</h2><h3 id="1-1-æœåŠ¡å™¨å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚"><a href="#1-1-æœåŠ¡å™¨å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚" class="headerlink" title="1.1 æœåŠ¡å™¨å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚"></a>1.1 æœåŠ¡å™¨å¤„ç†å®¢æˆ·ç«¯è¯·æ±‚</h3><p>é¦–å…ˆMySQLæ˜¯å…¸å‹çš„C&#x2F;Sæ¶æ„ï¼Œå³<code>Clinet/Server æ¶æ„</code>ï¼ŒæœåŠ¡ç«¯ç¨‹åºä½¿ç”¨çš„mysqldã€‚</p><p>ä¸è®ºå®¢æˆ·ç«¯è¿›ç¨‹å’ŒæœåŠ¡å™¨è¿›ç¨‹æ˜¯é‡‡ç”¨å“ªç§æ–¹å¼è¿›è¡Œé€šä¿¡ï¼Œæœ€åå®ç°çš„æ•ˆæœæ˜¯ï¼š<strong>å®¢æˆ·ç«¯è¿›ç¨‹å‘æœåŠ¡å™¨è¿›ç¨‹å‘é€ä¸€æ®µæ–‡æœ¬ï¼ˆSQLè¯­å¥ï¼‰ï¼ŒæœåŠ¡å™¨è¿›ç¨‹å¤„ç†åå†å‘å®¢æˆ·ç«¯è¿›ç¨‹å‘é€ä¸€æ®µæ–‡æœ¬ï¼ˆå¤„ç†ç»“æœï¼‰</strong>ã€‚</p><p>é‚£æœåŠ¡å™¨è¿›ç¨‹å¯¹å®¢æˆ·ç«¯è¿›ç¨‹å‘é€çš„è¯·æ±‚åšäº†ä»€ä¹ˆå¤„ç†ï¼Œæ‰èƒ½äº§ç”Ÿæœ€åçš„å¤„ç†ç»“æœå‘¢ï¼Ÿè¿™é‡Œä»¥æŸ¥è¯¢è¯·æ±‚ä¸º ä¾‹å±•ç¤ºï¼š</p><img src="/2023/03/03/01-MySQL%E6%9E%B6%E6%9E%84%E7%AF%87/image-20220615133227202.png" class=""><p>ä¸‹é¢å…·ä½“å±•å¼€å¦‚ä¸‹ï¼š</p><img src="/2023/03/03/01-MySQL%E6%9E%B6%E6%9E%84%E7%AF%87/image-20220615133420251.png" class=""><h3 id="1-2-Connectors"><a href="#1-2-Connectors" class="headerlink" title="1.2 Connectors"></a>1.2 Connectors</h3><p>Connectors, æŒ‡çš„æ˜¯ä¸åŒè¯­è¨€ä¸­ä¸SQLçš„äº¤äº’ã€‚MySQLé¦–å…ˆæ˜¯ä¸€ä¸ªç½‘ç»œç¨‹åºï¼Œåœ¨TCPä¹‹ä¸Šå®šä¹‰äº†è‡ªå·±çš„åº”ç”¨å±‚åè®®ã€‚æ‰€ä»¥è¦ä½¿ç”¨MySQLï¼Œæˆ‘ä»¬å¯ä»¥ç¼–å†™ä»£ç ï¼Œè·ŸMySQL Server <code>å»ºç«‹TCPè¿æ¥</code>ï¼Œä¹‹åæŒ‰ç…§å…¶å®šä¹‰å¥½çš„åè®®è¿›è¡Œäº¤äº’ã€‚æˆ–è€…æ¯”è¾ƒæ–¹ä¾¿çš„æ–¹æ³•æ˜¯è°ƒç”¨SDKï¼Œæ¯”å¦‚Native C APIã€JDBCã€PHPç­‰å„è¯­è¨€MySQL Connecotr,æˆ–è€…é€šè¿‡ODBCã€‚ä½†<strong>é€šè¿‡SDKæ¥è®¿é—®MySQLï¼Œæœ¬è´¨ä¸Šè¿˜æ˜¯åœ¨TCPè¿æ¥ä¸Šé€šè¿‡MySQLåè®®è·ŸMySQLè¿›è¡Œäº¤äº’</strong></p><p><strong>æ¥ä¸‹æ¥çš„MySQL Serverç»“æ„å¯ä»¥åˆ†ä¸ºå¦‚ä¸‹ä¸‰å±‚ï¼š</strong></p><h3 id="1-3-ç¬¬ä¸€å±‚ï¼šè¿æ¥å±‚"><a href="#1-3-ç¬¬ä¸€å±‚ï¼šè¿æ¥å±‚" class="headerlink" title="1.3 ç¬¬ä¸€å±‚ï¼šè¿æ¥å±‚"></a>1.3 ç¬¬ä¸€å±‚ï¼šè¿æ¥å±‚</h3><p>ç³»ç»Ÿï¼ˆå®¢æˆ·ç«¯ï¼‰è®¿é—® MySQL æœåŠ¡å™¨å‰ï¼Œåšçš„ç¬¬ä¸€ä»¶äº‹å°±æ˜¯å»ºç«‹ TCP è¿æ¥ã€‚ ç»è¿‡ä¸‰æ¬¡æ¡æ‰‹å»ºç«‹è¿æ¥æˆåŠŸåï¼Œ MySQL æœåŠ¡å™¨å¯¹ TCP ä¼ è¾“è¿‡æ¥çš„è´¦å·å¯†ç åšèº«ä»½è®¤è¯ã€æƒé™è·å–ã€‚</p><ul><li>ç”¨æˆ·åæˆ–å¯†ç ä¸å¯¹ï¼Œä¼šæ”¶åˆ°ä¸€ä¸ªAccess denied for useré”™è¯¯ï¼Œå®¢æˆ·ç«¯ç¨‹åºç»“æŸæ‰§è¡Œ </li><li>ç”¨æˆ·åå¯†ç è®¤è¯é€šè¿‡ï¼Œä¼šä»æƒé™è¡¨æŸ¥å‡ºè´¦å·æ‹¥æœ‰çš„æƒé™ä¸è¿æ¥å…³è”ï¼Œä¹‹åçš„æƒé™åˆ¤æ–­é€»è¾‘ï¼Œéƒ½å°†ä¾èµ–äºæ­¤æ—¶è¯»åˆ°çš„æƒé™</li></ul><p>TCP è¿æ¥æ”¶åˆ°è¯·æ±‚åï¼Œå¿…é¡»è¦åˆ†é…ç»™ä¸€ä¸ªçº¿ç¨‹ä¸“é—¨ä¸è¿™ä¸ªå®¢æˆ·ç«¯çš„äº¤äº’ã€‚æ‰€ä»¥è¿˜ä¼šæœ‰ä¸ªçº¿ç¨‹æ± ï¼Œå»èµ°åé¢çš„æµç¨‹ã€‚æ¯ä¸€ä¸ªè¿æ¥ä»çº¿ç¨‹æ± ä¸­è·å–çº¿ç¨‹ï¼Œçœå»äº†åˆ›å»ºå’Œé”€æ¯çº¿ç¨‹çš„å¼€é”€ã€‚</p><p>æ‰€ä»¥<strong>è¿æ¥ç®¡ç†</strong>çš„èŒè´£æ˜¯è´Ÿè´£è®¤è¯ã€ç®¡ç†è¿æ¥ã€è·å–æƒé™ä¿¡æ¯ã€‚</p><h3 id="1-4-ç¬¬äºŒå±‚ï¼šæœåŠ¡å±‚"><a href="#1-4-ç¬¬äºŒå±‚ï¼šæœåŠ¡å±‚" class="headerlink" title="1.4 ç¬¬äºŒå±‚ï¼šæœåŠ¡å±‚"></a>1.4 ç¬¬äºŒå±‚ï¼šæœåŠ¡å±‚</h3><p>ç¬¬äºŒå±‚æ¶æ„ä¸»è¦å®Œæˆå¤§å¤šæ•°çš„æ ¸å¿ƒæœåŠ¡åŠŸèƒ½ï¼Œå¦‚SQLæ¥å£ï¼Œå¹¶å®Œæˆ<code>ç¼“å­˜çš„æŸ¥è¯¢</code>ï¼ŒSQLçš„åˆ†æå’Œä¼˜åŒ–åŠéƒ¨åˆ†å†…ç½®å‡½æ•°çš„æ‰§è¡Œã€‚æ‰€æœ‰è·¨å­˜å‚¨å¼•æ“çš„åŠŸèƒ½ä¹Ÿåœ¨è¿™ä¸€å±‚å®ç°ï¼Œå¦‚è¿‡ç¨‹ã€å‡½æ•°ç­‰ã€‚</p><p>åœ¨è¯¥å±‚ï¼ŒæœåŠ¡å™¨ä¼š<code>è§£ææŸ¥è¯¢</code>å¹¶åˆ›å»ºç›¸åº”çš„å†…éƒ¨<code>è§£ææ ‘</code>ï¼Œå¹¶å¯¹å…¶å®Œæˆç›¸åº”çš„<code>ä¼˜åŒ–</code>ï¼šå¦‚ç¡®å®šæŸ¥è¯¢è¡¨çš„é¡ºåºï¼Œæ˜¯å¦åˆ©ç”¨ç´¢å¼•ç­‰ï¼Œæœ€åç”Ÿæˆç›¸åº”çš„æ‰§è¡Œæ“ä½œã€‚</p><p>å¦‚æœæ˜¯SELECTè¯­å¥ï¼ŒæœåŠ¡å™¨è¿˜ä¼š<code>æŸ¥è¯¢å†…éƒ¨çš„ç¼“å­˜</code>ã€‚å¦‚æœç¼“å­˜ç©ºé—´è¶³å¤Ÿå¤§ï¼Œè¿™æ ·åœ¨è§£å†³å¤§é‡è¯»æ“ä½œçš„ç¯å¢ƒä¸­èƒ½å¤Ÿå¾ˆå¥½çš„æå‡ç³»ç»Ÿçš„æ€§èƒ½ã€‚</p><ul><li><p>SQL Interface: SQLæ¥å£ </p><ul><li>æ¥æ”¶ç”¨æˆ·çš„SQLå‘½ä»¤ï¼Œå¹¶ä¸”è¿”å›ç”¨æˆ·éœ€è¦æŸ¥è¯¢çš„ç»“æœã€‚æ¯”å¦‚SELECT â€¦ FROMå°±æ˜¯è°ƒç”¨SQL Interface </li><li>MySQLæ”¯æŒDMLï¼ˆæ•°æ®æ“ä½œè¯­è¨€ï¼‰ã€DDLï¼ˆæ•°æ®å®šä¹‰è¯­è¨€ï¼‰ã€å­˜å‚¨è¿‡ç¨‹ã€è§†å›¾ã€è§¦å‘å™¨ã€è‡ªå®š ä¹‰å‡½æ•°ç­‰å¤šç§SQLè¯­è¨€æ¥å£</li></ul></li><li><p>Parser: è§£æå™¨</p><ul><li>åœ¨è§£æå™¨ä¸­å¯¹ SQL è¯­å¥è¿›è¡Œè¯­æ³•åˆ†æã€è¯­ä¹‰åˆ†æã€‚å°†SQLè¯­å¥åˆ†è§£æˆæ•°æ®ç»“æ„ï¼Œå¹¶å°†è¿™ä¸ªç»“æ„ ä¼ é€’åˆ°åç»­æ­¥éª¤ï¼Œä»¥åSQLè¯­å¥çš„ä¼ é€’å’Œå¤„ç†å°±æ˜¯åŸºäºè¿™ä¸ªç»“æ„çš„ã€‚å¦‚æœåœ¨åˆ†è§£æ„æˆä¸­é‡åˆ°é”™ è¯¯ï¼Œé‚£ä¹ˆå°±è¯´æ˜è¿™ä¸ªSQLè¯­å¥æ˜¯ä¸åˆç†çš„ã€‚ </li><li>åœ¨SQLå‘½ä»¤ä¼ é€’åˆ°è§£æå™¨çš„æ—¶å€™ä¼šè¢«è§£æå™¨éªŒè¯å’Œè§£æï¼Œå¹¶ä¸ºå…¶åˆ›å»º è¯­æ³•æ ‘ ï¼Œå¹¶æ ¹æ®æ•°æ®å­— å…¸ä¸°å¯ŒæŸ¥è¯¢è¯­æ³•æ ‘ï¼Œä¼š éªŒè¯è¯¥å®¢æˆ·ç«¯æ˜¯å¦å…·æœ‰æ‰§è¡Œè¯¥æŸ¥è¯¢çš„æƒé™ ã€‚åˆ›å»ºå¥½è¯­æ³•æ ‘åï¼ŒMySQLè¿˜ ä¼šå¯¹SQlæŸ¥è¯¢è¿›è¡Œè¯­æ³•ä¸Šçš„ä¼˜åŒ–ï¼Œè¿›è¡ŒæŸ¥è¯¢é‡å†™ã€‚</li></ul></li><li><p>Optimizer: æŸ¥è¯¢ä¼˜åŒ–å™¨</p><ul><li>SQLè¯­å¥åœ¨è¯­æ³•è§£æä¹‹åã€æŸ¥è¯¢ä¹‹å‰ä¼šä½¿ç”¨æŸ¥è¯¢ä¼˜åŒ–å™¨ç¡®å®š SQL è¯­å¥çš„æ‰§è¡Œè·¯å¾„ï¼Œç”Ÿæˆä¸€ä¸ª æ‰§è¡Œè®¡åˆ’ ã€‚ </li><li>è¿™ä¸ªæ‰§è¡Œè®¡åˆ’è¡¨æ˜åº”è¯¥ ä½¿ç”¨å“ªäº›ç´¢å¼• è¿›è¡ŒæŸ¥è¯¢ï¼ˆå…¨è¡¨æ£€ç´¢è¿˜æ˜¯ä½¿ç”¨ç´¢å¼•æ£€ç´¢ï¼‰ï¼Œè¡¨ä¹‹é—´çš„è¿ æ¥é¡ºåºå¦‚ä½•ï¼Œæœ€åä¼šæŒ‰ç…§æ‰§è¡Œè®¡åˆ’ä¸­çš„æ­¥éª¤è°ƒç”¨å­˜å‚¨å¼•æ“æä¾›çš„æ–¹æ³•æ¥çœŸæ­£çš„æ‰§è¡ŒæŸ¥è¯¢ï¼Œå¹¶å°† æŸ¥è¯¢ç»“æœè¿”å›ç»™ç”¨æˆ·ã€‚</li><li>å®ƒä½¿ç”¨â€œ é€‰å–-æŠ•å½±-è¿æ¥ â€ç­–ç•¥è¿›è¡ŒæŸ¥è¯¢ã€‚ä¾‹å¦‚ï¼š</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT id,name FROM student WHERE gender = &#x27;å¥³&#x27;;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªSELECTæŸ¥è¯¢å…ˆæ ¹æ®WHEREè¯­å¥è¿›è¡Œ é€‰å– ï¼Œè€Œä¸æ˜¯å°†è¡¨å…¨éƒ¨æŸ¥è¯¢å‡ºæ¥ä»¥åå†è¿›è¡Œgenderè¿‡ æ»¤ã€‚ è¿™ä¸ªSELECTæŸ¥è¯¢å…ˆæ ¹æ®idå’Œnameè¿›è¡Œå±æ€§ æŠ•å½± ï¼Œè€Œä¸æ˜¯å°†å±æ€§å…¨éƒ¨å–å‡ºä»¥åå†è¿›è¡Œè¿‡ æ»¤ï¼Œå°†è¿™ä¸¤ä¸ªæŸ¥è¯¢æ¡ä»¶ è¿æ¥ èµ·æ¥ç”Ÿæˆæœ€ç»ˆæŸ¥è¯¢ç»“æœã€‚</p></li><li><p>Caches &amp; Buffersï¼š æŸ¥è¯¢ç¼“å­˜ç»„ä»¶</p><ul><li>MySQLå†…éƒ¨ç»´æŒç€ä¸€äº›Cacheå’ŒBufferï¼Œæ¯”å¦‚Query Cacheç”¨æ¥ç¼“å­˜ä¸€æ¡SELECTè¯­å¥çš„æ‰§è¡Œç»“ æœï¼Œå¦‚æœèƒ½å¤Ÿåœ¨å…¶ä¸­æ‰¾åˆ°å¯¹åº”çš„æŸ¥è¯¢ç»“æœï¼Œé‚£ä¹ˆå°±ä¸å¿…å†è¿›è¡ŒæŸ¥è¯¢è§£æã€ä¼˜åŒ–å’Œæ‰§è¡Œçš„æ•´ä¸ªè¿‡ ç¨‹äº†ï¼Œç›´æ¥å°†ç»“æœåé¦ˆç»™å®¢æˆ·ç«¯ã€‚ </li><li>è¿™ä¸ªç¼“å­˜æœºåˆ¶æ˜¯ç”±ä¸€ç³»åˆ—å°ç¼“å­˜ç»„æˆçš„ã€‚æ¯”å¦‚è¡¨ç¼“å­˜ï¼Œè®°å½•ç¼“å­˜ï¼Œkeyç¼“å­˜ï¼Œæƒé™ç¼“å­˜ç­‰ ã€‚ è¿™ä¸ªæŸ¥è¯¢ç¼“å­˜å¯ä»¥åœ¨ ä¸åŒå®¢æˆ·ç«¯ä¹‹é—´å…±äº« ã€‚ </li><li>ä»MySQL 5.7.20å¼€å§‹ï¼Œä¸æ¨èä½¿ç”¨æŸ¥è¯¢ç¼“å­˜ï¼Œå¹¶åœ¨ MySQL 8.0ä¸­åˆ é™¤ ã€‚</li></ul></li></ul><h3 id="1-5-ç¬¬ä¸‰å±‚ï¼šå¼•æ“å±‚"><a href="#1-5-ç¬¬ä¸‰å±‚ï¼šå¼•æ“å±‚" class="headerlink" title="1.5 ç¬¬ä¸‰å±‚ï¼šå¼•æ“å±‚"></a>1.5 ç¬¬ä¸‰å±‚ï¼šå¼•æ“å±‚</h3><p>æ’ä»¶å¼å­˜å‚¨å¼•æ“å±‚ï¼ˆ Storage Enginesï¼‰ï¼Œ<strong>çœŸæ­£çš„è´Ÿè´£äº†MySQLä¸­æ•°æ®çš„å­˜å‚¨å’Œæå–ï¼Œå¯¹ç‰©ç†æœåŠ¡å™¨çº§åˆ«ç»´æŠ¤çš„åº•å±‚æ•°æ®æ‰§è¡Œæ“ä½œ</strong>ï¼ŒæœåŠ¡å™¨é€šè¿‡APIä¸å­˜å‚¨å¼•æ“è¿›è¡Œé€šä¿¡ã€‚ä¸åŒçš„å­˜å‚¨å¼•æ“å…·æœ‰çš„åŠŸèƒ½ä¸åŒï¼Œè¿™æ · æˆ‘ä»¬å¯ä»¥æ ¹æ®è‡ªå·±çš„å®é™…éœ€è¦è¿›è¡Œé€‰å–ã€‚</p><p>MySQL 8.0.25é»˜è®¤æ”¯æŒçš„å­˜å‚¨å¼•æ“å¦‚ä¸‹ï¼š</p><img src="/2023/03/03/01-MySQL%E6%9E%B6%E6%9E%84%E7%AF%87/image-20220615140556893.png" class=""><h3 id="1-6-å­˜å‚¨å±‚"><a href="#1-6-å­˜å‚¨å±‚" class="headerlink" title="1.6 å­˜å‚¨å±‚"></a>1.6 å­˜å‚¨å±‚</h3><p>æ‰€æœ‰çš„æ•°æ®ï¼Œæ•°æ®åº“ã€è¡¨çš„å®šä¹‰ï¼Œè¡¨çš„æ¯ä¸€è¡Œçš„å†…å®¹ï¼Œç´¢å¼•ï¼Œéƒ½æ˜¯å­˜åœ¨æ–‡ä»¶ç³»ç»Ÿ ä¸Šï¼Œä»¥<code>æ–‡ä»¶</code>çš„æ–¹å¼å­˜åœ¨çš„ï¼Œå¹¶å®Œæˆä¸å­˜å‚¨å¼•æ“çš„äº¤äº’ã€‚å½“ç„¶æœ‰äº›å­˜å‚¨å¼•æ“æ¯”å¦‚InnoDBï¼Œä¹Ÿæ”¯æŒä¸ä½¿ç”¨æ–‡ä»¶ç³»ç»Ÿç›´æ¥ç®¡ç†è£¸è®¾å¤‡ï¼Œä½†ç°ä»£æ–‡ä»¶ç³»ç»Ÿçš„å®ç°ä½¿å¾—è¿™æ ·åšæ²¡æœ‰å¿…è¦äº†ã€‚åœ¨æ–‡ä»¶ç³»ç»Ÿä¹‹ä¸‹ï¼Œå¯ä»¥ä½¿ç”¨æœ¬åœ°ç£ç›˜ï¼Œå¯ä»¥ä½¿ç”¨ DASã€NASã€SANç­‰å„ç§å­˜å‚¨ç³»ç»Ÿã€‚</p><h3 id="1-7-å°ç»“"><a href="#1-7-å°ç»“" class="headerlink" title="1.7 å°ç»“"></a>1.7 å°ç»“</h3><p>MySQLæ¶æ„å›¾æœ¬èŠ‚å¼€ç¯‡æ‰€ç¤ºã€‚ä¸‹é¢ä¸ºäº†ç†Ÿæ‚‰SQLæ‰§è¡Œæµç¨‹æ–¹ä¾¿ï¼Œæˆ‘ä»¬å¯ä»¥ç®€åŒ–å¦‚ä¸‹ï¼š</p><img src="/2023/03/03/01-MySQL%E6%9E%B6%E6%9E%84%E7%AF%87/image-20220615140710351.png" class=""><p>ç®€åŒ–ä¸ºä¸‰å±‚ç»“æ„ï¼š </p><ol><li>è¿æ¥å±‚ï¼šå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯å»ºç«‹è¿æ¥ï¼Œå®¢æˆ·ç«¯å‘é€ SQL è‡³æœåŠ¡å™¨ç«¯ï¼› </li><li>SQL å±‚ï¼ˆæœåŠ¡å±‚ï¼‰ï¼šå¯¹ SQL è¯­å¥è¿›è¡ŒæŸ¥è¯¢å¤„ç†ï¼›ä¸æ•°æ®åº“æ–‡ä»¶çš„å­˜å‚¨æ–¹å¼æ— å…³ï¼›</li><li>å­˜å‚¨å¼•æ“å±‚ï¼šä¸æ•°æ®åº“æ–‡ä»¶æ‰“äº¤é“ï¼Œè´Ÿè´£æ•°æ®çš„å­˜å‚¨å’Œè¯»å–ã€‚</li></ol><h2 id="2-SQLæ‰§è¡Œæµç¨‹"><a href="#2-SQLæ‰§è¡Œæµç¨‹" class="headerlink" title="2. SQLæ‰§è¡Œæµç¨‹"></a>2. SQLæ‰§è¡Œæµç¨‹</h2><h3 id="2-1-MySQLä¸­çš„SQLæ‰§è¡Œæµç¨‹"><a href="#2-1-MySQLä¸­çš„SQLæ‰§è¡Œæµç¨‹" class="headerlink" title="2.1 MySQLä¸­çš„SQLæ‰§è¡Œæµç¨‹"></a>2.1 MySQLä¸­çš„SQLæ‰§è¡Œæµç¨‹</h3><img src="/2023/03/03/01-MySQL%E6%9E%B6%E6%9E%84%E7%AF%87/image-20220615141934531.png" class=""><p>MySQLçš„æŸ¥è¯¢æµç¨‹ï¼š</p><ol><li><strong>æŸ¥è¯¢ç¼“å­˜</strong>ï¼šServer å¦‚æœåœ¨æŸ¥è¯¢ç¼“å­˜ä¸­å‘ç°äº†è¿™æ¡ SQL è¯­å¥ï¼Œå°±ä¼šç›´æ¥å°†ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ï¼›å¦‚æœæ²¡ æœ‰ï¼Œå°±è¿›å…¥åˆ°è§£æå™¨é˜¶æ®µã€‚éœ€è¦è¯´æ˜çš„æ˜¯ï¼Œå› ä¸ºæŸ¥è¯¢ç¼“å­˜å¾€å¾€æ•ˆç‡ä¸é«˜ï¼Œæ‰€ä»¥åœ¨ MySQL8.0 ä¹‹åå°±æŠ›å¼ƒäº†è¿™ä¸ªåŠŸèƒ½ã€‚</li></ol><p><strong>æ€»ä¹‹ï¼Œå› ä¸ºæŸ¥è¯¢ç¼“å­˜å¾€å¾€å¼Šå¤§äºåˆ©ï¼ŒæŸ¥è¯¢ç¼“å­˜çš„å¤±æ•ˆéå¸¸é¢‘ç¹ã€‚</strong></p><p>ä¸€èˆ¬å»ºè®®å¤§å®¶åœ¨é™æ€è¡¨é‡Œä½¿ç”¨æŸ¥è¯¢ç¼“å­˜ï¼Œä»€ä¹ˆå«<code>é™æ€è¡¨</code>å‘¢ï¼Ÿå°±æ˜¯ä¸€èˆ¬æˆ‘ä»¬æå°‘æ›´æ–°çš„è¡¨ã€‚æ¯”å¦‚ï¼Œä¸€ä¸ªç³»ç»Ÿé…ç½®è¡¨ã€å­—å…¸è¡¨ï¼Œè¿™å¼ è¡¨ä¸Šçš„æŸ¥è¯¢æ‰é€‚åˆä½¿ç”¨æŸ¥è¯¢ç¼“å­˜ã€‚å¥½åœ¨MySQLä¹Ÿæä¾›äº†è¿™ç§â€œ<code>æŒ‰éœ€ä½¿ç”¨</code>â€çš„æ–¹å¼ã€‚ä½ å¯ä»¥å°† my.cnf å‚æ•° query_cache_type è®¾ç½®æˆ DEMANDï¼Œä»£è¡¨å½“ sql è¯­å¥ä¸­æœ‰ SQL_CACHEå…³é”®å­—æ—¶æ‰ç¼“å­˜ã€‚æ¯”å¦‚ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># query_cache_type æœ‰3ä¸ªå€¼ã€‚ 0ä»£è¡¨å…³é—­æŸ¥è¯¢ç¼“å­˜OFFï¼Œ1ä»£è¡¨å¼€å¯ONï¼Œ2ä»£è¡¨(DEMAND)</span><br><span class="line">query_cache_type=2</span><br></pre></td></tr></table></figure><p>è¿™æ ·å¯¹äºé»˜è®¤çš„SQLè¯­å¥éƒ½ä¸ä½¿ç”¨æŸ¥è¯¢ç¼“å­˜ã€‚è€Œå¯¹äºä½ ç¡®å®šè¦ä½¿ç”¨æŸ¥è¯¢ç¼“å­˜çš„è¯­å¥ï¼Œå¯ä»¥ä¾›SQL_CACHEæ˜¾ç¤ºæŒ‡å®šï¼Œåƒä¸‹é¢è¿™ä¸ªè¯­å¥ä¸€æ ·ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT SQl_CACHE * FROM test WHERE ID=5;</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹å½“å‰ mysql å®ä¾‹æ˜¯å¦å¼€å¯ç¼“å­˜æœºåˆ¶</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># MySQL5.7ä¸­ï¼š</span><br><span class="line">show global variables like &quot;%query_cache_type%&quot;;</span><br></pre></td></tr></table></figure><p>ç›‘æ§æŸ¥è¯¢ç¼“å­˜çš„å‘½ä¸­ç‡ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show status like &#x27;%Qcache%&#x27;;</span><br></pre></td></tr></table></figure><img src="/2023/03/03/01-MySQL%E6%9E%B6%E6%9E%84%E7%AF%87/image-20220615144537260.png" class=""><p>è¿è¡Œç»“æœè§£æï¼š</p><p><code>Qcache_free_blocks</code>: è¡¨ç¤ºæŸ¥è¯¢ç¼“å­˜ä¸­æµ·æ²¹å¤šå°‘å‰©ä½™çš„blocksï¼Œå¦‚æœè¯¥å€¼æ˜¾ç¤ºè¾ƒå¤§ï¼Œåˆ™è¯´æ˜æŸ¥è¯¢ç¼“å­˜ä¸­çš„<code>å†…éƒ¨ç¢ç‰‡</code>è¿‡å¤šäº†ï¼Œå¯èƒ½åœ¨ä¸€å®šçš„æ—¶é—´è¿›è¡Œæ•´ç†ã€‚</p><p><code>Qcache_free_memory</code>: æŸ¥è¯¢ç¼“å­˜çš„å†…å­˜å¤§å°ï¼Œé€šè¿‡è¿™ä¸ªå‚æ•°å¯ä»¥å¾ˆæ¸…æ™°çš„çŸ¥é“å½“å‰ç³»ç»Ÿçš„æŸ¥è¯¢å†…å­˜æ˜¯å¦å¤Ÿç”¨ï¼ŒDBAå¯ä»¥æ ¹æ®å®é™…æƒ…å†µåšå‡ºè°ƒæ•´ã€‚</p><p><code>Qcache_hits</code>: è¡¨ç¤ºæœ‰ <code>å¤šå°‘æ¬¡å‘½ä¸­ç¼“å­˜</code>ã€‚æˆ‘ä»¬ä¸»è¦å¯ä»¥é€šè¿‡è¯¥å€¼æ¥éªŒè¯æˆ‘ä»¬çš„æŸ¥è¯¢ç¼“å­˜çš„æ•ˆæœã€‚æ•°å­—è¶Šå¤§ï¼Œç¼“å­˜æ•ˆæœè¶Šç†æƒ³ã€‚</p><p><code>Qcache_inserts</code>: è¡¨ç¤º<code>å¤šå°‘æ¬¡æœªå‘½ä¸­ç„¶åæ’å…¥</code>ï¼Œæ„æ€æ˜¯æ–°æ¥çš„SQLè¯·æ±‚åœ¨ç¼“å­˜ä¸­æœªæ‰¾åˆ°ï¼Œä¸å¾—ä¸æ‰§è¡ŒæŸ¥è¯¢å¤„ç†ï¼Œæ‰§è¡ŒæŸ¥è¯¢å¤„ç†åæŠŠç»“æœinsertåˆ°æŸ¥è¯¢ç¼“å­˜ä¸­ã€‚è¿™æ ·çš„æƒ…å†µçš„æ¬¡æ•°è¶Šå¤šï¼Œè¡¨ç¤ºæŸ¥è¯¢ç¼“å­˜åº”ç”¨åˆ°çš„æ¯”è¾ƒå°‘ï¼Œæ•ˆæœä¹Ÿå°±ä¸ç†æƒ³ã€‚å½“ç„¶ç³»ç»Ÿåˆšå¯åŠ¨åï¼ŒæŸ¥è¯¢ç¼“å­˜æ˜¯ç©ºçš„ï¼Œè¿™ä¹Ÿæ­£å¸¸ã€‚</p><p><code>Qcache_lowmem_prunes</code>: è¯¥å‚æ•°è®°å½•æœ‰<code>å¤šå°‘æ¡æŸ¥è¯¢å› ä¸ºå†…å­˜ä¸è¶³è€Œè¢«ç§»é™¤</code>å‡ºæŸ¥è¯¢ç¼“å­˜ã€‚é€šè¿‡è¿™ä¸ªå€¼ï¼Œç”¨æˆ·å¯ä»¥é€‚å½“çš„è°ƒæ•´ç¼“å­˜å¤§å°ã€‚</p><p><code>Qcache_not_cached</code>: è¡¨ç¤ºå› ä¸ºquery_cache_typeçš„è®¾ç½®è€Œæ²¡æœ‰è¢«ç¼“å­˜çš„æŸ¥è¯¢æ•°é‡ã€‚</p><p><code>Qcache_queries_in_cache</code>: å½“å‰ç¼“å­˜ä¸­<code>ç¼“å­˜çš„æŸ¥è¯¢æ•°é‡</code>ã€‚</p><p><code>Qcache_total_blocks</code>: å½“å‰ç¼“å­˜çš„blockæ•°é‡ã€‚</p><ol start="2"><li><strong>è§£æå™¨</strong>ï¼šåœ¨è§£æå™¨ä¸­å¯¹ SQL è¯­å¥è¿›è¡Œè¯­æ³•åˆ†æã€è¯­ä¹‰åˆ†æã€‚</li></ol><img src="/2023/03/03/01-MySQL%E6%9E%B6%E6%9E%84%E7%AF%87/image-20220615142301226.png" class=""><p>å¦‚æœæ²¡æœ‰å‘½ä¸­æŸ¥è¯¢ç¼“å­˜ï¼Œå°±è¦å¼€å§‹çœŸæ­£æ‰§è¡Œè¯­å¥äº†ã€‚é¦–å…ˆï¼ŒMySQLéœ€è¦çŸ¥é“ä½ è¦åšä»€ä¹ˆï¼Œå› æ­¤éœ€è¦å¯¹SQLè¯­å¥åšè§£æã€‚SQLè¯­å¥çš„åˆ†æåˆ†ä¸ºè¯æ³•åˆ†æä¸è¯­æ³•åˆ†æã€‚</p><p>åˆ†æå™¨å…ˆåšâ€œ <code>è¯æ³•åˆ†æ</code> â€ã€‚ä½ è¾“å…¥çš„æ˜¯ç”±å¤šä¸ªå­—ç¬¦ä¸²å’Œç©ºæ ¼ç»„æˆçš„ä¸€æ¡ SQL è¯­å¥ï¼ŒMySQL éœ€è¦è¯†åˆ«å‡ºé‡Œé¢ çš„å­—ç¬¦ä¸²åˆ†åˆ«æ˜¯ä»€ä¹ˆï¼Œä»£è¡¨ä»€ä¹ˆã€‚ </p><p>MySQL ä»ä½ è¾“å…¥çš„â€selectâ€è¿™ä¸ªå…³é”®å­—è¯†åˆ«å‡ºæ¥ï¼Œè¿™æ˜¯ä¸€ä¸ªæŸ¥è¯¢è¯­ å¥ã€‚å®ƒä¹Ÿè¦æŠŠå­—ç¬¦ä¸²â€œTâ€è¯†åˆ«æˆâ€œè¡¨å Tâ€ï¼ŒæŠŠå­—ç¬¦ä¸²â€œIDâ€è¯†åˆ«æˆâ€œåˆ— IDâ€ã€‚</p><p>æ¥ç€ï¼Œè¦åšâ€œ <code>è¯­æ³•åˆ†æ</code> â€ã€‚æ ¹æ®è¯æ³•åˆ†æçš„ç»“æœï¼Œè¯­æ³•åˆ†æå™¨ï¼ˆæ¯”å¦‚ï¼šBisonï¼‰ä¼šæ ¹æ®è¯­æ³•è§„åˆ™ï¼Œåˆ¤æ–­ä½ è¾“ å…¥çš„è¿™ä¸ª SQL è¯­å¥æ˜¯å¦ <code>æ»¡è¶³ MySQL è¯­æ³•</code> ã€‚</p><p>select department_id,job_id, avg(salary) from employees group by department_id; </p><p>å¦‚æœSQLè¯­å¥æ­£ç¡®ï¼Œåˆ™ä¼šç”Ÿæˆä¸€ä¸ªè¿™æ ·çš„è¯­æ³•æ ‘ï¼š</p><img src="/2023/03/03/01-MySQL%E6%9E%B6%E6%9E%84%E7%AF%87/image-20220615162031427.png" class=""><p>ä¸‹å›¾æ˜¯SQLåˆ†è¯åˆ†æçš„è¿‡ç¨‹æ­¥éª¤:</p><img src="/2023/03/03/01-MySQL%E6%9E%B6%E6%9E%84%E7%AF%87/image-20220615163338495.png" class=""><p>è‡³æ­¤è§£æå™¨çš„å·¥ä½œä»»åŠ¡ä¹ŸåŸºæœ¬åœ†æ»¡äº†ã€‚</p><ol start="3"><li><p><strong>ä¼˜åŒ–å™¨</strong>ï¼šåœ¨ä¼˜åŒ–å™¨ä¸­ä¼šç¡®å®š SQL è¯­å¥çš„æ‰§è¡Œè·¯å¾„ï¼Œæ¯”å¦‚æ˜¯æ ¹æ® <code>å…¨è¡¨æ£€ç´¢</code> ï¼Œè¿˜æ˜¯æ ¹æ® <code>ç´¢å¼•æ£€ç´¢</code> ç­‰ã€‚ </p><p>ç»è¿‡è§£é‡Šå™¨ï¼ŒMySQLå°±çŸ¥é“ä½ è¦åšä»€ä¹ˆäº†ã€‚åœ¨å¼€å§‹æ‰§è¡Œä¹‹å‰ï¼Œè¿˜è¦å…ˆç»è¿‡ä¼˜åŒ–å™¨çš„å¤„ç†ã€‚<strong>ä¸€æ¡æŸ¥è¯¢å¯ä»¥æœ‰å¾ˆå¤šç§æ‰§è¡Œæ–¹å¼ï¼Œæœ€åéƒ½è¿”å›ç›¸åŒçš„ç»“æœã€‚ä¼˜åŒ–å™¨çš„ä½œç”¨å°±æ˜¯æ‰¾åˆ°è¿™å…¶ä¸­æœ€å¥½çš„æ‰§è¡Œè®¡åˆ’</strong>ã€‚</p><p>æ¯”å¦‚ï¼šä¼˜åŒ–å™¨æ˜¯åœ¨è¡¨é‡Œé¢æœ‰å¤šä¸ªç´¢å¼•çš„æ—¶å€™ï¼Œå†³å®šä½¿ç”¨å“ªä¸ªç´¢å¼•ï¼›æˆ–è€…åœ¨ä¸€ä¸ªè¯­å¥æœ‰å¤šè¡¨å…³è” (join) çš„æ—¶å€™ï¼Œå†³å®šå„ä¸ªè¡¨çš„è¿æ¥é¡ºåºï¼Œè¿˜æœ‰è¡¨è¾¾å¼ç®€åŒ–ã€å­æŸ¥è¯¢è½¬ä¸ºè¿æ¥ã€å¤–è¿æ¥è½¬ä¸ºå†…è¿æ¥ç­‰ã€‚</p><p>ä¸¾ä¾‹ï¼šå¦‚ä¸‹è¯­å¥æ˜¯æ‰§è¡Œä¸¤ä¸ªè¡¨çš„ joinï¼š</p></li></ol><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">select * from test1 join test2 using(ID)</span><br><span class="line">where test1.name=&#x27;zhangwei&#x27; and test2.name=&#x27;mysqlé«˜çº§è¯¾ç¨‹&#x27;;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">æ–¹æ¡ˆ1ï¼šå¯ä»¥å…ˆä»è¡¨ test1 é‡Œé¢å–å‡º name=&#x27;zhangwei&#x27;çš„è®°å½•çš„ ID å€¼ï¼Œå†æ ¹æ® ID å€¼å…³è”åˆ°è¡¨ test2ï¼Œå†åˆ¤</span><br><span class="line">æ–­ test2 é‡Œé¢ nameçš„å€¼æ˜¯å¦ç­‰äº &#x27;mysqlé«˜çº§è¯¾ç¨‹&#x27;ã€‚</span><br><span class="line"></span><br><span class="line">æ–¹æ¡ˆ2ï¼šå¯ä»¥å…ˆä»è¡¨ test2 é‡Œé¢å–å‡º name=&#x27;mysqlé«˜çº§è¯¾ç¨‹&#x27; çš„è®°å½•çš„ ID å€¼ï¼Œå†æ ¹æ® ID å€¼å…³è”åˆ° test1ï¼Œ</span><br><span class="line">å†åˆ¤æ–­ test1 é‡Œé¢ nameçš„å€¼æ˜¯å¦ç­‰äº zhangweiã€‚</span><br><span class="line"></span><br><span class="line">è¿™ä¸¤ç§æ‰§è¡Œæ–¹æ³•çš„é€»è¾‘ç»“æœæ˜¯ä¸€æ ·çš„ï¼Œä½†æ˜¯æ‰§è¡Œçš„æ•ˆç‡ä¼šæœ‰ä¸åŒï¼Œè€Œä¼˜åŒ–å™¨çš„ä½œç”¨å°±æ˜¯å†³å®šé€‰æ‹©ä½¿ç”¨å“ªä¸€ä¸ªæ–¹æ¡ˆã€‚ä¼˜åŒ–</span><br><span class="line">å™¨é˜¶æ®µå®Œæˆåï¼Œè¿™ä¸ªè¯­å¥çš„æ‰§è¡Œæ–¹æ¡ˆå°±ç¡®å®šä¸‹æ¥äº†ï¼Œç„¶åè¿›å…¥æ‰§è¡Œå™¨é˜¶æ®µã€‚</span><br><span class="line">å¦‚æœä½ è¿˜æœ‰ä¸€äº›ç–‘é—®ï¼Œæ¯”å¦‚ä¼˜åŒ–å™¨æ˜¯æ€ä¹ˆé€‰æ‹©ç´¢å¼•çš„ï¼Œæœ‰æ²¡æœ‰å¯èƒ½é€‰æ‹©é”™ç­‰ã€‚åé¢è®²åˆ°ç´¢å¼•æˆ‘ä»¬å†è°ˆã€‚</span><br></pre></td></tr></table></figure><p>åœ¨æŸ¥è¯¢ä¼˜åŒ–å™¨ä¸­ï¼Œå¯ä»¥åˆ†ä¸º <code>é€»è¾‘æŸ¥è¯¢</code> ä¼˜åŒ–é˜¶æ®µå’Œ <code>ç‰©ç†æŸ¥è¯¢</code> ä¼˜åŒ–é˜¶æ®µã€‚</p><p>é€»è¾‘æŸ¥è¯¢ä¼˜åŒ–å°±æ˜¯é€šè¿‡æ”¹å˜SQLè¯­å¥çš„å†…å®¹æ¥ä½¿å¾—SQLæŸ¥è¯¢æ›´é«˜æ•ˆï¼ŒåŒæ—¶ä¸ºç‰©ç†æŸ¥è¯¢ä¼˜åŒ–æä¾›æ›´å¤šçš„å€™é€‰æ‰§è¡Œè®¡åˆ’ã€‚é€šå¸¸é‡‡ç”¨çš„æ–¹å¼æ˜¯å¯¹SQLè¯­å¥è¿›è¡Œ<code>ç­‰ä»·å˜æ¢</code>ï¼Œå¯¹æŸ¥è¯¢è¿›è¡Œ<code>é‡å†™</code>ï¼Œè€ŒæŸ¥è¯¢é‡å†™çš„æ•°å­¦åŸºç¡€å°±æ˜¯å…³ç³»ä»£æ•°ã€‚å¯¹æ¡ä»¶è¡¨è¾¾å¼è¿›è¡Œç­‰ä»·è°“è¯é‡å†™ã€æ¡ä»¶ç®€åŒ–ï¼Œå¯¹è§†å›¾è¿›è¡Œé‡å†™ï¼Œå¯¹å­æŸ¥è¯¢è¿›è¡Œä¼˜åŒ–ï¼Œå¯¹è¿æ¥è¯­ä¹‰è¿›è¡Œäº†å¤–è¿æ¥æ¶ˆé™¤ã€åµŒå¥—è¿æ¥æ¶ˆé™¤ç­‰ã€‚</p><p>ç‰©ç†æŸ¥è¯¢ä¼˜åŒ–æ˜¯åŸºäºå…³ç³»ä»£æ•°è¿›è¡Œçš„æŸ¥è¯¢é‡å†™ï¼Œè€Œå…³ç³»ä»£æ•°çš„æ¯ä¸€æ­¥éƒ½å¯¹åº”ç€ç‰©ç†è®¡ç®—ï¼Œè¿™äº›ç‰©ç†è®¡ç®—å¾€å¾€å­˜åœ¨å¤šç§ç®—æ³•ï¼Œå› æ­¤éœ€è¦è®¡ç®—å„ç§ç‰©ç†è·¯å¾„çš„ä»£ä»·ï¼Œä»ä¸­é€‰æ‹©ä»£ä»·æœ€å°çš„ä½œä¸ºæ‰§è¡Œè®¡åˆ’ã€‚åœ¨è¿™ä¸ªé˜¶æ®µé‡Œï¼Œå¯¹äºå•è¡¨å’Œå¤šè¡¨è¿æ¥çš„æ“ä½œï¼Œéœ€è¦é«˜æ•ˆåœ°<code>ä½¿ç”¨ç´¢å¼•</code>ï¼Œæå‡æŸ¥è¯¢æ•ˆç‡ã€‚</p><ol start="4"><li><strong>æ‰§è¡Œå™¨</strong>ï¼š</li></ol><p>æˆªæ­¢åˆ°ç°åœ¨ï¼Œè¿˜æ²¡æœ‰çœŸæ­£å»è¯»å†™çœŸå®çš„è¡¨ï¼Œä»…ä»…åªæ˜¯äº§å‡ºäº†ä¸€ä¸ªæ‰§è¡Œè®¡åˆ’ã€‚äºæ˜¯å°±è¿›å…¥äº†æ‰§è¡Œå™¨é˜¶æ®µ ã€‚</p><img src="/2023/03/03/01-MySQL%E6%9E%B6%E6%9E%84%E7%AF%87/image-20220615162613806.png" class=""><p>åœ¨æ‰§è¡Œä¹‹å‰éœ€è¦åˆ¤æ–­è¯¥ç”¨æˆ·æ˜¯å¦ <code>å…·å¤‡æƒé™</code> ã€‚å¦‚æœæ²¡æœ‰ï¼Œå°±ä¼šè¿”å›æƒé™é”™è¯¯ã€‚å¦‚æœå…·å¤‡æƒé™ï¼Œå°±æ‰§è¡Œ SQL æŸ¥è¯¢å¹¶è¿”å›ç»“æœã€‚åœ¨ MySQL8.0 ä»¥ä¸‹çš„ç‰ˆæœ¬ï¼Œå¦‚æœè®¾ç½®äº†æŸ¥è¯¢ç¼“å­˜ï¼Œè¿™æ—¶ä¼šå°†æŸ¥è¯¢ç»“æœè¿›è¡Œç¼“å­˜ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">select * from test where id=1;</span><br></pre></td></tr></table></figure><p>æ¯”å¦‚ï¼šè¡¨ test ä¸­ï¼ŒID å­—æ®µæ²¡æœ‰ç´¢å¼•ï¼Œé‚£ä¹ˆæ‰§è¡Œå™¨çš„æ‰§è¡Œæµç¨‹æ˜¯è¿™æ ·çš„ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">è°ƒç”¨ InnoDB å¼•æ“æ¥å£å–è¿™ä¸ªè¡¨çš„ç¬¬ä¸€è¡Œï¼Œåˆ¤æ–­ ID å€¼æ˜¯ä¸æ˜¯1ï¼Œå¦‚æœä¸æ˜¯åˆ™è·³è¿‡ï¼Œå¦‚æœæ˜¯åˆ™å°†è¿™è¡Œå­˜åœ¨ç»“æœé›†ä¸­ï¼›</span><br><span class="line">è°ƒç”¨å¼•æ“æ¥å£å–â€œä¸‹ä¸€è¡Œâ€ï¼Œé‡å¤ç›¸åŒçš„åˆ¤æ–­é€»è¾‘ï¼Œç›´åˆ°å–åˆ°è¿™ä¸ªè¡¨çš„æœ€åä¸€è¡Œã€‚</span><br><span class="line">æ‰§è¡Œå™¨å°†ä¸Šè¿°éå†è¿‡ç¨‹ä¸­æ‰€æœ‰æ»¡è¶³æ¡ä»¶çš„è¡Œç»„æˆçš„è®°å½•é›†ä½œä¸ºç»“æœé›†è¿”å›ç»™å®¢æˆ·ç«¯ã€‚</span><br></pre></td></tr></table></figure><p>è‡³æ­¤ï¼Œè¿™ä¸ªè¯­å¥å°±æ‰§è¡Œå®Œæˆäº†ã€‚å¯¹äºæœ‰ç´¢å¼•çš„è¡¨ï¼Œæ‰§è¡Œçš„é€»è¾‘ä¹Ÿå·®ä¸å¤šã€‚</p><p>SQL è¯­å¥åœ¨ MySQL ä¸­çš„æµç¨‹æ˜¯ï¼š <code>SQLè¯­å¥</code>â†’<code>æŸ¥è¯¢ç¼“å­˜</code>â†’<code>è§£æå™¨</code>â†’<code>ä¼˜åŒ–å™¨</code>â†’<code>æ‰§è¡Œå™¨</code> ã€‚</p><img src="/2023/03/03/01-MySQL%E6%9E%B6%E6%9E%84%E7%AF%87/image-20220615164722975.png" class=""><h3 id="2-2-MySQL8ä¸­SQLæ‰§è¡ŒåŸç†"><a href="#2-2-MySQL8ä¸­SQLæ‰§è¡ŒåŸç†" class="headerlink" title="2.2 MySQL8ä¸­SQLæ‰§è¡ŒåŸç†"></a>2.2 MySQL8ä¸­SQLæ‰§è¡ŒåŸç†</h3><h4 id="1-ç¡®è®¤profilingæ˜¯å¦å¼€å¯"><a href="#1-ç¡®è®¤profilingæ˜¯å¦å¼€å¯" class="headerlink" title="1) ç¡®è®¤profilingæ˜¯å¦å¼€å¯"></a>1) ç¡®è®¤profilingæ˜¯å¦å¼€å¯</h4><p>äº†è§£æŸ¥è¯¢è¯­å¥åº•å±‚æ‰§è¡Œçš„è¿‡ç¨‹ï¼š<code>select @profiling</code> æˆ–è€… <code>show variables like &#39;%profiling&#39;</code> æŸ¥çœ‹æ˜¯å¦å¼€å¯è®¡åˆ’ã€‚å¼€å¯å®ƒå¯ä»¥è®©MySQLæ”¶é›†åœ¨SQL</p><p>æ‰§è¡Œæ—¶æ‰€ä½¿ç”¨çš„èµ„æºæƒ…å†µï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select @@profiling;</span><br><span class="line">mysql&gt; show variables like &#x27;profiling&#x27;;</span><br></pre></td></tr></table></figure><p>profiling&#x3D;0 ä»£è¡¨å…³é—­ï¼Œæˆ‘ä»¬éœ€è¦æŠŠ profiling æ‰“å¼€ï¼Œå³è®¾ç½®ä¸º 1ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; set profiling=1;</span><br></pre></td></tr></table></figure><h4 id="2-å¤šæ¬¡æ‰§è¡Œç›¸åŒSQLæŸ¥è¯¢"><a href="#2-å¤šæ¬¡æ‰§è¡Œç›¸åŒSQLæŸ¥è¯¢" class="headerlink" title="2) å¤šæ¬¡æ‰§è¡Œç›¸åŒSQLæŸ¥è¯¢"></a>2) å¤šæ¬¡æ‰§è¡Œç›¸åŒSQLæŸ¥è¯¢</h4><p>ç„¶åæˆ‘ä»¬æ‰§è¡Œä¸€ä¸ª SQL æŸ¥è¯¢ï¼ˆä½ å¯ä»¥æ‰§è¡Œä»»ä½•ä¸€ä¸ª SQL æŸ¥è¯¢ï¼‰ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from employees;</span><br></pre></td></tr></table></figure><h4 id="3-æŸ¥çœ‹profiles"><a href="#3-æŸ¥çœ‹profiles" class="headerlink" title="3) æŸ¥çœ‹profiles"></a>3) æŸ¥çœ‹profiles</h4><p>æŸ¥çœ‹å½“å‰ä¼šè¯æ‰€äº§ç”Ÿçš„æ‰€æœ‰ profilesï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show profiles; # æ˜¾ç¤ºæœ€è¿‘çš„å‡ æ¬¡æŸ¥è¯¢</span><br></pre></td></tr></table></figure><h4 id="4-æŸ¥çœ‹profile"><a href="#4-æŸ¥çœ‹profile" class="headerlink" title="4) æŸ¥çœ‹profile"></a>4) æŸ¥çœ‹profile</h4><p>æ˜¾ç¤ºæ‰§è¡Œè®¡åˆ’ï¼ŒæŸ¥çœ‹ç¨‹åºçš„æ‰§è¡Œæ­¥éª¤ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show profile;</span><br></pre></td></tr></table></figure><img src="/2023/03/03/01-MySQL%E6%9E%B6%E6%9E%84%E7%AF%87/image-20220615172149919.png" class=""><p>å½“ç„¶ä½ ä¹Ÿå¯ä»¥æŸ¥è¯¢æŒ‡å®šçš„ Query IDï¼Œæ¯”å¦‚ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show profile for query 7;</span><br></pre></td></tr></table></figure><p>æŸ¥è¯¢ SQL çš„æ‰§è¡Œæ—¶é—´ç»“æœå’Œä¸Šé¢æ˜¯ä¸€æ ·çš„ã€‚</p><p>æ­¤å¤–ï¼Œè¿˜å¯ä»¥æŸ¥è¯¢æ›´ä¸°å¯Œçš„å†…å®¹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show profile cpu,block io for query 6;</span><br></pre></td></tr></table></figure><img src="/2023/03/03/01-MySQL%E6%9E%B6%E6%9E%84%E7%AF%87/image-20220615172409967.png" class=""><p>ç»§ç»­ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show profile cpu,block io for query 7;</span><br></pre></td></tr></table></figure><img src="/2023/03/03/01-MySQL%E6%9E%B6%E6%9E%84%E7%AF%87/image-20220615172438338.png" class=""><p>1ã€é™¤äº†æŸ¥çœ‹cpuã€ioé˜»å¡ç­‰å‚æ•°æƒ…å†µï¼Œè¿˜å¯ä»¥æŸ¥è¯¢ä¸‹åˆ—å‚æ•°çš„åˆ©ç”¨æƒ…å†µã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Syntax:</span><br><span class="line">SHOW PROFILE [type [, type] ... ]</span><br><span class="line">[FOR QUERY n]</span><br><span class="line">[LIMIT row_count [OFFSET offset]]</span><br><span class="line"></span><br><span class="line">type: &#123;</span><br><span class="line">| ALL -- æ˜¾ç¤ºæ‰€æœ‰å‚æ•°çš„å¼€é”€ä¿¡æ¯</span><br><span class="line">| BLOCK IO -- æ˜¾ç¤ºIOçš„ç›¸å…³å¼€é”€</span><br><span class="line">| CONTEXT SWITCHES -- ä¸Šä¸‹æ–‡åˆ‡æ¢ç›¸å…³å¼€é”€</span><br><span class="line">| CPU -- æ˜¾ç¤ºCPUç›¸å…³å¼€é”€ä¿¡æ¯</span><br><span class="line">| IPC -- æ˜¾ç¤ºå‘é€å’Œæ¥æ”¶ç›¸å…³å¼€é”€ä¿¡æ¯</span><br><span class="line">| MEMORY -- æ˜¾ç¤ºå†…å­˜ç›¸å…³å¼€é”€ä¿¡æ¯</span><br><span class="line">| PAGE FAULTS -- æ˜¾ç¤ºé¡µé¢é”™è¯¯ç›¸å…³å¼€é”€ä¿¡æ¯</span><br><span class="line">| SOURCE -- æ˜¾ç¤ºå’ŒSource_function,Source_file,Source_line ç›¸å…³çš„å¼€é”€ä¿¡æ¯</span><br><span class="line">| SWAPS -- æ˜¾ç¤ºäº¤æ¢æ¬¡æ•°ç›¸å…³çš„å¼€é”€ä¿¡æ¯</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2ã€å‘ç°ä¸¤æ¬¡æŸ¥è¯¢å½“å‰æƒ…å†µéƒ½ä¸€è‡´ï¼Œè¯´æ˜æ²¡æœ‰ç¼“å­˜ã€‚</p><p><code>åœ¨ 8.0 ç‰ˆæœ¬ä¹‹åï¼ŒMySQL ä¸å†æ”¯æŒç¼“å­˜çš„æŸ¥è¯¢</code>ã€‚ä¸€æ—¦æ•°æ®è¡¨æœ‰æ›´æ–°ï¼Œç¼“å­˜éƒ½å°†æ¸…ç©ºï¼Œå› æ­¤åªæœ‰æ•°æ®è¡¨æ˜¯é™æ€çš„æ—¶å€™ï¼Œæˆ–è€…æ•°æ®è¡¨å¾ˆå°‘å‘ç”Ÿå˜åŒ–æ—¶ï¼Œä½¿ç”¨ç¼“å­˜æŸ¥è¯¢æ‰æœ‰ä»·å€¼ï¼Œå¦åˆ™å¦‚æœæ•°æ®è¡¨ç»å¸¸æ›´æ–°ï¼Œåè€Œå¢åŠ äº† SQL çš„æŸ¥è¯¢æ—¶é—´ã€‚</p><h3 id="2-3-MySQL5-7ä¸­SQLæ‰§è¡ŒåŸç†"><a href="#2-3-MySQL5-7ä¸­SQLæ‰§è¡ŒåŸç†" class="headerlink" title="2.3 MySQL5.7ä¸­SQLæ‰§è¡ŒåŸç†"></a>2.3 MySQL5.7ä¸­SQLæ‰§è¡ŒåŸç†</h3><p>ä¸Šè¿°æ“ä½œåœ¨MySQL5.7ä¸­æµ‹è¯•ï¼Œå‘ç°å‰åä¸¤æ¬¡ç›¸åŒçš„sqlè¯­å¥ï¼Œæ‰§è¡Œçš„æŸ¥è¯¢è¿‡ç¨‹ä»ç„¶æ˜¯ç›¸åŒçš„ã€‚ä¸æ˜¯ä¼šä½¿ç”¨ ç¼“å­˜å—ï¼Ÿè¿™é‡Œæˆ‘ä»¬éœ€è¦ æ˜¾å¼å¼€å¯æŸ¥è¯¢ç¼“å­˜æ¨¡å¼ ã€‚åœ¨MySQL5.7ä¸­å¦‚ä¸‹è®¾ç½®ï¼š</p><h4 id="1-é…ç½®æ–‡ä»¶ä¸­å¼€å¯æŸ¥è¯¢ç¼“å­˜"><a href="#1-é…ç½®æ–‡ä»¶ä¸­å¼€å¯æŸ¥è¯¢ç¼“å­˜" class="headerlink" title="1) é…ç½®æ–‡ä»¶ä¸­å¼€å¯æŸ¥è¯¢ç¼“å­˜"></a>1) é…ç½®æ–‡ä»¶ä¸­å¼€å¯æŸ¥è¯¢ç¼“å­˜</h4><p>åœ¨ &#x2F;etc&#x2F;my.cnf ä¸­æ–°å¢ä¸€è¡Œï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">query_cache_type=1</span><br></pre></td></tr></table></figure><h4 id="2-é‡å¯mysqlæœåŠ¡"><a href="#2-é‡å¯mysqlæœåŠ¡" class="headerlink" title="2) é‡å¯mysqlæœåŠ¡"></a>2) é‡å¯mysqlæœåŠ¡</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl restart mysqld</span><br></pre></td></tr></table></figure><h4 id="3-å¼€å¯æŸ¥è¯¢æ‰§è¡Œè®¡åˆ’"><a href="#3-å¼€å¯æŸ¥è¯¢æ‰§è¡Œè®¡åˆ’" class="headerlink" title="3) å¼€å¯æŸ¥è¯¢æ‰§è¡Œè®¡åˆ’"></a>3) å¼€å¯æŸ¥è¯¢æ‰§è¡Œè®¡åˆ’</h4><p>ç”±äºé‡å¯è¿‡æœåŠ¡ï¼Œéœ€è¦é‡æ–°æ‰§è¡Œå¦‚ä¸‹æŒ‡ä»¤ï¼Œå¼€å¯profilingã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; set profiling=1;</span><br></pre></td></tr></table></figure><h4 id="4-æ‰§è¡Œè¯­å¥ä¸¤æ¬¡ï¼š"><a href="#4-æ‰§è¡Œè¯­å¥ä¸¤æ¬¡ï¼š" class="headerlink" title="4) æ‰§è¡Œè¯­å¥ä¸¤æ¬¡ï¼š"></a>4) æ‰§è¡Œè¯­å¥ä¸¤æ¬¡ï¼š</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from locations;</span><br></pre></td></tr></table></figure><h4 id="5-æŸ¥çœ‹profiles"><a href="#5-æŸ¥çœ‹profiles" class="headerlink" title="5) æŸ¥çœ‹profiles"></a>5) æŸ¥çœ‹profiles</h4><img src="/2023/03/03/01-MySQL%E6%9E%B6%E6%9E%84%E7%AF%87/image-20220615173727345.png" class=""><h4 id="6-æŸ¥çœ‹profile"><a href="#6-æŸ¥çœ‹profile" class="headerlink" title="6) æŸ¥çœ‹profile"></a>6) æŸ¥çœ‹profile</h4><p>æ˜¾ç¤ºæ‰§è¡Œè®¡åˆ’ï¼ŒæŸ¥çœ‹ç¨‹åºçš„æ‰§è¡Œæ­¥éª¤ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show profile for query 1;</span><br></pre></td></tr></table></figure><img src="/2023/03/03/01-MySQL%E6%9E%B6%E6%9E%84%E7%AF%87/image-20220615173803835.png" class=""><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show profile for query 2;</span><br></pre></td></tr></table></figure><img src="/2023/03/03/01-MySQL%E6%9E%B6%E6%9E%84%E7%AF%87/image-20220615173822079.png" class=""><p>ç»“è®ºä¸è¨€è€Œå–»ã€‚æ‰§è¡Œç¼–å·2æ—¶ï¼Œæ¯”æ‰§è¡Œç¼–å·1æ—¶å°‘äº†å¾ˆå¤šä¿¡æ¯ï¼Œä»æˆªå›¾ä¸­å¯ä»¥çœ‹å‡ºæŸ¥è¯¢è¯­å¥ç›´æ¥ä»ç¼“å­˜ä¸­ è·å–æ•°æ®ã€‚</p><h3 id="2-4-SQLè¯­æ³•é¡ºåº"><a href="#2-4-SQLè¯­æ³•é¡ºåº" class="headerlink" title="2.4 SQLè¯­æ³•é¡ºåº"></a>2.4 SQLè¯­æ³•é¡ºåº</h3><p>éšç€Mysqlç‰ˆæœ¬çš„æ›´æ–°æ¢ä»£ï¼Œå…¶ä¼˜åŒ–å™¨ä¹Ÿåœ¨ä¸æ–­çš„å‡çº§ï¼Œä¼˜åŒ–å™¨ä¼šåˆ†æä¸åŒæ‰§è¡Œé¡ºåºäº§ç”Ÿçš„æ€§èƒ½æ¶ˆè€—ä¸åŒ è€ŒåŠ¨æ€è°ƒæ•´æ‰§è¡Œé¡ºåºã€‚</p><h2 id="3-æ•°æ®åº“ç¼“å†²æ± ï¼ˆbuffer-poolï¼‰"><a href="#3-æ•°æ®åº“ç¼“å†²æ± ï¼ˆbuffer-poolï¼‰" class="headerlink" title="3. æ•°æ®åº“ç¼“å†²æ± ï¼ˆbuffer poolï¼‰"></a>3. æ•°æ®åº“ç¼“å†²æ± ï¼ˆbuffer poolï¼‰</h2><p><code>InnoDB</code> å­˜å‚¨å¼•æ“æ˜¯ä»¥é¡µä¸ºå•ä½æ¥ç®¡ç†å­˜å‚¨ç©ºé—´çš„ï¼Œæˆ‘ä»¬è¿›è¡Œçš„å¢åˆ æ”¹æŸ¥æ“ä½œå…¶å®æœ¬è´¨ä¸Šéƒ½æ˜¯åœ¨è®¿é—®é¡µé¢ï¼ˆåŒ…æ‹¬è¯»é¡µé¢ã€å†™é¡µé¢ã€åˆ›å»ºæ–°é¡µé¢ç­‰æ“ä½œï¼‰ã€‚è€Œç£ç›˜ I&#x2F;O éœ€è¦æ¶ˆè€—çš„æ—¶é—´å¾ˆå¤šï¼Œè€Œåœ¨å†…å­˜ä¸­è¿›è¡Œæ“ä½œï¼Œæ•ˆç‡åˆ™ä¼šé«˜å¾ˆå¤šï¼Œä¸ºäº†èƒ½è®©æ•°æ®è¡¨æˆ–è€…ç´¢å¼•ä¸­çš„æ•°æ®éšæ—¶è¢«æˆ‘ä»¬æ‰€ç”¨ï¼ŒDBMS ä¼šç”³è¯·<code>å ç”¨å†…å­˜æ¥ä½œä¸ºæ•°æ®ç¼“å†²æ± </code> ï¼Œåœ¨çœŸæ­£è®¿é—®é¡µé¢ä¹‹å‰ï¼Œéœ€è¦æŠŠåœ¨ç£ç›˜ä¸Šçš„é¡µç¼“å­˜åˆ°å†…å­˜ä¸­çš„ Buffer Pool ä¹‹åæ‰å¯ä»¥è®¿é—®ã€‚</p><p>è¿™æ ·åšçš„å¥½å¤„æ˜¯å¯ä»¥è®©ç£ç›˜æ´»åŠ¨æœ€å°åŒ–ï¼Œä»è€Œ <code>å‡å°‘ä¸ç£ç›˜ç›´æ¥è¿›è¡Œ I/O çš„æ—¶é—´ </code>ã€‚è¦çŸ¥é“ï¼Œè¿™ç§ç­–ç•¥å¯¹æå‡ SQL è¯­å¥çš„æŸ¥è¯¢æ€§èƒ½æ¥è¯´è‡³å…³é‡è¦ã€‚å¦‚æœç´¢å¼•çš„æ•°æ®åœ¨ç¼“å†²æ± é‡Œï¼Œé‚£ä¹ˆè®¿é—®çš„æˆæœ¬å°±ä¼šé™ä½å¾ˆå¤šã€‚</p><h3 id="3-1-ç¼“å†²æ± -vs-æŸ¥è¯¢ç¼“å­˜"><a href="#3-1-ç¼“å†²æ± -vs-æŸ¥è¯¢ç¼“å­˜" class="headerlink" title="3.1 ç¼“å†²æ±  vs æŸ¥è¯¢ç¼“å­˜"></a>3.1 ç¼“å†²æ±  vs æŸ¥è¯¢ç¼“å­˜</h3><p>ç¼“å†²æ± å’ŒæŸ¥è¯¢ç¼“å­˜æ˜¯ä¸€ä¸ªä¸œè¥¿å—ï¼Ÿä¸æ˜¯ã€‚</p><h4 id="1-ç¼“å†²æ± ï¼ˆBuffer-Poolï¼‰"><a href="#1-ç¼“å†²æ± ï¼ˆBuffer-Poolï¼‰" class="headerlink" title="1) ç¼“å†²æ± ï¼ˆBuffer Poolï¼‰"></a>1) ç¼“å†²æ± ï¼ˆBuffer Poolï¼‰</h4><p>é¦–å…ˆæˆ‘ä»¬éœ€è¦äº†è§£åœ¨ InnoDB å­˜å‚¨å¼•æ“ä¸­ï¼Œç¼“å†²æ± éƒ½åŒ…æ‹¬äº†å“ªäº›ã€‚</p><p>åœ¨ InnoDB å­˜å‚¨å¼•æ“ä¸­æœ‰ä¸€éƒ¨åˆ†æ•°æ®ä¼šæ”¾åˆ°å†…å­˜ä¸­ï¼Œç¼“å†²æ± åˆ™å äº†è¿™éƒ¨åˆ†å†…å­˜çš„å¤§éƒ¨åˆ†ï¼Œå®ƒç”¨æ¥å­˜å‚¨å„ç§æ•°æ®çš„ç¼“å­˜ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><img src="/2023/03/03/01-MySQL%E6%9E%B6%E6%9E%84%E7%AF%87/image-20220615175309751.png" class=""><p>ä»å›¾ä¸­ï¼Œä½ èƒ½çœ‹åˆ° InnoDB ç¼“å†²æ± åŒ…æ‹¬äº†æ•°æ®é¡µã€ç´¢å¼•é¡µã€æ’å…¥ç¼“å†²ã€é”ä¿¡æ¯ã€è‡ªé€‚åº” Hash å’Œæ•°æ®å­—å…¸ä¿¡æ¯ç­‰ã€‚</p><p><strong>ç¼“å­˜æ± çš„é‡è¦æ€§ï¼š</strong></p><p><strong>ç¼“å­˜åŸåˆ™ï¼š</strong></p><p>â€œ <code>ä½ç½® * é¢‘æ¬¡</code> â€è¿™ä¸ªåŸåˆ™ï¼Œå¯ä»¥å¸®æˆ‘ä»¬å¯¹ I&#x2F;O è®¿é—®æ•ˆç‡è¿›è¡Œä¼˜åŒ–ã€‚</p><p>é¦–å…ˆï¼Œä½ç½®å†³å®šæ•ˆç‡ï¼Œæä¾›ç¼“å†²æ± å°±æ˜¯ä¸ºäº†åœ¨å†…å­˜ä¸­å¯ä»¥ç›´æ¥è®¿é—®æ•°æ®ã€‚</p><p>å…¶æ¬¡ï¼Œé¢‘æ¬¡å†³å®šä¼˜å…ˆçº§é¡ºåºã€‚å› ä¸ºç¼“å†²æ± çš„å¤§å°æ˜¯æœ‰é™çš„ï¼Œæ¯”å¦‚ç£ç›˜æœ‰ 200Gï¼Œä½†æ˜¯å†…å­˜åªæœ‰ 16Gï¼Œç¼“å†²æ± å¤§å°åªæœ‰ 1Gï¼Œå°±æ— æ³•å°†æ‰€æœ‰æ•°æ®éƒ½åŠ è½½åˆ°ç¼“å†²æ± é‡Œï¼Œè¿™æ—¶å°±æ¶‰åŠåˆ°ä¼˜å…ˆçº§é¡ºåºï¼Œä¼š<code>ä¼˜å…ˆå¯¹ä½¿ç”¨é¢‘æ¬¡é«˜çš„çƒ­æ•°æ®è¿›è¡ŒåŠ è½½ </code>ã€‚</p><p><strong>ç¼“å†²æ± çš„é¢„è¯»ç‰¹æ€§:</strong></p><p>ç¼“å†²æ± çš„ä½œç”¨å°±æ˜¯æå‡ I&#x2F;O æ•ˆç‡ï¼Œè€Œæˆ‘ä»¬è¿›è¡Œè¯»å–æ•°æ®çš„æ—¶å€™å­˜åœ¨ä¸€ä¸ªâ€œå±€éƒ¨æ€§åŸç†â€ï¼Œä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬ä½¿ç”¨äº†ä¸€äº›æ•°æ®ï¼Œ<strong>å¤§æ¦‚ç‡è¿˜ä¼šä½¿ç”¨å®ƒå‘¨å›´çš„ä¸€äº›æ•°æ®</strong>ï¼Œå› æ­¤é‡‡ç”¨â€œé¢„è¯»â€çš„æœºåˆ¶æå‰åŠ è½½ï¼Œå¯ä»¥å‡å°‘æœªæ¥å¯èƒ½çš„ç£ç›˜ I&#x2F;O æ“ä½œã€‚</p><h4 id="2-æŸ¥è¯¢ç¼“å­˜"><a href="#2-æŸ¥è¯¢ç¼“å­˜" class="headerlink" title="2) æŸ¥è¯¢ç¼“å­˜"></a>2) æŸ¥è¯¢ç¼“å­˜</h4><p>é‚£ä¹ˆä»€ä¹ˆæ˜¯æŸ¥è¯¢ç¼“å­˜å‘¢ï¼Ÿ </p><p>æŸ¥è¯¢ç¼“å­˜æ˜¯æå‰æŠŠ æŸ¥è¯¢ç»“æœç¼“å­˜èµ·æ¥ï¼Œè¿™æ ·ä¸‹æ¬¡ä¸éœ€è¦æ‰§è¡Œå°±å¯ä»¥ç›´æ¥æ‹¿åˆ°ç»“æœã€‚éœ€è¦è¯´æ˜çš„æ˜¯ï¼Œåœ¨ MySQL ä¸­çš„æŸ¥è¯¢ç¼“å­˜ï¼Œä¸æ˜¯ç¼“å­˜æŸ¥è¯¢è®¡åˆ’ï¼Œè€Œæ˜¯æŸ¥è¯¢å¯¹åº”çš„ç»“æœã€‚å› ä¸ºå‘½ä¸­æ¡ä»¶è‹›åˆ»ï¼Œè€Œä¸”åªè¦æ•°æ®è¡¨ å‘ç”Ÿå˜åŒ–ï¼ŒæŸ¥è¯¢ç¼“å­˜å°±ä¼šå¤±æ•ˆï¼Œå› æ­¤å‘½ä¸­ç‡ä½ã€‚</p><h3 id="3-2-ç¼“å†²æ± å¦‚ä½•è¯»å–æ•°æ®"><a href="#3-2-ç¼“å†²æ± å¦‚ä½•è¯»å–æ•°æ®" class="headerlink" title="3.2 ç¼“å†²æ± å¦‚ä½•è¯»å–æ•°æ®"></a>3.2 ç¼“å†²æ± å¦‚ä½•è¯»å–æ•°æ®</h3><p>ç¼“å†²æ± ç®¡ç†å™¨ä¼šå°½é‡å°†ç»å¸¸ä½¿ç”¨çš„æ•°æ®ä¿å­˜èµ·æ¥ï¼Œåœ¨æ•°æ®åº“è¿›è¡Œé¡µé¢è¯»æ“ä½œçš„æ—¶å€™ï¼Œé¦–å…ˆä¼šåˆ¤æ–­è¯¥é¡µé¢ æ˜¯å¦åœ¨ç¼“å†²æ± ä¸­ï¼Œå¦‚æœå­˜åœ¨å°±ç›´æ¥è¯»å–ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œå°±ä¼šé€šè¿‡å†…å­˜æˆ–ç£ç›˜å°†é¡µé¢å­˜æ”¾åˆ°ç¼“å†²æ± ä¸­å†è¿›è¡Œè¯»å–ã€‚</p><p>ç¼“å­˜åœ¨æ•°æ®åº“ä¸­çš„ç»“æ„å’Œä½œç”¨å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><img src="/2023/03/03/01-MySQL%E6%9E%B6%E6%9E%84%E7%AF%87/image-20220615193131719.png" class=""><p><strong>å¦‚æœæˆ‘ä»¬æ‰§è¡Œ SQL è¯­å¥çš„æ—¶å€™æ›´æ–°äº†ç¼“å­˜æ± ä¸­çš„æ•°æ®ï¼Œé‚£ä¹ˆè¿™äº›æ•°æ®ä¼šé©¬ä¸ŠåŒæ­¥åˆ°ç£ç›˜ä¸Šå—ï¼Ÿ</strong></p><p>å®é™…ä¸Šï¼Œå½“æˆ‘ä»¬å¯¹æ•°æ®åº“ä¸­çš„è®°å½•è¿›è¡Œä¿®æ”¹çš„æ—¶å€™ï¼Œé¦–å…ˆä¼šä¿®æ”¹ç¼“å†²æ± ä¸­é¡µé‡Œé¢çš„è®°å½•ä¿¡æ¯ï¼Œç„¶åæ•°æ®åº“ä¼š<code>ä»¥ä¸€å®šçš„é¢‘ç‡åˆ·æ–°</code>åˆ°ç£ç›˜ä¸­ã€‚æ³¨æ„å¹¶ä¸æ˜¯æ¯æ¬¡å‘ç”Ÿæ›´æ–°æ“ä½œï¼Œéƒ½ä¼šç«‹å³è¿›è¡Œç£ç›˜å›å†™ã€‚ç¼“å†²æ± ä¼šé‡‡ç”¨ä¸€ç§å«åš <code>checkpoint çš„æœºåˆ¶</code> å°†æ•°æ®å›å†™åˆ°ç£ç›˜ä¸Šï¼Œè¿™æ ·åšçš„å¥½å¤„å°±æ˜¯æå‡äº†æ•°æ®åº“çš„æ•´ä½“æ€§èƒ½ã€‚</p><p>æ¯”å¦‚ï¼Œå½“<code>ç¼“å†²æ± ä¸å¤Ÿç”¨</code>æ—¶ï¼Œéœ€è¦é‡Šæ”¾æ‰ä¸€äº›ä¸å¸¸ç”¨çš„é¡µï¼Œæ­¤æ—¶å°±å¯ä»¥å¼ºè¡Œé‡‡ç”¨checkpointçš„æ–¹å¼ï¼Œå°†ä¸å¸¸ç”¨çš„è„é¡µå›å†™åˆ°ç£ç›˜ä¸Šï¼Œç„¶åå†ä»ç¼“å­˜æ± ä¸­å°†è¿™äº›é¡µé‡Šæ”¾æ‰ã€‚è¿™é‡Œçš„è„é¡µ (dirty page) æŒ‡çš„æ˜¯ç¼“å†²æ± ä¸­è¢«ä¿®æ”¹è¿‡çš„é¡µï¼Œä¸ç£ç›˜ä¸Šçš„æ•°æ®é¡µä¸ä¸€è‡´ã€‚</p><h3 id="3-3-æŸ¥çœ‹-x2F-è®¾ç½®ç¼“å†²æ± çš„å¤§å°"><a href="#3-3-æŸ¥çœ‹-x2F-è®¾ç½®ç¼“å†²æ± çš„å¤§å°" class="headerlink" title="3.3 æŸ¥çœ‹&#x2F;è®¾ç½®ç¼“å†²æ± çš„å¤§å°"></a>3.3 æŸ¥çœ‹&#x2F;è®¾ç½®ç¼“å†²æ± çš„å¤§å°</h3><p>å¦‚æœä½ ä½¿ç”¨çš„æ˜¯ MySQL MyISAM å­˜å‚¨å¼•æ“ï¼Œå®ƒåªç¼“å­˜ç´¢å¼•ï¼Œä¸ç¼“å­˜æ•°æ®ï¼Œå¯¹åº”çš„é”®ç¼“å­˜å‚æ•°ä¸º<code>key_buffer_size</code>ï¼Œä½ å¯ä»¥ç”¨å®ƒè¿›è¡ŒæŸ¥çœ‹ã€‚</p><p>å¦‚æœä½ ä½¿ç”¨çš„æ˜¯ InnoDB å­˜å‚¨å¼•æ“ï¼Œå¯ä»¥é€šè¿‡æŸ¥çœ‹ innodb_buffer_pool_size å˜é‡æ¥æŸ¥çœ‹ç¼“å†²æ± çš„å¤§å°ã€‚å‘½ä»¤å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show variables like &#x27;innodb_buffer_pool_size&#x27;;</span><br></pre></td></tr></table></figure><img src="/2023/03/03/01-MySQL%E6%9E%B6%E6%9E%84%E7%AF%87/image-20220615214847480.png" class=""><p>ä½ èƒ½çœ‹åˆ°æ­¤æ—¶ InnoDB çš„ç¼“å†²æ± å¤§å°åªæœ‰ 134217728&#x2F;1024&#x2F;1024&#x3D;128MBã€‚æˆ‘ä»¬å¯ä»¥ä¿®æ”¹ç¼“å†²æ± å¤§å°ï¼Œæ¯”å¦‚æ”¹ä¸º256MBï¼Œæ–¹æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">set global innodb_buffer_pool_size = 268435456;</span><br></pre></td></tr></table></figure><p>æˆ–è€…ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[server]</span><br><span class="line">innodb_buffer_pool_size = 268435456</span><br></pre></td></tr></table></figure><h3 id="3-4-å¤šä¸ªBuffer-Poolå®ä¾‹"><a href="#3-4-å¤šä¸ªBuffer-Poolå®ä¾‹" class="headerlink" title="3.4 å¤šä¸ªBuffer Poolå®ä¾‹"></a>3.4 å¤šä¸ªBuffer Poolå®ä¾‹</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[server]</span><br><span class="line">innodb_buffer_pool_instances = 2</span><br></pre></td></tr></table></figure><p>è¿™æ ·å°±è¡¨æ˜æˆ‘ä»¬è¦åˆ›å»º2ä¸ª <code>Buffer Pool</code> å®ä¾‹ã€‚</p><p>æˆ‘ä»¬çœ‹ä¸‹å¦‚ä½•æŸ¥çœ‹ç¼“å†²æ± çš„ä¸ªæ•°ï¼Œä½¿ç”¨å‘½ä»¤ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show variables like &#x27;innodb_buffer_pool_instances&#x27;;</span><br></pre></td></tr></table></figure><p>é‚£æ¯ä¸ª Buffer Pool å®ä¾‹å®é™…å å¤šå°‘å†…å­˜ç©ºé—´å‘¢ï¼Ÿå…¶å®ä½¿ç”¨è¿™ä¸ªå…¬å¼ç®—å‡ºæ¥çš„ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">innodb_buffer_pool_size/innodb_buffer_pool_instances</span><br></pre></td></tr></table></figure><p>ä¹Ÿå°±æ˜¯æ€»å…±çš„å¤§å°é™¤ä»¥å®ä¾‹çš„ä¸ªæ•°ï¼Œç»“æœå°±æ˜¯æ¯ä¸ª Buffer Pool å®ä¾‹å ç”¨çš„å¤§å°ã€‚</p><p>ä¸è¿‡ä¹Ÿä¸æ˜¯è¯´ Buffer Pool å®ä¾‹åˆ›å»ºçš„è¶Šå¤šè¶Šå¥½ï¼Œåˆ†åˆ«ç®¡ç†å„ä¸ª Buffer Pool ä¹Ÿæ˜¯éœ€è¦æ€§èƒ½å¼€é”€çš„ï¼ŒInnDBè§„å®šï¼šå½“innodb_buffer_pool_sizeçš„å€¼å°äº1Gçš„æ—¶å€™è®¾ç½®å¤šä¸ªå®ä¾‹æ˜¯æ— æ•ˆçš„ï¼ŒInnoDBä¼šé»˜è®¤æŠŠinnodb_buffer_pool_instancesçš„å€¼ä¿®æ”¹ä¸º1ã€‚è€Œæˆ‘ä»¬é¼“åŠ±åœ¨ Buffer Pool å¤§äºç­‰äº 1G çš„æ—¶å€™è®¾ç½®å¤šä¸ª Buffer Pool å®ä¾‹ã€‚</p><h3 id="3-5-å¼•ç”³é—®é¢˜"><a href="#3-5-å¼•ç”³é—®é¢˜" class="headerlink" title="3.5 å¼•ç”³é—®é¢˜"></a>3.5 å¼•ç”³é—®é¢˜</h3><p>Buffer Poolæ˜¯MySQLå†…å­˜ç»“æ„ä¸­ååˆ†æ ¸å¿ƒçš„ä¸€ä¸ªç»„æˆï¼Œä½ å¯ä»¥å…ˆæŠŠå®ƒæƒ³è±¡æˆä¸€ä¸ªé»‘ç›’å­ã€‚</p><p>é»‘ç›’ä¸‹çš„æ›´æ–°æ•°æ®æµç¨‹</p><p>å½“æˆ‘ä»¬æŸ¥è¯¢æ•°æ®çš„æ—¶å€™ï¼Œä¼šå…ˆå» Buffer Pool ä¸­æŸ¥è¯¢ã€‚å¦‚æœ Buffer Pool ä¸­ä¸å­˜åœ¨ï¼Œå­˜å‚¨å¼•æ“ä¼šå…ˆå°†æ•°æ®ä»ç£ç›˜åŠ è½½åˆ° Buffer Pool ä¸­ï¼Œç„¶åå°†æ•°æ®è¿”å›ç»™å®¢æˆ·ç«¯ï¼›åŒç†ï¼Œå½“æˆ‘ä»¬æ›´æ–°æŸä¸ªæ•°æ®çš„æ—¶å€™ï¼Œå¦‚æœè¿™ä¸ªæ•°æ®ä¸å­˜åœ¨äº Buffer Poolï¼ŒåŒæ ·ä¼šå…ˆæ•°æ®åŠ è½½è¿›æ¥ï¼Œç„¶åä¿®æ”¹å†…å­˜çš„æ•°æ®ã€‚è¢«ä¿®æ”¹çš„æ•°æ®ä¼šåœ¨ä¹‹åç»Ÿä¸€åˆ·å…¥ç£ç›˜ã€‚</p><img src="/2023/03/03/01-MySQL%E6%9E%B6%E6%9E%84%E7%AF%87/image-20220615222455867.png" class=""><p>æˆ‘æ›´æ–°åˆ°ä¸€åŠçªç„¶å‘ç”Ÿé”™è¯¯äº†ï¼Œæƒ³è¦å›æ»šåˆ°æ›´æ–°ä¹‹å‰çš„ç‰ˆæœ¬ï¼Œè¯¥æ€ä¹ˆåŠï¼Ÿè¿æ•°æ®æŒä¹…åŒ–çš„ä¿è¯ã€äº‹åŠ¡å›æ»šéƒ½åšä¸åˆ°è¿˜è°ˆä»€ä¹ˆå´©æºƒæ¢å¤ï¼Ÿ</p><p>ç­”æ¡ˆï¼š<strong>Redo Log</strong> &amp; <strong>Undo Log</strong></p><h1 id="ç¬¬05ç« -å­˜å‚¨å¼•æ“"><a href="#ç¬¬05ç« -å­˜å‚¨å¼•æ“" class="headerlink" title="ç¬¬05ç« _å­˜å‚¨å¼•æ“"></a>ç¬¬05ç« _å­˜å‚¨å¼•æ“</h1><h2 id="1-æŸ¥çœ‹å­˜å‚¨å¼•æ“"><a href="#1-æŸ¥çœ‹å­˜å‚¨å¼•æ“" class="headerlink" title="1. æŸ¥çœ‹å­˜å‚¨å¼•æ“"></a>1. æŸ¥çœ‹å­˜å‚¨å¼•æ“</h2><ul><li>æŸ¥çœ‹mysqlæä¾›ä»€ä¹ˆå­˜å‚¨å¼•æ“</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show engines;</span><br></pre></td></tr></table></figure><img src="/2023/03/03/01-MySQL%E6%9E%B6%E6%9E%84%E7%AF%87/image-20220615223831995.png" class=""><h2 id="2-è®¾ç½®ç³»ç»Ÿé»˜è®¤çš„å­˜å‚¨å¼•æ“"><a href="#2-è®¾ç½®ç³»ç»Ÿé»˜è®¤çš„å­˜å‚¨å¼•æ“" class="headerlink" title="2. è®¾ç½®ç³»ç»Ÿé»˜è®¤çš„å­˜å‚¨å¼•æ“"></a>2. è®¾ç½®ç³»ç»Ÿé»˜è®¤çš„å­˜å‚¨å¼•æ“</h2><ul><li>æŸ¥çœ‹é»˜è®¤çš„å­˜å‚¨å¼•æ“</li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">show variables like &#x27;%storage_engine%&#x27;;</span><br><span class="line">#æˆ–</span><br><span class="line">SELECT @@default_storage_engine;</span><br></pre></td></tr></table></figure><img src="/2023/03/03/01-MySQL%E6%9E%B6%E6%9E%84%E7%AF%87/image-20220615224249491.png" class=""><ul><li>ä¿®æ”¹é»˜è®¤çš„å­˜å‚¨å¼•æ“</li></ul><p>å¦‚æœåœ¨åˆ›å»ºè¡¨çš„è¯­å¥ä¸­æ²¡æœ‰æ˜¾å¼æŒ‡å®šè¡¨çš„å­˜å‚¨å¼•æ“çš„è¯ï¼Œé‚£å°±ä¼šé»˜è®¤ä½¿ç”¨ InnoDB ä½œä¸ºè¡¨çš„å­˜å‚¨å¼•æ“ã€‚ å¦‚æœæˆ‘ä»¬æƒ³æ”¹å˜è¡¨çš„é»˜è®¤å­˜å‚¨å¼•æ“çš„è¯ï¼Œå¯ä»¥è¿™æ ·å†™å¯åŠ¨æœåŠ¡å™¨çš„å‘½ä»¤è¡Œï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SET DEFAULT_STORAGE_ENGINE=MyISAM;</span><br></pre></td></tr></table></figure><p>æˆ–è€…ä¿®æ”¹ my.cnf æ–‡ä»¶ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">default-storage-engine=MyISAM</span><br><span class="line"># é‡å¯æœåŠ¡</span><br><span class="line">systemctl restart mysqld.service</span><br></pre></td></tr></table></figure><h2 id="3-è®¾ç½®è¡¨çš„å­˜å‚¨å¼•æ“"><a href="#3-è®¾ç½®è¡¨çš„å­˜å‚¨å¼•æ“" class="headerlink" title="3. è®¾ç½®è¡¨çš„å­˜å‚¨å¼•æ“"></a>3. è®¾ç½®è¡¨çš„å­˜å‚¨å¼•æ“</h2><p>å­˜å‚¨å¼•æ“æ˜¯è´Ÿè´£å¯¹è¡¨ä¸­çš„æ•°æ®è¿›è¡Œæå–å’Œå†™å…¥å·¥ä½œçš„ï¼Œæˆ‘ä»¬å¯ä»¥ä¸º ä¸åŒçš„è¡¨è®¾ç½®ä¸åŒçš„å­˜å‚¨å¼•æ“ ï¼Œä¹Ÿå°±æ˜¯ è¯´ä¸åŒçš„è¡¨å¯ä»¥æœ‰ä¸åŒçš„ç‰©ç†å­˜å‚¨ç»“æ„ï¼Œä¸åŒçš„æå–å’Œå†™å…¥æ–¹å¼ã€‚</p><h3 id="3-1-åˆ›å»ºè¡¨æ—¶æŒ‡å®šå­˜å‚¨å¼•æ“"><a href="#3-1-åˆ›å»ºè¡¨æ—¶æŒ‡å®šå­˜å‚¨å¼•æ“" class="headerlink" title="3.1 åˆ›å»ºè¡¨æ—¶æŒ‡å®šå­˜å‚¨å¼•æ“"></a>3.1 åˆ›å»ºè¡¨æ—¶æŒ‡å®šå­˜å‚¨å¼•æ“</h3><p>æˆ‘ä»¬ä¹‹å‰åˆ›å»ºè¡¨çš„è¯­å¥éƒ½æ²¡æœ‰æŒ‡å®šè¡¨çš„å­˜å‚¨å¼•æ“ï¼Œé‚£å°±ä¼šä½¿ç”¨é»˜è®¤çš„å­˜å‚¨å¼•æ“ InnoDB ã€‚å¦‚æœæˆ‘ä»¬æƒ³æ˜¾ å¼çš„æŒ‡å®šä¸€ä¸‹è¡¨çš„å­˜å‚¨å¼•æ“ï¼Œé‚£å¯ä»¥è¿™ä¹ˆå†™ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE è¡¨å(</span><br><span class="line">å»ºè¡¨è¯­å¥;</span><br><span class="line">) ENGINE = å­˜å‚¨å¼•æ“åç§°;</span><br></pre></td></tr></table></figure><h3 id="3-2-ä¿®æ”¹è¡¨çš„å­˜å‚¨å¼•æ“"><a href="#3-2-ä¿®æ”¹è¡¨çš„å­˜å‚¨å¼•æ“" class="headerlink" title="3.2 ä¿®æ”¹è¡¨çš„å­˜å‚¨å¼•æ“"></a>3.2 ä¿®æ”¹è¡¨çš„å­˜å‚¨å¼•æ“</h3><p>å¦‚æœè¡¨å·²ç»å»ºå¥½äº†ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥ä½¿ç”¨ä¸‹è¾¹è¿™ä¸ªè¯­å¥æ¥ä¿®æ”¹è¡¨çš„å­˜å‚¨å¼•æ“ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ALTER TABLE è¡¨å ENGINE = å­˜å‚¨å¼•æ“åç§°;</span><br></pre></td></tr></table></figure><p>æ¯”å¦‚æˆ‘ä»¬ä¿®æ”¹ä¸€ä¸‹ engine_demo_table è¡¨çš„å­˜å‚¨å¼•æ“ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; ALTER TABLE engine_demo_table ENGINE = InnoDB;</span><br></pre></td></tr></table></figure><p>è¿™æ—¶æˆ‘ä»¬å†æŸ¥çœ‹ä¸€ä¸‹ engine_demo_table çš„è¡¨ç»“æ„ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SHOW CREATE TABLE engine_demo_table\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">Table: engine_demo_table</span><br><span class="line">Create Table: CREATE TABLE `engine_demo_table` (</span><br><span class="line">`i` int(11) DEFAULT NULL</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8</span><br><span class="line">1 row in set (0.01 sec)</span><br></pre></td></tr></table></figure><h2 id="4-å¼•æ“ä»‹ç»"><a href="#4-å¼•æ“ä»‹ç»" class="headerlink" title="4. å¼•æ“ä»‹ç»"></a>4. å¼•æ“ä»‹ç»</h2><h3 id="4-1-InnoDB-å¼•æ“ï¼šå…·å¤‡å¤–é”®æ”¯æŒåŠŸèƒ½çš„äº‹åŠ¡å­˜å‚¨å¼•æ“"><a href="#4-1-InnoDB-å¼•æ“ï¼šå…·å¤‡å¤–é”®æ”¯æŒåŠŸèƒ½çš„äº‹åŠ¡å­˜å‚¨å¼•æ“" class="headerlink" title="4.1 InnoDB å¼•æ“ï¼šå…·å¤‡å¤–é”®æ”¯æŒåŠŸèƒ½çš„äº‹åŠ¡å­˜å‚¨å¼•æ“"></a>4.1 InnoDB å¼•æ“ï¼šå…·å¤‡å¤–é”®æ”¯æŒåŠŸèƒ½çš„äº‹åŠ¡å­˜å‚¨å¼•æ“</h3><ul><li>MySQLä»3.23.34aå¼€å§‹å°±åŒ…å«InnoDBå­˜å‚¨å¼•æ“ã€‚ <code>å¤§äºç­‰äº5.5ä¹‹åï¼Œé»˜è®¤é‡‡ç”¨InnoDBå¼•æ“</code> ã€‚</li><li>InnoDBæ˜¯MySQLçš„ é»˜è®¤äº‹åŠ¡å‹å¼•æ“ ï¼Œå®ƒè¢«è®¾è®¡ç”¨æ¥å¤„ç†å¤§é‡çš„çŸ­æœŸ(short-lived)äº‹åŠ¡ã€‚å¯ä»¥ç¡®ä¿äº‹åŠ¡çš„å®Œæ•´æäº¤(Commit)å’Œå›æ»š(Rollback)ã€‚ </li><li>é™¤äº†å¢åŠ å’ŒæŸ¥è¯¢å¤–ï¼Œè¿˜éœ€è¦æ›´æ–°ã€åˆ é™¤æ“ä½œï¼Œé‚£ä¹ˆï¼Œåº”ä¼˜å…ˆé€‰æ‹©InnoDBå­˜å‚¨å¼•æ“ã€‚ é™¤éæœ‰éå¸¸ç‰¹åˆ«çš„åŸå› éœ€è¦ä½¿ç”¨å…¶ä»–çš„å­˜å‚¨å¼•æ“ï¼Œå¦åˆ™åº”è¯¥ä¼˜å…ˆè€ƒè™‘InnoDBå¼•æ“ã€‚ </li><li>æ•°æ®æ–‡ä»¶ç»“æ„ï¼šï¼ˆåœ¨ã€Šç¬¬02ç« _MySQLæ•°æ®ç›®å½•ã€‹ç« èŠ‚å·²è®²ï¼‰ <ul><li>è¡¨å.frm å­˜å‚¨è¡¨ç»“æ„ï¼ˆMySQL8.0æ—¶ï¼Œåˆå¹¶åœ¨è¡¨å.ibdä¸­ï¼‰ </li><li>è¡¨å.ibd å­˜å‚¨æ•°æ®å’Œç´¢å¼•</li></ul></li><li>InnoDBæ˜¯ ä¸ºå¤„ç†å·¨å¤§æ•°æ®é‡çš„æœ€å¤§æ€§èƒ½è®¾è®¡ ã€‚ <ul><li>åœ¨ä»¥å‰çš„ç‰ˆæœ¬ä¸­ï¼Œå­—å…¸æ•°æ®ä»¥å…ƒæ•°æ®æ–‡ä»¶ã€éäº‹åŠ¡è¡¨ç­‰æ¥å­˜å‚¨ã€‚ç°åœ¨è¿™äº›å…ƒæ•°æ®æ–‡ä»¶è¢«åˆ é™¤ äº†ã€‚æ¯”å¦‚ï¼š .frm ï¼Œ .par ï¼Œ .trn ï¼Œ .isl ï¼Œ .db.opt ç­‰éƒ½åœ¨MySQL8.0ä¸­ä¸å­˜åœ¨äº†ã€‚</li></ul></li><li>å¯¹æ¯”MyISAMçš„å­˜å‚¨å¼•æ“ï¼Œ InnoDBå†™çš„å¤„ç†æ•ˆç‡å·®ä¸€äº› ï¼Œå¹¶ä¸”ä¼šå ç”¨æ›´å¤šçš„ç£ç›˜ç©ºé—´ä»¥ä¿å­˜æ•°æ®å’Œç´¢å¼•ã€‚ </li><li>MyISAMåªç¼“å­˜ç´¢å¼•ï¼Œä¸ç¼“å­˜çœŸå®æ•°æ®ï¼›InnoDBä¸ä»…ç¼“å­˜ç´¢å¼•è¿˜è¦ç¼“å­˜çœŸå®æ•°æ®ï¼Œ å¯¹å†…å­˜è¦æ±‚è¾ƒ é«˜ ï¼Œè€Œä¸”å†…å­˜å¤§å°å¯¹æ€§èƒ½æœ‰å†³å®šæ€§çš„å½±å“ã€‚</li></ul><h3 id="4-2-MyISAM-å¼•æ“ï¼šä¸»è¦çš„éäº‹åŠ¡å¤„ç†å­˜å‚¨å¼•æ“"><a href="#4-2-MyISAM-å¼•æ“ï¼šä¸»è¦çš„éäº‹åŠ¡å¤„ç†å­˜å‚¨å¼•æ“" class="headerlink" title="4.2 MyISAM å¼•æ“ï¼šä¸»è¦çš„éäº‹åŠ¡å¤„ç†å­˜å‚¨å¼•æ“"></a>4.2 MyISAM å¼•æ“ï¼šä¸»è¦çš„éäº‹åŠ¡å¤„ç†å­˜å‚¨å¼•æ“</h3><ul><li>MyISAMæä¾›äº†å¤§é‡çš„ç‰¹æ€§ï¼ŒåŒ…æ‹¬å…¨æ–‡ç´¢å¼•ã€å‹ç¼©ã€ç©ºé—´å‡½æ•°(GIS)ç­‰ï¼Œä½†MyISAMä¸æ”¯æŒäº‹åŠ¡ã€è¡Œçº§ é”ã€å¤–é”® ï¼Œæœ‰ä¸€ä¸ªæ¯«æ— ç–‘é—®çš„ç¼ºé™·å°±æ˜¯å´©æºƒåæ— æ³•å®‰å…¨æ¢å¤ ã€‚</li><li>5.5ä¹‹å‰é»˜è®¤çš„å­˜å‚¨å¼•æ“ </li><li>ä¼˜åŠ¿æ˜¯è®¿é—®çš„é€Ÿåº¦å¿« ï¼Œå¯¹äº‹åŠ¡å®Œæ•´æ€§æ²¡æœ‰è¦æ±‚æˆ–è€…ä»¥SELECTã€INSERTä¸ºä¸»çš„åº”ç”¨ </li><li>é’ˆå¯¹æ•°æ®ç»Ÿè®¡æœ‰é¢å¤–çš„å¸¸æ•°å­˜å‚¨ã€‚æ•…è€Œ count(*) çš„æŸ¥è¯¢æ•ˆç‡å¾ˆé«˜ æ•°æ®æ–‡ä»¶ç»“æ„ï¼šï¼ˆåœ¨ã€Šç¬¬02ç« _MySQLæ•°æ®ç›®å½•ã€‹ç« èŠ‚å·²è®²ï¼‰ <ul><li>è¡¨å.frm å­˜å‚¨è¡¨ç»“æ„ </li><li>è¡¨å.MYD å­˜å‚¨æ•°æ® (MYData) </li><li>è¡¨å.MYI å­˜å‚¨ç´¢å¼• (MYIndex)</li></ul></li><li>åº”ç”¨åœºæ™¯ï¼šåªè¯»åº”ç”¨æˆ–è€…ä»¥è¯»ä¸ºä¸»çš„ä¸šåŠ¡</li></ul><h3 id="4-3-Archive-å¼•æ“ï¼šç”¨äºæ•°æ®å­˜æ¡£"><a href="#4-3-Archive-å¼•æ“ï¼šç”¨äºæ•°æ®å­˜æ¡£" class="headerlink" title="4.3 Archive å¼•æ“ï¼šç”¨äºæ•°æ®å­˜æ¡£"></a>4.3 Archive å¼•æ“ï¼šç”¨äºæ•°æ®å­˜æ¡£</h3><ul><li>ä¸‹è¡¨å±•ç¤ºäº†ARCHIVE å­˜å‚¨å¼•æ“åŠŸèƒ½</li></ul><img src="/2023/03/03/01-MySQL%E6%9E%B6%E6%9E%84%E7%AF%87/image-20220616124743732.png" class="" title="### 4.4 Blackhole å¼•æ“ï¼šä¸¢å¼ƒå†™æ“ä½œï¼Œè¯»æ“ä½œä¼šè¿”å›ç©ºå†…å®¹ ### 4.5 CSV å¼•æ“ï¼šå­˜å‚¨æ•°æ®æ—¶ï¼Œä»¥é€—å·åˆ†éš”å„ä¸ªæ•°æ®é¡¹ ä½¿ç”¨æ¡ˆä¾‹å¦‚ä¸‹ <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; CREATE TABLE test (i INT NOT NULL, c CHAR(10) NOT NULL) ENGINE = CSV;</span><br><span class="line">Query OK, 0 rows affected (0.06 sec)</span><br><span class="line">mysql&gt; INSERT INTO test VALUES(1,&#x27;record one&#x27;),(2,&#x27;record two&#x27;);</span><br><span class="line">Query OK, 2 rows affected (0.05 sec)</span><br><span class="line">Records: 2 Duplicates: 0 Warnings: 0</span><br><span class="line">mysql&gt; SELECT * FROM test;</span><br><span class="line">+---+------------+</span><br><span class="line">| i |      c     |</span><br><span class="line">+---+------------+</span><br><span class="line">| 1 | record one |</span><br><span class="line">| 2 | record two |</span><br><span class="line">+---+------------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure> åˆ›å»ºCSVè¡¨è¿˜ä¼šåˆ›å»ºç›¸åº”çš„å…ƒæ–‡ä»¶ ï¼Œç”¨äº å­˜å‚¨è¡¨çš„çŠ¶æ€ å’Œ è¡¨ä¸­å­˜åœ¨çš„è¡Œæ•° ã€‚æ­¤æ–‡ä»¶çš„åç§°ä¸è¡¨çš„åç§°ç›¸ åŒï¼Œåç¼€ä¸º CSM ã€‚å¦‚å›¾æ‰€ç¤º {% asset_img image-20220616125342599.png"><p>å¦‚æœæ£€æŸ¥ test.CSV é€šè¿‡æ‰§è¡Œä¸Šè¿°è¯­å¥åˆ›å»ºçš„æ•°æ®åº“ç›®å½•ä¸­çš„æ–‡ä»¶ï¼Œå…¶å†…å®¹ä½¿ç”¨Notepad++æ‰“å¼€å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&quot;1&quot;,&quot;record one&quot;</span><br><span class="line">&quot;2&quot;,&quot;record two&quot;</span><br></pre></td></tr></table></figure><p>è¿™ç§æ ¼å¼å¯ä»¥è¢« Microsoft Excel ç­‰ç”µå­è¡¨æ ¼åº”ç”¨ç¨‹åºè¯»å–ï¼Œç”šè‡³å†™å…¥ã€‚ä½¿ç”¨Microsoft Excelæ‰“å¼€å¦‚å›¾æ‰€ç¤º</p><img src="/2023/03/03/01-MySQL%E6%9E%B6%E6%9E%84%E7%AF%87/image-20220616125448555.png" class=""><h3 id="4-6-Memory-å¼•æ“ï¼šç½®äºå†…å­˜çš„è¡¨"><a href="#4-6-Memory-å¼•æ“ï¼šç½®äºå†…å­˜çš„è¡¨" class="headerlink" title="4.6 Memory å¼•æ“ï¼šç½®äºå†…å­˜çš„è¡¨"></a>4.6 Memory å¼•æ“ï¼šç½®äºå†…å­˜çš„è¡¨</h3><p><strong>æ¦‚è¿°ï¼š</strong></p><p>Memoryé‡‡ç”¨çš„é€»è¾‘ä»‹è´¨æ˜¯å†…å­˜ ï¼Œå“åº”é€Ÿåº¦å¾ˆå¿« ï¼Œä½†æ˜¯å½“mysqldå®ˆæŠ¤è¿›ç¨‹å´©æºƒçš„æ—¶å€™æ•°æ®ä¼šä¸¢å¤± ã€‚å¦å¤–ï¼Œè¦æ±‚å­˜å‚¨çš„æ•°æ®æ˜¯æ•°æ®é•¿åº¦ä¸å˜çš„æ ¼å¼ï¼Œæ¯”å¦‚ï¼ŒBlobå’ŒTextç±»å‹çš„æ•°æ®ä¸å¯ç”¨(é•¿åº¦ä¸å›ºå®šçš„)ã€‚</p><p><strong>ä¸»è¦ç‰¹å¾ï¼š</strong></p><ul><li>MemoryåŒæ—¶ æ”¯æŒå“ˆå¸Œï¼ˆHASHï¼‰ç´¢å¼• å’Œ B+æ ‘ç´¢å¼• ã€‚ </li><li>Memoryè¡¨è‡³å°‘æ¯”MyISAMè¡¨è¦å¿«ä¸€ä¸ªæ•°é‡çº§ ã€‚ </li><li>MEMORY è¡¨çš„å¤§å°æ˜¯å—åˆ°é™åˆ¶ çš„ã€‚è¡¨çš„å¤§å°ä¸»è¦å–å†³äºä¸¤ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯ max_rows å’Œ max_heap_table_size ã€‚å…¶ä¸­ï¼Œmax_rowså¯ä»¥åœ¨åˆ›å»ºè¡¨æ—¶æŒ‡å®šï¼›max_heap_table_sizeçš„å¤§å°é»˜ è®¤ä¸º16MBï¼Œå¯ä»¥æŒ‰éœ€è¦è¿›è¡Œæ‰©å¤§ã€‚ </li><li>æ•°æ®æ–‡ä»¶ä¸ç´¢å¼•æ–‡ä»¶åˆ†å¼€å­˜å‚¨ã€‚ </li><li>ç¼ºç‚¹ï¼šå…¶æ•°æ®æ˜“ä¸¢å¤±ï¼Œç”Ÿå‘½å‘¨æœŸçŸ­ã€‚åŸºäºè¿™ä¸ªç¼ºé™·ï¼Œé€‰æ‹©MEMORYå­˜å‚¨å¼•æ“æ—¶éœ€è¦ç‰¹åˆ«å°å¿ƒã€‚</li></ul><p><strong>ä½¿ç”¨Memoryå­˜å‚¨å¼•æ“çš„åœºæ™¯ï¼š</strong></p><ol><li>ç›®æ ‡æ•°æ®æ¯”è¾ƒå° ï¼Œè€Œä¸”éå¸¸é¢‘ç¹çš„è¿›è¡Œè®¿é—® ï¼Œåœ¨å†…å­˜ä¸­å­˜æ”¾æ•°æ®ï¼Œå¦‚æœå¤ªå¤§çš„æ•°æ®ä¼šé€ æˆå†…å­˜æº¢å‡º ã€‚å¯ä»¥é€šè¿‡å‚æ•° max_heap_table_size æ§åˆ¶Memoryè¡¨çš„å¤§å°ï¼Œé™åˆ¶Memoryè¡¨çš„æœ€å¤§çš„å¤§å°ã€‚ </li><li>å¦‚æœæ•°æ®æ˜¯ä¸´æ—¶çš„ ï¼Œè€Œä¸”å¿…é¡»ç«‹å³å¯ç”¨å¾—åˆ°ï¼Œé‚£ä¹ˆå°±å¯ä»¥æ”¾åœ¨å†…å­˜ä¸­ã€‚</li><li>å­˜å‚¨åœ¨Memoryè¡¨ä¸­çš„æ•°æ®å¦‚æœçªç„¶é—´ä¸¢å¤±çš„è¯ä¹Ÿæ²¡æœ‰å¤ªå¤§çš„å…³ç³» ã€‚</li></ol><h3 id="4-7-Federated-å¼•æ“ï¼šè®¿é—®è¿œç¨‹è¡¨"><a href="#4-7-Federated-å¼•æ“ï¼šè®¿é—®è¿œç¨‹è¡¨" class="headerlink" title="4.7 Federated å¼•æ“ï¼šè®¿é—®è¿œç¨‹è¡¨"></a>4.7 Federated å¼•æ“ï¼šè®¿é—®è¿œç¨‹è¡¨</h3><p><strong>Federatedå¼•æ“æ˜¯è®¿é—®å…¶ä»–MySQLæœåŠ¡å™¨çš„ä¸€ä¸ª ä»£ç† ï¼Œå°½ç®¡è¯¥å¼•æ“çœ‹èµ·æ¥æä¾›äº†ä¸€ç§å¾ˆå¥½çš„ è·¨æœåŠ¡ å™¨çš„çµæ´»æ€§ ï¼Œä½†ä¹Ÿç»å¸¸å¸¦æ¥é—®é¢˜ï¼Œå› æ­¤ é»˜è®¤æ˜¯ç¦ç”¨çš„ ã€‚</strong></p><h3 id="4-8-Mergeå¼•æ“ï¼šç®¡ç†å¤šä¸ªMyISAMè¡¨æ„æˆçš„è¡¨é›†åˆ"><a href="#4-8-Mergeå¼•æ“ï¼šç®¡ç†å¤šä¸ªMyISAMè¡¨æ„æˆçš„è¡¨é›†åˆ" class="headerlink" title="4.8 Mergeå¼•æ“ï¼šç®¡ç†å¤šä¸ªMyISAMè¡¨æ„æˆçš„è¡¨é›†åˆ"></a>4.8 Mergeå¼•æ“ï¼šç®¡ç†å¤šä¸ªMyISAMè¡¨æ„æˆçš„è¡¨é›†åˆ</h3><h3 id="4-9-NDBå¼•æ“ï¼šMySQLé›†ç¾¤ä¸“ç”¨å­˜å‚¨å¼•æ“"><a href="#4-9-NDBå¼•æ“ï¼šMySQLé›†ç¾¤ä¸“ç”¨å­˜å‚¨å¼•æ“" class="headerlink" title="4.9 NDBå¼•æ“ï¼šMySQLé›†ç¾¤ä¸“ç”¨å­˜å‚¨å¼•æ“"></a>4.9 NDBå¼•æ“ï¼šMySQLé›†ç¾¤ä¸“ç”¨å­˜å‚¨å¼•æ“</h3><p>ä¹Ÿå«åš NDB Cluster å­˜å‚¨å¼•æ“ï¼Œä¸»è¦ç”¨äº MySQL Cluster åˆ†å¸ƒå¼é›†ç¾¤ ç¯å¢ƒï¼Œç±»ä¼¼äº Oracle çš„ RAC é›† ç¾¤ã€‚</p><h3 id="4-10-å¼•æ“å¯¹æ¯”"><a href="#4-10-å¼•æ“å¯¹æ¯”" class="headerlink" title="4.10 å¼•æ“å¯¹æ¯”"></a>4.10 å¼•æ“å¯¹æ¯”</h3><p>MySQLä¸­åŒä¸€ä¸ªæ•°æ®åº“ï¼Œä¸åŒçš„è¡¨å¯ä»¥é€‰æ‹©ä¸åŒçš„å­˜å‚¨å¼•æ“ã€‚å¦‚ä¸‹è¡¨å¯¹å¸¸ç”¨å­˜å‚¨å¼•æ“åšå‡ºäº†å¯¹æ¯”ã€‚</p><img src="/2023/03/03/01-MySQL%E6%9E%B6%E6%9E%84%E7%AF%87/image-20220616125928861.png" class=""><img src="/2023/03/03/01-MySQL%E6%9E%B6%E6%9E%84%E7%AF%87/image-20220616125945304.png" class=""><p>å…¶å®è¿™äº›ä¸œè¥¿å¤§å®¶æ²¡å¿…è¦ç«‹å³å°±ç»™è®°ä½ï¼Œåˆ—å‡ºæ¥çš„ç›®çš„å°±æ˜¯æƒ³è®©å¤§å®¶æ˜ç™½ä¸åŒçš„å­˜å‚¨å¼•æ“æ”¯æŒä¸åŒçš„åŠŸèƒ½ã€‚</p><p>å…¶å®æˆ‘ä»¬æœ€å¸¸ç”¨çš„å°±æ˜¯ InnoDB å’Œ MyISAM ï¼Œæœ‰æ—¶ä¼šæä¸€ä¸‹ Memory ã€‚å…¶ä¸­ InnoDB æ˜¯ MySQL é»˜è®¤çš„å­˜å‚¨å¼•æ“ã€‚</p><h2 id="5-MyISAMå’ŒInnoDB"><a href="#5-MyISAMå’ŒInnoDB" class="headerlink" title="5. MyISAMå’ŒInnoDB"></a>5. MyISAMå’ŒInnoDB</h2><p>å¾ˆå¤šäººå¯¹ InnoDB å’Œ MyISAM çš„å–èˆå­˜åœ¨ç–‘é—®ï¼Œåˆ°åº•é€‰æ‹©å“ªä¸ªæ¯”è¾ƒå¥½å‘¢ï¼Ÿ </p><p>MySQL5.5ä¹‹å‰çš„é»˜è®¤å­˜å‚¨å¼•æ“æ˜¯MyISAMï¼Œ5.5ä¹‹åæ”¹ä¸ºäº†InnoDBã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Mysql </category>
          
          <category> Mysqlé«˜çº§ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Mysqlé«˜çº§ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ‰‹å†™Webåº”ç”¨æœåŠ¡ï¼Œå½»åº•ææ‡‚Tomcat Â© pepsi-wyl</title>
      <link href="/2022/12/06/%E6%89%8B%E5%86%99Web%E5%BA%94%E7%94%A8%E6%9C%8D%E5%8A%A1%EF%BC%8C%E5%BD%BB%E5%BA%95%E6%90%9E%E6%87%82Tomcat-%C2%A9-pepsi-wyl/"/>
      <url>/2022/12/06/%E6%89%8B%E5%86%99Web%E5%BA%94%E7%94%A8%E6%9C%8D%E5%8A%A1%EF%BC%8C%E5%BD%BB%E5%BA%95%E6%90%9E%E6%87%82Tomcat-%C2%A9-pepsi-wyl/</url>
      
        <content type="html"><![CDATA[<h1 id="å‰æ"><a href="#å‰æ" class="headerlink" title="å‰æ"></a>å‰æ</h1><h2 id="çŸ¥è¯†ç‚¹"><a href="#çŸ¥è¯†ç‚¹" class="headerlink" title="çŸ¥è¯†ç‚¹"></a>çŸ¥è¯†ç‚¹</h2><ul><li>Socket</li><li>IOæµ</li></ul><h2 id="æ€è·¯"><a href="#æ€è·¯" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h2><ul><li>å¯åŠ¨<strong>Socket</strong>æœåŠ¡ï¼Œå¾ªç¯æ¥æ”¶æµè§ˆå™¨è¯·æ±‚</li><li>æ¥æ”¶åˆ°è¯·æ±‚åï¼Œ<strong>å–å‡ºæµä¸­æ•°æ®</strong></li><li><strong>åˆ¤æ–­ç›®æ ‡èµ„æºæ˜¯å¦å­˜åœ¨</strong>ï¼Œä¸å­˜åœ¨åˆ™è¿”å›404ï¼Œå­˜åœ¨åˆ™é€šè¿‡è¾“å‡ºæµå°†ç›®æ ‡èµ„æºå“åº”ç»™å®¢æˆ·ç«¯</li></ul><h2 id="ç±»"><a href="#ç±»" class="headerlink" title="ç±»"></a>ç±»</h2><ul><li>Serverï¼šå¼€å¯SocketæœåŠ¡</li><li>Requestï¼šå°è£…è¯·æ±‚ï¼Œå¤„ç†ç›¸å…³çš„è¯·æ±‚ä¸šåŠ¡</li><li>Responseï¼šå°è£…å“åº”ï¼Œå¤„ç†ç›¸å…³çš„å“åº”ä¸šåŠ¡</li><li>Testï¼šæµ‹è¯•ç±»</li></ul><h1 id="ç¼–ç "><a href="#ç¼–ç " class="headerlink" title="ç¼–ç "></a>ç¼–ç </h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">GitHub https:<span class="comment">//github.com/pepsi-wyl/Web_Tomcat</span></span><br><span class="line">    </span><br><span class="line">git<span class="meta">@github</span>.com:pepsi-wyl/Web_Tomcat.git</span><br><span class="line">https:<span class="comment">//github.com/pepsi-wyl/Web_Tomcat.git    </span></span><br></pre></td></tr></table></figure><h2 id="HttpServer"><a href="#HttpServer" class="headerlink" title="HttpServer"></a>HttpServer</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> lombok.SneakyThrows;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.OutputStream;</span><br><span class="line"><span class="keyword">import</span> java.net.ServerSocket;</span><br><span class="line"><span class="keyword">import</span> java.net.Socket;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* <span class="doctag">@author</span> by pepsi-wyl</span></span><br><span class="line"><span class="comment">* <span class="doctag">@date</span> 2022-12-06 17:21</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// SocketæœåŠ¡</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyHttpServer</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç«¯å£å·</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">port</span> <span class="operator">=</span> <span class="number">8080</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¥æ”¶è¯·æ±‚</span></span><br><span class="line">    <span class="meta">@SneakyThrows</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">receiving</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆ›å»ºSocketæœåŠ¡</span></span><br><span class="line">        <span class="type">ServerSocket</span> <span class="variable">serverSocket</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerSocket</span>(port);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¾ªç¯æ¥æ”¶è¯·æ±‚</span></span><br><span class="line">        <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">            <span class="comment">// è·å–è¿æ¥å¯¹è±¡</span></span><br><span class="line">            <span class="type">Socket</span> <span class="variable">socket</span> <span class="operator">=</span> serverSocket.accept();</span><br><span class="line">            <span class="comment">// è·å–è¿æ¥å¯¹è±¡çš„è¾“å…¥æµå’Œè¾“å‡ºæµ</span></span><br><span class="line">            <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> socket.getInputStream();</span><br><span class="line">            <span class="type">OutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> socket.getOutputStream();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// åˆ›å»ºRequest</span></span><br><span class="line">            <span class="type">MyHttpRequest</span> <span class="variable">request</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyHttpRequest</span>(inputStream);</span><br><span class="line">            <span class="comment">// åœ¨Requestä¸­è§£æè¾“å…¥æµå¯¹è±¡ï¼Œè·å–ç›®æ ‡èµ„æºä¿¡æ¯</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">uri</span> <span class="operator">=</span> request.parse();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// åˆ›å»ºResponse</span></span><br><span class="line">            <span class="type">MyHttpResponse</span> <span class="variable">response</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyHttpResponse</span>(outputStream);</span><br><span class="line">            <span class="comment">// åœ¨Responseä¸­</span></span><br><span class="line">            response.sendRedirect(uri);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="HttpRequest"><a href="#HttpRequest" class="headerlink" title="HttpRequest"></a>HttpRequest</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> lombok.SneakyThrows;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> by pepsi-wyl</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022-12-06 19:04</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å¤„ç†è¯·æ±‚å¯¹è±¡</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyHttpRequest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¾“å…¥æµ</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> InputStream inputStream;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ„é€ æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyHttpRequest</span><span class="params">(InputStream inputStream)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.inputStream = inputStream;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è§£æè¾“å…¥æµä¸­çš„ä¿¡æ¯</span></span><br><span class="line">    <span class="meta">@SneakyThrows</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">parse</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// å°†è¾“å…¥æµä¸­çš„æ•°æ®å­˜åˆ°æ•°ç»„ä¸­</span></span><br><span class="line">        <span class="type">byte</span>[] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">        inputStream.read(bytes);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è§£æè·å¾—ç›®æ ‡èµ„æºä¿¡æ¯å¹¶ä¸”è¿”å›</span></span><br><span class="line">        <span class="keyword">return</span> getUri(<span class="keyword">new</span> <span class="title class_">String</span>(bytes));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ ¹æ®è¯·æ±‚è·å–ç›®æ ‡èµ„æºä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">private</span> String <span class="title function_">getUri</span><span class="params">(String request)</span> &#123;</span><br><span class="line">        <span class="comment">// è·å–èµ„æºä¸‹æ ‡</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">index1</span> <span class="operator">=</span> request.indexOf(<span class="string">&#x27; &#x27;</span>);</span><br><span class="line">        <span class="type">int</span> <span class="variable">index2</span> <span class="operator">=</span> request.indexOf(<span class="string">&#x27; &#x27;</span>, index1 + <span class="number">1</span>);</span><br><span class="line">        <span class="comment">// è¿”å›èµ„æº</span></span><br><span class="line">        <span class="keyword">return</span> request.substring(index1 + <span class="number">1</span>, index2);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="HttpResponse"><a href="#HttpResponse" class="headerlink" title="HttpResponse"></a>HttpResponse</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> lombok.SneakyThrows;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.File;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.OutputStream;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> by pepsi-wyl</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022-12-06 21:30</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å¤„ç†å“åº”å¯¹è±¡</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyHttpResponse</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¾“å…¥æµ</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> OutputStream outputStream;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ„é€ æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyHttpResponse</span><span class="params">(OutputStream outputStream)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.outputStream = outputStream;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å“åº”</span></span><br><span class="line">    <span class="meta">@SneakyThrows</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendRedirect</span><span class="params">(String uri)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// è·å–èµ„æºä¿å­˜è·¯å¾„</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">path</span> <span class="operator">=</span> System.getProperty(<span class="string">&quot;user.dir&quot;</span>) + <span class="string">&quot;/src&quot;</span> + <span class="string">&quot;/main&quot;</span> + <span class="string">&quot;/resources&quot;</span> + <span class="string">&quot;/web&quot;</span>;</span><br><span class="line">        <span class="comment">// è·å–èµ„æºæ–‡ä»¶</span></span><br><span class="line">        <span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(path + uri);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¤„ç†è¿”å›å¯¹è±¡</span></span><br><span class="line">        <span class="keyword">if</span> (!file.exists()) &#123; <span class="comment">// ä¸å­˜åœ¨ åˆ™è¿”å›ä¸å­˜åœ¨ 404</span></span><br><span class="line">            <span class="comment">// è¦è¿”å›ä¿¡æ¯</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">error</span> <span class="operator">=</span> <span class="string">&quot;404 File Not Found!&quot;</span>;</span><br><span class="line">            <span class="comment">// è¿”å›</span></span><br><span class="line">            <span class="built_in">this</span>.outputStream.write(getResponseMessage(<span class="string">&quot;404&quot;</span>, error).getBytes());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;              <span class="comment">// å­˜åœ¨  åˆ™è¿”å›ç›®æ ‡èµ„æº 200</span></span><br><span class="line">            <span class="comment">// è¯»å–èµ„æºæ–‡ä»¶</span></span><br><span class="line">            <span class="type">FileInputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(file);</span><br><span class="line">            <span class="type">byte</span>[] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[(<span class="type">int</span>) file.length()];</span><br><span class="line">            fileInputStream.read(bytes);</span><br><span class="line">            <span class="comment">// è¿”å›ä¿¡æ¯</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(bytes);</span><br><span class="line">            <span class="comment">// è¿”å›</span></span><br><span class="line">            <span class="built_in">this</span>.outputStream.write(getResponseMessage(<span class="string">&quot;200&quot;</span>, result).getBytes());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å°è£…å“åº”ä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getResponseMessage</span><span class="params">(String code, String message)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;HTTP/1.1 &quot;</span> + code</span><br><span class="line">                + <span class="string">&quot;\r\n&quot;</span></span><br><span class="line">                + <span class="string">&quot;Content-type: &quot;</span> + <span class="string">&quot;text/html&quot;</span></span><br><span class="line">                + <span class="string">&quot;\r\n&quot;</span></span><br><span class="line">                + <span class="string">&quot;Content-Length: &quot;</span> + message.length()</span><br><span class="line">                + <span class="string">&quot;\r\n&quot;</span></span><br><span class="line">                + <span class="string">&quot;\r\n&quot;</span></span><br><span class="line">                + message;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Test"><a href="#Test" class="headerlink" title="Test"></a>Test</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> by pepsi-wyl</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022-12-06 17:33</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æµ‹è¯•æ–¹æ³•</span></span><br><span class="line"><span class="comment">// http://localhost:8080/index.html</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Server startup successfully......&quot;</span>);</span><br><span class="line">        <span class="comment">// åˆ›å»ºæœåŠ¡å¯¹è±¡</span></span><br><span class="line">        <span class="type">MyHttpServer</span> <span class="variable">server</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MyHttpServer</span>();</span><br><span class="line">        <span class="comment">// å¯åŠ¨æœåŠ¡æ¥æ”¶è¯·æ±‚</span></span><br><span class="line">        server.receiving();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="index-html"><a href="#index-html" class="headerlink" title="index.html"></a>index.html</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">&quot;en&quot;</span> xmlns:th=<span class="string">&quot;http://www.thymeleaf.org&quot;</span>&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=<span class="string">&quot;UTF-8&quot;</span>&gt;</span><br><span class="line">    &lt;title&gt;index&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line"></span><br><span class="line">index</span><br><span class="line"></span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure><h1 id="æµ‹è¯•"><a href="#æµ‹è¯•" class="headerlink" title="æµ‹è¯•"></a>æµ‹è¯•</h1><h2 id="å¯åŠ¨"><a href="#å¯åŠ¨" class="headerlink" title="å¯åŠ¨"></a>å¯åŠ¨</h2><img src="/2022/12/06/%E6%89%8B%E5%86%99Web%E5%BA%94%E7%94%A8%E6%9C%8D%E5%8A%A1%EF%BC%8C%E5%BD%BB%E5%BA%95%E6%90%9E%E6%87%82Tomcat-%C2%A9-pepsi-wyl/1670398719206-40f03b80-26ab-40ea-af91-3dd2f9b44400.png" class=""><h2 id="è®¿é—®å­˜åœ¨çš„èµ„æº"><a href="#è®¿é—®å­˜åœ¨çš„èµ„æº" class="headerlink" title="è®¿é—®å­˜åœ¨çš„èµ„æº"></a>è®¿é—®å­˜åœ¨çš„èµ„æº</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//localhost:8080/index.html</span></span><br></pre></td></tr></table></figure><img src="/2022/12/06/%E6%89%8B%E5%86%99Web%E5%BA%94%E7%94%A8%E6%9C%8D%E5%8A%A1%EF%BC%8C%E5%BD%BB%E5%BA%95%E6%90%9E%E6%87%82Tomcat-%C2%A9-pepsi-wyl/1670398775515-67d0d6aa-fac1-4030-aed8-9090649f997f.png" class=""><h2 id="è®¿é—®ä¸å­˜åœ¨çš„èµ„æº"><a href="#è®¿é—®ä¸å­˜åœ¨çš„èµ„æº" class="headerlink" title="è®¿é—®ä¸å­˜åœ¨çš„èµ„æº"></a>è®¿é—®ä¸å­˜åœ¨çš„èµ„æº</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//localhost:8080/t.html</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Tomcat </tag>
            
            <tag> Java </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>TCPä¸‰æ¬¡æ¡æ‰‹å’Œå››æ¬¡æŒ¥æ‰‹ Â© JavaGuide</title>
      <link href="/2022/11/18/TCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E5%92%8C%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B-%C2%A9-JavaGuide/"/>
      <url>/2022/11/18/TCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E5%92%8C%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B-%C2%A9-JavaGuide/</url>
      
        <content type="html"><![CDATA[<p>ä¸ºäº†<strong>å‡†ç¡®æ— è¯¯åœ°æŠŠæ•°æ®é€è¾¾ç›®æ ‡å¤„</strong>ï¼ŒTCP åè®®é‡‡ç”¨äº†ä¸‰æ¬¡æ¡æ‰‹ç­–ç•¥ã€‚</p><h2 id="å»ºç«‹è¿æ¥-TCP-ä¸‰æ¬¡æ¡æ‰‹"><a href="#å»ºç«‹è¿æ¥-TCP-ä¸‰æ¬¡æ¡æ‰‹" class="headerlink" title="å»ºç«‹è¿æ¥-TCP ä¸‰æ¬¡æ¡æ‰‹"></a>å»ºç«‹è¿æ¥-TCP ä¸‰æ¬¡æ¡æ‰‹</h2><p>å»ºç«‹ä¸€ä¸ª TCP è¿æ¥éœ€è¦â€œä¸‰æ¬¡æ¡æ‰‹â€ï¼Œ<strong>å»ºç«‹äº† 3 æ¬¡æ¡æ‰‹ä¹‹åï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯å°±å¯ä»¥ä¼ è¾“æ•°æ®å•¦ï¼ ( åºå·ï¼ˆSEQï¼‰ç¡®è®¤åºå·ï¼ˆACK) )</strong></p><ul><li><strong>ä¸€æ¬¡æ¡æ‰‹</strong>:å®¢æˆ·ç«¯å‘é€å¸¦æœ‰ <strong>SYNï¼ˆSEQ&#x3D;xï¼‰</strong> æ ‡å¿—çš„æ•°æ®åŒ… -&gt; æœåŠ¡ç«¯ï¼Œç„¶åå®¢æˆ·ç«¯è¿›å…¥ <strong>SYN_SENDï¼ˆè¯·æ±‚è¿æ¥ï¼‰</strong> çŠ¶æ€ï¼Œç­‰å¾…æœåŠ¡å™¨çš„ç¡®è®¤ï¼›</li><li><strong>äºŒæ¬¡æ¡æ‰‹</strong>:æœåŠ¡ç«¯å‘é€å¸¦æœ‰ **SYN+ACK(SEQ&#x3D;y,ACK&#x3D;x+1) **æ ‡å¿—çš„æ•°æ®åŒ… â€“&gt; å®¢æˆ·ç«¯,ç„¶åæœåŠ¡ç«¯è¿›å…¥ <strong>SYN_RECV</strong> çŠ¶æ€ï¼›</li><li><strong>ä¸‰æ¬¡æ¡æ‰‹</strong>:å®¢æˆ·ç«¯å‘é€å¸¦æœ‰ <strong>ACK(ACK&#x3D;y+1)</strong> æ ‡å¿—çš„æ•°æ®åŒ… â€“&gt; æœåŠ¡ç«¯ï¼Œç„¶åå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯éƒ½è¿›å…¥<strong>ESTABLISHED</strong> çŠ¶æ€ï¼Œå®ŒæˆTCPä¸‰æ¬¡æ¡æ‰‹ï¼›<img src="/2022/11/18/TCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E5%92%8C%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B-%C2%A9-JavaGuide/tcp-shakes-hands-three-times.png" class=""><img src="/2022/11/18/TCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E5%92%8C%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B-%C2%A9-JavaGuide/tcp-shakes-hands-three-times1.png" class=""></li></ul><h3 id="ä¸ºä»€ä¹ˆè¦ä¸‰æ¬¡æ¡æ‰‹"><a href="#ä¸ºä»€ä¹ˆè¦ä¸‰æ¬¡æ¡æ‰‹" class="headerlink" title="ä¸ºä»€ä¹ˆè¦ä¸‰æ¬¡æ¡æ‰‹"></a>ä¸ºä»€ä¹ˆè¦ä¸‰æ¬¡æ¡æ‰‹</h3><p>ä¸‰æ¬¡æ¡æ‰‹çš„ç›®çš„æ˜¯<strong>å»ºç«‹å¯é çš„é€šä¿¡ä¿¡é“</strong>ï¼Œè¯´åˆ°é€šè®¯ï¼Œç®€å•æ¥è¯´å°±æ˜¯æ•°æ®çš„å‘é€ä¸æ¥æ”¶ï¼Œè€Œä¸‰æ¬¡æ¡æ‰‹æœ€ä¸»è¦çš„ç›®çš„å°±æ˜¯<strong>åŒæ–¹ç¡®è®¤è‡ªå·±ä¸å¯¹æ–¹çš„å‘é€ä¸æ¥æ”¶æ­£å¸¸</strong></p><ol><li><strong>ç¬¬ä¸€æ¬¡æ¡æ‰‹</strong> ï¼šClient ä»€ä¹ˆéƒ½ä¸èƒ½ç¡®è®¤ï¼›Server ç¡®è®¤äº†å¯¹æ–¹å‘é€æ­£å¸¸ï¼Œè‡ªå·±æ¥æ”¶æ­£å¸¸</li><li><strong>ç¬¬äºŒæ¬¡æ¡æ‰‹</strong> ï¼šClient ç¡®è®¤äº†ï¼šè‡ªå·±å‘é€ã€æ¥æ”¶æ­£å¸¸ï¼Œå¯¹æ–¹å‘é€ã€æ¥æ”¶æ­£å¸¸ï¼›Server ç¡®è®¤äº†ï¼šå¯¹æ–¹å‘é€æ­£å¸¸ï¼Œè‡ªå·±æ¥æ”¶æ­£å¸¸</li><li><strong>ç¬¬ä¸‰æ¬¡æ¡æ‰‹</strong> ï¼šClient ç¡®è®¤äº†ï¼šè‡ªå·±å‘é€ã€æ¥æ”¶æ­£å¸¸ï¼Œå¯¹æ–¹å‘é€ã€æ¥æ”¶æ­£å¸¸ï¼›Server ç¡®è®¤äº†ï¼šè‡ªå·±å‘é€ã€æ¥æ”¶æ­£å¸¸ï¼Œå¯¹æ–¹å‘é€ã€æ¥æ”¶æ­£å¸¸</li></ol><p>ä¸‰æ¬¡æ¡æ‰‹å°±èƒ½ç¡®è®¤åŒæ–¹æ”¶å‘åŠŸèƒ½éƒ½æ­£å¸¸ï¼Œç¼ºä¸€ä¸å¯ã€‚<br>æ›´è¯¦ç»†çš„è§£ç­”å¯ä»¥çœ‹è¿™ä¸ªï¼š<a href="https://www.zhihu.com/question/24853633/answer/115173386">TCP ä¸ºä»€ä¹ˆæ˜¯ä¸‰æ¬¡æ¡æ‰‹ï¼Œè€Œä¸æ˜¯ä¸¤æ¬¡æˆ–å››æ¬¡ï¼Ÿ - è½¦å°èƒ–çš„å›ç­” - çŸ¥ä¹</a> Â ã€‚</p><h3 id="ç¬¬2æ¬¡æ¡æ‰‹ä¼ å›äº†ACKï¼Œä¸ºä»€ä¹ˆè¿˜è¦ä¼ å›SYN"><a href="#ç¬¬2æ¬¡æ¡æ‰‹ä¼ å›äº†ACKï¼Œä¸ºä»€ä¹ˆè¿˜è¦ä¼ å›SYN" class="headerlink" title="ç¬¬2æ¬¡æ¡æ‰‹ä¼ å›äº†ACKï¼Œä¸ºä»€ä¹ˆè¿˜è¦ä¼ å›SYN"></a>ç¬¬2æ¬¡æ¡æ‰‹ä¼ å›äº†ACKï¼Œä¸ºä»€ä¹ˆè¿˜è¦ä¼ å›SYN</h3><blockquote><p>**SYN åŒæ­¥åºåˆ—ç¼–å·(Synchronize Sequence Numbers) **æ˜¯ TCP&#x2F;IP å»ºç«‹è¿æ¥æ—¶ä½¿ç”¨çš„æ¡æ‰‹ä¿¡å·ã€‚åœ¨å®¢æˆ·æœºå’ŒæœåŠ¡å™¨ä¹‹é—´å»ºç«‹æ­£å¸¸çš„ TCP ç½‘ç»œè¿æ¥æ—¶ï¼Œå®¢æˆ·æœºé¦–å…ˆå‘å‡ºä¸€ä¸ª <strong>SYN</strong> æ¶ˆæ¯ï¼ŒæœåŠ¡å™¨ä½¿ç”¨ <strong>SYN-ACK</strong> åº”ç­”è¡¨ç¤ºæ¥æ”¶åˆ°äº†è¿™ä¸ªæ¶ˆæ¯ï¼Œæœ€åå®¢æˆ·æœºå†ä»¥ <strong>ACK(Acknowledgementï¼‰</strong>æ¶ˆæ¯å“åº”ã€‚è¿™æ ·åœ¨å®¢æˆ·æœºå’ŒæœåŠ¡å™¨ä¹‹é—´å°±å»ºç«‹èµ·å¯é çš„ TCP è¿æ¥ï¼Œæ•°æ®å°±å¯ä»¥åœ¨å®¢æˆ·æœºå’ŒæœåŠ¡å™¨ä¹‹é—´ä¼ é€’ã€‚</p></blockquote><p>æœåŠ¡ç«¯ä¼ å›å‘é€ç«¯æ‰€å‘é€çš„ ACK æ˜¯ä¸ºäº†å‘Šè¯‰å®¢æˆ·ç«¯ï¼šâ€œ<strong>æˆ‘æ¥æ”¶åˆ°çš„ä¿¡æ¯ç¡®å®æ˜¯ä½ æ‰€å‘é€çš„ä¿¡å·</strong>â€ï¼Œè¿™è¡¨æ˜ä»å®¢æˆ·ç«¯åˆ°æœåŠ¡ç«¯çš„é€šä¿¡æ˜¯æ­£å¸¸çš„ã€‚å›ä¼  SYN åˆ™æ˜¯<strong>ä¸ºäº†å»ºç«‹å¹¶ç¡®è®¤ä»æœåŠ¡ç«¯åˆ°å®¢æˆ·ç«¯çš„é€šä¿¡</strong>ã€‚</p><h2 id="æ–­å¼€è¿æ¥-TCP-å››æ¬¡æŒ¥æ‰‹"><a href="#æ–­å¼€è¿æ¥-TCP-å››æ¬¡æŒ¥æ‰‹" class="headerlink" title="æ–­å¼€è¿æ¥-TCP å››æ¬¡æŒ¥æ‰‹"></a>æ–­å¼€è¿æ¥-TCP å››æ¬¡æŒ¥æ‰‹</h2><p>æ–­å¼€ä¸€ä¸ª TCP è¿æ¥åˆ™éœ€è¦â€œå››æ¬¡æŒ¥æ‰‹â€ï¼Œ<strong>åªè¦å››æ¬¡æŒ¥æ‰‹æ²¡æœ‰ç»“æŸï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯å°±å¯ä»¥ç»§ç»­ä¼ è¾“æ•°æ®ï¼</strong></p><ol><li><strong>ç¬¬ä¸€æ¬¡æŒ¥æ‰‹</strong> ï¼šå®¢æˆ·ç«¯å‘é€ä¸€ä¸ª <strong>FINï¼ˆSEQ&#x3D;Xï¼‰</strong>æ ‡å¿—çš„æ•°æ®åŒ…-&gt;æœåŠ¡ç«¯ï¼Œç”¨æ¥å…³é—­å®¢æˆ·ç«¯åˆ°æœåŠ¡å™¨çš„æ•°æ®ä¼ é€ï¼Œç„¶åï¼Œå®¢æˆ·ç«¯è¿›å…¥ <strong>FIN-WAIT-1</strong> çŠ¶æ€ã€‚</li><li><strong>ç¬¬äºŒæ¬¡æŒ¥æ‰‹</strong> ï¼šæœåŠ¡å™¨æ”¶åˆ°è¿™ä¸ª <strong>FINï¼ˆSEQ&#x3D;Xï¼‰</strong>æ ‡å¿—çš„æ•°æ®åŒ…ï¼Œå®ƒå‘é€ä¸€ä¸ª <strong>ACK ï¼ˆSEQ&#x3D;X+1ï¼‰</strong>æ ‡å¿—çš„æ•°æ®åŒ…-&gt;å®¢æˆ·ç«¯ ï¼Œç„¶åï¼Œæ­¤æ—¶æœåŠ¡ç«¯è¿›å…¥<strong>CLOSE-WAIT</strong>çŠ¶æ€ï¼Œå®¢æˆ·ç«¯è¿›å…¥<strong>FIN-WAIT-2</strong>çŠ¶æ€ã€‚</li><li><strong>ç¬¬ä¸‰æ¬¡æŒ¥æ‰‹</strong> ï¼šæœåŠ¡ç«¯å…³é—­ä¸å®¢æˆ·ç«¯çš„è¿æ¥å¹¶å‘é€ä¸€ä¸ª <strong>FIN (SEQ&#x3D;y) <strong>æ ‡å¿—çš„æ•°æ®åŒ…-&gt;å®¢æˆ·ç«¯è¯·æ±‚å…³é—­è¿æ¥ï¼Œç„¶åï¼ŒæœåŠ¡ç«¯è¿›å…¥</strong>LAST-ACK</strong>çŠ¶æ€ã€‚</li><li><strong>ç¬¬å››æ¬¡æŒ¥æ‰‹</strong> ï¼šå®¢æˆ·ç«¯å‘é€ <strong>ACK (SEQ&#x3D;y+1) <strong>æ ‡å¿—çš„æ•°æ®åŒ…-&gt;æœåŠ¡ç«¯å¹¶ä¸”è¿›å…¥</strong>TIME-WAIT</strong>çŠ¶æ€ï¼ŒæœåŠ¡ç«¯åœ¨æ”¶åˆ° <strong>ACK (SEQ&#x3D;y+1) <strong>æ ‡å¿—çš„æ•°æ®åŒ…åè¿›å…¥</strong> CLOSE</strong> çŠ¶æ€ï¼Œæ­¤æ—¶ï¼Œå¦‚æœå®¢æˆ·ç«¯ç­‰å¾… <strong>2MSL</strong> åä¾ç„¶æ²¡æœ‰æ”¶åˆ°å›å¤ï¼Œå°±è¯æ˜æœåŠ¡ç«¯å·²æ­£å¸¸å…³é—­ï¼Œéšåï¼Œå®¢æˆ·ç«¯ä¹Ÿå¯ä»¥å…³é—­è¿æ¥äº†ã€‚<img src="/2022/11/18/TCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E5%92%8C%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B-%C2%A9-JavaGuide/tcp-waves-four-times.png" class=""> <img src="/2022/11/18/TCP%E4%B8%89%E6%AC%A1%E6%8F%A1%E6%89%8B%E5%92%8C%E5%9B%9B%E6%AC%A1%E6%8C%A5%E6%89%8B-%C2%A9-JavaGuide/tcp-waves-four-times1.png" class=""></li></ol><h3 id="ä¸ºä»€ä¹ˆè¦å››æ¬¡æŒ¥æ‰‹"><a href="#ä¸ºä»€ä¹ˆè¦å››æ¬¡æŒ¥æ‰‹" class="headerlink" title="ä¸ºä»€ä¹ˆè¦å››æ¬¡æŒ¥æ‰‹"></a>ä¸ºä»€ä¹ˆè¦å››æ¬¡æŒ¥æ‰‹</h3><p>TCP æ˜¯ <strong>å…¨åŒå·¥é€šä¿¡</strong>ï¼Œå¯ä»¥åŒå‘ä¼ è¾“æ•°æ®ï¼Œä»»ä½•ä¸€æ–¹éƒ½å¯ä»¥åœ¨æ•°æ®ä¼ é€ç»“æŸåå‘å‡ºè¿æ¥é‡Šæ”¾çš„é€šçŸ¥ï¼Œå¾…å¯¹æ–¹ç¡®è®¤åè¿›å…¥åŠå…³é—­çŠ¶æ€ï¼Œå½“å¦ä¸€æ–¹ä¹Ÿæ²¡æœ‰æ•°æ®å†å‘é€çš„æ—¶å€™ï¼Œåˆ™å‘å‡ºè¿æ¥é‡Šæ”¾é€šçŸ¥ï¼Œå¯¹æ–¹ç¡®è®¤åå°±å®Œå…¨å…³é—­äº† TCP è¿æ¥ã€‚<br>ä¸¾ä¸ªä¾‹å­ï¼šA å’Œ B æ‰“ç”µè¯ï¼Œé€šè¯å³å°†ç»“æŸåã€‚</p><ol><li><strong>ç¬¬ä¸€æ¬¡æŒ¥æ‰‹</strong> ï¼šA è¯´â€œæˆ‘æ²¡å•¥è¦è¯´çš„äº†â€</li><li><strong>ç¬¬äºŒæ¬¡æŒ¥æ‰‹</strong> ï¼šB å›ç­”â€œæˆ‘çŸ¥é“äº†â€ï¼Œä½†æ˜¯ B å¯èƒ½è¿˜ä¼šæœ‰è¦è¯´çš„è¯ï¼ŒA ä¸èƒ½è¦æ±‚ B è·Ÿç€è‡ªå·±çš„èŠ‚å¥ç»“æŸé€šè¯</li><li><strong>ç¬¬ä¸‰æ¬¡æŒ¥æ‰‹</strong> ï¼šäºæ˜¯ B å¯èƒ½åˆå·´æ‹‰å·´æ‹‰è¯´äº†ä¸€é€šï¼Œæœ€å B è¯´â€œæˆ‘è¯´å®Œäº†â€</li><li><strong>ç¬¬å››æ¬¡æŒ¥æ‰‹</strong> ï¼šA å›ç­”â€œçŸ¥é“äº†â€ï¼Œè¿™æ ·é€šè¯æ‰ç®—ç»“æŸã€‚</li></ol><h3 id="ä¸ºä»€ä¹ˆä¸èƒ½æŠŠæœåŠ¡å™¨å‘é€çš„-ACK-å’Œ-FIN-åˆå¹¶èµ·æ¥ï¼Œå˜æˆä¸‰æ¬¡æŒ¥æ‰‹"><a href="#ä¸ºä»€ä¹ˆä¸èƒ½æŠŠæœåŠ¡å™¨å‘é€çš„-ACK-å’Œ-FIN-åˆå¹¶èµ·æ¥ï¼Œå˜æˆä¸‰æ¬¡æŒ¥æ‰‹" class="headerlink" title="ä¸ºä»€ä¹ˆä¸èƒ½æŠŠæœåŠ¡å™¨å‘é€çš„ ACK å’Œ FIN åˆå¹¶èµ·æ¥ï¼Œå˜æˆä¸‰æ¬¡æŒ¥æ‰‹"></a>ä¸ºä»€ä¹ˆä¸èƒ½æŠŠæœåŠ¡å™¨å‘é€çš„ ACK å’Œ FIN åˆå¹¶èµ·æ¥ï¼Œå˜æˆä¸‰æ¬¡æŒ¥æ‰‹</h3><p>å› ä¸º<strong>æœåŠ¡å™¨æ”¶åˆ°å®¢æˆ·ç«¯æ–­å¼€è¿æ¥çš„è¯·æ±‚æ—¶ï¼Œå¯èƒ½è¿˜æœ‰ä¸€äº›æ•°æ®æ²¡æœ‰å‘å®Œ</strong>ï¼Œå…ˆå›å¤ ACKï¼Œè¡¨ç¤ºæ¥æ”¶åˆ°äº†æ–­å¼€è¿æ¥çš„è¯·æ±‚ï¼Œç­‰åˆ°æ•°æ®å‘å®Œä¹‹åå†å‘ FINï¼Œæ–­å¼€æœåŠ¡å™¨åˆ°å®¢æˆ·ç«¯çš„æ•°æ®ä¼ é€ã€‚</p><h3 id="å¦‚æœç¬¬äºŒæ¬¡æŒ¥æ‰‹æ—¶æœåŠ¡å™¨çš„-ACK-æ²¡æœ‰é€è¾¾å®¢æˆ·ç«¯ï¼Œä¼šæ€æ ·"><a href="#å¦‚æœç¬¬äºŒæ¬¡æŒ¥æ‰‹æ—¶æœåŠ¡å™¨çš„-ACK-æ²¡æœ‰é€è¾¾å®¢æˆ·ç«¯ï¼Œä¼šæ€æ ·" class="headerlink" title="å¦‚æœç¬¬äºŒæ¬¡æŒ¥æ‰‹æ—¶æœåŠ¡å™¨çš„ ACK æ²¡æœ‰é€è¾¾å®¢æˆ·ç«¯ï¼Œä¼šæ€æ ·"></a>å¦‚æœç¬¬äºŒæ¬¡æŒ¥æ‰‹æ—¶æœåŠ¡å™¨çš„ ACK æ²¡æœ‰é€è¾¾å®¢æˆ·ç«¯ï¼Œä¼šæ€æ ·</h3><p>å®¢æˆ·ç«¯æ²¡æœ‰æ”¶åˆ° ACK ç¡®è®¤ï¼Œ<strong>é‡æ–°å‘é€ FIN è¯·æ±‚</strong>ã€‚</p><h3 id="ä¸ºä»€ä¹ˆç¬¬å››æ¬¡æŒ¥æ‰‹å®¢æˆ·ç«¯éœ€è¦ç­‰å¾…-2-MSLï¼ˆæŠ¥æ–‡æ®µæœ€é•¿å¯¿å‘½ï¼‰æ—¶é—´åæ‰è¿›å…¥-CLOSED-çŠ¶æ€"><a href="#ä¸ºä»€ä¹ˆç¬¬å››æ¬¡æŒ¥æ‰‹å®¢æˆ·ç«¯éœ€è¦ç­‰å¾…-2-MSLï¼ˆæŠ¥æ–‡æ®µæœ€é•¿å¯¿å‘½ï¼‰æ—¶é—´åæ‰è¿›å…¥-CLOSED-çŠ¶æ€" class="headerlink" title="ä¸ºä»€ä¹ˆç¬¬å››æ¬¡æŒ¥æ‰‹å®¢æˆ·ç«¯éœ€è¦ç­‰å¾… 2*MSLï¼ˆæŠ¥æ–‡æ®µæœ€é•¿å¯¿å‘½ï¼‰æ—¶é—´åæ‰è¿›å…¥ CLOSED çŠ¶æ€"></a>ä¸ºä»€ä¹ˆç¬¬å››æ¬¡æŒ¥æ‰‹å®¢æˆ·ç«¯éœ€è¦ç­‰å¾… 2*MSLï¼ˆæŠ¥æ–‡æ®µæœ€é•¿å¯¿å‘½ï¼‰æ—¶é—´åæ‰è¿›å…¥ CLOSED çŠ¶æ€</h3><blockquote><p><strong>MSL(Maximum Segment Lifetime)</strong> : ä¸€ä¸ªç‰‡æ®µåœ¨ç½‘ç»œä¸­æœ€å¤§çš„å­˜æ´»æ—¶é—´ï¼Œ2MSL å°±æ˜¯ä¸€ä¸ªå‘é€å’Œä¸€ä¸ªå›å¤æ‰€éœ€çš„æœ€å¤§æ—¶é—´ï¼Œå¦‚æœç›´åˆ° 2MSLï¼ŒClient éƒ½æ²¡æœ‰å†æ¬¡æ”¶åˆ° FINï¼Œé‚£ä¹ˆ Client æ¨æ–­ ACK å·²ç»è¢«æˆåŠŸæ¥æ”¶ï¼Œåˆ™ç»“æŸ TCP è¿æ¥ã€‚</p></blockquote><p>ç¬¬å››æ¬¡æŒ¥æ‰‹æ—¶ï¼Œ<strong>å®¢æˆ·ç«¯å‘é€ç»™æœåŠ¡å™¨çš„ ACK å¯èƒ½ä¸¢å¤±</strong>ã€‚å¦‚æœæœåŠ¡ç«¯å› ä¸ºæŸäº›åŸå› è€Œæ²¡æœ‰æ”¶åˆ° ACK çš„è¯ï¼Œ<strong>æœåŠ¡ç«¯å°±ä¼šé‡å‘ FIN</strong>ï¼Œå¦‚æœå®¢æˆ·ç«¯åœ¨ 2*MSL çš„æ—¶é—´å†…æ”¶åˆ°äº† FINï¼Œå°±ä¼šé‡æ–°å‘é€ ACK å¹¶å†æ¬¡ç­‰å¾… 2MSLï¼Œé˜²æ­¢ Server æ²¡æœ‰æ”¶åˆ° ACK è€Œä¸æ–­é‡å‘ FINã€‚</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><ul><li>ã€Šè®¡ç®—æœºç½‘ç»œï¼ˆç¬¬ 7 ç‰ˆï¼‰ã€‹ </li><li>ã€Šå›¾è§£ HTTPã€‹ </li><li>TCP and UDP Tutorialï¼š<a href="https://www.9tut.com/tcp-and-udp-tutorial">https://www.9tut.com/tcp-and-udp-tutorial</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> è®¡ç®—æœºç½‘ç»œ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> è®¡ç®—æœºç½‘ç»œ </tag>
            
            <tag> TCP </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HTTP Â© CS-Notes</title>
      <link href="/2022/11/18/HTTP-%C2%A9-CS-Notes/"/>
      <url>/2022/11/18/HTTP-%C2%A9-CS-Notes/</url>
      
        <content type="html"><![CDATA[<h1 id="HTTP"><a href="#HTTP" class="headerlink" title="HTTP"></a>HTTP</h1><h2 id="åŸºç¡€å…¥é—¨"><a href="#åŸºç¡€å…¥é—¨" class="headerlink" title="åŸºç¡€å…¥é—¨"></a>åŸºç¡€å…¥é—¨</h2><h3 id="HTTP-1"><a href="#HTTP-1" class="headerlink" title="HTTP"></a>HTTP</h3><p>HTTP åè®®ï¼ˆHyperText Transfer Protocolï¼Œ<strong>è¶…æ–‡æœ¬ä¼ è¾“åè®®</strong>ï¼‰ï¼šæ˜¯å®¢æˆ·ç«¯æµè§ˆå™¨æˆ–å…¶ä»–ç¨‹åºä¸WebæœåŠ¡å™¨ä¹‹é—´çš„åº”ç”¨å±‚é€šä¿¡åè®® ã€‚</p><h3 id="è¯·æ±‚å’Œå“åº”æŠ¥æ–‡"><a href="#è¯·æ±‚å’Œå“åº”æŠ¥æ–‡" class="headerlink" title="è¯·æ±‚å’Œå“åº”æŠ¥æ–‡"></a>è¯·æ±‚å’Œå“åº”æŠ¥æ–‡</h3><p>å®¢æˆ·ç«¯å‘é€ä¸€ä¸ªè¯·æ±‚æŠ¥æ–‡ç»™æœåŠ¡å™¨ï¼ŒæœåŠ¡å™¨æ ¹æ®è¯·æ±‚æŠ¥æ–‡ä¸­çš„ä¿¡æ¯è¿›è¡Œå¤„ç†ï¼Œå¹¶å°†å¤„ç†ç»“æœæ”¾å…¥å“åº”æŠ¥æ–‡ä¸­è¿”å›ç»™å®¢æˆ·ç«¯ã€‚<br />è¯·æ±‚æŠ¥æ–‡ç»“æ„ï¼š</p><ul><li><p>ç¬¬ä¸€è¡ŒåŒ…å«<strong>è¯·æ±‚æ–¹æ³•ã€URLã€åè®®ç‰ˆæœ¬</strong>ï¼›</p></li><li><p>æ¥ä¸‹æ¥çš„å¤šè¡Œéƒ½æ˜¯<strong>è¯·æ±‚é¦–éƒ¨ Header</strong>ï¼Œæ¯ä¸ªé¦–éƒ¨éƒ½æœ‰ä¸€ä¸ªé¦–éƒ¨åç§°ï¼Œä»¥åŠå¯¹åº”çš„å€¼ï¼›</p></li><li><p>ä¸€ä¸ª<strong>ç©ºè¡Œ</strong>ç”¨æ¥åˆ†éš”é¦–éƒ¨å’Œå†…å®¹ä¸»ä½“ Bodyï¼›</p></li><li><p>æœ€åæ˜¯è¯·æ±‚çš„<strong>å†…å®¹ä¸»ä½“</strong>ï¼›</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">GET http://www.example.com/ HTTP/1.1</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.9,en;q=0.8</span><br><span class="line">Cache-Control: max-age=0</span><br><span class="line">Host: www.example.com</span><br><span class="line">If-Modified-Since: Thu, 17 Oct 2019 07:18:26 GMT</span><br><span class="line">If-None-Match: &quot;3147526947+gzip&quot;</span><br><span class="line">Proxy-Connection: keep-alive</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">User-Agent: Mozilla/5.0 xxx</span><br><span class="line"></span><br><span class="line">param1=1&amp;param2=2</span><br></pre></td></tr></table></figure><p>å“åº”æŠ¥æ–‡ç»“æ„ï¼š</p></li><li><p>ç¬¬ä¸€è¡ŒåŒ…å«<strong>åè®®ç‰ˆæœ¬ã€çŠ¶æ€ç ä»¥åŠæè¿°</strong>ï¼Œæœ€å¸¸è§çš„æ˜¯ 200 OK â€”&gt; è¡¨ç¤ºè¯·æ±‚æˆåŠŸï¼›</p></li><li><p>æ¥ä¸‹æ¥å¤šè¡Œä¹Ÿæ˜¯<strong>é¦–éƒ¨å†…å®¹</strong>ï¼›</p></li><li><p>ä¸€ä¸ª<strong>ç©ºè¡Œ</strong>åˆ†éš”é¦–éƒ¨å’Œå†…å®¹ä¸»ä½“ï¼›</p></li><li><p>æœ€åæ˜¯å“åº”çš„<strong>å†…å®¹ä¸»ä½“</strong>ï¼›</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 200 OK</span><br><span class="line">Age: 529651</span><br><span class="line">Cache-Control: max-age=604800</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Content-Encoding: gzip</span><br><span class="line">Content-Length: 648</span><br><span class="line">Content-Type: text/html; charset=UTF-8</span><br><span class="line">Date: Mon, 02 Nov 2020 17:53:39 GMT</span><br><span class="line">Etag: &quot;3147526947+ident+gzip&quot;</span><br><span class="line">Expires: Mon, 09 Nov 2020 17:53:39 GMT</span><br><span class="line">Keep-Alive: timeout=4</span><br><span class="line">Last-Modified: Thu, 17 Oct 2019 07:18:26 GMT</span><br><span class="line">Proxy-Connection: keep-alive</span><br><span class="line">Server: ECS (sjc/16DF)</span><br><span class="line">Vary: Accept-Encoding</span><br><span class="line">X-Cache: HIT</span><br><span class="line"></span><br><span class="line">&lt;!doctype html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;title&gt;Example Domain&lt;/title&gt;</span><br><span class="line">// çœç•¥... </span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure></li></ul><h3 id="URL"><a href="#URL" class="headerlink" title="URL"></a>URL</h3><p>HTTP ä½¿ç”¨ URLï¼ˆ <strong>U</strong>niform <strong>R</strong>esource <strong>L</strong>ocatorï¼Œ<strong>ç»Ÿä¸€èµ„æºå®šä½ç¬¦</strong>ï¼‰æ¥å®šä½èµ„æºï¼Œå®ƒæ˜¯ Â URIï¼ˆ<strong>U</strong>niform <strong>R</strong>esource <strong>I</strong>dentifierï¼Œ<strong>ç»Ÿä¸€èµ„æºæ ‡è¯†ç¬¦</strong>ï¼‰çš„å­é›†ï¼ŒURL åœ¨ URI çš„åŸºç¡€ä¸Šå¢åŠ äº†å®šä½èƒ½åŠ›ã€‚URI é™¤äº†åŒ…å« URLï¼Œè¿˜åŒ…å« URNï¼ˆUniform Resource Nameï¼Œ<strong>ç»Ÿä¸€èµ„æºåç§°</strong>ï¼‰ï¼Œå®ƒåªæ˜¯ç”¨æ¥<strong>å®šä¹‰ä¸€ä¸ªèµ„æºçš„åç§°</strong>ï¼Œå¹¶ä¸å…·å¤‡å®šä½è¯¥èµ„æºçš„èƒ½åŠ›ï¼Œå¦‚ urn:isbn:0451450523 ç”¨æ¥å®šä¹‰ä¸€ä¸ªä¹¦ç±åç§°ï¼Œä½†æ˜¯å´æ²¡æœ‰è¡¨ç¤ºæ€ä¹ˆæ‰¾åˆ°è¿™æœ¬ä¹¦ã€‚<br /><img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/8441b2c4-dca7-4d6b-8efb-f22efccaf331.png#crop=0&crop=0&crop=1&crop=1&height=262&id=Bjxju&originHeight=403&originWidth=762&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=&width=496"></p><ul><li><a href="https://zh.wikipedia.org/wiki/%E7%BB%9F%E4%B8%80%E8%B5%84%E6%BA%90%E6%A0%87%E5%BF%97%E7%AC%A6">wikipediaï¼šç»Ÿä¸€èµ„æºæ ‡å¿—ç¬¦</a></li><li><a href="https://en.wikipedia.org/wiki/URL">wikipedia: URL</a></li><li><a href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec3.html#sec3.2.2">rfc2616ï¼š3.2.2 http URL</a></li><li>What is the difference between a URI, a URL and a URN?</li></ul><h2 id="HTTPæ–¹æ³•"><a href="#HTTPæ–¹æ³•" class="headerlink" title="HTTPæ–¹æ³•"></a>HTTPæ–¹æ³•</h2><p>å®¢æˆ·ç«¯å‘é€çš„<strong>è¯·æ±‚æŠ¥æ–‡</strong>ç¬¬ä¸€è¡Œä¸º<strong>è¯·æ±‚è¡Œ</strong>ï¼ŒåŒ…å«äº†æ–¹æ³•å­—æ®µã€‚</p><h3 id="GET"><a href="#GET" class="headerlink" title="GET"></a>GET</h3><blockquote><p>è·å–èµ„æº</p></blockquote><p>åœ¨ç½‘ç»œè¯·æ±‚ä¸­ï¼Œç»å¤§éƒ¨åˆ†ä½¿ç”¨çš„æ˜¯ GET æ–¹æ³•ã€‚</p><h3 id="HEAD"><a href="#HEAD" class="headerlink" title="HEAD"></a>HEAD</h3><blockquote><p>è·å–æŠ¥æ–‡é¦–éƒ¨</p></blockquote><p>å’Œ GET æ–¹æ³•ç±»ä¼¼ï¼Œä½†<strong>ä¸è¿”å›æŠ¥æ–‡å®ä½“ä¸»ä½“éƒ¨åˆ†</strong>ï¼Œä¸»è¦ç”¨äºç¡®è®¤ URL çš„æœ‰æ•ˆæ€§ä»¥åŠèµ„æºæ›´æ–°çš„æ—¥æœŸæ—¶é—´ç­‰ã€‚</p><h3 id="POST"><a href="#POST" class="headerlink" title="POST"></a>POST</h3><blockquote><p>ä¼ è¾“å®ä½“ä¸»ä½“</p></blockquote><p>POST ä¸»è¦ç”¨æ¥ä¼ è¾“æ•°æ®ï¼Œè€Œ GET ä¸»è¦ç”¨æ¥è·å–èµ„æºã€‚</p><h3 id="PUT"><a href="#PUT" class="headerlink" title="PUT"></a>PUT</h3><blockquote><p>ä¸Šä¼ æ–‡ä»¶</p></blockquote><p>ç”±äºè‡ªèº«ä¸å¸¦éªŒè¯æœºåˆ¶ï¼Œä»»ä½•äººéƒ½å¯ä»¥ä¸Šä¼ æ–‡ä»¶ï¼Œå› æ­¤<strong>å­˜åœ¨å®‰å…¨æ€§é—®é¢˜ï¼Œä¸€èˆ¬ä¸ä½¿ç”¨è¯¥æ–¹æ³•</strong>ã€‚</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">PUT /new.html HTTP/1.1</span><br><span class="line">Host: example.com</span><br><span class="line">Content-type: text/html</span><br><span class="line">Content-length: 16</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>New File<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="PATCH"><a href="#PATCH" class="headerlink" title="PATCH"></a>PATCH</h3><blockquote><p>å¯¹èµ„æºè¿›è¡Œéƒ¨åˆ†ä¿®æ”¹</p></blockquote><p>PATCH ç”¨äºä¿®æ”¹èµ„æºï¼Œå…è®¸éƒ¨åˆ†ä¿®æ”¹ï¼ŒPUT ä¹Ÿèƒ½ç”¨äºä¿®æ”¹èµ„æºï¼Œä½†åªèƒ½å®Œå…¨æ›¿ä»£åŸå§‹èµ„æº ã€‚</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">PATCH /file.txt HTTP/1.1</span><br><span class="line">Host: www.example.com</span><br><span class="line">Content-Type: application/example</span><br><span class="line">If-Match: &quot;e0023aa4e&quot;</span><br><span class="line">Content-Length: 100</span><br><span class="line"></span><br><span class="line">[description of changes]</span><br></pre></td></tr></table></figure><h3 id="DELETE"><a href="#DELETE" class="headerlink" title="DELETE"></a>DELETE</h3><blockquote><p>åˆ é™¤æ–‡ä»¶</p></blockquote><p>ä¸ PUT åŠŸèƒ½ç›¸åï¼Œå¹¶åŒæ ·ä¸å¸¦éªŒè¯æœºåˆ¶ã€‚</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DELETE /file.html HTTP/1.1</span><br></pre></td></tr></table></figure><h3 id="OPTIONS"><a href="#OPTIONS" class="headerlink" title="OPTIONS"></a>OPTIONS</h3><blockquote><p>æŸ¥è¯¢æ”¯æŒçš„æ–¹æ³•</p></blockquote><p>æŸ¥è¯¢æŒ‡å®šçš„URL èƒ½å¤Ÿæ”¯æŒçš„æ–¹æ³•ã€‚ä¼šè¿”å› <code>Allow: GET, POST, HEAD, OPTIONS</code> ç­‰è¿™æ ·çš„å†…å®¹ã€‚</p><h3 id="CONNECT"><a href="#CONNECT" class="headerlink" title="CONNECT"></a>CONNECT</h3><blockquote><p>è¦æ±‚åœ¨ä¸ä»£ç†æœåŠ¡å™¨é€šä¿¡æ—¶å»ºç«‹éš§é“</p></blockquote><p>ä½¿ç”¨ <strong>SSL</strong>ï¼ˆSecure Sockets Layerï¼Œå®‰å…¨å¥—æ¥å±‚ï¼‰å’Œ <strong>TLS</strong>ï¼ˆTransport Layer Securityï¼Œä¼ è¾“å±‚å®‰å…¨ï¼‰åè®®æŠŠé€šä¿¡å†…å®¹<strong>åŠ å¯†</strong>åç»ç½‘ç»œéš§é“ä¼ è¾“ã€‚</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CONNECT www.example.com:443 HTTP/1.1</span><br></pre></td></tr></table></figure><p><img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/dc00f70e-c5c8-4d20-baf1-2d70014a97e3.jpg#crop=0&crop=0&crop=1&crop=1&id=R6tDA&originHeight=185&originWidth=654&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=&width="></p><h3 id="TRACE"><a href="#TRACE" class="headerlink" title="TRACE"></a>TRACE</h3><blockquote><p>è¿½è¸ªè·¯å¾„</p></blockquote><p>æœåŠ¡å™¨å°†<strong>é€šä¿¡è·¯å¾„</strong>è¿”å›ç»™å®¢æˆ·ç«¯ã€‚å‘é€è¯·æ±‚æ—¶ï¼Œåœ¨ Max-Forwards é¦–éƒ¨å­—æ®µä¸­å¡«å…¥æ•°å€¼ï¼Œæ¯ç»è¿‡ä¸€ä¸ªæœåŠ¡å™¨å°±ä¼šå‡ 1ï¼Œå½“æ•°å€¼ä¸º 0 æ—¶å°±åœæ­¢ä¼ è¾“ã€‚é€šå¸¸ä¸ä¼šä½¿ç”¨ TRACEï¼Œå¹¶ä¸”å®ƒå®¹æ˜“å—åˆ° XST æ”»å‡»ï¼ˆCross-Site Tracingï¼Œè·¨ç«™è¿½è¸ªï¼‰ã€‚</p><ul><li><a href="https://www.w3.org/Protocols/rfc2616/rfc2616-sec9.html">rfc2616ï¼š9 Method Definitions</a></li></ul><h3 id="æµè§ˆå™¨å…¼å®¹æ€§"><a href="#æµè§ˆå™¨å…¼å®¹æ€§" class="headerlink" title="æµè§ˆå™¨å…¼å®¹æ€§"></a>æµè§ˆå™¨å…¼å®¹æ€§</h3><table><thead><tr><th>**<strong>desktop</strong></th><th></th><th></th><th></th><th></th><th><strong>mobile</strong></th><th></th><th></th><th></th><th></th><th></th><th><br /></th></tr></thead><tbody><tr><td><br /></td><td><strong>Chrome</strong></td><td><strong>Edge</strong></td><td><strong>Firefox</strong></td><td><strong>Opera</strong></td><td><strong>Safari</strong></td><td><strong>Chrome Android</strong></td><td><strong>Firefox for Android</strong></td><td><strong>Opera Android</strong></td><td><strong>Safari on iOS</strong></td><td><strong>Samsung Internet</strong></td><td><strong>WebView Android</strong></td></tr><tr><td><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Methods/CONNECT">CONNECT</a></td><td><strong>Yes</strong><br /><strong>Toggle history</strong></td><td><strong>12</strong><br /><strong>Toggle history</strong></td><td><strong>Yes</strong><br /><strong>Toggle history</strong></td><td><strong>Yes</strong><br /><strong>Toggle history</strong></td><td><strong>Yes</strong><br /><strong>Toggle history</strong></td><td><strong>Yes</strong><br /><strong>Toggle history</strong></td><td><strong>Yes</strong><br /><strong>Toggle history</strong></td><td><strong>Yes</strong><br /><strong>Toggle history</strong></td><td><strong>Yes</strong><br /><strong>Toggle history</strong></td><td><strong>Yes</strong><br /><strong>Toggle history</strong></td><td><strong>Yes</strong><br /><strong>Toggle history</strong></td></tr><tr><td><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Methods/DELETE">DELETE</a></td><td><strong>Yes</strong><br /><strong>Toggle history</strong></td><td><strong>12</strong><br /><strong>Toggle history</strong></td><td><strong>Yes</strong><br /><strong>Toggle history</strong></td><td><strong>Yes</strong><br /><strong>Toggle history</strong></td><td><strong>Yes</strong><br /><strong>Toggle history</strong></td><td><strong>Yes</strong><br /><strong>Toggle history</strong></td><td><strong>Yes</strong><br /><strong>Toggle history</strong></td><td><strong>Yes</strong><br /><strong>Toggle history</strong></td><td><strong>Yes</strong><br /><strong>Toggle history</strong></td><td><strong>Yes</strong><br /><strong>Toggle history</strong></td><td><strong>Yes</strong><br /><strong>Toggle history</strong></td></tr><tr><td><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Methods/GET">GET</a></td><td><strong>Yes</strong><br /><strong>Toggle history</strong></td><td><strong>12</strong><br /><strong>Toggle history</strong></td><td><strong>Yes</strong><br /><strong>Toggle history</strong></td><td><strong>Yes</strong><br /><strong>Toggle history</strong></td><td><strong>Yes</strong><br /><strong>Toggle history</strong></td><td><strong>Yes</strong><br /><strong>Toggle history</strong></td><td><strong>Yes</strong><br /><strong>Toggle history</strong></td><td><strong>Yes</strong><br /><strong>Toggle history</strong></td><td><strong>Yes</strong><br /><strong>Toggle history</strong></td><td><strong>Yes</strong><br /><strong>Toggle history</strong></td><td><strong>Yes</strong><br /><strong>Toggle history</strong></td></tr><tr><td><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Methods/HEAD">HEAD</a></td><td><strong>Yes</strong><br /><strong>Toggle history</strong></td><td><strong>12</strong><br /><strong>Toggle history</strong></td><td><strong>Yes</strong><br /><strong>Toggle history</strong></td><td><strong>Yes</strong><br /><strong>Toggle history</strong></td><td><strong>Yes</strong><br /><strong>Toggle history</strong></td><td><strong>Yes</strong><br /><strong>Toggle history</strong></td><td><strong>Yes</strong><br /><strong>Toggle history</strong></td><td><strong>Yes</strong><br /><strong>Toggle history</strong></td><td><strong>Yes</strong><br /><strong>Toggle history</strong></td><td><strong>Yes</strong><br /><strong>Toggle history</strong></td><td><strong>Yes</strong><br /><strong>Toggle history</strong></td></tr><tr><td><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Methods/OPTIONS">OPTIONS</a></td><td><strong>Yes</strong><br /><strong>Toggle history</strong></td><td><strong>12</strong><br /><strong>Toggle history</strong></td><td><strong>Yes</strong><br /><strong>Toggle history</strong></td><td><strong>Yes</strong><br /><strong>Toggle history</strong></td><td><strong>Yes</strong><br /><strong>Toggle history</strong></td><td><strong>Yes</strong><br /><strong>Toggle history</strong></td><td><strong>Yes</strong><br /><strong>Toggle history</strong></td><td><strong>Yes</strong><br /><strong>Toggle history</strong></td><td><strong>Yes</strong><br /><strong>Toggle history</strong></td><td><strong>Yes</strong><br /><strong>Toggle history</strong></td><td><strong>Yes</strong><br /><strong>Toggle history</strong></td></tr><tr><td><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Methods/POST">POST</a></td><td><strong>Yes</strong><br /><strong>Toggle history</strong></td><td><strong>12</strong><br /><strong>Toggle history</strong></td><td><strong>Yes</strong><br /><strong>Toggle history</strong></td><td><strong>Yes</strong><br /><strong>Toggle history</strong></td><td><strong>Yes</strong><br /><strong>Toggle history</strong></td><td><strong>Yes</strong><br /><strong>Toggle history</strong></td><td><strong>Yes</strong><br /><strong>Toggle history</strong></td><td><strong>Yes</strong><br /><strong>Toggle history</strong></td><td><strong>Yes</strong><br /><strong>Toggle history</strong></td><td><strong>Yes</strong><br /><strong>Toggle history</strong></td><td><strong>Yes</strong><br /><strong>Toggle history</strong></td></tr><tr><td><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Methods/PUT">PUT</a></td><td><strong>Yes</strong><br /><strong>Toggle history</strong></td><td><strong>12</strong><br /><strong>Toggle history</strong></td><td><strong>Yes</strong><br /><strong>Toggle history</strong></td><td><strong>Yes</strong><br /><strong>Toggle history</strong></td><td><strong>Yes</strong><br /><strong>Toggle history</strong></td><td><strong>Yes</strong><br /><strong>Toggle history</strong></td><td><strong>Yes</strong><br /><strong>Toggle history</strong></td><td><strong>Yes</strong><br /><strong>Toggle history</strong></td><td><strong>Yes</strong><br /><strong>Toggle history</strong></td><td><strong>Yes</strong><br /><strong>Toggle history</strong></td><td><strong>Yes</strong><br /><strong>Toggle history</strong></td></tr><tr><td><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Methods/TRACE">TRACE</a></td><td><strong>?</strong><br /><strong>Toggle history</strong></td><td><strong>?</strong><br /><strong>Toggle history</strong></td><td><strong>?</strong><br /><strong>Toggle history</strong></td><td><strong>?</strong><br /><strong>Toggle history</strong></td><td><strong>?</strong><br /><strong>Toggle history</strong></td><td><strong>?</strong><br /><strong>Toggle history</strong></td><td><strong>?</strong><br /><strong>Toggle history</strong></td><td><strong>?</strong><br /><strong>Toggle history</strong></td><td><strong>?</strong><br /><strong>Toggle history</strong></td><td><strong>?</strong><br /><strong>Toggle history</strong></td><td><strong>?</strong></td></tr></tbody></table><h2 id="HTTPçŠ¶æ€ç "><a href="#HTTPçŠ¶æ€ç " class="headerlink" title="HTTPçŠ¶æ€ç "></a><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status">HTTPçŠ¶æ€ç </a></h2><p>æœåŠ¡å™¨è¿”å›çš„ Â <strong>å“åº”æŠ¥æ–‡</strong> Â ä¸­ç¬¬ä¸€è¡Œä¸ºçŠ¶æ€è¡Œï¼ŒåŒ…å«äº†<strong>çŠ¶æ€ç åŠåŸå› çŸ­è¯­</strong>ï¼Œç”¨æ¥å‘ŠçŸ¥å®¢æˆ·ç«¯è¯·æ±‚çš„ç»“æœã€‚</p><table><thead><tr><th>çŠ¶æ€ç </th><th>ç±»åˆ«</th><th>å«ä¹‰</th></tr></thead><tbody><tr><td>1XX</td><td>Informationalï¼ˆä¿¡æ¯æ€§çŠ¶æ€ç ï¼‰</td><td>æ¥æ”¶çš„è¯·æ±‚æ­£åœ¨å¤„ç†</td></tr><tr><td>2XX</td><td>Successï¼ˆæˆåŠŸçŠ¶æ€ç ï¼‰</td><td>è¯·æ±‚æ­£å¸¸å¤„ç†å®Œæ¯•</td></tr><tr><td>3XX</td><td>Redirectionï¼ˆé‡å®šå‘çŠ¶æ€ç ï¼‰</td><td>éœ€è¦è¿›è¡Œé™„åŠ æ“ä½œä»¥å®Œæˆè¯·æ±‚</td></tr><tr><td>4XX</td><td>Client Errorï¼ˆå®¢æˆ·ç«¯é”™è¯¯çŠ¶æ€ç ï¼‰</td><td>æœåŠ¡å™¨æ— æ³•å¤„ç†è¯·æ±‚</td></tr><tr><td>5XX</td><td>Server Errorï¼ˆæœåŠ¡å™¨é”™è¯¯çŠ¶æ€ç ï¼‰</td><td>æœåŠ¡å™¨å¤„ç†è¯·æ±‚å‡ºé”™</td></tr></tbody></table><h3 id="1XX-ä¿¡æ¯å“åº”"><a href="#1XX-ä¿¡æ¯å“åº”" class="headerlink" title="1XX ä¿¡æ¯å“åº”"></a>1XX ä¿¡æ¯å“åº”</h3><ul><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/100">100 Continue</a> è¿™ä¸ªä¸´æ—¶å“åº”è¡¨æ˜ï¼Œè¿„ä»Šä¸ºæ­¢çš„æ‰€æœ‰å†…å®¹éƒ½æ˜¯å¯è¡Œçš„ï¼Œå®¢æˆ·ç«¯åº”è¯¥ç»§ç»­è¯·æ±‚ï¼Œå¦‚æœå·²ç»å®Œæˆï¼Œåˆ™å¿½ç•¥å®ƒã€‚</li><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/101">101 Switching Protocols</a>  è¯¥ä»£ç æ˜¯å“åº”å®¢æˆ·ç«¯çš„ <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Upgrade">Upgrade(en-US)</a> è¯·æ±‚å¤´å‘é€çš„ï¼ŒæŒ‡æ˜æœåŠ¡å™¨å³å°†åˆ‡æ¢çš„åè®®ã€‚</li><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/102">102 Processing</a> (<a href="https://developer.mozilla.org/zh-CN/docs/Glossary/WebDAV">WebDAV</a>)  æ­¤ä»£ç è¡¨ç¤ºæœåŠ¡å™¨å·²æ”¶åˆ°å¹¶æ­£åœ¨å¤„ç†è¯¥è¯·æ±‚ï¼Œä½†å½“å‰æ²¡æœ‰å“åº”å¯ç”¨ã€‚</li><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/103">103 Early Hints</a> æ­¤çŠ¶æ€ä»£ç ä¸»è¦ç”¨äºä¸ <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Link">Link</a> é“¾æ¥å¤´ä¸€èµ·ä½¿ç”¨ï¼Œä»¥å…è®¸ç”¨æˆ·ä»£ç†åœ¨æœåŠ¡å™¨å‡†å¤‡å“åº”é˜¶æ®µæ—¶å¼€å§‹é¢„åŠ è½½ <a href="https://developer.mozilla.org/zh-CN/docs/Web/HTML/Link_types/preload">preloading</a> èµ„æºã€‚</li></ul><h3 id="2XX-æˆåŠŸå“åº”"><a href="#2XX-æˆåŠŸå“åº”" class="headerlink" title="2XX æˆåŠŸå“åº”"></a>2XX æˆåŠŸå“åº”</h3><ul><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/200">200 OK</a> è¯·æ±‚æˆåŠŸã€‚æˆåŠŸçš„å«ä¹‰å–å†³äº HTTP æ–¹æ³•ï¼š<ul><li>GET: èµ„æºå·²è¢«æå–å¹¶åœ¨æ¶ˆæ¯æ­£æ–‡ä¸­ä¼ è¾“ã€‚</li><li>HEAD: å®ä½“æ ‡å¤´ä½äºæ¶ˆæ¯æ­£æ–‡ä¸­ã€‚</li><li>PUT or POST: æè¿°åŠ¨ä½œç»“æœçš„èµ„æºåœ¨æ¶ˆæ¯ä½“ä¸­ä¼ è¾“ã€‚</li><li>TRACE: æ¶ˆæ¯æ­£æ–‡åŒ…å«æœåŠ¡å™¨æ”¶åˆ°çš„è¯·æ±‚æ¶ˆæ¯ã€‚</li></ul></li><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/201">201 Created</a>  è¯¥è¯·æ±‚å·²æˆåŠŸï¼Œå¹¶å› æ­¤åˆ›å»ºäº†ä¸€ä¸ªæ–°çš„èµ„æºã€‚è¿™é€šå¸¸æ˜¯åœ¨ POST è¯·æ±‚ï¼Œæˆ–æ˜¯æŸäº› PUT è¯·æ±‚ä¹‹åè¿”å›çš„å“åº”ã€‚</li><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/202">202 Accepted</a> è¯·æ±‚å·²ç»æ¥æ”¶åˆ°ï¼Œä½†è¿˜æœªå“åº”ï¼Œæ²¡æœ‰ç»“æœã€‚æ„å‘³ç€ä¸ä¼šæœ‰ä¸€ä¸ªå¼‚æ­¥çš„å“åº”å»è¡¨æ˜å½“å‰è¯·æ±‚çš„ç»“æœï¼Œé¢„æœŸå¦å¤–çš„è¿›ç¨‹å’ŒæœåŠ¡å»å¤„ç†è¯·æ±‚ï¼Œæˆ–è€…æ‰¹å¤„ç†ã€‚</li><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/203">203 Non-Authoritative Information</a>  æœåŠ¡å™¨å·²æˆåŠŸå¤„ç†äº†è¯·æ±‚ï¼Œä½†è¿”å›çš„å®ä½“å¤´éƒ¨å…ƒä¿¡æ¯ä¸æ˜¯åœ¨åŸå§‹æœåŠ¡å™¨ä¸Šæœ‰æ•ˆçš„ç¡®å®šé›†åˆï¼Œè€Œæ˜¯æ¥è‡ªæœ¬åœ°æˆ–è€…ç¬¬ä¸‰æ–¹çš„æ‹·è´ã€‚å½“å‰çš„ä¿¡æ¯å¯èƒ½æ˜¯åŸå§‹ç‰ˆæœ¬çš„å­é›†æˆ–è€…è¶…é›†ã€‚ä¾‹å¦‚ï¼ŒåŒ…å«èµ„æºçš„å…ƒæ•°æ®å¯èƒ½å¯¼è‡´åŸå§‹æœåŠ¡å™¨çŸ¥é“å…ƒä¿¡æ¯çš„è¶…é›†ã€‚ä½¿ç”¨æ­¤çŠ¶æ€ç ä¸æ˜¯å¿…é¡»çš„ï¼Œè€Œä¸”åªæœ‰åœ¨å“åº”ä¸ä½¿ç”¨æ­¤çŠ¶æ€ç ä¾¿ä¼šè¿”å›200 OKçš„æƒ…å†µä¸‹æ‰æ˜¯åˆé€‚çš„ã€‚</li><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/204">204 No Content</a> å¯¹äºè¯¥è¯·æ±‚æ²¡æœ‰çš„å†…å®¹å¯å‘é€ï¼Œä½†å¤´éƒ¨å­—æ®µå¯èƒ½æœ‰ç”¨ã€‚ç”¨æˆ·ä»£ç†å¯èƒ½ä¼šç”¨æ­¤æ—¶è¯·æ±‚å¤´éƒ¨ä¿¡æ¯æ¥æ›´æ–°åŸæ¥èµ„æºçš„å¤´éƒ¨ç¼“å­˜å­—æ®µã€‚</li><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/205">205 Reset Content</a>  å‘Šè¯‰ç”¨æˆ·ä»£ç†é‡ç½®å‘é€æ­¤è¯·æ±‚çš„æ–‡æ¡£ã€‚</li><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/206">206 Partial Content</a> å½“ä»å®¢æˆ·ç«¯å‘é€<a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Range">Range</a>èŒƒå›´æ ‡å¤´ä»¥åªè¯·æ±‚èµ„æºçš„ä¸€éƒ¨åˆ†æ—¶ï¼Œå°†ä½¿ç”¨æ­¤å“åº”ä»£ç ã€‚</li><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/207">207 Multi-Status</a> (<a href="https://developer.mozilla.org/zh-CN/docs/Glossary/WebDAV">WebDAV</a>)  å¯¹äºå¤šä¸ªçŠ¶æ€ä»£ç éƒ½å¯èƒ½åˆé€‚çš„æƒ…å†µï¼Œä¼ è¾“æœ‰å…³å¤šä¸ªèµ„æºçš„ä¿¡æ¯ã€‚</li><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/208">208 Already Reported</a> (<a href="https://developer.mozilla.org/zh-CN/docs/Glossary/WebDAV">WebDAV</a>) åœ¨ DAV é‡Œé¢ä½¿ç”¨ <a href="dav:propstat">dav:propstat</a> å“åº”å…ƒç´ ä»¥é¿å…é‡å¤æšä¸¾å¤šä¸ªç»‘å®šçš„å†…éƒ¨æˆå‘˜åˆ°åŒä¸€ä¸ªé›†åˆã€‚</li><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Status/226">226 IM Used</a> (<a href="https://datatracker.ietf.org/doc/html/rfc3229">HTTP Delta encoding</a>) æœåŠ¡å™¨å·²ç»å®Œæˆäº†å¯¹èµ„æºçš„GETè¯·æ±‚ï¼Œå¹¶ä¸”å“åº”æ˜¯å¯¹å½“å‰å®ä¾‹åº”ç”¨çš„ä¸€ä¸ªæˆ–å¤šä¸ªå®ä¾‹æ“ä½œç»“æœçš„è¡¨ç¤ºã€‚</li></ul><h3 id="3XX-é‡å®šå‘æ¶ˆæ¯"><a href="#3XX-é‡å®šå‘æ¶ˆæ¯" class="headerlink" title="3XX é‡å®šå‘æ¶ˆæ¯"></a>3XX é‡å®šå‘æ¶ˆæ¯</h3><ul><li><strong>301 Moved Permanently</strong> Â ï¼šæ°¸ä¹…æ€§é‡å®šå‘ </li><li><strong>302 Found</strong> Â ï¼šä¸´æ—¶æ€§é‡å®šå‘ </li><li><strong>303 See Other</strong> Â ï¼šå’Œ 302 æœ‰ç€ç›¸åŒçš„åŠŸèƒ½ï¼Œä½†æ˜¯ 303 æ˜ç¡®è¦æ±‚å®¢æˆ·ç«¯åº”è¯¥é‡‡ç”¨ GET æ–¹æ³•è·å–èµ„æºã€‚ </li><li>æ³¨ï¼šè™½ç„¶ HTTP åè®®è§„å®š 301ã€302 çŠ¶æ€ä¸‹é‡å®šå‘æ—¶ä¸å…è®¸æŠŠ POST æ–¹æ³•æ”¹æˆ GET æ–¹æ³•ï¼Œä½†æ˜¯å¤§å¤šæ•°æµè§ˆå™¨éƒ½ä¼šåœ¨ 301ã€302 å’Œ 303 çŠ¶æ€ä¸‹çš„é‡å®šå‘æŠŠ POST æ–¹æ³•æ”¹æˆ GET æ–¹æ³•ã€‚ </li><li><strong>304 Not Modified</strong> Â ï¼šå¦‚æœè¯·æ±‚æŠ¥æ–‡é¦–éƒ¨åŒ…å«ä¸€äº›æ¡ä»¶ï¼Œä¾‹å¦‚ï¼šIf-Matchï¼ŒIf-Modified-Sinceï¼ŒIf-None-Matchï¼ŒIf-Rangeï¼ŒIf-Unmodified-Sinceï¼Œå¦‚æœä¸æ»¡è¶³æ¡ä»¶ï¼Œåˆ™æœåŠ¡å™¨ä¼šè¿”å› 304 çŠ¶æ€ç ã€‚ </li><li><strong>307 Temporary Redirect</strong> Â ï¼šä¸´æ—¶é‡å®šå‘ï¼Œä¸ 302 çš„å«ä¹‰ç±»ä¼¼ï¼Œä½†æ˜¯ 307 è¦æ±‚æµè§ˆå™¨ä¸ä¼šæŠŠé‡å®šå‘è¯·æ±‚çš„ POST æ–¹æ³•æ”¹æˆ GET æ–¹æ³•ã€‚</li></ul><h3 id="4XX-å®¢æˆ·ç«¯é”™è¯¯å“åº”"><a href="#4XX-å®¢æˆ·ç«¯é”™è¯¯å“åº”" class="headerlink" title="4XX å®¢æˆ·ç«¯é”™è¯¯å“åº”"></a>4XX å®¢æˆ·ç«¯é”™è¯¯å“åº”</h3><ul><li><strong>400 Bad Request</strong> Â ï¼šè¯·æ±‚æŠ¥æ–‡ä¸­å­˜åœ¨è¯­æ³•é”™è¯¯ã€‚ </li><li><strong>401 Unauthorized</strong> Â ï¼šè¯¥çŠ¶æ€ç è¡¨ç¤ºå‘é€çš„è¯·æ±‚éœ€è¦æœ‰è®¤è¯ä¿¡æ¯ï¼ˆBASIC è®¤è¯ã€DIGEST è®¤è¯ï¼‰ã€‚å¦‚æœä¹‹å‰å·²è¿›è¡Œè¿‡ä¸€æ¬¡è¯·æ±‚ï¼Œåˆ™è¡¨ç¤ºç”¨æˆ·è®¤è¯å¤±è´¥ã€‚ </li><li><strong>403 Forbidden</strong> Â ï¼šè¯·æ±‚è¢«æ‹’ç»ã€‚ </li><li><strong>404 Not Found</strong></li></ul><h3 id="5XX-æœåŠ¡å™¨é”™è¯¯å“åº”"><a href="#5XX-æœåŠ¡å™¨é”™è¯¯å“åº”" class="headerlink" title="5XX æœåŠ¡å™¨é”™è¯¯å“åº”"></a>5XX æœåŠ¡å™¨é”™è¯¯å“åº”</h3><ul><li><strong>500 Internal Server Error</strong> Â ï¼šæœåŠ¡å™¨æ­£åœ¨æ‰§è¡Œè¯·æ±‚æ—¶å‘ç”Ÿé”™è¯¯ã€‚ </li><li><strong>503 Service Unavailable</strong> Â ï¼šæœåŠ¡å™¨æš‚æ—¶å¤„äºè¶…è´Ÿè½½æˆ–æ­£åœ¨è¿›è¡Œåœæœºç»´æŠ¤ï¼Œç°åœ¨æ— æ³•å¤„ç†è¯·æ±‚ã€‚</li></ul><h2 id="HTTPé¦–éƒ¨"><a href="#HTTPé¦–éƒ¨" class="headerlink" title="HTTPé¦–éƒ¨"></a>HTTPé¦–éƒ¨</h2><p>æœ‰ 4 ç§ç±»å‹çš„é¦–éƒ¨å­—æ®µï¼š<strong>é€šç”¨é¦–éƒ¨å­—æ®µã€è¯·æ±‚é¦–éƒ¨å­—æ®µã€å“åº”é¦–éƒ¨å­—æ®µå’Œå®ä½“é¦–éƒ¨å­—æ®µ</strong>ã€‚å„ç§é¦–éƒ¨å­—æ®µåŠå…¶å«ä¹‰å¦‚ä¸‹ï¼š</p><h3 id="é€šç”¨é¦–éƒ¨å­—æ®µ"><a href="#é€šç”¨é¦–éƒ¨å­—æ®µ" class="headerlink" title="é€šç”¨é¦–éƒ¨å­—æ®µ"></a>é€šç”¨é¦–éƒ¨å­—æ®µ</h3><table><thead><tr><th>é¦–éƒ¨å­—æ®µå</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>Cache-Control</td><td>æ§åˆ¶ç¼“å­˜çš„è¡Œä¸º</td></tr><tr><td>Connection</td><td>æ§åˆ¶ä¸å†è½¬å‘ç»™ä»£ç†çš„é¦–éƒ¨å­—æ®µã€ç®¡ç†æŒä¹…è¿æ¥</td></tr><tr><td>Date</td><td>åˆ›å»ºæŠ¥æ–‡çš„æ—¥æœŸæ—¶é—´</td></tr><tr><td>Pragma</td><td>æŠ¥æ–‡æŒ‡ä»¤</td></tr><tr><td>Trailer</td><td>æŠ¥æ–‡æœ«ç«¯çš„é¦–éƒ¨ä¸€è§ˆ</td></tr><tr><td>Transfer-Encoding</td><td>æŒ‡å®šæŠ¥æ–‡ä¸»ä½“çš„ä¼ è¾“ç¼–ç æ–¹å¼</td></tr><tr><td>Upgrade</td><td>å‡çº§ä¸ºå…¶ä»–åè®®</td></tr><tr><td>Via</td><td>ä»£ç†æœåŠ¡å™¨çš„ç›¸å…³ä¿¡æ¯</td></tr><tr><td>Warning</td><td>é”™è¯¯é€šçŸ¥</td></tr></tbody></table><h3 id="è¯·æ±‚é¦–éƒ¨å­—æ®µ"><a href="#è¯·æ±‚é¦–éƒ¨å­—æ®µ" class="headerlink" title="è¯·æ±‚é¦–éƒ¨å­—æ®µ"></a>è¯·æ±‚é¦–éƒ¨å­—æ®µ</h3><table><thead><tr><th>é¦–éƒ¨å­—æ®µå</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>Accept</td><td>ç”¨æˆ·ä»£ç†å¯å¤„ç†çš„åª’ä½“ç±»å‹</td></tr><tr><td>Accept-Charset</td><td>ä¼˜å…ˆçš„å­—ç¬¦é›†</td></tr><tr><td>Accept-Encoding</td><td>ä¼˜å…ˆçš„å†…å®¹ç¼–ç </td></tr><tr><td>Accept-Language</td><td>ä¼˜å…ˆçš„è¯­è¨€ï¼ˆè‡ªç„¶è¯­è¨€ï¼‰</td></tr><tr><td>Authorization</td><td>Web è®¤è¯ä¿¡æ¯</td></tr><tr><td>Expect</td><td>æœŸå¾…æœåŠ¡å™¨çš„ç‰¹å®šè¡Œä¸º</td></tr><tr><td>From</td><td>ç”¨æˆ·çš„ç”µå­é‚®ç®±åœ°å€</td></tr><tr><td>Host</td><td>è¯·æ±‚èµ„æºæ‰€åœ¨æœåŠ¡å™¨</td></tr><tr><td>If-Match</td><td>æ¯”è¾ƒå®ä½“æ ‡è®°ï¼ˆETagï¼‰</td></tr><tr><td>If-Modified-Since</td><td>æ¯”è¾ƒèµ„æºçš„æ›´æ–°æ—¶é—´</td></tr><tr><td>If-None-Match</td><td>æ¯”è¾ƒå®ä½“æ ‡è®°ï¼ˆä¸ If-Match ç›¸åï¼‰</td></tr><tr><td>If-Range</td><td>èµ„æºæœªæ›´æ–°æ—¶å‘é€å®ä½“ Byte çš„èŒƒå›´è¯·æ±‚</td></tr><tr><td>If-Unmodified-Since</td><td>æ¯”è¾ƒèµ„æºçš„æ›´æ–°æ—¶é—´ï¼ˆä¸ If-Modified-Since ç›¸åï¼‰</td></tr><tr><td>Max-Forwards</td><td>æœ€å¤§ä¼ è¾“é€è·³æ•°</td></tr><tr><td>Proxy-Authorization</td><td>ä»£ç†æœåŠ¡å™¨è¦æ±‚å®¢æˆ·ç«¯çš„è®¤è¯ä¿¡æ¯</td></tr><tr><td>Range</td><td>å®ä½“çš„å­—èŠ‚èŒƒå›´è¯·æ±‚</td></tr><tr><td>Referer</td><td>å¯¹è¯·æ±‚ä¸­ URI çš„åŸå§‹è·å–æ–¹</td></tr><tr><td>TE</td><td>ä¼ è¾“ç¼–ç çš„ä¼˜å…ˆçº§</td></tr><tr><td>User-Agent</td><td>HTTP å®¢æˆ·ç«¯ç¨‹åºçš„ä¿¡æ¯</td></tr></tbody></table><h3 id="å“åº”é¦–éƒ¨å­—æ®µ"><a href="#å“åº”é¦–éƒ¨å­—æ®µ" class="headerlink" title="å“åº”é¦–éƒ¨å­—æ®µ"></a>å“åº”é¦–éƒ¨å­—æ®µ</h3><table><thead><tr><th>é¦–éƒ¨å­—æ®µå</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>Accept-Ranges</td><td>æ˜¯å¦æ¥å—å­—èŠ‚èŒƒå›´è¯·æ±‚</td></tr><tr><td>Age</td><td>æ¨ç®—èµ„æºåˆ›å»ºç»è¿‡æ—¶é—´</td></tr><tr><td>ETag</td><td>èµ„æºçš„åŒ¹é…ä¿¡æ¯</td></tr><tr><td>Location</td><td>ä»¤å®¢æˆ·ç«¯é‡å®šå‘è‡³æŒ‡å®š URI</td></tr><tr><td>Proxy-Authenticate</td><td>ä»£ç†æœåŠ¡å™¨å¯¹å®¢æˆ·ç«¯çš„è®¤è¯ä¿¡æ¯</td></tr><tr><td>Retry-After</td><td>å¯¹å†æ¬¡å‘èµ·è¯·æ±‚çš„æ—¶æœºè¦æ±‚</td></tr><tr><td>Server</td><td>HTTP æœåŠ¡å™¨çš„å®‰è£…ä¿¡æ¯</td></tr><tr><td>Vary</td><td>ä»£ç†æœåŠ¡å™¨ç¼“å­˜çš„ç®¡ç†ä¿¡æ¯</td></tr><tr><td>WWW-Authenticate</td><td>æœåŠ¡å™¨å¯¹å®¢æˆ·ç«¯çš„è®¤è¯ä¿¡æ¯</td></tr></tbody></table><h3 id="å®ä½“é¦–éƒ¨å­—æ®µ"><a href="#å®ä½“é¦–éƒ¨å­—æ®µ" class="headerlink" title="å®ä½“é¦–éƒ¨å­—æ®µ"></a>å®ä½“é¦–éƒ¨å­—æ®µ</h3><table><thead><tr><th>é¦–éƒ¨å­—æ®µå</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>Allow</td><td>èµ„æºå¯æ”¯æŒçš„ HTTP æ–¹æ³•</td></tr><tr><td>Content-Encoding</td><td>å®ä½“ä¸»ä½“é€‚ç”¨çš„ç¼–ç æ–¹å¼</td></tr><tr><td>Content-Language</td><td>å®ä½“ä¸»ä½“çš„è‡ªç„¶è¯­è¨€</td></tr><tr><td>Content-Length</td><td>å®ä½“ä¸»ä½“çš„å¤§å°</td></tr><tr><td>Content-Location</td><td>æ›¿ä»£å¯¹åº”èµ„æºçš„ URI</td></tr><tr><td>Content-MD5</td><td>å®ä½“ä¸»ä½“çš„æŠ¥æ–‡æ‘˜è¦</td></tr><tr><td>Content-Range</td><td>å®ä½“ä¸»ä½“çš„ä½ç½®èŒƒå›´</td></tr><tr><td>Content-Type</td><td>å®ä½“ä¸»ä½“çš„åª’ä½“ç±»å‹</td></tr><tr><td>Expires</td><td>å®ä½“ä¸»ä½“è¿‡æœŸçš„æ—¥æœŸæ—¶é—´</td></tr><tr><td>Last-Modified</td><td>èµ„æºçš„æœ€åä¿®æ”¹æ—¥æœŸæ—¶é—´</td></tr></tbody></table><h2 id="HTTPå…·ä½“åº”ç”¨"><a href="#HTTPå…·ä½“åº”ç”¨" class="headerlink" title="HTTPå…·ä½“åº”ç”¨"></a>HTTPå…·ä½“åº”ç”¨</h2><h3 id="è¿æ¥ç®¡ç†"><a href="#è¿æ¥ç®¡ç†" class="headerlink" title="è¿æ¥ç®¡ç†"></a>è¿æ¥ç®¡ç†</h3><p><img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/HTTP1_x_Connections.png#crop=0&crop=0&crop=1&crop=1&height=468&id=kbeVS&originHeight=670&originWidth=1012&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=&width=707"></p><h4 id="çŸ­è¿æ¥ä¸é•¿è¿æ¥"><a href="#çŸ­è¿æ¥ä¸é•¿è¿æ¥" class="headerlink" title="çŸ­è¿æ¥ä¸é•¿è¿æ¥"></a>çŸ­è¿æ¥ä¸é•¿è¿æ¥</h4><p>å½“æµè§ˆå™¨è®¿é—®ä¸€ä¸ªåŒ…å«å¤šå¼ å›¾ç‰‡çš„ HTML é¡µé¢æ—¶ï¼Œé™¤äº†è¯·æ±‚è®¿é—®çš„ HTML é¡µé¢èµ„æºï¼Œè¿˜ä¼šè¯·æ±‚å›¾ç‰‡èµ„æºã€‚å¦‚æœæ¯è¿›è¡Œä¸€æ¬¡ HTTP é€šä¿¡å°±è¦æ–°å»ºä¸€ä¸ª TCP è¿æ¥ï¼Œé‚£ä¹ˆå¼€é”€ä¼šå¾ˆå¤§ã€‚é•¿è¿æ¥<strong>åªéœ€å»ºç«‹ä¸€æ¬¡ TCP è¿æ¥å°±èƒ½è¿›è¡Œå¤šæ¬¡ HTTP é€šä¿¡</strong>ã€‚</p><ul><li><strong>ä» HTTP&#x2F;1.1 å¼€å§‹é»˜è®¤æ˜¯é•¿è¿æ¥çš„</strong>ï¼Œå¦‚æœè¦æ–­å¼€è¿æ¥ï¼Œéœ€è¦ç”±å®¢æˆ·ç«¯æˆ–è€…æœåŠ¡å™¨ç«¯æå‡ºæ–­å¼€ï¼Œä½¿ç”¨ <code>**Connection : close**</code>ï¼›</li><li>åœ¨ HTTP&#x2F;1.1 ä¹‹å‰é»˜è®¤æ˜¯çŸ­è¿æ¥çš„ï¼Œå¦‚æœéœ€è¦ä½¿ç”¨é•¿è¿æ¥ï¼Œåˆ™ä½¿ç”¨ <code>**Connection : Keep-Alive**</code>ã€‚</li></ul><h4 id="æµæ°´çº¿"><a href="#æµæ°´çº¿" class="headerlink" title="æµæ°´çº¿"></a>æµæ°´çº¿</h4><p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒHTTP è¯·æ±‚æ˜¯<strong>æŒ‰é¡ºåºå‘å‡º</strong>çš„ï¼Œä¸‹ä¸€ä¸ªè¯·æ±‚åªæœ‰åœ¨å½“å‰è¯·æ±‚æ”¶åˆ°å“åº”ä¹‹åæ‰ä¼šè¢«å‘å‡ºã€‚ç”±äºå—åˆ°ç½‘ç»œå»¶è¿Ÿå’Œå¸¦å®½çš„é™åˆ¶ï¼Œåœ¨ä¸‹ä¸€ä¸ªè¯·æ±‚è¢«å‘é€åˆ°æœåŠ¡å™¨ä¹‹å‰ï¼Œå¯èƒ½éœ€è¦ç­‰å¾…å¾ˆé•¿æ—¶é—´ã€‚æµæ°´çº¿æ˜¯åœ¨<strong>åŒä¸€æ¡é•¿è¿æ¥ä¸Šè¿ç»­å‘å‡ºè¯·æ±‚</strong>ï¼Œè€Œä¸ç”¨ç­‰å¾…å“åº”è¿”å›ï¼Œè¿™æ ·å¯ä»¥å‡å°‘å»¶è¿Ÿã€‚</p><h3 id="Cookie"><a href="#Cookie" class="headerlink" title="Cookie"></a>Cookie</h3><p>HTTP åè®®æ˜¯<strong>æ— çŠ¶æ€</strong>çš„ï¼Œä¸»è¦æ˜¯ä¸ºäº†è®© HTTP åè®®å°½å¯èƒ½ç®€å•ï¼Œä½¿å¾—å®ƒèƒ½å¤Ÿå¤„ç†å¤§é‡äº‹åŠ¡ï¼Œåœ¨HTTP&#x2F;1.1 å¼•å…¥ Cookie æ¥ä¿å­˜çŠ¶æ€ä¿¡æ¯ã€‚<br />Cookie æ˜¯æœåŠ¡å™¨å‘é€åˆ°ç”¨æˆ·æµè§ˆå™¨å¹¶ä¿å­˜åœ¨æœ¬åœ°çš„ä¸€å°å—æ•°æ®ï¼Œå®ƒä¼šåœ¨æµè§ˆå™¨ä¹‹åå‘åŒä¸€æœåŠ¡å™¨å†æ¬¡å‘èµ·è¯·æ±‚æ—¶è¢«æºå¸¦ä¸Šï¼Œç”¨äº<strong>å‘ŠçŸ¥æœåŠ¡ç«¯ä¸¤ä¸ªè¯·æ±‚æ˜¯å¦æ¥è‡ªåŒä¸€æµè§ˆå™¨</strong>ã€‚ç”±äºä¹‹åæ¯æ¬¡è¯·æ±‚éƒ½ä¼šéœ€è¦æºå¸¦ Cookie æ•°æ®ï¼Œå› æ­¤ä¼šå¸¦æ¥é¢å¤–çš„æ€§èƒ½å¼€é”€ï¼ˆå°¤å…¶æ˜¯åœ¨ç§»åŠ¨ç¯å¢ƒä¸‹ï¼‰ã€‚<br />Cookie æ›¾ä¸€åº¦ç”¨äºå®¢æˆ·ç«¯æ•°æ®çš„å­˜å‚¨ï¼Œå› ä¸ºå½“æ—¶ä½œä¸ºå”¯ä¸€çš„å­˜å‚¨æ‰‹æ®µå¹¶æ²¡æœ‰å…¶å®ƒåˆé€‚çš„å­˜å‚¨åŠæ³•ï¼Œä½†ç°åœ¨éšç€ç°ä»£æµè§ˆå™¨å¼€å§‹æ”¯æŒå„ç§å„æ ·çš„å­˜å‚¨æ–¹å¼ï¼ŒCookie <strong>æ¸æ¸è¢«æ·˜æ±°</strong>ã€‚æ–°çš„æµè§ˆå™¨ API å·²ç»å…è®¸å¼€å‘è€…ç›´æ¥å°†æ•°æ®å­˜å‚¨åˆ°æœ¬åœ°ï¼Œå¦‚ä½¿ç”¨ <strong>Web storage API</strong>ï¼ˆæœ¬åœ°å­˜å‚¨å’Œä¼šè¯å­˜å‚¨ï¼‰æˆ– <strong>IndexedDB</strong>ã€‚</p><h4 id="å®ƒçš„ç”¨é€”"><a href="#å®ƒçš„ç”¨é€”" class="headerlink" title="å®ƒçš„ç”¨é€”"></a>å®ƒçš„ç”¨é€”</h4><ul><li>ä¼šè¯çŠ¶æ€ç®¡ç†ï¼ˆå¦‚ç”¨æˆ·ç™»å½•çŠ¶æ€ã€è´­ç‰©è½¦ã€æ¸¸æˆåˆ†æ•°æˆ–å…¶å®ƒéœ€è¦è®°å½•çš„ä¿¡æ¯ï¼‰</li><li>ä¸ªæ€§åŒ–è®¾ç½®ï¼ˆå¦‚ç”¨æˆ·è‡ªå®šä¹‰è®¾ç½®ã€ä¸»é¢˜ç­‰ï¼‰</li><li><strong>æµè§ˆå™¨è¡Œä¸ºè·Ÿè¸ª</strong>ï¼ˆå¦‚è·Ÿè¸ªåˆ†æç”¨æˆ·è¡Œä¸ºç­‰ï¼‰</li></ul><h4 id="å¦‚ä½•åˆ›å»º-x2F-åˆ›å»ºè¿‡ç¨‹"><a href="#å¦‚ä½•åˆ›å»º-x2F-åˆ›å»ºè¿‡ç¨‹" class="headerlink" title="å¦‚ä½•åˆ›å»º&#x2F;åˆ›å»ºè¿‡ç¨‹"></a>å¦‚ä½•åˆ›å»º&#x2F;åˆ›å»ºè¿‡ç¨‹</h4><p>æœåŠ¡å™¨å‘é€çš„å“åº”æŠ¥æ–‡åŒ…å« <strong>Set-Cookie</strong> é¦–éƒ¨å­—æ®µï¼Œå®¢æˆ·ç«¯å¾—åˆ°å“åº”æŠ¥æ–‡åæŠŠ Cookie å†…å®¹ä¿å­˜åˆ°æµè§ˆå™¨ä¸­ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.0 200 OK</span><br><span class="line">Content-type: text/html</span><br><span class="line">Set-Cookie: yummy_cookie=choco</span><br><span class="line">Set-Cookie: tasty_cookie=strawberry</span><br><span class="line"></span><br><span class="line">[page content]</span><br></pre></td></tr></table></figure><p>å®¢æˆ·ç«¯ä¹‹åå¯¹åŒä¸€ä¸ªæœåŠ¡å™¨å‘é€è¯·æ±‚æ—¶ï¼Œä¼šä»æµè§ˆå™¨ä¸­å–å‡º Cookie ä¿¡æ¯å¹¶é€šè¿‡ <strong>Cookie è¯·æ±‚é¦–éƒ¨å­—æ®µ</strong>å‘é€ç»™æœåŠ¡å™¨ã€‚</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">GET /sample_page.html HTTP/1.1</span><br><span class="line">Host: www.example.org</span><br><span class="line">Cookie: yummy_cookie=choco; tasty_cookie=strawberry</span><br></pre></td></tr></table></figure><h4 id="æŒ‰ç”Ÿå‘½å‘¨æœŸåˆ†ç±»"><a href="#æŒ‰ç”Ÿå‘½å‘¨æœŸåˆ†ç±»" class="headerlink" title="æŒ‰ç”Ÿå‘½å‘¨æœŸåˆ†ç±»"></a>æŒ‰ç”Ÿå‘½å‘¨æœŸåˆ†ç±»</h4><ul><li>ä¼šè¯æœŸ Cookieï¼šæµè§ˆå™¨å…³é—­ä¹‹åå®ƒä¼šè¢«è‡ªåŠ¨åˆ é™¤ï¼Œå³å®ƒä»…åœ¨ä¼šè¯æœŸå†…æœ‰æ•ˆã€‚</li><li>æŒä¹…æ€§ Cookieï¼šæŒ‡å®šè¿‡æœŸæ—¶é—´ï¼ˆExpiresï¼‰æˆ–æœ‰æ•ˆæœŸï¼ˆmax-ageï¼‰ä¹‹åå°±æˆä¸ºäº†æŒä¹…æ€§çš„ Cookieã€‚<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Set-Cookie: id=a3fWa; Expires=Wed, 21 Oct 2015 07:28:00 GMT;</span><br></pre></td></tr></table></figure></li></ul><h4 id="å®ƒçš„ä½œç”¨åŸŸ"><a href="#å®ƒçš„ä½œç”¨åŸŸ" class="headerlink" title="å®ƒçš„ä½œç”¨åŸŸ"></a>å®ƒçš„ä½œç”¨åŸŸ</h4><p><strong>Domain æ ‡è¯†</strong>æŒ‡å®šäº†å“ªäº›ä¸»æœºå¯ä»¥æ¥å— Cookieã€‚å¦‚æœä¸æŒ‡å®šï¼Œé»˜è®¤ä¸ºå½“å‰æ–‡æ¡£çš„ä¸»æœºï¼ˆä¸åŒ…å«å­åŸŸåï¼‰ï¼Œå¦‚æœæŒ‡å®šäº† Domainï¼Œåˆ™ä¸€èˆ¬åŒ…å«å­åŸŸåã€‚ä¾‹å¦‚ï¼Œå¦‚æœè®¾ç½® Domain&#x3D;mozilla.orgï¼Œåˆ™ å­åŸŸåä¸­ï¼ˆå¦‚ developer.mozilla.orgï¼‰ä¹Ÿå¯ä»¥æ¥å—è¯¥Cookie ã€‚<br /><strong>Path æ ‡è¯†</strong>æŒ‡å®šäº†ä¸»æœºä¸‹çš„å“ªäº›è·¯å¾„å¯ä»¥æ¥å— Cookieï¼ˆè¯¥ <strong>URL</strong> è·¯å¾„å¿…é¡»å­˜åœ¨äºè¯·æ±‚ URL ä¸­ï¼‰ï¼Œä»¥å­—ç¬¦ %x2F (â€œ&#x2F;â€œ) ä½œä¸ºè·¯å¾„åˆ†éš”ç¬¦çš„å­è·¯å¾„ä¹Ÿä¼šè¢«åŒ¹é…ã€‚ä¾‹å¦‚ï¼Œè®¾ç½® Path&#x3D;&#x2F;docsï¼Œåˆ™ä»¥ä¸‹åœ°å€éƒ½ä¼šåŒ¹é…ï¼š&#x2F;docs  &#x2F;docs&#x2F;Web&#x2F;  &#x2F;docs&#x2F;Web&#x2F;HTTP</p><h4 id="å…³äºJavaScriptè„šæœ¬å’ŒCookieé‚£äº›äº‹"><a href="#å…³äºJavaScriptè„šæœ¬å’ŒCookieé‚£äº›äº‹" class="headerlink" title="å…³äºJavaScriptè„šæœ¬å’ŒCookieé‚£äº›äº‹"></a>å…³äºJavaScriptè„šæœ¬å’ŒCookieé‚£äº›äº‹</h4><p>æµè§ˆå™¨é€šè¿‡ <code>**document.cookie**</code> å±æ€§å¯åˆ›å»ºæ–°çš„ Cookieï¼Œä¹Ÿå¯ä»¥è®¿é—®é HttpOnly æ ‡è®°çš„ Cookieã€‚è·¨ç«™è„šæœ¬æ”»å‡» (XSS) å¸¸å¸¸ä½¿ç”¨ JavaScript çš„ <code>document.cookie</code> API çªƒå–ç”¨æˆ·çš„ Cookie ä¿¡æ¯ã€‚</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">document.cookie = &quot;yummy_cookie=choco&quot;;</span><br><span class="line">document.cookie = &quot;tasty_cookie=strawberry&quot;;</span><br><span class="line">console.log(document.cookie);</span><br></pre></td></tr></table></figure><h4 id="HttpOnly"><a href="#HttpOnly" class="headerlink" title="HttpOnly"></a>HttpOnly</h4><p>æ ‡è®°ä¸º <strong>HttpOnly</strong> çš„ Cookie ä¸èƒ½è¢« JavaScript è„šæœ¬è°ƒç”¨ã€‚è·¨ç«™è„šæœ¬æ”»å‡» (XSS) å¸¸å¸¸ä½¿ç”¨ JavaScript çš„ <code>**document.cookie**</code> API çªƒå–ç”¨æˆ·çš„ Cookie ä¿¡æ¯ï¼Œå› æ­¤ä½¿ç”¨ <strong>HttpOnly æ ‡è®°å¯ä»¥åœ¨ä¸€å®šç¨‹åº¦ä¸Šé¿å… XSS æ”»å‡»</strong>ã€‚</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Set-Cookie: id=a3fWa; Expires=Wed, 21 Oct 2015 07:28:00 GMT; Secure; HttpOnly</span><br></pre></td></tr></table></figure><h4 id="Secure-å®‰å…¨"><a href="#Secure-å®‰å…¨" class="headerlink" title="Secure å®‰å…¨"></a>Secure å®‰å…¨</h4><p>æ ‡è®°ä¸º Secure çš„ Cookie åªèƒ½é€šè¿‡è¢« <strong>HTTPS åè®®åŠ å¯†</strong>è¿‡çš„è¯·æ±‚å‘é€ç»™æœåŠ¡ç«¯ï¼Œä½†æ˜¯å³ä¾¿è®¾ç½®äº† Secure æ ‡è®°ï¼Œæ•æ„Ÿä¿¡æ¯ä¹Ÿä¸åº”è¯¥é€šè¿‡ Cookie ä¼ è¾“ï¼Œå› ä¸º <strong>Cookie æœ‰å…¶å›ºæœ‰çš„ä¸å®‰å…¨æ€§ï¼ŒSecure æ ‡è®°ä¹Ÿæ— æ³•æä¾›ç¡®å®çš„å®‰å…¨ä¿éšœ</strong>ã€‚</p><h4 id="Session-ä¼šè¯"><a href="#Session-ä¼šè¯" class="headerlink" title="Session ä¼šè¯"></a>Session ä¼šè¯</h4><p>é™¤äº†å¯ä»¥å°†ç”¨æˆ·ä¿¡æ¯é€šè¿‡ Cookie å­˜å‚¨åœ¨ç”¨æˆ·æµè§ˆå™¨ä¸­ï¼Œä¹Ÿå¯ä»¥åˆ©ç”¨ Session å­˜å‚¨åœ¨æœåŠ¡å™¨ç«¯ï¼Œå­˜å‚¨åœ¨æœåŠ¡å™¨ç«¯çš„ä¿¡æ¯æ›´åŠ å®‰å…¨ã€‚Sessionå¯ä»¥å­˜å‚¨åœ¨æœåŠ¡å™¨ä¸Šçš„æ–‡ä»¶ã€æ•°æ®åº“æˆ–è€…å†…å­˜ä¸­ï¼Œä¹Ÿå¯ä»¥å­˜å‚¨åœ¨ **Redis è¿™ç§å†…å­˜å‹æ•°æ®åº“ä¸­(essionå…±äº«)**ï¼Œæ•ˆç‡ä¼šæ›´é«˜ã€‚<br />ä½¿ç”¨ Session ç»´æŠ¤ç”¨æˆ·ç™»å½•çŠ¶æ€çš„è¿‡ç¨‹å¦‚ä¸‹ï¼š</p><ul><li>ç”¨æˆ·è¿›è¡Œç™»å½•æ—¶ï¼Œç”¨æˆ·æäº¤åŒ…å«ç”¨æˆ·åå’Œå¯†ç çš„è¡¨å•ï¼Œæ”¾å…¥ HTTP è¯·æ±‚æŠ¥æ–‡ä¸­ï¼›</li><li>æœåŠ¡å™¨éªŒè¯è¯¥ç”¨æˆ·åå’Œå¯†ç ï¼Œå¦‚æœæ­£ç¡®åˆ™æŠŠç”¨æˆ·ä¿¡æ¯å­˜å‚¨åˆ° Redis ä¸­ï¼Œå®ƒåœ¨ Redis ä¸­çš„ Key ç§°ä¸º Session IDï¼›</li><li>æœåŠ¡å™¨è¿”å›çš„å“åº”æŠ¥æ–‡çš„ Set-Cookie é¦–éƒ¨å­—æ®µåŒ…å«äº†è¿™ä¸ª Session IDï¼Œå®¢æˆ·ç«¯æ”¶åˆ°å“åº”æŠ¥æ–‡ä¹‹åå°†è¯¥ Cookie å€¼å­˜å…¥æµè§ˆå™¨ä¸­ï¼›</li><li>å®¢æˆ·ç«¯ä¹‹åå¯¹åŒä¸€ä¸ªæœåŠ¡å™¨è¿›è¡Œè¯·æ±‚æ—¶ä¼šåŒ…å«è¯¥ Cookie å€¼ï¼ŒæœåŠ¡å™¨æ”¶åˆ°ä¹‹åæå–å‡º Session IDï¼Œä» Redis ä¸­å–å‡ºç”¨æˆ·ä¿¡æ¯ï¼Œç»§ç»­ä¹‹å‰çš„ä¸šåŠ¡æ“ä½œã€‚</li></ul><p>éœ€è¦æ³¨æ„ Session ID çš„å®‰å…¨æ€§é—®é¢˜ï¼Œä¸èƒ½è®©å®ƒè¢«æ¶æ„æ”»å‡»è€…è½»æ˜“è·å–ï¼Œé‚£ä¹ˆå°±ä¸èƒ½äº§ç”Ÿä¸€ä¸ªå®¹æ˜“è¢«çŒœåˆ°çš„ Session ID å€¼ï¼ŒåŒæ—¶è¿˜éœ€è¦ç»å¸¸é‡æ–°ç”Ÿæˆ Session IDã€‚åœ¨å¯¹å®‰å…¨æ€§è¦æ±‚æé«˜çš„åœºæ™¯ä¸‹ï¼Œä¾‹å¦‚è½¬è´¦ç­‰æ“ä½œï¼Œé™¤äº†ä½¿ç”¨ Session ç®¡ç†ç”¨æˆ·çŠ¶æ€ä¹‹å¤–ï¼Œè¿˜éœ€è¦<strong>å¯¹ç”¨æˆ·è¿›è¡Œé‡æ–°éªŒè¯</strong>ï¼Œæ¯”å¦‚é‡æ–°è¾“å…¥å¯†ç ï¼Œæˆ–è€…ä½¿ç”¨çŸ­ä¿¡éªŒè¯ç ç­‰æ–¹å¼ã€‚</p><h4 id="æµè§ˆå™¨ç¦ç”¨-Cookie"><a href="#æµè§ˆå™¨ç¦ç”¨-Cookie" class="headerlink" title="æµè§ˆå™¨ç¦ç”¨ Cookie"></a>æµè§ˆå™¨ç¦ç”¨ Cookie</h4><p>æ­¤æ—¶æ— æ³•ä½¿ç”¨ Cookie æ¥ä¿å­˜ç”¨æˆ·ä¿¡æ¯ï¼Œåªèƒ½ä½¿ç”¨ Sessionã€‚é™¤æ­¤ä¹‹å¤–ï¼Œä¸èƒ½å†å°† Session ID å­˜æ”¾åˆ° Cookie ä¸­ï¼Œè€Œæ˜¯<strong>ä½¿ç”¨ URL é‡å†™æŠ€æœ¯</strong>ï¼Œå°† Session ID ä½œä¸º URL çš„å‚æ•°è¿›è¡Œä¼ é€’ã€‚</p><h4 id="Cookie-ä¸-Session-é€‰æ‹©"><a href="#Cookie-ä¸-Session-é€‰æ‹©" class="headerlink" title="Cookie ä¸ Session é€‰æ‹©"></a>Cookie ä¸ Session é€‰æ‹©</h4><ul><li>Cookie åªèƒ½å­˜å‚¨ ASCII ç å­—ç¬¦ä¸²ï¼Œè€Œ Session åˆ™å¯ä»¥å­˜å‚¨ä»»ä½•ç±»å‹çš„æ•°æ®ï¼Œå› æ­¤åœ¨è€ƒè™‘<strong>æ•°æ®å¤æ‚æ€§æ—¶é¦–é€‰ Session</strong>ï¼›</li><li>Cookie å­˜å‚¨åœ¨æµè§ˆå™¨ä¸­ï¼Œå®¹æ˜“è¢«æ¶æ„æŸ¥çœ‹ã€‚éè¦å°†éšç§æ•°æ®å­˜åœ¨ Cookie ä¸­ï¼Œå¯ä»¥å°† Cookie å€¼è¿›è¡ŒåŠ å¯†ï¼Œç„¶ååœ¨æœåŠ¡å™¨è¿›è¡Œè§£å¯†ï¼›</li><li>å¯¹äºå¤§å‹ç½‘ç«™ï¼Œå¦‚æœç”¨æˆ·æ‰€æœ‰çš„ä¿¡æ¯éƒ½å­˜å‚¨åœ¨ Session ä¸­ï¼Œé‚£ä¹ˆå¼€é”€æ˜¯éå¸¸å¤§çš„ï¼Œ<strong>ä¸å»ºè®®å°†æ‰€æœ‰çš„ç”¨æˆ·ä¿¡æ¯éƒ½å­˜å‚¨åˆ° Session ä¸­</strong>ã€‚</li></ul><h3 id="ç¼“å­˜"><a href="#ç¼“å­˜" class="headerlink" title="ç¼“å­˜"></a>ç¼“å­˜</h3><h4 id="ä¼˜ç‚¹"><a href="#ä¼˜ç‚¹" class="headerlink" title="ä¼˜ç‚¹"></a>ä¼˜ç‚¹</h4><ul><li>ç¼“è§£æœåŠ¡å™¨å‹åŠ›ï¼›</li><li><strong>é™ä½å®¢æˆ·ç«¯è·å–èµ„æºçš„å»¶è¿Ÿ</strong>ï¼Œç¼“å­˜é€šå¸¸ä½äºå†…å­˜ä¸­ï¼Œè¯»å–ç¼“å­˜çš„é€Ÿåº¦æ›´å¿«ï¼Œä¸”ç¼“å­˜æœåŠ¡å™¨åœ¨åœ°ç†ä½ç½®ä¸Šä¹Ÿæœ‰å¯èƒ½æ¯”æºæœåŠ¡å™¨æ¥å¾—è¿‘ï¼Œå¦‚æµè§ˆå™¨ç¼“å­˜ã€‚</li></ul><h4 id="å®ç°æ–¹æ³•"><a href="#å®ç°æ–¹æ³•" class="headerlink" title="å®ç°æ–¹æ³•"></a>å®ç°æ–¹æ³•</h4><ul><li>è®©<strong>ä»£ç†æœåŠ¡å™¨</strong>è¿›è¡Œç¼“å­˜ï¼›</li><li>è®©<strong>å®¢æˆ·ç«¯æµè§ˆå™¨</strong>è¿›è¡Œç¼“å­˜ï¼›</li></ul><h4 id="Cache-Control-ç¼“å­˜æ§åˆ¶"><a href="#Cache-Control-ç¼“å­˜æ§åˆ¶" class="headerlink" title="Cache-Control (ç¼“å­˜æ§åˆ¶)"></a>Cache-Control (ç¼“å­˜æ§åˆ¶)</h4><p>HTTP&#x2F;1.1 é€šè¿‡ Cache-Control é¦–éƒ¨å­—æ®µæ¥æ§åˆ¶ç¼“å­˜ã€‚<br /><strong>ç¦æ­¢è¿›è¡Œç¼“å­˜</strong><br /><strong>no-store</strong> æŒ‡ä»¤è§„å®šä¸èƒ½å¯¹è¯·æ±‚æˆ–å“åº”çš„ä»»ä½•ä¸€éƒ¨åˆ†è¿›è¡Œç¼“å­˜ã€‚</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Cache-Control: no-store</span><br></pre></td></tr></table></figure><p><strong>å¼ºåˆ¶ç¡®è®¤ç¼“å­˜</strong><br /><strong>no-cache</strong> æŒ‡ä»¤è§„å®šç¼“å­˜æœåŠ¡å™¨éœ€è¦<strong>å…ˆå‘æºæœåŠ¡å™¨éªŒè¯ç¼“å­˜èµ„æºçš„æœ‰æ•ˆæ€§</strong>ï¼Œåªæœ‰å½“ç¼“å­˜èµ„æºæœ‰æ•ˆæ—¶æ‰èƒ½ä½¿ç”¨è¯¥ç¼“å­˜å¯¹å®¢æˆ·ç«¯çš„è¯·æ±‚è¿›è¡Œå“åº”ã€‚</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Cache-Control: no-cache</span><br></pre></td></tr></table></figure><p><strong>ç§æœ‰ç¼“å­˜å’Œå…¬å…±ç¼“å­˜</strong><br /><strong>private</strong> æŒ‡ä»¤è§„å®šäº†å°†èµ„æºä½œä¸º<strong>ç§æœ‰ç¼“å­˜</strong>ï¼Œåªèƒ½è¢«å•ç‹¬ç”¨æˆ·ä½¿ç”¨ï¼Œä¸€èˆ¬å­˜å‚¨åœ¨<strong>ç”¨æˆ·æµè§ˆå™¨</strong>ä¸­ã€‚</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Cache-Control: private</span><br></pre></td></tr></table></figure><p><strong>public</strong> æŒ‡ä»¤è§„å®šäº†å°†èµ„æºä½œä¸º<strong>å…¬å…±ç¼“å­˜</strong>ï¼Œå¯ä»¥è¢«å¤šä¸ªç”¨æˆ·ä½¿ç”¨ï¼Œä¸€èˆ¬å­˜å‚¨åœ¨<strong>ä»£ç†æœåŠ¡å™¨</strong>ä¸­ã€‚</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Cache-Control: public</span><br></pre></td></tr></table></figure><p><strong>ç¼“å­˜è¿‡æœŸæœºåˆ¶</strong><br />max-age æŒ‡ä»¤å‡ºç°åœ¨è¯·æ±‚æŠ¥æ–‡ï¼Œå¹¶ä¸”ç¼“å­˜èµ„æºçš„ç¼“å­˜æ—¶é—´å°äºè¯¥æŒ‡ä»¤æŒ‡å®šçš„æ—¶é—´ï¼Œé‚£ä¹ˆå°±èƒ½æ¥å—è¯¥ç¼“å­˜ã€‚<br />max-age æŒ‡ä»¤å‡ºç°åœ¨å“åº”æŠ¥æ–‡ï¼Œè¡¨ç¤ºç¼“å­˜èµ„æºåœ¨ç¼“å­˜æœåŠ¡å™¨ä¸­ä¿å­˜çš„æ—¶é—´ã€‚</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Cache-Control: max-age=31536000</span><br></pre></td></tr></table></figure><ul><li>åœ¨ HTTP&#x2F;1.1 ä¸­ï¼Œä¼šä¼˜å…ˆå¤„ç† max-age æŒ‡ä»¤ï¼›</li><li>åœ¨ HTTP&#x2F;1.0 ä¸­ï¼Œmax-age æŒ‡ä»¤ä¼šè¢«å¿½ç•¥æ‰ï¼›</li></ul><p>Expires é¦–éƒ¨å­—æ®µç”¨äºå‘ŠçŸ¥ç¼“å­˜æœåŠ¡å™¨è¯¥èµ„æºä»€ä¹ˆæ—¶å€™ä¼šè¿‡æœŸã€‚</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Expires: Wed, 04 Jul 2012 08:26:05 GMT</span><br></pre></td></tr></table></figure><h4 id="ç¼“å­˜éªŒè¯"><a href="#ç¼“å­˜éªŒè¯" class="headerlink" title="ç¼“å­˜éªŒè¯"></a>ç¼“å­˜éªŒè¯</h4><p><strong>ETag é¦–éƒ¨å­—æ®µ</strong>ï¼Œæ˜¯èµ„æºçš„å”¯ä¸€æ ‡è¯†ã€‚URL ä¸èƒ½å”¯ä¸€è¡¨ç¤ºèµ„æºï¼Œå¦‚ <code>http://www.google.com/</code> æœ‰ä¸­æ–‡å’Œè‹±æ–‡ä¸¤ä¸ªèµ„æºï¼Œåªæœ‰ ETag æ‰èƒ½å¯¹è¿™ä¸¤ä¸ªèµ„æºè¿›è¡Œå”¯ä¸€æ ‡è¯†ã€‚</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ETag: &quot;82e22293907ce725faf67773957acd12&quot;</span><br></pre></td></tr></table></figure><p>å¯ä»¥å°†ç¼“å­˜èµ„æºçš„ ETag å€¼æ”¾å…¥ <strong>If-None-Match</strong> é¦–éƒ¨ï¼ŒæœåŠ¡å™¨æ”¶åˆ°è¯¥è¯·æ±‚åï¼Œåˆ¤æ–­ç¼“å­˜èµ„æºçš„ ETag å€¼å’Œèµ„æºçš„æœ€æ–° ETag å€¼æ˜¯å¦ä¸€è‡´ï¼Œä¸€è‡´åˆ™è¡¨ç¤ºç¼“å­˜èµ„æºæœ‰æ•ˆï¼Œè¿”å› 304 Not Modifiedã€‚</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">If-None-Match: &quot;82e22293907ce725faf67773957acd12&quot;</span><br></pre></td></tr></table></figure><p><strong>Last-Modified</strong> é¦–éƒ¨å­—æ®µå¯ä»¥ç”¨äºç¼“å­˜éªŒè¯ï¼ŒåŒ…å«åœ¨æºæœåŠ¡å™¨å‘é€çš„å“åº”æŠ¥æ–‡ä¸­ï¼ŒæŒ‡ç¤ºæºæœåŠ¡å™¨å¯¹èµ„æºçš„æœ€åä¿®æ”¹æ—¶é—´ï¼Œä½†å®ƒæ˜¯ä¸€ç§å¼±æ ¡éªŒå™¨ï¼Œå› ä¸ºåªèƒ½ç²¾ç¡®åˆ°ä¸€ç§’ï¼Œæ‰€ä»¥å®ƒé€šå¸¸<strong>ä½œä¸º ETag çš„å¤‡ç”¨æ–¹æ¡ˆ</strong>ã€‚å¦‚æœå“åº”é¦–éƒ¨å­—æ®µé‡Œå«æœ‰è¿™ä¸ªä¿¡æ¯ï¼Œå®¢æˆ·ç«¯å¯ä»¥åœ¨åç»­çš„è¯·æ±‚ä¸­å¸¦ä¸Š <strong>If-Modified-Since</strong> æ¥éªŒè¯ç¼“å­˜ã€‚æœåŠ¡å™¨åªåœ¨<strong>æ‰€è¯·æ±‚çš„èµ„æº</strong>åœ¨ç»™å®šçš„æ—¥æœŸæ—¶é—´ä¹‹åå¯¹å†…å®¹è¿›è¡Œè¿‡ä¿®æ”¹çš„æƒ…å†µä¸‹æ‰ä¼šå°†èµ„æºè¿”å›ï¼ŒçŠ¶æ€ç ä¸º 200 OKï¼Œè¯·æ±‚çš„èµ„æºä»é‚£æ—¶èµ·æœªç»ä¿®æ”¹ï¼Œé‚£è¿”å›ä¸€ä¸ªä¸å¸¦æœ‰å®ä½“ä¸»ä½“çš„ 304 Not Modified å“åº”æŠ¥æ–‡ã€‚</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Last-Modified: Wed, 21 Oct 2015 07:28:00 GMT</span><br></pre></td></tr></table></figure><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">If-Modified-Since: Wed, 21 Oct 2015 07:28:00 GMT</span><br></pre></td></tr></table></figure><h3 id="å†…å®¹åå•†"><a href="#å†…å®¹åå•†" class="headerlink" title="å†…å®¹åå•†"></a>å†…å®¹åå•†</h3><p>é€šè¿‡å†…å®¹åå•†è¿”å›æœ€åˆé€‚çš„å†…å®¹ï¼Œä¾‹å¦‚æ ¹æ®æµè§ˆå™¨çš„é»˜è®¤è¯­è¨€é€‰æ‹©è¿”å›ä¸­æ–‡ç•Œé¢è¿˜æ˜¯è‹±æ–‡ç•Œé¢ã€‚</p><h4 id="ç±»å‹"><a href="#ç±»å‹" class="headerlink" title="ç±»å‹"></a>ç±»å‹</h4><p><strong>æœåŠ¡ç«¯é©±åŠ¨å‹</strong><br />å®¢æˆ·ç«¯è®¾ç½®ç‰¹å®šçš„ HTTP é¦–éƒ¨å­—æ®µï¼Œä¾‹å¦‚ Acceptã€Accept-Charsetã€Accept-Encodingã€Accept-Languageï¼ŒæœåŠ¡å™¨æ ¹æ®è¿™äº›å­—æ®µè¿”å›ç‰¹å®šçš„èµ„æºã€‚<br />å®ƒå­˜åœ¨ä»¥ä¸‹é—®é¢˜ï¼š</p><ul><li>æœåŠ¡å™¨å¾ˆéš¾çŸ¥é“å®¢æˆ·ç«¯æµè§ˆå™¨çš„å…¨éƒ¨ä¿¡æ¯ï¼›</li><li>å®¢æˆ·ç«¯æä¾›çš„<strong>ä¿¡æ¯ç›¸å½“å†—é•¿</strong>ï¼ˆHTTP&#x2F;2 åè®®çš„<strong>é¦–éƒ¨å‹ç¼©æœºåˆ¶</strong>ç¼“è§£äº†è¿™ä¸ªé—®é¢˜ï¼‰ï¼Œå¹¶ä¸”<strong>å­˜åœ¨éšç§é£é™©</strong>ï¼ˆHTTP <strong>æŒ‡çº¹è¯†åˆ«æŠ€æœ¯</strong>ï¼‰ï¼›</li><li>ç»™å®šçš„èµ„æºéœ€è¦è¿”å›ä¸åŒçš„å±•ç°å½¢å¼ï¼Œ<strong>å…±äº«ç¼“å­˜çš„æ•ˆç‡ä¼šé™ä½ï¼ŒæœåŠ¡å™¨ç«¯çš„å®ç°ä¼šè¶Šæ¥è¶Šå¤æ‚ã€‚</strong></li></ul><p><strong>ä»£ç†é©±åŠ¨å‹</strong><br />æœåŠ¡å™¨è¿”å› <strong>300 Multiple Choices</strong> æˆ–è€… <strong>406 Not Acceptable</strong>ï¼Œå®¢æˆ·ç«¯ä»ä¸­é€‰å‡ºæœ€åˆé€‚çš„é‚£ä¸ªèµ„æºã€‚</p><h4 id="Vary-é¦–éƒ¨å­—æ®µ"><a href="#Vary-é¦–éƒ¨å­—æ®µ" class="headerlink" title="Vary é¦–éƒ¨å­—æ®µ"></a>Vary é¦–éƒ¨å­—æ®µ</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Vary: Accept-Language</span><br></pre></td></tr></table></figure><p>åœ¨ä½¿ç”¨å†…å®¹åå•†çš„æƒ…å†µä¸‹ï¼Œåªæœ‰å½“ç¼“å­˜æœåŠ¡å™¨ä¸­çš„ç¼“å­˜æ»¡è¶³å†…å®¹åå•†æ¡ä»¶æ—¶ï¼Œæ‰èƒ½ä½¿ç”¨è¯¥ç¼“å­˜ï¼Œå¦åˆ™åº”è¯¥å‘æºæœåŠ¡å™¨è¯·æ±‚è¯¥èµ„æºã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªå®¢æˆ·ç«¯å‘é€äº†ä¸€ä¸ªåŒ…å« Accept-Language é¦–éƒ¨å­—æ®µçš„è¯·æ±‚ä¹‹åï¼ŒæºæœåŠ¡å™¨è¿”å›çš„å“åº”åŒ…å« <code>Vary: Accept-Language</code> å†…å®¹ï¼Œç¼“å­˜æœåŠ¡å™¨å¯¹è¿™ä¸ªå“åº”è¿›è¡Œç¼“å­˜ä¹‹åï¼Œåœ¨å®¢æˆ·ç«¯ä¸‹ä¸€æ¬¡è®¿é—®åŒä¸€ä¸ª URL èµ„æºï¼Œå¹¶ä¸” Accept-Language ä¸ç¼“å­˜ä¸­çš„å¯¹åº”çš„å€¼ç›¸åŒæ—¶æ‰ä¼šè¿”å›è¯¥ç¼“å­˜ã€‚</p><h3 id="å†…å®¹ç¼–ç "><a href="#å†…å®¹ç¼–ç " class="headerlink" title="å†…å®¹ç¼–ç "></a>å†…å®¹ç¼–ç </h3><p>å†…å®¹ç¼–ç å°†å®ä½“ä¸»ä½“è¿›è¡Œå‹ç¼©ï¼Œä»è€Œå‡å°‘ä¼ è¾“çš„æ•°æ®é‡ï¼Œå¸¸ç”¨çš„å†…å®¹ç¼–ç æœ‰ï¼š<strong>gzipã€compressã€deflateã€identity</strong>ã€‚<br />æµè§ˆå™¨å‘é€ <strong>Accept-Encoding</strong> é¦–éƒ¨ï¼Œå…¶ä¸­åŒ…å«å®ƒæ‰€æ”¯æŒçš„å‹ç¼©ç®—æ³•ï¼Œä»¥åŠå„è‡ªçš„ä¼˜å…ˆçº§ï¼ŒæœåŠ¡å™¨ä»ä¸­é€‰æ‹©ä¸€ç§ï¼Œä½¿ç”¨è¯¥ç®—æ³•å¯¹å“åº”çš„æ¶ˆæ¯ä¸»ä½“è¿›è¡Œå‹ç¼©ï¼Œå¹¶ä¸”å‘é€ <strong>Content-Encoding</strong> é¦–éƒ¨æ¥å‘ŠçŸ¥æµè§ˆå™¨å®ƒé€‰æ‹©äº†å“ªä¸€ç§ç®—æ³•ã€‚ç”±äºè¯¥<strong>å†…å®¹åå•†è¿‡ç¨‹</strong>åŸºäº<strong>ç¼–ç ç±»å‹</strong>æ¥é€‰æ‹©èµ„æºçš„å±•ç°å½¢å¼ï¼Œ<strong>å“åº”æŠ¥æ–‡çš„ Vary é¦–éƒ¨å­—æ®µ</strong>è‡³å°‘è¦åŒ…å« Content-Encodingã€‚</p><h3 id="èŒƒå›´è¯·æ±‚"><a href="#èŒƒå›´è¯·æ±‚" class="headerlink" title="èŒƒå›´è¯·æ±‚"></a>èŒƒå›´è¯·æ±‚</h3><p>å¦‚æœç½‘ç»œå‡ºç°ä¸­æ–­ï¼ŒæœåŠ¡å™¨åªå‘é€äº†ä¸€éƒ¨åˆ†æ•°æ®ï¼ŒèŒƒå›´è¯·æ±‚å¯ä»¥ä½¿å¾—å®¢æˆ·ç«¯åªè¯·æ±‚æœåŠ¡å™¨æœªå‘é€çš„é‚£éƒ¨åˆ†æ•°æ®ï¼Œä»è€Œé¿å…æœåŠ¡å™¨é‡æ–°å‘é€æ‰€æœ‰æ•°æ®ã€‚</p><h4 id="Range"><a href="#Range" class="headerlink" title="Range"></a>Range</h4><p>åœ¨è¯·æ±‚æŠ¥æ–‡ä¸­æ·»åŠ  <strong>Range é¦–éƒ¨å­—æ®µ</strong>æŒ‡å®šè¯·æ±‚çš„èŒƒå›´</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">GET /z4d4kWk.jpg HTTP/1.1</span><br><span class="line">Host: i.imgur.com</span><br><span class="line">Range: bytes=0-1023</span><br></pre></td></tr></table></figure><p>è¯·æ±‚æˆåŠŸæœåŠ¡å™¨è¿”å›çš„å“åº”åŒ…å« <strong>206 Partial Content</strong> çŠ¶æ€ç </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">HTTP/1.1 206 Partial Content</span><br><span class="line">Content-Range: bytes 0-1023/146515</span><br><span class="line">Content-Length: 1024</span><br><span class="line">...</span><br><span class="line">(binary content)</span><br></pre></td></tr></table></figure><h4 id="Accept-Ranges"><a href="#Accept-Ranges" class="headerlink" title="Accept-Ranges"></a>Accept-Ranges</h4><p>å“åº”<strong>é¦–éƒ¨å­—æ®µ Accept-Ranges</strong> ç”¨äºå‘ŠçŸ¥å®¢æˆ·ç«¯èƒ½å¦å¤„ç†èŒƒå›´è¯·æ±‚ï¼Œèƒ½å¤„ç†ä½¿ç”¨ bytesï¼Œå¦åˆ™ä½¿ç”¨ noneã€‚</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Accept-Ranges: bytes</span><br></pre></td></tr></table></figure><h4 id="å“åº”çŠ¶æ€ç "><a href="#å“åº”çŠ¶æ€ç " class="headerlink" title="å“åº”çŠ¶æ€ç "></a>å“åº”çŠ¶æ€ç </h4><ul><li>åœ¨è¯·æ±‚æˆåŠŸçš„æƒ…å†µä¸‹ï¼ŒæœåŠ¡å™¨ä¼šè¿”å› <strong>206 Partial Content</strong> çŠ¶æ€ç ã€‚</li><li>åœ¨è¯·æ±‚çš„èŒƒå›´è¶Šç•Œçš„æƒ…å†µä¸‹ï¼ŒæœåŠ¡å™¨ä¼šè¿”å› <strong>416 Requested Range Not Satisfiable</strong> çŠ¶æ€ç ã€‚</li><li>åœ¨ä¸æ”¯æŒèŒƒå›´è¯·æ±‚çš„æƒ…å†µä¸‹ï¼ŒæœåŠ¡å™¨ä¼šè¿”å› <strong>200 OK</strong> çŠ¶æ€ç ã€‚</li></ul><h3 id="åˆ†å—ä¼ è¾“ç¼–ç "><a href="#åˆ†å—ä¼ è¾“ç¼–ç " class="headerlink" title="åˆ†å—ä¼ è¾“ç¼–ç "></a>åˆ†å—ä¼ è¾“ç¼–ç </h3><p><strong>Chunked Transfer Encoding</strong>ï¼ŒæŠŠæ•°æ®åˆ†å‰²æˆå¤šå—ï¼Œè®©æµè§ˆå™¨é€æ­¥æ˜¾ç¤ºé¡µé¢ã€‚</p><h3 id="å¤šéƒ¨åˆ†å¯¹è±¡é›†åˆ"><a href="#å¤šéƒ¨åˆ†å¯¹è±¡é›†åˆ" class="headerlink" title="å¤šéƒ¨åˆ†å¯¹è±¡é›†åˆ"></a>å¤šéƒ¨åˆ†å¯¹è±¡é›†åˆ</h3><p>ä¸€ä»½æŠ¥æ–‡ä¸»ä½“å†…å¯<strong>å«æœ‰å¤šç§ç±»å‹çš„å®ä½“åŒæ—¶å‘é€</strong>ï¼Œæ¯ä¸ªéƒ¨åˆ†ä¹‹é—´ç”¨ <strong>boundary å­—æ®µå®šä¹‰çš„åˆ†éš”ç¬¦è¿›è¡Œåˆ†éš”</strong>ï¼Œæ¯ä¸ªéƒ¨åˆ†éƒ½å¯ä»¥æœ‰é¦–éƒ¨å­—æ®µã€‚<br />ä¾‹å¦‚ï¼Œä¸Šä¼ å¤šä¸ªè¡¨å•æ—¶å¯ä»¥ä½¿ç”¨å¦‚ä¸‹æ–¹å¼ï¼š</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Content-Type: multipart/form-data; boundary=AaB03x</span><br><span class="line"></span><br><span class="line">--AaB03x</span><br><span class="line">Content-Disposition: form-data; name=&quot;submit-name&quot;</span><br><span class="line"></span><br><span class="line">Larry</span><br><span class="line">--AaB03x</span><br><span class="line">Content-Disposition: form-data; name=&quot;files&quot;; filename=&quot;file1.txt&quot;</span><br><span class="line">Content-Type: text/plain</span><br><span class="line"></span><br><span class="line">... contents of file1.txt ...</span><br><span class="line">--AaB03x--</span><br></pre></td></tr></table></figure><h3 id="è™šæ‹Ÿä¸»æœº"><a href="#è™šæ‹Ÿä¸»æœº" class="headerlink" title="è™šæ‹Ÿä¸»æœº"></a>è™šæ‹Ÿä¸»æœº</h3><p>HTTP&#x2F;1.1 ä½¿ç”¨<strong>è™šæ‹Ÿä¸»æœºæŠ€æœ¯</strong>ï¼Œä½¿å¾—ä¸€å°æœåŠ¡å™¨æ‹¥æœ‰å¤šä¸ªåŸŸåï¼Œå¹¶ä¸”åœ¨é€»è¾‘ä¸Šå¯ä»¥çœ‹æˆå¤šä¸ªæœåŠ¡å™¨ã€‚</p><h3 id="é€šä¿¡æ•°æ®è½¬å‘"><a href="#é€šä¿¡æ•°æ®è½¬å‘" class="headerlink" title="é€šä¿¡æ•°æ®è½¬å‘"></a>é€šä¿¡æ•°æ®è½¬å‘</h3><h4 id="ä»£ç†"><a href="#ä»£ç†" class="headerlink" title="ä»£ç†"></a>ä»£ç†</h4><p>ä»£ç†æœåŠ¡å™¨æ¥å—å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œå¹¶ä¸”è½¬å‘ç»™å…¶å®ƒæœåŠ¡å™¨ã€‚<br />ä½¿ç”¨ä»£ç†çš„<strong>ä¸»è¦ç›®çš„</strong>æ˜¯ï¼š</p><ul><li>ç¼“å­˜</li><li>è´Ÿè½½å‡è¡¡</li><li><strong>ç½‘ç»œè®¿é—®æ§åˆ¶</strong></li><li>è®¿é—®æ—¥å¿—è®°å½•</li></ul><p>ä»£ç†æœåŠ¡å™¨åˆ†ä¸ºæ­£å‘ä»£ç†å’Œåå‘ä»£ç†ä¸¤ç§ï¼š</p><ul><li>ç”¨æˆ·å¯Ÿè§‰å¾—åˆ°æ­£å‘ä»£ç†çš„å­˜åœ¨</li></ul><p><img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/a314bb79-5b18-4e63-a976-3448bffa6f1b.png#crop=0&crop=0&crop=1&crop=1&id=NdTW5&originHeight=170&originWidth=527&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=&width="></p><ul><li>åå‘ä»£ç†ä¸€èˆ¬ä½äºå†…éƒ¨ç½‘ç»œä¸­ï¼Œç”¨æˆ·å¯Ÿè§‰ä¸åˆ°</li></ul><p><img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/2d09a847-b854-439c-9198-b29c65810944.png#crop=0&crop=0&crop=1&crop=1&id=barhD&originHeight=175&originWidth=467&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=&width="></p><h4 id="ç½‘å…³"><a href="#ç½‘å…³" class="headerlink" title="ç½‘å…³"></a>ç½‘å…³</h4><p>ä¸ä»£ç†æœåŠ¡å™¨ä¸åŒçš„æ˜¯ï¼Œç½‘å…³æœåŠ¡å™¨ä¼š<strong>å°† HTTP è½¬åŒ–ä¸ºå…¶å®ƒåè®®è¿›è¡Œé€šä¿¡</strong>ï¼Œä»è€Œè¯·æ±‚å…¶å®ƒé HTTP æœåŠ¡å™¨çš„æœåŠ¡ã€‚</p><h4 id="éš§é“"><a href="#éš§é“" class="headerlink" title="éš§é“"></a>éš§é“</h4><p>ä½¿ç”¨ SSL ç­‰åŠ å¯†æ‰‹æ®µï¼Œåœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨é—´å»ºç«‹ä¸€æ¡<strong>å®‰å…¨çš„é€šä¿¡çº¿è·¯</strong>ã€‚</p><h2 id="HTTPS"><a href="#HTTPS" class="headerlink" title="HTTPS"></a>HTTPS</h2><h3 id="ç®€è¿°"><a href="#ç®€è¿°" class="headerlink" title="ç®€è¿°"></a>ç®€è¿°</h3><p>HTTP æœ‰ä»¥ä¸‹å®‰å…¨æ€§é—®é¢˜ï¼š</p><ul><li>ä½¿ç”¨<strong>æ˜æ–‡è¿›è¡Œé€šä¿¡</strong>ï¼Œå†…å®¹å¯èƒ½ä¼šè¢«çªƒå¬ï¼›</li><li>ä¸éªŒè¯é€šä¿¡æ–¹çš„èº«ä»½ï¼Œé€šä¿¡æ–¹çš„èº«ä»½æœ‰å¯èƒ½é­é‡<strong>ä¼ªè£…</strong>ï¼›</li><li>æ— æ³•è¯æ˜æŠ¥æ–‡çš„å®Œæ•´æ€§ï¼ŒæŠ¥æ–‡æœ‰å¯èƒ½é­<strong>ç¯¡æ”¹</strong>ã€‚</li></ul><p>HTTPS å¹¶ä¸æ˜¯æ–°åè®®ï¼Œè€Œæ˜¯è®© HTTP å…ˆå’Œ SSLï¼ˆSecure Sockets Layerï¼‰é€šä¿¡ï¼Œå†ç”± SSL å’Œ TCP é€šä¿¡ï¼Œå³ HTTPS ä½¿ç”¨äº†<strong>éš§é“è¿›è¡Œé€šä¿¡</strong>ã€‚é€šè¿‡ä½¿ç”¨ SSLï¼Œ<strong>HTTPS å…·æœ‰äº†åŠ å¯†ï¼ˆé˜²çªƒå¬ï¼‰ã€è®¤è¯ï¼ˆé˜²ä¼ªè£…ï¼‰å’Œå®Œæ•´æ€§ä¿æŠ¤ï¼ˆé˜²ç¯¡æ”¹ï¼‰</strong>ã€‚<br /><img src="/2022/11/18/HTTP-%C2%A9-CS-Notes/1668755393125-bf95e07d-2bd9-4e15-aab7-1210158297a2.png" class=""><br><img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/ssl-offloading.jpg#crop=0&crop=0&crop=1&crop=1&height=219&id=IU4oZ&originHeight=345&originWidth=1103&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=&width=700"></p><h3 id="åŠ å¯†"><a href="#åŠ å¯†" class="headerlink" title="åŠ å¯†"></a>åŠ å¯†</h3><h4 id="å¯¹ç§°å¯†é’¥åŠ å¯†"><a href="#å¯¹ç§°å¯†é’¥åŠ å¯†" class="headerlink" title="å¯¹ç§°å¯†é’¥åŠ å¯†"></a>å¯¹ç§°å¯†é’¥åŠ å¯†</h4><p><strong>å¯¹ç§°å¯†é’¥åŠ å¯†</strong>ï¼ˆSymmetric-Key Encryptionï¼‰ï¼ŒåŠ å¯†å’Œè§£å¯†ä½¿ç”¨åŒä¸€å¯†é’¥ã€‚</p><ul><li>ä¼˜ç‚¹ï¼šè¿ç®—é€Ÿåº¦å¿«ï¼›</li><li>ç¼ºç‚¹ï¼šæ— æ³•å®‰å…¨åœ°å°†å¯†é’¥ä¼ è¾“ç»™é€šä¿¡æ–¹ï¼›</li></ul><p><img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/7fffa4b8-b36d-471f-ad0c-a88ee763bb76.png#crop=0&crop=0&crop=1&crop=1&height=287&id=Ndlwz&originHeight=369&originWidth=772&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=&width=600"></p><h4 id="éå¯¹ç§°å¯†é’¥åŠ å¯†"><a href="#éå¯¹ç§°å¯†é’¥åŠ å¯†" class="headerlink" title="éå¯¹ç§°å¯†é’¥åŠ å¯†"></a>éå¯¹ç§°å¯†é’¥åŠ å¯†</h4><p><strong>éå¯¹ç§°å¯†é’¥åŠ å¯†</strong>ï¼Œåˆç§°<strong>å…¬å¼€å¯†é’¥åŠ å¯†</strong>ï¼ˆPublic-Key Encryptionï¼‰ï¼ŒåŠ å¯†å’Œè§£å¯†ä½¿ç”¨ä¸åŒçš„å¯†é’¥ã€‚<br /><strong>å…¬å¼€å¯†é’¥æ‰€æœ‰äººéƒ½å¯ä»¥è·å¾—</strong>ï¼Œé€šä¿¡å‘é€æ–¹è·å¾—æ¥æ”¶æ–¹çš„å…¬å¼€å¯†é’¥ä¹‹åï¼Œå°±å¯ä»¥ä½¿ç”¨å…¬å¼€å¯†é’¥è¿›è¡ŒåŠ å¯†ï¼Œæ¥æ”¶æ–¹æ”¶åˆ°é€šä¿¡å†…å®¹åä½¿ç”¨ç§æœ‰å¯†é’¥è§£å¯†ã€‚<br />éå¯¹ç§°å¯†é’¥é™¤äº†ç”¨æ¥<strong>åŠ å¯†</strong>ï¼Œè¿˜å¯ä»¥ç”¨æ¥è¿›è¡Œ<strong>ç­¾å</strong>ï¼Œé€šä¿¡å‘é€æ–¹ä½¿ç”¨å…¶ç§æœ‰å¯†é’¥è¿›è¡Œç­¾åï¼Œé€šä¿¡æ¥æ”¶æ–¹ä½¿ç”¨å‘é€æ–¹çš„å…¬å¼€å¯†é’¥å¯¹ç­¾åè¿›è¡Œè§£å¯†ï¼Œå› ä¸ºç§æœ‰å¯†é’¥æ— æ³•è¢«å…¶ä»–äººè·å–ï¼Œå› æ­¤å°±èƒ½åˆ¤æ–­è¿™ä¸ªç­¾åæ˜¯å¦æ­£ç¡®ã€‚</p><ul><li>ä¼˜ç‚¹ï¼šå¯ä»¥æ›´å®‰å…¨åœ°å°†å…¬å¼€å¯†é’¥ä¼ è¾“ç»™é€šä¿¡å‘é€æ–¹ï¼›</li><li>ç¼ºç‚¹ï¼šè¿ç®—é€Ÿåº¦æ…¢ï¼›</li></ul><p><img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/39ccb299-ee99-4dd1-b8b4-2f9ec9495cb4.png#crop=0&crop=0&crop=1&crop=1&height=303&id=rnCSR&originHeight=393&originWidth=779&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=&width=600"></p><h4 id="HTTPSé‡‡ç”¨çš„åŠ å¯†æ–¹å¼"><a href="#HTTPSé‡‡ç”¨çš„åŠ å¯†æ–¹å¼" class="headerlink" title="HTTPSé‡‡ç”¨çš„åŠ å¯†æ–¹å¼"></a>HTTPSé‡‡ç”¨çš„åŠ å¯†æ–¹å¼</h4><p><strong>HTTPS é‡‡ç”¨æ··åˆçš„åŠ å¯†æœºåˆ¶ï¼Œ</strong>å¯¹ç§°å¯†é’¥åŠ å¯†æ–¹å¼çš„ä¼ è¾“æ•ˆç‡æ›´é«˜ï¼Œä½†æ— æ³•å®‰å…¨åœ°å°†å¯†é’¥ Secret Key ä¼ è¾“ç»™é€šä¿¡æ–¹ï¼Œéå¯¹ç§°å¯†é’¥åŠ å¯†æ–¹å¼èƒ½ä¿è¯ä¼ è¾“çš„å®‰å…¨æ€§ã€‚</p><ul><li>ä½¿ç”¨<strong>éå¯¹ç§°å¯†é’¥åŠ å¯†</strong>æ–¹å¼ï¼Œä¼ è¾“å¯¹ç§°å¯†é’¥åŠ å¯†æ–¹å¼æ‰€éœ€è¦çš„ <strong>Secret Key</strong>ï¼Œä¿è¯å®‰å…¨æ€§;</li><li>è·å–åˆ° Secret Key åï¼Œä½¿ç”¨<strong>å¯¹ç§°å¯†é’¥åŠ å¯†</strong>æ–¹å¼è¿›è¡Œé€šä¿¡ï¼Œä»è€Œ<strong>ä¿è¯æ•ˆç‡</strong>ã€‚</li></ul><p>ï¼ˆä¸‹å›¾ä¸­çš„ Session Key å°±æ˜¯ Secret Keyï¼‰<br /><img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/How-HTTPS-Works.png#crop=0&crop=0&crop=1&crop=1&height=1563&id=lvcxJ&originHeight=5000&originWidth=1920&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=&width=600"></p><h3 id="è®¤è¯-æ•°å­—è¯ä¹¦"><a href="#è®¤è¯-æ•°å­—è¯ä¹¦" class="headerlink" title="è®¤è¯ æ•°å­—è¯ä¹¦"></a>è®¤è¯ æ•°å­—è¯ä¹¦</h3><p>è§£å†³é€šä¿¡æ–¹èº«ä»½å¯èƒ½è¢«ä¼ªè£…çš„é—®é¢˜ï¼Œé€šè¿‡ä½¿ç”¨ <strong>è¯ä¹¦</strong> æ¥å¯¹é€šä¿¡æ–¹è¿›è¡Œè®¤è¯ã€‚<br />æ•°å­—è¯ä¹¦è®¤è¯æœºæ„ï¼ˆ<strong>CA</strong>ï¼ŒCertificate Authorityï¼‰æ˜¯å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨åŒæ–¹éƒ½å¯ä¿¡èµ–çš„ç¬¬ä¸‰æ–¹æœºæ„ã€‚æœåŠ¡å™¨çš„è¿è¥äººå‘˜å‘ CA æå‡ºå…¬å¼€å¯†é’¥çš„ç”³è¯·ï¼ŒCA åœ¨åˆ¤æ˜æå‡ºç”³è¯·è€…çš„èº«ä»½ä¹‹åï¼Œ<strong>å¯¹å·²ç”³è¯·çš„å…¬å¼€å¯†é’¥åšæ•°å­—ç­¾åï¼Œå¹¶åˆ†é…è¿™ä¸ªå·²ç­¾åçš„å…¬å¼€å¯†é’¥ï¼Œå¹¶å°†è¯¥å…¬å¼€å¯†é’¥æ”¾å…¥å…¬å¼€å¯†é’¥è¯ä¹¦åç»‘å®šåœ¨ä¸€èµ·</strong>ã€‚è¿›è¡Œ HTTPS é€šä¿¡æ—¶ï¼ŒæœåŠ¡å™¨ä¼šæŠŠ<strong>è¯ä¹¦</strong>å‘é€ç»™å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯å–å¾—å…¶ä¸­çš„å…¬å¼€å¯†é’¥ä¹‹åï¼Œå…ˆä½¿ç”¨<strong>æ•°å­—ç­¾åè¿›è¡ŒéªŒè¯</strong>ï¼Œå¦‚æœéªŒè¯é€šè¿‡ï¼Œå°±å¯ä»¥å¼€å§‹é€šä¿¡äº†ã€‚<br /><img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/2017-06-11-ca.png#crop=0&crop=0&crop=1&crop=1&id=IOT2j&originHeight=595&originWidth=800&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=&width="></p><h3 id="å®Œæ•´æ€§ä¿æŠ¤"><a href="#å®Œæ•´æ€§ä¿æŠ¤" class="headerlink" title="å®Œæ•´æ€§ä¿æŠ¤"></a>å®Œæ•´æ€§ä¿æŠ¤</h3><p>HTTP æä¾› MD5 æŠ¥æ–‡æ‘˜è¦åŠŸèƒ½ï¼Œä½†ä¸æ˜¯å®‰å…¨çš„ï¼Œå¦‚æŠ¥æ–‡å†…å®¹è¢«ç¯¡æ”¹ä¹‹åï¼ŒåŒæ—¶é‡æ–°è®¡ç®— MD5 çš„å€¼ï¼Œé€šä¿¡æ¥æ”¶æ–¹æ˜¯æ— æ³•æ„è¯†åˆ°å‘ç”Ÿäº†ç¯¡æ”¹ã€‚<br />SSL æä¾›<strong>æŠ¥æ–‡æ‘˜è¦</strong>åŠŸèƒ½æ¥è¿›è¡Œå®Œæ•´æ€§ä¿æŠ¤ï¼ŒHTTPS çš„æŠ¥æ–‡æ‘˜è¦åŠŸèƒ½æ˜¯å®‰å…¨çš„ï¼Œå› ä¸ºå®ƒç»“åˆäº†<strong>åŠ å¯†å’Œè®¤è¯</strong>è¿™ä¸¤ä¸ªæ“ä½œï¼ŒåŠ å¯†ä¹‹åçš„æŠ¥æ–‡ï¼Œé­åˆ°ç¯¡æ”¹ä¹‹åï¼Œå› ä¸ºæ— æ³•è½»æ˜“è·å–æ˜æ–‡ï¼Œæ‰€ä»¥å¾ˆéš¾é‡æ–°è®¡ç®—æŠ¥æ–‡æ‘˜è¦ã€‚</p><h3 id="HTTPSçš„ç¼ºç‚¹"><a href="#HTTPSçš„ç¼ºç‚¹" class="headerlink" title="HTTPSçš„ç¼ºç‚¹"></a>HTTPSçš„ç¼ºç‚¹</h3><ul><li>éœ€è¦è¿›è¡ŒåŠ å¯†è§£å¯†ç­‰è¿‡ç¨‹ï¼Œå³<strong>é€Ÿåº¦ä¼šæ›´æ…¢</strong>ï¼›</li><li>éœ€è¦<strong>æ”¯ä»˜è¯ä¹¦æˆæƒçš„é«˜é¢è´¹ç”¨</strong>ï¼›</li></ul><h2 id="HTTP-x2F-1-1-æ–°ç‰¹æ€§"><a href="#HTTP-x2F-1-1-æ–°ç‰¹æ€§" class="headerlink" title="HTTP&#x2F;1.1 æ–°ç‰¹æ€§"></a>HTTP&#x2F;1.1 æ–°ç‰¹æ€§</h2><ul><li>é»˜è®¤æ˜¯é•¿è¿æ¥</li><li>æ”¯æŒæµæ°´çº¿</li><li>æ”¯æŒåŒæ—¶æ‰“å¼€å¤šä¸ª TCP è¿æ¥</li><li>æ”¯æŒè™šæ‹Ÿä¸»æœº</li><li>æ–°å¢çŠ¶æ€ç  100</li><li>æ”¯æŒåˆ†å—ä¼ è¾“ç¼–ç </li><li>æ–°å¢ç¼“å­˜å¤„ç†æŒ‡ä»¤ max-age</li></ul><h2 id="HTTP-x2F-2-0-æ–°ç‰ˆæœ¬"><a href="#HTTP-x2F-2-0-æ–°ç‰ˆæœ¬" class="headerlink" title="HTTP&#x2F;2.0 æ–°ç‰ˆæœ¬"></a>HTTP&#x2F;2.0 æ–°ç‰ˆæœ¬</h2><h3 id="HTTP-x2F-1-x-ç¼ºé™·"><a href="#HTTP-x2F-1-x-ç¼ºé™·" class="headerlink" title="HTTP&#x2F;1.x ç¼ºé™·"></a>HTTP&#x2F;1.x ç¼ºé™·</h3><p>HTTP&#x2F;1.x å®ç°ç®€å•<strong>ä»¥ç‰ºç‰²æ€§èƒ½ä¸ºä»£ä»·</strong>ï¼š</p><ul><li>å®¢æˆ·ç«¯éœ€è¦ä½¿ç”¨å¤šä¸ªè¿æ¥æ‰èƒ½å®ç°å¹¶å‘å’Œç¼©çŸ­å»¶è¿Ÿï¼›</li><li><strong>ä¸ä¼šå‹ç¼©è¯·æ±‚å’Œå“åº”é¦–éƒ¨</strong>ï¼Œä»è€Œå¯¼è‡´ä¸å¿…è¦çš„ç½‘ç»œæµé‡ï¼›</li><li>ä¸æ”¯æŒæœ‰æ•ˆçš„èµ„æºä¼˜å…ˆçº§ï¼Œè‡´ä½¿åº•å±‚ <strong>TCP è¿æ¥çš„åˆ©ç”¨ç‡</strong>ä½ä¸‹ï¼›</li></ul><h3 id="äºŒè¿›åˆ¶åˆ†å¸§å±‚"><a href="#äºŒè¿›åˆ¶åˆ†å¸§å±‚" class="headerlink" title="äºŒè¿›åˆ¶åˆ†å¸§å±‚"></a>äºŒè¿›åˆ¶åˆ†å¸§å±‚</h3><p>HTTP&#x2F;2.0 å°†æŠ¥æ–‡åˆ†æˆ <strong>HEADERS å¸§å’Œ DATA å¸§</strong>ï¼Œéƒ½æ˜¯äºŒè¿›åˆ¶æ ¼å¼<br /><img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/86e6a91d-a285-447a-9345-c5484b8d0c47.png#crop=0&crop=0&crop=1&crop=1&height=315&id=uzlHH&originHeight=438&originWidth=557&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=&width=400"><br>åœ¨é€šä¿¡è¿‡ç¨‹ä¸­ï¼Œ<strong>åªå­˜åœ¨ä¸€ä¸ª TCP è¿æ¥</strong>ï¼Œå®ƒæ‰¿è½½äº†ä»»æ„æ•°é‡çš„åŒå‘æ•°æ®æµï¼ˆStreamï¼‰</p><ul><li>ä¸€ä¸ªæ•°æ®æµï¼ˆStreamï¼‰éƒ½æœ‰ä¸€ä¸ª<strong>å”¯ä¸€æ ‡è¯†ç¬¦</strong>å’Œå¯é€‰çš„<strong>ä¼˜å…ˆçº§</strong>ä¿¡æ¯ï¼Œç”¨äºæ‰¿è½½åŒå‘ä¿¡æ¯</li><li>æ¶ˆæ¯ï¼ˆMessageï¼‰æ˜¯ä¸é€»è¾‘è¯·æ±‚æˆ–å“åº”å¯¹åº”çš„å®Œæ•´çš„ä¸€ç³»åˆ—å¸§</li><li><strong>å¸§ï¼ˆFrameï¼‰æ˜¯æœ€å°çš„é€šä¿¡å•ä½</strong>ï¼Œ<strong>æ¥è‡ªä¸åŒæ•°æ®æµçš„å¸§å¯ä»¥äº¤é”™å‘é€ï¼Œç„¶åæ ¹æ®æ¯ä¸ªå¸§å¤´çš„æ•°æ®æµæ ‡è¯†ç¬¦é‡æ–°ç»„è£…</strong></li></ul><p><img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/af198da1-2480-4043-b07f-a3b91a88b815.png#crop=0&crop=0&crop=1&crop=1&height=462&id=ozGf7&originHeight=720&originWidth=936&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=&width=600"></p><h3 id="æœåŠ¡ç«¯æ¨é€"><a href="#æœåŠ¡ç«¯æ¨é€" class="headerlink" title="æœåŠ¡ç«¯æ¨é€"></a>æœåŠ¡ç«¯æ¨é€</h3><p>HTTP&#x2F;2.0 åœ¨å®¢æˆ·ç«¯è¯·æ±‚ä¸€ä¸ªèµ„æºæ—¶ï¼ŒæŠŠ<strong>ç›¸å…³çš„èµ„æºä¸€èµ·å‘é€ç»™å®¢æˆ·ç«¯</strong>ï¼Œå®¢æˆ·ç«¯å°±ä¸ç”¨å†æ¬¡å‘èµ·è¯·æ±‚ï¼Œå¦‚å®¢æˆ·ç«¯è¯·æ±‚ page.html é¡µé¢ï¼ŒæœåŠ¡ç«¯å°±æŠŠ script.js å’Œ style.css ç­‰ä¸ä¹‹ç›¸å…³çš„èµ„æºä¸€èµ·å‘ç»™å®¢æˆ·ç«¯ã€‚<br /><img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/e3f1657c-80fc-4dfa-9643-bf51abd201c6.png#crop=0&crop=0&crop=1&crop=1&height=320&id=vSTzs&originHeight=341&originWidth=853&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=&width=800"></p><h3 id="é¦–éƒ¨å‹ç¼©"><a href="#é¦–éƒ¨å‹ç¼©" class="headerlink" title="é¦–éƒ¨å‹ç¼©"></a>é¦–éƒ¨å‹ç¼©</h3><p>HTTP&#x2F;1.1 é¦–éƒ¨å¸¦æœ‰å¤§é‡ä¿¡æ¯ï¼Œè€Œä¸”æ¯æ¬¡éƒ½è¦é‡å¤å‘é€ã€‚<br />HTTP&#x2F;2.0 è¦æ±‚å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨åŒæ—¶<strong>ç»´æŠ¤å’Œæ›´æ–°</strong>ä¸€ä¸ªåŒ…å«ä¹‹å‰è§è¿‡çš„é¦–éƒ¨å­—æ®µè¡¨ï¼Œä»è€Œé¿å…äº†é‡å¤ä¼ è¾“ï¼ŒHTTP&#x2F;2.0 ä¹Ÿä½¿ç”¨ <strong>Huffman</strong> ç¼–ç å¯¹é¦–éƒ¨å­—æ®µè¿›è¡Œå‹ç¼©ã€‚<br /><img src="https://cs-notes-1256109796.cos.ap-guangzhou.myqcloud.com/_u4E0B_u8F7D.png#crop=0&crop=0&crop=1&crop=1&height=496&id=JeyxN&originHeight=722&originWidth=873&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=&width=600"></p><h2 id="GET-VS-POST"><a href="#GET-VS-POST" class="headerlink" title="GET VS POST"></a>GET VS POST</h2><h3 id="ä½œç”¨"><a href="#ä½œç”¨" class="headerlink" title="ä½œç”¨"></a>ä½œç”¨</h3><p>GET ç”¨äºè·å–èµ„æºï¼ŒPOST ç”¨äºä¼ è¾“å®ä½“ä¸»ä½“ã€‚</p><h3 id="å‚æ•°"><a href="#å‚æ•°" class="headerlink" title="å‚æ•°"></a>å‚æ•°</h3><p>GET å’Œ POST çš„è¯·æ±‚éƒ½èƒ½ä½¿ç”¨é¢å¤–çš„å‚æ•°ï¼ŒGET çš„å‚æ•°æ˜¯ä»¥æŸ¥è¯¢å­—ç¬¦ä¸²å‡ºç°åœ¨ URL ä¸­ï¼Œ POST çš„å‚æ•°å­˜å‚¨åœ¨å®ä½“ä¸»ä½“ä¸­ã€‚å®ƒä»¬éƒ½å¯ä»¥é€šè¿‡ä¸€äº›æŠ“åŒ…å·¥å…·ï¼ˆFiddlerï¼‰æŸ¥çœ‹ï¼Œä¸èƒ½å› ä¸º POST å‚æ•°å­˜å‚¨åœ¨å®ä½“ä¸»ä½“ä¸­å°±è®¤ä¸ºå®ƒçš„å®‰å…¨æ€§æ›´é«˜ã€‚<br />ç”±äº URL åªæ”¯æŒ ASCII ç ï¼Œå³ GET çš„å‚æ•°ä¸­å­˜åœ¨ä¸­æ–‡ç­‰å­—ç¬¦å°±éœ€è¦å…ˆè¿›è¡Œç¼–ç ï¼Œå¦‚ <code>ä¸­æ–‡</code> ä¼šè½¬æ¢ä¸º <code>%E4%B8%AD%E6%96%87</code>ï¼Œç©ºæ ¼ä¼šè½¬æ¢ä¸º <code>%20</code>ã€‚POST å‚æ•°æ”¯æŒæ ‡å‡†å­—ç¬¦é›†ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GET /test/demo_form.asp?name1=value1&amp;name2=value2 HTTP/1.1</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">POST /test/demo_form.asp HTTP/1.1</span><br><span class="line">Host: w3schools.com</span><br><span class="line">name1=value1&amp;name2=value2</span><br></pre></td></tr></table></figure><h3 id="å®‰å…¨"><a href="#å®‰å…¨" class="headerlink" title="å®‰å…¨"></a>å®‰å…¨</h3><p>å®‰å…¨çš„ HTTP æ–¹æ³•ä¸ä¼šæ”¹å˜æœåŠ¡å™¨çŠ¶æ€ï¼Œå³å®ƒåªæ˜¯å¯è¯»çš„ã€‚<br />GET æ–¹æ³•æ˜¯å®‰å…¨çš„ï¼ŒPOST æ–¹æ³•å´ä¸æ˜¯ï¼Œå› ä¸º POST æ–¹æ³•çš„ç›®çš„æ˜¯ä¼ é€å®ä½“ä¸»ä½“å†…å®¹ï¼Œè¿™ä¸ªå†…å®¹å¯èƒ½æ˜¯ç”¨æˆ·ä¸Šä¼ çš„è¡¨å•æ•°æ®ï¼Œä¸Šä¼ æˆåŠŸä¹‹åï¼ŒæœåŠ¡å™¨å¯èƒ½æŠŠè¿™ä¸ªæ•°æ®å­˜å‚¨åˆ°æ•°æ®åº“ä¸­ï¼Œå³çŠ¶æ€ä¹Ÿå°±å‘ç”Ÿäº†æ”¹å˜ã€‚</p><ul><li>å®‰å…¨çš„æ–¹æ³•é™¤äº† GET ä¹‹å¤–è¿˜æœ‰ï¼šHEADã€OPTIONSç­‰</li><li>ä¸å®‰å…¨çš„æ–¹æ³•é™¤äº† POST ä¹‹å¤–è¿˜æœ‰ PUTã€DELETEç­‰</li></ul><h3 id="å¹‚ç­‰æ€§"><a href="#å¹‚ç­‰æ€§" class="headerlink" title="å¹‚ç­‰æ€§"></a>å¹‚ç­‰æ€§</h3><p>å¹‚ç­‰çš„ HTTP æ–¹æ³•ï¼ŒåŒæ ·çš„è¯·æ±‚è¢«æ‰§è¡Œä¸€æ¬¡ä¸è¿ç»­æ‰§è¡Œå¤šæ¬¡çš„æ•ˆæœæ˜¯ä¸€æ ·çš„ï¼ŒæœåŠ¡å™¨çš„çŠ¶æ€ä¹Ÿæ˜¯ä¸€æ ·çš„ã€‚æ¢å¥è¯è¯´å°±æ˜¯ï¼Œ<strong>å¹‚ç­‰æ–¹æ³•ä¸åº”è¯¥å…·æœ‰å‰¯ä½œç”¨ï¼ˆç»Ÿè®¡ç”¨é€”é™¤å¤–ï¼‰</strong>ï¼Œæ‰€æœ‰çš„å®‰å…¨æ–¹æ³•ä¹Ÿéƒ½æ˜¯å¹‚ç­‰çš„ã€‚<br />åœ¨æ­£ç¡®å®ç°çš„æ¡ä»¶ä¸‹ï¼ŒGETï¼ŒHEADï¼ŒPUT å’Œ DELETE ç­‰æ–¹æ³•éƒ½æ˜¯å¹‚ç­‰çš„ï¼Œè€Œ POST æ–¹æ³•ä¸æ˜¯ã€‚</p><p>GET &#x2F;pageX HTTP&#x2F;1.1 æ˜¯å¹‚ç­‰çš„ï¼Œè¿ç»­è°ƒç”¨å¤šæ¬¡ï¼Œå®¢æˆ·ç«¯æ¥æ”¶åˆ°çš„ç»“æœéƒ½æ˜¯ä¸€æ ·çš„</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">GET /pageX HTTP/1.1</span><br><span class="line">GET /pageX HTTP/1.1</span><br><span class="line">GET /pageX HTTP/1.1</span><br><span class="line">GET /pageX HTTP/1.1</span><br></pre></td></tr></table></figure><p>POST &#x2F;add_row HTTP&#x2F;1.1 ä¸æ˜¯å¹‚ç­‰çš„ï¼Œå¦‚æœ<strong>è°ƒç”¨å¤šæ¬¡ï¼Œå°±ä¼šå¢åŠ å¤šè¡Œè®°å½•</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">POST /add_row HTTP/1.1   -&gt; Adds a 1nd row</span><br><span class="line">POST /add_row HTTP/1.1   -&gt; Adds a 2nd row</span><br><span class="line">POST /add_row HTTP/1.1   -&gt; Adds a 3rd row</span><br></pre></td></tr></table></figure><p>DELETE &#x2F;idX&#x2F;delete HTTP&#x2F;1.1 æ˜¯å¹‚ç­‰çš„ï¼Œå³ä½¿ä¸åŒçš„è¯·æ±‚æ¥æ”¶åˆ°çš„çŠ¶æ€ç ä¸ä¸€æ ·</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">DELETE /idX/delete HTTP/1.1   -&gt; Returns 200 if idX exists</span><br><span class="line">DELETE /idX/delete HTTP/1.1   -&gt; Returns 404 as it just got deleted</span><br><span class="line">DELETE /idX/delete HTTP/1.1   -&gt; Returns 404</span><br></pre></td></tr></table></figure><h3 id="å¯ç¼“å­˜"><a href="#å¯ç¼“å­˜" class="headerlink" title="å¯ç¼“å­˜"></a>å¯ç¼“å­˜</h3><p>å¦‚æœè¦å¯¹å“åº”è¿›è¡Œç¼“å­˜ï¼Œéœ€è¦æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š</p><ul><li>è¯·æ±‚æŠ¥æ–‡çš„ <strong>HTTP æ–¹æ³•æœ¬èº«å¯ç¼“å­˜</strong>ï¼ŒåŒ…æ‹¬ GET å’Œ HEADï¼Œä½†æ˜¯ PUT å’Œ DELETE ä¸å¯ç¼“å­˜ï¼Œ<strong>POST åœ¨å¤šæ•°æƒ…å†µä¸‹ä¸å¯ç¼“å­˜</strong>ã€‚</li><li>å“åº”æŠ¥æ–‡çš„<strong>çŠ¶æ€ç å¯ç¼“å­˜</strong>ï¼ŒåŒ…æ‹¬ï¼š200, 203, 204, 206, 300, 301, 404, 405, 410, 414, and 501ã€‚</li><li>å“åº”æŠ¥æ–‡çš„<strong>Cache-Control é¦–éƒ¨å­—æ®µ</strong>æ²¡æœ‰æŒ‡å®šä¸è¿›è¡Œç¼“å­˜ã€‚</li></ul><h3 id="XMLHttpRequest"><a href="#XMLHttpRequest" class="headerlink" title="XMLHttpRequest"></a>XMLHttpRequest</h3><blockquote><p>XMLHttpRequest æ˜¯ä¸€ä¸ª APIï¼Œä¸ºå®¢æˆ·ç«¯æä¾›äº†åœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´ä¼ è¾“æ•°æ®çš„åŠŸèƒ½ï¼Œæä¾›äº†ä¸€ä¸ªé€šè¿‡ URL æ¥è·å–æ•°æ®çš„ç®€å•æ–¹å¼ï¼Œå¹¶ä¸”ä¸ä¼šä½¿æ•´ä¸ªé¡µé¢åˆ·æ–°ï¼Œä½¿å¾—ç½‘é¡µ<strong>åªæ›´æ–°ä¸€éƒ¨åˆ†é¡µé¢è€Œä¸ä¼šæ‰“æ‰°åˆ°ç”¨æˆ·</strong>ï¼Œåœ¨ AJAX ä¸­è¢«å¤§é‡ä½¿ç”¨ã€‚</p></blockquote><ul><li>ä½¿ç”¨ XMLHttpRequest çš„ POST æ–¹æ³•æ—¶ï¼Œæµè§ˆå™¨ä¼šå…ˆå‘é€ Header å†å‘é€ Dataï¼Œä¸æ˜¯æ‰€æœ‰æµè§ˆå™¨ä¼šè¿™ä¹ˆåš (ç«ç‹ä¸ä¼š)ã€‚</li><li>ä½¿ç”¨ XMLHttpRequest çš„ GET æ–¹æ³•æ—¶, æµè§ˆå™¨ä¼šå°† Header å’Œ Data ä¼šä¸€èµ·å‘é€ã€‚</li></ul><h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul><li>ä¸Šé‡å®£. å›¾è§£ HTTP[M]. äººæ°‘é‚®ç”µå‡ºç‰ˆç¤¾, 2014.</li><li><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP">MDN : HTTP</a></li><li><a href="https://developers.google.com/web/fundamentals/performance/http2/?hl=zh-cn">HTTP&#x2F;2 ç®€ä»‹</a></li><li><a href="http://php.net/manual/zh/function.htmlspecialchars.php">htmlspecialchars</a></li><li><a href="http://java2db.com/java-io/how-to-get-and-the-difference-between-file-uri-and-url-in-java">Difference between file URI and URL in java</a></li><li><a href="https://software-security.sans.org/developer-how-to/fix-sql-injection-in-java-using-prepared-callable-statement">How to Fix SQL Injection Using Java PreparedStatement &amp; CallableStatement</a></li><li><a href="https://www.cnblogs.com/hyddd/archive/2009/03/31/1426026.html">æµ…è°ˆ HTTP ä¸­ Get ä¸ Post çš„åŒºåˆ«</a></li><li><a href="https://www.webdancers.com/are-http-and-www-necesary/">Are http:&#x2F;&#x2F; and www really necessary?</a></li><li><a href="https://www.ntu.edu.sg/home/ehchua/programming/webprogramming/HTTP_Basics.html">HTTP (HyperText Transfer Protocol)</a></li><li><a href="https://www.igvita.com/2011/12/01/web-vpn-secure-proxies-with-spdy-chrome/">Web-VPN: Secure Proxies with SPDY &amp; Chrome</a></li><li><a href="http://en.wikipedia.org/wiki/File:HTTP_persistent_connection.svg">File:HTTP persistent connection.svg</a></li><li><a href="https://en.wikipedia.org/wiki/Proxy_server">Proxy server</a></li><li><a href="https://www.x-cart.com/blog/what-is-https-and-ssl.html">What Is This HTTPS&#x2F;SSL Thing And Why Should You Care?</a></li><li><a href="https://securebox.comodo.com/ssl-sniffing/ssl-offloading/">What is SSL Offloading?</a></li><li><a href="https://docs.oracle.com/cd/E19424-01/820-4811/6ng8i26bn/index.html">Sun Directory Server Enterprise Edition 7.0 Reference - Key Encryption</a></li><li><a href="https://www.codeproject.com/Articles/326574/An-Introduction-to-Mutual-SSL-Authentication">An Introduction to Mutual SSL Authentication</a></li><li><a href="https://danielmiessler.com/study/url-uri/">The Difference Between URLs and URIs</a></li><li><a href="https://juejin.im/entry/5766c29d6be3ff006a31b84e#comment">Cookie ä¸ Session çš„åŒºåˆ«</a></li><li><a href="https://www.zhihu.com/question/19786827">COOKIE å’Œ SESSION æœ‰ä»€ä¹ˆåŒºåˆ«</a></li><li><a href="https://harttle.land/2015/08/10/cookie-session.html">Cookie&#x2F;Session çš„æœºåˆ¶ä¸å®‰å…¨</a></li><li><a href="https://shijianan.com/2017/06/11/https/">HTTPS è¯ä¹¦åŸç†</a></li><li><a href="https://stackoverflow.com/questions/176264/what-is-the-difference-between-a-uri-a-url-and-a-urn">What is the difference between a URI, a URL and a URN?</a></li><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/XMLHttpRequest">XMLHttpRequest</a></li><li><a href="https://blog.josephscott.org/2009/08/27/xmlhttprequest-xhr-uses-multiple-packets-for-http-post/">XMLHttpRequest (XHR) Uses Multiple Packets for HTTP POST?</a></li><li><a href="https://www.ssl2buy.com/wiki/symmetric-vs-asymmetric-encryption-what-are-differences">Symmetric vs. Asymmetric Encryption â€“ What are differences?</a></li><li><a href="https://www.kancloud.cn/digest/web-performance-http2">Web æ€§èƒ½ä¼˜åŒ–ä¸ HTTP&#x2F;2</a></li><li><a href="https://developers.google.com/web/fundamentals/performance/http2/?hl=zh-cn">HTTP&#x2F;2 ç®€ä»‹</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> è®¡ç®—æœºç½‘ç»œ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> HTTP </tag>
            
            <tag> è®¡ç®—æœºç½‘ç»œ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>EasyExcel Â© pepsi-wyl</title>
      <link href="/2022/11/16/EasyExcel-%C2%A9-pepsi-wyl/"/>
      <url>/2022/11/16/EasyExcel-%C2%A9-pepsi-wyl/</url>
      
        <content type="html"><![CDATA[<h1 id="åˆè¯†EasyExcel"><a href="#åˆè¯†EasyExcel" class="headerlink" title="åˆè¯†EasyExcel"></a>åˆè¯†EasyExcel</h1><h2 id="Apache-POI"><a href="#Apache-POI" class="headerlink" title="Apache POI"></a>Apache POI</h2><p>Apache POIæ˜¯Apacheè½¯ä»¶åŸºé‡‘ä¼šçš„å¼€æºå‡½å¼åº“ï¼Œæä¾›è·¨å¹³å°çš„Java APIå®ç°<code>Microsoft Office</code>æ ¼å¼æ¡£æ¡ˆè¯»å†™ã€‚<br />ç‰¹ç‚¹</p><ol><li>åŠŸèƒ½å¼ºå¤§ </li><li>ä»£ç ä¹¦å†™å†—ä½™ç¹æ‚ ,å­¦ä¹ å’Œä½¿ç”¨æˆæœ¬è¾ƒé«˜</li><li>è¯»å†™å¤§æ–‡ä»¶è€—è´¹å†…å­˜è¾ƒå¤§ï¼Œå®¹æ˜“OOM</li></ol><h2 id="EasyExcel"><a href="#EasyExcel" class="headerlink" title="EasyExcel"></a>EasyExcel</h2><p><a href="https://github.com/alibaba/easyexcel">GitHubåœ°å€</a>     <a href="https://easyexcel.opensource.alibaba.com/">å®˜ç½‘åœ°å€</a><br>EasyExcelæ˜¯ä¸€ä¸ªåŸºäºJavaçš„<strong>ç®€å•ã€çœå†…å­˜</strong>çš„è¯»å†™Excelçš„å¼€æºé¡¹ç›®ï¼Œåœ¨å°½å¯èƒ½èŠ‚çº¦å†…å­˜çš„æƒ…å†µä¸‹æ”¯æŒè¯»å†™ç™¾Mçš„Excelã€‚<br />ç‰¹ç‚¹</p><ol><li>åœ¨æ•°æ®æ¨¡å‹å±‚é¢è¿›è¡Œäº†å°è£…ï¼Œä½¿ç”¨ç®€å•</li><li>é‡å†™äº†07ç‰ˆæœ¬çš„Excelçš„è§£æä»£ç ï¼Œé™ä½å†…å­˜æ¶ˆè€—ï¼Œèƒ½æœ‰æ•ˆé¿å…OOM</li><li>åªèƒ½æ“ä½œExcel</li><li>ä¸èƒ½è¯»å–å›¾ç‰‡</li></ol><p>æ€§èƒ½æµ‹è¯•<br />64Må†…å­˜20ç§’è¯»å–75M(46Wè¡Œ25åˆ—)çš„Excelï¼ˆ3.0.2+ç‰ˆæœ¬ï¼‰ï¼Œä¹Ÿæœ‰<a href="https://easyexcel.opensource.alibaba.com/qa/read#%E5%BC%80%E5%90%AF%E6%80%A5%E9%80%9F%E6%A8%A1%E5%BC%8F">æé€Ÿæ¨¡å¼</a>èƒ½æ›´å¿«ï¼Œä½†æ˜¯å†…å­˜å ç”¨ä¼šåœ¨100Må¤šä¸€ç‚¹ã€‚<br />![large-4261205e1a145b60a6051d57afe137d1.png](.&#x2F;assets&#x2F;1668427614873-2a21e2a6-e3fb-40d2-a08f-9430f3faa6de.png %}</p><h1 id="å¿«é€Ÿå…¥é—¨"><a href="#å¿«é€Ÿå…¥é—¨" class="headerlink" title="å¿«é€Ÿå…¥é—¨"></a>å¿«é€Ÿå…¥é—¨</h1><h2 id="å®˜ç½‘åœ°å€"><a href="#å®˜ç½‘åœ°å€" class="headerlink" title="å®˜ç½‘åœ°å€"></a>å®˜ç½‘åœ°å€</h2><p>å¿«é€Ÿå¼€å§‹ <a href="https://easyexcel.opensource.alibaba.com/docs/current/">https://easyexcel.opensource.alibaba.com/docs/current/</a><br>è¯»Excel <a href="https://easyexcel.opensource.alibaba.com/docs/current/quickstart/read">https://easyexcel.opensource.alibaba.com/docs/current/quickstart/read</a><br>å†™Excel <a href="https://easyexcel.opensource.alibaba.com/docs/current/quickstart/write">https://easyexcel.opensource.alibaba.com/docs/current/quickstart/write</a></p><h2 id="å¯¼å…¥ä¾èµ–åæ ‡"><a href="#å¯¼å…¥ä¾èµ–åæ ‡" class="headerlink" title="å¯¼å…¥ä¾èµ–åæ ‡"></a>å¯¼å…¥ä¾èµ–åæ ‡</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- EasyExcel --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>easyexcel<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- lombok ä¼˜é›…ç¼–ç¨‹ --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.18.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- junit --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="è¯»å–Excel"><a href="#è¯»å–Excel" class="headerlink" title="è¯»å–Excel"></a>è¯»å–Excel</h2><h3 id="å‡†å¤‡å·¥ä½œ"><a href="#å‡†å¤‡å·¥ä½œ" class="headerlink" title="å‡†å¤‡å·¥ä½œ"></a>å‡†å¤‡å·¥ä½œ</h3><p>ç¼–å†™Excelæ–‡ä»¶,å¤åˆ¶åˆ°<strong>resources</strong>ç›®å½•ä¸‹</p><img src="/2022/11/16/EasyExcel-%C2%A9-pepsi-wyl/1668491674370-cd1e6468-fa28-4e63-8dae-ec546334ef4b.png" class=""><h3 id="ç¼–å†™å®ä½“ç±»"><a href="#ç¼–å†™å®ä½“ç±»" class="headerlink" title="ç¼–å†™å®ä½“ç±»"></a>ç¼–å†™å®ä½“ç±»</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@EqualsAndHashCode</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//  @Accessors(chain = true) å¼•å‘éƒ¨åˆ†å­—æ®µæ²¡æ³•è¯»å–æˆ–è€…å†™å…¥</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Student</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Excelè¡¨å¤´ä¿¡æ¯ valueä¸ºè¡¨å¤´çš„å€¼ indexä¸ºç´¢å¼•ä½ç½® 0ä¸ºç¬¬ä¸€åˆ—</span></span><br><span class="line">    <span class="meta">@ExcelProperty(value = &quot;å­¦ç”Ÿå§“å&quot;, index = 0)</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExcelProperty(value = &quot;å­¦ç”Ÿæ€§åˆ«&quot;, index = 1)</span></span><br><span class="line">    <span class="keyword">private</span> String gender;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExcelProperty(value = &quot;å­¦ç”Ÿå‡ºç”Ÿæ—¥æœŸ&quot;, index = 2)</span></span><br><span class="line">    <span class="keyword">private</span> Date birthDate;    <span class="comment">// åªæ”¯æŒDateï¼Œä¸æ”¯æŒLocalDateå’ŒLocalDateTime</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="è¯»å–Excelæ–‡ä»¶"><a href="#è¯»å–Excelæ–‡ä»¶" class="headerlink" title="è¯»å–Excelæ–‡ä»¶"></a>è¯»å–Excelæ–‡ä»¶</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¯»å–Excel</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Excel_Read</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// 1.æ–‡ä»¶çš„è·¯å¾„ 2.å®ä½“ç±»çš„Class 3.è¯»ç›‘å¬å™¨è¯»</span></span><br><span class="line">        <span class="comment">// è·å–Resourceä¸‹çš„æ–‡ä»¶</span></span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> Thread.currentThread().getContextClassLoader().getResourceAsStream(<span class="string">&quot;student.xls&quot;</span>);</span><br><span class="line">        EasyExcel.read(</span><br><span class="line">                        inputStream,</span><br><span class="line">                        Student.class,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">StudentListener</span>()</span><br><span class="line">                )</span><br><span class="line">                .sheet()   <span class="comment">// é»˜è®¤ä¸ºè¡¨æ ¼1</span></span><br><span class="line">                .doRead(); <span class="comment">// å¼€å§‹è¯»å–</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Studentè¯»ç›‘å¬å™¨</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StudentListener</span> <span class="keyword">extends</span> <span class="title class_">AnalysisEventListener</span>&lt;Student&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¯»å–excelè¡¨å¤´ä¿¡æ¯ï¼ŒheadMapå³ä¸ºè¡¨å¤´ä¿¡æ¯</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">invokeHeadMap</span><span class="params">(Map&lt;Integer, String&gt; headMap, AnalysisContext context)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;è¡¨å¤´ä¿¡æ¯ï¼š&quot;</span> + headMap);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¯»å–å®Œä¸€è¡Œè°ƒç”¨ä¸€æ¬¡</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">invoke</span><span class="params">(Student student, AnalysisContext analysisContext)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;è¡¨ä½“ä¿¡æ¯ï¼š&quot;</span> + student);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ–‡æ¡£è¯»å–å®Œæˆåæ‰§è¡Œ</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doAfterAllAnalysed</span><span class="params">(AnalysisContext analysisContext)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;StudentExcelè¯»å–å®Œæ¯•&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="è¯»å–å®Œæˆ"><a href="#è¯»å–å®Œæˆ" class="headerlink" title="è¯»å–å®Œæˆ"></a>è¯»å–å®Œæˆ</h3><img src="/2022/11/16/EasyExcel-%C2%A9-pepsi-wyl/1668491915960-fda603c1-3e17-4257-af93-86036426e39e.png" class=""><h2 id="å†™å…¥Excel"><a href="#å†™å…¥Excel" class="headerlink" title="å†™å…¥Excel"></a>å†™å…¥Excel</h2><h3 id="åˆ›å»ºå†™å…¥æ–‡ä»¶å¤¹"><a href="#åˆ›å»ºå†™å…¥æ–‡ä»¶å¤¹" class="headerlink" title="åˆ›å»ºå†™å…¥æ–‡ä»¶å¤¹"></a>åˆ›å»ºå†™å…¥æ–‡ä»¶å¤¹</h3><p>å·¥ç¨‹è·¯å¾„ä¸‹&#x2F;downæ–‡ä»¶å¤¹</p><img src="/2022/11/16/EasyExcel-%C2%A9-pepsi-wyl/1668563592152-5e9fc15d-264d-4067-b8b7-126ebfb0015f.png" class=""><h3 id="ç¼–å†™å®ä½“ç±»-1"><a href="#ç¼–å†™å®ä½“ç±»-1" class="headerlink" title="ç¼–å†™å®ä½“ç±»"></a>ç¼–å†™å®ä½“ç±»</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@EqualsAndHashCode</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//  @Accessors(chain = true) å¼•å‘éƒ¨åˆ†å­—æ®µæ²¡æ³•è¯»å–æˆ–è€…å†™å…¥</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Student</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å†™å…¥æ—¶å€™å¿½ç•¥è¯¥å­—æ®µ</span></span><br><span class="line">    <span class="meta">@ExcelIgnore</span></span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Excelè¡¨å¤´ä¿¡æ¯ valueä¸ºè¡¨å¤´çš„å€¼ indexä¸ºExcelè¡¨çš„ç´¢å¼•ä½ç½®  0ä¸ºç¬¬ä¸€åˆ—</span></span><br><span class="line">    <span class="meta">@ExcelProperty(value = &quot;å­¦ç”Ÿå§“å&quot;, index = 0)</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExcelProperty(value = &quot;å­¦ç”Ÿæ€§åˆ«&quot;, index = 1)</span></span><br><span class="line">    <span class="keyword">private</span> String gender;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExcelProperty(value = &quot;å­¦ç”Ÿå‡ºç”Ÿæ—¥æœŸ&quot;, index = 2)</span></span><br><span class="line">    <span class="keyword">private</span> Date birthDate;    <span class="comment">// åªæ”¯æŒDateï¼Œä¸æ”¯æŒLocalDateå’ŒLocalDateTime</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å†™å…¥Excelæ–‡ä»¶"><a href="#å†™å…¥Excelæ–‡ä»¶" class="headerlink" title="å†™å…¥Excelæ–‡ä»¶"></a>å†™å…¥Excelæ–‡ä»¶</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å†™Excel</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Excel_Write</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å‡†å¤‡æ•°æ®</span></span><br><span class="line">        ArrayList&lt;Student&gt; students = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            <span class="type">Date</span> <span class="variable">date</span> <span class="operator">=</span> Date.from(LocalDate.of(<span class="number">2001</span>, i + <span class="number">1</span>, <span class="number">17</span>).atStartOfDay().atZone(ZoneId.systemDefault()).toInstant());</span><br><span class="line">            <span class="type">Student</span> <span class="variable">student</span> <span class="operator">=</span> Student.builder().name(<span class="string">&quot;Ylan&quot;</span> + i).gender(<span class="string">&quot;ç”·&quot;</span>).birthDate(date).build();</span><br><span class="line">            students.add(student);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1.æ–‡ä»¶çš„è·¯å¾„ 2.å®ä½“ç±»çš„Class</span></span><br><span class="line">        <span class="comment">// å†™å…¥å·¥ç¨‹ä¸‹downæ–‡ä»¶å¤¹ä¸­</span></span><br><span class="line">        EasyExcel.write(</span><br><span class="line">                        <span class="string">&quot;down/student_Write.xls&quot;</span>,</span><br><span class="line">                        Student.class</span><br><span class="line">                ).sheet()   <span class="comment">// é»˜è®¤ä¸ºè¡¨æ ¼1</span></span><br><span class="line">                .doWrite(students);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å†™å…¥å®Œæˆ"><a href="#å†™å…¥å®Œæˆ" class="headerlink" title="å†™å…¥å®Œæˆ"></a>å†™å…¥å®Œæˆ</h3><img src="/2022/11/16/EasyExcel-%C2%A9-pepsi-wyl/1668492243249-d7be8dd0-4265-4b4a-896e-6d51a7754167.png" class=""><h2 id="å†™å…¥å¸¦æœ‰è¡¨å¤´çš„Excel"><a href="#å†™å…¥å¸¦æœ‰è¡¨å¤´çš„Excel" class="headerlink" title="å†™å…¥å¸¦æœ‰è¡¨å¤´çš„Excel"></a>å†™å…¥å¸¦æœ‰è¡¨å¤´çš„Excel</h2><h3 id="åˆ›å»ºå†™å…¥æ–‡ä»¶å¤¹-1"><a href="#åˆ›å»ºå†™å…¥æ–‡ä»¶å¤¹-1" class="headerlink" title="åˆ›å»ºå†™å…¥æ–‡ä»¶å¤¹"></a>åˆ›å»ºå†™å…¥æ–‡ä»¶å¤¹</h3><p>å·¥ç¨‹è·¯å¾„ä¸‹&#x2F;downæ–‡ä»¶å¤¹</p><img src="/2022/11/16/EasyExcel-%C2%A9-pepsi-wyl/1668563592152-5e9fc15d-264d-4067-b8b7-126ebfb0015f.png" class=""><h3 id="ç¼–å†™å®ä½“ç±»-2"><a href="#ç¼–å†™å®ä½“ç±»-2" class="headerlink" title="ç¼–å†™å®ä½“ç±»"></a>ç¼–å†™å®ä½“ç±»</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@EqualsAndHashCode</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//  @Accessors(chain = true) å¼•å‘éƒ¨åˆ†å­—æ®µæ²¡æ³•è¯»å–æˆ–è€…å†™å…¥</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Student</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å†™å…¥æ—¶å€™å¿½ç•¥è¯¥å­—æ®µ</span></span><br><span class="line">    <span class="meta">@ExcelIgnore</span></span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Excelè¡¨å¤´ä¿¡æ¯ valueä¸ºè¡¨å¤´çš„å€¼ indexä¸ºExcelè¡¨çš„ç´¢å¼•ä½ç½® 0ä¸ºç¬¬ä¸€åˆ—</span></span><br><span class="line">    <span class="meta">@ExcelProperty(value = &#123;&quot;å­¦ç”Ÿä¿¡æ¯è¡¨&quot;, &quot;å­¦ç”Ÿå§“å&quot;&#125;, index = 0)</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExcelProperty(value = &#123;&quot;å­¦ç”Ÿä¿¡æ¯è¡¨&quot;, &quot;å­¦ç”Ÿæ€§åˆ«&quot;&#125;, index = 1)</span></span><br><span class="line">    <span class="keyword">private</span> String gender;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExcelProperty(value = &#123;&quot;å­¦ç”Ÿä¿¡æ¯è¡¨&quot;, &quot;å­¦ç”Ÿå‡ºç”Ÿæ—¥æœŸ&quot;&#125;, index = 2)</span></span><br><span class="line">    <span class="meta">@DateTimeFormat(&quot;yyyy-MM-dd&quot;)</span>  <span class="comment">// å°†Dateæ ¼å¼è½¬åŒ–ä¸ºæŒ‡å®šæ ¼å¼</span></span><br><span class="line">    <span class="keyword">private</span> Date birthDate;    <span class="comment">// åªæ”¯æŒDateï¼Œä¸æ”¯æŒLocalDateå’ŒLocalDateTime</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å†™å…¥Excelæ–‡ä»¶-1"><a href="#å†™å…¥Excelæ–‡ä»¶-1" class="headerlink" title="å†™å…¥Excelæ–‡ä»¶"></a>å†™å…¥Excelæ–‡ä»¶</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å†™Excel</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Excel_Write</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å‡†å¤‡æ•°æ®</span></span><br><span class="line">        ArrayList&lt;Student&gt; students = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            <span class="type">Date</span> <span class="variable">date</span> <span class="operator">=</span> Date.from(LocalDate.of(<span class="number">2001</span>, i + <span class="number">1</span>, <span class="number">17</span>).atStartOfDay().atZone(ZoneId.systemDefault()).toInstant());</span><br><span class="line">            <span class="type">Student</span> <span class="variable">student</span> <span class="operator">=</span> Student.builder().name(<span class="string">&quot;Ylan&quot;</span> + i).gender(<span class="string">&quot;ç”·&quot;</span>).birthDate(date).build();</span><br><span class="line">            students.add(student);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1.æ–‡ä»¶çš„è·¯å¾„ 2.å®ä½“ç±»çš„Class</span></span><br><span class="line">        <span class="comment">// å†™å…¥å·¥ç¨‹ä¸‹downæ–‡ä»¶å¤¹ä¸­</span></span><br><span class="line">        EasyExcel.write(</span><br><span class="line">                        <span class="string">&quot;down/student_Write.xls&quot;</span>,</span><br><span class="line">                        Student.class</span><br><span class="line">                ).sheet()   <span class="comment">// é»˜è®¤ä¸ºè¡¨æ ¼1</span></span><br><span class="line">                .doWrite(students);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å†™å…¥å®Œæˆ-1"><a href="#å†™å…¥å®Œæˆ-1" class="headerlink" title="å†™å…¥å®Œæˆ"></a>å†™å…¥å®Œæˆ</h3><img src="/2022/11/16/EasyExcel-%C2%A9-pepsi-wyl/1668512204404-15dea9cb-65c3-45fd-bf09-bf1867b9fb37.png" class=""><h2 id="å†™å…¥å¸¦æœ‰å•å…ƒæ ¼æ ·å¼çš„Excel"><a href="#å†™å…¥å¸¦æœ‰å•å…ƒæ ¼æ ·å¼çš„Excel" class="headerlink" title="å†™å…¥å¸¦æœ‰å•å…ƒæ ¼æ ·å¼çš„Excel"></a>å†™å…¥å¸¦æœ‰å•å…ƒæ ¼æ ·å¼çš„Excel</h2><p>EasyExcelæ”¯æŒè°ƒæ•´è¡Œé«˜ã€åˆ—å®½ã€èƒŒæ™¯è‰²ã€å­—ä½“å¤§å°ç­‰å†…å®¹ï¼Œæ§åˆ¶æ–¹å¼å’Œä½¿ç”¨åŸç”ŸPOIæ— å¼‚ï¼Œ<strong>æ¯”è¾ƒç¹çï¼Œä¸å»ºè®®ä½¿ç”¨</strong>ã€‚æ¨èä½¿ç”¨<strong>æ¨¡æ¿å¡«å……</strong>çš„æ–¹å¼ï¼Œå‘é¢„è®¾æ ·å¼çš„è¡¨æ ¼ä¸­ç›´æ¥å†™å…¥æ•°æ®ï¼Œå†™å…¥æ•°æ®çš„æ—¶å€™ä¼šä¿æŒåŸæœ‰æ ·å¼ã€‚</p><h3 id="å¸¸è§æ³¨è§£"><a href="#å¸¸è§æ³¨è§£" class="headerlink" title="å¸¸è§æ³¨è§£"></a>å¸¸è§æ³¨è§£</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¡¨å¤´è¡Œé«˜    ä½œç”¨äºç±»</span></span><br><span class="line"><span class="meta">@HeadRowHeight(25)</span></span><br><span class="line"><span class="comment">// å†…å®¹è¡Œé«˜    ä½œç”¨äºç±»</span></span><br><span class="line"><span class="meta">@ContentRowHeight(15)</span></span><br><span class="line"><span class="comment">// åˆ—å®½ ä½œç”¨äºå…¨éƒ¨   ä½œç”¨äºç±»å’Œå­—æ®µ</span></span><br><span class="line"><span class="meta">@ColumnWidth(20)</span></span><br></pre></td></tr></table></figure><h3 id="åˆ›å»ºå†™å…¥æ–‡ä»¶å¤¹-2"><a href="#åˆ›å»ºå†™å…¥æ–‡ä»¶å¤¹-2" class="headerlink" title="åˆ›å»ºå†™å…¥æ–‡ä»¶å¤¹"></a>åˆ›å»ºå†™å…¥æ–‡ä»¶å¤¹</h3><p>å·¥ç¨‹è·¯å¾„ä¸‹&#x2F;downæ–‡ä»¶å¤¹</p><img src="/2022/11/16/EasyExcel-%C2%A9-pepsi-wyl/1668563592152-5e9fc15d-264d-4067-b8b7-126ebfb0015f.png" class=""><h3 id="ä¿®æ”¹å®ä½“ç±»"><a href="#ä¿®æ”¹å®ä½“ç±»" class="headerlink" title="ä¿®æ”¹å®ä½“ç±»"></a>ä¿®æ”¹å®ä½“ç±»</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@EqualsAndHashCode</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//  @Accessors(chain = true) å¼•å‘éƒ¨åˆ†å­—æ®µæ²¡æ³•è¯»å–æˆ–è€…å†™å…¥</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è¡¨å¤´è¡Œé«˜</span></span><br><span class="line"><span class="meta">@HeadRowHeight(25)</span></span><br><span class="line"><span class="comment">// å†…å®¹è¡Œé«˜</span></span><br><span class="line"><span class="meta">@ContentRowHeight(15)</span></span><br><span class="line"><span class="comment">// åˆ—å®½ ä½œç”¨äºå…¨éƒ¨</span></span><br><span class="line"><span class="meta">@ColumnWidth(20)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Student</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å†™å…¥æ—¶å€™å¿½ç•¥è¯¥å­—æ®µ</span></span><br><span class="line">    <span class="meta">@ExcelIgnore</span></span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Excelè¡¨å¤´ä¿¡æ¯ valueä¸ºè¡¨å¤´çš„å€¼ indexä¸ºExcelè¡¨çš„ç´¢å¼•ä½ç½®</span></span><br><span class="line">    <span class="meta">@ExcelProperty(value = &quot;å­¦ç”Ÿå§“å&quot;, index = 0)</span></span><br><span class="line">    <span class="comment">// åˆ—å®½</span></span><br><span class="line">    <span class="meta">@ColumnWidth(20)</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExcelProperty(value = &quot;å­¦ç”Ÿæ€§åˆ«&quot;, index = 1)</span></span><br><span class="line">    <span class="meta">@ColumnWidth(20)</span></span><br><span class="line">    <span class="keyword">private</span> String gender;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExcelProperty(value = &quot;å­¦ç”Ÿå‡ºç”Ÿæ—¥æœŸ&quot;, index = 2)</span></span><br><span class="line">    <span class="meta">@ColumnWidth(20)</span></span><br><span class="line">    <span class="keyword">private</span> Date birthDate;    <span class="comment">// åªæ”¯æŒDateï¼Œä¸æ”¯æŒLocalDateå’ŒLocalDateTime</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="é‡æ–°å†™å…¥Excelæ–‡ä»¶"><a href="#é‡æ–°å†™å…¥Excelæ–‡ä»¶" class="headerlink" title="é‡æ–°å†™å…¥Excelæ–‡ä»¶"></a>é‡æ–°å†™å…¥Excelæ–‡ä»¶</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å†™Excel</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Excel_Write</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å‡†å¤‡æ•°æ®</span></span><br><span class="line">        ArrayList&lt;Student&gt; students = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            <span class="type">Date</span> <span class="variable">date</span> <span class="operator">=</span> Date.from(LocalDate.of(<span class="number">2001</span>, i + <span class="number">1</span>, <span class="number">17</span>).atStartOfDay().atZone(ZoneId.systemDefault()).toInstant());</span><br><span class="line">            <span class="type">Student</span> <span class="variable">student</span> <span class="operator">=</span> Student.builder().name(<span class="string">&quot;Ylan&quot;</span> + i).gender(<span class="string">&quot;ç”·&quot;</span>).birthDate(date).build();</span><br><span class="line">            students.add(student);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1.æ–‡ä»¶çš„è·¯å¾„ 2.å®ä½“ç±»çš„Class</span></span><br><span class="line">        <span class="comment">// å†™å…¥å·¥ç¨‹ä¸‹downæ–‡ä»¶å¤¹ä¸­</span></span><br><span class="line">        EasyExcel.write(</span><br><span class="line">                        <span class="string">&quot;down/student_Write.xls&quot;</span>,</span><br><span class="line">                        Student.class</span><br><span class="line">                ).sheet()   <span class="comment">// é»˜è®¤ä¸ºè¡¨æ ¼1</span></span><br><span class="line">                .doWrite(students);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å†™å…¥å®Œæˆ-2"><a href="#å†™å…¥å®Œæˆ-2" class="headerlink" title="å†™å…¥å®Œæˆ"></a>å†™å…¥å®Œæˆ</h3><img src="/2022/11/16/EasyExcel-%C2%A9-pepsi-wyl/1668492834027-2b37791e-4db9-4e97-919a-7a88a432eaab.png" class=""><h2 id="æ–‡ä»¶ä¸Šä¼ å’Œä¸‹è½½"><a href="#æ–‡ä»¶ä¸Šä¼ å’Œä¸‹è½½" class="headerlink" title="æ–‡ä»¶ä¸Šä¼ å’Œä¸‹è½½"></a>æ–‡ä»¶ä¸Šä¼ å’Œä¸‹è½½</h2><h3 id="Excelæ–‡ä»¶ä¸Šä¼ "><a href="#Excelæ–‡ä»¶ä¸Šä¼ " class="headerlink" title="Excelæ–‡ä»¶ä¸Šä¼ "></a>Excelæ–‡ä»¶ä¸Šä¼ </h3><h4 id="å‡†å¤‡Excelæ–‡ä»¶"><a href="#å‡†å¤‡Excelæ–‡ä»¶" class="headerlink" title="å‡†å¤‡Excelæ–‡ä»¶"></a>å‡†å¤‡Excelæ–‡ä»¶</h4><img src="/2022/11/16/EasyExcel-%C2%A9-pepsi-wyl/1668517478748-b52599b0-2600-4ee2-8134-f7019e138303.png" class=""><h4 id="ç¼–å†™å®ä½“ç±»-3"><a href="#ç¼–å†™å®ä½“ç±»-3" class="headerlink" title="ç¼–å†™å®ä½“ç±»"></a>ç¼–å†™å®ä½“ç±»</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@EqualsAndHashCode</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//  @Accessors(chain = true) å¼•å‘éƒ¨åˆ†å­—æ®µæ²¡æ³•è¯»å–æˆ–è€…å†™å…¥</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Student</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å†™å…¥æ—¶å€™å¿½ç•¥è¯¥å­—æ®µ</span></span><br><span class="line">    <span class="meta">@ExcelIgnore</span></span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Excelè¡¨å¤´ä¿¡æ¯ valueä¸ºè¡¨å¤´çš„å€¼ indexä¸ºExcelè¡¨çš„ç´¢å¼•ä½ç½® 0ä¸ºç¬¬ä¸€åˆ—</span></span><br><span class="line">    <span class="meta">@ExcelProperty(value = &quot;å­¦ç”Ÿå§“å&quot;, index = 0)</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExcelProperty(value = &quot;å­¦ç”Ÿæ€§åˆ«&quot;, index = 1)</span></span><br><span class="line">    <span class="keyword">private</span> String gender;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExcelProperty(value = &quot;å­¦ç”Ÿå‡ºç”Ÿæ—¥æœŸ&quot;, index = 2)</span></span><br><span class="line">    <span class="meta">@DateTimeFormat(&quot;yyyy/MM/dd&quot;)</span>  <span class="comment">// å°†Dateæ ¼å¼è½¬åŒ–ä¸ºæŒ‡å®šæ ¼å¼</span></span><br><span class="line">    <span class="keyword">private</span> Date birthDate;    <span class="comment">// åªæ”¯æŒDateï¼Œä¸æ”¯æŒLocalDateå’ŒLocalDateTime</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ç¼–å†™æ•°æ®å¤„ç†é€»è¾‘"><a href="#ç¼–å†™æ•°æ®å¤„ç†é€»è¾‘" class="headerlink" title="ç¼–å†™æ•°æ®å¤„ç†é€»è¾‘"></a>ç¼–å†™æ•°æ®å¤„ç†é€»è¾‘</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service(&quot;studentService&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StudentService</span> &#123;</span><br><span class="line">    <span class="comment">// è°ƒç”¨æ•°æ®åº“è¿›è¡Œæ’å…¥</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">readExcel</span><span class="params">(List&lt;Student&gt; students)</span> &#123;</span><br><span class="line">        students.forEach(student -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;æ’å…¥&quot;</span> + student);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ç¼–å†™è¯»ç›‘å¬å™¨"><a href="#ç¼–å†™è¯»ç›‘å¬å™¨" class="headerlink" title="ç¼–å†™è¯»ç›‘å¬å™¨"></a>ç¼–å†™è¯»ç›‘å¬å™¨</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¯»ç›‘å¬å™¨</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Scope(&quot;prototype&quot;)</span>  <span class="comment">// å¿…é¡»ä¸ºå¤šä¾‹</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExcelListener</span> <span class="keyword">extends</span> <span class="title class_">AnalysisEventListener</span>&lt;Student&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å­˜å‚¨è¯»å–çš„Excelä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">private</span> ArrayList&lt;Student&gt; students = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è°ƒç”¨æœåŠ¡æ’å…¥æ•°æ®åº“</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> StudentService studentService;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ExcelListener</span><span class="params">(StudentService studentService)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.studentService = studentService;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¯»å–excelè¡¨å¤´ä¿¡æ¯ï¼ŒheadMapå³ä¸ºè¡¨å¤´ä¿¡æ¯</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">invokeHeadMap</span><span class="params">(Map&lt;Integer, String&gt; headMap, AnalysisContext context)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;è¡¨å¤´ä¿¡æ¯ï¼š&quot;</span> + headMap);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¯»å–å®Œä¸€è¡Œè°ƒç”¨ä¸€æ¬¡ï¼Œé€šå¸¸åœ¨æ­¤æ¬¡å­˜å…¥æ•°æ®åº“</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">invoke</span><span class="params">(Student student, AnalysisContext analysisContext)</span> &#123;</span><br><span class="line">        <span class="comment">// å­˜å…¥å®¹å™¨</span></span><br><span class="line">        students.add(student);</span><br><span class="line">        <span class="comment">// æ’å…¥æ•°æ®åº“</span></span><br><span class="line">        <span class="keyword">if</span> (students.size() % <span class="number">5</span> == <span class="number">0</span>) &#123;</span><br><span class="line">            studentService.readExcel(students);</span><br><span class="line">            students.clear();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ–‡æ¡£è¯»å–å®Œæˆåæ‰§è¡Œ</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doAfterAllAnalysed</span><span class="params">(AnalysisContext analysisContext)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;StudentExcelè¯»å–å®Œæ¯•&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ç¼–å†™æ§åˆ¶å™¨è¯»å–Excel"><a href="#ç¼–å†™æ§åˆ¶å™¨è¯»å–Excel" class="headerlink" title="ç¼–å†™æ§åˆ¶å™¨è¯»å–Excel"></a>ç¼–å†™æ§åˆ¶å™¨è¯»å–Excel</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¤„ç†webç¯å¢ƒçš„Excelæ–‡ä»¶</span></span><br><span class="line"><span class="meta">@Controller(&quot;excelController&quot;)</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/excel&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExcelController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ³¨å…¥Excelè¯»å–ç›‘å¬å™¨</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ExcelListener excelListener;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ExcelController</span><span class="params">(ExcelListener excelListener)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.excelListener = excelListener;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¤„ç†ä¸Šä¼ çš„æ–‡ä»¶</span></span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/read&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, String&gt; <span class="title function_">readExcel</span><span class="params">(<span class="meta">@RequestPart(&quot;file&quot;)</span> MultipartFile file)</span> &#123;</span><br><span class="line">        HashMap&lt;String, String&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// è¯»å–Excelæ–‡ä»¶</span></span><br><span class="line">            <span class="type">ExcelReaderBuilder</span> <span class="variable">read</span> <span class="operator">=</span> EasyExcel.read(file.getInputStream(), Student.class, excelListener);</span><br><span class="line">            <span class="type">ExcelReaderSheetBuilder</span> <span class="variable">sheet</span> <span class="operator">=</span> read.sheet();</span><br><span class="line">            sheet.doRead();</span><br><span class="line">            map.put(<span class="string">&quot;message&quot;</span>, <span class="string">&quot;success&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            map.put(<span class="string">&quot;message&quot;</span>, <span class="string">&quot;error&quot;</span>);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="æµ‹è¯•æ¡ˆä¾‹"><a href="#æµ‹è¯•æ¡ˆä¾‹" class="headerlink" title="æµ‹è¯•æ¡ˆä¾‹"></a>æµ‹è¯•æ¡ˆä¾‹</h4><p><a href="http://localhost:9999/excel/read">http://localhost:9999/excel/read</a><br>ç±»å‹  Content-Type-multipart&#x2F;form-data</p><img src="/2022/11/16/EasyExcel-%C2%A9-pepsi-wyl/1668517947597-e9306d43-c6f4-47f8-95af-5aaf5400509b.png" class=""><img src="/2022/11/16/EasyExcel-%C2%A9-pepsi-wyl/1668518043415-9eb9bba5-eb1f-49e0-bcd1-35b60cfba954.png" class=""><img src="/2022/11/16/EasyExcel-%C2%A9-pepsi-wyl/1668518072063-d13e4607-deb6-4a2f-bf8d-79ec97fecaed.png" class=""><img src="/2022/11/16/EasyExcel-%C2%A9-pepsi-wyl/1668518113766-37b10e98-1e56-4c5a-9b8e-d7856ddfab0e.png" class=""><h3 id="Excelæ–‡ä»¶ä¸‹è½½"><a href="#Excelæ–‡ä»¶ä¸‹è½½" class="headerlink" title="Excelæ–‡ä»¶ä¸‹è½½"></a>Excelæ–‡ä»¶ä¸‹è½½</h3><h4 id="ç¼–å†™å®ä½“ç±»-4"><a href="#ç¼–å†™å®ä½“ç±»-4" class="headerlink" title="ç¼–å†™å®ä½“ç±»"></a>ç¼–å†™å®ä½“ç±»</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@EqualsAndHashCode</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//  @Accessors(chain = true) å¼•å‘éƒ¨åˆ†å­—æ®µæ²¡æ³•è¯»å–æˆ–è€…å†™å…¥</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Student</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å†™å…¥æ—¶å€™å¿½ç•¥è¯¥å­—æ®µ</span></span><br><span class="line">    <span class="meta">@ExcelIgnore</span></span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Excelè¡¨å¤´ä¿¡æ¯ valueä¸ºè¡¨å¤´çš„å€¼ indexä¸ºExcelè¡¨çš„ç´¢å¼•ä½ç½® 0ä¸ºç¬¬ä¸€åˆ—</span></span><br><span class="line">    <span class="meta">@ExcelProperty(value = &quot;å­¦ç”Ÿå§“å&quot;, index = 0)</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExcelProperty(value = &quot;å­¦ç”Ÿæ€§åˆ«&quot;, index = 1)</span></span><br><span class="line">    <span class="keyword">private</span> String gender;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExcelProperty(value = &quot;å­¦ç”Ÿå‡ºç”Ÿæ—¥æœŸ&quot;, index = 2)</span></span><br><span class="line">    <span class="meta">@DateTimeFormat(&quot;yyyy/MM/dd&quot;)</span>  <span class="comment">// å°†Dateæ ¼å¼è½¬åŒ–ä¸ºæŒ‡å®šæ ¼å¼</span></span><br><span class="line">    <span class="keyword">private</span> Date birthDate;    <span class="comment">// åªæ”¯æŒDateï¼Œä¸æ”¯æŒLocalDateå’ŒLocalDateTime</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="ç¼–å†™æ§åˆ¶å™¨å†™å…¥Excel"><a href="#ç¼–å†™æ§åˆ¶å™¨å†™å…¥Excel" class="headerlink" title="ç¼–å†™æ§åˆ¶å™¨å†™å…¥Excel"></a>ç¼–å†™æ§åˆ¶å™¨å†™å…¥Excel</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¤„ç†webç¯å¢ƒçš„Excelæ–‡ä»¶</span></span><br><span class="line"><span class="meta">@Controller(&quot;excelController&quot;)</span></span><br><span class="line"><span class="meta">@RequestMapping(&quot;/excel&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExcelController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(value = &quot;/write&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">write</span><span class="params">(HttpServletResponse response)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        response.setContentType(<span class="string">&quot;application/vnd.openxmlformats-officedocument.spreadsheetml.sheet&quot;</span>);</span><br><span class="line">        response.setCharacterEncoding(<span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line">        <span class="comment">// è¿™é‡ŒURLEncoder.encodeå¯ä»¥é˜²æ­¢ä¸­æ–‡ä¹±ç  å½“ç„¶å’Œeasyexcelæ²¡æœ‰å…³ç³»</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">fileName</span> <span class="operator">=</span> URLEncoder.encode(<span class="string">&quot;æµ‹è¯•&quot;</span>, <span class="string">&quot;UTF-8&quot;</span>).replaceAll(<span class="string">&quot;\\+&quot;</span>, <span class="string">&quot;%20&quot;</span>);</span><br><span class="line">        response.setHeader(<span class="string">&quot;Content-disposition&quot;</span>, <span class="string">&quot;attachment;filename*=utf-8&#x27;&#x27;&quot;</span> + fileName + <span class="string">&quot;.xlsx&quot;</span>);</span><br><span class="line">        EasyExcel.write(response.getOutputStream(), Student.class).sheet().doWrite(data());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;Student&gt; <span class="title function_">data</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// å‡†å¤‡æ•°æ®</span></span><br><span class="line">        ArrayList&lt;Student&gt; students = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            <span class="type">Date</span> <span class="variable">date</span> <span class="operator">=</span> Date.from(LocalDate.of(<span class="number">2001</span>, i + <span class="number">1</span>, <span class="number">17</span>).atStartOfDay().atZone(ZoneId.systemDefault()).toInstant());</span><br><span class="line">            <span class="type">Student</span> <span class="variable">student</span> <span class="operator">=</span> Student.builder().name(<span class="string">&quot;Ylan&quot;</span> + i).gender(<span class="string">&quot;ç”·&quot;</span>).birthDate(date).build();</span><br><span class="line">            students.add(student);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> students;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="æµ‹è¯•æ¡ˆä¾‹-1"><a href="#æµ‹è¯•æ¡ˆä¾‹-1" class="headerlink" title="æµ‹è¯•æ¡ˆä¾‹"></a>æµ‹è¯•æ¡ˆä¾‹</h4><p><a href="http://localhost:9999/excel/write">http://localhost:9999/excel/write</a></p><img src="/2022/11/16/EasyExcel-%C2%A9-pepsi-wyl/1668518500141-968f9344-dcc2-4554-85ef-f4a5559e3754.png" class=""><img src="/2022/11/16/EasyExcel-%C2%A9-pepsi-wyl/1668518516715-be7431bd-09bb-42e1-914e-6ff31001d02c.png" class=""><h1 id="å¡«å……æ¨¡æ¿"><a href="#å¡«å……æ¨¡æ¿" class="headerlink" title="å¡«å……æ¨¡æ¿"></a>å¡«å……æ¨¡æ¿</h1><h2 id="å®˜æ–¹åœ°å€"><a href="#å®˜æ–¹åœ°å€" class="headerlink" title="å®˜æ–¹åœ°å€"></a>å®˜æ–¹åœ°å€</h2><p>æ¨¡æ¿å¡«å…… <a href="https://easyexcel.opensource.alibaba.com/docs/current/quickstart/fill#since-3">https://easyexcel.opensource.alibaba.com/docs/current/quickstart/fill#since-3</a></p><h2 id="å‡†å¤‡å·¥ä½œ-1"><a href="#å‡†å¤‡å·¥ä½œ-1" class="headerlink" title="å‡†å¤‡å·¥ä½œ"></a>å‡†å¤‡å·¥ä½œ</h2><h3 id="åˆ›å»ºå†™å…¥æ–‡ä»¶å¤¹-3"><a href="#åˆ›å»ºå†™å…¥æ–‡ä»¶å¤¹-3" class="headerlink" title="åˆ›å»ºå†™å…¥æ–‡ä»¶å¤¹"></a>åˆ›å»ºå†™å…¥æ–‡ä»¶å¤¹</h3><p>å·¥ç¨‹è·¯å¾„ä¸‹&#x2F;downæ–‡ä»¶å¤¹</p><img src="/2022/11/16/EasyExcel-%C2%A9-pepsi-wyl/1668563592152-5e9fc15d-264d-4067-b8b7-126ebfb0015f.png" class=""><h2 id="å¡«å……å•ç»„æ•°æ®"><a href="#å¡«å……å•ç»„æ•°æ®" class="headerlink" title="å¡«å……å•ç»„æ•°æ®"></a>å¡«å……å•ç»„æ•°æ®</h2><h3 id="å‡†å¤‡æ¨¡æ¿"><a href="#å‡†å¤‡æ¨¡æ¿" class="headerlink" title="å‡†å¤‡æ¨¡æ¿"></a>å‡†å¤‡æ¨¡æ¿</h3><p>Excelè¡¨æ ¼ä¸­ç”¨**{}<strong>åŒ…è£¹è¡¨ç¤ºè¦å¡«å……çš„å˜é‡ï¼Œå¦‚æœå•å…ƒæ ¼æ–‡æœ¬ä¸­æœ¬æ¥å°±æœ‰</strong>{}<strong>ï¼Œéœ€è¦åœ¨æ‹¬å·å‰é¢ä½¿ç”¨æ–œæ è½¬ä¹‰</strong>{}<strong>ã€‚<br />ä»£ç ä¸­è¢«å¡«å……</strong>å®ä½“å¯¹è±¡çš„æˆå‘˜å˜é‡å<strong>æˆ–è¢«å¡«å……</strong>mapé›†åˆçš„key**éœ€è¦å’ŒExcelä¸­è¢«{}åŒ…è£¹çš„å˜é‡åç§°ä¸€è‡´ã€‚</p><img src="/2022/11/16/EasyExcel-%C2%A9-pepsi-wyl/1668569024454-6c4be7a9-a74e-4c5a-9d77-14897b02d0f7.png" class=""><h3 id="å°è£…æ•°æ®"><a href="#å°è£…æ•°æ®" class="headerlink" title="å°è£…æ•°æ®"></a>å°è£…æ•°æ®</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä½¿ç”¨å®ä½“ç±»å°è£…å¡«å……æ•°æ®</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileData</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å‡†å¤‡æ•°æ® å®ä½“ç±»</span></span><br><span class="line"><span class="type">FileData</span> <span class="variable">data</span> <span class="operator">=</span> FileData.builder().name(<span class="string">&quot;Ylan&quot;</span>).age(<span class="number">21</span>).build();</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å‡†å¤‡æ•°æ® Mapç±»</span></span><br><span class="line">HashMap&lt;String, String&gt; data = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">data.put(<span class="string">&quot;name&quot;</span>, <span class="string">&quot;pepsi-wyl&quot;</span>);</span><br><span class="line">data.put(<span class="string">&quot;age&quot;</span>, <span class="string">&quot;21&quot;</span>);</span><br></pre></td></tr></table></figure><h3 id="å¼€å§‹å¡«å……"><a href="#å¼€å§‹å¡«å……" class="headerlink" title="å¼€å§‹å¡«å……"></a>å¼€å§‹å¡«å……</h3><p>å‡†å¤‡æ•°æ®å¹¶å¡«å……åˆ°æ–‡ä»¶</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å•ç»„å¡«å……</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TemplateTest1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// å‡†å¤‡æ¨¡æ¿</span></span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">template</span> <span class="operator">=</span> Thread.currentThread().getContextClassLoader().getResourceAsStream(<span class="string">&quot;template/fill_data_template1.xlsx&quot;</span>);</span><br><span class="line">        <span class="comment">// å‡†å¤‡è¾“å…¥æ–‡ä»¶</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">targetFileName</span> <span class="operator">=</span> <span class="string">&quot;down/Excel_å¡«å……_å•ç»„æ•°æ®.xlsx&quot;</span>;</span><br><span class="line">        <span class="comment">// å‡†å¤‡æ•°æ® å®ä½“ç±»</span></span><br><span class="line">        <span class="type">FileData</span> <span class="variable">data</span> <span class="operator">=</span> FileData.builder().name(<span class="string">&quot;Ylan&quot;</span>).age(<span class="number">21</span>).build();</span><br><span class="line">        <span class="comment">// å‡†å¤‡æ•°æ® Mapç±»</span></span><br><span class="line">        <span class="comment">//        HashMap&lt;String, String&gt; data = new HashMap&lt;&gt;();</span></span><br><span class="line">        <span class="comment">//        data.put(&quot;name&quot;, &quot;pepsi-wyl&quot;);</span></span><br><span class="line">        <span class="comment">//        data.put(&quot;age&quot;, &quot;21&quot;);</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆ›å»ºå·¥ä½œç°¿å¯¹è±¡ å…³è”æ¨¡æ¿å’Œè¾“å…¥æ–‡ä»¶</span></span><br><span class="line">        <span class="type">ExcelWriterBuilder</span> <span class="variable">excelWriterBuilder</span> <span class="operator">=</span> EasyExcel.write(targetFileName, FileData.class).withTemplate(template);</span><br><span class="line">        <span class="comment">// åˆ›å»ºå·¥èµ„è¡¨å¯¹è±¡</span></span><br><span class="line">        <span class="type">ExcelWriterSheetBuilder</span> <span class="variable">sheet</span> <span class="operator">=</span> excelWriterBuilder.sheet();</span><br><span class="line">        <span class="comment">// å¡«å……æ•°æ® å…³è”æ•°æ®</span></span><br><span class="line">        sheet.doFill(data);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å¡«å……æ•ˆæœ"><a href="#å¡«å……æ•ˆæœ" class="headerlink" title="å¡«å……æ•ˆæœ"></a>å¡«å……æ•ˆæœ</h3><img src="/2022/11/16/EasyExcel-%C2%A9-pepsi-wyl/1668576287110-0db3fc81-641b-4c90-a767-fa62c42d9294.png" class=""><h2 id="å¡«å……å¤šç»„æ•°æ®"><a href="#å¡«å……å¤šç»„æ•°æ®" class="headerlink" title="å¡«å……å¤šç»„æ•°æ®"></a>å¡«å……å¤šç»„æ•°æ®</h2><h3 id="å‡†å¤‡æ¨¡æ¿-1"><a href="#å‡†å¤‡æ¨¡æ¿-1" class="headerlink" title="å‡†å¤‡æ¨¡æ¿"></a>å‡†å¤‡æ¨¡æ¿</h3><p>Excelè¡¨æ ¼ä¸­ç”¨ <strong>{.}</strong> åŒ…è£¹è¡¨ç¤ºè¦å¡«å……çš„å˜é‡ï¼Œå¦‚æœå•å…ƒæ ¼æ–‡æœ¬ä¸­æœ¬æ¥å°±æœ‰**{}<strong>ï¼Œéœ€è¦åœ¨æ‹¬å·å‰é¢ä½¿ç”¨æ–œæ è½¬ä¹‰</strong>{}<strong>ã€‚<br />ä»£ç ä¸­è¢«å¡«å……</strong>å®ä½“å¯¹è±¡çš„æˆå‘˜å˜é‡å<strong>æˆ–è¢«å¡«å……</strong>mapé›†åˆçš„key**éœ€è¦å’ŒExcelä¸­è¢«{}åŒ…è£¹çš„å˜é‡åç§°ä¸€è‡´ã€‚</p><img src="/2022/11/16/EasyExcel-%C2%A9-pepsi-wyl/1668576404252-262c8007-4082-4b3a-88f9-dae3f2dac10f.png" class=""><h3 id="å°è£…æ•°æ®-1"><a href="#å°è£…æ•°æ®-1" class="headerlink" title="å°è£…æ•°æ®"></a>å°è£…æ•°æ®</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä½¿ç”¨å®ä½“ç±»å°è£…å¡«å……æ•°æ®</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileData</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å‡†å¤‡æ•°æ® å®ä½“ç±»</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> List&lt;FileData&gt; <span class="title function_">initFillData</span><span class="params">()</span> &#123;</span><br><span class="line">ArrayList&lt;FileData&gt; fillDatas = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;FileData&gt;();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) fillDatas.add(FileData.builder().name(<span class="string">&quot;YLan&quot;</span> + i).age(<span class="number">10</span> + i).build());</span><br><span class="line">    <span class="keyword">return</span> fillDatas;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åŒä¸Š</span></span><br></pre></td></tr></table></figure><h3 id="å¼€å§‹å¡«å……-1"><a href="#å¼€å§‹å¡«å……-1" class="headerlink" title="å¼€å§‹å¡«å……"></a>å¼€å§‹å¡«å……</h3><p>å‡†å¤‡æ•°æ®å¹¶å¡«å……åˆ°æ–‡ä»¶</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¤šç»„å¡«å……</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TemplateTest2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// å‡†å¤‡æ¨¡æ¿</span></span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">template</span> <span class="operator">=</span> Thread.currentThread().getContextClassLoader().getResourceAsStream(<span class="string">&quot;template/fill_data_template2.xlsx&quot;</span>);</span><br><span class="line">        <span class="comment">// å‡†å¤‡è¾“å…¥æ–‡ä»¶</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">targetFileName</span> <span class="operator">=</span> <span class="string">&quot;down/Excel_å¡«å……_å¤šç»„æ•°æ®.xlsx&quot;</span>;</span><br><span class="line">        <span class="comment">// å‡†å¤‡æ•°æ® å®ä½“ç±»é›†åˆ</span></span><br><span class="line">        List&lt;FileData&gt; dataList = initFillData();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆ›å»ºå·¥ä½œç°¿å¯¹è±¡ å…³è”æ¨¡æ¿å’Œè¾“å…¥æ–‡ä»¶</span></span><br><span class="line">        <span class="type">ExcelWriterBuilder</span> <span class="variable">excelWriterBuilder</span> <span class="operator">=</span> EasyExcel.write(targetFileName, FileData.class).withTemplate(template);</span><br><span class="line">        <span class="comment">// åˆ›å»ºå·¥èµ„è¡¨å¯¹è±¡</span></span><br><span class="line">        <span class="type">ExcelWriterSheetBuilder</span> <span class="variable">sheet</span> <span class="operator">=</span> excelWriterBuilder.sheet();</span><br><span class="line">        <span class="comment">// å¡«å……æ•°æ® å…³è”æ•°æ®</span></span><br><span class="line">        sheet.doFill(dataList);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;FileData&gt; <span class="title function_">initFillData</span><span class="params">()</span> &#123;</span><br><span class="line">        ArrayList&lt;FileData&gt; fillDatas = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;FileData&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) fillDatas.add(FileData.builder().name(<span class="string">&quot;YLan&quot;</span> + i).age(<span class="number">10</span> + i).build());</span><br><span class="line">        <span class="keyword">return</span> fillDatas;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å¡«å……æ•ˆæœ-1"><a href="#å¡«å……æ•ˆæœ-1" class="headerlink" title="å¡«å……æ•ˆæœ"></a>å¡«å……æ•ˆæœ</h3><img src="/2022/11/16/EasyExcel-%C2%A9-pepsi-wyl/1668576592109-9a73facb-0aa2-4342-9eab-2538614fb161.png" class=""><h2 id="ç»„åˆå¡«å……"><a href="#ç»„åˆå¡«å……" class="headerlink" title="ç»„åˆå¡«å……"></a>ç»„åˆå¡«å……</h2><h3 id="å‡†å¤‡æ¨¡æ¿-2"><a href="#å‡†å¤‡æ¨¡æ¿-2" class="headerlink" title="å‡†å¤‡æ¨¡æ¿"></a>å‡†å¤‡æ¨¡æ¿</h3><p>å³æœ‰å¤šç»„æ•°æ®å¡«å……ï¼Œåˆæœ‰å•ä¸€æ•°æ®å¡«å……ï¼Œä¸ºäº†é¿å…ä¸¤è€…æ•°æ®å‡ºç°å†²çªè¦†ç›–çš„æƒ…å†µï¼Œåœ¨å¤šç»„å¡«å……æ—¶éœ€è¦é€šè¿‡<code>**FillConfig**</code>å¯¹è±¡è®¾ç½®æ¢è¡Œã€‚</p><img src="/2022/11/16/EasyExcel-%C2%A9-pepsi-wyl/1668576652037-9f98f9de-b124-4461-a367-e78ca2340361.png" class=""><h3 id="å°è£…æ•°æ®-2"><a href="#å°è£…æ•°æ®-2" class="headerlink" title="å°è£…æ•°æ®"></a>å°è£…æ•°æ®</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä½¿ç”¨å®ä½“ç±»å°è£…å¡«å……æ•°æ®</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileData</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å‡†å¤‡æ•°æ® å®ä½“ç±»</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> List&lt;FileData&gt; <span class="title function_">initFillData</span><span class="params">()</span> &#123;</span><br><span class="line">    ArrayList&lt;FileData&gt; fillDatas = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;FileData&gt;();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) fillDatas.add(FileData.builder().name(<span class="string">&quot;YLan&quot;</span> + i).age(<span class="number">10</span> + i).build());</span><br><span class="line">    <span class="keyword">return</span> fillDatas;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å‡†å¤‡æ•°æ® Mapç±»</span></span><br><span class="line">HashMap&lt;String, String&gt; dataMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">dataMap.put(<span class="string">&quot;date&quot;</span>, <span class="string">&quot;2022-03-17&quot;</span>);</span><br><span class="line">dataMap.put(<span class="string">&quot;total&quot;</span>, <span class="string">&quot;21&quot;</span>);</span><br></pre></td></tr></table></figure><h3 id="å¼€å§‹å¡«å……-2"><a href="#å¼€å§‹å¡«å……-2" class="headerlink" title="å¼€å§‹å¡«å……"></a>å¼€å§‹å¡«å……</h3><p>å‡†å¤‡æ•°æ®å¹¶å¡«å……åˆ°æ–‡ä»¶</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç»„åˆå¡«å……</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TemplateTest3</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// å‡†å¤‡æ¨¡æ¿</span></span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">template</span> <span class="operator">=</span> Thread.currentThread().getContextClassLoader().getResourceAsStream(<span class="string">&quot;template/fill_data_template3.xlsx&quot;</span>);</span><br><span class="line">        <span class="comment">// å‡†å¤‡è¾“å…¥æ–‡ä»¶</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">targetFileName</span> <span class="operator">=</span> <span class="string">&quot;down/Excel_å¡«å……_ç»„åˆæ•°æ®.xlsx&quot;</span>;</span><br><span class="line">        <span class="comment">// å‡†å¤‡æ•°æ® å®ä½“ç±»</span></span><br><span class="line">        List&lt;FileData&gt; dataList = initFillData();</span><br><span class="line">        <span class="comment">// å‡†å¤‡æ•°æ® Mapç±»</span></span><br><span class="line">        HashMap&lt;String, String&gt; dataMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        dataMap.put(<span class="string">&quot;date&quot;</span>, <span class="string">&quot;2022-03-17&quot;</span>);</span><br><span class="line">        dataMap.put(<span class="string">&quot;total&quot;</span>, <span class="string">&quot;21&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆ›å»ºå·¥ä½œç°¿å¯¹è±¡ å…³è”æ¨¡æ¿å’Œè¾“å…¥æ–‡ä»¶</span></span><br><span class="line">        <span class="type">ExcelWriter</span> <span class="variable">workBook</span> <span class="operator">=</span> EasyExcel.write(targetFileName, FileData.class).withTemplate(template).build();</span><br><span class="line">        <span class="comment">// åˆ›å»ºå·¥èµ„è¡¨å¯¹è±¡</span></span><br><span class="line">        <span class="type">WriteSheet</span> <span class="variable">sheet</span> <span class="operator">=</span> EasyExcel.writerSheet().build();</span><br><span class="line">        <span class="comment">// ç»„åˆå¡«å……æ—¶ï¼Œå› ä¸ºå¤šç»„å¡«å……çš„æ•°æ®é‡ä¸ç¡®å®šï¼Œéœ€è¦åœ¨å¤šç»„å¡«å……å®Œä¹‹åå¦èµ·ä¸€è¡Œ</span></span><br><span class="line">        <span class="type">FillConfig</span> <span class="variable">fillConfig</span> <span class="operator">=</span> FillConfig.builder().forceNewRow(<span class="literal">true</span>).build();</span><br><span class="line">        <span class="comment">// å¡«å……æ•°æ® å…³è”æ•°æ®</span></span><br><span class="line">        workBook.fill(dataList, fillConfig, sheet); <span class="comment">// å¤šç»„æ•°æ®</span></span><br><span class="line">        workBook.fill(dataMap, sheet);  <span class="comment">// å•ç»„æ•°æ®</span></span><br><span class="line">        <span class="comment">// å…³é—­æµï¼ï¼ï¼</span></span><br><span class="line">        workBook.finish();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;FileData&gt; <span class="title function_">initFillData</span><span class="params">()</span> &#123;</span><br><span class="line">        ArrayList&lt;FileData&gt; fillDatas = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;FileData&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) fillDatas.add(FileData.builder().name(<span class="string">&quot;YLan&quot;</span> + i).age(<span class="number">10</span> + i).build());</span><br><span class="line">        <span class="keyword">return</span> fillDatas;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å¡«å……æ•ˆæœ-2"><a href="#å¡«å……æ•ˆæœ-2" class="headerlink" title="å¡«å……æ•ˆæœ"></a>å¡«å……æ•ˆæœ</h3><img src="/2022/11/16/EasyExcel-%C2%A9-pepsi-wyl/1668576871553-50822bcb-4b08-459a-9680-1b02b1b56762.png" class=""><h2 id="æ°´å¹³å¡«å……"><a href="#æ°´å¹³å¡«å……" class="headerlink" title="æ°´å¹³å¡«å……"></a>æ°´å¹³å¡«å……</h2><h3 id="å‡†å¤‡æ¨¡æ¿-3"><a href="#å‡†å¤‡æ¨¡æ¿-3" class="headerlink" title="å‡†å¤‡æ¨¡æ¿"></a>å‡†å¤‡æ¨¡æ¿</h3><p>æ°´å¹³å¡«å……å’Œå¤šç»„å¡«å……æ¨¡æ¿ä¸€æ ·ï¼Œä¸ä¸€æ ·çš„åœ°æ–¹åœ¨äºï¼Œå¡«å……æ—¶éœ€è¦é€šè¿‡<code>**FillConfig**</code>å¯¹è±¡è®¾ç½®æ°´å¹³å¡«å……ã€‚</p><img src="/2022/11/16/EasyExcel-%C2%A9-pepsi-wyl/1668576914357-50a46c58-2521-4607-b6ec-3522b46d2c48.png" class=""><h3 id="å°è£…æ•°æ®-3"><a href="#å°è£…æ•°æ®-3" class="headerlink" title="å°è£…æ•°æ®"></a>å°è£…æ•°æ®</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä½¿ç”¨å®ä½“ç±»å°è£…å¡«å……æ•°æ®</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">FileData</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å‡†å¤‡æ•°æ® å®ä½“ç±»</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> List&lt;FileData&gt; <span class="title function_">initFillData</span><span class="params">()</span> &#123;</span><br><span class="line">ArrayList&lt;FileData&gt; fillDatas = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;FileData&gt;();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) fillDatas.add(FileData.builder().name(<span class="string">&quot;YLan&quot;</span> + i).age(<span class="number">10</span> + i).build());</span><br><span class="line">    <span class="keyword">return</span> fillDatas;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åŒä¸Š</span></span><br></pre></td></tr></table></figure><h3 id="å¼€å§‹å¡«å……-3"><a href="#å¼€å§‹å¡«å……-3" class="headerlink" title="å¼€å§‹å¡«å……"></a>å¼€å§‹å¡«å……</h3><p>å‡†å¤‡æ•°æ®å¹¶å¡«å……åˆ°æ–‡ä»¶</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ°´å¹³å¡«å……</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TemplateTest4</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// å‡†å¤‡æ¨¡æ¿</span></span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">template</span> <span class="operator">=</span> Thread.currentThread().getContextClassLoader().getResourceAsStream(<span class="string">&quot;template/fill_data_template4.xlsx&quot;</span>);</span><br><span class="line">        <span class="comment">// å‡†å¤‡è¾“å…¥æ–‡ä»¶</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">targetFileName</span> <span class="operator">=</span> <span class="string">&quot;down/Excel_å¡«å……_æ°´å¹³æ•°æ®.xlsx&quot;</span>;</span><br><span class="line">        <span class="comment">// å‡†å¤‡æ•°æ® å®ä½“ç±»</span></span><br><span class="line">        List&lt;FileData&gt; dataList = initFillData();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆ›å»ºå·¥ä½œç°¿å¯¹è±¡ å…³è”æ¨¡æ¿å’Œè¾“å…¥æ–‡ä»¶</span></span><br><span class="line">        <span class="type">ExcelWriter</span> <span class="variable">workBook</span> <span class="operator">=</span> EasyExcel.write(targetFileName, FileData.class).withTemplate(template).build();</span><br><span class="line">        <span class="comment">// åˆ›å»ºå·¥èµ„è¡¨å¯¹è±¡</span></span><br><span class="line">        <span class="type">WriteSheet</span> <span class="variable">sheet</span> <span class="operator">=</span> EasyExcel.writerSheet().build();</span><br><span class="line">        <span class="comment">// æ°´å¹³å¡«å……é…ç½®</span></span><br><span class="line">        <span class="type">FillConfig</span> <span class="variable">fillConfig</span> <span class="operator">=</span> FillConfig.builder().direction(WriteDirectionEnum.HORIZONTAL).build();</span><br><span class="line">        <span class="comment">// å¡«å……æ•°æ® å…³è”æ•°æ®</span></span><br><span class="line">        workBook.fill(dataList, fillConfig, sheet);  <span class="comment">// å•ç»„æ•°æ®</span></span><br><span class="line">        <span class="comment">// å…³é—­æµï¼ï¼ï¼</span></span><br><span class="line">        workBook.finish();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;FileData&gt; <span class="title function_">initFillData</span><span class="params">()</span> &#123;</span><br><span class="line">        ArrayList&lt;FileData&gt; fillDatas = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;FileData&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) fillDatas.add(FileData.builder().name(<span class="string">&quot;YLan&quot;</span> + i).age(<span class="number">10</span> + i).build());</span><br><span class="line">        <span class="keyword">return</span> fillDatas;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å¡«å……æ•ˆæœ-3"><a href="#å¡«å……æ•ˆæœ-3" class="headerlink" title="å¡«å……æ•ˆæœ"></a>å¡«å……æ•ˆæœ</h3><img src="/2022/11/16/EasyExcel-%C2%A9-pepsi-wyl/1668577023891-e5a2c518-c61e-481c-a87f-440b34aac689.png" class=""><h2 id="å¡«å……ç»¼åˆç»ƒä¹ "><a href="#å¡«å……ç»¼åˆç»ƒä¹ " class="headerlink" title="å¡«å……ç»¼åˆç»ƒä¹ "></a>å¡«å……ç»¼åˆç»ƒä¹ </h2><h3 id="å‡†å¤‡æ¨¡æ¿-4"><a href="#å‡†å¤‡æ¨¡æ¿-4" class="headerlink" title="å‡†å¤‡æ¨¡æ¿"></a>å‡†å¤‡æ¨¡æ¿</h3><img src="/2022/11/16/EasyExcel-%C2%A9-pepsi-wyl/1668577130444-b7eda24a-2315-4d96-a031-9e2c574e9462.png" class=""><h3 id="å°è£…æ•°æ®-4"><a href="#å°è£…æ•°æ®-4" class="headerlink" title="å°è£…æ•°æ®"></a>å°è£…æ•°æ®</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¼šå‘˜å®ä½“ç±»</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@EqualsAndHashCode</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//  @Accessors(chain = true) å¼•å‘éƒ¨åˆ†å­—æ®µæ²¡æ³•è¯»å–æˆ–è€…å†™å…¥</span></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Members</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å†™å…¥æ—¶å€™å¿½ç•¥è¯¥å­—æ®µ</span></span><br><span class="line">    <span class="meta">@ExcelIgnore</span></span><br><span class="line">    <span class="keyword">private</span> String id;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// indexä¸ºExcelè¡¨çš„ç´¢å¼•ä½ç½® 0ä¸ºç¬¬ä¸€åˆ—</span></span><br><span class="line">    <span class="meta">@ExcelProperty(index = 0)</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExcelProperty(index = 1)</span></span><br><span class="line">    <span class="keyword">private</span> String gender;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ExcelProperty(index = 2)</span></span><br><span class="line">    <span class="keyword">private</span> Date birthday;    <span class="comment">// åªæ”¯æŒDateï¼Œä¸æ”¯æŒLocalDateå’ŒLocalDateTime</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å°è£…å®ä½“ç±»æ•°æ®</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> List&lt;Members&gt; <span class="title function_">initData</span><span class="params">()</span> &#123;</span><br><span class="line">    ArrayList&lt;Members&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">        <span class="type">Date</span> <span class="variable">date</span> <span class="operator">=</span> Date.from(LocalDate.of(<span class="number">2001</span>, i + <span class="number">1</span>, <span class="number">17</span>).atStartOfDay().atZone(ZoneId.systemDefault()).toInstant());</span><br><span class="line">        <span class="type">Members</span> <span class="variable">members</span> <span class="operator">=</span> Members.builder().name(<span class="string">&quot;Ylan&quot;</span> + i).gender(<span class="string">&quot;ç”·&quot;</span>).birthday(date).build();</span><br><span class="line">        list.add(members);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> list;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å°è£…Mapç±»æ•°æ®</span></span><br><span class="line"><span class="comment">// ****** å‡†å¤‡æ•°æ® *******</span></span><br><span class="line">HashMap&lt;String, String&gt; data = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, String&gt;();</span><br><span class="line"><span class="comment">// æ—¥æœŸ</span></span><br><span class="line">data.put(<span class="string">&quot;date&quot;</span>, <span class="string">&quot;2020-03-16&quot;</span>);</span><br><span class="line"><span class="comment">// æ€»ä¼šå‘˜æ•°</span></span><br><span class="line">data.put(<span class="string">&quot;totalCount&quot;</span>, <span class="string">&quot;1000&quot;</span>);</span><br><span class="line"><span class="comment">// æ–°å¢å‘˜æ•°</span></span><br><span class="line">data.put(<span class="string">&quot;increaseCount&quot;</span>, <span class="string">&quot;100&quot;</span>);</span><br><span class="line"><span class="comment">// æœ¬å‘¨æ–°å¢ä¼šå‘˜æ•°</span></span><br><span class="line">data.put(<span class="string">&quot;increaseCountWeek&quot;</span>, <span class="string">&quot;50&quot;</span>);</span><br><span class="line"><span class="comment">// æœ¬æœˆæ–°å¢ä¼šå‘˜æ•°</span></span><br><span class="line">data.put(<span class="string">&quot;increaseCountMonth&quot;</span>, <span class="string">&quot;100&quot;</span>);</span><br><span class="line"><span class="comment">// æ–°å¢ä¼šå‘˜æ•°æ®</span></span><br><span class="line">List&lt;Members&gt; members = initData();</span><br><span class="line"><span class="comment">// **** å‡†å¤‡æ•°æ®ç»“æŸ****</span></span><br></pre></td></tr></table></figure><h3 id="å¼€å§‹å¡«å……-4"><a href="#å¼€å§‹å¡«å……-4" class="headerlink" title="å¼€å§‹å¡«å……"></a>å¼€å§‹å¡«å……</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æŠ¥è¡¨å¯¼å‡º</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TemplateTest5</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å‡†å¤‡æ¨¡æ¿</span></span><br><span class="line">        <span class="type">InputStream</span> <span class="variable">template</span> <span class="operator">=</span> Thread.currentThread().getContextClassLoader().getResourceAsStream(<span class="string">&quot;template/report_template.xlsx&quot;</span>);</span><br><span class="line">        <span class="comment">// å‡†å¤‡è¾“å…¥æ–‡ä»¶</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">targetFileName</span> <span class="operator">=</span> <span class="string">&quot;down/Excel_å¡«å……_æŠ¥è¡¨å¯¼å‡º.xlsx&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ****** å‡†å¤‡æ•°æ® *******</span></span><br><span class="line">        HashMap&lt;String, String&gt; data = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, String&gt;();</span><br><span class="line">        <span class="comment">// æ—¥æœŸ</span></span><br><span class="line">        data.put(<span class="string">&quot;date&quot;</span>, <span class="string">&quot;2020-03-16&quot;</span>);</span><br><span class="line">        <span class="comment">// æ€»ä¼šå‘˜æ•°</span></span><br><span class="line">        data.put(<span class="string">&quot;totalCount&quot;</span>, <span class="string">&quot;1000&quot;</span>);</span><br><span class="line">        <span class="comment">// æ–°å¢å‘˜æ•°</span></span><br><span class="line">        data.put(<span class="string">&quot;increaseCount&quot;</span>, <span class="string">&quot;100&quot;</span>);</span><br><span class="line">        <span class="comment">// æœ¬å‘¨æ–°å¢ä¼šå‘˜æ•°</span></span><br><span class="line">        data.put(<span class="string">&quot;increaseCountWeek&quot;</span>, <span class="string">&quot;50&quot;</span>);</span><br><span class="line">        <span class="comment">// æœ¬æœˆæ–°å¢ä¼šå‘˜æ•°</span></span><br><span class="line">        data.put(<span class="string">&quot;increaseCountMonth&quot;</span>, <span class="string">&quot;100&quot;</span>);</span><br><span class="line">        <span class="comment">// æ–°å¢ä¼šå‘˜æ•°æ®</span></span><br><span class="line">        List&lt;Members&gt; members = initData();</span><br><span class="line">        <span class="comment">// **** å‡†å¤‡æ•°æ®ç»“æŸ****</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// åˆ›å»ºå·¥ä½œç°¿å¯¹è±¡ å…³è”æ¨¡æ¿å’Œè¾“å…¥æ–‡ä»¶</span></span><br><span class="line">        <span class="type">ExcelWriter</span> <span class="variable">workBook</span> <span class="operator">=</span> EasyExcel.write(targetFileName, FileData.class).withTemplate(template).build();</span><br><span class="line">        <span class="comment">// åˆ›å»ºå·¥èµ„è¡¨å¯¹è±¡</span></span><br><span class="line">        <span class="type">WriteSheet</span> <span class="variable">sheet</span> <span class="operator">=</span> EasyExcel.writerSheet().build();</span><br><span class="line">        <span class="comment">// å¡«å……æ•°æ® å…³è”æ•°æ®</span></span><br><span class="line">        workBook.fill(data, sheet);    <span class="comment">// å•ç»„æ•°æ®</span></span><br><span class="line">        workBook.fill(members, sheet); <span class="comment">// å¤šç»„æ•°æ®</span></span><br><span class="line">        <span class="comment">// å…³é—­æµï¼ï¼ï¼</span></span><br><span class="line">        workBook.finish();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> List&lt;Members&gt; <span class="title function_">initData</span><span class="params">()</span> &#123;</span><br><span class="line">        ArrayList&lt;Members&gt; list = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span><br><span class="line">            <span class="type">Date</span> <span class="variable">date</span> <span class="operator">=</span> Date.from(LocalDate.of(<span class="number">2001</span>, i + <span class="number">1</span>, <span class="number">17</span>).atStartOfDay().atZone(ZoneId.systemDefault()).toInstant());</span><br><span class="line">            <span class="type">Members</span> <span class="variable">members</span> <span class="operator">=</span> Members.builder().name(<span class="string">&quot;Ylan&quot;</span> + i).gender(<span class="string">&quot;ç”·&quot;</span>).birthday(date).build();</span><br><span class="line">            list.add(members);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å¡«å……æ•ˆæœ-4"><a href="#å¡«å……æ•ˆæœ-4" class="headerlink" title="å¡«å……æ•ˆæœ"></a>å¡«å……æ•ˆæœ</h3><img src="/2022/11/16/EasyExcel-%C2%A9-pepsi-wyl/1668577411509-e1824b9a-e738-4c5d-a43c-061b294e1730.png" class=""><h2 id="æ³¨æ„äº‹é¡¹"><a href="#æ³¨æ„äº‹é¡¹" class="headerlink" title="æ³¨æ„äº‹é¡¹"></a>æ³¨æ„äº‹é¡¹</h2><p>ä¸ºäº†<strong>èŠ‚çœå†…å­˜</strong>ï¼Œæ‰€ä»¥æ²¡æœ‰é‡‡ç”¨æŠŠæ•´ä¸ªæ–‡æ¡£åœ¨å†…å­˜ä¸­ç»„ç»‡å¥½ä¹‹åå†æ•´ä½“å†™å…¥åˆ°æ–‡ä»¶çš„åšæ³•ï¼Œè€Œæ˜¯é‡‡ç”¨çš„æ˜¯<strong>ä¸€è¡Œä¸€è¡Œå†™å…¥çš„æ–¹å¼</strong>ï¼Œä¸èƒ½å®ç°åˆ é™¤å’Œç§»åŠ¨è¡Œï¼Œä¹Ÿä¸æ”¯æŒå¤‡æ³¨å†™å…¥ã€‚å¤šç»„æ•°æ®å†™å…¥çš„æ—¶å€™ï¼Œå¦‚æœéœ€è¦æ–°å¢è¡Œï¼Œåªèƒ½åœ¨æœ€åä¸€è¡Œå¢åŠ ï¼Œä¸èƒ½åœ¨ä¸­é—´ä½ç½®æ·»åŠ ã€‚</p><h1 id="APIåŠæ³¨è§£"><a href="#APIåŠæ³¨è§£" class="headerlink" title="APIåŠæ³¨è§£"></a>APIåŠæ³¨è§£</h1><h2 id="å®˜æ–¹åœ°å€-1"><a href="#å®˜æ–¹åœ°å€-1" class="headerlink" title="å®˜æ–¹åœ°å€"></a>å®˜æ–¹åœ°å€</h2><p>è¯»Excel <a href="https://easyexcel.opensource.alibaba.com/docs/current/api/#readsheet">https://easyexcel.opensource.alibaba.com/docs/current/api/#readsheet</a><br>å†™Excel <a href="https://easyexcel.opensource.alibaba.com/docs/current/api/write">https://easyexcel.opensource.alibaba.com/docs/current/api/write</a><br>å¡«å……Excel <a href="https://easyexcel.opensource.alibaba.com/docs/current/api/fill">https://easyexcel.opensource.alibaba.com/docs/current/api/fill</a></p><h2 id="å¸¸ç”¨ç±»"><a href="#å¸¸ç”¨ç±»" class="headerlink" title="å¸¸ç”¨ç±»"></a>å¸¸ç”¨ç±»</h2><ul><li><strong>EasyExcel</strong> å…¥å£ç±»ï¼Œæ„å»ºå¼€å§‹çš„æ“ä½œ</li><li><strong>ExcelReaderBuilder</strong> æ„å»ºå‡ºä¸€ä¸ªReadWorkbookå¯¹è±¡ï¼Œå³ä¸€ä¸ªå·¥ä½œç°¿å¯¹è±¡ï¼Œå¯¹åº”çš„æ˜¯ä¸€ä¸ªExcelæ–‡ä»¶</li><li><strong>ExcelReaderSheetBuilder</strong> æ„å»ºå‡ºä¸€ä¸ªReadSheetå¯¹è±¡ï¼Œå³ä¸€ä¸ªå·¥ä½œè¡¨çš„å¯¹è±¡ï¼Œå¯¹åº”çš„Excelä¸­çš„æ¯ä¸ªsheetï¼Œä¸€ä¸ªå·¥ä½œç°¿å¯ä»¥æœ‰å¤šä¸ªå·¥ä½œè¡¨</li><li><strong>ReadListener</strong> åœ¨æ¯ä¸€è¡Œè¯»å–å®Œæ¯•åè°ƒç”¨ReadListeneræ¥å¤„ç†æ•°æ®ï¼Œå¯ä»¥æŠŠè°ƒç”¨serviceçš„ä»£ç å¯ä»¥å†™åœ¨å…¶<strong>invoke</strong>æ–¹æ³•å†…éƒ¨</li><li><strong>ExcelWriterBuilder</strong> æ„å»ºå‡ºä¸€ä¸ªWriteWorkbookå¯¹è±¡ï¼Œå³ä¸€ä¸ªå·¥ä½œç°¿å¯¹è±¡ï¼Œå¯¹åº”çš„æ˜¯ä¸€ä¸ªExcelæ–‡ä»¶</li><li><strong>ExcelWriterSheetBuilder</strong> æ„å»ºå‡ºä¸€WriteSheetå¯¹è±¡ï¼Œå³ä¸€ä¸ªå·¥ä½œè¡¨çš„å¯¹è±¡ï¼Œå¯¹åº”çš„Excelä¸­çš„æ¯ä¸ªsheetï¼Œä¸€ä¸ªå·¥ä½œç°¿å¯ä»¥æœ‰å¤šä¸ªå·¥ä½œè¡¨</li><li><strong>WriteHandler</strong> åˆ›å»ºå•å…ƒæ ¼ã€åˆ›å»ºè¡¨æ ¼ç­‰éƒ½ä¼šè°ƒç”¨WriteHandleræ¥å¤„ç†æ•°æ®ï¼Œå¯¹ä½¿ç”¨è€…é€æ˜ä¸å¯è§</li></ul><p><strong>æ‰€æœ‰é…ç½®éƒ½æ˜¯ç»§æ‰¿çš„</strong> Workbookçš„é…ç½®ä¼šè¢«Sheetç»§æ‰¿ï¼Œå³åœ¨è®¾ç½®å‚æ•°çš„æ—¶å€™ï¼Œåœ¨EasyExcelâ€¦sheet()æ–¹æ³•ä¹‹å‰ä½œç”¨åŸŸæ˜¯æ•´ä¸ªsheetï¼Œä¹‹åé’ˆå¯¹å•ä¸ªsheetã€‚</p><h2 id="è¯»å–APIåŠæ³¨è§£"><a href="#è¯»å–APIåŠæ³¨è§£" class="headerlink" title="è¯»å–APIåŠæ³¨è§£"></a>è¯»å–APIåŠæ³¨è§£</h2><h3 id="æ³¨è§£"><a href="#æ³¨è§£" class="headerlink" title="æ³¨è§£"></a>æ³¨è§£</h3><h4 id="ExcelProperty"><a href="#ExcelProperty" class="headerlink" title="@ExcelProperty"></a>@ExcelProperty</h4><p><strong>ä½¿ç”¨ä½ç½®</strong>ï¼šä½œç”¨åœ¨æˆå‘˜å˜é‡ä¸Š<br /><strong>å¯é€‰å±æ€§ï¼š</strong></p><table><thead><tr><th>å±æ€§å</th><th>å«ä¹‰</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>index</td><td>å¯¹åº”Excelè¡¨ä¸­çš„åˆ—æ•°</td><td>é»˜è®¤-1ï¼ŒæŒ‡å®šæ—¶ä»0å¼€å§‹</td></tr><tr><td>value</td><td>å¯¹åº”Excelè¡¨ä¸­çš„åˆ—å¤´</td><td><br /></td></tr><tr><td>converter</td><td>æˆå‘˜å˜é‡è½¬æ¢å™¨</td><td>è‡ªå®šä¹‰è½¬æ¢å™¨éœ€è¦å®Converteræ¥å£</td></tr></tbody></table><p>ä¸ä½¿ç”¨@ExcelPropertyæ³¨è§£æ—¶ï¼Œæˆå‘˜å˜é‡ä»ä¸Šåˆ°ä¸‹çš„é¡ºåºï¼Œå¯¹åº”è¡¨æ ¼ä¸­ä»å·¦åˆ°å³çš„é¡ºåºè¿›è¡Œè§£æã€‚indexå±æ€§å’Œvalueå±æ€§éƒ½å¯ä»¥æŒ‡å®šå½“å‰å­—æ®µå¯¹åº”excelä¸­çš„å“ªä¸€åˆ—ï¼Œæ¨èè®©indexå’Œvlaueçš„é…ç½®éƒ½æŒ‡å‘åŒä¸€åˆ—ã€‚</p><img src="/2022/11/16/EasyExcel-%C2%A9-pepsi-wyl/1668503487518-6498e19d-297f-4053-9fbb-bceea9f925fc.png" class=""><h4 id="ExcelIgnore"><a href="#ExcelIgnore" class="headerlink" title="@ExcelIgnore"></a>@ExcelIgnore</h4><p><strong>ä½¿ç”¨ä½ç½®</strong>ï¼šæ ‡æ³¨åœ¨æˆå‘˜å˜é‡ä¸Š<br />é»˜è®¤æ‰€æœ‰å­—æ®µéƒ½ä¼šå’ŒExcelè¡¨æ ¼å»åŒ¹é…ï¼ŒåŠ è¯¥æ³¨è§£åä¼šå¿½ç•¥è¯¥å­—æ®µï¼Œé€šå¸¸å°†æ•°æ®åº“çš„ä¸»é”®IDåŠ ä¸Šè¯¥æ³¨è§£ã€‚</p><img src="/2022/11/16/EasyExcel-%C2%A9-pepsi-wyl/1668503456389-2453323f-d2e4-4c70-a490-09a23d743ae7.png" class=""><h4 id="DateTimeFormat"><a href="#DateTimeFormat" class="headerlink" title="@DateTimeFormat"></a>@DateTimeFormat</h4><p><strong>ä½¿ç”¨ä½ç½®</strong>ï¼šæ ‡æ³¨åœ¨æˆå‘˜å˜é‡ä¸Š<br />ç”¨äºæ—¥æœŸè½¬æ¢ï¼Œç”¨<code>Stringç±»å‹çš„æˆå‘˜å˜é‡</code>å»æ¥æ”¶<code>excelä¸­æ—¥æœŸæ ¼å¼çš„æ•°æ®</code>ä¼šè°ƒç”¨è¿™ä¸ªæ³¨è§£ï¼Œ<code>value</code>å‚ç…§<code>java.text.SimpleDateFormat</code>æ ¼å¼ã€‚</p><img src="/2022/11/16/EasyExcel-%C2%A9-pepsi-wyl/1668503441942-02ebca2c-55ea-4d2d-a1fc-84108a586999.png" class=""><h4 id="NumberFormat"><a href="#NumberFormat" class="headerlink" title="@NumberFormat"></a>@NumberFormat</h4><p><strong>ä½¿ç”¨ä½ç½®</strong>ï¼šæ ‡æ³¨åœ¨æˆå‘˜å˜é‡ä¸Š<br />ç”¨äºæ•°å­—è½¬æ¢ï¼Œç”¨<code>Stringç±»å‹çš„æˆå‘˜å˜é‡</code>å»æ¥æ”¶<code>excelæ•°å­—æ ¼å¼çš„æ•°æ®</code>ä¼šè°ƒç”¨è¿™ä¸ªæ³¨è§£ï¼Œ<code>value</code>å‚ç…§<code>java.text.DecimalFormat</code>æ ¼å¼ã€‚</p><h4 id="ExcelIgnoreUnannotated"><a href="#ExcelIgnoreUnannotated" class="headerlink" title="@ExcelIgnoreUnannotated"></a>@ExcelIgnoreUnannotated</h4><p><strong>ä½¿ç”¨ä½ç½®</strong>ï¼šæ ‡æ³¨åœ¨ç±»ä¸Š<br />ä¸æ ‡æ³¨è¯¥æ³¨è§£æ—¶ï¼Œç±»ä¸­æ‰€æœ‰å±æ€§ï¼ˆé™¤@ExcelIgnoreçš„å±æ€§ï¼‰éƒ½ä¼šå‚ä¸è¯»å†™ï¼Œæ— è®ºæ˜¯å¦åœ¨æˆå‘˜å˜é‡ä¸ŠåŠ <code>@ExcelProperty</code> æ³¨è§£ã€‚<br />æ ‡æ³¨è¯¥æ³¨è§£åï¼Œåªè¯»å†™ç±»ä¸­æœ‰æ ‡æ³¨<code>@ExcelProperty</code> æ³¨è§£çš„å±æ€§ã€‚</p><h3 id="è¯»å–æ—¶é€šç”¨å‚æ•°"><a href="#è¯»å–æ—¶é€šç”¨å‚æ•°" class="headerlink" title="è¯»å–æ—¶é€šç”¨å‚æ•°"></a>è¯»å–æ—¶é€šç”¨å‚æ•°</h3><p><code>ReadWorkbook</code>,<code>ReadSheet</code> éƒ½æœ‰çš„å‚æ•°ï¼Œä¸ºç©ºæ—¶é»˜è®¤ä½¿ç”¨ä¸Šçº§</p><ul><li><code>converter</code> è½¬æ¢å™¨ï¼Œé»˜è®¤åŠ è½½äº†å¾ˆå¤šè½¬æ¢å™¨ï¼Œä¹Ÿå¯ä»¥è‡ªå®šä¹‰</li><li><code>readListener</code> è¯»ç›‘å¬å™¨ï¼Œåœ¨è¯»å–æ•°æ®çš„è¿‡ç¨‹ä¸­ä¼šä¸æ–­çš„è°ƒç”¨ç›‘å¬å™¨ </li><li><code>headRowNumber</code> æŒ‡å®šéœ€è¦è¯»çš„è¡¨æ ¼çš„åˆ—å¤´è¡Œæ•°ã€‚é»˜è®¤æœ‰ä¸€è¡Œå¤´ï¼Œä¹Ÿå°±æ˜¯è®¤ä¸ºç¬¬äºŒè¡Œå¼€å§‹èµ·ä¸ºæ•°æ®ã€‚ </li><li><code>head</code> ä¸<code>clazz</code>äºŒé€‰ä¸€ã€‚è¯»å–æ–‡ä»¶å¤´å¯¹åº”çš„åˆ—è¡¨ï¼Œæ ¹æ®åˆ—è¡¨åŒ¹é…æ•°æ®ã€‚å»ºè®®ä½¿ç”¨classï¼Œå³æ–‡ä»¶ä¸­æ¯ä¸€è¡Œæ•°æ®å¯¹åº”çš„ä»£ç ä¸­çš„å®ä½“ç±»å‹ã€‚ </li><li><code>clazz</code> ä¸<code>head</code>äºŒé€‰ä¸€ã€‚è¯»å–æ–‡ä»¶å¤´å¯¹åº”çš„classï¼Œæ ¹æ®classåŒ¹é…æ•°æ®ã€‚å¦‚æœä¸¤ä¸ªéƒ½ä¸æŒ‡å®šï¼Œåˆ™ä¼šè¯»å–å…¨éƒ¨æ•°æ®ã€‚ </li><li><code>autoTrim</code> å­—ç¬¦ä¸²ã€è¡¨å¤´ç­‰æ•°æ®è‡ªåŠ¨trim </li><li><code>password</code> è¯»çš„æ—¶å€™æ˜¯å¦éœ€è¦ä½¿ç”¨å¯†ç </li></ul><h4 id="ReadWorkbookï¼ˆå·¥ä½œç°¿å¯¹è±¡ï¼‰å‚æ•°"><a href="#ReadWorkbookï¼ˆå·¥ä½œç°¿å¯¹è±¡ï¼‰å‚æ•°" class="headerlink" title="ReadWorkbookï¼ˆå·¥ä½œç°¿å¯¹è±¡ï¼‰å‚æ•°"></a>ReadWorkbookï¼ˆå·¥ä½œç°¿å¯¹è±¡ï¼‰å‚æ•°</h4><ul><li><code>excelType</code> å½“å‰excelçš„ç±»å‹ï¼Œè¯»å–æ—¶è‡ªåŠ¨åˆ¤æ–­ï¼Œæ— éœ€è®¾ç½®ã€‚</li><li><code>inputStream</code> ä¸<code>file</code>äºŒé€‰ä¸€ã€‚å»ºè®®ä½¿ç”¨fileã€‚</li><li><code>file</code> ä¸<code>inputStream</code>äºŒé€‰ä¸€ã€‚è¯»å–æ–‡ä»¶çš„æ–‡ä»¶ã€‚</li><li><code>autoCloseStream</code> è‡ªåŠ¨å…³é—­æµã€‚</li><li><code>readCache</code> é»˜è®¤å°äº5Mç”¨å†…å­˜ï¼Œè¶…è¿‡5Mä½¿ç”¨ <code>EhCache</code>ï¼Œä¸å»ºè®®ä½¿ç”¨è¿™ä¸ªå‚æ•°ã€‚</li><li><code>useDefaultListener</code> <code>@since 2.1.4</code> é»˜è®¤ä¼šåŠ å…¥<code>ModelBuildEventListener</code> æ¥å¸®å¿™è½¬æ¢æˆä¼ å…¥<code>class</code>çš„å¯¹è±¡ï¼Œè®¾ç½®æˆ<code>false</code>åå°†ä¸ä¼šååŠ©è½¬æ¢å¯¹è±¡ï¼Œè‡ªå®šä¹‰çš„ç›‘å¬å™¨ä¼šæ¥æ”¶åˆ°<code>Map&lt;Integer,CellData&gt;</code>å¯¹è±¡ï¼Œå¦‚æœè¿˜æƒ³ç»§ç»­æ¥å¬åˆ°<code>class</code>å¯¹è±¡ï¼Œè¯·è°ƒç”¨<code>readListener</code>æ–¹æ³•ï¼ŒåŠ å…¥è‡ªå®šä¹‰çš„<code>beforeListener</code>ã€ <code>ModelBuildEventListener</code>ã€ è‡ªå®šä¹‰çš„<code>afterListener</code>å³å¯ã€‚</li></ul><h4 id="ReadSheetï¼ˆå·¥ä½œè¡¨å¯¹è±¡ï¼‰å‚æ•°"><a href="#ReadSheetï¼ˆå·¥ä½œè¡¨å¯¹è±¡ï¼‰å‚æ•°" class="headerlink" title="ReadSheetï¼ˆå·¥ä½œè¡¨å¯¹è±¡ï¼‰å‚æ•°"></a>ReadSheetï¼ˆå·¥ä½œè¡¨å¯¹è±¡ï¼‰å‚æ•°</h4><ul><li><code>sheetNo</code> éœ€è¦è¯»å–Sheetçš„ç¼–å·ï¼Œå»ºè®®ä½¿ç”¨è¯¥å‚æ•°æ¥æŒ‡å®šè¯»å–çš„Sheet</li><li><code>sheetName</code> éœ€è¦è¯»å–Sheetçš„åç§°ï¼Œexcel 2003ä¸æ”¯æŒæ ¹æ®åå­—å»åŒ¹é…</li></ul><h2 id="å†™å…¥APIåŠæ³¨è§£"><a href="#å†™å…¥APIåŠæ³¨è§£" class="headerlink" title="å†™å…¥APIåŠæ³¨è§£"></a>å†™å…¥APIåŠæ³¨è§£</h2><h3 id="æ³¨è§£-1"><a href="#æ³¨è§£-1" class="headerlink" title="æ³¨è§£"></a>æ³¨è§£</h3><h4 id="ExcelProperty-1"><a href="#ExcelProperty-1" class="headerlink" title="@ExcelProperty"></a>@ExcelProperty</h4><p><strong>ä½¿ç”¨ä½ç½®</strong>ï¼šä½œç”¨åœ¨æˆå‘˜å˜é‡ä¸Š<br /><strong>å¯é€‰å±æ€§ï¼š</strong></p><table><thead><tr><th>å±æ€§å</th><th>å«ä¹‰</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>index</td><td>å¯¹åº”Excelè¡¨ä¸­çš„åˆ—æ•°</td><td>é»˜è®¤-1ï¼ŒæŒ‡å®šæ—¶å»ºè®®ä»0å¼€å§‹</td></tr><tr><td>value</td><td>å¯¹åº”Excelè¡¨ä¸­çš„åˆ—å¤´</td><td><br /></td></tr><tr><td>converter</td><td>æˆå‘˜å˜é‡è½¬æ¢å™¨</td><td>è‡ªå®šä¹‰è½¬æ¢å™¨éœ€è¦å®Converteræ¥å£</td></tr></tbody></table><p><strong>ä½¿ç”¨æ•ˆæœ</strong>ï¼š<code>index</code> æŒ‡å®šå†™åˆ°ç¬¬å‡ åˆ—ï¼Œå¦‚æœä¸æŒ‡å®šåˆ™æ ¹æ®æˆå‘˜å˜é‡ä½ç½®æ’åºï¼›<code>value</code>æŒ‡å®šå†™å…¥çš„åˆ—å¤´ï¼Œå¦‚æœä¸æŒ‡å®šåˆ™ä½¿ç”¨æˆå‘˜å˜é‡çš„åå­—ä½œä¸ºåˆ—å¤´ï¼›<strong>å¦‚æœè¦è®¾ç½®å¤æ‚çš„å¤´ï¼Œå¯ä»¥ä¸ºvalueæŒ‡å®šå¤šä¸ªå€¼</strong>ã€‚</p><img src="/2022/11/16/EasyExcel-%C2%A9-pepsi-wyl/1668503487518-6498e19d-297f-4053-9fbb-bceea9f925fc.png" class=""><h4 id="ExcelIgnore-1"><a href="#ExcelIgnore-1" class="headerlink" title="@ExcelIgnore"></a>@ExcelIgnore</h4><p><strong>ä½¿ç”¨ä½ç½®</strong>ï¼šæ ‡æ³¨åœ¨æˆå‘˜å˜é‡ä¸Š<br />é»˜è®¤æ‰€æœ‰å­—æ®µéƒ½ä¼šå’ŒExcelè¡¨æ ¼å»åŒ¹é…ï¼ŒåŠ è¯¥æ³¨è§£åä¼šå¿½ç•¥è¯¥å­—æ®µï¼Œé€šå¸¸å°†æ•°æ®åº“çš„ä¸»é”®IDåŠ ä¸Šè¯¥æ³¨è§£ã€‚</p><img src="/2022/11/16/EasyExcel-%C2%A9-pepsi-wyl/1668503456389-2453323f-d2e4-4c70-a490-09a23d743ae7.png" class=""><h4 id="DateTimeFormat-1"><a href="#DateTimeFormat-1" class="headerlink" title="@DateTimeFormat"></a>@DateTimeFormat</h4><p><strong>ä½¿ç”¨ä½ç½®</strong>ï¼šæ ‡æ³¨åœ¨æˆå‘˜å˜é‡ä¸Š<br />ç”¨äºæ—¥æœŸè½¬æ¢ï¼Œç”¨<code>Stringç±»å‹çš„æˆå‘˜å˜é‡</code>å»æ¥æ”¶<code>excelä¸­æ—¥æœŸæ ¼å¼çš„æ•°æ®</code>ä¼šè°ƒç”¨è¿™ä¸ªæ³¨è§£ï¼Œ<code>value</code>å‚ç…§<code>java.text.SimpleDateFormat</code>æ ¼å¼ã€‚</p><img src="/2022/11/16/EasyExcel-%C2%A9-pepsi-wyl/1668503441942-02ebca2c-55ea-4d2d-a1fc-84108a586999.png" class=""><h4 id="NumberFormat-1"><a href="#NumberFormat-1" class="headerlink" title="@NumberFormat"></a>@NumberFormat</h4><p><strong>ä½¿ç”¨ä½ç½®</strong>ï¼šæ ‡æ³¨åœ¨æˆå‘˜å˜é‡ä¸Š<br />ç”¨äºæ•°å­—è½¬æ¢ï¼Œç”¨<code>Stringç±»å‹çš„æˆå‘˜å˜é‡</code>å»æ¥æ”¶<code>excelæ•°å­—æ ¼å¼çš„æ•°æ®</code>ä¼šè°ƒç”¨è¿™ä¸ªæ³¨è§£ï¼Œ<code>value</code>å‚ç…§<code>java.text.DecimalFormat</code>æ ¼å¼ã€‚</p><h4 id="ExcelIgnoreUnannotated-1"><a href="#ExcelIgnoreUnannotated-1" class="headerlink" title="@ExcelIgnoreUnannotated"></a>@ExcelIgnoreUnannotated</h4><p><strong>ä½¿ç”¨ä½ç½®</strong>ï¼šæ ‡æ³¨åœ¨ç±»ä¸Š<br />ä¸æ ‡æ³¨è¯¥æ³¨è§£æ—¶ï¼Œç±»ä¸­æ‰€æœ‰å±æ€§ï¼ˆé™¤@ExcelIgnoreçš„å±æ€§ï¼‰éƒ½ä¼šå‚ä¸è¯»å†™ï¼Œæ— è®ºæ˜¯å¦åœ¨æˆå‘˜å˜é‡ä¸ŠåŠ <code>@ExcelProperty</code> æ³¨è§£ã€‚<br />æ ‡æ³¨è¯¥æ³¨è§£åï¼Œåªè¯»å†™ç±»ä¸­æœ‰æ ‡æ³¨<code>@ExcelProperty</code> æ³¨è§£çš„å±æ€§</p><h4 id="HeadRowHeight-value"><a href="#HeadRowHeight-value" class="headerlink" title="@HeadRowHeight(value)"></a>@HeadRowHeight(value)</h4><p><strong>ä½¿ç”¨ä½ç½®</strong>ï¼šæ ‡æ³¨åœ¨ç±»ä¸Š<br />æŒ‡å®šåˆ—å¤´è¡Œé«˜</p><h4 id="ContentRowHeight-value"><a href="#ContentRowHeight-value" class="headerlink" title="@ContentRowHeight(value)"></a>@ContentRowHeight(value)</h4><p><strong>ä½¿ç”¨ä½ç½®</strong>ï¼šæ ‡æ³¨åœ¨ç±»ä¸Šä¸Š<br />æŒ‡å®šå†…å®¹è¡Œé«˜ï¼Œç»Ÿä¸€è¡Œé«˜ </p><h4 id="ColumnWidth-value"><a href="#ColumnWidth-value" class="headerlink" title="@ColumnWidth(value)"></a>@ColumnWidth(value)</h4><p><strong>ä½¿ç”¨ä½ç½®</strong>ï¼šæ ‡æ³¨åœ¨ç±»ä¸Šæˆ–å±æ€§ä¸Š<br />æŒ‡å®šåˆ—å®½ ï¼Œä½œç”¨äºç±»ä¸Šæ—¶ç»Ÿä¸€åˆ—å®½ï¼Œä½œç”¨äºå±æ€§ä¸Šæ—¶å•ç‹¬è®¾ç½®åˆ—å®½ï¼Œå±æ€§ä¸Šçš„ä¼˜å…ˆçº§å¤§äºç±»ä¸Šã€‚</p><h3 id="å†™å…¥æ—¶é€šç”¨å‚æ•°"><a href="#å†™å…¥æ—¶é€šç”¨å‚æ•°" class="headerlink" title="å†™å…¥æ—¶é€šç”¨å‚æ•°"></a>å†™å…¥æ—¶é€šç”¨å‚æ•°</h3><p><code>WriteWorkbook</code>ã€<code>WriteSheet</code>éƒ½æœ‰çš„å‚æ•°ï¼Œä¸ºç©ºæ—¶ä½¿ç”¨ä¸Šçº§</p><ul><li><code>converter</code> è½¬æ¢å™¨ï¼Œé»˜è®¤åŠ è½½äº†å¾ˆå¤šè½¬æ¢å™¨ï¼Œä¹Ÿå¯ä»¥è‡ªå®šä¹‰ã€‚ </li><li><code>writeHandler</code> å†™å¤„ç†å™¨ã€‚å¯ä»¥å®ç°<code>WorkbookWriteHandler</code>,<code>SheetWriteHandler</code>,<code>RowWriteHandler</code>,<code>CellWriteHandler</code>ï¼Œåœ¨å†™å…¥excelçš„ä¸åŒé˜¶æ®µä¼šè°ƒç”¨ï¼Œå¯¹ä½¿ç”¨è€…é€æ˜ä¸å¯è§ã€‚ </li><li><code>relativeHeadRowIndex</code> è·ç¦»å¤šå°‘è¡Œåå¼€å§‹ï¼Œå³å¼€å¤´ç©ºå‡ è¡Œã€‚ </li><li><code>needHead</code> æ˜¯å¦å¯¼å‡ºå¤´ </li><li><code>head</code> ä¸<code>clazz</code>äºŒé€‰ä¸€ã€‚è¯»å–æ–‡ä»¶å¤´å¯¹åº”çš„åˆ—è¡¨ï¼Œæ ¹æ®åˆ—è¡¨åŒ¹é…æ•°æ®ã€‚å»ºè®®ä½¿ç”¨classï¼Œå³æ–‡ä»¶ä¸­æ¯ä¸€è¡Œæ•°æ®å¯¹åº”çš„ä»£ç ä¸­çš„å®ä½“ç±»å‹ã€‚ </li><li><code>clazz</code> ä¸<code>head</code>äºŒé€‰ä¸€ã€‚è¯»å–æ–‡ä»¶å¤´å¯¹åº”çš„classï¼Œæ ¹æ®classåŒ¹é…æ•°æ®ã€‚å¦‚æœä¸¤ä¸ªéƒ½ä¸æŒ‡å®šï¼Œåˆ™ä¼šè¯»å–å…¨éƒ¨æ•°æ®ã€‚ </li><li><code>autoTrim</code> Â å­—ç¬¦ä¸²ã€è¡¨å¤´ç­‰æ•°æ®è‡ªåŠ¨trim</li></ul><h4 id="WriteWorkbookï¼ˆå·¥ä½œç°¿å¯¹è±¡ï¼‰å‚æ•°"><a href="#WriteWorkbookï¼ˆå·¥ä½œç°¿å¯¹è±¡ï¼‰å‚æ•°" class="headerlink" title="WriteWorkbookï¼ˆå·¥ä½œç°¿å¯¹è±¡ï¼‰å‚æ•°"></a>WriteWorkbookï¼ˆå·¥ä½œç°¿å¯¹è±¡ï¼‰å‚æ•°</h4><ul><li><code>excelType</code> å½“å‰excelçš„ç±»å‹ï¼Œé»˜è®¤ä¸º<code>xlsx</code> ã€‚</li><li><code>outputStream</code> ä¸<code>file</code>äºŒé€‰ä¸€ï¼Œå†™å…¥æ–‡ä»¶çš„æµ ã€‚</li><li><code>file</code> ä¸<code>outputStream</code>äºŒé€‰ä¸€ï¼Œå†™å…¥çš„æ–‡ä»¶ ã€‚</li><li><code>templateInputStream</code> æ¨¡æ¿çš„æ–‡ä»¶æµ </li><li><code>templateFile</code> æ¨¡æ¿æ–‡ä»¶ </li><li><code>autoCloseStream</code> è‡ªåŠ¨å…³é—­æµã€‚ </li><li><code>password</code> Â å†™çš„æ—¶å€™æ˜¯å¦éœ€è¦ä½¿ç”¨å¯†ç  </li><li><code>useDefaultStyle</code> å†™çš„æ—¶å€™æ˜¯å¦æ˜¯ä½¿ç”¨é»˜è®¤å¤´</li></ul><h4 id="WriteSheetï¼ˆå·¥ä½œè¡¨å¯¹è±¡ï¼‰å‚æ•°"><a href="#WriteSheetï¼ˆå·¥ä½œè¡¨å¯¹è±¡ï¼‰å‚æ•°" class="headerlink" title="WriteSheetï¼ˆå·¥ä½œè¡¨å¯¹è±¡ï¼‰å‚æ•°"></a>WriteSheetï¼ˆå·¥ä½œè¡¨å¯¹è±¡ï¼‰å‚æ•°</h4><ul><li><code>sheetNo</code> éœ€è¦å†™å…¥Sheetçš„ç¼–å·ï¼Œå»ºè®®ä½¿ç”¨è¯¥å‚æ•°æ¥æŒ‡å®šå†™å…¥çš„Sheet ã€‚</li><li><code>sheetName</code> éœ€è¦å†™å…¥Sheetçš„åç§°ï¼Œexcel 2003ä¸æ”¯æŒæ ¹æ®åå­—å»åŒ¹é…ã€‚</li></ul><h1 id="å¸¸è§é—®é¢˜"><a href="#å¸¸è§é—®é¢˜" class="headerlink" title="å¸¸è§é—®é¢˜"></a>å¸¸è§é—®é¢˜</h1><h2 id="å®˜æ–¹åœ°å€-2"><a href="#å®˜æ–¹åœ°å€-2" class="headerlink" title="å®˜æ–¹åœ°å€"></a>å®˜æ–¹åœ°å€</h2><p>å¿…è¯» <a href="https://easyexcel.opensource.alibaba.com/qa/">https://easyexcel.opensource.alibaba.com/qa/</a><br>è¯»Excel <a href="https://easyexcel.opensource.alibaba.com/qa/read">https://easyexcel.opensource.alibaba.com/qa/read</a><br>å†™Excel <a href="https://easyexcel.opensource.alibaba.com/qa/read">https://easyexcel.opensource.alibaba.com/qa/read</a><br>å¡«å……Excel <a href="https://easyexcel.opensource.alibaba.com/qa/fill">https://easyexcel.opensource.alibaba.com/qa/fill</a></p><h2 id="å¿…è¯»"><a href="#å¿…è¯»" class="headerlink" title="å¿…è¯»"></a>å¿…è¯»</h2><h3 id="æˆ‘çš„éƒ¨åˆ†å­—æ®µä¸ºä»€ä¹ˆæ²¡æ³•è¯»å–æˆ–è€…å†™å…¥ï¼Ÿ"><a href="#æˆ‘çš„éƒ¨åˆ†å­—æ®µä¸ºä»€ä¹ˆæ²¡æ³•è¯»å–æˆ–è€…å†™å…¥ï¼Ÿ" class="headerlink" title="æˆ‘çš„éƒ¨åˆ†å­—æ®µä¸ºä»€ä¹ˆæ²¡æ³•è¯»å–æˆ–è€…å†™å…¥ï¼Ÿ"></a>æˆ‘çš„éƒ¨åˆ†å­—æ®µä¸ºä»€ä¹ˆæ²¡æ³•è¯»å–æˆ–è€…å†™å…¥ï¼Ÿ</h3><ul><li>è¯»å†™åå°„å¯¹è±¡ç”¨åˆ°äº†Cglib,æ‰€ä»¥æˆå‘˜å˜é‡å¿…é¡»ç¬¦åˆé©¼å³°è§„èŒƒï¼Œè¯·ç¡®è®¤æ˜¯å¦ç¬¦åˆé©¼å³°è§„èŒƒ<ul><li>åœ¨3.0.0-beta1 å…¼å®¹äº†éƒ¨åˆ†éé©¼å³°ï¼Œä½†æ˜¯è¿˜æ˜¯ä¸å»ºè®®ä½¿ç”¨éé©¼å³°å­—æ®µ</li></ul></li><li>ä½¿ç”¨äº†lombokçš„@Accessors(chain &#x3D; true) ï¼Œæ— æ³•è¢«Cglibè¯»å–<ul><li>å»ºè®®ä½¿ç”¨@Builderæ¥æ›¿æ¢@Accessors(chain &#x3D; true)</li></ul></li></ul><h3 id="æˆ‘åœ¨æœ¬åœ°å¯ä»¥ï¼Œå‘å¸ƒåˆ°çº¿ä¸Šç¯å¢ƒæ€ä¹ˆä¸å¯ä»¥äº†ï¼Ÿ"><a href="#æˆ‘åœ¨æœ¬åœ°å¯ä»¥ï¼Œå‘å¸ƒåˆ°çº¿ä¸Šç¯å¢ƒæ€ä¹ˆä¸å¯ä»¥äº†ï¼Ÿ" class="headerlink" title="æˆ‘åœ¨æœ¬åœ°å¯ä»¥ï¼Œå‘å¸ƒåˆ°çº¿ä¸Šç¯å¢ƒæ€ä¹ˆä¸å¯ä»¥äº†ï¼Ÿ"></a>æˆ‘åœ¨æœ¬åœ°å¯ä»¥ï¼Œå‘å¸ƒåˆ°çº¿ä¸Šç¯å¢ƒæ€ä¹ˆä¸å¯ä»¥äº†ï¼Ÿ</h3><p>å¤§æ¦‚ç‡æ˜¯ç¼ºå°‘å­—ä½“åº“å¯¼è‡´ï¼Œ2ä¸ªæ–¹æ¡ˆï¼š</p><ul><li>å®‰è£…å­—ä½“ï¼ˆæ¨èï¼‰<ul><li>çœ‹ä¸‹æœåŠ¡å™¨æ˜¯å¦å®‰è£…äº†å­—ä½“ï¼Œjdk8å­—ä½“éœ€è¦è‡ªå·±å®‰è£…è¯·å®‰è£…å­—ä½“ï¼šdejavu-sans-fonts å’Œ fontconfig åœ¨dockerfileä¸­å¢åŠ å­—ä½“å®‰è£…å‘½ä»¤ï¼š RUN <strong>yum install dejavu-sans-fonts fontconfig -y</strong></li><li>æ™®é€šçš„çº¿ä¸Šç¯å¢ƒç›´æ¥è¿è¡Œï¼š yum install dejavu-sans-fonts fontconfig -y</li></ul></li><li>å¼€å¯å†…å­˜å¤„ç†æ¨¡å¼ï¼ˆä¸æ¨èï¼Œ1Wæ•°æ®ä»¥å†…å¯ä»¥è€ƒè™‘ï¼Œå¤§äº†å¾ˆå®¹æ˜“OOMï¼‰<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">EasyExcel</span><br><span class="line">    .write(fileName, DemoData.class)</span><br><span class="line">    <span class="comment">// æ ¸å¿ƒè¿™ä¸ªé…ç½® å¼€å§‹å†…å­˜å¤„ç†æ¨¡å¼</span></span><br><span class="line">    .inMemory(Boolean.TRUE)</span><br><span class="line">    .sheet(<span class="string">&quot;æ¨¡æ¿&quot;</span>)</span><br><span class="line">    .doWrite(data());</span><br></pre></td></tr></table></figure></li></ul><h2 id="è¯»Excel"><a href="#è¯»Excel" class="headerlink" title="è¯»Excel"></a>è¯»Excel</h2><h3 id="ä¸ºä»€ä¹ˆListener-ä¸èƒ½è®©springç®¡ç†ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆListener-ä¸èƒ½è®©springç®¡ç†ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆListener ä¸èƒ½è®©springç®¡ç†ï¼Ÿ"></a>ä¸ºä»€ä¹ˆListener ä¸èƒ½è®©springç®¡ç†ï¼Ÿ</h3><ul><li>åœ¨è¯»å–excelçš„æ—¶å€™ï¼Œä¼šå›è°ƒcom.alibaba.excel.read.listener.ReadListener#invokeçš„æ–¹æ³•ï¼Œè€Œspringå¦‚æœç®¡ç†Listenerä¼šå¯¼è‡´Listener å˜æˆäº†å•ä¾‹ï¼Œåœ¨æœ‰å¹¶å‘è¯»å–æ–‡ä»¶çš„æƒ…å†µä¸‹éƒ½ä¼šå›è°ƒåŒä¸€ä¸ªListenerï¼Œå°±æ— æ³•åŒºåˆ†æ˜¯å“ªä¸ªæ–‡ä»¶è¯»å–å‡ºæ¥çš„äº†ã€‚</li></ul><h3 id="åœ¨è¯»çš„æ—¶å€™Listeneré‡Œé¢éœ€è¦ä½¿ç”¨springçš„-Autowired"><a href="#åœ¨è¯»çš„æ—¶å€™Listeneré‡Œé¢éœ€è¦ä½¿ç”¨springçš„-Autowired" class="headerlink" title="åœ¨è¯»çš„æ—¶å€™Listeneré‡Œé¢éœ€è¦ä½¿ç”¨springçš„@Autowired"></a>åœ¨è¯»çš„æ—¶å€™Listeneré‡Œé¢éœ€è¦ä½¿ç”¨springçš„@Autowired</h3><ul><li><p>æ–¹æ¡ˆ1ï¼šé¿å¼€åˆ›å»ºListenerçš„ç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">EasyExcel.read(fileName, DemoData.class, <span class="keyword">new</span> <span class="title class_">PageReadListener</span>&lt;DemoData&gt;(dataList -&gt; &#123;</span><br><span class="line">    <span class="keyword">for</span> (DemoData demoData : dataList) &#123;</span><br><span class="line">        log.info(<span class="string">&quot;è¯»å–åˆ°ä¸€æ¡æ•°æ®&#123;&#125;&quot;</span>, JSON.toJSONString(demoData));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)).sheet().doRead();</span><br></pre></td></tr></table></figure></li><li><p>æ–¹æ¡ˆ2</p><ul><li>ç»™Listeneråˆ›å»ºæˆå‘˜å˜é‡ï¼Œç„¶ååœ¨æ„é€ æ–¹æ³•é‡Œé¢ä¼ è¿›å»ã€‚å¿…é¡»ä¸è®©springç®¡ç†Listenerï¼Œæ¯æ¬¡è¯»å–éƒ½è¦newä¸€ä¸ªã€‚</li></ul></li></ul><h3 id="å¼€å¯æ€¥é€Ÿæ¨¡å¼"><a href="#å¼€å¯æ€¥é€Ÿæ¨¡å¼" class="headerlink" title="å¼€å¯æ€¥é€Ÿæ¨¡å¼"></a>å¼€å¯æ€¥é€Ÿæ¨¡å¼</h3><p>æ€¥é€Ÿæ¨¡å¼å¯ä»¥è‡ªå·±å¼€å¯åæµ‹è¯•ä¸‹å†…å­˜çš„å ç”¨ï¼Œå¦‚æœæ„Ÿè§‰ç¬¦åˆé¢„æœŸå¯ä»¥ç›´æ¥å¼€å¯ã€‚<br />å¦‚æœæœ€å¤§æ–‡ä»¶æ¡æ•°ä¹Ÿå°±åå‡ äºŒåä¸‡ï¼Œç„¶åexcelä¹Ÿå°±æ˜¯åå‡ äºŒåMï¼Œè€Œä¸”ä¸ä¼šæœ‰å¾ˆé«˜çš„å¹¶å‘ï¼Œå¹¶ä¸”å†…å­˜ä¹Ÿè¾ƒå¤§ã€‚è¿™ç§æƒ…å†µä¸‹å¯ä»¥è€ƒè™‘å¼€å¯æé€Ÿæ¨¡å¼ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¼ºåˆ¶ä½¿ç”¨å†…å­˜å­˜å‚¨ï¼Œè¿™æ ·å¤§æ¦‚ä¸€ä¸ª20Mçš„excelä½¿ç”¨150Mï¼ˆå¾ˆå¤šä¸´æ—¶å¯¹è±¡ï¼Œæ‰€ä»¥100Mä¼šä¸€ç›´GCï¼‰çš„å†…å­˜</span></span><br><span class="line"><span class="comment">// è¿™æ ·æ•ˆç‡ä¼šæ¯”ä¸Šé¢çš„å¤æ‚çš„ç­–ç•¥é«˜å¾ˆ</span></span><br><span class="line"><span class="comment">// è¿™é‡Œå†è¯´æ˜ä¸‹ å°±æ˜¯åŠ äº†ä¸ªreadCache(new MapCache()) å‚æ•°è€Œå·²ï¼Œå…¶ä»–çš„å‚ç…§å…¶ä»–demoå†™ è¿™é‡Œæ²¡æœ‰å†™å…¨ </span></span><br><span class="line">EasyExcel.read().readCache(<span class="keyword">new</span> <span class="title class_">MapCache</span>());</span><br></pre></td></tr></table></figure><h2 id="å†™Excel"><a href="#å†™Excel" class="headerlink" title="å†™Excel"></a>å†™Excel</h2><h3 id="å¯¼å‡ºçš„excelæ‰“ä¸å¼€"><a href="#å¯¼å‡ºçš„excelæ‰“ä¸å¼€" class="headerlink" title="å¯¼å‡ºçš„excelæ‰“ä¸å¼€"></a>å¯¼å‡ºçš„excelæ‰“ä¸å¼€</h3><p>å¤§æ¦‚ç‡ç”±ä»¥ä¸‹2ä¸ªåŸå› å¯¼è‡´ï¼š</p><ul><li>å‰ç«¯ç”¨å„ç§æ¡†æ¶æ¥å¯¼å‡ºï¼Œç„¶åæŠŠæ–‡ä»¶æµæ”¹äº†</li><li>åç«¯å„ç§æ‹¦æˆªå™¨ï¼ŒæŠŠæ–‡ä»¶æµæ”¹äº†</li></ul><h4 id="è§£å†³æ–¹æ¡ˆï¼š"><a href="#è§£å†³æ–¹æ¡ˆï¼š" class="headerlink" title="è§£å†³æ–¹æ¡ˆï¼š"></a>è§£å†³æ–¹æ¡ˆï¼š</h4><ul><li>å…ˆæµ‹è¯•æŠŠæ–‡ä»¶å¯¼å‡ºåˆ°æœ¬åœ°ï¼Œè€Œä¸æ˜¯é€šè¿‡æµè§ˆå™¨<ul><li>è¿™ä¸ªæ ¸å¿ƒå®šä½æ˜¯ä¸æ˜¯è‡ªå·±ä»£ç å†™é”™äº†ï¼Œé€šè¿‡ä»£è¡¨ä»£ç æ²¡é—®é¢˜</li><li>ä¸é€šè¿‡è‡ªå·±å‚ç…§ä¸‹æœ€ç®€å•çš„å†™è¯•è¯•</li></ul></li><li>å†é€šè¿‡æµè§ˆå™¨è®¿é—®çš„æ–¹æ¡ˆå»å¯¼å‡º<ul><li>è¿™ä¸ªæ ¸å¿ƒç¡®è®¤æ˜¯å¦è¢«åç«¯çš„å„ç§æ‹¦æˆªå™¨æˆ–è€…nginxæŠŠæµç»™æ”¹åäº†ï¼Œé€šè¿‡ä»£è¡¨åç«¯+ç½‘ç»œæ²¡é—®é¢˜</li><li>ä¸é€šè¿‡è‡ªå·±è¯•ä¸‹ä¸ç”¨nginxç­‰è‡ªå·±è®¿é—®è¡Œä¸è¡Œï¼Œå¦‚æœè¿˜ä¸è¡Œé‚£å°±æ˜¯åç«¯çš„å„ç§æ‹¦æˆªå™¨å¯¼è‡´<ul><li>è¿™é‡Œæ³¨æ„ä¸‹æ³¨è§£æ˜¯@Controller ï¼Œä¸æ˜¯RestController</li><li>è¿”å›æ˜¯void,ç„¶åç¡®ä¿åé¢æ‰€æœ‰çš„æ‹¦æˆªå™¨ä¹‹ç±»çš„ä¸èƒ½å†ä¿®æ”¹æµ</li></ul></li></ul></li><li>æ¥ä¸‹æ¥å°±æ˜¯<strong>ç”©é”…ç»™å‰ç«¯</strong><ul><li>åç«¯åªè¦ç¡®ä¿æµè§ˆå™¨ç›´æ¥è®¿é—®èƒ½ä¸‹è½½å°±è¡Œï¼Œæ¥ä¸‹æ¥å‰ç«¯å„ç§æ¡†æ¶å¤„ç†çš„æ–¹æ¡ˆéƒ½ä¸ä¸€æ ·</li></ul></li></ul><h2 id="å¡«å……Excel"><a href="#å¡«å……Excel" class="headerlink" title="å¡«å……Excel"></a>å¡«å……Excel</h2><h3 id="æ¨¡æ¿ä¸­çš„å­—æ®µæœªæ›¿æ¢"><a href="#æ¨¡æ¿ä¸­çš„å­—æ®µæœªæ›¿æ¢" class="headerlink" title="æ¨¡æ¿ä¸­çš„å­—æ®µæœªæ›¿æ¢"></a>æ¨¡æ¿ä¸­çš„å­—æ®µæœªæ›¿æ¢</h3><p>ä½¿ç”¨EasyExcelç”Ÿæˆçš„æ¨¡æ¿ï¼Œå»å¡«å……ï¼Œç»“æœå¡«å……å­—æ®µæœªæ›¿æ¢ã€‚è¿™ä¸ªé—®é¢˜åŸå› æ¯”è¾ƒå¤æ‚ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥äº†è§£ä¸‹:ShardingStrings ,EasyExcelåœ¨å†™å…¥çš„æ—¶å€™ï¼Œä¸ºäº†çœå†…å­˜ï¼Œè€Œæœªä½¿ç”¨ShardingStringsã€‚</p><h4 id="è§£å†³æ–¹æ¡ˆï¼š-1"><a href="#è§£å†³æ–¹æ¡ˆï¼š-1" class="headerlink" title="è§£å†³æ–¹æ¡ˆï¼š"></a>è§£å†³æ–¹æ¡ˆï¼š</h4><p>åœ¨å¯¼å‡ºæ¨¡æ¿æ—¶ï¼Œä½¿ç”¨å‚æ•°inMemory&#x3D;trueå³å¯ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// è¿™é‡Œä½¿ç”¨inMemory(true) ä¼šè§¦å‘ å†™å…¥åˆ°ShardingStrings ä½†æ˜¯è¿™æ ·æ‰€æœ‰çš„æ•°æ®éƒ½ä¼šåœ¨å†…å­˜ æ‰€ä»¥å®¹æ˜“OOM</span><br><span class="line">// ä½†æ˜¯å¦‚æœæˆ‘ä»¬ä»…ä»…æ˜¯éœ€è¦å¯¼å‡ºæ¨¡æ¿ï¼Œå­—æ®µä¸æ˜¯å¾ˆå¤šï¼Œæ‰€ä»¥é—®é¢˜ä¸å¤§ã€‚</span><br><span class="line">// è¿™é‡Œæ³¨æ„ å¯¼å‡ºæ¨¡æ¿çš„åŠ å…¥è¿™ä¸ªå‚æ•° å®é™…å†™æ•°æ®åƒä¸‡åˆ«åŠ ï¼Œä¸ç„¶å®¹æ˜“OOM</span><br><span class="line">EasyExcel.write(fileName, DemoData.class).inMemory(true).sheet(&quot;æ¨¡æ¿&quot;).doWrite(fillData())</span><br></pre></td></tr></table></figure><h1 id="SpringBootè¯»å–Resourceæ–‡ä»¶"><a href="#SpringBootè¯»å–Resourceæ–‡ä»¶" class="headerlink" title="SpringBootè¯»å–Resourceæ–‡ä»¶"></a>SpringBootè¯»å–Resourceæ–‡ä»¶</h1><p>æœ€è¿‘åœ¨é¡¹ç›®ä¸­æ¶‰åŠåˆ°Excleçš„å¯¼å…¥åŠŸèƒ½ï¼Œé€šå¸¸æ˜¯æˆ‘ä»¬å®šä¹‰å®Œæ¨¡æ¿ä¾›ç”¨æˆ·ä¸‹è½½ï¼Œç”¨æˆ·æŒ‰ç…§æ¨¡æ¿å¡«å†™å®Œåä¸Šä¼ ã€‚è¿™é‡Œå¾…ä¸‹è½½æ¨¡æ¿ä½ç½®ä¸ºresource&#x2F;excelTemplate&#x2F;test.xlsxã€‚</p><h2 id="æ–¹å¼one"><a href="#æ–¹å¼one" class="headerlink" title="æ–¹å¼one"></a>æ–¹å¼one</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ClassPathResource</span> <span class="variable">classPathResource</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ClassPathResource</span>(<span class="string">&quot;excleTemplate/test.xlsx&quot;</span>);</span><br><span class="line"><span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span>classPathResource.getInputStream();</span><br></pre></td></tr></table></figure><h2 id="æ–¹å¼two"><a href="#æ–¹å¼two" class="headerlink" title="æ–¹å¼two"></a>æ–¹å¼two</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> Thread.currentThread().getContextClassLoader().getResourceAsStream(<span class="string">&quot;excleTemplate/test.xlsx&quot;</span>);</span><br></pre></td></tr></table></figure><h2 id="æ–¹å¼three"><a href="#æ–¹å¼three" class="headerlink" title="æ–¹å¼three"></a>æ–¹å¼three</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> <span class="built_in">this</span>.getClass().getResourceAsStream(<span class="string">&quot;/excleTemplate/test.xlsx&quot;</span>);</span><br></pre></td></tr></table></figure><h2 id=""><a href="#" class="headerlink" title=""></a><br /><br /></h2>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Excel </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hadoop Â© pepsi-wyl</title>
      <link href="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/"/>
      <url>/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/</url>
      
        <content type="html"><![CDATA[<h1 id="Hadoopç®€ä»‹"><a href="#Hadoopç®€ä»‹" class="headerlink" title="Hadoopç®€ä»‹"></a>Hadoopç®€ä»‹</h1><p>Hadoopæ˜¯Apacheè½¯ä»¶åŸºé‡‘ä¼šæ——ä¸‹çš„ä¸€ä¸ªå¼€æºåˆ†å¸ƒå¼è®¡ç®—å¹³å°ï¼Œä¸ºç”¨æˆ·æä¾›äº†ç³»ç»Ÿåº•å±‚ç»†èŠ‚é€æ˜çš„åˆ†å¸ƒå¼åŸºç¡€æ¶æ„ã€‚Hadoopæ˜¯åŸºäºJavaè¯­è¨€å¼€å‘çš„ï¼Œå…·æœ‰å¾ˆå¥½çš„è·¨å¹³å°ç‰¹æ€§ï¼Œå¹¶ä¸”å¯ä»¥éƒ¨ç½²åœ¨å»‰ä»·çš„è®¡ç®—æœºé›†ç¾¤ä¸­ã€‚Hadoopçš„æ ¸å¿ƒæ˜¯åˆ†å¸ƒå¼æ–‡ä»¶ç³»ç»Ÿï¼ˆHadoop Distributed File Systemï¼ŒHDFSï¼‰å’ŒMapReduceã€‚Apache Hadoopç‰ˆæœ¬åˆ†ä¸ºä¸‰ä»£ï¼Œåˆ†åˆ«æ˜¯Hadoop 1.0ã€Hadoop 2.0å’ŒHadoop3.0ã€‚é™¤äº†å…è´¹å¼€æºçš„Apache Hadoopä»¥å¤–ï¼Œè¿˜æœ‰ä¸€äº›å•†ä¸šå…¬å¸æ¨å‡ºHadoopçš„å‘è¡Œç‰ˆã€‚2008å¹´ï¼ŒClouderaæˆä¸ºç¬¬ä¸€ä¸ªHadoopå•†ä¸šåŒ–å…¬å¸ï¼Œå¹¶åœ¨2009å¹´æ¨å‡ºç¬¬ä¸€ä¸ªHadoopå‘è¡Œç‰ˆã€‚æ­¤åï¼Œå¾ˆå¤šå¤§å…¬å¸ä¹ŸåŠ å…¥äº†åšHadoopäº§å“åŒ–çš„è¡Œåˆ—ï¼Œæ¯”å¦‚MapRã€Hortonworksã€æ˜Ÿç¯ç­‰ã€‚2018å¹´10æœˆï¼ŒClouderaå’ŒHortonworkså®£å¸ƒåˆå¹¶ã€‚ä¸€èˆ¬è€Œè¨€ï¼Œå•†ä¸šåŒ–å…¬å¸æ¨å‡ºçš„Hadoopå‘è¡Œç‰ˆä¹Ÿæ˜¯ä»¥Apache Hadoopä¸ºåŸºç¡€ï¼Œä½†æ˜¯å‰è€…æ¯”åè€…å…·æœ‰æ›´å¥½çš„æ˜“ç”¨æ€§ã€æ›´å¤šçš„åŠŸèƒ½ä»¥åŠæ›´é«˜çš„æ€§èƒ½ã€‚</p><h1 id="å•æœºå®‰è£…"><a href="#å•æœºå®‰è£…" class="headerlink" title="å•æœºå®‰è£…"></a>å•æœºå®‰è£…</h1><h2 id="é¢„å…ˆé…ç½®"><a href="#é¢„å…ˆé…ç½®" class="headerlink" title="é¢„å…ˆé…ç½®"></a>é¢„å…ˆé…ç½®</h2><h3 id="å…³é—­é˜²ç«å¢™"><a href="#å…³é—­é˜²ç«å¢™" class="headerlink" title="å…³é—­é˜²ç«å¢™"></a>å…³é—­é˜²ç«å¢™</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å…³é—­</span></span><br><span class="line">systemctl stop firewalld</span><br><span class="line"><span class="comment"># ç¦æ­¢å¼€æœºè‡ªå¯</span></span><br><span class="line">systemctl <span class="built_in">disable</span> firewalld</span><br></pre></td></tr></table></figure><h3 id="ä¿®æ”¹ä¸»æœºåç§°å’Œæ·»åŠ æ˜ å°„"><a href="#ä¿®æ”¹ä¸»æœºåç§°å’Œæ·»åŠ æ˜ å°„" class="headerlink" title="ä¿®æ”¹ä¸»æœºåç§°å’Œæ·»åŠ æ˜ å°„"></a>ä¿®æ”¹ä¸»æœºåç§°å’Œæ·»åŠ æ˜ å°„</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¿®æ”¹ä¸»æœºåç§°</span></span><br><span class="line">hostnamectl set-hostname hadoop</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ·»åŠ æ˜ å°„</span></span><br><span class="line">vim /etc/hosts</span><br><span class="line">192.168.131.144 hadoop</span><br></pre></td></tr></table></figure><h3 id="åˆ›å»ºHadoopç”¨æˆ·"><a href="#åˆ›å»ºHadoopç”¨æˆ·" class="headerlink" title="åˆ›å»ºHadoopç”¨æˆ·"></a>åˆ›å»ºHadoopç”¨æˆ·</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºç”¨æˆ·å¹¶ä½¿ç”¨ /bin/bash ä½œä¸ºshell</span></span><br><span class="line">useradd -m hadoop -s /bin/bash</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç»™hadoopç”¨æˆ·è®¾ç½®å¯†ç ï¼Œè‹¥æç¤ºå¯†ç æ— æ•ˆï¼Œä¸ç”¨ç®¡ï¼Œæ¥ç€è¾“å…¥ä¸€æ¬¡å³å¯</span></span><br><span class="line">passwd hadoop</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç»™hadoopå¢åŠ æ‰§è¡Œæƒé™</span></span><br><span class="line">visudo</span><br><span class="line"><span class="comment">#98è¡Œ  è¾“å…¥ :98 è·³è½¬è‡³98è¡Œï¼Œå¢åŠ ä¸€è¡Œ hadoop  ALL=(ALL) ALL</span></span><br><span class="line">root   ALL=(ALL) ALL</span><br><span class="line">hadoop ALL=(ALL) ALL</span><br></pre></td></tr></table></figure><h3 id="è®¾ç½®SSHå…å¯†ç™»é™†"><a href="#è®¾ç½®SSHå…å¯†ç™»é™†" class="headerlink" title="è®¾ç½®SSHå…å¯†ç™»é™†"></a>è®¾ç½®SSHå…å¯†ç™»é™†</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è¿ç»­æ•²å‡»3æ¬¡å›è½¦</span></span><br><span class="line">ssh-keygen -t rsa</span><br></pre></td></tr></table></figure><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1663641733146-a8455665-58ee-40e3-a010-2bf11716ce01.png" class=""><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹ç”Ÿæˆçš„ç§˜é’¥å¯¹</span></span><br><span class="line"><span class="built_in">ls</span> ~/.ssh/ </span><br></pre></td></tr></table></figure><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1663641760536-97777943-3817-457e-adf0-f77610436ebd.png" class=""><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è¿½åŠ å…¬é’¥ï¼Œæ‰§è¡Œå‘½ä»¤åï¼Œæ ¹æ®æç¤ºè¾“å…¥ yes å†æ¬¡å›è½¦</span></span><br><span class="line">ssh-copy-id hadoop</span><br></pre></td></tr></table></figure><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1663641803197-e32579dd-bef8-460f-afc3-11123ca453d4.png" class=""><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹ç”Ÿæˆçš„è®¤è¯æ–‡ä»¶ authorized_keys</span></span><br><span class="line"><span class="built_in">ls</span> ~/.ssh/ authorized_keys id_rsa id_rsa.pub known_hosts</span><br></pre></td></tr></table></figure><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1663641836828-57203ca4-ed25-4f44-b55a-c43f1617fea5.png" class=""><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># éªŒè¯å…å¯†</span></span><br><span class="line">ssh hadoop</span><br><span class="line">ssh 192.168.131.144</span><br><span class="line"><span class="comment"># é€€å‡º</span></span><br><span class="line"><span class="built_in">exit</span></span><br></pre></td></tr></table></figure><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1663641915104-1b41fa2d-da76-4f02-8de6-3b396efca443.png" class=""> <h3 id="å®‰è£…JAVAå¹¶é…ç½®ç¯å¢ƒå˜é‡"><a href="#å®‰è£…JAVAå¹¶é…ç½®ç¯å¢ƒå˜é‡" class="headerlink" title="å®‰è£…JAVAå¹¶é…ç½®ç¯å¢ƒå˜é‡"></a>å®‰è£…JAVAå¹¶é…ç½®ç¯å¢ƒå˜é‡</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ä¸Šä¼ è‡³æœåŠ¡å™¨å¹¶ä¸”è§£å‹æ›´æ”¹åç§°</span></span><br><span class="line">tar -xvzf jdk-8u351-linux-x64.tar.gz </span><br><span class="line">mv jdk-8u351 jdk8</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ç¼–è¾‘é…ç½®æ–‡ä»¶</span></span><br><span class="line">vim /etc/profile </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">è®¾ç½®jdkç¯å¢ƒå˜é‡</span></span><br><span class="line">export JAVA_HOME=/home/hadoop/jdk8  #jdkå®‰è£…ç›®å½•</span><br><span class="line">export JRE_HOME=$&#123;JAVA_HOME&#125;/jre</span><br><span class="line">export CLASSPATH=.:$&#123;JAVA_HOME&#125;/lib:$&#123;JRE_HOME&#125;/lib:$CLASSPATH</span><br><span class="line">export JAVA_PATH=$&#123;JAVA_HOME&#125;/bin:$&#123;JRE_HOME&#125;/bin</span><br><span class="line">export PATH=$PATH:$&#123;JAVA_PATH&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ä½¿é…ç½®æ–‡ä»¶ç”Ÿæ•ˆ</span></span><br><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ£€æŸ¥æ˜¯å¦å®‰è£…æˆåŠŸ</span></span><br><span class="line">java -version</span><br></pre></td></tr></table></figure><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1663589572984-3f8831f9-bdb3-48ff-a4a0-cd1f2dd7bfdc.png" class=""> <h3 id="å®‰è£…Hadoopå¹¶é…ç½®ç¯å¢ƒå˜é‡"><a href="#å®‰è£…Hadoopå¹¶é…ç½®ç¯å¢ƒå˜é‡" class="headerlink" title="å®‰è£…Hadoopå¹¶é…ç½®ç¯å¢ƒå˜é‡"></a>å®‰è£…Hadoopå¹¶é…ç½®ç¯å¢ƒå˜é‡</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ä¸Šä¼ è‡³æœåŠ¡å™¨å¹¶ä¸”è§£å‹æ›´æ”¹åç§°</span></span><br><span class="line">tar -zxvf hadoop-3.1.3.tar.gz</span><br><span class="line">mv hadoop-3.1.3 hadoop</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æŸ¥çœ‹æ˜¯å¦å¯ç”¨</span></span><br><span class="line">/home/hadoop/hadoop/bin/hadoop version</span><br></pre></td></tr></table></figure><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1667010092554-700f0aa9-b031-4e92-b770-500fdb34f7d3.png" class=""> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ç¼–è¾‘profileæ–‡ä»¶</span></span><br><span class="line">vim /etc/profile</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å¢åŠ hadoopç¯å¢ƒå˜é‡</span></span><br><span class="line">export HADOOP_HOME=/home/hadoop/hadoop</span><br><span class="line">export PATH=$PATH:$HADOOP_HOME/bin:$HADOOP_HOME/sbin</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ä½¿é…ç½®æ–‡ä»¶ç”Ÿæ•ˆ</span></span><br><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hadoop version</span><br></pre></td></tr></table></figure><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1667010077535-4ce9cd5c-e0a2-43d2-bf07-b66d2bd4dd60.png" class=""> <h2 id="å•æœºéåˆ†å¸ƒå¼è¿è¡Œ"><a href="#å•æœºéåˆ†å¸ƒå¼è¿è¡Œ" class="headerlink" title="å•æœºéåˆ†å¸ƒå¼è¿è¡Œ"></a>å•æœºéåˆ†å¸ƒå¼è¿è¡Œ</h2><p>ä¸»è¦<strong>ç”¨æ¥è°ƒè¯•æ—¶ä½¿ç”¨</strong></p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è¿›å…¥hadoopçš„å®‰è£…è·¯å¾„</span></span><br><span class="line">cd /home/hadoop/hadoop</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å°†é…ç½®æ–‡ä»¶ä½œä¸ºè¾“å…¥æ–‡ä»¶</span></span><br><span class="line">mkdir ./input</span><br><span class="line">cp ./etc/hadoop/*.xml ./input   </span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">è¿è¡Œ</span></span><br><span class="line">./bin/hadoop jar ./share/hadoop/mapreduce/hadoop-mapreduce-examples-*.jar grep ./input ./output &#x27;dfs[a-z.]+&#x27;</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æŸ¥çœ‹</span></span><br><span class="line">cat ./output/*</span><br><span class="line"></span><br><span class="line">//  rm -rf ./input</span><br><span class="line">//  rm -rf ./input</span><br></pre></td></tr></table></figure><h2 id="ä¼ªåˆ†å¸ƒå¼è¿è¡Œ"><a href="#ä¼ªåˆ†å¸ƒå¼è¿è¡Œ" class="headerlink" title="ä¼ªåˆ†å¸ƒå¼è¿è¡Œ"></a>ä¼ªåˆ†å¸ƒå¼è¿è¡Œ</h2><h3 id="åˆ›å»ºhadoopå­˜æ”¾æ•°æ®çš„ç›®å½•"><a href="#åˆ›å»ºhadoopå­˜æ”¾æ•°æ®çš„ç›®å½•" class="headerlink" title="åˆ›å»ºhadoopå­˜æ”¾æ•°æ®çš„ç›®å½•"></a>åˆ›å»ºhadoopå­˜æ”¾æ•°æ®çš„ç›®å½•</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ‡æ¢è·¯å¾„ hadoopçš„å®‰è£…è·¯å¾„</span></span><br><span class="line"><span class="built_in">cd</span> /home/hadoop/hadoop/</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»º temp è·¯å¾„</span></span><br><span class="line"><span class="built_in">mkdir</span> temp</span><br><span class="line"><span class="comment"># åˆ›å»º dfs è·¯å¾„</span></span><br><span class="line"><span class="built_in">cd</span> temp/</span><br><span class="line"><span class="built_in">mkdir</span> dfs</span><br><span class="line"><span class="comment"># åˆ›å»º name å’Œ data æ–‡ä»¶å¤¹</span></span><br><span class="line"><span class="built_in">cd</span> dfs/</span><br><span class="line"><span class="built_in">mkdir</span> name</span><br><span class="line"><span class="built_in">mkdir</span> data</span><br><span class="line"></span><br><span class="line"><span class="built_in">ls</span></span><br><span class="line">data  name</span><br></pre></td></tr></table></figure><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1663643055647-d3d78508-7abd-4a39-ac98-ad2fb4d27fc1.png" class=""> <h3 id="ä¿®æ”¹é…ç½®æ–‡ä»¶"><a href="#ä¿®æ”¹é…ç½®æ–‡ä»¶" class="headerlink" title="ä¿®æ”¹é…ç½®æ–‡ä»¶"></a>ä¿®æ”¹é…ç½®æ–‡ä»¶</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">hadoop é…ç½®æ–‡ä»¶éƒ½åœ¨hadoop å®‰è£…ç›®å½•ä¸‹çš„ /etc/hadoop ä¸­</span></span><br><span class="line">cd /home/hadoop/hadoop/etc/hadoop</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim hadoop-env.sh</span><br></pre></td></tr></table></figure><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1663588736101-ee11adc3-4272-4fa2-a63d-09206419ae05.png" class=""> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">vim core-site.xml</span><br><span class="line"></span><br><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;?xml-stylesheet type=&quot;text/xsl&quot; href=&quot;configuration.xsl&quot;?&gt;</span><br><span class="line">&lt;configuration&gt;</span><br><span class="line">    &lt;!-- æŒ‡å®š ä½¿ç”¨å“ªç§æ–‡ä»¶ç³»ç»Ÿ--&gt;</span><br><span class="line">    &lt;property&gt;</span><br><span class="line">        &lt;name&gt;fs.defaultFS&lt;/name&gt;</span><br><span class="line">        &lt;!-- ä½¿ç”¨ç³»hdfsåˆ†å¸ƒå¼ç»Ÿ--&gt;</span><br><span class="line">        &lt;!-- hdfsç³»ç»Ÿåœ°å€ hdfs://hdfsé›†ç¾¤ä¸»èŠ‚ç‚¹åç§°:9000(é»˜è®¤ç«¯å£å·)--&gt;</span><br><span class="line">        &lt;!--å› ä¸ºæ˜¯ä¼ªåˆ†å¸ƒå¼,æ‰€æœ‰èŠ‚ç‚¹åœ¨åŒä¸€å°æœºå­ä¸Š,æ•…èŠ‚ç‚¹åç§°ä¸ºä¸»æœºå--&gt;</span><br><span class="line">        &lt;value&gt;hdfs://hadoop:9000&lt;/value&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">    &lt;!-- æŒ‡å®šhadoopè¿›ç¨‹å·¥ä½œç›®å½•,hadoopè¿è¡Œæ—¶äº§ç”Ÿæ–‡ä»¶çš„å­˜å‚¨è·¯å¾„--&gt;</span><br><span class="line">    &lt;property&gt;</span><br><span class="line">        &lt;name&gt;hadoop.tmp.dir&lt;/name&gt;</span><br><span class="line">        &lt;!--æ•°æ®æ”¾åœ¨hadoopçš„å®‰è£…ç›®å½•ä¸‹æ˜¯/tmpä¸‹--&gt;</span><br><span class="line">        &lt;value&gt;/home/hadoop/hadoop/tmp/&lt;/value&gt;</span><br><span class="line">        &lt;description&gt;A base for other temporary directories.&lt;/description&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">    &lt;property&gt;</span><br><span class="line">        &lt;name&gt;hadoop.http.staticuser.user&lt;/name&gt;</span><br><span class="line">        &lt;value&gt;root&lt;/value&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">&lt;/configuration&gt;</span><br></pre></td></tr></table></figure><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1663643912934-f5df4cc6-5ebc-4af5-b93b-fe6c360ac6bd.png" class=""> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">vim hdfs-site.xml</span><br><span class="line"></span><br><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;?xml-stylesheet type=&quot;text/xsl&quot; href=&quot;configuration.xsl&quot;?&gt;</span><br><span class="line">&lt;configuration&gt;</span><br><span class="line">    &lt;property&gt;</span><br><span class="line">        &lt;!--æŒ‡å®šHDFSå‚¨å­˜æ•°æ®çš„å‰¯æœ¬æ•°ç›®ï¼Œé»˜è®¤æƒ…å†µä¸‹ä¸º3ä»½--&gt;</span><br><span class="line">        &lt;name&gt;dfs.replication&lt;/name&gt;</span><br><span class="line">        &lt;value&gt;1&lt;/value&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">    &lt;property&gt;</span><br><span class="line">        &lt;!--name node å­˜æ”¾ name table çš„ç›®å½•--&gt;</span><br><span class="line">        &lt;name&gt;dfs.namenode.name.dir&lt;/name&gt;</span><br><span class="line">        &lt;value&gt;/home/hadoop/hadoop/tmp/dfs/name&lt;/value&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">    &lt;property&gt;</span><br><span class="line">        &lt;!--data node å­˜æ”¾æ•°æ® block çš„ç›®å½•--&gt;</span><br><span class="line">        &lt;name&gt;dfs.datanode.data.dir&lt;/name&gt;</span><br><span class="line">        &lt;value&gt;/home/hadoop/hadoop/tmp/dfs/data&lt;/value&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">    &lt;property&gt;</span><br><span class="line">        &lt;!--è®¾ç½®ç›‘æ§é¡µé¢çš„ç«¯å£åŠåœ°å€--&gt;</span><br><span class="line">        &lt;name&gt;dfs.http.address&lt;/name&gt;</span><br><span class="line">        &lt;value&gt;0.0.0.0:50070&lt;/value&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">&lt;/configuration&gt;</span><br></pre></td></tr></table></figure><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1663643954561-840c2b58-6b0d-4c1f-9826-df75a6868327.png" class=""> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">vim mapred-site.xml</span><br><span class="line"></span><br><span class="line">&lt;?xml version=&quot;1.0&quot;?&gt;</span><br><span class="line">&lt;?xml-stylesheet type=&quot;text/xsl&quot; href=&quot;configuration.xsl&quot;?&gt;</span><br><span class="line">&lt;configuration&gt;</span><br><span class="line">    &lt;!-- é€šçŸ¥æ¡†æ¶mapreduceä½¿ç”¨YARN --&gt;</span><br><span class="line">    &lt;!-- ä½¿å¾—mapreduceåœ¨èµ„æºè°ƒåº¦é›†ç¾¤(yarn)ä¸Šè·‘--&gt;</span><br><span class="line">    &lt;property&gt;</span><br><span class="line">        &lt;name&gt;mapreduce.framework.name&lt;/name&gt;</span><br><span class="line">        &lt;value&gt;yarn&lt;/value&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">&lt;/configuration&gt;</span><br></pre></td></tr></table></figure><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1663643968145-60c65faa-0070-46b0-bb9c-c982462179f1.png" class=""> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">vim yarn-site.xml</span><br><span class="line"></span><br><span class="line">&lt;?xml version=&quot;1.0&quot;?&gt;</span><br><span class="line">&lt;configuration&gt;</span><br><span class="line">    &lt;!-- é…ç½®yarn é›†ç¾¤ä¸»èŠ‚ç‚¹ï¼Œå› ä¸ºæ˜¯ä¼ªåˆ†å¸ƒå¼,æ‰€ä»¥æ˜¯æœ¬æœº--&gt;</span><br><span class="line">    &lt;property&gt;</span><br><span class="line">        &lt;name&gt;yarn.resourcemanager.hostname&lt;/name&gt;</span><br><span class="line">        &lt;value&gt;hadoop&lt;/value&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">    &lt;!-- reducerå–æ•°æ®çš„æ–¹å¼æ˜¯mapreduce_shuffle --&gt;</span><br><span class="line">    &lt;!-- node-manager ä»èŠ‚ç‚¹ --&gt;</span><br><span class="line">    &lt;property&gt;</span><br><span class="line">        &lt;name&gt;yarn.nodemanager.aux-services&lt;/name&gt;</span><br><span class="line">        &lt;value&gt;mapreduce_shuffle&lt;/value&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">&lt;/configuration&gt;</span><br></pre></td></tr></table></figure><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1663643979365-99107655-9c0b-4c81-89eb-4749467a4635.png" class=""> <h3 id="ä¿®æ”¹ç¯å¢ƒå˜é‡"><a href="#ä¿®æ”¹ç¯å¢ƒå˜é‡" class="headerlink" title="ä¿®æ”¹ç¯å¢ƒå˜é‡"></a>ä¿®æ”¹ç¯å¢ƒå˜é‡</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ç¼–è¾‘é…ç½®æ–‡ä»¶</span></span><br><span class="line">vim /etc/profile</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ·»åŠ ç¯å¢ƒå˜é‡</span></span><br><span class="line">export HDFS_NAMENODE_USER=root</span><br><span class="line">export HDFS_DATANODE_USER=root</span><br><span class="line">export HDFS_SECONDARYNAMENODE_USER=root</span><br><span class="line">export YARN_RESOURCEMANAGER_USER=root</span><br><span class="line">export YARN_NODEMANAGER_USER=root</span><br><span class="line"></span><br><span class="line">export HADOOP_COMMON_LIB_NATIVE_DIR=$HADOOP_HOME/lib/native </span><br><span class="line">export HADOOP_OPTS=&quot;-Djava.library.path=$HADOOP_HOME/lib&quot; </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ä½¿é…ç½®æ–‡ä»¶ç”Ÿæ•ˆ</span></span><br><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1663591945147-337ce9f4-f46b-421e-9094-e16e29bc6815.png" class=""> <h3 id="æ ¼å¼åŒ–é›†ç¾¤æ–‡ä»¶ç³»ç»Ÿ"><a href="#æ ¼å¼åŒ–é›†ç¾¤æ–‡ä»¶ç³»ç»Ÿ" class="headerlink" title="æ ¼å¼åŒ–é›†ç¾¤æ–‡ä»¶ç³»ç»Ÿ"></a>æ ¼å¼åŒ–é›†ç¾¤æ–‡ä»¶ç³»ç»Ÿ</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hadoop namenode -format</span><br></pre></td></tr></table></figure><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1663589892367-51dfc120-6ae4-487f-a171-a38e28fac7b5.png" class=""> <h3 id="å¯åŠ¨ä¼ªåˆ†å¸ƒå¼"><a href="#å¯åŠ¨ä¼ªåˆ†å¸ƒå¼" class="headerlink" title="å¯åŠ¨ä¼ªåˆ†å¸ƒå¼"></a>å¯åŠ¨ä¼ªåˆ†å¸ƒå¼</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">start-all.sh</span><br></pre></td></tr></table></figure><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1663643207913-53599cf3-06c0-4445-8c7b-bbdc6500ed7d.png" class=""> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jps</span><br></pre></td></tr></table></figure><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1663643216928-c8bf1643-b2da-46b0-803b-55f3c11de072.png" class=""> <h3 id="Webç®¡ç†ç•Œé¢ï¼ˆå…³é—­é˜²ç«å¢™æˆ–è€…æ”¾è¡Œç«¯å£ï¼‰"><a href="#Webç®¡ç†ç•Œé¢ï¼ˆå…³é—­é˜²ç«å¢™æˆ–è€…æ”¾è¡Œç«¯å£ï¼‰" class="headerlink" title="Webç®¡ç†ç•Œé¢ï¼ˆå…³é—­é˜²ç«å¢™æˆ–è€…æ”¾è¡Œç«¯å£ï¼‰"></a>Webç®¡ç†ç•Œé¢ï¼ˆå…³é—­é˜²ç«å¢™æˆ–è€…æ”¾è¡Œç«¯å£ï¼‰</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://192.168.131.144:50070/</span><br></pre></td></tr></table></figure><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1663643420268-4ba15f66-5fb6-4ff8-9b5d-9c0efa937e3f.png" class=""> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://192.168.131.144:8088</span><br></pre></td></tr></table></figure><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1663643396447-7f745750-2777-436b-ae27-d05d2124a275.png" class=""> <h3 id="å…³é—­ä¼ªåˆ†å¸ƒå¼"><a href="#å…³é—­ä¼ªåˆ†å¸ƒå¼" class="headerlink" title="å…³é—­ä¼ªåˆ†å¸ƒå¼"></a>å…³é—­ä¼ªåˆ†å¸ƒå¼</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stop-all.sh</span><br></pre></td></tr></table></figure><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1663644320334-099a2dcd-8cb0-4687-aec9-d9ec2e5e7e0c.png" class=""> <h1 id="åˆ†å¸ƒå¼å®‰è£…-é€‰ä½œ"><a href="#åˆ†å¸ƒå¼å®‰è£…-é€‰ä½œ" class="headerlink" title="åˆ†å¸ƒå¼å®‰è£…(é€‰ä½œ)"></a>åˆ†å¸ƒå¼å®‰è£…(é€‰ä½œ)</h1><h2 id="è™šæœºåˆ†é…"><a href="#è™šæœºåˆ†é…" class="headerlink" title="è™šæœºåˆ†é…"></a>è™šæœºåˆ†é…</h2><table><thead><tr><th></th><th>hadoop1:192.168.131.145</th><th>hadoop2:192.168.131.146</th><th>hadoop3:192.168.131.147</th></tr></thead><tbody><tr><td>HDFS</td><td>NameNode<br />DataNode</td><td>DataNode</td><td>SecondaryNameNode<br />DataNode</td></tr><tr><td>YARN</td><td>NodeManager</td><td>ResourceManager<br />NodeManager</td><td>NodeManager</td></tr></tbody></table><p>å…‹éš†3å°è™šæ‹Ÿæœºä¿®æ”¹é™æ€IPè¿›è¡Œæ“ä½œ</p><h2 id="å‡†å¤‡å·¥ä½œ"><a href="#å‡†å¤‡å·¥ä½œ" class="headerlink" title="å‡†å¤‡å·¥ä½œ"></a>å‡†å¤‡å·¥ä½œ</h2><h3 id="å…³é—­é˜²ç«å¢™-3å°"><a href="#å…³é—­é˜²ç«å¢™-3å°" class="headerlink" title="å…³é—­é˜²ç«å¢™(3å°)"></a>å…³é—­é˜²ç«å¢™(3å°)</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å…³é—­</span></span><br><span class="line">systemctl stop firewalld</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ç¦æ­¢å¼€æœºè‡ªå¯</span></span><br><span class="line">systemctl disable firewalld</span><br></pre></td></tr></table></figure><h3 id="ä¿®æ”¹ä¸»æœºåç§°å’Œä¿®æ”¹æ˜ å°„-3å°"><a href="#ä¿®æ”¹ä¸»æœºåç§°å’Œä¿®æ”¹æ˜ å°„-3å°" class="headerlink" title="ä¿®æ”¹ä¸»æœºåç§°å’Œä¿®æ”¹æ˜ å°„(3å°)"></a>ä¿®æ”¹ä¸»æœºåç§°å’Œä¿®æ”¹æ˜ å°„(3å°)</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ä¿®æ”¹ä¸»æœºåç§°</span></span><br><span class="line">hostnamectl set-hostname hadoop1</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ·»åŠ æ˜ å°„</span></span><br><span class="line">vim /etc/hosts</span><br><span class="line">192.168.131.145 hadoop1</span><br><span class="line">192.168.131.146 hadoop2</span><br><span class="line">192.168.131.147 hadoop3</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ä¿®æ”¹ä¸»æœºåç§°</span></span><br><span class="line">hostnamectl set-hostname hadoop2</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ·»åŠ æ˜ å°„</span></span><br><span class="line">vim /etc/hosts</span><br><span class="line">192.168.131.145 hadoop1</span><br><span class="line">192.168.131.146 hadoop2</span><br><span class="line">192.168.131.147 hadoop3</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ä¿®æ”¹ä¸»æœºåç§°</span></span><br><span class="line">hostnamectl set-hostname hadoop3</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ·»åŠ æ˜ å°„</span></span><br><span class="line">vim /etc/hosts</span><br><span class="line">192.168.131.145 hadoop1</span><br><span class="line">192.168.131.146 hadoop2</span><br><span class="line">192.168.131.147 hadoop3</span><br></pre></td></tr></table></figure><h3 id="è®¾ç½®SSHå…å¯†ç™»é™†-3å°"><a href="#è®¾ç½®SSHå…å¯†ç™»é™†-3å°" class="headerlink" title="è®¾ç½®SSHå…å¯†ç™»é™†(3å°)"></a>è®¾ç½®SSHå…å¯†ç™»é™†(3å°)</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">3æ¬¡å›è½¦</span></span><br><span class="line">ssh-keygen -t rsa</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ç§é’¥å’Œå…¬é’¥ /root/.ssh é‡Œ</span></span><br><span class="line">cd /root/.ssh</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">åˆ›å»ºä¸€ä¸ªåä¸º authorized_keys çš„æ–‡ä»¶</span></span><br><span class="line">touch authorized_keys</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å°†å…¬é’¥å†™è¿›è¿™ä¸ªæ–‡ä»¶</span></span><br><span class="line">cat id_rsa.pub &gt;&gt; authorized_keys   # è¯¥æ–‡ä»¶å½“å‰åªå­˜è´®äº†æœ¬æœºçš„å…¬é’¥ç§é’¥</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">3å°ä¸»æœºçš„å…¨éƒ¨å…¬é’¥ç§é’¥åœ¨3å°æœºå™¨ä¸Šå…¨éƒ¨å­˜å‚¨(ç²—æš´å¤åˆ¶)</span></span><br><span class="line"></span><br><span class="line">ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDkJjZnDNzV+m87Ox6RanAJW4Wl3ZXHJSumNcoXitLTew9NMWmliK7nl87iWOP7iAuqIwgv0mowaO9J8wDUjCqhv2gQymNDR+tKcX1DNIgrR8xdO2jHjmi2NsyihoMgVUbs27mFaznPiJprSEEznE9GZgoQ5C27QKxG2f03p1dWiPJHNfcf4EJO1V/2YI+u1hprKkoZFoZr7q6c5fTJkRSn6BBFXKHQOeQTTdrbeJA4zdUO/Rb/0jWTuhUFU52hfgQtzmEhDKiE2N19eG78p7QLvY4clcaYDg9m1p8I9HeXVMAp7pg+d3NadksXlzWEbyF5BTc3wHYXhC0bv6yhplI5 root@hadoop1</span><br><span class="line">ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDs02adR7MDyNeVwarqoKlyNIfZjUHi8zgZjzbVTattM9GwvF/FC0rRzjOYjexpjpyA0IVOm5ililEwMX8yjJhhx7h004OKdl39O642dtr8Pnf/SEy8cLPilnGO0n3lXIXzpqekTHQ3czlE3X9UDfG1BcYJcOIkD4ltlAXkS7bnosqoN/Eu82Dec1AsyjCITWayAQcC0fMsTlKKWgh8sBaXIjdYwrAh9WbZjyatYnWnTBxtqDXhZhDHc9QdWaq0pYtrMGQ7ZZ2weqfKDY9+7wEwBgkg7SmJhkwtVDiuO8Xef9geFmnHzKrpTCel+J3EfwHYOV0yMWAvZ2TFo271ogk3 root@hadoop2</span><br><span class="line">ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDpZFNA4qlYVrPcVIULo41h6y8qr2EJW7xj4JM9K3kLqFZ1tQw2voN9VA91GlOwKI1lvCVWyuwnkQaWLXHN3M56Jdpw9pupNt3LAXjEmLl+8Ze1vfbgv7DoVS9yJyJQn8V/AKZE3xl/AftrY8anMtYAIujwEn1M5Fra4ozLTfRRmB0Duax/Qgi2xCHaq90YldKcwI4pZ2nz1y9ffwhLR1wKQUJBGyhVIshw8a/vkrnjNGcUwa7fe55SelOEl5bSOgcTGeXHaQufGmnHslwrc91Qzd+W2peaF2ChDCoob+wIqJq7liqMeZw6go/IN+VSWkF4EXwKu4RPaY+bHj9EUlT9 root@hadoop3</span><br></pre></td></tr></table></figure><h3 id="å®‰è£…JDKå¹¶é…ç½®ç¯å¢ƒå˜é‡-3å°"><a href="#å®‰è£…JDKå¹¶é…ç½®ç¯å¢ƒå˜é‡-3å°" class="headerlink" title="å®‰è£…JDKå¹¶é…ç½®ç¯å¢ƒå˜é‡(3å°)"></a>å®‰è£…JDKå¹¶é…ç½®ç¯å¢ƒå˜é‡(3å°)</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ä¸Šä¼ è‡³æœåŠ¡å™¨å¹¶ä¸”è§£å‹æ›´æ”¹åç§°</span></span><br><span class="line">tar -xvzf jdk-8u333-linux-i586.tar.gz </span><br><span class="line">mv jdk1.8.0_333 jdk8</span><br><span class="line">rm -rf jdk-8u333-linux-i586.tar.gz</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ç¼–è¾‘é…ç½®æ–‡ä»¶</span></span><br><span class="line">vim /etc/profile</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">è®¾ç½®jdkç¯å¢ƒå˜é‡</span></span><br><span class="line">export JAVA_HOME=/opt/jdk8  #jdkå®‰è£…ç›®å½•</span><br><span class="line">export JRE_HOME=$&#123;JAVA_HOME&#125;/jre</span><br><span class="line">export CLASSPATH=.:$&#123;JAVA_HOME&#125;/lib:$&#123;JRE_HOME&#125;/lib:$CLASSPATH</span><br><span class="line">export JAVA_PATH=$&#123;JAVA_HOME&#125;/bin:$&#123;JRE_HOME&#125;/bin</span><br><span class="line">export PATH=$PATH:$&#123;JAVA_PATH&#125;</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ä½¿é…ç½®æ–‡ä»¶ç”Ÿæ•ˆ</span></span><br><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ£€æŸ¥æ˜¯å¦å®‰è£…æˆåŠŸ</span></span><br><span class="line">java -version</span><br></pre></td></tr></table></figure><h3 id="å®‰è£…Hadoopå¹¶é…ç½®ç¯å¢ƒå˜é‡-3å°"><a href="#å®‰è£…Hadoopå¹¶é…ç½®ç¯å¢ƒå˜é‡-3å°" class="headerlink" title="å®‰è£…Hadoopå¹¶é…ç½®ç¯å¢ƒå˜é‡(3å°)"></a>å®‰è£…Hadoopå¹¶é…ç½®ç¯å¢ƒå˜é‡(3å°)</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ä¸Šä¼ è‡³æœåŠ¡å™¨å¹¶ä¸”è§£å‹æ›´æ”¹åç§°</span></span><br><span class="line">tar -zxvf hadoop-3.1.3.tar.gz</span><br><span class="line">mv hadoop-3.1.3 hadoop</span><br><span class="line">rm -rf hadoop-3.1.3.tar.gz</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æŸ¥çœ‹æ˜¯å¦å¯ç”¨</span></span><br><span class="line">/opt/hadoop/bin/hadoop version</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ç¼–è¾‘profileæ–‡ä»¶</span></span><br><span class="line">vim /etc/profile</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">å¢åŠ hadoopç¯å¢ƒå˜é‡</span></span><br><span class="line">export HADOOP_HOME=/opt/hadoop</span><br><span class="line">export PATH=$PATH:$HADOOP_HOME/bin:$HADOOP_HOME/sbin</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ä½¿é…ç½®æ–‡ä»¶ç”Ÿæ•ˆ</span></span><br><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hadoop version</span><br></pre></td></tr></table></figure><h2 id="ä¿®æ”¹ç¯å¢ƒå˜é‡-3å°"><a href="#ä¿®æ”¹ç¯å¢ƒå˜é‡-3å°" class="headerlink" title="ä¿®æ”¹ç¯å¢ƒå˜é‡(3å°)"></a>ä¿®æ”¹ç¯å¢ƒå˜é‡(3å°)</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ç¼–è¾‘é…ç½®æ–‡ä»¶</span></span><br><span class="line">vim /etc/profile</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">æ·»åŠ ç¯å¢ƒå˜é‡</span></span><br><span class="line">export HDFS_NAMENODE_USER=root</span><br><span class="line">export HDFS_DATANODE_USER=root</span><br><span class="line">export HDFS_SECONDARYNAMENODE_USER=root</span><br><span class="line">export YARN_RESOURCEMANAGER_USER=root</span><br><span class="line">export YARN_NODEMANAGER_USER=root</span><br><span class="line"></span><br><span class="line">export HADOOP_COMMON_LIB_NATIVE_DIR=$HADOOP_HOME/lib/native </span><br><span class="line">export HADOOP_OPTS=&quot;-Djava.library.path=$HADOOP_HOME/lib&quot; </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ä½¿é…ç½®æ–‡ä»¶ç”Ÿæ•ˆ</span></span><br><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure><h2 id="ä¿®æ”¹é…ç½®æ–‡ä»¶-3å°"><a href="#ä¿®æ”¹é…ç½®æ–‡ä»¶-3å°" class="headerlink" title="ä¿®æ”¹é…ç½®æ–‡ä»¶(3å°)"></a>ä¿®æ”¹é…ç½®æ–‡ä»¶(3å°)</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">hadoop é…ç½®æ–‡ä»¶éƒ½åœ¨hadoop å®‰è£…ç›®å½•ä¸‹çš„ /etc/hadoop ä¸­</span></span><br><span class="line">cd /opt/hadoop/etc/hadoop</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">vim hadoop-env.sh</span><br><span class="line"></span><br><span class="line">export JAVA_HOME=/opt/jdk8</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">vim core-site.xml</span><br><span class="line"></span><br><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;?xml-stylesheet type=&quot;text/xsl&quot; href=&quot;configuration.xsl&quot;?&gt;</span><br><span class="line">&lt;configuration&gt;</span><br><span class="line">    &lt;!--æŒ‡å®šnamenodeçš„åœ°å€--&gt;</span><br><span class="line">    &lt;property&gt;</span><br><span class="line">        &lt;name&gt;fs.defaultFS&lt;/name&gt;</span><br><span class="line">        &lt;value&gt;hdfs://hadoop1:8020&lt;/value&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">    &lt;!-- æŒ‡å®š Hadoop è¿è¡Œæ—¶äº§ç”Ÿæ–‡ä»¶çš„å­˜å‚¨ç›®å½• --&gt;</span><br><span class="line">    &lt;property&gt;</span><br><span class="line">        &lt;name&gt;hadoop.tmp.dir&lt;/name&gt;</span><br><span class="line">        &lt;value&gt;/opt/hadoop/data&lt;/value&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">&lt;/configuration&gt;</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">vim hdfs-site.xml</span><br><span class="line"></span><br><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;?xml-stylesheet type=&quot;text/xsl&quot; href=&quot;configuration.xsl&quot;?&gt;</span><br><span class="line">&lt;configuration&gt;</span><br><span class="line">    &lt;!--nn webç«¯è®¿é—®åœ°å€--&gt;</span><br><span class="line">    &lt;property&gt;</span><br><span class="line">        &lt;name&gt;dfs.namenode.http-address&lt;/name&gt;</span><br><span class="line">        &lt;value&gt;hadoop1:9870&lt;/value&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">    &lt;!-- 2nn webç«¯è®¿é—®åœ°å€ --&gt;</span><br><span class="line">    &lt;property&gt;</span><br><span class="line">        &lt;name&gt;dfs.namenode.secondary.http-address&lt;/name&gt;</span><br><span class="line">        &lt;value&gt;hadoop3:9868&lt;/value&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">&lt;/configuration&gt;</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">vim yarn-site.xml</span><br><span class="line"></span><br><span class="line">&lt;?xml version=&quot;1.0&quot;?&gt;</span><br><span class="line">&lt;configuration&gt;</span><br><span class="line">    &lt;!-- æŒ‡å®š MR èµ°shuffle --&gt;</span><br><span class="line">    &lt;property&gt;</span><br><span class="line">        &lt;name&gt;yarn.nodemanager.aux-services&lt;/name&gt;</span><br><span class="line">        &lt;value&gt;mapreduce_shuffle&lt;/value&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">    &lt;!-- æŒ‡å®š YARN çš„ ResourceManager çš„åœ°å€ --&gt;</span><br><span class="line">    &lt;property&gt;</span><br><span class="line">        &lt;name&gt;yarn.resourcemanager.hostname&lt;/name&gt;</span><br><span class="line">        &lt;value&gt;hadoop2&lt;/value&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">&lt;/configuration&gt;</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">vim mapred-site.xml</span><br><span class="line"></span><br><span class="line">&lt;?xml version=&quot;1.0&quot;?&gt;</span><br><span class="line">&lt;?xml-stylesheet type=&quot;text/xsl&quot; href=&quot;configuration.xsl&quot;?&gt;</span><br><span class="line">&lt;configuration&gt;</span><br><span class="line">    &lt;!-- æŒ‡å®š MR è¿è¡Œåœ¨ Yarn ä¸Š --&gt;</span><br><span class="line">    &lt;property&gt;</span><br><span class="line">        &lt;name&gt;mapreduce.framework.name&lt;/name&gt;</span><br><span class="line">        &lt;value&gt;yarn&lt;/value&gt;</span><br><span class="line">    &lt;/property&gt;</span><br><span class="line">&lt;/configuration&gt;</span><br></pre></td></tr></table></figure><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vim workers</span><br><span class="line"></span><br><span class="line">hadoop1</span><br><span class="line">hadoop2</span><br><span class="line">hadoop3</span><br></pre></td></tr></table></figure><h2 id="æ ¼å¼åŒ–é›†ç¾¤æ–‡ä»¶ç³»ç»Ÿ-3å°"><a href="#æ ¼å¼åŒ–é›†ç¾¤æ–‡ä»¶ç³»ç»Ÿ-3å°" class="headerlink" title="æ ¼å¼åŒ–é›†ç¾¤æ–‡ä»¶ç³»ç»Ÿ(3å°)"></a>æ ¼å¼åŒ–é›†ç¾¤æ–‡ä»¶ç³»ç»Ÿ(3å°)</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hdfs namenode -format</span><br></pre></td></tr></table></figure><h2 id="å¯åŠ¨åˆ†å¸ƒå¼é›†ç¾¤-3å°"><a href="#å¯åŠ¨åˆ†å¸ƒå¼é›†ç¾¤-3å°" class="headerlink" title="å¯åŠ¨åˆ†å¸ƒå¼é›†ç¾¤(3å°)"></a>å¯åŠ¨åˆ†å¸ƒå¼é›†ç¾¤(3å°)</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">start-all.sh</span><br><span class="line">jps   # æŸ¥çœ‹è¿›ç¨‹</span><br></pre></td></tr></table></figure><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1663667031629-0ff30139-f400-47bf-ac71-39e25f3ea064.png" class=""> <h2 id="Webç®¡ç†ç•Œé¢ï¼ˆå…³é—­é˜²ç«å¢™æˆ–è€…æ”¾è¡Œç«¯å£ï¼‰-1"><a href="#Webç®¡ç†ç•Œé¢ï¼ˆå…³é—­é˜²ç«å¢™æˆ–è€…æ”¾è¡Œç«¯å£ï¼‰-1" class="headerlink" title="Webç®¡ç†ç•Œé¢ï¼ˆå…³é—­é˜²ç«å¢™æˆ–è€…æ”¾è¡Œç«¯å£ï¼‰"></a>Webç®¡ç†ç•Œé¢ï¼ˆå…³é—­é˜²ç«å¢™æˆ–è€…æ”¾è¡Œç«¯å£ï¼‰</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hadoop1çš„IP NameNode</span><br><span class="line">http://192.168.131.145:9870</span><br></pre></td></tr></table></figure><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1663667968980-4500cc37-383b-4b43-b3ad-e688914d9e48.png" class=""> <figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hadoop2çš„IP ResourceManager</span><br><span class="line">http://192.168.131.146:8088</span><br></pre></td></tr></table></figure><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1663668001933-91605b47-88b7-4104-ac16-4feb8b525aa4.png" class=""> <h2 id="å…³é—­åˆ†å¸ƒå¼é›†ç¾¤-3å°"><a href="#å…³é—­åˆ†å¸ƒå¼é›†ç¾¤-3å°" class="headerlink" title="å…³é—­åˆ†å¸ƒå¼é›†ç¾¤(3å°)"></a>å…³é—­åˆ†å¸ƒå¼é›†ç¾¤(3å°)</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">stop-all.sh</span><br></pre></td></tr></table></figure><h1 id="æ–‡ä»¶çš„æ“ä½œç»¼åˆåº”ç”¨"><a href="#æ–‡ä»¶çš„æ“ä½œç»¼åˆåº”ç”¨" class="headerlink" title="æ–‡ä»¶çš„æ“ä½œç»¼åˆåº”ç”¨"></a>æ–‡ä»¶çš„æ“ä½œç»¼åˆåº”ç”¨</h1><h2 id="å‘½ä»¤è¡Œæ“ä½œ"><a href="#å‘½ä»¤è¡Œæ“ä½œ" class="headerlink" title="å‘½ä»¤è¡Œæ“ä½œ"></a>å‘½ä»¤è¡Œæ“ä½œ</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ—å‡ºHDFSæ–‡ä»¶</span></span><br><span class="line">hadoop fs -<span class="built_in">ls</span> æ–‡ä»¶å¤¹çš„è·¯å¾„ </span><br><span class="line">hadoop fs -<span class="built_in">ls</span> /</span><br></pre></td></tr></table></figure><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1664439577142-d9498b98-34c7-49f8-bb3e-080eef05818c.png" class=""> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åœ¨HDFSä¸­åˆ›å»ºæ–‡ä»¶å¤¹</span></span><br><span class="line">hadoop fs -<span class="built_in">mkdir</span> æ–‡ä»¶å¤¹å   </span><br><span class="line">hadoop fs -<span class="built_in">mkdir</span> /testmkdir</span><br></pre></td></tr></table></figure><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1664439464457-a5459725-9b01-49e0-8334-29b4ba1aab06.png" class=""> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ é™¤HDFSä¸­çš„æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹</span></span><br><span class="line">hadoop fs -<span class="built_in">rm</span> -r æ–‡ä»¶å¤¹å/æ–‡ä»¶å</span><br><span class="line">hadoop fs -<span class="built_in">rm</span> -r /testmkdir  </span><br></pre></td></tr></table></figure><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1664439596814-da571959-f0aa-461c-87f7-1735c712b427.png" class=""> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¸Šä¼ æ–‡ä»¶åˆ°HDFS</span></span><br><span class="line">hadoop fs â€“put ~/file /   ======&gt; ~/file:æœ¬åœ°æ–‡ä»¶ /:HDFSæ–‡ä»¶è·¯å¾„</span><br><span class="line">hadoop fs -put t.c    /</span><br></pre></td></tr></table></figure><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1664441108215-1f3ab21c-bd81-4d74-9498-c91671922ff4.png" class=""> <img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1664441141955-7618e4fc-f47d-44e2-9b28-17ccd856f2bd.png" class=""> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹HDFSä¸‹çš„æŸä¸ªæ–‡ä»¶</span></span><br><span class="line">hadoop fs â€“<span class="built_in">cat</span> æ–‡ä»¶è·¯å¾„</span><br><span class="line">hadoop fs -<span class="built_in">cat</span> /t.c</span><br></pre></td></tr></table></figure><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1664441125309-a3d00af8-9701-462a-a1db-4a0415641c6f.png" class=""> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å°†HDFSä¸­çš„æ–‡ä»¶å¤åˆ¶åˆ°æœ¬åœ°ç³»ç»Ÿä¸­</span></span><br><span class="line">hadoop fs -get  HDFSä¸­çš„æ–‡ä»¶åæœ¬åœ°ç³»ç»Ÿä¸­çš„æ–‡ä»¶å æœ¬åœ°å­˜æ”¾åœ°å€</span><br><span class="line">hadoop fs -get /t.c /</span><br></pre></td></tr></table></figure><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1664441331730-5c0a7863-bb3e-487c-ac0f-93aec9294ad9.png" class=""> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¿®æ”¹HDFSä¸­çš„æ–‡ä»¶å’Œæ–‡ä»¶å¤¹çš„åç§°</span></span><br><span class="line">hadoop fs  -<span class="built_in">mv</span> /åŸHDFSä¸­çš„æ–‡ä»¶å  /ä¿®æ”¹åçš„HDFSä¸­çš„æ–‡ä»¶å</span><br><span class="line">hadoop fs  -<span class="built_in">mv</span> /t.c  /t1.c</span><br></pre></td></tr></table></figure><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1664441529518-4edc7cf8-e282-4054-bd55-94813c4cd57d.png" class=""> <h2 id="HDFS-APIç¼–ç¨‹"><a href="#HDFS-APIç¼–ç¨‹" class="headerlink" title="HDFS APIç¼–ç¨‹"></a>HDFS APIç¼–ç¨‹</h2><p>ä»£ç é“¾æ¥ <a href="https://github.com/pepsi-wyl/HDFS_API">https://github.com/pepsi-wyl/HDFS_API</a><br><strong>BUG</strong> <a href="https://www.panziye.com/java/3041.html">è§£å†³java.io.FileNotFoundException: java.io.FileNotFoundException: HADOOP_HOME and hadoop.home.dir are unset</a></p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.hadoop<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hadoop-common<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.hadoop<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hadoop-hdfs<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.hadoop<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hadoop-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HDFSUtils</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·å–Configuration</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Configuration <span class="title function_">getConfiguration</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">Configuration</span> <span class="variable">configuration</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Configuration</span>();</span><br><span class="line">        <span class="comment">// è¿™é‡ŒæŒ‡å®šä½¿ç”¨çš„æ˜¯HDFSæ–‡ä»¶ç³»ç»Ÿ</span></span><br><span class="line">        configuration.set(<span class="string">&quot;fs.defaultFS&quot;</span>, <span class="string">&quot;hdfs://192.168.131.144:9000&quot;</span>);</span><br><span class="line">        configuration.set(<span class="string">&quot;fs.hdfs.impl&quot;</span>, <span class="string">&quot;org.apache.hadoop.hdfs.DistributedFileSystem&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> configuration;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·å–FileSystem</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> FileSystem <span class="title function_">getFileSystem</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">// é€šè¿‡å¦‚ä¸‹çš„æ–¹å¼è¿›è¡Œå®¢æˆ·ç«¯èº«ä»½çš„è®¾ç½®</span></span><br><span class="line">        System.setProperty(<span class="string">&quot;HADOOP_USER_NAME&quot;</span>, <span class="string">&quot;root&quot;</span>);</span><br><span class="line">        <span class="comment">// é€šè¿‡FileSystemçš„é™æ€æ–¹æ³•è·å–æ–‡ä»¶ç³»ç»Ÿå®¢æˆ·ç«¯å¯¹è±¡</span></span><br><span class="line">        <span class="type">FileSystem</span> <span class="variable">fileSystem</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">return</span> FileSystem.get(getConfiguration());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å…³é—­FileSystem</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">closeFileSystem</span><span class="params">(FileSystem fileSystem)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        fileSystem.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ—å‡ºHDFSæ–‡ä»¶</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ListFiles</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">FileSystem</span> <span class="variable">fileSystem</span> <span class="operator">=</span> HDFSUtils.getFileSystem();</span><br><span class="line">        FileStatus[] statuses = fileSystem.listStatus(<span class="keyword">new</span> <span class="title class_">Path</span>(<span class="string">&quot;/&quot;</span>));</span><br><span class="line">        <span class="keyword">for</span> (FileStatus fileStatus : statuses) &#123;</span><br><span class="line">            <span class="comment">// fileStatusä¸ºæ–‡ä»¶çŠ¶æ€å­˜å‚¨æ–‡ä»¶çš„ä¿¡æ¯</span></span><br><span class="line">            System.out.println(fileStatus.getPath());</span><br><span class="line">        &#125;</span><br><span class="line">        HDFSUtils.closeFileSystem(fileSystem);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1664453706943-25cbbc50-0d83-482a-98d6-153e074d89bb.png" class=""> <img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1664453722783-03cf448d-fd95-47b2-a83f-a7a49285d3ab.png" class=""> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ›å»ºæ–‡ä»¶å¤¹</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Mkdir</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">FileSystem</span> <span class="variable">fileSystem</span> <span class="operator">=</span> HDFSUtils.getFileSystem();</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isOK</span> <span class="operator">=</span> fileSystem.mkdirs(<span class="keyword">new</span> <span class="title class_">Path</span>(<span class="string">&quot;/javaAPI/&quot;</span>));</span><br><span class="line">        <span class="keyword">if</span> (isOK)</span><br><span class="line">            System.out.printf(<span class="string">&quot;åˆ›å»ºæ–‡ä»¶å¤¹æˆåŠŸ&quot;</span>);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            System.out.printf(<span class="string">&quot;åˆ›å»ºæ–‡ä»¶å¤¹å¤±è´¥&quot;</span>);</span><br><span class="line">        HDFSUtils.closeFileSystem(fileSystem);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1664453752647-e7d58730-b024-4a07-b26c-c68de5b1cf63.png" class=""> <img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1664453772003-bcdd4904-5a91-4018-9ab3-83394f68416d.png" class=""> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ é™¤æ–‡ä»¶å¤¹</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Rmdir</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">FileSystem</span> <span class="variable">fileSystem</span> <span class="operator">=</span> HDFSUtils.getFileSystem();</span><br><span class="line">        <span class="comment">// trueä¸ºé€’å½’åˆ é™¤ falseå•çº§ç›®å½•åˆ é™¤</span></span><br><span class="line">        <span class="type">boolean</span> <span class="variable">isOK</span> <span class="operator">=</span> fileSystem.delete(<span class="keyword">new</span> <span class="title class_">Path</span>(<span class="string">&quot;/javaAPI/&quot;</span>), <span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">if</span> (isOK)</span><br><span class="line">            System.out.printf(<span class="string">&quot;åˆ é™¤æ–‡ä»¶å¤¹æˆåŠŸ&quot;</span>);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            System.out.printf(<span class="string">&quot;åˆ é™¤æ–‡ä»¶å¤¹å¤±è´¥&quot;</span>);</span><br><span class="line">        HDFSUtils.closeFileSystem(fileSystem);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1664453808865-e57580cb-44de-4479-9a5f-a535961df6ce.png" class=""> <img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1664453816837-7649d9aa-6653-454a-a5e2-ced6b240db59.png" class=""> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¸Šä¼ æ–‡ä»¶</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Upload</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">FileSystem</span> <span class="variable">fileSystem</span> <span class="operator">=</span> HDFSUtils.getFileSystem();</span><br><span class="line">        <span class="type">Path</span> <span class="variable">localFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Path</span>(<span class="string">&quot;G:\\Coding\\java\\HDFS_API\\src\\main\\java\\Utils\\HDFSUtils.java&quot;</span>);</span><br><span class="line">        <span class="type">Path</span> <span class="variable">remoteFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Path</span>(<span class="string">&quot;/&quot;</span>);</span><br><span class="line">        fileSystem.copyFromLocalFile(localFile, remoteFile);</span><br><span class="line">        System.out.println(<span class="string">&quot;ä¸Šä¼ æ–‡ä»¶æˆåŠŸ&quot;</span>);</span><br><span class="line">        HDFSUtils.closeFileSystem(fileSystem);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1664453849662-5a8b9565-7d29-4600-aaee-c5e45e54d7e1.png" class=""> <img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1664453864273-a459eb28-e3d5-46fb-894f-88f04602d34b.png" class=""> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¸‹è½½æ–‡ä»¶</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Download</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">FileSystem</span> <span class="variable">fileSystem</span> <span class="operator">=</span> HDFSUtils.getFileSystem();</span><br><span class="line">        <span class="type">Path</span> <span class="variable">remoteFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Path</span>(<span class="string">&quot;/HDFSUtils.java&quot;</span>);</span><br><span class="line">        <span class="type">Path</span> <span class="variable">localFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Path</span>(<span class="string">&quot;G:\\Coding\\java\\HDFS_API\\src&quot;</span>);</span><br><span class="line">        fileSystem.copyToLocalFile(remoteFile, localFile);</span><br><span class="line">        System.out.println(<span class="string">&quot;ä¸‹è½½æ–‡ä»¶æˆåŠŸ&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1664453912255-7d72dad3-3c10-4ae8-b450-8cf2549a530a.png" class=""> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¿®æ”¹HDFSä¸­çš„æ–‡ä»¶å’Œæ–‡ä»¶å¤¹çš„åç§°</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RenameFile</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">FileSystem</span> <span class="variable">fileSystem</span> <span class="operator">=</span> HDFSUtils.getFileSystem();</span><br><span class="line">        <span class="type">Path</span> <span class="variable">oldPath</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Path</span>(<span class="string">&quot;/HDFSUtils.java&quot;</span>);</span><br><span class="line">        <span class="type">Path</span> <span class="variable">newPath</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Path</span>(<span class="string">&quot;/HDFSUtils_rename.java&quot;</span>);</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">rename</span> <span class="operator">=</span> fileSystem.rename(oldPath, newPath);</span><br><span class="line">        <span class="keyword">if</span> (rename)</span><br><span class="line">            System.out.println(<span class="string">&quot;é‡å‘½åæˆåŠŸ&quot;</span>);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            System.out.println(<span class="string">&quot;é‡å‘½åå¤±è´¥&quot;</span>);</span><br><span class="line">        HDFSUtils.closeFileSystem(fileSystem);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1664453938659-7ba44c6a-ba0e-4000-a259-ffb686379cfa.png" class=""> <img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1664453949575-697dd0a1-37e2-4c9a-bba1-b935355cacd4.png" class=""> <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æŸ¥çœ‹HDFSä¸­çš„æ–‡ä»¶</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CatFile</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">FileSystem</span> <span class="variable">fileSystem</span> <span class="operator">=</span> HDFSUtils.getFileSystem();</span><br><span class="line">        <span class="type">FSDataInputStream</span> <span class="variable">in</span> <span class="operator">=</span> fileSystem.open(<span class="keyword">new</span> <span class="title class_">Path</span>(<span class="string">&quot;/HDFSUtils.java&quot;</span>));</span><br><span class="line">        IOUtils.copyBytes(in, System.out, <span class="number">1024</span>);</span><br><span class="line">        HDFSUtils.closeFileSystem(fileSystem);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1664454028601-33defa24-bffb-4e5c-aaad-e0af4a0e089c.png" class=""> <h1 id="MapReduceåŸºç¡€ç¼–ç¨‹"><a href="#MapReduceåŸºç¡€ç¼–ç¨‹" class="headerlink" title="MapReduceåŸºç¡€ç¼–ç¨‹"></a>MapReduceåŸºç¡€ç¼–ç¨‹</h1><h2 id="ä½¿ç”¨å‘½ä»¤è¡Œç¼–è¯‘æ‰“åŒ…è¯é¢‘ç»Ÿè®¡ç¨‹åº"><a href="#ä½¿ç”¨å‘½ä»¤è¡Œç¼–è¯‘æ‰“åŒ…è¯é¢‘ç»Ÿè®¡ç¨‹åº" class="headerlink" title="ä½¿ç”¨å‘½ä»¤è¡Œç¼–è¯‘æ‰“åŒ…è¯é¢‘ç»Ÿè®¡ç¨‹åº"></a>ä½¿ç”¨å‘½ä»¤è¡Œç¼–è¯‘æ‰“åŒ…è¯é¢‘ç»Ÿè®¡ç¨‹åº</h2><h3 id="HDFSä¸­åˆ›å»ºæ–‡ä»¶"><a href="#HDFSä¸­åˆ›å»ºæ–‡ä»¶" class="headerlink" title="HDFSä¸­åˆ›å»ºæ–‡ä»¶"></a>HDFSä¸­åˆ›å»ºæ–‡ä»¶</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">wordfile1.txt   </span><br><span class="line">I love Spark</span><br><span class="line">I love Hadoop</span><br><span class="line"></span><br><span class="line">wordfile2.txt.txt    </span><br><span class="line">Hadoop is good</span><br><span class="line">Spark is fast</span><br></pre></td></tr></table></figure><p><strong>ä¸Šä¼ åˆ°HDFSä¸­</strong></p><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1666086361148-02133ef3-7ce4-4be8-baec-3064ab246f96.png" class=""> <h3 id="ç¼–å†™æºæ–‡ä»¶"><a href="#ç¼–å†™æºæ–‡ä»¶" class="headerlink" title="ç¼–å†™æºæ–‡ä»¶"></a>ç¼–å†™æºæ–‡ä»¶</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æºæ–‡ä»¶ç¼–å†™åœ¨hadoopçš„å®‰è£…è·¯å¾„ä¸‹</span></span><br><span class="line"><span class="built_in">cd</span> /home/hadoop/hadoop</span><br><span class="line"></span><br><span class="line">vim WordCount.java</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.StringTokenizer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.conf.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.fs.Path;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.IntWritable;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.Text;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Job;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Mapper;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Reducer;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.input.FileInputFormat;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.output.FileOutputFormat;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.util.GenericOptionsParser;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> by pepsi-wyl</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022-10-18 16:44</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WordCount</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">WordCount</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Configuration</span> <span class="variable">conf</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Configuration</span>();</span><br><span class="line">        String[] otherArgs = (<span class="keyword">new</span> <span class="title class_">GenericOptionsParser</span>(conf, args)).getRemainingArgs();</span><br><span class="line">        <span class="keyword">if</span> (otherArgs.length &lt; <span class="number">2</span>) &#123;</span><br><span class="line">            System.err.println(<span class="string">&quot;Usage: wordcount &lt;in&gt; [&lt;in&gt;...] &lt;out&gt;&quot;</span>);</span><br><span class="line">            System.exit(<span class="number">2</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Job</span> <span class="variable">job</span> <span class="operator">=</span> Job.getInstance(conf, <span class="string">&quot;word count&quot;</span>);</span><br><span class="line">        job.setJarByClass(WordCount.class);</span><br><span class="line">        job.setMapperClass(WordCount.TokenizerMapper.class);</span><br><span class="line">        job.setCombinerClass(WordCount.IntSumReducer.class);</span><br><span class="line">        job.setReducerClass(WordCount.IntSumReducer.class);</span><br><span class="line">        job.setOutputKeyClass(Text.class);</span><br><span class="line">        job.setOutputValueClass(IntWritable.class);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; otherArgs.length - <span class="number">1</span>; ++i) &#123;</span><br><span class="line">            FileInputFormat.addInputPath(job, <span class="keyword">new</span> <span class="title class_">Path</span>(otherArgs[i]));</span><br><span class="line">        &#125;</span><br><span class="line">        FileOutputFormat.setOutputPath(job, <span class="keyword">new</span> <span class="title class_">Path</span>(otherArgs[otherArgs.length - <span class="number">1</span>]));</span><br><span class="line">        System.exit(job.waitForCompletion(<span class="literal">true</span>) ? <span class="number">0</span> : <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">TokenizerMapper</span> <span class="keyword">extends</span> <span class="title class_">Mapper</span>&lt;Object, Text, Text, IntWritable&gt; &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">IntWritable</span> <span class="variable">one</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IntWritable</span>(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">private</span> <span class="type">Text</span> <span class="variable">word</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Text</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">TokenizerMapper</span><span class="params">()</span> &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">map</span><span class="params">(Object key, Text value, Mapper&lt;Object, Text, Text, IntWritable&gt;.Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException &#123;</span><br><span class="line">            <span class="type">StringTokenizer</span> <span class="variable">itr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringTokenizer</span>(value.toString());</span><br><span class="line">            <span class="keyword">while</span> (itr.hasMoreTokens()) &#123;</span><br><span class="line">                <span class="built_in">this</span>.word.set(itr.nextToken());</span><br><span class="line">                context.write(<span class="built_in">this</span>.word, one);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">IntSumReducer</span> <span class="keyword">extends</span> <span class="title class_">Reducer</span>&lt;Text, IntWritable, Text, IntWritable&gt; &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="type">IntWritable</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IntWritable</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">IntSumReducer</span><span class="params">()</span> &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">reduce</span><span class="params">(Text key, Iterable&lt;IntWritable&gt; values, Reducer&lt;Text, IntWritable, Text, IntWritable&gt;.Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">sum</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">            IntWritable val;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">Iterator</span> <span class="variable">i$</span> <span class="operator">=</span> values.iterator(); i$.hasNext(); sum += val.get()) &#123;</span><br><span class="line">                val = (IntWritable) i$.next();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">this</span>.result.set(sum);</span><br><span class="line">            context.write(key, <span class="built_in">this</span>.result);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ç¼–è¯‘æ‰“åŒ…è¿è¡Œ"><a href="#ç¼–è¯‘æ‰“åŒ…è¿è¡Œ" class="headerlink" title="ç¼–è¯‘æ‰“åŒ…è¿è¡Œ"></a>ç¼–è¯‘æ‰“åŒ…è¿è¡Œ</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åœ¨hadoopçš„å®‰è£…è·¯å¾„ä¸‹æ“ä½œ</span></span><br><span class="line"><span class="built_in">cd</span> /home/hadoop/hadoop</span><br><span class="line"></span><br><span class="line"><span class="comment"># javacç¼–è¯‘ç¨‹åºå¯ä»¥æ‰¾åˆ°Hadoopç›¸å…³çš„JARåŒ…</span></span><br><span class="line"><span class="built_in">export</span> CLASSPATH=<span class="string">&quot;/home/hadoop/hadoop/share/hadoop/common/hadoop-common-3.3.0.jar:/home/hadoop/hadoop/share/hadoop/mapreduce/hadoop-mapreduce-client-core-3.3.0.jar:/home/hadoop/hadoop/share/hadoop/common/lib/commons-cli-1.2.jar:<span class="variable">$CLASSPATH</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¼–è¯‘ç¨‹åº</span></span><br><span class="line">javac WordCount.java</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†Javaçš„3ä¸ª.classå¯æ‰§è¡Œæ–‡ä»¶æ‰“åŒ…å¹¶å‘½åä¸ºWordCount.jar</span></span><br><span class="line">jar -cvf WordCount.jar *.class    </span><br><span class="line"></span><br><span class="line"><span class="comment"># è¿è¡ŒjaråŒ…</span></span><br><span class="line">./bin/hadoop jar WordCount.jar WordCount input output</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹ç»“æœ</span></span><br><span class="line">./bin/hadoop fs -<span class="built_in">cat</span> output/*</span><br></pre></td></tr></table></figure><p><strong>ç¼–è¯‘</strong></p><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1666086755717-463841a2-4f8b-4173-b835-e7f85e3c1a63.png" class=""> <p><strong>æ‰“åŒ…</strong></p><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1666086735222-1ceb8c6c-1689-40c0-85ac-7c0ecd82cd38.png" class=""> <p><strong>è¿è¡Œ</strong></p><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1666086674036-256e194b-db5f-43a3-a385-a1b4a139df87.png" class=""> <p><strong>æŸ¥çœ‹ç»“æœ</strong></p><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1666086650756-c5ce2cc6-92ca-4c6c-8f5c-26de0979cf65.png" class=""> <h3 id="æ’é”™"><a href="#æ’é”™" class="headerlink" title="æ’é”™"></a>æ’é”™</h3><p>Hadoopï¼šæ‰¾ä¸åˆ°æˆ–æ— æ³•åŠ è½½ä¸»ç±»org.apache.hadoop.mapreduce.v2.app.MRAppMaster<br /><a href="https://blog.csdn.net/lianghecai52171314/article/details/103231176">https://blog.csdn.net/lianghecai52171314/article/details/103231176</a></p><h2 id="ä½¿ç”¨Ideaç¼–è¯‘è¿è¡Œè¯é¢‘ç»Ÿè®¡ç¨‹åº"><a href="#ä½¿ç”¨Ideaç¼–è¯‘è¿è¡Œè¯é¢‘ç»Ÿè®¡ç¨‹åº" class="headerlink" title="ä½¿ç”¨Ideaç¼–è¯‘è¿è¡Œè¯é¢‘ç»Ÿè®¡ç¨‹åº"></a>ä½¿ç”¨Ideaç¼–è¯‘è¿è¡Œè¯é¢‘ç»Ÿè®¡ç¨‹åº</h2><h3 id="HDFSä¸­åˆ›å»ºæ–‡ä»¶-1"><a href="#HDFSä¸­åˆ›å»ºæ–‡ä»¶-1" class="headerlink" title="HDFSä¸­åˆ›å»ºæ–‡ä»¶"></a>HDFSä¸­åˆ›å»ºæ–‡ä»¶</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">wordfile1.txt   </span><br><span class="line">I love Spark</span><br><span class="line">I love Hadoop</span><br><span class="line"></span><br><span class="line">wordfile2.txt.txt    </span><br><span class="line">Hadoop is good</span><br><span class="line">Spark is fast</span><br></pre></td></tr></table></figure><p><strong>ä¸Šä¼ åˆ°HDFSä¸­</strong></p><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1666086361148-02133ef3-7ce4-4be8-baec-3064ab246f96.png" class=""> <h3 id="mavenå·¥ç¨‹"><a href="#mavenå·¥ç¨‹" class="headerlink" title="mavenå·¥ç¨‹"></a>mavenå·¥ç¨‹</h3><h4 id="åˆ›å»ºå·¥ç¨‹"><a href="#åˆ›å»ºå·¥ç¨‹" class="headerlink" title="åˆ›å»ºå·¥ç¨‹"></a>åˆ›å»ºå·¥ç¨‹</h4><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1666092766611-2532f20d-08f2-452b-aa32-70a00c89efcb.png" class=""> <h4 id="å¯¼å…¥ä¾èµ–"><a href="#å¯¼å…¥ä¾èµ–" class="headerlink" title="å¯¼å…¥ä¾èµ–"></a>å¯¼å…¥ä¾èµ–</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.hadoop<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hadoop-common<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.hadoop<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hadoop-hdfs<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.hadoop<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hadoop-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="ç¼–å†™æºç "><a href="#ç¼–å†™æºç " class="headerlink" title="ç¼–å†™æºç "></a>ç¼–å†™æºç </h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.hadoop.conf.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.fs.Path;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.IntWritable;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.io.Text;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Job;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Mapper;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.Reducer;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.input.FileInputFormat;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.mapreduce.lib.output.FileOutputFormat;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.util.GenericOptionsParser;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.StringTokenizer;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> by pepsi-wyl</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022-10-18 16:44</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WordCount</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">WordCount</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Configuration</span> <span class="variable">conf</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Configuration</span>();</span><br><span class="line">        String[] otherArgs = (<span class="keyword">new</span> <span class="title class_">GenericOptionsParser</span>(conf, args)).getRemainingArgs();</span><br><span class="line">        <span class="keyword">if</span> (otherArgs.length &lt; <span class="number">2</span>) &#123;</span><br><span class="line">            System.err.println(<span class="string">&quot;Usage: wordcount &lt;in&gt; [&lt;in&gt;...] &lt;out&gt;&quot;</span>);</span><br><span class="line">            System.exit(<span class="number">2</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Job</span> <span class="variable">job</span> <span class="operator">=</span> Job.getInstance(conf, <span class="string">&quot;word count&quot;</span>);</span><br><span class="line">        job.setJarByClass(WordCount.class);</span><br><span class="line">        job.setMapperClass(TokenizerMapper.class);</span><br><span class="line">        job.setCombinerClass(IntSumReducer.class);</span><br><span class="line">        job.setReducerClass(IntSumReducer.class);</span><br><span class="line">        job.setOutputKeyClass(Text.class);</span><br><span class="line">        job.setOutputValueClass(IntWritable.class);</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; otherArgs.length - <span class="number">1</span>; ++i) &#123;</span><br><span class="line">            FileInputFormat.addInputPath(job, <span class="keyword">new</span> <span class="title class_">Path</span>(otherArgs[i]));</span><br><span class="line">        &#125;</span><br><span class="line">        FileOutputFormat.setOutputPath(job, <span class="keyword">new</span> <span class="title class_">Path</span>(otherArgs[otherArgs.length - <span class="number">1</span>]));</span><br><span class="line">        System.exit(job.waitForCompletion(<span class="literal">true</span>) ? <span class="number">0</span> : <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">TokenizerMapper</span> <span class="keyword">extends</span> <span class="title class_">Mapper</span>&lt;Object, Text, Text, IntWritable&gt; &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">IntWritable</span> <span class="variable">one</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IntWritable</span>(<span class="number">1</span>);</span><br><span class="line">        <span class="keyword">private</span> <span class="type">Text</span> <span class="variable">word</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Text</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">TokenizerMapper</span><span class="params">()</span> &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">map</span><span class="params">(Object key, Text value, Mapper&lt;Object, Text, Text, IntWritable&gt;.Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException &#123;</span><br><span class="line">            <span class="type">StringTokenizer</span> <span class="variable">itr</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StringTokenizer</span>(value.toString());</span><br><span class="line">            <span class="keyword">while</span> (itr.hasMoreTokens()) &#123;</span><br><span class="line">                <span class="built_in">this</span>.word.set(itr.nextToken());</span><br><span class="line">                context.write(<span class="built_in">this</span>.word, one);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">IntSumReducer</span> <span class="keyword">extends</span> <span class="title class_">Reducer</span>&lt;Text, IntWritable, Text, IntWritable&gt; &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="type">IntWritable</span> <span class="variable">result</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">IntWritable</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">IntSumReducer</span><span class="params">()</span> &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">reduce</span><span class="params">(Text key, Iterable&lt;IntWritable&gt; values, Reducer&lt;Text, IntWritable, Text, IntWritable&gt;.Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">sum</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">            IntWritable val;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">Iterator</span> <span class="variable">i$</span> <span class="operator">=</span> values.iterator(); i$.hasNext(); sum += val.get()) &#123;</span><br><span class="line">                val = (IntWritable) i$.next();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">this</span>.result.set(sum);</span><br><span class="line">            context.write(key, <span class="built_in">this</span>.result);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="æ‰“åŒ…"><a href="#æ‰“åŒ…" class="headerlink" title="æ‰“åŒ…"></a>æ‰“åŒ…</h4><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1666093874063-e79c44be-e14b-4aae-bcab-f4c1a0ea29c1.png" class=""> <img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1666094025109-e6fef8eb-315e-4ee6-a7d7-772b6681d864.png" class=""> <h3 id="ä¸Šä¼ æœåŠ¡å™¨è¿è¡Œ"><a href="#ä¸Šä¼ æœåŠ¡å™¨è¿è¡Œ" class="headerlink" title="ä¸Šä¼ æœåŠ¡å™¨è¿è¡Œ"></a>ä¸Šä¼ æœåŠ¡å™¨è¿è¡Œ</h3><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1666094119014-befca265-3725-4672-9c7b-5c30da0b1c5b.png" class=""> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è¿è¡ŒjaråŒ…</span></span><br><span class="line">./bin/hadoop jar WordCount-1.0-SNAPSHOT.jar WordCount input output</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹ç»“æœ</span></span><br><span class="line">./bin/hadoop fs -<span class="built_in">cat</span> output/*</span><br></pre></td></tr></table></figure><p><strong>è¿è¡Œ</strong></p><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1666094258647-504a15bf-f744-4c2a-a3a2-a81cdf16f1d7.png" class=""> <p><strong>æŸ¥çœ‹ç»“æœ</strong></p><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1666094282090-fb888bf8-50b3-47a1-b6dc-6bbcf697602b.png" class=""> <h1 id="HBaseåŸºæœ¬ä½¿ç”¨"><a href="#HBaseåŸºæœ¬ä½¿ç”¨" class="headerlink" title="HBaseåŸºæœ¬ä½¿ç”¨"></a>HBaseåŸºæœ¬ä½¿ç”¨</h1><h2 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h2><h3 id="ä¸‹è½½å’Œå®‰è£…"><a href="#ä¸‹è½½å’Œå®‰è£…" class="headerlink" title="ä¸‹è½½å’Œå®‰è£…"></a>ä¸‹è½½å’Œå®‰è£…</h3><h4 id="ç‰ˆæœ¬å¯¹åº”å…³ç³»"><a href="#ç‰ˆæœ¬å¯¹åº”å…³ç³»" class="headerlink" title="ç‰ˆæœ¬å¯¹åº”å…³ç³»"></a>ç‰ˆæœ¬å¯¹åº”å…³ç³»</h4><p>:::tips<br>HBaseç‰ˆæœ¬2.2.2 <strong>(æ³¨æ„å…¼å®¹æ€§)</strong><br /><a href="https://hbase.apache.org/book.html#hadoop">https://hbase.apache.org/book.html#hadoop</a><br>:::</p><h4 id="ä¸‹è½½å’Œè§£å‹"><a href="#ä¸‹è½½å’Œè§£å‹" class="headerlink" title="ä¸‹è½½å’Œè§£å‹"></a>ä¸‹è½½å’Œè§£å‹</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¸‹è½½</span></span><br><span class="line">wget https://archive.apache.org/dist/hbase/2.2.2/hbase-2.2.2-bin.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># è§£å‹</span></span><br><span class="line">tar -zxvf hbase-2.2.7-bin.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ é™¤æºç åŒ…</span></span><br><span class="line"><span class="built_in">rm</span> -rf hbase-2.2.7-bin.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># é‡å‘½å</span></span><br><span class="line"><span class="built_in">mv</span> hbase-2.2.7 hbase</span><br></pre></td></tr></table></figure><h4 id="é…ç½®ç¯å¢ƒå˜é‡"><a href="#é…ç½®ç¯å¢ƒå˜é‡" class="headerlink" title="é…ç½®ç¯å¢ƒå˜é‡"></a>é…ç½®ç¯å¢ƒå˜é‡</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç¼–è¾‘é…ç½®æ–‡ä»¶</span></span><br><span class="line">vim /etc/profile </span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> HBASE_HOME=/home/hadoop/hbase</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:<span class="variable">$HBASE_HOME</span>/bin:/<span class="variable">$HBASE_HOME</span>/sbin</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä½¿é…ç½®æ–‡ä»¶ç”Ÿæ•ˆ</span></span><br><span class="line"><span class="built_in">source</span> /etc/profile</span><br></pre></td></tr></table></figure><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1666833633192-1e6f1219-18b6-4cca-b688-1db5a92972d5.png" class=""> <h4 id="æŸ¥çœ‹HBaseç‰ˆæœ¬ä¿¡æ¯"><a href="#æŸ¥çœ‹HBaseç‰ˆæœ¬ä¿¡æ¯" class="headerlink" title="æŸ¥çœ‹HBaseç‰ˆæœ¬ä¿¡æ¯"></a>æŸ¥çœ‹HBaseç‰ˆæœ¬ä¿¡æ¯</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹ç‰ˆæœ¬ä¿¡æ¯</span></span><br><span class="line">hbase version</span><br></pre></td></tr></table></figure><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1666833256300-93192e20-dcc3-4c5e-ba5e-56524408e4e0.png" class=""> <h3 id="é…ç½®"><a href="#é…ç½®" class="headerlink" title="é…ç½®"></a>é…ç½®</h3><h4 id="é…ç½®hbase-env-sh"><a href="#é…ç½®hbase-env-sh" class="headerlink" title="é…ç½®hbase-env.sh"></a>é…ç½®hbase-env.sh</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vim /home/hadoop/hbase/conf/hbase-env.sh</span><br><span class="line"></span><br><span class="line"><span class="built_in">export</span> JAVA_HOME=/home/hadoop/jdk8</span><br><span class="line"><span class="built_in">export</span> HBASE_CLASSPATH=/home/hadoop/hbase/conf</span><br><span class="line"><span class="built_in">export</span> HBASE_MANAGES_ZK=<span class="literal">true</span></span><br></pre></td></tr></table></figure><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1666833711166-4714d08e-e817-4898-a974-a8f24b211206.png" class=""> <h4 id="é…ç½®hbase-site-xml"><a href="#é…ç½®hbase-site-xml" class="headerlink" title="é…ç½®hbase-site.xml"></a>é…ç½®hbase-site.xml</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /home/hadoop/hbase/conf/hbase-site.xml</span><br></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span>?&gt;</span></span><br><span class="line"><span class="meta">&lt;?xml-stylesheet type=<span class="string">&quot;text/xsl&quot;</span> href=<span class="string">&quot;configuration.xsl&quot;</span>?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.rootdir<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--IPä¸ºè‡ªå·±çš„è™šæœºIP--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>hdfs://192.168.131.144:9000/hbase<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.cluster.distributed<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>true<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>hbase.unsafe.stream.capability.enforce<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>false<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1666785067910-12967934-9e4a-43f3-b33a-e22fdb44da32.png" class=""> <h3 id="å¯åŠ¨å’Œåœæ­¢"><a href="#å¯åŠ¨å’Œåœæ­¢" class="headerlink" title="å¯åŠ¨å’Œåœæ­¢"></a>å¯åŠ¨å’Œåœæ­¢</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># é¦–å…ˆå¯åŠ¨Hadoop</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯åŠ¨HBase</span></span><br><span class="line">/home/hadoop/hbase/bin/start-hbase.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹å¯åŠ¨çš„è¿›ç¨‹</span></span><br><span class="line">jps</span><br></pre></td></tr></table></figure><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1666833437687-86f0490f-1a84-427c-abb5-efcad7c0bcd6.png" class=""> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åœæ­¢HBase</span></span><br><span class="line">/home/hadoop/hbase/bin/hbase-daemon.sh stop master</span><br><span class="line">/home/hadoop/hbase/bin/stop-hbase.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹å¯åŠ¨çš„è¿›ç¨‹</span></span><br><span class="line">jps</span><br></pre></td></tr></table></figure><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1666786886054-3757a29a-9bba-458e-b295-abc3745ebd10.png" class=""> <img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1666786886913-86709fe7-5da4-403c-8db1-bc0513b738bf.png" class=""> <h2 id="Shellå‘½ä»¤"><a href="#Shellå‘½ä»¤" class="headerlink" title="Shellå‘½ä»¤"></a>Shellå‘½ä»¤</h2><h3 id="å¯åŠ¨"><a href="#å¯åŠ¨" class="headerlink" title="å¯åŠ¨"></a>å¯åŠ¨</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¯åŠ¨HBase Shell</span></span><br><span class="line">/home/hadoop/hbase/bin/hbase shell</span><br></pre></td></tr></table></figure><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1666833479444-785641b0-1da7-482f-b3de-1d1c33683a24.png" class=""> <h3 id="åˆ›å»ºè¡¨"><a href="#åˆ›å»ºè¡¨" class="headerlink" title="åˆ›å»ºè¡¨"></a>åˆ›å»ºè¡¨</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºè¡¨</span></span><br><span class="line">create <span class="string">&#x27;student&#x27;</span>,<span class="string">&#x27;Sname&#x27;</span>,<span class="string">&#x27;Ssex&#x27;</span>,<span class="string">&#x27;Sage&#x27;</span>,<span class="string">&#x27;Sdept&#x27;</span>,<span class="string">&#x27;course&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹è¡¨ä¿¡æ¯</span></span><br><span class="line">describe <span class="string">&#x27;student&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹è¡¨</span></span><br><span class="line">list</span><br></pre></td></tr></table></figure><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1667009441071-8bdc163f-e0ac-456a-9b6e-70d619cf3480.png" class=""> <img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1667009462736-9ec35cce-0808-4384-8414-38825de33613.png" class=""> <img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1667009474325-56ac4ad1-b5e5-4894-91a1-5c74f2c21b80.png" class=""> <h3 id="åˆ é™¤è¡¨"><a href="#åˆ é™¤è¡¨" class="headerlink" title="åˆ é™¤è¡¨"></a>åˆ é™¤è¡¨</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ é™¤è¡¨  è®©è¡¨ä¸å¯ç”¨</span></span><br><span class="line"><span class="built_in">disable</span> <span class="string">&#x27;student&#x27;</span> </span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ é™¤è¡¨  è®©è¡¨ä¸å¯ç”¨</span></span><br><span class="line">drop <span class="string">&#x27;student&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹è¡¨</span></span><br><span class="line">list </span><br></pre></td></tr></table></figure><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1667009518411-3fbf382d-a514-4a7e-92e9-65ee3d6d6f74.png" class=""> <h3 id="æ’å…¥æ•°æ®"><a href="#æ’å…¥æ•°æ®" class="headerlink" title="æ’å…¥æ•°æ®"></a>æ’å…¥æ•°æ®</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ’å…¥æ•°æ®</span></span><br><span class="line">put <span class="string">&#x27;student&#x27;</span>,<span class="string">&#x27;95001&#x27;</span>,<span class="string">&#x27;Sname&#x27;</span>,<span class="string">&#x27;LiYing&#x27;</span></span><br><span class="line">put <span class="string">&#x27;student&#x27;</span>,<span class="string">&#x27;95001&#x27;</span>,<span class="string">&#x27;Ssex&#x27;</span>,<span class="string">&#x27;male&#x27;</span></span><br><span class="line">put <span class="string">&#x27;student&#x27;</span>,<span class="string">&#x27;95001&#x27;</span>,<span class="string">&#x27;Sage&#x27;</span>,<span class="string">&#x27;22&#x27;</span></span><br><span class="line">put <span class="string">&#x27;student&#x27;</span>,<span class="string">&#x27;95001&#x27;</span>,<span class="string">&#x27;Sdept&#x27;</span>,<span class="string">&#x27;CS&#x27;</span></span><br><span class="line">put <span class="string">&#x27;student&#x27;</span>,<span class="string">&#x27;95001&#x27;</span>,<span class="string">&#x27;course:math&#x27;</span>,<span class="string">&#x27;80&#x27;</span></span><br></pre></td></tr></table></figure><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1667009593262-a410dbca-ef7c-40a4-a27e-9b85634d0fad.png" class=""> <h3 id="æŸ¥çœ‹æ•°æ®"><a href="#æŸ¥çœ‹æ•°æ®" class="headerlink" title="æŸ¥çœ‹æ•°æ®"></a>æŸ¥çœ‹æ•°æ®</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹æ•°æ®  æŸ¥çœ‹è¡¨çš„æŸä¸€ä¸ªå•å…ƒæ ¼æ•°æ®</span></span><br><span class="line">get <span class="string">&#x27;student&#x27;</span>,<span class="string">&#x27;95001&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹æ•°æ®  æŸ¥çœ‹æŸä¸ªè¡¨çš„å…¨éƒ¨æ•°æ®</span></span><br><span class="line">scan <span class="string">&#x27;student&#x27;</span></span><br></pre></td></tr></table></figure><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1667009618408-ea27b1ea-70f2-4d21-b877-e93b8931b4ad.png" class=""> <h3 id="åˆ é™¤æ•°æ®"><a href="#åˆ é™¤æ•°æ®" class="headerlink" title="åˆ é™¤æ•°æ®"></a>åˆ é™¤æ•°æ®</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ é™¤æ•°æ® åˆ é™¤ä¸€åˆ—æ•°æ®</span></span><br><span class="line">delete <span class="string">&#x27;student&#x27;</span>,<span class="string">&#x27;95001&#x27;</span>,<span class="string">&#x27;Ssex&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ é™¤æ•°æ® åˆ é™¤ä¸€è¡Œæ•°æ®</span></span><br><span class="line">deleteall <span class="string">&#x27;student&#x27;</span>,<span class="string">&#x27;95001&#x27;</span></span><br></pre></td></tr></table></figure><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1667009645508-cc7df4a1-61f1-4aaf-8c71-cfd99a8dff60.png" class=""> <h3 id="æŸ¥è¯¢å†å²æ•°æ®"><a href="#æŸ¥è¯¢å†å²æ•°æ®" class="headerlink" title="æŸ¥è¯¢å†å²æ•°æ®"></a>æŸ¥è¯¢å†å²æ•°æ®</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºteacherè¡¨ï¼ŒæŒ‡å®šä¿å­˜çš„ç‰ˆæœ¬æ•°ï¼ˆå‡è®¾æŒ‡å®šä¸º5ï¼‰</span></span><br><span class="line">create <span class="string">&#x27;teacher&#x27;</span>,&#123;NAME=&gt;<span class="string">&#x27;username&#x27;</span>,VERSIONS=&gt;5&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ’å…¥æ•°æ®ï¼Œå¹¶æ›´æ–°æ•°æ®ï¼Œä½¿å…¶äº§ç”Ÿå†å²ç‰ˆæœ¬æ•°æ®</span></span><br><span class="line">put <span class="string">&#x27;teacher&#x27;</span>,<span class="string">&#x27;91001&#x27;</span>,<span class="string">&#x27;username&#x27;</span>,<span class="string">&#x27;Mary&#x27;</span></span><br><span class="line">put <span class="string">&#x27;teacher&#x27;</span>,<span class="string">&#x27;91001&#x27;</span>,<span class="string">&#x27;username&#x27;</span>,<span class="string">&#x27;Mary1&#x27;</span></span><br><span class="line">put <span class="string">&#x27;teacher&#x27;</span>,<span class="string">&#x27;91001&#x27;</span>,<span class="string">&#x27;username&#x27;</span>,<span class="string">&#x27;Mary2&#x27;</span></span><br><span class="line">put <span class="string">&#x27;teacher&#x27;</span>,<span class="string">&#x27;91001&#x27;</span>,<span class="string">&#x27;username&#x27;</span>,<span class="string">&#x27;Mary3&#x27;</span></span><br><span class="line">put <span class="string">&#x27;teacher&#x27;</span>,<span class="string">&#x27;91001&#x27;</span>,<span class="string">&#x27;username&#x27;</span>,<span class="string">&#x27;Mary4&#x27;</span>  </span><br><span class="line">put <span class="string">&#x27;teacher&#x27;</span>,<span class="string">&#x27;91001&#x27;</span>,<span class="string">&#x27;username&#x27;</span>,<span class="string">&#x27;Mary5&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥è¯¢æŒ‡å®šæŸ¥è¯¢çš„å†å²ç‰ˆæœ¬æ•°</span></span><br><span class="line">get <span class="string">&#x27;teacher&#x27;</span>,<span class="string">&#x27;91001&#x27;</span>,&#123;COLUMN=&gt;<span class="string">&#x27;username&#x27;</span>,VERSIONS=&gt;5&#125;</span><br><span class="line">get <span class="string">&#x27;teacher&#x27;</span>,<span class="string">&#x27;91001&#x27;</span>,&#123;COLUMN=&gt;<span class="string">&#x27;username&#x27;</span>,VERSIONS=&gt;3&#125;</span><br></pre></td></tr></table></figure><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1667009898500-5a894fc3-1d57-4f06-ad35-9e38f220da42.png" class=""> <h3 id="é€€å‡º"><a href="#é€€å‡º" class="headerlink" title="é€€å‡º"></a>é€€å‡º</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">exit</span></span><br></pre></td></tr></table></figure><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1667009912071-112ede8e-1567-4d87-8998-55f7510cfc41.png" class=""> <h2 id="Idaeç¼–ç¨‹"><a href="#Idaeç¼–ç¨‹" class="headerlink" title="Idaeç¼–ç¨‹"></a>Idaeç¼–ç¨‹</h2><p>ä»£ç è¿æ¥ <a href="https://github.com/pepsi-wyl/Hbase_API">https://github.com/pepsi-wyl/Hbase_API</a></p><h3 id="Windowsæ·»åŠ æ˜ å°„"><a href="#Windowsæ·»åŠ æ˜ å°„" class="headerlink" title="Windowsæ·»åŠ æ˜ å°„"></a>Windowsæ·»åŠ æ˜ å°„</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># C:\Windows\System32\drivers\etc\hosts</span><br><span class="line"></span><br><span class="line"># æ·»åŠ æ˜ å°„</span><br><span class="line"><span class="number">192.168</span><span class="number">.131</span><span class="number">.144</span> hadoop</span><br></pre></td></tr></table></figure><h3 id="åˆ›å»ºMavenå¹¶ä¸”æ·»åŠ ä¾èµ–"><a href="#åˆ›å»ºMavenå¹¶ä¸”æ·»åŠ ä¾èµ–" class="headerlink" title="åˆ›å»ºMavenå¹¶ä¸”æ·»åŠ ä¾èµ–"></a>åˆ›å»ºMavenå¹¶ä¸”æ·»åŠ ä¾èµ–</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.hbase<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hbase-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.hbase<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>hbase-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ä¾èµ–ç‰ˆæœ¬è¦ä¸HBaseç‰ˆæœ¬å¯¹åº”</p><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1667028051579-0cd82888-c116-4d67-9c61-b2bf7349fdc1.png" class=""> <h3 id="ç¼–å†™ä»£ç "><a href="#ç¼–å†™ä»£ç " class="headerlink" title="ç¼–å†™ä»£ç "></a>ç¼–å†™ä»£ç </h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.conf.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.client.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.hbase.util.Bytes;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> by pepsi-wyl</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2022-10-29 11:19</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExampleForHBase</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Configuration configuration;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Connection connection;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Admin admin;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        init();</span><br><span class="line">        createTable(<span class="string">&quot;student&quot;</span>, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;score&quot;</span>&#125;);</span><br><span class="line">        insertData(<span class="string">&quot;student&quot;</span>, <span class="string">&quot;zhangsan&quot;</span>, <span class="string">&quot;score&quot;</span>, <span class="string">&quot;English&quot;</span>, <span class="string">&quot;69&quot;</span>);</span><br><span class="line">        insertData(<span class="string">&quot;student&quot;</span>, <span class="string">&quot;zhangsan&quot;</span>, <span class="string">&quot;score&quot;</span>, <span class="string">&quot;Math&quot;</span>, <span class="string">&quot;86&quot;</span>);</span><br><span class="line">        insertData(<span class="string">&quot;student&quot;</span>, <span class="string">&quot;zhangsan&quot;</span>, <span class="string">&quot;score&quot;</span>, <span class="string">&quot;Computer&quot;</span>, <span class="string">&quot;77&quot;</span>);</span><br><span class="line">        getData(<span class="string">&quot;student&quot;</span>, <span class="string">&quot;zhangsan&quot;</span>, <span class="string">&quot;score&quot;</span>, <span class="string">&quot;English&quot;</span>);</span><br><span class="line">        close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">()</span> &#123;</span><br><span class="line">        configuration = HBaseConfiguration.create();</span><br><span class="line">        configuration.set(<span class="string">&quot;hbase.rootdir&quot;</span>, <span class="string">&quot;hdfs://192.168.131.144:9000/hbase&quot;</span>);</span><br><span class="line">        configuration.set(<span class="string">&quot;hbase.zookeeper.quorum&quot;</span>, <span class="string">&quot;192.168.131.144&quot;</span>);</span><br><span class="line">        configuration.set(<span class="string">&quot;hbase.zookeeper.property.clientPort&quot;</span>, <span class="string">&quot;2181&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            connection = ConnectionFactory.createConnection(configuration);</span><br><span class="line">            admin = connection.getAdmin();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">close</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (admin != <span class="literal">null</span>) &#123;</span><br><span class="line">                admin.close();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (<span class="literal">null</span> != connection) &#123;</span><br><span class="line">                connection.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">createTable</span><span class="params">(String myTableName, String[] colFamily)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">TableName</span> <span class="variable">tableName</span> <span class="operator">=</span> TableName.valueOf(myTableName);</span><br><span class="line">        <span class="keyword">if</span> (admin.tableExists(tableName)) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;talbe is exists!&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">TableDescriptorBuilder</span> <span class="variable">tableDescriptor</span> <span class="operator">=</span> TableDescriptorBuilder.newBuilder(tableName);</span><br><span class="line">            <span class="keyword">for</span> (String str : colFamily) &#123;</span><br><span class="line">                <span class="type">ColumnFamilyDescriptor</span> <span class="variable">family</span> <span class="operator">=</span> ColumnFamilyDescriptorBuilder.newBuilder(Bytes.toBytes(str)).build();</span><br><span class="line">                tableDescriptor.setColumnFamily(family);</span><br><span class="line">            &#125;</span><br><span class="line">            admin.createTable(tableDescriptor.build());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">insertData</span><span class="params">(String tableName, String rowKey, String colFamily, String col, String val)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">Table</span> <span class="variable">table</span> <span class="operator">=</span> connection.getTable(TableName.valueOf(tableName));</span><br><span class="line">        <span class="type">Put</span> <span class="variable">put</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Put</span>(rowKey.getBytes());</span><br><span class="line">        put.addColumn(colFamily.getBytes(), col.getBytes(), val.getBytes());</span><br><span class="line">        table.put(put);</span><br><span class="line">        table.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">getData</span><span class="params">(String tableName, String rowKey, String colFamily, String col)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">Table</span> <span class="variable">table</span> <span class="operator">=</span> connection.getTable(TableName.valueOf(tableName));</span><br><span class="line">        <span class="type">Get</span> <span class="variable">get</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Get</span>(rowKey.getBytes());</span><br><span class="line">        get.addColumn(colFamily.getBytes(), col.getBytes());</span><br><span class="line">        <span class="type">Result</span> <span class="variable">result</span> <span class="operator">=</span> table.get(get);</span><br><span class="line">        System.out.println(<span class="keyword">new</span> <span class="title class_">String</span>(result.getValue(colFamily.getBytes(), col == <span class="literal">null</span> ? <span class="literal">null</span> : col.getBytes())));</span><br><span class="line">        table.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1667028401831-86be6eae-9f74-433a-b192-5c196b7e6978.png" class=""> <h1 id="ZookeeperæŠ€æœ¯"><a href="#ZookeeperæŠ€æœ¯" class="headerlink" title="ZookeeperæŠ€æœ¯"></a>ZookeeperæŠ€æœ¯</h1><h2 id="å®‰è£…-1"><a href="#å®‰è£…-1" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h2><h3 id="å•æœºå®‰è£…-1"><a href="#å•æœºå®‰è£…-1" class="headerlink" title="å•æœºå®‰è£…"></a>å•æœºå®‰è£…</h3><p>è¿™ç§é…ç½®æ–¹å¼ä¸‹æ²¡æœ‰Zookeeperå‰¯æœ¬ï¼Œæ‰€ä»¥å¦‚æœZookeeperæœåŠ¡å™¨å‡ºç°æ•…éšœï¼ŒZookeeperæœåŠ¡å°†ä¼šåœæ­¢ã€‚è¿™ç§åº”ç”¨æ¨¡å¼ä¸»è¦ç”¨åœ¨æµ‹è¯•æˆ–demoçš„æƒ…å†µä¸‹ï¼Œåœ¨ç”Ÿäº§ç¯å¢ƒä¸‹ä¸€èˆ¬ä¸ä¼šé‡‡ç”¨ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ‡æ¢è·¯å¾„</span></span><br><span class="line"><span class="built_in">cd</span> /home/hadoop</span><br><span class="line"></span><br><span class="line"><span class="comment"># è§£å†³é¢å‘çš„è¯ä¹¦å·²ç»è¿‡æœŸé—®é¢˜</span></span><br><span class="line">yum install -y ca-certificates</span><br><span class="line"></span><br><span class="line"><span class="comment"># è·å–å®‰è£…åŒ…</span></span><br><span class="line">wget https://dlcdn.apache.org/zookeeper/zookeeper-3.6.3/apache-zookeeper-3.6.3-bin.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># è§£å‹å®‰è£…åŒ…</span></span><br><span class="line">tar -zxvf apache-zookeeper-3.6.3-bin.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># é‡å‘½å</span></span><br><span class="line"><span class="built_in">mv</span> apache-zookeeper-3.6.3-bin zookeeper</span><br><span class="line"></span><br><span class="line"><span class="comment"># èµ‹äºˆæƒé™</span></span><br><span class="line">sudo <span class="built_in">chown</span> hadoop:hadoop -R /home/hadoop/zookeeper</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ é™¤å®‰è£…åŒ…</span></span><br><span class="line"><span class="built_in">rm</span> -rf apache-zookeeper-3.6.3-bin.tar.gz</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºè·¯å¾„</span></span><br><span class="line"><span class="built_in">mkdir</span> /home/hadoop/zookeeper/one</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºæ•°æ®ç›®å½•</span></span><br><span class="line"><span class="built_in">mkdir</span> /home/hadoop/zookeeper/one/data</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¤åˆ¶é…ç½®æ–‡ä»¶</span></span><br><span class="line"><span class="built_in">cp</span> /home/hadoop/zookeeper/conf/zoo_sample.cfg /home/hadoop/zookeeper/conf/zoo.cfg</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ä¿®æ”¹é…ç½®æ–‡ä»¶</span></span><br><span class="line">vim /home/hadoop/zookeeper/conf/zoo.cfg</span><br><span class="line"></span><br><span class="line">ickTime=2000</span><br><span class="line">dataDir=/home/hadoop/zookeeper/one/data</span><br><span class="line">clientPort=2181</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¯åŠ¨zookeeperæœåŠ¡</span></span><br><span class="line">/home/hadoop/zookeeper/bin/zkServer.sh start</span><br><span class="line"></span><br><span class="line"><span class="comment"># å…³é—­zookeeperæœåŠ¡</span></span><br><span class="line">/home/hadoop/zookeeper/bin/zkServer.sh stop</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹zookeeperæœåŠ¡çš„è¿è¡ŒçŠ¶æ€</span></span><br><span class="line">/home/hadoop/zookeeper/bin/zkServer.sh status</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹ç³»ç»Ÿè¿›ç¨‹ï¼Œçœ‹åˆ°â€œQuorumPeerMainâ€è¿›ç¨‹ï¼Œè¡¨ç¤ºZookeeperå·²ç»å¯åŠ¨</span></span><br><span class="line">jps</span><br></pre></td></tr></table></figure><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1667890477529-cc2150a8-d739-47f0-9fa8-738ae47fa62b.png" class=""> <h3 id="ä¼ªåˆ†å¸ƒå¼å®‰è£…"><a href="#ä¼ªåˆ†å¸ƒå¼å®‰è£…" class="headerlink" title="ä¼ªåˆ†å¸ƒå¼å®‰è£…"></a>ä¼ªåˆ†å¸ƒå¼å®‰è£…</h3><p>ä¼ªé›†ç¾¤æ¨¡å¼å°±æ˜¯åœ¨å•æœºæ¨¡æ‹Ÿé›†ç¾¤çš„ZookeeperæœåŠ¡ã€‚åœ¨Zookeeperçš„å‚æ•°é…ç½®ä¸­ï¼ŒclientPortå‚æ•°ç”¨æ¥é…ç½®å®¢æˆ·ç«¯è¿æ¥Zookeeperçš„ç«¯å£ã€‚ä¼ªåˆ†å¸ƒå¼æ˜¯ä½¿ç”¨æ¯ä¸ªé…ç½®æ–‡æ¡£æ¨¡æ‹Ÿä¸€å°æœºå™¨ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œéœ€è¦åœ¨å•å°æœºå™¨ä¸Šè¿è¡Œå¤šä¸ªZookeeperå®ä¾‹ã€‚ä½†æ˜¯å¿…é¡»è¦ä¿è¯å„ä¸ªé…ç½®æ–‡æ¡£çš„clientPortä¸å†²çªå³å¯ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºé›†ç¾¤ç›®å½•</span></span><br><span class="line"><span class="built_in">mkdir</span> /home/hadoop/zookeeper/master</span><br><span class="line"></span><br><span class="line"><span class="built_in">mkdir</span> /home/hadoop/zookeeper/master/conf</span><br><span class="line"><span class="built_in">mkdir</span> /home/hadoop/zookeeper/master/data</span><br><span class="line"><span class="built_in">mkdir</span> /home/hadoop/zookeeper/master/data/one</span><br><span class="line"><span class="built_in">mkdir</span> /home/hadoop/zookeeper/master/data/two</span><br><span class="line"><span class="built_in">mkdir</span> /home/hadoop/zookeeper/master/data/three</span><br><span class="line"><span class="built_in">mkdir</span> /home/hadoop/zookeeper/master/datalog</span><br><span class="line"><span class="built_in">mkdir</span> /home/hadoop/zookeeper/master/datalog/one</span><br><span class="line"><span class="built_in">mkdir</span> /home/hadoop/zookeeper/master/datalog/two</span><br><span class="line"><span class="built_in">mkdir</span> /home/hadoop/zookeeper/master/datalog/three</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¤åˆ¶é…ç½®æ–‡ä»¶</span></span><br><span class="line"><span class="built_in">cp</span> /home/hadoop/zookeeper/conf/zoo_sample.cfg /home/hadoop/zookeeper/master/conf/zoo1.cfg</span><br><span class="line"><span class="built_in">cp</span> /home/hadoop/zookeeper/conf/zoo_sample.cfg /home/hadoop/zookeeper/master/conf/zoo2.cfg</span><br><span class="line"><span class="built_in">cp</span> /home/hadoop/zookeeper/conf/zoo_sample.cfg /home/hadoop/zookeeper/master/conf/zoo3.cfg</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">vim /home/hadoop/zookeeper/master/conf/zoo1.cfg</span><br><span class="line">tickTime=2000</span><br><span class="line">initLimit=10</span><br><span class="line">syncLimit=5</span><br><span class="line">dataDir=/home/hadoop/zookeeper/master/data/one</span><br><span class="line">dataLogDir=/home/hadoop/zookeeper/master/datalog/one</span><br><span class="line">clientPort=2181</span><br><span class="line">server.1=127.0.0.1:2888:3888</span><br><span class="line">server.2=127.0.0.1:2889:3889</span><br><span class="line">server.3=127.0.0.1:2890:3890</span><br><span class="line">maxClientCnxns=60</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">vim /home/hadoop/zookeeper/master/conf/zoo2.cfg</span><br><span class="line">tickTime=2000</span><br><span class="line">initLimit=10</span><br><span class="line">syncLimit=5</span><br><span class="line">dataDir=/home/hadoop/zookeeper/master/data/two</span><br><span class="line">dataLogDir=/home/hadoop/zookeeper/master/datalog/two</span><br><span class="line">clientPort=2182</span><br><span class="line">server.1=127.0.0.1:2888:3888</span><br><span class="line">server.2=127.0.0.1:2889:3889</span><br><span class="line">server.3=127.0.0.1:2890:3890</span><br><span class="line">maxClientCnxns=60</span><br><span class="line"></span><br><span class="line">vim /home/hadoop/zookeeper/master/conf/zoo3.cfg</span><br><span class="line">tickTime=2000</span><br><span class="line">initLimit=10</span><br><span class="line">syncLimit=5</span><br><span class="line">dataDir=/home/hadoop/zookeeper/master/data/three</span><br><span class="line">dataLogDir=/home/hadoop/zookeeper/master/datalog/three</span><br><span class="line">clientPort=2183</span><br><span class="line">server.1=127.0.0.1:2888:3888</span><br><span class="line">server.2=127.0.0.1:2889:3889</span><br><span class="line">server.3=127.0.0.1:2890:3890</span><br><span class="line">maxClientCnxns=60</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># myidæ–‡ä»¶ç¼ºå¤± https://blog.csdn.net/a_bang/article/details/72825929</span></span><br><span class="line"></span><br><span class="line">vim /home/hadoop/zookeeper/master/data/one/myid</span><br><span class="line">1</span><br><span class="line">vim /home/hadoop/zookeeper/master/data/two/myid</span><br><span class="line">2</span><br><span class="line">vim /home/hadoop/zookeeper/master/data/three/myid</span><br><span class="line">3</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¯åŠ¨</span></span><br><span class="line">/home/hadoop/zookeeper/bin/zkServer.sh start /home/hadoop/zookeeper/master/conf/zoo1.cfg</span><br><span class="line">/home/hadoop/zookeeper/bin/zkServer.sh start /home/hadoop/zookeeper/master/conf/zoo2.cfg</span><br><span class="line">/home/hadoop/zookeeper/bin/zkServer.sh start /home/hadoop/zookeeper/master/conf/zoo3.cfg</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹çŠ¶æ€</span></span><br><span class="line">/home/hadoop/zookeeper/bin/zkServer.sh status /home/hadoop/zookeeper/master/conf/zoo1.cfg</span><br><span class="line">/home/hadoop/zookeeper/bin/zkServer.sh status /home/hadoop/zookeeper/master/conf/zoo2.cfg</span><br><span class="line">/home/hadoop/zookeeper/bin/zkServer.sh status /home/hadoop/zookeeper/master/conf/zoo3.cfg</span><br><span class="line"></span><br><span class="line"><span class="comment"># å…³é—­</span></span><br><span class="line">/home/hadoop/zookeeper/bin/zkServer.sh stop /home/hadoop/zookeeper/master/conf/zoo1.cfg</span><br><span class="line">/home/hadoop/zookeeper/bin/zkServer.sh stop /home/hadoop/zookeeper/master/conf/zoo2.cfg</span><br><span class="line">/home/hadoop/zookeeper/bin/zkServer.sh stop /home/hadoop/zookeeper/master/conf/zoo3.cfg</span><br></pre></td></tr></table></figure><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1667895541526-b296cb63-4d17-446c-ab82-9cd8e061d85b.png" class=""> <img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1667895570296-717dc9d3-af3a-4e6f-919a-4f031694f61c.png" class=""> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/home/hadoop/zookeeper/bin/zkServer.sh start-foreground /home/hadoop/zookeeper/master/conf/zoo1.cfg</span><br></pre></td></tr></table></figure><h3 id="åˆ†å¸ƒå¼å®‰è£…-é€‰ä½œ-1"><a href="#åˆ†å¸ƒå¼å®‰è£…-é€‰ä½œ-1" class="headerlink" title="åˆ†å¸ƒå¼å®‰è£…(é€‰ä½œ)"></a>åˆ†å¸ƒå¼å®‰è£…(é€‰ä½œ)</h3><p>åœ¨è¿™ç§æ¨¡å¼ä¸‹å¯ä»¥è·å¾—å¯é çš„ZookeeperæœåŠ¡ï¼Œåªè¦é›†ç¾¤ä¸­çš„å¤§å¤šæ•°ZookeeperæœåŠ¡å¯åŠ¨äº†ï¼Œé‚£ä¹ˆæ€»çš„ZookeeperæœåŠ¡å°†æ˜¯å¯ç”¨çš„ã€‚åˆ†å¸ƒå¼æ¨¡å¼ä¸‹çš„é…ç½®ä¸ä¼ªåˆ†å¸ƒå¼æœ€å¤§çš„ä¸åŒæ˜¯Zookeeperå®ä¾‹åˆ†å¸ƒåœ¨å¤šå°æœºå™¨ä¸Šã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ‡æ¢è·¯å¾„</span></span><br><span class="line"><span class="built_in">cd</span> /opt</span><br><span class="line"></span><br><span class="line"><span class="comment"># è§£å†³é¢å‘çš„è¯ä¹¦å·²ç»è¿‡æœŸé—®é¢˜</span></span><br><span class="line">yum install -y ca-certificates</span><br><span class="line"></span><br><span class="line"><span class="comment"># è·å–å®‰è£…åŒ…</span></span><br><span class="line">wget https://dlcdn.apache.org/zookeeper/zookeeper-3.6.3/apache-zookeeper-3.6.3-bin.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># è§£å‹å®‰è£…åŒ…</span></span><br><span class="line">tar -zxvf apache-zookeeper-3.6.3-bin.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># é‡å‘½å</span></span><br><span class="line"><span class="built_in">mv</span> apache-zookeeper-3.6.3-bin zookeeper</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ é™¤å®‰è£…åŒ…</span></span><br><span class="line"><span class="built_in">rm</span> -rf apache-zookeeper-3.6.3-bin.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºæ•°æ®ç›®å½•</span></span><br><span class="line"><span class="built_in">mkdir</span> /opt/zookeeper/data</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºæ•°æ®ç›®å½•æ—¥å¿—ç›®å½•</span></span><br><span class="line"><span class="built_in">mkdir</span> /opt/zookeeper/datalog</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¤åˆ¶é…ç½®æ–‡ä»¶</span></span><br><span class="line"><span class="built_in">cp</span> /opt/zookeeper/conf/zoo_sample.cfg /opt/zookeeper/conf/zoo.cfg</span><br><span class="line"></span><br><span class="line"><span class="comment"># ç¼–å†™é…ç½®æ–‡ä»¶</span></span><br><span class="line">vim /opt/zookeeper/conf/zoo.cfg</span><br><span class="line"></span><br><span class="line">tickTime=2000</span><br><span class="line">initLimit=10</span><br><span class="line">syncLimit=5</span><br><span class="line">dataDir=/opt/zookeeper/data</span><br><span class="line">dataLogDir=/opt/zookeeper/datalog</span><br><span class="line">clientPort=2182</span><br><span class="line">server.1=192.168.131.145:2887:3887</span><br><span class="line">server.2=192.168.131.146:2888:3888</span><br><span class="line">server.3=192.168.131.147:2899:3899</span><br><span class="line"></span><br><span class="line"><span class="comment"># hadoop1ä¸­</span></span><br><span class="line">vim /opt/zookeeper/data/myid</span><br><span class="line">1</span><br><span class="line"></span><br><span class="line"><span class="comment"># hadoop2ä¸­</span></span><br><span class="line">vim /opt/zookeeper/data/myid</span><br><span class="line">2</span><br><span class="line"></span><br><span class="line"><span class="comment"># hadoop3ä¸­</span></span><br><span class="line">vim /opt/zookeeper/data/myid</span><br><span class="line">3</span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯åŠ¨zookeeperæœåŠ¡</span></span><br><span class="line">/opt/zookeeper/bin/zkServer.sh start</span><br><span class="line"></span><br><span class="line"><span class="comment"># å…³é—­zookeeperæœåŠ¡</span></span><br><span class="line">/opt/zookeeper/bin/zkServer.sh stop</span><br><span class="line"></span><br><span class="line"><span class="comment"># æŸ¥çœ‹zookeeperæœåŠ¡çš„è¿è¡ŒçŠ¶æ€</span></span><br><span class="line">/opt/zookeeper/bin/zkServer.sh status</span><br></pre></td></tr></table></figure><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1667898771414-cb30096f-32f8-4352-8019-fca123110223.png" class=""> <img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1667898784655-8706b29b-c514-460c-9dfb-416a0285109d.png" class=""> <img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1667898803162-34d2506c-ce20-4aa6-8dbe-42cad1b29bab.png" class=""> <h2 id="æ“ä½œ"><a href="#æ“ä½œ" class="headerlink" title="æ“ä½œ"></a>æ“ä½œ</h2><h3 id="0-å¯åŠ¨Cli"><a href="#0-å¯åŠ¨Cli" class="headerlink" title="0.å¯åŠ¨Cli"></a>0.å¯åŠ¨Cli</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å¯åŠ¨Cli</span></span><br><span class="line">/home/hadoop/zookeeper/bin/zkCli.sh</span><br></pre></td></tr></table></figure><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1667896052438-415c3bc8-93d5-4738-8669-a15c6b737d52.png" class=""> <h3 id="1-åˆ›å»ºZnodes"><a href="#1-åˆ›å»ºZnodes" class="headerlink" title="1.åˆ›å»ºZnodes"></a>1.åˆ›å»ºZnodes</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºèŠ‚ç‚¹</span></span><br><span class="line">create /path /data</span><br><span class="line">create /FirstZnode <span class="string">&quot;Myfirstzookeeper-pp&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºé¡ºåºèŠ‚ç‚¹ flagï¼š-s</span></span><br><span class="line">create -s /path /data</span><br><span class="line">create -s /FirstZnode <span class="string">&quot;second-data&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ›å»ºä¸´æ—¶èŠ‚ç‚¹ flagï¼š-e</span></span><br><span class="line">create -e /path /data</span><br><span class="line">create -e /SecondZnode <span class="string">&quot;Ephemeral-data&quot;</span></span><br></pre></td></tr></table></figure><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1667896521579-d76bca1b-e077-42f3-a65f-97e199519e06.png" class=""> <h3 id="2-è·å–æ•°æ®"><a href="#2-è·å–æ•°æ®" class="headerlink" title="2.è·å–æ•°æ®"></a>2.è·å–æ•°æ®</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è·å–æ•°æ®</span></span><br><span class="line">get /path</span><br><span class="line"></span><br><span class="line">get /FirstZnode</span><br><span class="line">get /FirstZnode0000000001</span><br></pre></td></tr></table></figure><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1667896881402-e91bfbc6-a817-4b95-b3ea-131552d199a9.png" class=""> <img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1667897285456-0012e270-7b8d-4a1c-a860-69c948eb9f11.png" class=""> <h3 id="3-Watchï¼ˆç›‘è§†ï¼‰"><a href="#3-Watchï¼ˆç›‘è§†ï¼‰" class="headerlink" title="3.Watchï¼ˆç›‘è§†ï¼‰"></a>3.Watchï¼ˆç›‘è§†ï¼‰</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Watchï¼ˆç›‘è§†ï¼‰</span></span><br><span class="line">get /path [watch] 1</span><br><span class="line"></span><br><span class="line">get /FirstZnode 1</span><br></pre></td></tr></table></figure><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1667896791268-e2183bd6-67e8-4212-921f-60ec13c90008.png" class=""> <h3 id="4-è®¾ç½®æ•°æ®"><a href="#4-è®¾ç½®æ•°æ®" class="headerlink" title="4.è®¾ç½®æ•°æ®"></a>4.è®¾ç½®æ•°æ®</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è®¾ç½®/æ›´æ”¹æ•°æ®</span></span><br><span class="line"><span class="built_in">set</span> /path /data</span><br><span class="line"></span><br><span class="line"><span class="built_in">set</span> /SecondZnode Data-updated</span><br><span class="line"><span class="built_in">set</span> /SecondZnode abc</span><br></pre></td></tr></table></figure><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1667896957320-a7c16bc8-fc41-401c-808c-7bc092173e63.png" class=""> <h3 id="5-åˆ›å»ºznodeå­èŠ‚ç‚¹"><a href="#5-åˆ›å»ºznodeå­èŠ‚ç‚¹" class="headerlink" title="5.åˆ›å»ºznodeå­èŠ‚ç‚¹"></a>5.åˆ›å»ºznodeå­èŠ‚ç‚¹</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ›å»ºznodeå­èŠ‚ç‚¹</span></span><br><span class="line">create /parent/path/subnode/path /data</span><br><span class="line"></span><br><span class="line">create /FirstZnode/Child1 firstchildren</span><br></pre></td></tr></table></figure><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1667897100634-28744b14-5faf-4ac7-8981-d1353c1a30d5.png" class=""> <h3 id="6-åˆ—å‡ºznodeçš„å­èŠ‚ç‚¹"><a href="#6-åˆ—å‡ºznodeçš„å­èŠ‚ç‚¹" class="headerlink" title="6.åˆ—å‡ºznodeçš„å­èŠ‚ç‚¹"></a>6.åˆ—å‡ºznodeçš„å­èŠ‚ç‚¹</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ—å‡ºznodeçš„å­èŠ‚ç‚¹</span></span><br><span class="line"><span class="built_in">ls</span> /path</span><br><span class="line"></span><br><span class="line"><span class="built_in">ls</span> /FirstZnode</span><br></pre></td></tr></table></figure><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1667897128446-054aab38-e54c-48b1-84bc-f4319f5bad49.png" class=""> <h3 id="7-æ£€æŸ¥çŠ¶æ€"><a href="#7-æ£€æŸ¥çŠ¶æ€" class="headerlink" title="7.æ£€æŸ¥çŠ¶æ€"></a>7.æ£€æŸ¥çŠ¶æ€</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ£€æŸ¥çŠ¶æ€</span></span><br><span class="line"><span class="built_in">stat</span> /path</span><br><span class="line"></span><br><span class="line"><span class="built_in">stat</span> /FirstZnode</span><br></pre></td></tr></table></figure><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1667897141714-96981414-bf40-434c-bfc8-1bb9c069fa95.png" class=""> <h3 id="8-åˆ é™¤Znode"><a href="#8-åˆ é™¤Znode" class="headerlink" title="8. åˆ é™¤Znode"></a>8. åˆ é™¤Znode</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ é™¤Znode</span></span><br><span class="line">delete /path</span><br><span class="line"></span><br><span class="line">delete /SecondZnode</span><br></pre></td></tr></table></figure><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1667897363718-2534fed6-adbe-4dcd-8acb-1ac6148d0baa.png" class=""> <h1 id="æ•°æ®ä»“åº“Hive"><a href="#æ•°æ®ä»“åº“Hive" class="headerlink" title="æ•°æ®ä»“åº“Hive"></a>æ•°æ®ä»“åº“Hive</h1><h2 id="å®‰è£…-2"><a href="#å®‰è£…-2" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h2><h3 id="å®‰è£…Mysql"><a href="#å®‰è£…Mysql" class="headerlink" title="å®‰è£…Mysql"></a>å®‰è£…Mysql</h3><p>æœ¬æ¬¡ä½¿ç”¨Dockerå®‰è£…Mysql  dockerè¯¦è§£ä¸º<a href="https://www.yuque.com/pepsiwyl/blog/ghlc1t">https://www.yuque.com/pepsiwyl/blog/ghlc1t</a><br>ç›´æ¥å®‰è£…å¯ä»¥å‚è€ƒ <a href="https://www.yuque.com/pepsiwyl/blog/zalhzm">https://www.yuque.com/pepsiwyl/blog/zalhzm</a></p><h4 id="å®‰è£…Docker"><a href="#å®‰è£…Docker" class="headerlink" title="å®‰è£…Docker"></a>å®‰è£…Docker</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®‰è£…å‘½ä»¤</span></span><br><span class="line">curl -fsSL https://get.docker.com | bash -s docker --mirror Aliyun</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†å½“å‰ç”¨æˆ·åŠ å…¥Dockerç»„</span></span><br><span class="line">sudo groupadd docker            <span class="comment"># åˆ›å»ºDockerç»„</span></span><br><span class="line">sudo usermod -aG docker <span class="variable">$USER</span>   <span class="comment"># å°†å½“å‰ç”¨æˆ·åŠ å…¥Dockerç»„</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¯åŠ¨docker</span></span><br><span class="line">systemctl start docker    <span class="comment"># å¼€å¯æœåŠ¡</span></span><br><span class="line">systemctl <span class="built_in">enable</span> docker   <span class="comment"># å¼€æœºè‡ªå¯æœåŠ¡</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># éªŒè¯dokerç‰ˆæœ¬</span></span><br><span class="line">docker version</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># é…ç½®é˜¿é‡Œäº‘åŠ é€Ÿé•œåƒ æ‰§è¡Œä»¥ä¸‹è„šæœ¬å³å¯</span></span><br><span class="line">sudo <span class="built_in">mkdir</span> -p /etc/docker</span><br><span class="line">sudo <span class="built_in">tee</span> /etc/docker/daemon.json &lt;&lt;-<span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;registry-mirrors&quot;</span>: [<span class="string">&quot;https://fimlvmx5.mirror.aliyuncs.com&quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl restart docker</span><br></pre></td></tr></table></figure><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1667906764198-b2da97bf-6e62-4abc-afa7-e07416670a76.png" class=""> <h4 id="å¯åŠ¨Mysqlå®¹å™¨"><a href="#å¯åŠ¨Mysqlå®¹å™¨" class="headerlink" title="å¯åŠ¨Mysqlå®¹å™¨"></a>å¯åŠ¨Mysqlå®¹å™¨</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®‰è£…mysql  è´¦å·root å¯†ç root</span></span><br><span class="line">docker run -p 3306:3306 -e MYSQL_ROOT_PASSWORD=root -v mysql:/var/lib/mysql -d --restart=always --name mysql8.0 mysql:8.0.24</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æŸ¥çœ‹mysqlæ˜¯å¦å¯åŠ¨æˆåŠŸ</span></span><br><span class="line">docker ps</span><br></pre></td></tr></table></figure><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1667906236888-d77b6f9b-287f-4db4-9501-dab2430ede21.png" class=""> <h4 id="åˆ›å»ºhiveåº“"><a href="#åˆ›å»ºhiveåº“" class="headerlink" title="åˆ›å»ºhiveåº“"></a>åˆ›å»ºhiveåº“</h4><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1667908007042-ef0a9be7-ba52-490b-a51d-9303fdd423d4.png" class=""> <h3 id="å®‰è£…Hive"><a href="#å®‰è£…Hive" class="headerlink" title="å®‰è£…Hive"></a>å®‰è£…Hive</h3><h4 id="å®‰è£…-3"><a href="#å®‰è£…-3" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ‡æ¢è·¯å¾„</span></span><br><span class="line"><span class="built_in">cd</span> /opt</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸‹è½½å®‰è£…åŒ…  ç½‘å€: https://dlcdn.apache.org/hive/</span></span><br><span class="line">wget https://dlcdn.apache.org/hive/hive-3.1.2/apache-hive-3.1.2-bin.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># è§£å‹</span></span><br><span class="line">tar -zxvf apache-hive-3.1.2-bin.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># é‡å‘½å</span></span><br><span class="line"><span class="built_in">mv</span> apache-hive-3.1.2-bin hive</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ é™¤å®‰è£…åŒ…</span></span><br><span class="line"><span class="built_in">rm</span> -rf apache-hive-3.1.2-bin.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ·»åŠ ç¯å¢ƒå˜é‡</span></span><br><span class="line">vim /etc/profile</span><br><span class="line"><span class="comment">#hiveå®‰è£…ç›®å½•</span></span><br><span class="line"><span class="built_in">export</span> HIVE_HOME=/opt/hive  </span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:<span class="variable">$HIVE_HOME</span>/bin</span><br><span class="line"><span class="comment"># æ›´æ–°ç¯å¢ƒå˜é‡</span></span><br><span class="line"><span class="built_in">source</span> /etc/profile</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ£€æµ‹Hiveæ˜¯å¦å®‰è£…æˆåŠŸ</span></span><br><span class="line">hive --version</span><br></pre></td></tr></table></figure><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1667906665017-ab18ac10-38c0-45a0-a09e-baa8268b5031.png" class=""> <h4 id="æ·»åŠ jaråŒ…"><a href="#æ·»åŠ jaråŒ…" class="headerlink" title="æ·»åŠ jaråŒ…"></a>æ·»åŠ jaråŒ…</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ‡æ¢è·¯å¾„</span></span><br><span class="line"><span class="built_in">cd</span> /opt</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸‹è½½rpmåŒ…</span></span><br><span class="line">wget https://downloads.mysql.com/archives/get/p/3/file/mysql-connector-java-8.0.24-1.el7.noarch.rpm</span><br><span class="line"></span><br><span class="line"><span class="comment"># è§£å‹rpmåŒ…</span></span><br><span class="line">rpm2cpio mysql-connector-java-8.0.24-1.el7.noarch.rpm | cpio -div</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ é™¤rpmåŒ…</span></span><br><span class="line"><span class="built_in">rm</span> -rf mysql-connector-java-8.0.24-1.el7.noarch.rpm</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ·»åŠ jaråŒ…</span></span><br><span class="line"><span class="built_in">cp</span> /opt/usr/share/java/mysql-connector-java.jar /opt/hive/lib</span><br><span class="line"></span><br><span class="line"><span class="comment"># åˆ é™¤è§£å‹æ–‡ä»¶</span></span><br><span class="line"><span class="built_in">rm</span> -rf /opt/usr</span><br></pre></td></tr></table></figure><h4 id="é…ç½®Hive"><a href="#é…ç½®Hive" class="headerlink" title="é…ç½®Hive"></a>é…ç½®Hive</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åˆ‡æ¢è·¯å¾„</span></span><br><span class="line"><span class="built_in">cd</span> /opt/hive/conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># å°†hive-default.xml.templateæ–‡ä»¶é‡å‘½åä¸ºhive-default.xml</span></span><br><span class="line"><span class="built_in">mv</span> hive-default.xml.template hive-default.xml</span><br><span class="line"></span><br><span class="line"><span class="comment"># æ–°å»ºä¸€ä¸ªæ–‡ä»¶hive-site.xml</span></span><br><span class="line">vim hive-site.xml</span><br></pre></td></tr></table></figure><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> standalone=<span class="string">&quot;no&quot;</span>?&gt;</span></span><br><span class="line"><span class="meta">&lt;?xml-stylesheet type=<span class="string">&quot;text/xsl&quot;</span> href=<span class="string">&quot;configuration.xsl&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>javax.jdo.option.ConnectionURL<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--MysqlæœåŠ¡å™¨IPåœ°å€--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>jdbc:mysql://192.168.131.144:3306/hive?useUnicode=true<span class="symbol">&amp;amp;</span>serverTimezone=UTC<span class="symbol">&amp;amp;</span>useUnicode=true<span class="symbol">&amp;amp;</span>characterEncoding=utf8<span class="symbol">&amp;amp;</span>useSSL=false<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">description</span>&gt;</span>JDBC connect string for a JDBC metastore<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>javax.jdo.option.ConnectionDriverName<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>com.mysql.cj.jdbc.Driver<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">description</span>&gt;</span>Driver class name for a JDBC metastore<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>javax.jdo.option.ConnectionUserName<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>root<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">description</span>&gt;</span>username to use against metastore database<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>javax.jdo.option.ConnectionPassword<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>root<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">description</span>&gt;</span>password to use against metastore database<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure><h4 id="æ‰§è¡Œåˆå§‹åŒ–å‘½ä»¤"><a href="#æ‰§è¡Œåˆå§‹åŒ–å‘½ä»¤" class="headerlink" title="æ‰§è¡Œåˆå§‹åŒ–å‘½ä»¤"></a>æ‰§è¡Œåˆå§‹åŒ–å‘½ä»¤</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">schematool -dbType mysql -initSchema</span><br></pre></td></tr></table></figure><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1667909425435-7baa3dde-2cfb-4193-b212-d52882331ddd.png" class=""> <img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1667909445175-45d0536f-1413-469c-9987-f445c81eab98.png" class=""> <h5 id="BUG"><a href="#BUG" class="headerlink" title="BUG"></a>BUG</h5><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1667909533430-b9924b3b-75ed-4520-a08b-637c65ba7ffc.png" class=""> <p>è§£å†³æ–¹æ³•   <a href="https://www.cnblogs.com/syq816/p/12632028.html">https://www.cnblogs.com/syq816/p/12632028.html</a></p><h4 id="å¯åŠ¨-1"><a href="#å¯åŠ¨-1" class="headerlink" title="å¯åŠ¨"></a>å¯åŠ¨</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># å¯åŠ¨ä¹‹å‰éœ€è¦å…ˆå¯åŠ¨Hadoop   è„šæœ¬: start-all.sh</span><br><span class="line">hive</span><br></pre></td></tr></table></figure><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1667909857211-0e2ac56e-1098-4705-aae7-f466554528c6.png" class=""> <h2 id="åŸºæœ¬æ“ä½œ"><a href="#åŸºæœ¬æ“ä½œ" class="headerlink" title="åŸºæœ¬æ“ä½œ"></a>åŸºæœ¬æ“ä½œ</h2><h3 id="åˆ›å»ºæ•°æ®åº“ã€è¡¨ã€è§†å›¾"><a href="#åˆ›å»ºæ•°æ®åº“ã€è¡¨ã€è§†å›¾" class="headerlink" title="åˆ›å»ºæ•°æ®åº“ã€è¡¨ã€è§†å›¾"></a>åˆ›å»ºæ•°æ®åº“ã€è¡¨ã€è§†å›¾</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># åˆ›å»ºæ•°æ®åº“hive</span><br><span class="line">create database if not exists hive;</span><br><span class="line"></span><br><span class="line"># åˆ›å»ºè¡¨</span><br><span class="line">use hive;</span><br><span class="line">create table if not exists usr(id bigint,name string,age int);</span><br><span class="line">create table if not exists hive.usr(id bigint,name string,age int) location &#x27;/usr/local/hive/warehouse/hive/usr&#x27;;</span><br><span class="line">create table if not exists usr1 like usr;</span><br><span class="line"></span><br><span class="line"># åˆ›å»ºè§†å›¾</span><br><span class="line">create view little_usr as select id,age from usr;</span><br></pre></td></tr></table></figure><h3 id="åˆ é™¤æ•°æ®åº“ã€è¡¨ã€è§†å›¾"><a href="#åˆ é™¤æ•°æ®åº“ã€è¡¨ã€è§†å›¾" class="headerlink" title="åˆ é™¤æ•°æ®åº“ã€è¡¨ã€è§†å›¾"></a>åˆ é™¤æ•°æ®åº“ã€è¡¨ã€è§†å›¾</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># åˆ é™¤æ•°æ®åº“</span><br><span class="line">drop database if not exists hive;</span><br><span class="line">drop database if not exists hive cascade;</span><br><span class="line"></span><br><span class="line"># åˆ é™¤è¡¨</span><br><span class="line">drop table if exists usr;</span><br><span class="line"></span><br><span class="line"># åˆ é™¤è§†å›¾</span><br><span class="line">drop view if exists little_usr;</span><br></pre></td></tr></table></figure><h3 id="ä¿®æ”¹æ•°æ®åº“ã€è¡¨ã€è§†å›¾"><a href="#ä¿®æ”¹æ•°æ®åº“ã€è¡¨ã€è§†å›¾" class="headerlink" title="ä¿®æ”¹æ•°æ®åº“ã€è¡¨ã€è§†å›¾"></a>ä¿®æ”¹æ•°æ®åº“ã€è¡¨ã€è§†å›¾</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"># ä¿®æ”¹æ•°æ®åº“</span><br><span class="line">alter database hive set dbproperties(&#x27;edited-by&#x27;=&#x27;lily&#x27;);</span><br><span class="line"></span><br><span class="line"># ä¿®æ”¹è¡¨</span><br><span class="line">alter table usr rename to user;</span><br><span class="line">alter table usr add if not exists partition(age=10);</span><br><span class="line">alter table usr drop if exists partition(age=10);</span><br><span class="line">alter table usr change name username string after age;</span><br><span class="line">alter table usr add columns(sex boolean);</span><br><span class="line">alter table usr replace columns(newid bigint,newname string,newage int);</span><br><span class="line">alter table usr set tabproperties(â€˜notesâ€™=â€™the columns in usr may be null except idâ€™);</span><br><span class="line"></span><br><span class="line"># ä¿®æ”¹è§†å›¾</span><br><span class="line">alter view little_usr set tabproperties(â€˜create_atâ€™=â€™refer to timestampâ€™);</span><br></pre></td></tr></table></figure><h3 id="æŸ¥çœ‹æ•°æ®åº“ã€è¡¨ã€è§†å›¾"><a href="#æŸ¥çœ‹æ•°æ®åº“ã€è¡¨ã€è§†å›¾" class="headerlink" title="æŸ¥çœ‹æ•°æ®åº“ã€è¡¨ã€è§†å›¾"></a>æŸ¥çœ‹æ•°æ®åº“ã€è¡¨ã€è§†å›¾</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># æŸ¥çœ‹æ•°æ®åº“</span><br><span class="line">show databases;</span><br><span class="line"></span><br><span class="line"># æŸ¥çœ‹è¡¨å’Œè§†å›¾</span><br><span class="line">use hive;</span><br><span class="line">show tables;</span><br></pre></td></tr></table></figure><h3 id="æè¿°æ•°æ®åº“ã€è¡¨ã€è§†å›¾"><a href="#æè¿°æ•°æ®åº“ã€è¡¨ã€è§†å›¾" class="headerlink" title="æè¿°æ•°æ®åº“ã€è¡¨ã€è§†å›¾"></a>æè¿°æ•°æ®åº“ã€è¡¨ã€è§†å›¾</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># æè¿°æ•°æ®åº“</span><br><span class="line">describe database hive;</span><br><span class="line">describe database extended hive;</span><br><span class="line"></span><br><span class="line"># æè¿°è¡¨å’Œè§†å›¾</span><br><span class="line">describe hive.usr;</span><br><span class="line">describe hive.little_usr;</span><br><span class="line">describe extended hive.usr;</span><br><span class="line">describe extended hive.little_usr;</span><br></pre></td></tr></table></figure><h3 id="å‘è¡¨ä¸­è£…è½½æ•°æ®"><a href="#å‘è¡¨ä¸­è£…è½½æ•°æ®" class="headerlink" title="å‘è¡¨ä¸­è£…è½½æ•°æ®"></a>å‘è¡¨ä¸­è£…è½½æ•°æ®</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># æŠŠç›®å½•&#x27;/usr/local/data&#x27;ä¸‹çš„æ•°æ®æ–‡ä»¶ä¸­çš„æ•°æ®è£…è½½è¿›usrè¡¨å¹¶è¦†ç›–åŸæœ‰æ•°æ®</span><br><span class="line">load data local inpath &#x27;/usr/local/data&#x27; overwrite into table usr;</span><br><span class="line"></span><br><span class="line"># æŠŠç›®å½•&#x27;/usr/local/data&#x27;ä¸‹çš„æ•°æ®æ–‡ä»¶ä¸­çš„æ•°æ®è£…è½½è¿›usrè¡¨ä¸è¦†ç›–åŸæœ‰æ•°æ®</span><br><span class="line">load data local inpath &#x27;/usr/local/data&#x27; into table usr;</span><br></pre></td></tr></table></figure><h3 id="å‘è¡¨ä¸­æ’å…¥æ•°æ®æˆ–ä»è¡¨ä¸­å¯¼å‡ºæ•°æ®"><a href="#å‘è¡¨ä¸­æ’å…¥æ•°æ®æˆ–ä»è¡¨ä¸­å¯¼å‡ºæ•°æ®" class="headerlink" title="å‘è¡¨ä¸­æ’å…¥æ•°æ®æˆ–ä»è¡¨ä¸­å¯¼å‡ºæ•°æ®"></a>å‘è¡¨ä¸­æ’å…¥æ•°æ®æˆ–ä»è¡¨ä¸­å¯¼å‡ºæ•°æ®</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># å‘è¡¨usr1ä¸­æ’å…¥æ¥è‡ªusrè¡¨çš„æ•°æ®å¹¶è¦†ç›–åŸæœ‰æ•°æ®</span><br><span class="line">insert overwrite table usr1 select * from usr where age=10;</span><br><span class="line"></span><br><span class="line"># å‘è¡¨usr1ä¸­æ’å…¥æ¥è‡ªusrè¡¨çš„æ•°æ®å¹¶è¿½åŠ åœ¨åŸæœ‰æ•°æ®å</span><br><span class="line">insert into table usr1 select * from usr where age=10;</span><br></pre></td></tr></table></figure><h2 id="åº”ç”¨ä¸¾ä¾‹"><a href="#åº”ç”¨ä¸¾ä¾‹" class="headerlink" title="åº”ç”¨ä¸¾ä¾‹"></a>åº”ç”¨ä¸¾ä¾‹</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># åˆ›å»ºå¤„ç†çš„HDFSè·¯å¾„</span><br><span class="line">hadoop fs -mkdir /user/root/input</span><br><span class="line"></span><br><span class="line">cd /opt</span><br><span class="line">echo &quot;hello world&quot; &gt; file1.txt</span><br><span class="line">echo &quot;hello hadoop&quot; &gt; file2.txt</span><br><span class="line"></span><br><span class="line"># ä¸Šä¼ </span><br><span class="line">hadoop fs -put file1.txt   /user/root/input</span><br><span class="line">hadoop fs -put file2.txt   /user/root/input</span><br><span class="line"></span><br><span class="line"># åˆ é™¤æœ¬åœ°æ–‡ä»¶</span><br><span class="line">rm -rf file1.txt file2.txt</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"># å¯åŠ¨Hive</span><br><span class="line">hive</span><br><span class="line"></span><br><span class="line"># åˆ›å»ºè¾“å…¥è¡¨</span><br><span class="line">create table if not exists docs(line string);</span><br><span class="line"></span><br><span class="line"># åˆ é™¤è¾“å‡ºè¡¨</span><br><span class="line">drop table if exists word_count;</span><br><span class="line"></span><br><span class="line"># åŠ è½½æ•°æ®</span><br><span class="line">load data inpath &#x27;input&#x27; overwrite into table docs;</span><br><span class="line"></span><br><span class="line"># æŸ¥çœ‹åŠ è½½çš„æ•°æ®</span><br><span class="line">select * from docs;</span><br><span class="line"></span><br><span class="line"># å¼€å§‹åˆ†æ</span><br><span class="line">create table word_count as </span><br><span class="line">      select word, count(1) as count from</span><br><span class="line">      (select explode(split(line,&#x27; &#x27;))as word from docs) w</span><br><span class="line">      group by word</span><br><span class="line">      order by word;</span><br><span class="line"></span><br><span class="line"># æŸ¥è¯¢ç»“æœ</span><br><span class="line">select * from word_count;</span><br></pre></td></tr></table></figure><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1667913486795-4aec8db7-931a-482f-87cb-cab9cddf87ca.png" class=""> <img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1667913441540-8b7eac86-5f98-44cb-938d-d1f40114b6c7.png" class=""> <h1 id="PigæŠ€æœ¯"><a href="#PigæŠ€æœ¯" class="headerlink" title="PigæŠ€æœ¯"></a>PigæŠ€æœ¯</h1><h2 id="å®‰è£…Pig"><a href="#å®‰è£…Pig" class="headerlink" title="å®‰è£…Pig"></a>å®‰è£…Pig</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"># åˆ‡æ¢ç›®å½•</span><br><span class="line">cd /opt</span><br><span class="line"> </span><br><span class="line"># ä¸‹è½½å®‰è£…åŒ…  ç½‘å€: https://dlcdn.apache.org/pig/</span><br><span class="line">wget https://dlcdn.apache.org/pig/pig-0.17.0/pig-0.17.0.tar.gz</span><br><span class="line"></span><br><span class="line"># è§£å‹</span><br><span class="line">tar -zxvf pig-0.17.0.tar.gz </span><br><span class="line"></span><br><span class="line"># é‡å‘½å</span><br><span class="line">mv pig-0.17.0 pig</span><br><span class="line"></span><br><span class="line"># åˆ é™¤å®‰è£…åŒ…</span><br><span class="line">rm -rf pig-0.17.0.tar.gz</span><br><span class="line"></span><br><span class="line"># æ·»åŠ ç¯å¢ƒå˜é‡</span><br><span class="line">vim /etc/profile</span><br><span class="line">#pigå®‰è£…ç›®å½•</span><br><span class="line">export PIG_HOME=/opt/pig  </span><br><span class="line">export PATH=$PATH:$PIG_HOME/bin</span><br><span class="line"># æ›´æ–°ç¯å¢ƒå˜é‡</span><br><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># æ£€æµ‹pigç‰ˆæœ¬</span><br><span class="line">pig -version</span><br></pre></td></tr></table></figure><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1668686153223-7d2d73bb-e4c1-4ba7-8f23-fe32a7fe46e9.png" class=""><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># æ£€æµ‹pigæ˜¯å¦å®‰è£…æˆåŠŸ</span><br><span class="line">æµ‹è¯•æ˜¯å¦å®‰è£…æˆåŠŸï¼Œä½¿ç”¨pigå‘½ä»¤è¿›å…¥ï¼Œç„¶åä½¿ç”¨sh lsæŸ¥çœ‹æµ‹è¯•ï¼Œèƒ½å’Œå¢é•¿è¿è¡Œè¡¨ç¤ºæˆåŠŸã€‚</span><br></pre></td></tr></table></figure><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1668935309710-da7cdbff-8fd8-4c47-b2c7-ebe0431cf00e.png" class=""><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># æœ¬åœ°æ¨¡å¼</span><br><span class="line">pig -x local</span><br></pre></td></tr></table></figure><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1668686235957-e09133e4-e46a-4faa-875e-c1a541e73cee.png" class=""><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># MapReduceæ¨¡å¼</span><br><span class="line">pig -x mapreduce</span><br></pre></td></tr></table></figure><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1668686259504-d4062bf4-3050-49ea-adce-ee359f6fef84.png" class=""><h2 id="å®éªŒæ“ä½œ"><a href="#å®éªŒæ“ä½œ" class="headerlink" title="å®éªŒæ“ä½œ"></a>å®éªŒæ“ä½œ</h2><h3 id="åˆ›å»ºæ–‡ä»¶å¹¶ä¸Šä¼ HDFS"><a href="#åˆ›å»ºæ–‡ä»¶å¹¶ä¸Šä¼ HDFS" class="headerlink" title="åˆ›å»ºæ–‡ä»¶å¹¶ä¸Šä¼ HDFS"></a>åˆ›å»ºæ–‡ä»¶å¹¶ä¸Šä¼ HDFS</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"># åˆ‡æ¢è·¯å¾„</span><br><span class="line">cd /opt</span><br><span class="line"></span><br><span class="line"># åˆ›å»ºæ–‡ä»¶</span><br><span class="line">vim student.txt</span><br><span class="line">201000101:æå‹‡:ç”·:20:è®¡ç®—æœºè½¯ä»¶åŠç†è®º</span><br><span class="line">201000102:ç‹ä¸½:å¥³:19:è®¡ç®—æœºè½¯ä»¶åŠç†è®º</span><br><span class="line">201000103:åˆ˜èŠ±:å¥³:18:è®¡ç®—æœºåº”ç”¨æŠ€æœ¯</span><br><span class="line">201000104:æè‚–:ç”·:19:è®¡ç®—æœºç³»ç»Ÿç»“æ„</span><br><span class="line">201000105:æµ©è¾¾:ç”·:19:è®¡ç®—æœºç³»ç»Ÿç»“æ„</span><br><span class="line">201000106:åå…‹:ç”·:19:è®¡ç®—æœºç³»ç»Ÿç»“æ„</span><br><span class="line"></span><br><span class="line"># åˆ›å»ºæ–‡ä»¶</span><br><span class="line">vim course.txt</span><br><span class="line">01,English,4</span><br><span class="line">02,Data Structure,2</span><br><span class="line">03,DataBase,2</span><br><span class="line">04,DB Design,3</span><br><span class="line">05,C Language,3</span><br><span class="line">06,Principles of Network,3</span><br><span class="line">07,OS,3</span><br><span class="line"></span><br><span class="line"># åˆ›å»ºæ–‡ä»¶</span><br><span class="line">vim sc.txt</span><br><span class="line">201000101,01,92</span><br><span class="line">201000101,03,84</span><br><span class="line">201000102,01,90</span><br><span class="line">201000102,02,94</span><br><span class="line">201000102,03,82</span><br><span class="line">201000103,01,72</span><br><span class="line">201000103,02,90</span><br><span class="line">201000104,03,75</span><br><span class="line"></span><br><span class="line"># åˆ›å»ºpigç›®å½•ï¼Œä¸“é—¨å­˜æ”¾è¿™ä¸‰ä¸ªæ–‡ä»¶</span><br><span class="line">hdfs dfs -mkdir /pig_test</span><br><span class="line"></span><br><span class="line"># ä¸Šä¼ æ–‡ä»¶</span><br><span class="line">hdfs dfs -put student.txt /pig_test</span><br><span class="line">hdfs dfs -put course.txt /pig_test</span><br><span class="line">hdfs dfs -put sc.txt /pig_test</span><br><span class="line"></span><br><span class="line"># åˆ é™¤æœ¬åœ°æ–‡ä»¶</span><br><span class="line">rm -rf student.txt;</span><br><span class="line">rm -rf course.txt;</span><br><span class="line">rm -rf sc.txt;</span><br></pre></td></tr></table></figure><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1668936075094-de112816-47ff-4316-9877-f386541a1627.png" class=""><h3 id="å®éªŒæ“ä½œ-1"><a href="#å®éªŒæ“ä½œ-1" class="headerlink" title="å®éªŒæ“ä½œ"></a>å®éªŒæ“ä½œ</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">-&gt;pig</span><br><span class="line"></span><br><span class="line"># åœ¨PigåŠ è½½æ•°æ®</span><br><span class="line">a = load &#x27;/pig_test/student.txt&#x27; using PigStorage(&#x27;:&#x27;) as (sno:chararray,sname:chararray,sex:chararray,age:int,dept:chararray);</span><br><span class="line">b = load &#x27;/pig_test/course.txt&#x27; using PigStorage(&#x27;,&#x27;) as (cno:chararray,cname:chararray,grade:chararray);</span><br><span class="line">c = load &#x27;/pig_test/sc.txt&#x27; using PigStorage(&#x27;,&#x27;) as (sno:chararray,cno:chararray,score:float);</span><br><span class="line"></span><br><span class="line">a_join_c = join a by sno,c by sno;</span><br><span class="line">dump a_join_c;</span><br><span class="line"></span><br><span class="line">abc_join = join b by cno,a_join_c by c::cno;</span><br><span class="line">dump abc_join;</span><br><span class="line"></span><br><span class="line">not_excl = filter abc_join by score&lt;80;</span><br><span class="line">dump not_excl;</span><br><span class="line"></span><br><span class="line">foreach_data = foreach not_excl generate sname,cname,score;</span><br><span class="line">dump foreach_data;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">åœ¨hadoopé›†ç¾¤ä¸Šè¿è¡ŒpigæŠ¥å¦‚ä¸‹é”™è¯¯ï¼šæŠ¥é”™INFO  org.apache.hadoop.ipc.Client - Retrying connect to server: 0.0.0.0/0.0.0.0:10020. Already tried 0 time(s); retry policy is RetryUpToMaximumCountWithFixedSleep(maxRetries=10, sleepTime=1000 MILLISECONDS)</span><br><span class="line"></span><br><span class="line">è§£å†³æ–¹æ¡ˆï¼šå¯åŠ¨historyserverï¼š</span><br><span class="line">mapred --daemon start historyserver</span><br></pre></td></tr></table></figure><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1668942481278-04ea5f0e-5698-4feb-a45d-8787820010e6.png" class=""><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1668943741931-e2f05310-6903-4306-8dd0-9b7d433c22d1.png" class=""><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1668943809574-5a35ec1d-1ac6-4766-b2b5-5c4a4316b4d2.png" class=""><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1668943945695-0b9788b6-bfc7-43ed-b16c-6203f0fc198e.png" class=""><h1 id="SqoopæŠ€æœ¯"><a href="#SqoopæŠ€æœ¯" class="headerlink" title="SqoopæŠ€æœ¯"></a>SqoopæŠ€æœ¯</h1><h2 id="å®‰è£…Sqoop"><a href="#å®‰è£…Sqoop" class="headerlink" title="å®‰è£…Sqoop"></a>å®‰è£…Sqoop</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"># åˆ‡æ¢ç›®å½•</span><br><span class="line">cd /opt</span><br><span class="line"> </span><br><span class="line"># ä¸‹è½½å®‰è£…åŒ…  ç½‘å€:https://archive.apache.org/dist/sqoop/</span><br><span class="line">wget https://archive.apache.org/dist/sqoop/1.4.7/sqoop-1.4.7.bin__hadoop-2.6.0.tar.gz</span><br><span class="line"></span><br><span class="line"># è§£å‹</span><br><span class="line">tar -zxvf sqoop-1.4.7.bin__hadoop-2.6.0.tar.gz </span><br><span class="line"></span><br><span class="line"># é‡å‘½å</span><br><span class="line">mv sqoop-1.4.7.bin__hadoop-2.6.0 sqoop</span><br><span class="line"></span><br><span class="line"># é…ç½®ç¯å¢ƒå˜é‡</span><br><span class="line">vim /etc/profile</span><br><span class="line"># sqoopå®‰è£…ç›®å½•</span><br><span class="line">export SQOOP_HOME=/opt/sqoop</span><br><span class="line">export PATH=$PATH:$SQOOP_HOME/bin</span><br><span class="line">export CLASSPATH=$CLASSPATH:$SQOOP_HOME/lib</span><br><span class="line"># æ›´æ–°ç¯å¢ƒå˜é‡</span><br><span class="line">source /etc/profile</span><br><span class="line"></span><br><span class="line"># åˆ é™¤å®‰è£…åŒ…</span><br><span class="line">rm -rf sqoop-1.4.7.bin__hadoop-2.6.0.tar.gz</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># é‡å†™å‘½åé…ç½®æ–‡ä»¶</span><br><span class="line">mv /opt/sqoop/conf/sqoop-env-template.sh  /opt/sqoop/conf/sqoop-env.sh</span><br><span class="line"></span><br><span class="line"># é…ç½®sqoop-env.shæ–‡ä»¶</span><br><span class="line">vim sqoop-env.sh</span><br><span class="line">æ’å…¥</span><br><span class="line">export HADOOP_COMMON_HOME=/home/hadoop/hadoop</span><br><span class="line">export HADOOP_MAPRED_HOME=/home/hadoop/hadoop</span><br><span class="line">export HIVE_HOME=/opt/hive</span><br><span class="line">export HIVE_CONF_DIR=//opt/hive/conf</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># æ‹·è´mysqlé©±åŠ¨</span><br><span class="line">cp /opt/hive/lib/mysql-connector-java.jar /opt/sqoop/lib</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># æµ‹è¯•è¿æ¥æ•°æ®åº“</span><br><span class="line">sqoop list-databases --connect jdbc:mysql://127.0.0.1:3306/ --username root -P</span><br><span class="line">-&gt;è¾“å…¥å¯†ç ......</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">è§£å†³BUGæŠ¥é”™ Exception in thread &quot;main&quot; java.lang.NoClassDefFoundError: org/apache/commons/lang/StringUtils</span><br><span class="line">cd /opt</span><br><span class="line">wget https://mirrors.tuna.tsinghua.edu.cn/apache//commons/lang/binaries/commons-lang-2.6-bin.tar.gz</span><br><span class="line">tar -zxvf commons-lang-2.6-bin.tar.gz </span><br><span class="line">cp /opt/commons-lang-2.6/commons-lang-2.6.jar /opt/sqoop/lib</span><br><span class="line">rm -rf commons-lang-2.6-bin.tar.gz</span><br><span class="line">rm -rf commons-lang-2.6</span><br></pre></td></tr></table></figure><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1668946680916-fcf23f2b-e7a9-4a1f-b8ba-b88f8021e970.png" class=""><h2 id="å®éªŒæ“ä½œ-2"><a href="#å®éªŒæ“ä½œ-2" class="headerlink" title="å®éªŒæ“ä½œ"></a>å®éªŒæ“ä½œ</h2><h3 id="åˆ›å»ºæ•°æ®æ–‡ä»¶"><a href="#åˆ›å»ºæ•°æ®æ–‡ä»¶" class="headerlink" title="åˆ›å»ºæ•°æ®æ–‡ä»¶"></a>åˆ›å»ºæ•°æ®æ–‡ä»¶</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">drop database if exists userdb;</span><br><span class="line">create database userdb;</span><br><span class="line">use userdb;</span><br><span class="line">drop table if exists emp;</span><br><span class="line">drop table if exists emp_add;</span><br><span class="line">drop table if exists emp_conn;</span><br><span class="line"> </span><br><span class="line">CREATE TABLE emp(</span><br><span class="line">id INT NOT NULL,</span><br><span class="line">name VARCHAR(100),</span><br><span class="line">deg VARCHAR(100),</span><br><span class="line">salary BIGINT,</span><br><span class="line">dept VARCHAR(50)</span><br><span class="line">);</span><br><span class="line"> </span><br><span class="line">CREATE TABLE emp_add(</span><br><span class="line">id INT NOT NULL,</span><br><span class="line">hno VARCHAR(50),</span><br><span class="line">street VARCHAR(50),</span><br><span class="line">city VARCHAR(50)</span><br><span class="line">);</span><br><span class="line"> </span><br><span class="line">CREATE TABLE emp_conn(</span><br><span class="line">id INT NOT NULL,</span><br><span class="line">phno VARCHAR(50),</span><br><span class="line">email VARCHAR(50)</span><br><span class="line">);</span><br><span class="line"> </span><br><span class="line">insert into emp values(1201,&#x27;gopal&#x27;,&#x27;manager&#x27;,&#x27;50000&#x27;,&#x27;TP&#x27;);</span><br><span class="line">insert into emp values(1202,&#x27;manisha&#x27;,&#x27;Proof reader&#x27;,&#x27;50000&#x27;,&#x27;TP&#x27;);</span><br><span class="line">insert into emp values(1204,&#x27;prasanth&#x27;,&#x27;php dev&#x27;,&#x27;30000&#x27;,&#x27;AC&#x27;);</span><br><span class="line">insert into emp values(1205,&#x27;kranthi&#x27;,&#x27;admin&#x27;,&#x27;20000&#x27;,&#x27;TP&#x27;);</span><br><span class="line"> </span><br><span class="line">insert into emp_add values(1201,&#x27;288A&#x27;,&#x27;vgiri&#x27;,&#x27;jublee&#x27;);</span><br><span class="line">insert into emp_add values(1202,&#x27;108I&#x27;,&#x27;aoc&#x27;,&#x27;sec-bad&#x27;);</span><br><span class="line">insert into emp_add values(1203,&#x27;144Z&#x27;,&#x27;pgutta&#x27;,&#x27;hyd&#x27;);</span><br><span class="line">insert into emp_add values(1204,&#x27;78B&#x27;,&#x27;old city&#x27;,&#x27;sec-bad&#x27;);</span><br><span class="line">insert into emp_add values(1205,&#x27;720X&#x27;,&#x27;hitec&#x27;,&#x27;sec-bad&#x27;);</span><br><span class="line"> </span><br><span class="line">insert into emp_conn values(1201,&#x27;2356742&#x27;,&#x27;gopal@tp.com&#x27;);</span><br><span class="line">insert into emp_conn values(1202,&#x27;1661663&#x27;,&#x27;manisha@tp.com&#x27;);</span><br><span class="line">insert into emp_conn values(1203,&#x27;8887776&#x27;,&#x27;khalil@ac.com&#x27;);</span><br><span class="line">insert into emp_conn values(1204,&#x27;9988774&#x27;,&#x27;prasanth@ac.com&#x27;);</span><br><span class="line">insert into emp_conn values(1205,&#x27;1231231&#x27;,&#x27;kranthi@tp.com&#x27;);</span><br></pre></td></tr></table></figure><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1668947371652-f8019f76-3efc-4869-9b98-2448477b2e6f.png" class=""><h3 id="Sqoopçš„æ•°æ®å¯¼å…¥"><a href="#Sqoopçš„æ•°æ®å¯¼å…¥" class="headerlink" title="Sqoopçš„æ•°æ®å¯¼å…¥"></a><strong>Sqoopçš„æ•°æ®å¯¼å…¥</strong></h3><h4 id="å¯¼å…¥HDFSä¸­"><a href="#å¯¼å…¥HDFSä¸­" class="headerlink" title="å¯¼å…¥HDFSä¸­"></a>å¯¼å…¥HDFSä¸­</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># å¯¼å…¥</span><br><span class="line">hadoop fs -rm -r /user/root/emp;</span><br><span class="line">sqoop  import  --connect jdbc:mysql://192.168.131.144:3306/userdb  --username root  --password root  --table emp  --m 1; </span><br><span class="line"></span><br><span class="line"># æŸ¥çœ‹</span><br><span class="line">hadoop fs -cat /user/root/emp/part-m-00000</span><br></pre></td></tr></table></figure><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1668947907436-fa506eb1-da1b-44a4-8153-f3182bd381fd.png" class=""><h4 id="å¯¼å…¥HIVEä¸­"><a href="#å¯¼å…¥HIVEä¸­" class="headerlink" title="å¯¼å…¥HIVEä¸­"></a>å¯¼å…¥HIVEä¸­</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># å¯¼å…¥HIVEçš„æ—¶ï¼Œé»˜è®¤ç›®å½•ä¸­ä¸èƒ½æœ‰å½“å‰è¡¨</span><br><span class="line">hadoop fs -rm -r /user/root/emp;</span><br><span class="line"></span><br><span class="line"># å¯¼å…¥HIVE</span><br><span class="line">sqoop  import  --connect jdbc:mysql://192.168.131.144:3306/userdb  --username root  --password root  --table emp  --hive-import  --m 1; </span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">// ERROR tool.ImportTool: Import failed: java.io.IOException: java.lang.ClassNotFoundException: </span><br><span class="line">cp /opt/hive/lib/hive-common-3.1.2.jar /opt/sqoop/lib/</span><br><span class="line">cp /opt/hive/lib/hive-exec-3.1.2.jar /opt/sqoop/lib/</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-&gt;hive</span><br><span class="line">select * from emp;</span><br></pre></td></tr></table></figure><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1668948884923-d27814f1-0c04-41ff-b391-646e16222c64.png" class=""><h4 id="å¯¼å…¥è¡¨æ•°æ®å­é›†"><a href="#å¯¼å…¥è¡¨æ•°æ®å­é›†" class="headerlink" title="å¯¼å…¥è¡¨æ•°æ®å­é›†"></a>å¯¼å…¥è¡¨æ•°æ®å­é›†</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># å¯¼å…¥</span><br><span class="line">hadoop fs -rm -r /wherequery;</span><br><span class="line">sqoop  import  --connect jdbc:mysql://192.168.131.144:3306/userdb  --username root  --password root  --target-dir /wherequery  --query &#x27;select id,name,deg from emp WHERE id&gt;1203 and $CONDITIONS&#x27;  --split-by id  --fields-terminated-by &#x27;\t&#x27;  --m 1;</span><br><span class="line"></span><br><span class="line"># æŸ¥çœ‹</span><br><span class="line">hadoop fs -cat /wherequery/part-m-*</span><br></pre></td></tr></table></figure><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1668949339913-4cea7b6a-633b-4518-b9a5-67f570329997.png" class=""><h3 id="Sqoopçš„æ•°æ®å¯¼å‡º"><a href="#Sqoopçš„æ•°æ®å¯¼å‡º" class="headerlink" title="Sqoopçš„æ•°æ®å¯¼å‡º"></a>Sqoopçš„æ•°æ®å¯¼å‡º</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">use userdb;</span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> if <span class="keyword">exists</span> employee;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> if <span class="keyword">not</span> <span class="keyword">exists</span> employee ( </span><br><span class="line">  id <span class="type">INT</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span> <span class="keyword">PRIMARY</span> KEY, </span><br><span class="line">  name <span class="type">VARCHAR</span>(<span class="number">20</span>), </span><br><span class="line">  deg <span class="type">VARCHAR</span>(<span class="number">20</span>),</span><br><span class="line">  salary <span class="type">INT</span>,</span><br><span class="line">  dept <span class="type">VARCHAR</span>(<span class="number">10</span>));</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># å¯¼å‡º</span><br><span class="line">sqoop  export   --connect jdbc:mysql://192.168.131.144:3306/userdb  --username root  --password root  --table employee --export-dir /user/root/emp;</span><br></pre></td></tr></table></figure><img src="/2022/11/12/Hadoop-%C2%A9-pepsi-wyl/1668950327042-d47f5296-706f-4182-8423-76b0737ab88f.png" class="">]]></content>
      
      
      <categories>
          
          <category> å¤§æ•°æ® </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hadoop </tag>
            
            <tag> å¤§æ•°æ® </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hexoå…¥é—¨</title>
      <link href="/2022/11/12/Hexo/"/>
      <url>/2022/11/12/Hexo/</url>
      
        <content type="html"><![CDATA[<h1 id="åŸºç¡€å…¥é—¨"><a href="#åŸºç¡€å…¥é—¨" class="headerlink" title="åŸºç¡€å…¥é—¨"></a>åŸºç¡€å…¥é—¨</h1><h2 id="åŸºç¡€å‘½ä»¤"><a href="#åŸºç¡€å‘½ä»¤" class="headerlink" title="åŸºç¡€å‘½ä»¤"></a>åŸºç¡€å‘½ä»¤</h2><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">hexo help             # å¸®åŠ©</span><br><span class="line">hexo clean            # æ¸…é™¤ç¼“å­˜å’Œå·²ç”Ÿæˆçš„é™æ€æ–‡ä»¶</span><br><span class="line">hexo g                # ç”Ÿæˆé¡µé¢</span><br><span class="line">hexo s                # æœ¬åœ°é¢„è§ˆ</span><br><span class="line"></span><br><span class="line">hexo d                # éƒ¨ç½²</span><br><span class="line">hexo g -d             # ç”Ÿæˆé¡µé¢å¹¶éƒ¨ç½²</span><br></pre></td></tr></table></figure><h2 id="æ–°å»ºé¡µé¢"><a href="#æ–°å»ºé¡µé¢" class="headerlink" title="æ–°å»ºé¡µé¢"></a>æ–°å»ºé¡µé¢</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexo new page <span class="string">&quot;name&quot;</span>  <span class="comment"># æ–°å»ºé¡µé¢</span></span><br></pre></td></tr></table></figure><h2 id="åˆ›å»ºæ–‡ç« "><a href="#åˆ›å»ºæ–‡ç« " class="headerlink" title="åˆ›å»ºæ–‡ç« "></a>åˆ›å»ºæ–‡ç« </h2><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexo new &quot;name&quot;       # æ–°å»ºæ–‡ç« </span><br></pre></td></tr></table></figure><h3 id="Front-matter"><a href="#Front-matter" class="headerlink" title="Front-matter"></a>Front-matter</h3><p>Front-matter é€‰é¡¹ä¸­çš„æ‰€æœ‰å†…å®¹å‡ä¸ºéå¿…å¡«çš„ã€‚ä½†æˆ‘ä»ç„¶å»ºè®®è‡³å°‘å¡«å†™ title å’Œ date çš„å€¼ã€‚</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># åŸºæœ¬å±æ€§</span></span><br><span class="line">title      æ–‡ç« æ ‡é¢˜</span><br><span class="line">date      æ–‡ä»¶åˆ›å»ºæ—¶é—´</span><br><span class="line">updated       æ–‡ä»¶æ›´æ–°æ—¶é—´</span><br><span class="line">author        æ–‡ç« ä½œè€…</span><br><span class="line">tags      æ–‡ç« æ ‡ç­¾</span><br><span class="line">categories    æ–‡ç« åˆ†ç±»</span><br><span class="line">toptrue  è®¾ç½®ä¸º trueï¼Œæ–‡ç« åˆ™ç½®é¡¶</span><br><span class="line">summary  å¼€å¯æ–‡ç« æ‘˜è¦åï¼Œè‡ªå®šä¹‰æ–‡ç« æ‘˜è¦å†…å®¹ï¼Œå¦åˆ™æˆªå–æ–‡ç« å†…å®¹ä¸ºæ‘˜è¦</span><br></pre></td></tr></table></figure><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># ç®€å•ä¸¾ä¾‹</span></span><br><span class="line">---</span><br><span class="line">title: Hello World</span><br><span class="line">tags:</span><br><span class="line"><span class="bullet">    -</span> Hello World</span><br><span class="line">categories:</span><br><span class="line"><span class="section">    - Hello World</span></span><br><span class="line"><span class="section">---</span></span><br></pre></td></tr></table></figure><h3 id="æ–‡ç« æ·»åŠ å›¾ç‰‡"><a href="#æ–‡ç« æ·»åŠ å›¾ç‰‡" class="headerlink" title="æ–‡ç« æ·»åŠ å›¾ç‰‡"></a>æ–‡ç« æ·»åŠ å›¾ç‰‡</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># ä¿®æ”¹æ ¹ç›®å½•ä¸‹çš„<span class="emphasis">_config.ymlæ–‡ä»¶å¼€å¯é…ç½® </span></span></span><br><span class="line"><span class="emphasis"><span class="section">post_</span>asset<span class="emphasis">_folder: true</span></span></span><br><span class="line"><span class="emphasis"><span class="section"></span></span></span><br><span class="line"><span class="emphasis"><span class="section"># åˆ›å»ºæ–‡ç« ä¹‹åä¼šå‡ºç°ä¸¤ä¸ªç›®å½•</span></span></span><br><span class="line"><span class="emphasis"><span class="section">hexo new page &quot;name&quot;</span></span></span><br><span class="line"><span class="emphasis"><span class="section"></span></span></span><br><span class="line"><span class="emphasis"><span class="section"># åœ¨nameç›®å½•ä¸­è¿›è¡Œå¼•å…¥å›¾ç‰‡</span></span></span><br><span class="line"><span class="emphasis"><span class="section"></span></span></span><br><span class="line"><span class="emphasis"><span class="section"># åœ¨name.mdä¸­è¿›è¡Œå¼•å…¥å›¾ç‰‡</span></span></span><br><span class="line"><span class="emphasis"><span class="section">&#123;% asset_</span>img XXXX.XXX %&#125; </span></span><br><span class="line"></span><br><span class="line">æ›¿æ¢</span><br><span class="line">![image.png](./assets/ -&gt; &#123;% asset<span class="emphasis">_img </span></span><br><span class="line"><span class="emphasis">.png) -&gt; .png %&#125;</span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Hexo </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hexo </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
